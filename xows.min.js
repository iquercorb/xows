"use strict";const XOWS_APP_NAME="Xows",XOWS_APP_VERS="0.9.0",XOWS_APP_NODE="https://github.com/sedenion/xows",XOWS_LOGO_SVG=new Path2D("M8.282 6.527l2.514 3.942c-2.33 1.463-3.431 3.529-4.134 5.785-2.326.221-1.5-4.322-1.659-5.373 0 0-2.945 5.92-.822 7.584 1.518 1.19 4.09 1.651 4.09 1.651l-3.268 4.146c2.224.748 7.17.825 7.17.825l2.837-4.416h2.054l2.837 4.417s4.946-.078 7.17-.826l-3.268-4.146s2.558-.477 4.09-1.651c1.964-1.506-.822-7.584-.822-7.584-.159 1.051.667 5.594-1.66 5.373-.701-2.257-1.803-4.322-4.134-5.785l2.514-3.942c-.98-1.003-2.247-1.753-3.34-1.576l-3.786 4.692h-1.257L11.622 4.95c-1.091-.177-2.358.573-3.34 1.576zm4.104 6.495c.63 1.175 1.797 3.073 1.797 3.073s-1.005.029-1.95.029c-.944 0-1.598-.05-1.598-.754s.322-2.348 1.75-2.348zm7.264 0c1.449 0 1.75 1.644 1.75 2.348 0 .705-.596.754-1.598.754a74.34 74.34 0 01-1.95-.029S19 14.197 19.65 13.022z");function xows_has_bits(_,e){return(_&e)===e}function xows_is_func(_){return _&&_.constructor&&_.call&&_.apply}function xows_random(_){let e=_+=1831565813;return e=Math.imul(e^e>>>15,1|e),(((e^=e+Math.imul(e^e>>>7,61|e))^e>>>14)>>>0)/4294967296}const XOWS_SIG_ERR=0,XOWS_SIG_WRN=1,XOWS_SIG_LOG=2;function xows_log(_,e,o,s,t){if(_<=xows_options.verbose){let c,n="";_>1&&t&&(n+="%c",c="color:"+t),n+=o,s&&(n+=": "+s);const i=e+": "+n;switch(_){case 0:case 1:console.warn(i);break;default:c?console.log(i,c):console.log(i)}}}const XOWS_CMAP_HEX="0123456789abcdef",XOWS_CMAP_B64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function xows_str_to_utf8(_){let e,o,s="";for(let t=0,c=_.length;t<c;++t)(e=_.charCodeAt(t))<128?s+=_.charAt(t):e<2048?s+=String.fromCharCode(192|e>>6,128|63&e):e<55296||e>=57344?s+=String.fromCharCode(224|e>>12,128|e>>6&63,128|63&e):(++t,e=65536+((1023&e)<<10|1023&(o=_.charCodeAt(t))),s+=String.fromCharCode(240|e>>18,128|e>>12&63,128|e>>6&63,128|63&e));return s}function xows_str_bytes_len(_){let e,o=0;for(let s=0,t=_.length;s<t;++s)(e=_.charCodeAt(s))<128?o++:e<2048?o+=2:e<55296||e>=57344?o+=3:(++s,o+=4);return o}function xows_str_to_bytes(_,e){let o,s;const t=new Uint8Array(e||xows_str_bytes_len(_));for(let e=0,c=0,n=_.length;e<n;++e)(o=_.charCodeAt(e))<128?t[c++]=o:o<2048?(t[c++]=192|o>>6,t[c++]=128|63&o):o<55296||o>=57344?(t[c++]=224|o>>12,t[c++]=128|o>>6&63,t[c++]=128|63&o):(++e,o=65536+((1023&o)<<10|1023&(s=_.charCodeAt(e))),t[c++]=240|o>>18,t[c++]=128|o>>12&63,t[c++]=128|o>>6&63,t[c++]=128|63&o);return t}function xows_bytes_to_str(_){return String.fromCharCode.apply(null,_)}function xows_bytes_to_b64(_){const e=_.length,o=e%3;let s,t,c,n="";for(s=0,t=e-o;s<t;)c=_[s++]<<16|_[s++]<<8|_[s++],n+=XOWS_CMAP_B64[63&c>>18],n+=XOWS_CMAP_B64[63&c>>12],n+=XOWS_CMAP_B64[63&c>>6],n+=XOWS_CMAP_B64[63&c];return 0!==o&&(c=_[s++]<<16,o>1&&(c|=_[s]<<8),n+=XOWS_CMAP_B64[63&c>>18],n+=XOWS_CMAP_B64[63&c>>12],n+=o>1?XOWS_CMAP_B64[63&c>>6]:"=",n+="="),n}function xows_bytes_to_hex(_){let e,o="";for(let s=0,t=_.length;s<t;++s)e=_[s],o+=XOWS_CMAP_HEX.charAt(e>>>4&15)+XOWS_CMAP_HEX.charAt(15&e);return o}function xows_gen_uuid(){const _=new Uint8Array(16);window.crypto.getRandomValues(_),_[6]=15&_[6]|64,_[8]=63&_[8]|128;let e="";for(let o=0,s=0;s<16;++s)8!==o&&13!==o&&18!==o&&23!==o||(e+="-",o++),e+=XOWS_CMAP_HEX.charAt(_[s]>>>4&15)+XOWS_CMAP_HEX.charAt(15&_[s]),o+=2;return e}function xows_gen_nonce_hex(_){const e=new Uint8Array(_);window.crypto.getRandomValues(e);let o="";for(let s=0;s<_;++s)o+=XOWS_CMAP_HEX.charAt(e[s]>>>4&15)+XOWS_CMAP_HEX.charAt(15&e[s]);return o}function xows_gen_nonce_asc(_){const e=new Uint8Array(_);window.crypto.getRandomValues(e);let o="";for(let s=0;s<_;++s)o+=XOWS_CMAP_B64[e[s]%62];return o}function xows_hash_md5(_){let e;function o(_,o,s,t,c,n,i){return((e=_+((t^o&(s^t))+c+i))<<n|e>>>32-n)+o}function s(_,o,s,t,c,n,i){return((e=_+((s^t&(o^s))+c+i))<<n|e>>>32-n)+o}function t(_,o,s,t,c,n,i){return((e=_+((o^s^t)+c+i))<<n|e>>>32-n)+o}function c(_,o,s,t,c,n,i){return((e=_+((s^(o|~t))+c+i))<<n|e>>>32-n)+o}let n,i,r,l=0;if("string"==typeof _)r=xows_str_to_bytes(_,64+((i=8*(n=xows_str_bytes_len(_)))+64>>9<<6));else for(i=8*(n=_.length),r=new Uint8Array(64+(i+64>>9<<6));l<n;++l)r[l]=_[l];r[n]|=128;let a=r.length-8;r[a]=255&i,r[a+1]=i>>8&255,r[a+2]=i>>16&255,r[a+3]=i>>24&255;const x=new Uint32Array(16),w=new Uint32Array(4);let u,d,p,m;for(w[0]=1732584193,w[1]=4023233417,w[2]=2562383102,w[3]=271733878,a=0;a<r.length;){for(l=0;l<16;++l)x[l]=r[a++]|r[a++]<<8|r[a++]<<16|r[a++]<<24;u=w[0],d=c(d=c(d=c(d=c(d=t(d=t(d=t(d=t(d=s(d=s(d=s(d=s(d=o(d=o(d=o(d=o(d=w[1],p=o(p=w[2],m=o(m=w[3],u=o(u,d,p,m,x[0],7,3614090360),d,p,x[1],12,3905402710),u,d,x[2],17,606105819),m,u,x[3],22,3250441966),p=o(p,m=o(m,u=o(u,d,p,m,x[4],7,4118548399),d,p,x[5],12,1200080426),u,d,x[6],17,2821735955),m,u,x[7],22,4249261313),p=o(p,m=o(m,u=o(u,d,p,m,x[8],7,1770035416),d,p,x[9],12,2336552879),u,d,x[10],17,4294925233),m,u,x[11],22,2304563134),p=o(p,m=o(m,u=o(u,d,p,m,x[12],7,1804603682),d,p,x[13],12,4254626195),u,d,x[14],17,2792965006),m,u,x[15],22,1236535329),p=s(p,m=s(m,u=s(u,d,p,m,x[1],5,4129170786),d,p,x[6],9,3225465664),u,d,x[11],14,643717713),m,u,x[0],20,3921069994),p=s(p,m=s(m,u=s(u,d,p,m,x[5],5,3593408605),d,p,x[10],9,38016083),u,d,x[15],14,3634488961),m,u,x[4],20,3889429448),p=s(p,m=s(m,u=s(u,d,p,m,x[9],5,568446438),d,p,x[14],9,3275163606),u,d,x[3],14,4107603335),m,u,x[8],20,1163531501),p=s(p,m=s(m,u=s(u,d,p,m,x[13],5,2850285829),d,p,x[2],9,4243563512),u,d,x[7],14,1735328473),m,u,x[12],20,2368359562),p=t(p,m=t(m,u=t(u,d,p,m,x[5],4,4294588738),d,p,x[8],11,2272392833),u,d,x[11],16,1839030562),m,u,x[14],23,4259657740),p=t(p,m=t(m,u=t(u,d,p,m,x[1],4,2763975236),d,p,x[4],11,1272893353),u,d,x[7],16,4139469664),m,u,x[10],23,3200236656),p=t(p,m=t(m,u=t(u,d,p,m,x[13],4,681279174),d,p,x[0],11,3936430074),u,d,x[3],16,3572445317),m,u,x[6],23,76029189),p=t(p,m=t(m,u=t(u,d,p,m,x[9],4,3654602809),d,p,x[12],11,3873151461),u,d,x[15],16,530742520),m,u,x[2],23,3299628645),p=c(p,m=c(m,u=c(u,d,p,m,x[0],6,4096336452),d,p,x[7],10,1126891415),u,d,x[14],15,2878612391),m,u,x[5],21,4237533241),p=c(p,m=c(m,u=c(u,d,p,m,x[12],6,1700485571),d,p,x[3],10,2399980690),u,d,x[10],15,4293915773),m,u,x[1],21,2240044497),p=c(p,m=c(m,u=c(u,d,p,m,x[8],6,1873313359),d,p,x[15],10,4264355552),u,d,x[6],15,2734768916),m,u,x[13],21,1309151649),p=c(p,m=c(m,u=c(u,d,p,m,x[4],6,4149444226),d,p,x[11],10,3174756917),u,d,x[2],15,718787259),m,u,x[9],21,3951481745),w[0]+=u,w[1]+=d,w[2]+=p,w[3]+=m}const g=new Uint8Array(16);for(l=0,a=0;l<4;++l)g[a++]=255&w[l],g[a++]=w[l]>>8&255,g[a++]=w[l]>>16&255,g[a++]=w[l]>>24&255;return g}function xows_hash_sha1(_){let e,o,s,t=0;if("string"==typeof _)s=xows_str_to_bytes(_,64+((o=8*(e=xows_str_bytes_len(_)))+64>>9<<6));else for(o=8*(e=_.length),s=new Uint8Array(64+(o+64>>9<<6));t<e;++t)s[t]=_[t];s[e]|=128;let c=s.length-4;s[c]=o>>24&255,s[c+1]=o>>16&255,s[c+2]=o>>8&255,s[c+3]=255&o;const n=new Uint32Array(16),i=new Uint32Array(5);let r,l,a,x,w,u,d,p;for(i[0]=1732584193,i[1]=4023233417,i[2]=2562383102,i[3]=271733878,i[4]=3285377520,c=0;c<s.length;){for(t=0;t<16;++t)n[t]=s[c++]<<24|s[c++]<<16|s[c++]<<8|s[c++];for(r=i[0],l=i[1],a=i[2],x=i[3],w=i[4],t=0;t<80;++t)t>15&&(p=n[t-3&15]^n[t-8&15]^n[t-14&15]^n[15&t],n[15&t]=p<<1|p>>>31),t<20?(u=1518500249,d=x^l&(a^x)):t<40?(u=1859775393,d=l^a^x):t<60?(u=2400959708,d=l&a|l&x|a&x):(u=3395469782,d=l^a^x),p=(r<<5|r>>>27)+d+(w+n[15&t]+u),w=x,x=a,a=l<<30|l>>>2,l=r,r=p;i[0]+=r,i[1]+=l,i[2]+=a,i[3]+=x,i[4]+=w}const m=new Uint8Array(20);for(t=0,c=0;t<5;++t)m[c++]=i[t]>>24&255,m[c++]=i[t]>>16&255,m[c++]=i[t]>>8&255,m[c++]=255&i[t];return m}function xows_hmac_sha1(_,e){"string"==typeof _&&(_=xows_str_to_bytes(_)),_.length>64&&(_=xows_hash_sha1(_));const o=new Uint8Array(64+e.length),s=new Uint8Array(84);let t,c,n;for(c=0,n=_.length;c<n;++c)o[c]=54^_[c],s[c]=92^_[c];for(;c<64;++c)o[c]=54,s[c]=92;for("string"==typeof e&&(e=xows_str_to_bytes(e)),t=0,n=e.length;t<n;++t)o[c++]=e[t];const i=xows_hash_sha1(o);for(t=0,c=64;t<20;++t)s[c++]=i[t];return xows_hash_sha1(s)}function xows_hash_sha256(_){const e=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);let o,s,t,c=0;if("string"==typeof _)t=xows_str_to_bytes(_,64+((s=8*(o=xows_str_bytes_len(_)))+64>>9<<6));else for(s=8*(o=_.length),t=new Uint8Array(64+(s+64>>9<<6));c<o;++c)t[c]=_[c];t[o]|=128;let n=t.length-4;t[n]=s>>24&255,t[n+1]=s>>16&255,t[n+2]=s>>8&255,t[n+3]=255&s;const i=new Uint32Array(64),r=new Uint32Array(8);let l,a,x,w,u,d,p,m,g,h;for(r[0]=1779033703,r[1]=3144134277,r[2]=1013904242,r[3]=2773480762,r[4]=1359893119,r[5]=2600822924,r[6]=528734635,r[7]=1541459225,n=0;n<t.length;){for(c=0;c<16;++c)i[c]=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++];for(l=r[0],a=r[1],x=r[2],w=r[3],u=r[4],d=r[5],p=r[6],m=r[7],c=0;c<64;c++)c>15&&(g=((h=i[c-2])>>>17|h<<15)^(h>>>19|h<<13)^h>>>10,i[c]=g+i[c-7],g=((h=i[c-15])>>>7|h<<25)^(h>>>18|h<<14)^h>>>3,i[c]+=g+i[c-16]),w+=h=m+(g=(u>>>6|u<<26)^(u>>>11|u<<21)^(u>>>25|u<<7))+(p^u&(d^p))+e[c]+i[c],h+=(g=(l>>>2|l<<30)^(l>>>13|l<<19)^(l>>>22|l<<10))+(l&a|x&(l|a)),m=p,p=d,d=u,u=w,w=x,x=a,a=l,l=h;r[0]+=l,r[1]+=a,r[2]+=x,r[3]+=w,r[4]+=u,r[5]+=d,r[6]+=p,r[7]+=m}const f=new Uint8Array(32);for(c=0,n=0;c<8;++c)f[n++]=r[c]>>24&255,f[n++]=r[c]>>16&255,f[n++]=r[c]>>8&255,f[n++]=255&r[c];return f}const XOWS_REG_TEST_JID=/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;function xows_is_jid(_){return XOWS_REG_TEST_JID.test(_)}function xows_jid_to_bare(_){const e=_.indexOf("/");return-1!==e?_.substring(0,e):_}function xows_jid_to_nick(_){const e=_.indexOf("/");return-1!==e?_.substring(e+1):null}function xows_url_to_data(_){return 0===_.indexOf("data:")?_.substring(_.indexOf(",")+1):null}function xows_url_to_bytes(_){return 0===_.indexOf("data:")?atob(_.substring(_.indexOf(",")+1)):null}function xows_url_to_type(_){return 0===_.indexOf("data:")?_.substring(5,_.indexOf(";")):null}function xows_clean_dom(_){let e,o=_.childNodes.length;for(;o--;)8===(e=_.childNodes[o]).nodeType||3===e.nodeType&&!/\S/.test(e.nodeValue)?_.removeChild(e):1===e.nodeType&&xows_clean_dom(e);return _}function xows_gen_avatar(_,e,o,s){const t=document.createElement("canvas"),c=t.getContext("2d"),n=.5*_;if(e){let o;const s=e.naturalWidth,n=e.naturalHeight;if(s>_||n>_){let i,r,l;s>n?(r=.5*(s-(i=n)),l=0):(r=0,l=.5*(n-(i=s))),t.width=s,t.height=n,c.drawImage(e,0,0);const a=c.getImageData(r,l,i,i),x=new Int32Array(a.data.buffer);o=new ImageData(_,_);const w=new Int32Array(o.data.buffer),u=1/(_/i),d=Math.round(u),p=1/(d*d);let m,g,h,f,b,F,S,v,y,A;for(m=0;m<_;++m)for(g=0;g<_;++g){for(b=Math.round(g*u)*i+Math.round(m*u),F=0,S=0,v=0,y=0,f=0;f<d;++f)for(h=0;h<d;++h)y+=(A=x[b+(f*i+h)])>>24&255,v+=A>>16&255,S+=A>>8&255,F+=255&A;F=Math.round(F*p),S=Math.round(S*p),v=Math.round(v*p),y=Math.round(y*p),w[g*_+m]=y<<24|v<<16|S<<8|F}t.width=t.height=_,c.putImageData(o,0,0)}else t.width=t.height=_,c.drawImage(e,0,0,_,_)}else if(t.width=t.height=_,o){let e=0,s=o.length;for(;s--;)e+=o.charCodeAt(s);const t=Math.ceil(1e3*xows_random(e))%360;c.fillStyle="hsl("+t+",85%,45%)",c.arc(n,n,n,0,2*Math.PI),c.fill(),c.fillStyle="#FFF";const i=_/32;c.scale(i,i),c.fill(XOWS_LOGO_SVG)}return t.toDataURL("image/png")}let xows_l10n_db={},xows_l10n_current="en",xows_l10n_fw_onready=function(){};function xows_l10n_select(_,e){xows_is_func(e)&&(xows_l10n_fw_onready=e);let o=xows_options.root+"/locale/LC_list.json";xows_options.uncache&&(o+="?"+xows_gen_nonce_asc(4));const s=new XMLHttpRequest;s.open("GET",o,!0),s.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_select","parsing locale list",this.responseURL);let e=JSON.parse(this.responseText);if(!e)return void xows_log(0,"l10n_select",'locale list "'+this.responseURL+'" parse error');if(e[_])return xows_log(2,"l10n_select","found available locale",_),void xows_l10n_db_load(e[_]);if(-1!==_.indexOf("-")){let o=_.split("-")[0].toLowerCase();if(e[o])return xows_log(2,"l10n_select","found available language",o),void xows_l10n_db_load(e[o])}xows_log(1,"l10n_select",'invalid or unavailable locale "'+_+'"',"using default"),xows_l10n_fw_onready()}else xows_log(0,"l10n_select",'locale list "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"')},xows_log(2,"l10n_select","loading locale list",o),s.send()}function xows_l10n_db_load(_,e){xows_is_func(e)&&(xows_l10n_fw_onready=e);let o=xows_options.root+"/locale/"+_+"/LC_db.json";xows_options.uncache&&(o+="?"+xows_gen_nonce_asc(4));const s=new XMLHttpRequest;s.open("GET",o,!0),s.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_db_load","parsing JSON data",this.responseURL);let e=JSON.parse(this.responseText);if(!e)return void xows_log(0,"l10n_db_load",'data "'+this.responseURL+'" parse error');xows_l10n_db=e,xows_l10n_current=_,xows_l10n_fw_onready()}else xows_log(0,"l10n_db_load",'file "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"'),xows_l10n_fw_onready()},xows_log(2,"l10n_db_load","loading locale db",o),s.send()}function xows_l10n_get(_){const e=xows_l10n_db[_];return e&&0!==e.length?e:_}function xows_l10n_parseFunc(_,e){const o=xows_l10n_db[e];return o&&0!==o.length?o:e}function xows_l10n_parse(_){return _.replace(/\${['"](.*)['"]}/g,xows_l10n_parseFunc)}function xows_l10n_hasLocale(_){return null!==xows_l10n_db[_]&&void 0!==xows_l10n_db[_]}function xows_l10n_date(_){const e=new Date(_),o=new Date,s=new Date(_);return o.setHours(0,0,0,0),s.setHours(0,0,0,0),o===s?xows_l10n_get("at")+" "+e.toLocaleTimeString(xows_l10n_current):e.toLocaleDateString(xows_l10n_current,{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}function xows_l10n_houre(_){return new Date(_).toLocaleTimeString(xows_l10n_current,{hour:"2-digit",minute:"2-digit"})}const xows_xml_parser=new DOMParser,xows_xml_doc=document.implementation.createDocument("jabber:client","Xows"),XOWS_XML_ESCAP_MAP={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&apos;",'"':"&quot;"},XOWS_XML_UNESC_MAP={"&amp;":"&","&lt;":"<","&gt;":">","&apos;":"'","&quot;":'"'};function xows_xml_escap_fnc(_){return XOWS_XML_ESCAP_MAP[_]}function xows_xml_escape(_){return _.replace(/[\&<>'"]/g,xows_xml_escap_fnc)}function xows_xml_unesc_fnc(_){return XOWS_XML_UNESC_MAP[_]}function xows_xml_unesc(_){return _.replace(/\&\w*;/g,xows_xml_unesc_fnc)}function xows_xml_parent(_,e){if("string"==typeof e||"number"==typeof e)_.appendChild(xows_xml_doc.createTextNode(e));else if("object"==typeof e){const o=e.length;if(void 0!==o)for(let s=0;s<o;++s)xows_xml_parent(_,e[s]);else _.appendChild(e)}}function xows_xml_node(_,e,o){const s=xows_xml_doc.createElement(_);if("object"==typeof e)for(const _ in e)e.hasOwnProperty(_)&&e[_]&&s.setAttribute(_,e[_]);return null!=o&&xows_xml_parent(s,o),s}function xows_xml_serialize(_){let e,o,s="<"+_.nodeName;for(o=_.attributes.length,e=0;e<o;++e)s+=" "+_.attributes[e].nodeName+'="'+_.attributes[e].nodeValue+'"';if(0!==(o=_.childNodes.length)){for(s+=">",e=0;e<o;++e)1===_.childNodes[e].nodeType?s+=xows_xml_serialize(_.childNodes[e]):s+=xows_xml_escape(_.childNodes[e].nodeValue);s+="</"+_.nodeName+">"}else s+="/>";return s}function xows_xml_parse(_){return xows_clean_dom(xows_xml_parser.parseFromString(_,"text/xml"))}function xows_xml_get_text(_){if(!_)return"";const e=_.childNodes.length;if(0===e&&3===_.nodeType)return xows_xml_unesc(_.nodeValue);let o="";for(let s=0;s<e;++s)3===_.childNodes[s].nodeType&&(o+=_.childNodes[s].nodeValue);return xows_xml_unesc(o)}let xows_sasl_data=null,xows_sasl_select="",xows_sasl_get_request=function(){return""},xows_sasl_get_response=function(_){return""},xows_sasl_chk_integrity=function(_){return!0},xows_sasl_failure_cb=function(){},xows_sasl_success_cb=function(){};function xows_sasl_get_selected(){return xows_sasl_select}function xows_sasl_plain_req(){let _=xows_sasl_data.authz+"\0";return _+=xows_sasl_data.authc+"\0",_+=xows_sasl_data.passw,xows_sasl_data={},_}function xows_sasl_plain_resp(_){return""}function xows_sasl_plain_chk(_){return!0}function xows_sasl_sha1_req(){xows_sasl_data.cnonce=xows_gen_nonce_asc(24);let _="n="+xows_sasl_data.authc;return _+=",r="+xows_sasl_data.cnonce,xows_sasl_data.client_first_message_bare=_,"n,,"+_}function xows_sasl_sha1_resp(_){let e,o,s,t,c,n,i,r=_.split(",");for(e=0,s=r.length;e<s;++e)"r"===(i=r[e].match(/([a-z]+)=(.+)/))[1]&&(t=i[2]),"s"===i[1]&&(c=i[2]),"i"===i[1]&&(n=i[2]);if(t.substr(0,24)!==xows_sasl_data.cnonce)return xows_sasl_data={},xows_log(0,"sasl_sha1_resp","SCRAM-SHA-1 challenge error","missing cnonce in server nonce"),xows_is_func(xows_sasl_failure_cb)&&xows_sasl_failure_cb(),"";let l,a,x="c=biws,r="+t,w=xows_sasl_data.client_first_message_bare;for(w+=","+_+","+x,l=a=xows_hmac_sha1(xows_sasl_data.passw,atob(c)+"\0\0\0"),e=1;e<n;++e)for(a=xows_hmac_sha1(xows_sasl_data.passw,a),o=0;o<20;++o)l[o]^=a[o];let u=xows_hmac_sha1(l,"Client Key");const d=xows_hmac_sha1(l,"Server Key"),p=xows_hmac_sha1(xows_hash_sha1(u),w);for(o=0;o<20;o++)u[o]^=p[o];xows_sasl_data={};const m=xows_hmac_sha1(d,w);return xows_sasl_data.sproof=xows_bytes_to_b64(m),x+=",p="+xows_bytes_to_b64(u)}function xows_sasl_sha1_chk(_){const e=_.match(/(v)=(.+)/),o=xows_sasl_data.sproof;return xows_sasl_data={},o===e[2]||(xows_log(0,"sasl_sha1_chk","SCRAM-SHA-1 integrity check failed","supplied server signature mismatches the computed one"),!1)}function xows_sasl_md5_req(){return""}function xows_sasl_md5_resp(_){let e,o,s,t,c,n,i=_.split(",");for(let _=0,r=i.length;_<r;++_)"realm"===(n=i[_].match(/([a-z]+)="?([^"]+)/))[1]&&(e=n[2]),"nonce"===n[1]&&(o=n[2]),"qop"===n[1]&&(s=n[2]),"host"===n[1]&&(t=n[2]),"rspauth"===n[1]&&(c=n[2]);if(void 0!==c)return"";const r=xows_sasl_data.authc,l=xows_sasl_data.authz,a=xows_sasl_data.passw;xows_sasl_data={};let x="xmpp/"+l.split("@")[1];void 0!==t&&(x+="/"+t);const w=xows_gen_nonce_asc(24),u="00000001";let d="charset=utf-8,";return d+='username="'+r+'",',d+='realm="'+e+'",',d+='nonce="'+o+'",',d+='cnonce="'+w+'",',d+="nc="+u+",",d+='digest-uri="'+x+'",',d+='response="'+xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_str(xows_hash_md5(r+":"+e+":"+a))+":"+o+":"+w+":"+l))+":"+o+":"+u+"1:"+w+":"+s+":"+xows_bytes_to_hex(xows_hash_md5("AUTHENTICATE:"+x))))+'",',d+="qop=auth"}function xows_sasl_md5_chk(_){return!0}const xows_sasl_mechanisms=[{name:"SCRAM-SHA-1",req:xows_sasl_sha1_req,res:xows_sasl_sha1_resp,chk:xows_sasl_sha1_chk},{name:"DIGEST-MD5",req:xows_sasl_md5_req,res:xows_sasl_md5_resp,chk:xows_sasl_md5_chk},{name:"PLAIN",req:xows_sasl_plain_req,res:xows_sasl_plain_resp,chk:xows_sasl_plain_chk}];function xows_sasl_init(_,e,o,s,t,c){let n=-1;for(let e=0,o=xows_sasl_mechanisms.length;e<o;++e)if(_.includes(xows_sasl_mechanisms[e].name)){xows_sasl_select=xows_sasl_mechanisms[e].name,n=e;break}return-1!==n&&(xows_sasl_failure_cb=c,xows_sasl_success_cb=t,xows_sasl_get_request=xows_sasl_mechanisms[n].req,xows_sasl_get_response=xows_sasl_mechanisms[n].res,xows_sasl_chk_integrity=xows_sasl_mechanisms[n].chk,(xows_sasl_data={}).authz=xows_str_to_utf8(e),xows_sasl_data.authc=xows_str_to_utf8(o),xows_sasl_data.passw=xows_str_to_utf8(s),!0)}let xows_sck_sock=null,xows_sck_url=null,xows_sck_fw_onopen=function(){},xows_sck_fw_onrecv=function(){},xows_sck_fw_onclose=function(){};function xows_sck_set_callback(_,e){if(xows_is_func(e))switch(_.toLowerCase()){case"open":xows_sck_fw_onopen=e;break;case"recv":xows_sck_fw_onrecv=e;break;case"close":xows_sck_fw_onclose=e}}function xows_sck_error(_){const e="Socket connection error";xows_log(0,"sck_error",e),xows_sck_fw_onclose(XOWS_SIG_ERR,e),xows_sck_sock=null}function xows_sck_closed(_){if(1e3!==_.code){const e="Server closed the socket";xows_log(0,"sck_closed",e,_.reason),xows_sck_fw_onclose(XOWS_SIG_ERR,e)}else xows_log(2,"sck_closed","Socket closed"),xows_sck_fw_onclose(3);xows_sck_sock=null}function xows_sck_opened(_){xows_log(2,"sck_opened","Socket connected"),xows_sck_fw_onopen()}function xows_sck_recv(_){xows_log(3,"sck_recv",_.data,null,"#AB5655"),xows_sck_fw_onrecv(_.data)}function xows_sck_create(_,e){xows_log(3,"sck_create","Socket connecting",_),(xows_sck_sock=new WebSocket(xows_sck_url=_,e)).onerror=xows_sck_error,xows_sck_sock.onopen=xows_sck_opened,xows_sck_sock.onclose=xows_sck_closed,xows_sck_sock.onmessage=xows_sck_recv}function xows_sck_destroy(){null!==xows_sck_sock&&(xows_log(3,"sck_destroy","WebSocket closing"),xows_sck_sock.close(),xows_sck_sock=null)}function xows_sck_send(_){xows_log(3,"sck_send",_,null,"#55ABAB"),xows_sck_sock.send(_)}const XOWS_NS_CLIENT="jabber:client",XOWS_NS_VERSION="jabber:iq:version",XOWS_NS_ROSTER="jabber:iq:roster",XOWS_NS_REGISTER="jabber:iq:register",XOWS_NS_XDATA="jabber:x:data",XOWS_NS_PING="urn:xmpp:ping",XOWS_NS_TIME="urn:xmpp:time",XOWS_NS_DELAY="urn:xmpp:delay",XOWS_NS_CARBONS="urn:xmpp:carbons",XOWS_NS_RECEIPTS="urn:xmpp:receipts",XOWS_NS_MAM="urn:xmpp:mam",XOWS_NS_VCARD4="urn:xmpp:vcard4",XOWS_NS_AVATAR_DATA="urn:xmpp:avatar:data",XOWS_NS_AVATAR_META="urn:xmpp:avatar:metadata",XOWS_NS_MARKERS="urn:xmpp:chat-markers",XOWS_NS_HTTPUPLOAD="urn:xmpp:http:upload",XOWS_NS_IETF_FRAMING="urn:ietf:params:xml:ns:xmpp-framing",XOWS_NS_IETF_SASL="urn:ietf:params:xml:ns:xmpp-sasl",XOWS_NS_IETF_BIND="urn:ietf:params:xml:ns:xmpp-bind",XOWS_NS_IETF_SESSION="urn:ietf:params:xml:ns:xmpp-session",XOWS_NS_IETF_VCARD4="urn:ietf:params:xml:ns:vcard-4.0",XOWS_NS_VCARD="vcard-temp",XOWS_NS_VCARDXUPDATE="vcard-temp:x:update",XOWS_NS_NICK="http://jabber.org/protocol/nick",XOWS_NS_CAPS="http://jabber.org/protocol/caps",XOWS_NS_DISCOINFO="http://jabber.org/protocol/disco#info",XOWS_NS_DISCOITEMS="http://jabber.org/protocol/disco#items",XOWS_NS_MUC="http://jabber.org/protocol/muc",XOWS_NS_MUCUSER="http://jabber.org/protocol/muc#user",XOWS_NS_MUCOWNER="http://jabber.org/protocol/muc#owner",XOWS_NS_CHATSTATES="http://jabber.org/protocol/chatstates",XOWS_NS_RSM="http://jabber.org/protocol/rsm",XOWS_NS_PUBSUB="http://jabber.org/protocol/pubsub",XOWS_NS_PUBSUBEVENT="http://jabber.org/protocol/pubsub#event",XOWS_NS_PUBSUBOPTS="http://jabber.org/protocol/pubsub#publish-options",XOWS_SHOW_OFF=-1,XOWS_SHOW_DND=0,XOWS_SHOW_XA=1,XOWS_SHOW_AWAY=2,XOWS_SHOW_ON=3,XOWS_SHOW_CHAT=4,xows_xmp_show_level_map={dnd:0,xa:1,away:2,chat:4},xows_xmp_show_name_map=["dnd","xa","away","","chat"],XOWS_SUBS_REM=-1,XOWS_SUBS_NONE=0,XOWS_SUBS_FROM=1,XOWS_SUBS_TO=2,XOWS_SUBS_BOTH=3,xows_xmp_subs_mask_map={remove:-1,none:0,from:1,to:2,both:3},XOWS_CHAT_GONE=0,XOWS_CHAT_ACTI=1,XOWS_CHAT_INAC=2,XOWS_CHAT_PAUS=3,XOWS_CHAT_COMP=4,xows_xmp_chat_mask_map={gone:0,active:1,inactive:2,paused:3,composing:4},xows_xmp_chat_name_map=["gone","active","inactive","paused","composing"],xows_xmp_xep_ns={"urn:xmpp:carbons":null,"urn:xmpp:mam":null,"urn:xmpp:http:upload":null},xows_xmp_stream_feat=[];let xows_xmp_iq_stk=[];const xows_xmp_mam_stk=[];let xows_xmp_url=null,xows_xmp_user=null,xows_xmp_domain=null,xows_xmp_jid=null,xows_xmp_bare=null,xows_xmp_res=null,xows_xmp_auth=null,xows_xmp_auth_register=!1;function xows_xmp_use_xep(_){const e=_.match(/([a-z\:]+)(:\d|$)/);if(e[1]){let o=!1;if(e[1]in xows_xmp_xep_ns)if(e[2].length){if(null!==xows_xmp_xep_ns[e[1]]){let _=!1;if(xows_xmp_xep_ns[e[1]].length){parseInt(xows_xmp_xep_ns[e[1]].charAt(1))>=parseInt(e[2].charAt(1))&&(_=!0)}}}else null!==xows_xmp_xep_ns[e[1]]&&(o=!0);return o?(xows_log(2,"xmp_use_xep","Ignoring extension",_),!1):(xows_xmp_xep_ns[e[1]]=e[2].length?e[2]:"",xows_log(2,"xmp_use_xep","Use extension",_),!0)}return xows_log(1,"xmp_use_xep","Unsuported extension",e[1]),!1}function xows_xmp_get_xep(_){return _ in xows_xmp_xep_ns&&xows_xmp_xep_ns[_]?_+xows_xmp_xep_ns[_]:(xows_log(1,"xmp_get_xep","Unknown extension",_),null)}function xows_xmp_get_caps(){let _=XOWS_NS_VCARD4,e=XOWS_NS_AVATAR_META;return xows_options.vcard4_notify&&(_+="+notify"),xows_options.avatar_notify&&(e+="+notify"),[xows_xml_node("identity",{category:"client",name:XOWS_APP_NAME,type:"web"}),xows_xml_node("feature",{var:XOWS_NS_CAPS}),xows_xml_node("feature",{var:XOWS_NS_DISCOINFO}),xows_xml_node("feature",{var:XOWS_NS_DISCOITEMS}),xows_xml_node("feature",{var:XOWS_NS_PING}),xows_xml_node("feature",{var:XOWS_NS_TIME}),xows_xml_node("feature",{var:XOWS_NS_VERSION}),xows_xml_node("feature",{var:XOWS_NS_CHATSTATES}),xows_xml_node("feature",{var:XOWS_NS_RECEIPTS}),xows_xml_node("feature",{var:XOWS_NS_VCARD}),xows_xml_node("feature",{var:XOWS_NS_IETF_VCARD4}),xows_xml_node("feature",{var:_}),xows_xml_node("feature",{var:XOWS_NS_AVATAR_DATA}),xows_xml_node("feature",{var:e})]}function xows_xmp_get_caps_ver(){const _=xows_xmp_get_caps();let e,o=_.length,s="";for(e=0;e<o;++e)"identity"===_[e].tagName&&(s+=_[e].getAttribute("category")+"/",s+=_[e].getAttribute("type")+"/",s+=(_[e].hasAttribute("xml:lang")?_[e].getAttribute("xml:lang"):"")+"/",s+=_[e].getAttribute("name")+"<");for(e=0;e<o;++e)"feature"===_[e].tagName&&(s+=_[e].getAttribute("var")+"<");return xows_bytes_to_b64(xows_hash_sha1(s))}function xows_xmp_xdata_parse(_){const e=[],o=_.getElementsByTagName("field");for(let _=0,s=o.length;_<s;++_)e.push({required:null!==o[_].querySelector("required"),type:o[_].getAttribute("type"),label:o[_].getAttribute("label"),var:o[_].getAttribute("var"),value:xows_xml_get_text(o[_].querySelector("value"))});return e}function xows_xmp_xdata_make(_){const e=xows_xml_node("x",{type:"submit",xmlns:XOWS_NS_XDATA});let o;for(let s=0,t=_.length;s<t;++s)o=xows_xml_node("field"),_[s].var&&o.setAttribute("var",_[s].var),_[s].type&&o.setAttribute("type",_[s].type),_[s].value&&xows_xml_parent(o,xows_xml_node("value",null,_[s].value)),xows_xml_parent(e,o);return e}let xows_xmp_fw_onsession=function(){},xows_xmp_fw_onregister=function(){},xows_xmp_fw_onpresence=function(){},xows_xmp_fw_onsubscrib=function(){},xows_xmp_fw_onoccupant=function(){},xows_xmp_fw_onroster=function(){},xows_xmp_fw_onmessage=function(){},xows_xmp_fw_onchatstate=function(){},xows_xmp_fw_onreceipt=function(){},xows_xmp_fw_onsubject=function(){},xows_xmp_fw_onpubsub=function(){},xows_xmp_fw_onerror=function(){},xows_xmp_fw_onclose=function(){};function xows_xmp_set_callback(_,e){if(xows_is_func(e))switch(_.toLowerCase()){case"session":xows_xmp_fw_onsession=e;break;case"register":xows_xmp_fw_onregister=e;break;case"presence":xows_xmp_fw_onpresence=e;break;case"subscrib":xows_xmp_fw_onsubscrib=e;break;case"occupant":xows_xmp_fw_onoccupant=e;break;case"roster":xows_xmp_fw_onroster=e;break;case"message":xows_xmp_fw_onmessage=e;break;case"chatstate":xows_xmp_fw_onchatstate=e;break;case"receipt":xows_xmp_fw_onreceipt=e;break;case"subject":xows_xmp_fw_onsubject=e;break;case"pubsub":xows_xmp_fw_onpubsub=e;break;case"error":xows_xmp_fw_onerror=e;break;case"close":xows_xmp_fw_onclose=e}}function xows_xmp_send(_,e,o){if(!xows_sck_sock)return;"presence"!==_.tagName&&"message"!==_.tagName&&"iq"!==_.tagName||_.getAttribute("xmlns")||_.setAttribute("xmlns",XOWS_NS_CLIENT);let s=_.getAttribute("id");s||(s=xows_gen_uuid(),_.setAttribute("id",s)),xows_is_func(e)&&xows_xmp_iq_stk.push({id:s,onresult:e,onparse:o}),xows_sck_send(xows_xml_serialize(_))}function xows_xmp_error_str(_){let e;const o=_.querySelector("error");if(o){e="("+o.getAttribute("type")+") ";const _=o.querySelector("text");e+=_?xows_xml_get_text(_):o.firstChild.tagName}return e}function xows_xmp_iq_parse(_,e){let o,s,t,c;const n=_.getAttribute("id"),i=_.getAttribute("type");if("error"===i){const e=_.querySelector("error");o=e.getAttribute("type"),s=e.getAttribute("code"),t=e.firstChild.tagName,c=xows_xml_get_text(_.querySelector("text")),xows_log(1,"xows_xmp_iq_parse","Query '"+n+"' error",xows_xmp_error_str(_))}xows_is_func(e)&&e(_.getAttribute("from"),i,o,s,t,c)}function xows_xmp_session_parse(_){if("error"===_.getAttribute("type")){const e="Session establishment failure";return xows_log(0,"xmp_session_parse",e,xows_xmp_error_str(_)),void xows_xmp_send_close(XOWS_SIG_ERR,e)}xows_log(2,"xmp_session_parse","Session established"),xows_xmp_fw_onsession(xows_xmp_jid)}function xows_xmp_session_query(){xows_log(2,"xmp_session_query","Query for session"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("session",{xmlns:XOWS_NS_IETF_SESSION})),xows_xmp_session_parse)}function xows_xmp_bind_parse(_){if("error"===_.getAttribute("type")){const e="Resource bind failure";return xows_log(0,"xmp_bind_parse",e,xows_xmp_error_str(_)),void xows_xmp_send_close(XOWS_SIG_ERR,e)}const e=_.querySelector("jid");xows_xmp_jid=xows_xml_get_text(e),xows_xmp_res=xows_jid_to_nick(xows_xmp_jid),xows_log(2,"xmp_bind_parse","Resource bind accepted",xows_xmp_jid),xows_xmp_stream_feat.includes(XOWS_NS_IETF_SESSION)?xows_xmp_session_query():xows_xmp_fw_onsession(xows_xmp_jid)}function xows_xmp_bind_query(){const _="xows_"+xows_gen_nonce_asc(8);xows_log(2,"xmp_bind_query","Query for resource bind",_),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("bind",{xmlns:XOWS_NS_IETF_BIND},xows_xml_node("resource",null,_))),xows_xmp_bind_parse)}function xows_xmp_carbons_query(_,e){const o=_?"enable":"disable";xows_log(2,"xmp_carbons_query","Query XEP-0280 Carbons",o);const s=xows_xmp_get_xep(XOWS_NS_CARBONS);s?xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node(o,{xmlns:s})),xows_xmp_iq_parse,e):xows_log(1,"xmp_carbons_query","XEP-0280 Carbons unavailable")}function xows_xmp_discoinfo_parse(_,e){if("error"===_.getAttribute("type"))return void xows_log(1,"xmp_discoinfo_parse","Parse Disco#info",xows_xmp_error_str(_));const o=_.querySelector("query");let s,t,c;const n=[];for(s=0,t=(c=o.getElementsByTagName("identity")).length;s<t;++s)n.push({category:c[s].getAttribute("category"),type:c[s].getAttribute("type"),name:c[s].getAttribute("name")});const i=[];for(s=0,t=(c=o.getElementsByTagName("feature")).length;s<t;++s)c[s].hasAttribute("var")&&i.push(c[s].getAttribute("var"));const r=o.querySelector("x"),l=r?xows_xmp_xdata_parse(r):null;xows_is_func(e)&&e(_.getAttribute("from"),n,i,l,o.getAttribute("node"))}function xows_xmp_discoinfo_query(_,e,o){xows_log(2,"xmp_discoinfo_query","Query disco#info",_),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("query",{xmlns:XOWS_NS_DISCOINFO,node:e})),xows_xmp_discoinfo_parse,o)}function xows_xmp_discoitems_parse(_,e){if("error"===_.getAttribute("type"))return void xows_log(1,"xmp_discoitems_parse","Parse Disco#items",xows_xmp_error_str(_));const o=_.getElementsByTagName("item"),s=[];for(let _=0,e=o.length;_<e;++_)s.push({jid:o[_].getAttribute("jid"),name:o[_].getAttribute("name")});xows_is_func(e)&&e(_.getAttribute("from"),s)}function xows_xmp_discoitems_query(_,e){xows_log(2,"xmp_discoitems_query","Query disco#items",_),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("query",{xmlns:XOWS_NS_DISCOITEMS})),xows_xmp_discoitems_parse,e)}function xows_xmp_roster_get_parse(_,e){if("error"===_.getAttribute("type"))return void xows_log(1,"xmp_roster_get_parse","Parse get Roster",xows_xmp_error_str(_));const o=_.getElementsByTagName("item"),s=[];for(let _=0,e=o.length;_<e;++_)s.push({bare:o[_].getAttribute("jid"),name:o[_].getAttribute("name"),subs:xows_xmp_subs_mask_map[o[_].getAttribute("subscription")],group:xows_xml_get_text(o[_].querySelector("group"))});xows_is_func(e)&&e(s)}function xows_xmp_roster_get_query(_){xows_log(2,"xmp_roster_get_query","Query get Roster"),xows_xmp_send(xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:XOWS_NS_ROSTER})),xows_xmp_roster_get_parse,_)}function xows_xmp_roster_set_query(_,e,o,s){xows_log(2,"xmp_roster_set_query","Query set Roster",_);const t=xows_xml_node("item",{jid:_});e?(t.setAttribute("name",e),void 0!==o&&xows_xml_parent(t,xows_xml_node("group",null,o))):t.setAttribute("subscription","remove"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("query",{xmlns:XOWS_NS_ROSTER},t)),xows_xmp_iq_parse,s)}function xows_xmp_muc_cfg_get_parse(_,e){"error"!==_.getAttribute("type")?xows_is_func(e)&&e(_.getAttribute("from"),xows_xmp_xdata_parse(_.querySelector("x"))):xows_log(1,"xmp_muc_cfg_get_parse","Parse get MUC config",xows_xmp_error_str(_))}function xows_xmp_muc_cfg_get_guery(_,e){xows_log(2,"xmp_muc_cfg_get_guery","Query get MUC config"),xows_xmp_send(xows_xml_node("iq",{to:_,type:"get"},xows_xml_node("query",{xmlns:XOWS_NS_MUCOWNER})),xows_xmp_muc_cfg_get_parse,e)}function xows_xmp_muc_cfg_set_cancel(_,e){xows_log(2,"xmp_muc_cfg_set_cancel","Cancel set MUC config"),xows_xmp_send(xows_xml_node("iq",{to:_,type:"set"},xows_xml_node("query",{xmlns:XOWS_NS_MUCOWNER}),xows_xml_node("x",{xmlns:XOWS_NS_XDATA,type:"cancel"})),xows_xmp_iq_parse,e)}function xows_xmp_muc_cfg_set_query(_,e,o){xows_log(2,"xmp_muc_cfg_set_query","Query set MUC config");const s=xows_xmp_xdata_make(e);xows_xmp_send(xows_xml_node("iq",{to:_,type:"set"},xows_xml_node("query",{xmlns:XOWS_NS_MUCOWNER},s)),xows_xmp_iq_parse,o)}function xows_xmp_pubsub_publish(_,e,o,s){xows_log(2,"xmp_pubsub_publish","Publish PEP node",_);const t=[e];o&&t.push(xows_xml_node("publish-options",{node:_},xows_xmp_xdata_make([{var:"FORM_TYPE",type:"hidden",value:XOWS_NS_PUBSUBOPTS},{var:"pubsub#access_model",value:o}]))),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:XOWS_NS_PUBSUB},t)),xows_xmp_iq_parse,s)}function xows_xmp_vcard4_publish(_,e,o){xows_log(2,"xmp_vcard4_publish","Publish vCard-4");const s=xows_xml_node("publish",{node:XOWS_NS_VCARD4},xows_xml_node("item",null,xows_xml_node("vcard",{xmlns:XOWS_NS_IETF_VCARD4},_)));xows_xmp_pubsub_publish(XOWS_NS_VCARD4,s,e,o)}function xows_xmp_vcard4_get_parse(_,e){let o=null;"error"===_.getAttribute("type")?xows_log(1,"xmp_vcard4_get_parse","Parse get vCard-4",xows_xmp_error_str(_)):o=_.querySelector("vcard"),xows_is_func(e)&&e(_.getAttribute("from"),o)}function xows_xmp_vcard4_get_query(_,e){xows_log(2,"xmp_vcard4_get_query","Query get vCard-4",_),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("vcard",{xmlns:XOWS_NS_IETF_VCARD4})),xows_xmp_vcard4_get_parse,e)}function xows_xmp_vcardtemp_publish(_,e){xows_log(2,"xmp_vcardtemp_publish","Publish vCard-temp"),xows_xmp_send(xows_xml_node("iq",{type:"set",to:xows_xmp_bare},xows_xml_node("vCard",{xmlns:XOWS_NS_VCARD},_)),xows_xmp_iq_parse,e)}function xows_xmp_vcardtemp_get_parse(_,e){"error"!==_.getAttribute("type")?xows_is_func(e)&&e(_.getAttribute("from"),_.querySelector("vCard")):xows_log(1,"xmp_vcardtemp_get_parse","Parse get vcard-Temp",xows_xmp_error_str(_))}function xows_xmp_vcardtemp_get_query(_,e){xows_log(2,"xmp_vcardtemp_get_query_","Query get vcard-Temp");const o=xows_xml_node("iq",{type:"get"},xows_xml_node("vCard",{xmlns:XOWS_NS_VCARD}));null!==_&&o.setAttribute("to",_),xows_xmp_send(o,xows_xmp_vcardtemp_get_parse,e)}function xows_xmp_avat_data_publish(_,e,o,s){xows_log(2,"xmp_avat_data_publish","Publish Avatar Data",_);const t=xows_xml_node("publish",{node:XOWS_NS_AVATAR_DATA},xows_xml_node("item",{id:_},xows_xml_node("data",{xmlns:XOWS_NS_AVATAR_DATA},e)));xows_xmp_pubsub_publish(XOWS_NS_AVATAR_DATA,t,o,s)}function xows_xmp_avat_meta_publish(_,e,o,s,t,c,n){xows_log(2,"xmp_avat_meta_publish","Publish Avatar Metadata",_);const i=xows_xml_node("info",{id:_,type:e,bytes:o,width:s,height:t}),r=xows_xml_node("publish",{node:XOWS_NS_AVATAR_META},xows_xml_node("item",{id:_},xows_xml_node("metadata",{xmlns:XOWS_NS_AVATAR_META},i)));xows_xmp_pubsub_publish(XOWS_NS_AVATAR_META,r,c,n)}function xows_xmp_avat_data_get_parse(_,e){let o,s=null;"error"===_.getAttribute("type")&&xows_log(1,"xmp_avat_data_get_parse","Parse get Avatar Data",xows_xmp_error_str(_));const t=_.querySelector("item");t&&(o=t.getAttribute("id"),s=xows_xml_get_text(t.querySelector("data"))),xows_is_func(e)&&e(_.getAttribute("from"),o,s)}function xows_xmp_avat_data_get_query(_,e,o){xows_log(2,"xmp_avat_data_get_query","Query get Avatar Data",_+" hash:"+e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("pubsub",{xmlns:XOWS_NS_PUBSUB},xows_xml_node("items",{node:XOWS_NS_AVATAR_DATA},xows_xml_node("item",{id:e})))),xows_xmp_avat_data_get_parse,o)}function xows_xmp_avat_meta_get_parse(_,e){"error"!==_.getAttribute("type")?xows_is_func(e)&&e(_.getAttribute("from"),_.querySelector("metadata")):xows_log(1,"xmp_avat_meta_get_parse","Parse get Avatar Metadata",xows_xmp_error_str(_))}function xows_xmp_avat_meta_get_query(_,e){xows_log(2,"xmp_avat_meta_get_query","Query get Avatar Metadata",_),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("pubsub",{xmlns:XOWS_NS_PUBSUB},xows_xml_node("items",{node:XOWS_NS_AVATAR_META}))),xows_xmp_avat_meta_get_parse,e)}function xows_xmp_nick_publish(_,e){xows_log(2,"xmp_nick_publish","Publish Nickname",_);const o=xows_xml_node("publish",{node:XOWS_NS_NICK},xows_xml_node("item",null,xows_xml_node("nick",{xmlns:XOWS_NS_NICK},_)));xows_xmp_pubsub_publish(XOWS_NS_NICK,o,null,e)}function xows_xmp_nick_get_parse(_,e){"error"!==_.getAttribute("type")?xows_is_func(e)&&e(_.getAttribute("from"),_.querySelector("nick")):xows_log(1,"xmp_nick_get_parse","Parse get Nickname",xows_xmp_error_str(_))}function xows_xmp_nick_get_query(_,e){xows_log(2,"xmp_avat_data_get_query","Query get Nickname",_),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("pubsub",{xmlns:XOWS_NS_PUBSUB},xows_xml_node("items",{node:XOWS_NS_NICK},xows_xml_node("item",null)))),xows_xmp_nick_get_parse,e)}function xows_xmp_register_get_parse(_,e){if("error"===_.getAttribute("type"))return void xows_log(1,"xmp_register_get_parse","Parse get Register",xows_xmp_error_str(_));const o=_.querySelector("username"),s=_.querySelector("password"),t=_.querySelector("email"),c=_.querySelector("x"),n=!!_.querySelector("registered"),i=o?xows_xml_get_text(o):null,r=s?xows_xml_get_text(s):null,l=t?xows_xml_get_text(t):null,a=c?xows_xmp_xdata_parse(c):null;xows_is_func(e)&&e(_.getAttribute("from"),n,i,r,l,a)}function xows_xmp_register_get_query(_,e){xows_log(2,"xmp_register_get_query","Query get Register");const o=xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:XOWS_NS_REGISTER}));null!==_&&o.setAttribute("to",_),xows_xmp_send(o,xows_xmp_register_get_parse,e)}function xows_xmp_register_set_query(_,e,o,s,t,c){xows_log(2,"xmp_register_submit","Submit Register");const n=xows_xml_node("query",{xmlns:XOWS_NS_REGISTER});null!==e&&xows_xml_parent(n,xows_xml_node("username",null,e)),null!==o&&xows_xml_parent(n,xows_xml_node("password",null,o)),null!==s&&xows_xml_parent(n,xows_xml_node("email",null,s)),null!==t&&xows_xml_parent(n,xows_xmp_xdata_make(t));const i=xows_xml_node("iq",{type:"set"},n);null!==_&&i.setAttribute("to",_),xows_xmp_send(i,xows_xmp_iq_parse,c)}const xows_xmp_mam_query_param={};function xows_xmp_mam_parse(_,e){if("error"===_.getAttribute("type"))return void xows_log(1,"xmp_mam_parse","Archive query failure",xows_xmp_error_str(_));const o=_.getAttribute("id"),s=xows_xmp_mam_query_param[o].to,t=xows_xmp_mam_query_param[o].with,c=_.querySelector("fin");if(c){let _,o,n,i,r,l,a=0;if(i="true"===c.getAttribute("complete"),(_=c.querySelector("count"))&&(a=parseInt(xows_xml_get_text(_))),!(_=c.querySelector("first")))return xows_log(2,"xmp_mam_parse","No result received"),void(xows_is_func(e)&&e(s,t,[],a,i));o=xows_xml_get_text(_),(_=c.querySelector("last"))&&(n=xows_xml_get_text(_));const x=xows_xmp_mam_stk.length;for(r=0;r<x&&xows_xmp_mam_stk[r].page!==o;r++);if(r>=x)xows_log(0,"xmp_mam_parse","First result page not found in stack",o),l=[];else{let _=r,e=0;do{if(r===x){xows_log(1,"xmp_mam_parse","Last result page not found (reached end of stack)",n);break}e++}while(xows_xmp_mam_stk[r++].page!==n);l=xows_xmp_mam_stk.splice(_,e)}xows_log(2,"xmp_mam_parse","Results collected","("+l.length+"/"+a+") '"+o+"'=>'"+n+"'"),xows_is_func(e)&&e(s,t,l,a,i)}delete xows_xmp_mam_query_param[o]}function xows_xmp_mam_query(_,e,o,s,t,c,n){const i=xows_xmp_get_xep(XOWS_NS_MAM);if(!i)return void xows_log(1,"xmp_mam_query","Message Archive Management is unavailable");const r=[];r.push({var:"FORM_TYPE",type:"hidden",value:i}),o&&r.push({var:"with",value:o}),s&&r.push({var:"start",value:new Date(s).toJSON()}),t&&r.push({var:"end",value:new Date(t).toJSON()});const l=xows_xml_node("set",{xmlns:XOWS_NS_RSM},xows_xml_node("max",null,e));!c&&s||xows_xml_parent(l,xows_xml_node("before",null,c));const a=xows_gen_uuid(),x=xows_xml_node("iq",{id:a,type:"set"},xows_xml_node("query",{xmlns:i},[xows_xmp_xdata_make(r),l]));null!==_&&x.setAttribute("to",_),xows_xmp_mam_query_param[a]={to:_,with:o},xows_log(2,"xmp_mam_query","Send archive query","with "+o+" start "+s+" end "+t),xows_xmp_send(x,xows_xmp_mam_parse,n)}function xows_xmp_upload_parse(_,e){if("error"===_.getAttribute("type")){const o=xows_xmp_error_str(_);return xows_log(1,"xmp_upload_parse","Http-upload query error",o),void(xows_is_func(e)&&e(null,null,null,o))}const o=_.querySelector("slot");if(o){let _,s,t;const c=o.querySelector("put");c&&(_=c.getAttribute("url"),t=c.getElementsByTagName("header"));const n=o.querySelector("get");n&&(s=n.getAttribute("url")),xows_log(2,"xmp_upload_parse","Accepted http-upload slot",_),xows_is_func(e)&&e(_,t,s)}}function xows_xmp_upload_query(_,e,o,s,t){const c=xows_xmp_get_xep(XOWS_NS_HTTPUPLOAD);if(!c)return void xows_log(1,"xmp_upload_query","Http-upload is unvailable");xows_log(2,"xmp_upload_query","Send http-upload query",o+" bytes required");let n={xmlns:c,filename:e,size:o};s&&(n.type=s),xows_xmp_send(xows_xml_node("iq",{to:_,type:"get"},xows_xml_node("request",n)),xows_xmp_upload_parse,t)}function xows_xmp_auth_register_get_handle(_,e,o,s,t,c){if(void 0!==c){let _=c.length;for(;_--;)"username"===c[_].var&&(c[_].value=xows_xmp_user),"password"===c[_].var&&(c[_].value=xows_xmp_auth)}else null!==o&&(o=xows_xmp_user),null!==s&&(s=xows_xmp_auth);xows_xmp_register_set_query(null,o,s,null,c,xows_xmp_auth_register_set_handle)}function xows_xmp_auth_register_set_handle(_,e,o,s,t,c){let n=null;"error"===e?("409"!==s&&"conflict"!==t||(n="Unsername already exists"),"406"!==s&&"not-acceptable"!==t||(n="Invalid username or missing password")):"result"===e?(xows_log(2,"xmp_auth_register_set_handle","success"),xows_xmp_send_close(3),xows_xmp_fw_onregister(xows_xmp_user+"@"+xows_xmp_domain)):n="Unexpected registration error",null!==n&&(xows_xmp_auth=null,xows_log(0,"xmp_auth_register_set_handle",n),xows_xmp_send_close(XOWS_SIG_ERR,n))}function xows_xmp_resp_ping(_){const e=_.getAttribute("from"),o=_.getAttribute("id");xows_log(2,"xmp_resp_ping","Responds to ping",e),xows_xmp_send(xows_xml_node("iq",{id:o,to:e,type:"result"}))}function xows_xmp_resp_time(_){const e=_.getAttribute("from"),o=_.getAttribute("id"),s=new Date;let t=s.getTimezoneOffset()/60,c=t<0?"-":"";c+=((t=Math.abs(t))>9?t:"0"+t)+":00";const n=s.toJSON();xows_log(2,"xmp_resp_time","Responds to time",e),xows_xmp_send(xows_xml_node("iq",{to:e,id:o,type:"result"},xows_xml_node("time",{xmlns:XOWS_NS_TIME},[xows_xml_node("tzo",null,c),xows_xml_node("utc",null,n)])))}function xows_xmp_resp_version(_){const e=_.getAttribute("from"),o=_.getAttribute("id");xows_log(2,"xmp_resp_version","Responds to version",e),xows_xmp_send(xows_xml_node("iq",{to:e,id:o,type:"result"},xows_xml_node("query",{xmlns:XOWS_NS_VERSION},[xows_xml_node("name",null,XOWS_APP_NAME),xows_xml_node("version",null,XOWS_APP_VERS)])))}function xows_xmp_resp_discoinfo(_){const e=_.getAttribute("from"),o=_.getAttribute("id"),s=_.querySelector("query"),t=s?s.getAttribute("node"):null;xows_log(2,"xmp_resp_discoinfo","Responds to disco#info",e);const c=xows_xmp_get_caps();xows_xmp_send(xows_xml_node("iq",{to:e,id:o,type:"result"},xows_xml_node("query",{xmlns:XOWS_NS_DISCOINFO,node:t},c)))}function xows_xmp_recv_open(_){let e=_.getAttribute("xmlns")===XOWS_NS_IETF_FRAMING;if(!("1.0"===_.getAttribute("version"))||!e){const _="Invalid server framing";xows_log(0,"xmp_recv_open",_),xows_xmp_send_close(XOWS_SIG_ERR,_)}return!0}function xows_xmp_recv_close(_){const e="Server closed the stream";return xows_log(1,"xmp_recv_close",e),xows_xmp_send_close(XOWS_SIG_ERR,e),!0}function xows_xmp_recv_streamerror(_){return xows_log(0,"xmp_recv_streamerror",_.firstChild.tagName,xows_xml_get_text(_.querySelector("text"))),xows_xmp_send_close(XOWS_SIG_ERR,"Server thrown a stream error"),!0}function xows_xmp_recv_streamfeatures(_){if(xows_xmp_auth_register){if(_.querySelector("register"))xows_xmp_register_get_query(null,xows_xmp_auth_register_get_handle);else{xows_xmp_auth=null;let _="Account registration is not allowed by server";xows_log(0,"xmp_recv_streamfeatures",_),xows_xmp_send_close(XOWS_SIG_ERR,_)}return!0}const e=_.getElementsByTagName("mechanism");if(0!==e.length){const _=[];for(let o=0,s=e.length;o<s;++o)_.push(xows_xml_get_text(e[o]));if(xows_log(2,"xmp_recv_streamfeatures","Received authentication mechanisms",_.join(", ")),!xows_sasl_init(_,xows_xmp_bare,xows_xmp_user,xows_xmp_auth)){xows_xmp_auth=null;let _="Unable to find a suitable authentication mechanism";return xows_log(0,"xmp_recv_streamfeatures",_),xows_xmp_send_close(XOWS_SIG_ERR,_),!0}xows_xmp_auth=null;const o=xows_sasl_get_selected();xows_log(2,"xmp_recv_streamfeatures","Select authentication mechanism",o);const s=xows_sasl_get_request();return 0!==s.length&&(xows_log(2,"xmp_recv_streamfeatures","Sending authentication request",s),xows_xmp_send(xows_xml_node("auth",{xmlns:XOWS_NS_IETF_SASL,mechanism:o},btoa(s)))),!0}{let e=_.childNodes.length;for(;e--;)xows_xmp_stream_feat.push(_.childNodes[e].getAttribute("xmlns"));xows_log(2,"xmp_recv_streamfeatures","Received features",xows_xmp_stream_feat.join(", ")),xows_xmp_stream_feat.includes(XOWS_NS_IETF_BIND)?xows_xmp_bind_query():xows_xmp_fw_onsession(xows_xmp_bare)}return!1}function xows_xmp_recv_challenge(_){const e=atob(xows_xml_get_text(_));xows_log(2,"xmp_recv_challenge","Received authentication challenge",e);const o=xows_sasl_get_response(e);return xows_log(2,"xmp_recv_challenge","Sending challenge response",o),xows_xmp_send(xows_xml_node("response",{xmlns:XOWS_NS_IETF_SASL},btoa(o))),!0}function xows_xmp_recv_failure(_){let e;const o=_.firstChild.tagName;switch(o.toLowerCase()){case"not-authorized":e="Wrong username or password";break;default:e="Authentication failure"}return xows_log(0,"xmp_recv_failure",e,o),xows_xmp_send_close(XOWS_SIG_ERR,e),!0}function xows_xmp_recv_success(_){const e=xows_xml_get_text(_);if(0!==e.length&&xows_log(2,"xmp_recv_success","Received server proof signature",e),!xows_sasl_chk_integrity(atob(e))){const _="Server integrity check failed";return xows_log(0,"xmp_recv_success",_),xows_xmp_send_close(XOWS_SIG_ERR,_),!0}return xows_log(2,"xmp_recv_success","Authentication success"),xows_xmp_send_open(),!0}function xows_xmp_recv_roster_push(_){xows_xmp_send(xows_xml_node("iq",{id:_.getAttribute("id"),type:"result"},xows_xml_node("query",{xmlns:XOWS_NS_ROSTER})));const e=_.querySelector("item"),o=e.getAttribute("jid"),s=e.getAttribute("name"),t=xows_xmp_subs_mask_map[e.getAttribute("subscription")];let c=e.querySelector("group");c=c?xows_xml_get_text(c):null,xows_log(2,"xmp_recv_roster_push","Received roster push"),xows_xmp_fw_onroster(o,s,t,c)}function xows_xmp_recv_presence(_){const e=_.getAttribute("from");let o,s,t,c,n,i;if(_.hasAttribute("type")){const s=_.getAttribute("type");if("unavailable"===s&&(o=-1),s.includes("subscrib")){xows_log(2,"xmp_recv_presence","Received subscrib",e+" type:"+s);const o=_.querySelector("nick"),t=o?xows_xml_get_text(o):null;return xows_xmp_fw_onsubscrib(e,s,t),!0}if("error"===s)return xows_log(1,"xmp_recv_presence","Error",e+" "+xows_xmp_error_str(_)),!0}let r,l=_.childNodes.length;for(;l--;)if(1===(r=_.childNodes[l]).nodeType)if("show"!==r.tagName)if("priority"!==r.tagName)if("status"!==r.tagName)if("c"!==r.tagName){if("x"===r.tagName){const _=r.getAttribute("xmlns");if(_===XOWS_NS_MUCUSER){const _=r.querySelector("item");n={affiliation:_.getAttribute("affiliation"),role:_.getAttribute("role"),jid:_.getAttribute("jid"),nickname:_.getAttribute("nickname"),code:[]};const e=r.getElementsByTagName("status");let o=e.length;for(;o--;)n.code.push(parseInt(e[o].getAttribute("code")))}_===XOWS_NS_VCARDXUPDATE&&(i=xows_xml_get_text(r.firstChild))}}else r.getAttribute("xmlns")===XOWS_NS_CAPS&&(c={node:r.getAttribute("node"),ver:r.getAttribute("ver")});else t=xows_xml_get_text(r);else s=xows_xml_get_text(r);else{const _=xows_xml_get_text(r);o=_?xows_xmp_show_level_map[_]:3}return void 0!==n?(xows_log(2,"xmp_recv_presence","Received MUC occupant",e),xows_xmp_fw_onoccupant(e,o,t,n,i),!0):(xows_log(2,"xmp_recv_presence","Received presence",e+" show:"+o),xows_xmp_fw_onpresence(e,o,s,t,c,i),!0)}function xows_xmp_recv_mam_result(_){const e=_.getAttribute("id"),o=_.querySelector("forwarded");if(!o)return!1;let s,t,c,n,i,r;const l=o.querySelector("delay");l&&(n=new Date(l.getAttribute("stamp")).getTime());const a=o.querySelector("message");if(a){s=a.getAttribute("id"),t=a.getAttribute("from"),c=a.getAttribute("to");let _,o,l,x,w=a.childNodes.length;for(;w--;)1===(_=a.childNodes[w]).nodeType&&(o=_.getAttribute("xmlns"),l=_.tagName,o!==XOWS_NS_CHATSTATES?"body"===_.tagName&&(i=_.hasChildNodes()?xows_xml_get_text(_):""):r=l);return void 0!==i?(n||(n=new Date(0).getTime()),xows_xmp_mam_stk.push({page:e,id:s,from:t,to:c,time:n,body:i}),x="Adding archived message to result stack"):x="Skipped archived message without body",xows_log(2,"xmp_recv_mam_result",x,"from "+t+" to "+c),!0}return!1}function xows_xmp_recv_pubsub(_,e){const o=e.querySelector("items");if(!o)return!1;const s=o.getAttribute("node"),t=[];for(let _=0,e=o.childNodes.length;_<e;++_)t.push({id:o.childNodes[_].getAttribute("id"),data:o.childNodes[_].firstChild});return xows_xmp_fw_onpubsub(_,s,t),!0}function xows_xmp_recv_message(_){const e=_.getAttribute("type"),o=_.getAttribute("id"),s=_.getAttribute("from"),t=_.getAttribute("to");let c,n,i,r,l,a,x,w,u=_.childNodes.length;for(;u--;)if(1===(w=_.childNodes[u]).nodeType){if((a=w.getAttribute("xmlns"))===xows_xmp_get_xep(XOWS_NS_MAM))return xows_log(2,"xmp_recv_message","Received archive result"),xows_xmp_recv_mam_result(w);if(a===XOWS_NS_PUBSUBEVENT)return xows_log(2,"xmp_recv_message","Received PubSub Event"),xows_xmp_recv_pubsub(s,w);if(a===xows_xmp_get_xep(XOWS_NS_CARBONS)){xows_log(2,"xmp_recv_message","Received forwarded carbons");const _=w.querySelector("message");return!!_&&xows_xmp_recv_message(_)}if(x=w.tagName,a===XOWS_NS_RECEIPTS)if("request"===x)xows_log(2,"xmp_recv_message","Received receipt request"),xows_xmp_send_receipt(s,o);else if("received"===x){l=w.getAttribute("id");continue}a!==XOWS_NS_CHATSTATES?a!==XOWS_NS_DELAY?"body"!==x?"subject"===x&&(n=xows_xml_get_text(w)):c=xows_xml_get_text(w):i=new Date(w.getAttribute("stamp")).getTime():r=xows_xmp_chat_mask_map[x]}let d=!1;return void 0!==r&&(xows_xmp_fw_onchatstate(o,e,s,t,r,i),d=!0),void 0!==c&&(xows_xmp_fw_onmessage(o,e,s,t,c,i),d=!0),void 0!==l&&(xows_xmp_fw_onreceipt(o,s,t,l,i),d=!0),void 0!==n&&(xows_xmp_fw_onsubject(o,s,n),d=!0),xows_log(2,"xmp_recv_message",d?"Handling message":"Unhandled message","from "+s+" to "+t),d}function xows_xmp_recv_iq(_){if("get"===_.getAttribute("type")){const e=_.firstChild;if(void 0!==e){const o=e.getAttribute("xmlns");if(o===XOWS_NS_PING)return xows_xmp_resp_ping(_);if(o===XOWS_NS_TIME)return xows_xmp_resp_time(_);if(o===XOWS_NS_VERSION)return xows_xmp_resp_version(_);if(o===XOWS_NS_DISCOINFO)return xows_xmp_resp_discoinfo(_)}return!1}if("set"===_.getAttribute("type")){const e=_.firstChild;if(void 0!==e){if(e.getAttribute("xmlns")===XOWS_NS_ROSTER)return xows_xmp_recv_roster_push(_)}return!1}const e=_.getAttribute("id");let o=xows_xmp_iq_stk.length;for(;o--;)if(xows_xmp_iq_stk[o].id===e){if(xows_is_func(xows_xmp_iq_stk[o].onresult))return xows_xmp_iq_stk[o].onresult(_,xows_xmp_iq_stk[o].onparse);xows_log(1,"xmp_recv_iq","Invalid onresult callback for query",e),xows_xmp_iq_stk.splice(o,1)}return!1}function xows_xmp_send_presence(_,e,o,s,t,c,n){const i=xows_xml_node("presence");_&&i.setAttribute("to",_),e&&i.setAttribute("type",e),o>=0&&(xows_xml_parent(i,xows_xml_node("show",null,xows_xmp_show_name_map[o])),xows_xml_parent(i,xows_xml_node("priority",null,20*o)),s&&xows_xml_parent(i,xows_xml_node("status",null,s)),xows_cli_feat_srv_has(XOWS_NS_VCARD)&&xows_xml_parent(i,xows_xml_node("x",{xmlns:XOWS_NS_VCARDXUPDATE},t?xows_xml_node("photo",null,t):null)),xows_xml_parent(i,xows_xml_node("c",{xmlns:XOWS_NS_CAPS,hash:"sha-1",node:XOWS_APP_NODE,ver:xows_xmp_get_caps_ver()}))),c&&xows_xml_parent(i,xows_xml_node("x",{xmlns:XOWS_NS_MUC})),n&&xows_xml_parent(i,xows_xml_node("nick",{xmlns:XOWS_NS_NICK},n)),xows_log(2,"xmp_send_presence",e||"Availability",(_||"")+" show:"+xows_xmp_show_name_map[o]),xows_xmp_send(i)}function xows_xmp_send_receipt(_,e){xows_log(2,"xmp_send_receipt","Send message receipt","received "+e+" to "+_),xows_xmp_send(xows_xml_node("message",{to:_},xows_xml_node("received",{id:e,xmlns:XOWS_NS_RECEIPTS})))}function xows_xmp_send_chatstate(_,e,o){const s=xows_xmp_chat_name_map[o];xows_log(2,"xmp_send_chatstate","Send chat state",s+" to "+_),xows_xmp_send(xows_xml_node("message",{to:_,type:e},xows_xml_node(s,{xmlns:XOWS_NS_CHATSTATES})))}function xows_xmp_send_message(_,e,o,s){const t=xows_gen_uuid(),c=xows_xml_node("message",{id:t,to:e,type:_},xows_xml_node("body",null,xows_xml_escape(o)));return s&&xows_xml_parent(c,xows_xml_node("request",{xmlns:XOWS_NS_RECEIPTS})),xows_log(2,"xmp_send_message","Send message","type "+_+" to "+e),xows_xmp_send(c),t}function xows_xmp_send_subject(_,e){const o=xows_gen_uuid();return xows_log(2,"xmp_send_subject","Send subject to",_),xows_xmp_send(xows_xml_node("message",{id:o,to:_,type:"groupchat"},xows_xml_node("subject",null,xows_xml_escape(e)))),o}function xows_xmp_send_close(_,e){xows_log(2,"xmp_close","Closing the stream"),xows_xmp_send(xows_xml_node("close",{xmlns:XOWS_NS_IETF_FRAMING,id:"_ciao"})),xows_xmp_fw_onclose(_,e),xows_sck_destroy()}function xows_xmp_send_open(){xows_log(2,"xmp_send_open","Sending stream open request",XOWS_NS_IETF_FRAMING),xows_xmp_send(xows_xml_node("open",{to:xows_xmp_domain,version:"1.0",xmlns:XOWS_NS_IETF_FRAMING}))}function xows_xmp_sck_open(){xows_xmp_send_open()}function xows_xmp_sck_close(_,e){xows_xmp_fw_onclose(_,e)}function xows_xmp_sck_recv(_){const e=xows_xml_parse(_).firstChild,o=e.tagName;return"iq"===o?xows_xmp_recv_iq(e):"message"===o?xows_xmp_recv_message(e):"presence"===o?xows_xmp_recv_presence(e):"open"===o?xows_xmp_recv_open(e):"close"===o?xows_xmp_recv_close(e):"stream:error"===o?xows_xmp_recv_streamerror(e):"stream:features"===o?xows_xmp_recv_streamfeatures(e):"challenge"===o?xows_xmp_recv_challenge(e):"success"===o?xows_xmp_recv_success(e):"failure"===o?xows_xmp_recv_failure(e):void xows_log(1,"xmp_recv","Unprocessed stanza",event.data)}function xows_xmp_connect(_,e,o,s){xows_sck_destroy(),xows_xmp_res=null,xows_xmp_jid=null;const t=e.split("@");if(xows_xmp_domain=null,void 0!==t[1]&&0!==t[1].length&&(xows_xmp_domain=t[1]),null===xows_xmp_domain){let _="Incomplete JID (undefined domain)";return xows_log(0,"xmp_connect",_),void xows_xmp_fw_onclose(XOWS_SIG_ERR,_)}xows_xmp_bare=e,xows_xmp_user=t[0],xows_xmp_auth=o,xows_sck_set_callback("open",xows_xmp_sck_open),xows_sck_set_callback("recv",xows_xmp_sck_recv),xows_sck_set_callback("close",xows_xmp_sck_close),xows_xmp_auth_register=s,xows_xmp_url=_,xows_sck_create(_,"xmpp")}const XOWS_PEER_NONE=0,XOWS_PEER_CONT=1,XOWS_PEER_ROOM=2,XOWS_PEER_OCCU=3,XOWS_AVAT_SIZE=48,xows_cli_feat_own=[],xows_cli_feat_srv=[];function xows_cli_feat_own_has(_){return xows_cli_feat_own.includes(_)}function xows_cli_feat_srv_has(_){return xows_cli_feat_srv.includes(_)}const xows_cli_cont=[],xows_cli_room=[];let xows_cli_fw_onconnect=function(){},xows_cli_fw_onregister=function(){},xows_cli_fw_onownchange=function(){},xows_cli_fw_oncontpush=function(){},xows_cli_fw_oncontrem=function(){},xows_cli_fw_onsubspush=function(){},xows_cli_fw_onsubsrem=function(){},xows_cli_fw_onroompush=function(){},xows_cli_fw_onoccupush=function(){},xows_cli_fw_onoccurem=function(){},xows_cli_fw_onmessage=function(){},xows_cli_fw_onchatstate=function(){},xows_cli_fw_onreceipt=function(){},xows_cli_fw_onsubject=function(){},xows_cli_fw_onerror=function(){},xows_cli_fw_onclose=function(){},xows_cli_own={type:XOWS_PEER_CONT,jid:"",bare:"",name:"",avat:"",show:-1,stat:null};const xows_cli_service_url={};function xows_cli_service_exist(_){return _ in xows_cli_service_url}function xows_cli_new_cont(_,e,o,s){const t={type:XOWS_PEER_CONT,bare:_,lock:_,name:e||_,subs:o,ress:{},avat:s,show:-1,stat:"",noti:!0};return xows_cli_cont.push(t),t}function xows_cli_new_room(_,e,o,s){const t={type:XOWS_PEER_ROOM,bare:_,name:e,desc:o,subj:"",priv:s,join:null,occu:[],noti:!0};return xows_cli_room.push(t),t}function xows_cli_new_room_occu(_,e,o,s,t,c,n,i){const r={type:XOWS_PEER_OCCU,jid:e,name:xows_jid_to_nick(e),affi:o,role:s,full:t,bare:t?xows_jid_to_bare(t):null,avat:c,show:n,stat:i,self:!!t&&xows_cli_is_own(t)};return _.occu.push(r),r}function xows_cli_get_cont(_){const e=xows_jid_to_bare(_);let o=xows_cli_cont.length;for(;o--;)if(xows_cli_cont[o].bare===e)return xows_cli_cont[o];return null}function xows_cli_get_room(_){const e=xows_jid_to_bare(_);let o=xows_cli_room.length;for(;o--;)if(xows_cli_room[o].bare===e)return xows_cli_room[o];return null}function xows_cli_get_peer(_){const e=xows_jid_to_bare(_);let o=xows_cli_room.length;for(;o--;)if(xows_cli_room[o].bare===e)return xows_cli_room[o];for(o=xows_cli_cont.length;o--;)if(xows_cli_cont[o].bare===e)return xows_cli_cont[o];return null}function xows_cli_get_occu(_,e){if(!_.occu)return null;let o=_.occu.length;for(;o--;)if(_.occu[o].jid===e)return _.occu[o];return null}function xows_cli_is_own(_){return _.includes(xows_cli_own.bare)}function xows_cli_get_autor(_,e){if(_.type===XOWS_PEER_CONT)return e.includes(xows_cli_own.bare)?xows_cli_own:_;if(_.join===e)return xows_cli_own;{const o=xows_cli_get_occu(_,e);return o||xows_cli_cache_occu_temp(e)}}const xows_cli_cache_avat_db={};function xows_cli_cache_avat_add(_,e){const o=e||xows_bytes_to_hex(xows_hash_sha1(xows_url_to_bytes(_)));return xows_cli_cache_avat_db[o]=_,localStorage.setItem(o,_),o}function xows_cli_cache_avat_has(_){return _ in xows_cli_cache_avat_db||_ in localStorage}function xows_cli_cache_avat_get(_){return _ in xows_cli_cache_avat_db?xows_cli_cache_avat_db[_]:_ in localStorage?(xows_cli_cache_avat_db[_]=localStorage.getItem(_),xows_cli_cache_avat_db[_]):null}const xows_cli_cache_peer_db={};function xows_cli_cache_peer_add(_,e,o,s){let t=null;if(e&&o&&s)t={name:e,note:o,avat:s};else{try{t=JSON.parse(localStorage.getItem(_))}catch(_){xows_log(1,"cli_cache_peer_add","JSON parse error",_)}null!==t?(null!==e&&(t.name=e),null!==o&&(t.note=o),null!==s&&(t.avat=s)):t={name:e,note:o,avat:s}}xows_cli_cache_peer_db[_]=t,localStorage.setItem(_,JSON.stringify(t))}function xows_cli_cache_peer_has(_){return _ in xows_cli_cache_peer_db||_ in localStorage}function xows_cli_cache_peer_get(_){if(_ in xows_cli_cache_peer_db)return xows_cli_cache_peer_db[_];if(_ in localStorage){try{xows_cli_cache_peer_db[_]=JSON.parse(localStorage.getItem(_))}catch(e){return xows_log(1,"cli_cache_peer_get","JSON parse error",e),localStorage.removeItem(_),null}return xows_cli_cache_peer_db[_]}return null}const xows_cli_cache_occu_tmp_db={};function xows_cli_cache_occu_temp(_){if(_ in xows_cli_cache_occu_tmp_db)return xows_cli_cache_occu_tmp_db[_];const e=xows_jid_to_nick(_),o=xows_cli_cache_peer_get(_),s=o?o.avat:null;return xows_cli_cache_occu_tmp_db[_]={name:e,avat:s||xows_cli_cache_avat_temp(e)},xows_cli_cache_occu_tmp_db[_]}const xows_cli_cache_avat_tmp_db={};function xows_cli_cache_avat_temp(_){if(_ in xows_cli_cache_avat_tmp_db)return xows_cli_cache_avat_tmp_db[_];const e=xows_gen_avatar(XOWS_AVAT_SIZE,null,_),o=xows_bytes_to_hex(xows_hash_sha1(e));return xows_cli_cache_avat_tmp_db[_]=o,xows_cli_cache_avat_db[o]=e,o}const xows_cli_cache_caps_db={};function xows_cli_cache_caps_add(_,e){xows_cli_cache_caps_db[_]=e,localStorage.setItem(_,JSON.stringify(e))}function xows_cli_cache_caps_has(_){return _ in xows_cli_cache_caps_db||_ in localStorage}function xows_cli_cache_caps_get(_){if(_ in xows_cli_cache_caps_db)return xows_cli_cache_caps_db[_];if(_ in localStorage){try{xows_cli_cache_caps_db[_]=JSON.parse(localStorage.getItem(_))}catch(e){return xows_log(1,"cli_cache_caps_get","JSON parse error",e),localStorage.removeItem(_),null}return xows_cli_cache_caps_db[_]}return null}function xows_cli_cache_caps_try(_,e){const o=xows_cli_cache_caps_get(_);return!!o&&o.includes(e)}function xows_cli_set_callback(_,e){if(xows_is_func(e))switch(_.toLowerCase()){case"connect":xows_cli_fw_onconnect=e;break;case"register":xows_cli_fw_onregister=e;break;case"ownchange":xows_cli_fw_onownchange=e;break;case"contpush":xows_cli_fw_oncontpush=e;break;case"contrem":xows_cli_fw_oncontrem=e;break;case"subspush":xows_cli_fw_onsubspush=e;break;case"subsrem":xows_cli_fw_onsubsrem=e;break;case"roompush":xows_cli_fw_onroompush=e;break;case"occupush":xows_cli_fw_onoccupush=e;break;case"occurem":xows_cli_fw_onoccurem=e;break;case"message":xows_cli_fw_onmessage=e;break;case"chatstate":xows_cli_fw_onchatstate=e;break;case"receipt":xows_cli_fw_onreceipt=e;break;case"subject":xows_cli_fw_onsubject=e;break;case"error":xows_cli_fw_onerror=e;break;case"close":xows_cli_fw_onclose=e}}let xows_cli_initialize=!0;function xows_cli_connect(_,e,o,s){xows_cli_cont.length=0,xows_cli_room.length=0,xows_cli_feat_own.length=0,xows_cli_feat_srv.length=0;for(const _ in xows_cli_service_url)delete xows_cli_service_url[_];return xows_cli_own.jid=e,xows_cli_own.bare=e,xows_cli_own.name=null,xows_cli_own.avat=null,xows_cli_own.show=-1,xows_cli_own.stat=null,xows_xmp_set_callback("session",xows_cli_xmp_session),xows_xmp_set_callback("register",xows_cli_xmp_register),xows_xmp_set_callback("presence",xows_cli_xmp_recv_presence),xows_xmp_set_callback("subscrib",xows_cli_xmp_recv_subscribe),xows_xmp_set_callback("occupant",xows_cli_xmp_recv_occupant),xows_xmp_set_callback("roster",xows_cli_roster_push_handle),xows_xmp_set_callback("message",xows_cli_xmp_recv_message),xows_xmp_set_callback("chatstate",xows_cli_xmp_recv_chatstate),xows_xmp_set_callback("receipt",xows_cli_xmp_recv_receipt),xows_xmp_set_callback("subject",xows_cli_xmp_recv_subject),xows_xmp_set_callback("pubsub",xows_cli_xmp_recv_pubsub),xows_xmp_set_callback("close",xows_cli_xmp_closed),s||(xows_cli_initialize=!0),xows_xmp_connect(_,e,o,s)}function xows_cli_xmp_session(_){xows_cli_own.jid=_;const e=xows_cli_cache_peer_get(xows_cli_own.bare);if(null!==e&&(e.name&&(xows_cli_own.name=e.name),e.avat&&(xows_cli_own.avat=e.avat),e.stat&&(xows_cli_own.stat=e.stat)),null===xows_cli_own.name){const _=xows_xmp_bare.split("@")[0];xows_cli_own.name=_[0].toUpperCase()+_.slice(1)}xows_cli_own.avat||(xows_cli_own.avat=xows_cli_cache_avat_temp(xows_cli_own.bare)),xows_xmp_discoinfo_query(xows_cli_own.bare,null,xows_cli_own_info_handle)}function xows_cli_xmp_register(_){xows_log(2,"cli_xmp_register","Registration succeed",_),xows_cli_fw_onregister(_)}function xows_cli_xmp_closed(_,e){xows_cli_cont.length=0,xows_cli_room.length=0,xows_cli_own.jid=null,xows_cli_own.bare=null,xows_cli_fw_onclose(_,e)}function xows_cli_own_info_handle(_,e,o){for(let _=0,e=o.length;_<e;++_)xows_cli_feat_own.push(o[_]),o[_].includes(XOWS_NS_MAM)&&xows_xmp_use_xep(o[_]);xows_xmp_discoinfo_query(xows_xmp_domain,null,xows_cli_srv_info_handle)}function xows_cli_srv_info_handle(_,e,o){for(let _=0,e=o.length;_<e;++_)xows_cli_feat_srv.push(o[_]),o[_].includes(XOWS_NS_CARBONS)&&xows_xmp_use_xep(o[_])&&xows_xmp_carbons_query(!0),o[_].includes(XOWS_NS_HTTPUPLOAD)&&xows_xmp_use_xep(o[_]),o[_].includes(XOWS_NS_MUC)&&xows_xmp_use_xep(o[_]);xows_xmp_discoitems_query(xows_xmp_domain,xows_cli_srv_items_handle)}const xows_cli_srv_items_stack=[];function xows_cli_srv_items_handle(_,e){if(!e.length)return void xows_cli_roster_get_query();xows_cli_srv_items_stack.length=0;let o=e.length;for(;o--;)xows_cli_srv_items_stack.push(e[o].jid);xows_xmp_discoinfo_query(xows_cli_srv_items_stack.pop(),null,xows_cli_srv_item_info_handle)}function xows_cli_srv_item_info_handle(_,e,o){const s=e[0].category,t=e[0].type;let c;if(xows_log(2,"cli_srv_item_info_handle","Discover service features",_+": "+s+", "+t+', "'+e[0].name+'"'),"store"===s&&"file"===t)for(c=o.length;c--;)o[c].includes(XOWS_NS_HTTPUPLOAD)&&(xows_xmp_use_xep(o[c]),xows_cli_service_url[XOWS_NS_HTTPUPLOAD]=_,xows_log(2,"cli_srv_item_info_handle","Use service for Http-Upload",_));if("conference"===s&&"text"===t)for(c=o.length;c--;)o[c]===XOWS_NS_MUC&&(xows_cli_service_url[XOWS_NS_MUC]=_,xows_log(2,"cli_srv_item_info_handle","Use service for Multi-User Chat",_));xows_cli_srv_items_stack.length?xows_xmp_discoinfo_query(xows_cli_srv_items_stack.pop(),null,xows_cli_srv_item_info_handle):xows_cli_roster_get_query()}function xows_cli_roster_push_handle(_,e,o,s){if(o<0){xows_log(2,"cli_roster_push_handle","Roster update",_+' "'+e+'" subscription: '+o);let s=xows_cli_cont.length;for(;s--;)if(xows_cli_cont[s].bare===_){xows_log(2,"cli_roster_push_handle","Removing contact",_),xows_cli_cont.splice(s,1),xows_cli_fw_oncontrem(_);break}return}xows_log(2,"cli_roster_push_handle","Update Contact",_+' "'+e+'" subscription: '+o);let t=xows_cli_get_cont(_);if(null!==t)t.name=e||_,t.subs=o;else{let s=null;const c=xows_cli_cache_peer_get(_);null!==c&&(e=c.name,s=c.avat),s||(s=xows_cli_cache_avat_temp(_)),t=xows_cli_new_cont(_,e,o,s)}xows_options.avatar_notify||xows_cli_avat_meta_query(_),xows_cli_nick_query(_),xows_cli_fw_oncontpush(t)}function xows_cli_roster_get_handle(_){if(xows_cli_cont.length=0,_.length)for(let e=0,o=_.length;e<o;++e)xows_cli_roster_push_handle(_[e].bare,_[e].name,_[e].subs,_[e].group);else xows_cli_fw_oncontpush(null);xows_cli_initialize&&xows_cli_presence_init()}function xows_cli_roster_get_query(){xows_xmp_roster_get_query(xows_cli_roster_get_handle)}function xows_cli_profile_handle(_,e,o,s){if(!_||xows_cli_is_own(_))xows_cli_cache_peer_add(xows_cli_own.bare,e,s,o),e&&(xows_cli_own.name=e),o&&(xows_cli_own.avat=o),s&&(xows_cli_own.stat=s),xows_cli_fw_onownchange(xows_cli_own),(o||s)&&xows_cli_presence_update(),xows_log(2,"cli_profile_handle","Received own profile data");else{const t=xows_cli_get_peer(_);if(!t)return void xows_log(1,"cli_profile_handle","Unknown/unsubscribed peer",_);if(xows_cli_cache_peer_add(_,e,s,o),t.type===XOWS_PEER_CONT)e&&(t.name=e),o&&(t.avat=o),s&&(t.stat=s),xows_cli_fw_oncontpush(t);else{const s=xows_cli_get_occu(t,_);s&&(e&&(s.name=e),o&&(s.avat=o),xows_cli_fw_onoccupush(t,s))}xows_log(2,"cli_profile_handle","Received profile data for",_)}}function xows_cli_vcard_query(_){xows_log(2,"cli_vcard_query","Query vCard for",_),xows_cli_feat_own_has(XOWS_NS_IETF_VCARD4)&&!xows_options.legacy_vcard?xows_xmp_vcard4_get_query(_,xows_cli_vcard_handle):xows_xmp_vcardtemp_get_query(_,xows_cli_vcard_handle)}let xows_cli_vcard_own=null;function xows_cli_vcard_handle(_,e){let o,s,t,c;if(xows_log(2,"cli_vcard_handle","Parse recevied vCard",_),e){if(xows_cli_vcard_own=e,xows_cli_feat_own_has(XOWS_NS_IETF_VCARD4)&&!xows_options.legacy_vcard)(o=e.querySelector("nickname"))&&(s=xows_xml_get_text(o.firstChild)),(o=e.querySelector("note"))&&(t=xows_xml_get_text(o.firstChild)),(o=e.querySelector("photo"))&&(c=xows_xml_get_text(o.firstChild));else if((o=e.querySelector("NICKNAME"))&&(s=xows_xml_get_text(o)),(o=e.querySelector("NOTE"))?t=xows_xml_get_text(o):(o=e.querySelector("DESC"))&&(t=xows_xml_get_text(o)),o=e.querySelector("PHOTO")){c="data:"+xows_xml_get_text(o.querySelector("TYPE"))+";base64,"+xows_xml_get_text(o.querySelector("BINVAL"))}s&&0===s.length&&(s=null),t&&0===t.length&&(t=null),c&&0===c.length&&(c=null)}xows_cli_profile_handle(_,s,c?xows_cli_cache_avat_add(c):null,t)}function xows_cli_vcard_publish(_){let e;const o=xows_cli_cache_avat_get(xows_cli_own.avat),s=xows_cli_vcard_own||xows_xml_node("vcard");if(xows_cli_feat_own_has(XOWS_NS_IETF_VCARD4)&&!xows_options.legacy_vcard)(e=s.querySelector("nickname"))&&e.parentNode.removeChild(e),xows_xml_parent(s,xows_xml_node("nickname",null,xows_xml_node("text",null,xows_cli_own.name))),(e=s.querySelector("note"))&&e.parentNode.removeChild(e),xows_xml_parent(s,xows_xml_node("note",null,xows_xml_node("text",null,xows_cli_own.stat))),o&&((e=s.querySelector("photo"))&&e.parentNode.removeChild(e),xows_xml_parent(s,xows_xml_node("photo",null,xows_xml_node("uri",null,o))));else if((e=s.querySelector("NICKNAME"))&&e.parentNode.removeChild(e),xows_xml_parent(s,xows_xml_node("NICKNAME",null,xows_cli_own.name)),(e=s.querySelector("DESC"))&&e.parentNode.removeChild(e),xows_xml_parent(s,xows_xml_node("DESC",null,xows_cli_own.stat)),o){const _=xows_url_to_type(o),t=xows_url_to_data(o);(e=s.querySelector("PHOTO"))&&e.parentNode.removeChild(e),xows_xml_parent(s,xows_xml_node("PHOTO",null,[xows_xml_node("TYPE",null,_),xows_xml_node("BINVAL",null,t)]))}xows_log(2,"cli_vcard_publish","Publish own vCard");const t=[];for(let _=0,e=s.childNodes.length;_<e;++_)t.push(s.childNodes[_]);xows_cli_feat_own_has(XOWS_NS_IETF_VCARD4)&&!xows_options.legacy_vcard?xows_xmp_vcard4_publish(t,_?"open":"presence"):xows_xmp_vcardtemp_publish(t)}const xows_cli_avat_handle_temp={};function xows_cli_avat_data_handle(_,e,o){let s=null;if(o){if(xows_log(2,"cli_avat_data_handle","Handle received Avatar Data",e),!(e in xows_cli_avat_handle_temp))return void xows_log(1,"cli_avat_data_handle","Received Avatar Data without Metadata",e);s=xows_cli_cache_avat_add("data:"+xows_cli_avat_handle_temp[e]+";base64,"+o,e)}else xows_log(2,"cli_avat_data_handle","Handle cached Avatar Data",e),s=e;xows_cli_profile_handle(_,null,s,null)}function xows_cli_avat_meta_handle(_,e){if(e){const o=e.querySelector("info");if(o){const e=o.getAttribute("id");xows_cli_avat_handle_temp[e]=o.getAttribute("type"),xows_cli_cache_avat_has(e)?(xows_log(2,"cli_avat_meta_handle","Avatar Data already cached",e),xows_cli_avat_data_handle(_,e,null)):(xows_log(2,"cli_avat_meta_handle","Avatar Data unavailable",e),xows_xmp_avat_data_get_query(_,e,xows_cli_avat_data_handle))}}}function xows_cli_avat_meta_query(_){xows_log(2,"cli_avat_meta_query","Query Avatar Metadata",_),xows_xmp_avat_meta_get_query(_,xows_cli_avat_meta_handle)}let xows_cli_avat_publish_temp=null;function xows_cli_avat_meta_publish(_=null,e="result"){if("result"===e)if(xows_log(2,"cli_avat_meta_publish","Avatar Data publication succeed","Now publish metadata"),xows_cli_avat_publish_temp){const _=xows_cli_avat_publish_temp.open,e=xows_cli_avat_publish_temp.hash,o=xows_cli_avat_publish_temp.type,s=xows_cli_avat_publish_temp.bytes;xows_xmp_avat_meta_publish(e,o,s,XOWS_AVAT_SIZE,XOWS_AVAT_SIZE,_?"open":"presence",null),xows_log(2,"cli_avat_meta_publish","Publish Avatar Metadata","id:"+e+" bytes:"+s)}else xows_log(1,"cli_avat_meta_publish","No temp Metadata stored");xows_cli_avat_publish_temp=null}function xows_cli_avat_data_publish(_){const e=xows_cli_cache_avat_get(xows_cli_own.avat);if(e){const o=xows_url_to_data(e),s=xows_url_to_type(e),t=atob(o),c=xows_bytes_to_hex(xows_hash_sha1(t));xows_cli_avat_publish_temp={open:_,hash:c,type:s,bytes:t.length},xows_log(2,"cli_avat_data_publish","Publish Avatar Data",c),xows_xmp_avat_data_publish(c,o,_?"open":"presence",xows_cli_avat_meta_publish)}else xows_log(1,"cli_avat_data_publish","No Data to publish")}function xows_cli_nick_handle(_,e){xows_log(2,"cli_nick_handle","Parse received Nickname",_),xows_cli_profile_handle(_,xows_xml_get_text(e),null,null)}function xows_cli_nick_query(_){xows_log(2,"cli_nick_query","Query nickname",_),xows_xmp_nick_get_query(_,xows_cli_nick_handle)}function xows_cli_nick_publish(){xows_log(2,"cli_nick_publish","Publish own Nickname",xows_cli_own.name),xows_xmp_nick_publish(xows_cli_own.name)}function xows_cli_xmp_recv_subscribe(_,e,o){let s;switch(e){case"subscribe":s="request";break;case"unsubscribed":s="denied";break;case"subscribed":s="allowed";break;case"unsubscribe":s="removed"}if(xows_log(2,"cli_xmp_recv_subscribe","Subscription "+s+" by",_),"subscribe"===e){const e=xows_cli_get_cont(_);e?(xows_log(2,"cli_xmp_recv_subscribe","Request automatically allowed","Contact in Roster"),xows_cli_subscribe_allow(e.bare,!0,o)):xows_cli_fw_onsubspush(xows_jid_to_bare(_),o)}}function xows_cli_xmp_recv_presence(_,e,o,s,t,c){const n=xows_cli_get_cont(_);if(!n)return void(xows_jid_to_bare(_)!==xows_xmp_bare&&xows_log(1,"cli_xmp_recv_presence","Unknown/unsubscribed contact",_));n.lock=n.bare;let i=xows_jid_to_nick(_);if(e>=0){if(n.ress[i])xows_log(2,"cli_xmp_recv_presence","Updating resource for "+n.bare,i),n.ress[i].show=e,n.ress[i].prio=o,n.ress[i].stat=s;else if(xows_log(2,"cli_xmp_recv_presence","Adding resource for "+n.bare,i),n.ress[i]={show:e,prio:o,stat:s,node:null},t){const e=t.node+"#"+t.ver;n.ress[i].node=e,xows_cli_cache_caps_has(e)||(xows_log(2,"cli_xmp_recv_presence","Query entity caps for "+n.bare,e),xows_xmp_discoinfo_query(_,e,xows_cli_entity_caps_handle))}}else n.ress[i]&&(xows_log(2,"cli_xmp_recv_presence","Removing resource for "+n.bare,i),delete n.ress[i]);n.show=-1,n.stat=null;let r=-128;for(const _ in n.ress)n.ress.hasOwnProperty(_)&&n.ress[_].prio>r&&(r=n.ress[_].prio,n.show=n.ress[_].show,n.stat=n.ress[_].stat);xows_log(2,"cli_xmp_recv_presence","Updated presence for "+n.bare,"show:"+n.show+" stat:"+n.stat),c&&(xows_cli_cache_avat_has(c)?n.avat=c:xows_cli_vcard_query(n.bare)),xows_cli_cache_peer_add(n.bare,null,n.stat,null),xows_cli_fw_oncontpush(n)}function xows_cli_xmp_recv_occupant(_,e,o,s,t){const c=xows_cli_get_room(_);if(!c)return void xows_log(1,"cli_xmp_recv_occupant","Unknown/unjoined room",_);if(e<0){let e=c.occu.length;for(;e--;)if(c.occu[e].jid===_){c.occu.splice(e,1),xows_cli_fw_onoccurem(c,_);break}return}if(s.code.length)for(let e=0,o=s.code.length;e<o;++e)if(201===s.code[e]){xows_log(2,"cli_xmp_recv_occupant","Request initial room config",_),xows_xmp_muc_cfg_get_guery(c.bare,xows_cli_muc_cfg_get_handle);break}const n=xows_jid_to_nick(_),i=s.affiliation,r=s.role,l=s.jid,a=l?xows_jid_to_bare(l):null;let x=xows_cli_get_occu(c,_);if(x)xows_log(2,"cli_xmp_recv_occupant","Refresh occupant of "+c.name,n+" ("+l+")"),x.full=l,x.bare=a,x.affi=i,x.role=r,x.show=e,x.stat=o,t&&(xows_cli_cache_avat_has(t)?x.avat=t:xows_cli_vcard_query(_));else{xows_log(2,"cli_xmp_recv_occupant","Adding occupant to "+c.name,n+" ("+l+")");let s=null;a&&xows_cli_cache_peer_get(a),s||xows_cli_cache_peer_get(_);let t=null;s&&s.avat&&(t=s.avat),t||(t=xows_cli_cache_avat_temp(_)),x=xows_cli_new_room_occu(c,_,i,r,l,t,e,o),xows_cli_avat_meta_query(_)}xows_cli_fw_onoccupush(c,x)}function xows_cli_entity_caps_handle(_,e,o,s,t){xows_cli_cache_caps_has(t)?xows_log(2,"cli_entity_caps_handle","Node already cached",t):(xows_log(2,"cli_entity_caps_handle","Caching entity caps",t),xows_cli_cache_caps_add(t,o))}function xows_cli_xmp_recv_chatstate(_,e,o,s,t,c){if("chat"!==e&&"groupchat"!==e)return void xows_log(1,"cli_xmp_recv_chatstate","Invalid message type",e);let n;if("chat"===e){if(xows_cli_is_own(o))return void xows_log(2,"cli_xmp_recv_chatstate","Carbons chat state ignored",o);n=xows_cli_get_cont(o)}else if((n=xows_cli_get_room(o)).join===o)return void xows_log(2,"cli_xmp_recv_chatstate","Echo chat state ignored",o);n?(n.type===XOWS_PEER_CONT&&(n.lock=o,n.chat=t),xows_log(2,"cli_xmp_recv_chatstate","Chat state",o+" "+t),xows_cli_fw_onchatstate(n,o,t)):xows_log(1,"cli_recv_message","Unknown/unsubscribed JID",o)}function xows_cli_xmp_recv_message(_,e,o,s,t,c){if("chat"!==e&&"groupchat"!==e)return void xows_log(1,"cli_recv_message","Invalid message type",e);let n,i;"chat"===e?i=xows_cli_get_cont((n=xows_cli_is_own(o))?s:o):n=o===(i=xows_cli_get_room(o)).join,i?(c||(c=(new Date).getTime()),i.type===XOWS_PEER_CONT&&(n||(i.lock=o)),xows_log(2,"cli_recv_message","Chat message",o+' "'+t+'"'),xows_cli_fw_onmessage(i,_,o,t,c,n,!0)):xows_log(1,"cli_recv_message","Unknown/unsubscribed JID",o)}function xows_cli_xmp_recv_subject(_,e,o){const s=xows_cli_get_room(e);s?(s.subj=o,xows_log(2,"cli_xmp_recv_subject","Room subject",e+' "'+o+'"'),xows_cli_fw_onsubject(s,o)):xows_log(1,"cli_xmp_recv_subject","Unknown/unsubscribed JID",e)}function xows_cli_xmp_recv_receipt(_,e,o,s,t){let c;xows_cli_is_own(e)?xows_log(2,"cli_recv_receipt","Receipt from other resource ignored",e):(c=xows_cli_get_peer(e))?(xows_log(2,"cli_recv_receipt","Message receipt received",e+" "+s),xows_cli_fw_onreceipt(c,s)):xows_log(1,"cli_recv_receipt","Unknown/unsubscribed JID",e)}function xows_cli_xmp_recv_pubsub(_,e,o){e===XOWS_NS_VCARD4&&o.length&&(xows_log(2,"cli_xmp_recv_pubsub","Received vCard notification",_),xows_cli_vcard_handle(_,o[0].data)),e===XOWS_NS_AVATAR_META&&o.length&&(xows_log(2,"cli_xmp_recv_pubsub","Received Avatar notification",_),xows_cli_avat_meta_handle(_,o[0].data)),e===XOWS_NS_NICK&&o.length&&(xows_log(2,"cli_xmp_recv_pubsub","Received Nickname notification",_),xows_cli_nick_handle(_,o[0].data))}let xows_cli_mam_cb=null;function xows_cli_mam_handle(_,e,o,s,t){const c=xows_cli_get_peer(_||e);c?(xows_log(2,"cli_mam_handle","Received archives for",c.bare),xows_is_func(xows_cli_mam_cb)&&xows_cli_mam_cb(c,o,t)):xows_log(1,"cli_mam_handle","Unknown/unsubscribed JID",_||e)}function xows_cli_mam_query(_,e,o,s,t){_.type===XOWS_PEER_CONT?xows_xmp_mam_query(null,e,_.bare,o,s,null,xows_cli_mam_handle):xows_xmp_mam_query(_.bare,e,null,o,s,null,xows_cli_mam_handle),xows_cli_mam_cb=t}function xows_cli_send_message(_,e){if(!e.length)return void xows_log(1,"cli_user_send_message","Message with empty body","Who you gonna call ?");let o,s,t,c=!1;if(_.type===XOWS_PEER_ROOM)o="groupchat",s=_.bare,t=_.join,c=!0;else{if(_.lock!==_.bare){const e=_.ress[xows_jid_to_nick(_.lock)];e&&(c=xows_cli_cache_caps_try(e.node,XOWS_NS_RECEIPTS))}o="chat",s=_.lock,t=xows_cli_own.bare}xows_log(2,"cli_user_send_message","Send "+o+" message",s+' "'+e+'"');const n=xows_xmp_send_message(o,s,e,c);xows_cli_fw_onmessage(_,n,t,e,(new Date).getTime(),!0,!c)}function xows_cli_send_chatstate(_,e){let o,s;_.type===XOWS_PEER_ROOM?(o="groupchat",s=_.bare):(o="chat",s=_.lock),xows_log(2,"cli_send_chatstate","Send Chatstat",s+' "'+e+'"'),xows_xmp_send_chatstate(s,o,e)}function xows_cli_send_subject(_,e){xows_log(2,"cli_muc_subject_send","Send subject",_.bare+' "'+e+'"'),xows_xmp_send_subject(_.bare,e)}const xows_cli_muc_item_info_stack=[];function xows_cli_muc_items_query(){if(!xows_cli_service_exist(XOWS_NS_MUC))return xows_log(1,"cli_muc_items_query","service not found","the server does not provide "+XOWS_NS_MUC+" service"),void xows_cli_fw_onerror(XOWS_SIG_WRN,"Multi-User Chat (XEP-0045) service is unavailable");xows_xmp_discoitems_query(xows_cli_service_url[XOWS_NS_MUC],xows_cli_muc_items_handle)}function xows_cli_muc_items_handle(_,e){if(xows_cli_room.length=0,e.length){xows_cli_muc_item_info_stack.length=0;let _=e.length;for(;_--;)xows_cli_muc_item_info_stack.push(e[_].jid);xows_xmp_discoinfo_query(xows_cli_muc_item_info_stack.pop(),null,xows_cli_muc_item_info_handle)}else xows_cli_fw_onroompush(null)}function xows_cli_muc_item_info_handle(_,e,o,s){let t,c,n,i="",r="",l=!1;for(n=e.length?e[0].name:_.split("@")[0],t=0,c=o.length;t<c;++t)"muc_passwordprotected"===o[t]&&(l=!0);if(s)for(t=0,c=s.length;t<c;++t)"muc#roominfo_description"==s[t].var&&(r=s[t].value),"muc#roominfo_subject"==s[t].var&&(i=s[t].value);let a=xows_cli_get_room(_);a?(a.name=n,a.desc=r,a.priv=l,xows_log(2,"cli_handle_roominfo","Refresh Room",n+" ("+_+') :"'+r+'"')):(a=xows_cli_new_room(_,n,r,l),xows_log(2,"cli_handle_roominfo","Adding Room",n+" ("+_+') :"'+r+'"')),xows_cli_fw_onroompush(a),xows_cli_muc_item_info_stack.length&&xows_xmp_discoinfo_query(xows_cli_muc_item_info_stack.pop(),null,xows_cli_muc_item_info_handle)}let xows_cli_muc_cfg_get_cb=null;function xows_cli_muc_cfg_get_handle(_,e){const o=xows_cli_get_room(_);o?(xows_log(2,"cli_muc_cfg_get_handle","Received room form",o.bare),xows_is_func(xows_cli_muc_cfg_get_cb)&&xows_cli_muc_cfg_get_cb(o,e)):xows_log(1,"cli_muc_cfg_get_handle","Unknown/unsubscribed Room",_)}function xows_cli_room_cfg_get(_,e){xows_log(2,"cli_user_room_cfg_get","Query for room config",_.bare),xows_xmp_muc_cfg_get_guery(_.bare,xows_cli_muc_cfg_get_handle),xows_cli_muc_cfg_get_cb=e}function xows_cli_room_cfg_set(_,e){xows_log(2,"cli_user_room_cfg_set","Submit MUC room config",_.bare),e?xows_xmp_muc_cfg_set_query(_.bare,e,xows_cli_muc_cfg_set_handle):xows_xmp_muc_cfg_set_cancel(_.bare,null)}function xows_cli_muc_cfg_set_handle(_,e){if("result"===e){const e=xows_cli_get_room(_);if(!e)return void xows_log(1,"cli_handle_room_submit","Unknown/unsubscribed Room",_);xows_xmp_discoinfo_query(e.bare,null,xows_cli_muc_item_info_handle)}}function xows_cli_change_roster(_,e){xows_log(2,"cli_change_roster",(e?"Add":"Remove")+" contact",_),xows_xmp_roster_set_query(_,e,null,null),e&&(xows_log(2,"cli_change_roster","Request subscribe to",_),xows_xmp_send_presence(_,"subscribe",null,null,null,null,xows_cli_own.name))}let xows_cli_upld_param=null,xows_cli_upld_fw_error=function(){},xows_cli_upld_fw_success=function(){},xows_cli_upld_fw_progress=function(){},xows_cli_upld_fw_abort=function(){};function xows_cli_upld_query(_,e,o,s,t){if(!xows_cli_upld_param){if(!xows_cli_service_exist(XOWS_NS_HTTPUPLOAD))return xows_log(1,"cli_user_upload_query","service not found","the server does not provide "+XOWS_NS_HTTPUPLOAD+"(:0) service"),void xows_cli_fw_onerror(XOWS_SIG_ERR,"HTTP File Upload (XEP-0363) service is unavailable");xows_log(2,"cli_user_upload_query","Upload query for",_.name),xows_cli_upld_param={file:_,url:""},xows_cli_upld_fw_error=e,xows_cli_upld_fw_success=o,xows_cli_upld_fw_progress=s,xows_cli_upld_fw_abort=t,xows_xmp_upload_query(xows_cli_service_url[XOWS_NS_HTTPUPLOAD],_.name,_.size,_.type,xows_cli_upld_handle)}}function xows_cli_upld_abort(){xows_log(2,"cli_user_upload_abort","Upload abort requested"),xows_cli_upld_xhr&&xows_cli_upld_xhr.abort()}let xows_cli_upld_xhr=null;function xows_cli_upld_xhr_progress(_){xows_is_func(xows_cli_upld_fw_progress)&&xows_cli_upld_fw_progress(_.loaded/_.total*100)}function xows_cli_upld_xhr_success(){xows_is_func(xows_cli_upld_fw_success)&&xows_cli_upld_fw_success(xows_cli_upld_param.url),xows_cli_upld_param=null,xows_cli_upld_xhr=null}function xows_cli_upld_xhr_error(_){xows_log(1,"cli_upload_xhr_error","http PUT request failed"),xows_is_func(xows_cli_upld_fw_error)&&xows_cli_upld_fw_error("("+xows_cli_upld_xhr.status+") "+xows_cli_upld_xhr.statusText),xows_cli_upld_param=null,xows_cli_upld_xhr=null}function xows_cli_upld_xhr_abort(_){xows_log(1,"cli_upload_xhr_abort","http PUT request aborted by user"),xows_cli_upld_param=null,xows_cli_upld_xhr=null,xows_is_func(xows_cli_upld_fw_abort)&&xows_cli_upld_fw_abort()}function xows_cli_upld_handle(_,e,o,s){if(!_)return xows_cli_upld_param=null,void(xows_is_func(xows_cli_upld_fw_error)&&xows_cli_upld_fw_error(s));xows_cli_upld_param.url=o;const t=xows_cli_upld_param.file;(new FormData).append(t.name,t);const c=new XMLHttpRequest;c.upload.addEventListener("progress",xows_cli_upld_xhr_progress,!1),c.upload.addEventListener("load",xows_cli_upld_xhr_success,!1),c.upload.addEventListener("error",xows_cli_upld_xhr_error,!1),c.upload.addEventListener("abort",xows_cli_upld_xhr_abort,!1),c.open("PUT",_,!0),c.setRequestHeader("Content-Type","main_menucation/octet-stream"),xows_log(2,"cli_upload_handle","Send PUT http request",_),xows_cli_upld_xhr=c,c.send(t)}function xows_cli_muc_register_query(_){xows_xmp_register_get_query(_.bare,xows_cli_muc_register_handle)}function xows_cli_muc_register_handle(_,e,o,s,t,c){if(xows_cli_get_room(_)){if(!e&&c){for(let _=0,e=c.length;_<e;++_)"muc#register_roomnick"===c[_].var&&(c[_].value=xows_cli_own.name);xows_xmp_register_set_query(_,null,null,null,c,null)}}else xows_log(1,"cli_muc_register_handle","Unknown/unsubscribed Room",_)}function xows_cli_subscribe_request(_){xows_log(2,"cli_subscribe_request","Request subscribe to",_),xows_xmp_send_presence(_,"subscribe")}function xows_cli_subscribe_allow(_,e,o){if(xows_xmp_send_presence(_,e?"subscribed":"unsubscribed"),xows_log(2,"cli_subscribe_request",(e?"Allow":"Deny")+" subscription from",_),e&&!xows_cli_get_cont(_)){let e;if(o)e=o;else{const o=_.split("@")[0];e=o[0].toUpperCase()+o.slice(1)}xows_cli_change_roster(_,e)}xows_cli_fw_onsubsrem(_)}function xows_cli_room_join(_,e,o,s){if(!xows_cli_service_exist(XOWS_NS_MUC))return xows_log(1,"cli_muc_items_query","service not found","the server does not provide "+XOWS_NS_MUC+" service"),void xows_cli_fw_onerror(XOWS_SIG_WRN,"Multi-User Chat (XEP-0045) service is unavailable");if(_){if(_.join)return}else{const o=xows_cli_service_url[XOWS_NS_MUC];let s=e.toLowerCase()+"@"+o;_=xows_cli_new_room(s,e,"",!1),xows_log(2,"cli_muc_room_join","Adding Room",e+" ("+s+")"),xows_cli_fw_onroompush(_)}const t=_.bare+"/"+(o||xows_cli_own.name);xows_log(2,"cli_muc_room_join","Joining room",t),xows_xmp_send_presence(t,null,xows_cli_own.show,xows_cli_own.stat,xows_cli_own.avat,!0),_.join=t}function xows_cli_change_profile(_,e,o){_&&(xows_cli_own.name=_,xows_log(2,"cli_change_profile","Change user name",_)),e?(xows_log(2,"cli_change_profile","Change avatar data"),xows_cli_own.avat=xows_cli_cache_avat_add(e)):(xows_log(2,"cli_change_profile","Removing avatar data"),xows_cli_own.avat=xows_cli_cache_avat_temp(xows_cli_own.bare)),xows_cli_vcard_publish(o),xows_cli_nick_publish(),xows_cli_avat_data_publish(o),xows_cli_presence_update(),xows_cli_fw_onownchange(xows_cli_own)}let xows_cli_chosen_show=0;function xows_cli_presence_init(){xows_cli_own.stat=null,xows_cli_own.show=xows_cli_chosen_show=3,xows_log(2,"cli_presence_init","Send intial presence"),xows_xmp_send_presence(null,null,3),xows_cli_initialize=!1,xows_options.vcard4_notify||xows_cli_vcard_query(xows_cli_own.bare),xows_options.avatar_notify||xows_cli_avat_meta_query(xows_cli_own.bare),xows_cli_nick_query(xows_cli_own.bare),xows_cli_fw_onconnect(xows_cli_own)}function xows_cli_presence_update(){let _,e,o,s;xows_cli_own.show>=0?(e=xows_cli_own.show,o=xows_cli_own.stat,s=xows_cli_own.avat):_="unavailable",xows_log(2,"cli_presence_update","Send updated presence"),xows_xmp_send_presence(null,_,e,o,s);let t=xows_cli_room.length;for(;t--;)xows_cli_room[t].join&&(xows_xmp_send_presence(xows_cli_room[t].join,_,e,o,s),_&&(xows_cli_room[t].join=null))}function xows_cli_change_presence(_){xows_cli_own.show=xows_cli_chosen_show=_,xows_cli_presence_update(),xows_cli_fw_onownchange(xows_cli_own)}function xows_cli_change_status(_){xows_cli_own.stat!==_&&(xows_cli_own.stat=_,xows_cli_cache_peer_add(xows_cli_own.bare,null,_,null),xows_cli_own.show===xows_cli_chosen_show&&xows_cli_presence_update(),xows_cli_fw_onownchange(xows_cli_own))}let xows_cli_activity_timeout=null;function xows_cli_activity_sleep(){xows_cli_activity_timeout&&clearTimeout(xows_cli_activity_timeout),xows_cli_own.show>1&&(xows_cli_activity_timeout=setTimeout(xows_cli_activity_sleep,6e5),xows_cli_own.show--,xows_cli_presence_update(),xows_cli_fw_onownchange(xows_cli_own))}function xows_cli_activity_wakeup(){xows_cli_activity_timeout&&clearTimeout(xows_cli_activity_timeout),xows_cli_activity_timeout=setTimeout(xows_cli_activity_sleep,6e5),xows_cli_own.show<xows_cli_chosen_show&&(xows_cli_own.show=xows_cli_chosen_show,xows_cli_presence_update(),xows_cli_fw_onownchange(xows_cli_own))}let xows_cli_chatstate_timeout=null;function xows_cli_chatstate_set(_,e){e>XOWS_CHAT_PAUS?(xows_cli_chatstate_timeout?clearTimeout(xows_cli_chatstate_timeout):xows_cli_send_chatstate(_,e),xows_cli_chatstate_timeout=setTimeout(xows_cli_chatstate_set,4e3,_,XOWS_CHAT_PAUS)):(clearTimeout(xows_cli_chatstate_timeout),xows_cli_send_chatstate(_,e),xows_cli_chatstate_timeout=null)}function xows_cli_disconnect(){xows_log(2,"cli_disconnect","Cleaning Client session"),xows_cli_own.show=XOWS_SHOW_OFF,xows_cli_presence_update(),xows_xmp_send_close(3)}const XOWS_CLS_FLATTEN="flatten",XOWS_CLS_HIDDEN="hidden",XOWS_CLS_ROST_CONT="rost-cont",XOWS_CLS_ROST_SUBS="rost-subs",XOWS_CLS_ROST_ROOM="rost-room",XOWS_CLS_ROST_LOAD="rost-load",XOWS_CLS_CONT_NAME="cont-name",XOWS_CLS_CONT_STAT="cont-stat",XOWS_CLS_CONT_SHOW="cont-show",XOWS_CLS_CONT_UNRD="cont-unrd",XOWS_CLS_CONT_DENY="cont-deny",XOWS_CLS_CONT_SUBS="cont-subs",XOWS_CLS_SUBS_BARE="subs-bare",XOWS_CLS_SUBS_ALLO="subs-allo",XOWS_CLS_SUBS_DENY="subs-deny",XOWS_CLS_ROOM_NAME="room-name",XOWS_CLS_ROOM_DESC="room-desc",XOWS_CLS_ROOM_AVAT="room-avat",XOWS_CLS_ROOM_LOCK="room-lock",XOWS_CLS_ROOM_UNRD="room-unrd",XOWS_CLS_ROOM_OCCU="room-occu",XOWS_CLS_OCCU_SUBS="occu-subs",XOWS_CLS_MESG_FULL="mesg-full",XOWS_CLS_MESG_AGGR="mesg-aggr",XOWS_CLS_MESG_FROM="mesg-from",XOWS_CLS_MESG_DATE="mesg-date",XOWS_CLS_MESG_HOUR="mesg-hour",XOWS_CLS_MESG_SENT="mesg-sent",XOWS_CLS_MESG_RECV="mesg-recv",XOWS_CLS_MESG_RECP="mesg-recp",XOWS_CLS_EMBD_LOAD="embd-load",XOWS_ATTR_NOLOAD="noload",XOWS_LAZY_SRC_ATTR="data_src",xows_tpl_template_parser=new DOMParser;let xows_tpl_fw_onready=function(){},xows_tpl_template_parse_remain=0,xows_tpl_model=[],xows_tpl_fragment=null,xows_tpl_theme="dark";const xows_tpl_emoj_map={100:"1F4AF",1234:"1F522",grinning:"1F600",smiley:"1F603",smile:"1F604",grin:"1F601",laughing:"1F606",sweat_smile:"1F605",rolling_on_the_floor_laughing:"1F923",joy:"1F602",slightly_smiling_face:"1F642",upside_down_face:"1F643",wink:"1F609",blush:"1F60A",innocent:"1F607",smiling_face_with_3_hearts:"1F970",heart_eyes:"1F60D","star-struck":"1F929",kissing_heart:"1F618",kissing:"1F617",kissing_closed_eyes:"1F61A",kissing_smiling_eyes:"1F619",yum:"1F60B",stuck_out_tongue:"1F61B",stuck_out_tongue_winking_eye:"1F61C",zany_face:"1F92A",stuck_out_tongue_closed_eyes:"1F61D",money_mouth_face:"1F911",hugging_face:"1F917",face_with_hand_over_mouth:"1F92D",shushing_face:"1F92B",thinking_face:"1F914",zipper_mouth_face:"1F910",face_with_raised_eyebrow:"1F928",neutral_face:"1F610",expressionless:"1F611",no_mouth:"1F636",smirk:"1F60F",unamused:"1F612",face_with_rolling_eyes:"1F644",grimacing:"1F62C",lying_face:"1F925",relieved:"1F60C",pensive:"1F614",sleepy:"1F62A",drooling_face:"1F924",sleeping:"1F634",mask:"1F637",face_with_thermometer:"1F912",face_with_head_bandage:"1F915",nauseated_face:"1F922",face_vomiting:"1F92E",sneezing_face:"1F927",hot_face:"1F975",cold_face:"1F976",woozy_face:"1F974",dizzy_face:"1F635",exploding_head:"1F92F",face_with_cowboy_hat:"1F920",partying_face:"1F973",sunglasses:"1F60E",nerd_face:"1F913",face_with_monocle:"1F9D0",confused:"1F615",worried:"1F61F",slightly_frowning_face:"1F641",open_mouth:"1F62E",hushed:"1F62F",astonished:"1F632",flushed:"1F633",pleading_face:"1F97A",frowning:"1F626",anguished:"1F627",fearful:"1F628",cold_sweat:"1F630",disappointed_relieved:"1F625",cry:"1F622",sob:"1F62D",scream:"1F631",confounded:"1F616",persevere:"1F623",disappointed:"1F61E",sweat:"1F613",weary:"1F629",tired_face:"1F62B",yawning_face:"1F971",triumph:"1F624",rage:"1F621",angry:"1F620",face_with_symbols_on_mouth:"1F92C",smiling_imp:"1F608",imp:"1F47F",skull:"1F480",hankey:"1F4A9",clown_face:"1F921",japanese_ogre:"1F479",japanese_goblin:"1F47A",ghost:"1F47B",alien:"1F47D",space_invader:"1F47E",robot_face:"1F916",smiley_cat:"1F63A",smile_cat:"1F638",joy_cat:"1F639",heart_eyes_cat:"1F63B",smirk_cat:"1F63C",kissing_cat:"1F63D",scream_cat:"1F640",crying_cat_face:"1F63F",pouting_cat:"1F63E",see_no_evil:"1F648",hear_no_evil:"1F649",speak_no_evil:"1F64A",kiss:"1F48B",love_letter:"1F48C",cupid:"1F498",gift_heart:"1F49D",sparkling_heart:"1F496",heartpulse:"1F497",heartbeat:"1F493",revolving_hearts:"1F49E",two_hearts:"1F495",heart_decoration:"1F49F",broken_heart:"1F494",orange_heart:"1F9E1",yellow_heart:"1F49B",green_heart:"1F49A",blue_heart:"1F499",purple_heart:"1F49C",brown_heart:"1F90E",black_heart:"1F5A4",white_heart:"1F90D",anger:"1F4A2",boom:"1F4A5",dizzy:"1F4AB",sweat_drops:"1F4A6",dash:"1F4A8",bomb:"1F4A3",speech_balloon:"1F4AC",thought_balloon:"1F4AD",zzz:"1F4A4",wave:"1F44B",raised_back_of_hand:"1F91A",hand:"270B","spock-hand":"1F596",ok_hand:"1F44C",pinching_hand:"1F90F",crossed_fingers:"1F91E",i_love_you_hand_sign:"1F91F",the_horns:"1F918",call_me_hand:"1F919",point_left:"1F448",point_right:"1F449",point_up_2:"1F446",middle_finger:"1F595",point_down:"1F447","+1":"1F44D","-1":"1F44E",fist:"270A",facepunch:"1F44A","left-facing_fist":"1F91B","right-facing_fist":"1F91C",clap:"1F44F",raised_hands:"1F64C",open_hands:"1F450",palms_up_together:"1F932",handshake:"1F91D",pray:"1F64F",nail_care:"1F485",selfie:"1F933",muscle:"1F4AA",mechanical_arm:"1F9BE",mechanical_leg:"1F9BF",leg:"1F9B5",foot:"1F9B6",ear:"1F442",ear_with_hearing_aid:"1F9BB",nose:"1F443",brain:"1F9E0",tooth:"1F9B7",bone:"1F9B4",eyes:"1F440",tongue:"1F445",lips:"1F444",baby:"1F476",child:"1F9D2",boy:"1F466",girl:"1F467",adult:"1F9D1",person_with_blond_hair:"1F471",man:"1F468",bearded_person:"1F9D4",woman:"1F469",older_adult:"1F9D3",older_man:"1F474",older_woman:"1F475",person_frowning:"1F64D",person_with_pouting_face:"1F64E",no_good:"1F645",ok_woman:"1F646",information_desk_person:"1F481",raising_hand:"1F64B",deaf_person:"1F9CF",bow:"1F647",face_palm:"1F926",shrug:"1F937",cop:"1F46E",guardsman:"1F482",construction_worker:"1F477",prince:"1F934",princess:"1F478",man_with_turban:"1F473",man_with_gua_pi_mao:"1F472",person_with_headscarf:"1F9D5",man_in_tuxedo:"1F935",bride_with_veil:"1F470",pregnant_woman:"1F930","breast-feeding":"1F931",angel:"1F47C",santa:"1F385",mrs_claus:"1F936",superhero:"1F9B8",supervillain:"1F9B9",mage:"1F9D9",fairy:"1F9DA",vampire:"1F9DB",merperson:"1F9DC",elf:"1F9DD",genie:"1F9DE",zombie:"1F9DF",massage:"1F486",haircut:"1F487",walking:"1F6B6",standing_person:"1F9CD",kneeling_person:"1F9CE",runner:"1F3C3",dancer:"1F483",man_dancing:"1F57A",dancers:"1F46F",person_in_steamy_room:"1F9D6",person_climbing:"1F9D7",fencer:"1F93A",horse_racing:"1F3C7",snowboarder:"1F3C2",surfer:"1F3C4",rowboat:"1F6A3",swimmer:"1F3CA",bicyclist:"1F6B4",mountain_bicyclist:"1F6B5",person_doing_cartwheel:"1F938",wrestlers:"1F93C",water_polo:"1F93D",handball:"1F93E",juggling:"1F939",person_in_lotus_position:"1F9D8",bath:"1F6C0",sleeping_accommodation:"1F6CC",two_women_holding_hands:"1F46D",couple:"1F46B",two_men_holding_hands:"1F46C",couplekiss:"1F48F",couple_with_heart:"1F491",family:"1F46A",bust_in_silhouette:"1F464",busts_in_silhouette:"1F465",footprints:"1F463",monkey_face:"1F435",monkey:"1F412",gorilla:"1F98D",orangutan:"1F9A7",dog:"1F436",dog2:"1F415",guide_dog:"1F9AE",poodle:"1F429",wolf:"1F43A",fox_face:"1F98A",raccoon:"1F99D",cat:"1F431",cat2:"1F408",lion_face:"1F981",tiger:"1F42F",tiger2:"1F405",leopard:"1F406",horse:"1F434",racehorse:"1F40E",unicorn_face:"1F984",zebra_face:"1F993",deer:"1F98C",cow:"1F42E",ox:"1F402",water_buffalo:"1F403",cow2:"1F404",pig:"1F437",pig2:"1F416",boar:"1F417",pig_nose:"1F43D",ram:"1F40F",sheep:"1F411",goat:"1F410",dromedary_camel:"1F42A",camel:"1F42B",llama:"1F999",giraffe_face:"1F992",elephant:"1F418",rhinoceros:"1F98F",hippopotamus:"1F99B",mouse:"1F42D",mouse2:"1F401",rat:"1F400",hamster:"1F439",rabbit:"1F430",rabbit2:"1F407",hedgehog:"1F994",bat:"1F987",bear:"1F43B",koala:"1F428",panda_face:"1F43C",sloth:"1F9A5",otter:"1F9A6",skunk:"1F9A8",kangaroo:"1F998",badger:"1F9A1",feet:"1F43E",turkey:"1F983",chicken:"1F414",rooster:"1F413",hatching_chick:"1F423",baby_chick:"1F424",hatched_chick:"1F425",bird:"1F426",penguin:"1F427",eagle:"1F985",duck:"1F986",swan:"1F9A2",owl:"1F989",flamingo:"1F9A9",peacock:"1F99A",parrot:"1F99C",frog:"1F438",crocodile:"1F40A",turtle:"1F422",lizard:"1F98E",snake:"1F40D",dragon_face:"1F432",dragon:"1F409",sauropod:"1F995","t-rex":"1F996",whale:"1F433",whale2:"1F40B",dolphin:"1F42C",fish:"1F41F",tropical_fish:"1F420",blowfish:"1F421",shark:"1F988",octopus:"1F419",shell:"1F41A",snail:"1F40C",butterfly:"1F98B",bug:"1F41B",ant:"1F41C",bee:"1F41D",beetle:"1F41E",cricket:"1F997",scorpion:"1F982",mosquito:"1F99F",microbe:"1F9A0",bouquet:"1F490",cherry_blossom:"1F338",white_flower:"1F4AE",rose:"1F339",wilted_flower:"1F940",hibiscus:"1F33A",sunflower:"1F33B",blossom:"1F33C",tulip:"1F337",seedling:"1F331",evergreen_tree:"1F332",deciduous_tree:"1F333",palm_tree:"1F334",cactus:"1F335",ear_of_rice:"1F33E",herb:"1F33F",four_leaf_clover:"1F340",maple_leaf:"1F341",fallen_leaf:"1F342",leaves:"1F343",grapes:"1F347",melon:"1F348",watermelon:"1F349",tangerine:"1F34A",lemon:"1F34B",banana:"1F34C",pineapple:"1F34D",mango:"1F96D",apple:"1F34E",green_apple:"1F34F",pear:"1F350",peach:"1F351",cherries:"1F352",strawberry:"1F353",kiwifruit:"1F95D",tomato:"1F345",coconut:"1F965",avocado:"1F951",eggplant:"1F346",potato:"1F954",carrot:"1F955",corn:"1F33D",cucumber:"1F952",leafy_green:"1F96C",broccoli:"1F966",garlic:"1F9C4",onion:"1F9C5",mushroom:"1F344",peanuts:"1F95C",chestnut:"1F330",bread:"1F35E",croissant:"1F950",baguette_bread:"1F956",pretzel:"1F968",bagel:"1F96F",pancakes:"1F95E",waffle:"1F9C7",cheese_wedge:"1F9C0",meat_on_bone:"1F356",poultry_leg:"1F357",cut_of_meat:"1F969",bacon:"1F953",hamburger:"1F354",fries:"1F35F",pizza:"1F355",hotdog:"1F32D",sandwich:"1F96A",taco:"1F32E",burrito:"1F32F",stuffed_flatbread:"1F959",falafel:"1F9C6",egg:"1F95A",fried_egg:"1F373",shallow_pan_of_food:"1F958",stew:"1F372",bowl_with_spoon:"1F963",green_salad:"1F957",popcorn:"1F37F",butter:"1F9C8",salt:"1F9C2",canned_food:"1F96B",bento:"1F371",rice_cracker:"1F358",rice_ball:"1F359",rice:"1F35A",curry:"1F35B",ramen:"1F35C",spaghetti:"1F35D",sweet_potato:"1F360",oden:"1F362",sushi:"1F363",fried_shrimp:"1F364",fish_cake:"1F365",moon_cake:"1F96E",dango:"1F361",dumpling:"1F95F",fortune_cookie:"1F960",takeout_box:"1F961",crab:"1F980",lobster:"1F99E",shrimp:"1F990",squid:"1F991",oyster:"1F9AA",icecream:"1F366",shaved_ice:"1F367",ice_cream:"1F368",doughnut:"1F369",cookie:"1F36A",birthday:"1F382",cake:"1F370",cupcake:"1F9C1",pie:"1F967",chocolate_bar:"1F36B",candy:"1F36C",lollipop:"1F36D",custard:"1F36E",honey_pot:"1F36F",baby_bottle:"1F37C",glass_of_milk:"1F95B",coffee:"2615",tea:"1F375",sake:"1F376",champagne:"1F37E",wine_glass:"1F377",cocktail:"1F378",tropical_drink:"1F379",beer:"1F37A",beers:"1F37B",clinking_glasses:"1F942",tumbler_glass:"1F943",cup_with_straw:"1F964",beverage_box:"1F9C3",mate_drink:"1F9C9",ice_cube:"1F9CA",chopsticks:"1F962",fork_and_knife:"1F374",spoon:"1F944",hocho:"1F52A",amphora:"1F3FA",eyeglasses:"1F453",goggles:"1F97D",lab_coat:"1F97C",safety_vest:"1F9BA",necktie:"1F454",shirt:"1F455",jeans:"1F456",scarf:"1F9E3",gloves:"1F9E4",coat:"1F9E5",socks:"1F9E6",dress:"1F457",kimono:"1F458",sari:"1F97B","one-piece_swimsuit":"1FA71",briefs:"1FA72",shorts:"1FA73",bikini:"1F459",womans_clothes:"1F45A",purse:"1F45B",handbag:"1F45C",pouch:"1F45D",school_satchel:"1F392",mans_shoe:"1F45E",athletic_shoe:"1F45F",hiking_boot:"1F97E",womans_flat_shoe:"1F97F",high_heel:"1F460",sandal:"1F461",ballet_shoes:"1FA70",boot:"1F462",crown:"1F451",womans_hat:"1F452",tophat:"1F3A9",mortar_board:"1F393",billed_cap:"1F9E2",prayer_beads:"1F4FF",lipstick:"1F484",ring:"1F48D",gem:"1F48E",mute:"1F507",speaker:"1F508",sound:"1F509",loud_sound:"1F50A",loudspeaker:"1F4E2",mega:"1F4E3",postal_horn:"1F4EF",bell:"1F514",no_bell:"1F515",musical_score:"1F3BC",musical_note:"1F3B5",notes:"1F3B6",microphone:"1F3A4",headphones:"1F3A7",radio:"1F4FB",saxophone:"1F3B7",guitar:"1F3B8",musical_keyboard:"1F3B9",trumpet:"1F3BA",violin:"1F3BB",banjo:"1FA95",drum_with_drumsticks:"1F941",iphone:"1F4F1",calling:"1F4F2",telephone_receiver:"1F4DE",pager:"1F4DF",fax:"1F4E0",battery:"1F50B",electric_plug:"1F50C",computer:"1F4BB",minidisc:"1F4BD",floppy_disk:"1F4BE",cd:"1F4BF",dvd:"1F4C0",abacus:"1F9EE",movie_camera:"1F3A5",clapper:"1F3AC",tv:"1F4FA",camera:"1F4F7",camera_with_flash:"1F4F8",video_camera:"1F4F9",vhs:"1F4FC",mag:"1F50D",mag_right:"1F50E",bulb:"1F4A1",flashlight:"1F526",izakaya_lantern:"1F3EE",diya_lamp:"1FA94",notebook_with_decorative_cover:"1F4D4",closed_book:"1F4D5",book:"1F4D6",green_book:"1F4D7",blue_book:"1F4D8",orange_book:"1F4D9",books:"1F4DA",notebook:"1F4D3",ledger:"1F4D2",page_with_curl:"1F4C3",scroll:"1F4DC",page_facing_up:"1F4C4",newspaper:"1F4F0",bookmark_tabs:"1F4D1",bookmark:"1F516",moneybag:"1F4B0",yen:"1F4B4",dollar:"1F4B5",euro:"1F4B6",pound:"1F4B7",money_with_wings:"1F4B8",credit_card:"1F4B3",receipt:"1F9FE",chart:"1F4B9",currency_exchange:"1F4B1",heavy_dollar_sign:"1F4B2","e-mail":"1F4E7",incoming_envelope:"1F4E8",envelope_with_arrow:"1F4E9",outbox_tray:"1F4E4",inbox_tray:"1F4E5",package:"1F4E6",mailbox:"1F4EB",mailbox_closed:"1F4EA",mailbox_with_mail:"1F4EC",mailbox_with_no_mail:"1F4ED",postbox:"1F4EE",memo:"1F4DD",briefcase:"1F4BC",file_folder:"1F4C1",open_file_folder:"1F4C2",date:"1F4C5",calendar:"1F4C6",card_index:"1F4C7",chart_with_upwards_trend:"1F4C8",chart_with_downwards_trend:"1F4C9",bar_chart:"1F4CA",clipboard:"1F4CB",pushpin:"1F4CC",round_pushpin:"1F4CD",paperclip:"1F4CE",straight_ruler:"1F4CF",triangular_ruler:"1F4D0",lock:"1F512",unlock:"1F513",lock_with_ink_pen:"1F50F",closed_lock_with_key:"1F510",key:"1F511",hammer:"1F528",axe:"1FA93",gun:"1F52B",bow_and_arrow:"1F3F9",wrench:"1F527",nut_and_bolt:"1F529",probing_cane:"1F9AF",link:"1F517",toolbox:"1F9F0",magnet:"1F9F2",test_tube:"1F9EA",petri_dish:"1F9EB",dna:"1F9EC",microscope:"1F52C",telescope:"1F52D",satellite_antenna:"1F4E1",syringe:"1F489",drop_of_blood:"1FA78",pill:"1F48A",adhesive_bandage:"1FA79",stethoscope:"1FA7A",door:"1F6AA",chair:"1FA91",toilet:"1F6BD",shower:"1F6BF",bathtub:"1F6C1",razor:"1FA92",lotion_bottle:"1F9F4",safety_pin:"1F9F7",broom:"1F9F9",basket:"1F9FA",roll_of_paper:"1F9FB",soap:"1F9FC",sponge:"1F9FD",fire_extinguisher:"1F9EF",shopping_trolley:"1F6D2",smoking:"1F6AC",moyai:"1F5FF",earth_africa:"1F30D",earth_americas:"1F30E",earth_asia:"1F30F",globe_with_meridians:"1F310",japan:"1F5FE",compass:"1F9ED",volcano:"1F30B",mount_fuji:"1F5FB",bricks:"1F9F1",house:"1F3E0",house_with_garden:"1F3E1",office:"1F3E2",post_office:"1F3E3",european_post_office:"1F3E4",hospital:"1F3E5",bank:"1F3E6",hotel:"1F3E8",love_hotel:"1F3E9",convenience_store:"1F3EA",school:"1F3EB",department_store:"1F3EC",factory:"1F3ED",japanese_castle:"1F3EF",european_castle:"1F3F0",wedding:"1F492",tokyo_tower:"1F5FC",statue_of_liberty:"1F5FD",church:"26EA",mosque:"1F54C",hindu_temple:"1F6D5",synagogue:"1F54D",kaaba:"1F54B",fountain:"26F2",tent:"26FA",foggy:"1F301",night_with_stars:"1F303",sunrise_over_mountains:"1F304",sunrise:"1F305",city_sunset:"1F306",city_sunrise:"1F307",bridge_at_night:"1F309",carousel_horse:"1F3A0",ferris_wheel:"1F3A1",roller_coaster:"1F3A2",barber:"1F488",circus_tent:"1F3AA",steam_locomotive:"1F682",railway_car:"1F683",bullettrain_side:"1F684",bullettrain_front:"1F685",train2:"1F686",metro:"1F687",light_rail:"1F688",station:"1F689",tram:"1F68A",monorail:"1F69D",mountain_railway:"1F69E",train:"1F68B",bus:"1F68C",oncoming_bus:"1F68D",trolleybus:"1F68E",minibus:"1F690",ambulance:"1F691",fire_engine:"1F692",police_car:"1F693",oncoming_police_car:"1F694",taxi:"1F695",oncoming_taxi:"1F696",car:"1F697",oncoming_automobile:"1F698",blue_car:"1F699",truck:"1F69A",articulated_lorry:"1F69B",tractor:"1F69C",motor_scooter:"1F6F5",manual_wheelchair:"1F9BD",motorized_wheelchair:"1F9BC",auto_rickshaw:"1F6FA",bike:"1F6B2",scooter:"1F6F4",skateboard:"1F6F9",busstop:"1F68F",fuelpump:"26FD",rotating_light:"1F6A8",traffic_light:"1F6A5",vertical_traffic_light:"1F6A6",octagonal_sign:"1F6D1",construction:"1F6A7",anchor:"2693",boat:"26F5",canoe:"1F6F6",speedboat:"1F6A4",ship:"1F6A2",airplane_departure:"1F6EB",airplane_arriving:"1F6EC",parachute:"1FA82",seat:"1F4BA",helicopter:"1F681",suspension_railway:"1F69F",mountain_cableway:"1F6A0",aerial_tramway:"1F6A1",rocket:"1F680",flying_saucer:"1F6F8",luggage:"1F9F3",hourglass:"231B",hourglass_flowing_sand:"23F3",watch:"231A",alarm_clock:"23F0",clock12:"1F55B",clock1230:"1F567",clock1:"1F550",clock130:"1F55C",clock2:"1F551",clock230:"1F55D",clock3:"1F552",clock330:"1F55E",clock4:"1F553",clock430:"1F55F",clock5:"1F554",clock530:"1F560",clock6:"1F555",clock630:"1F561",clock7:"1F556",clock730:"1F562",clock8:"1F557",clock830:"1F563",clock9:"1F558",clock930:"1F564",clock10:"1F559",clock1030:"1F565",clock11:"1F55A",clock1130:"1F566",new_moon:"1F311",waxing_crescent_moon:"1F312",first_quarter_moon:"1F313",moon:"1F314",full_moon:"1F315",waning_gibbous_moon:"1F316",last_quarter_moon:"1F317",waning_crescent_moon:"1F318",crescent_moon:"1F319",new_moon_with_face:"1F31A",first_quarter_moon_with_face:"1F31B",last_quarter_moon_with_face:"1F31C",full_moon_with_face:"1F31D",sun_with_face:"1F31E",ringed_planet:"1FA90",star:"2B50",star2:"1F31F",stars:"1F320",milky_way:"1F30C",partly_sunny:"26C5",cyclone:"1F300",rainbow:"1F308",closed_umbrella:"1F302",umbrella_with_rain_drops:"2614",zap:"26A1",snowman_without_snow:"26C4",fire:"1F525",droplet:"1F4A7",ocean:"1F30A",jack_o_lantern:"1F383",christmas_tree:"1F384",fireworks:"1F386",sparkler:"1F387",firecracker:"1F9E8",sparkles:"2728",balloon:"1F388",tada:"1F389",confetti_ball:"1F38A",tanabata_tree:"1F38B",bamboo:"1F38D",dolls:"1F38E",flags:"1F38F",wind_chime:"1F390",rice_scene:"1F391",red_envelope:"1F9E7",ribbon:"1F380",gift:"1F381",ticket:"1F3AB",trophy:"1F3C6",sports_medal:"1F3C5",first_place_medal:"1F947",second_place_medal:"1F948",third_place_medal:"1F949",soccer:"26BD",baseball:"26BE",softball:"1F94E",basketball:"1F3C0",volleyball:"1F3D0",football:"1F3C8",rugby_football:"1F3C9",tennis:"1F3BE",flying_disc:"1F94F",bowling:"1F3B3",cricket_bat_and_ball:"1F3CF",field_hockey_stick_and_ball:"1F3D1",ice_hockey_stick_and_puck:"1F3D2",lacrosse:"1F94D",table_tennis_paddle_and_ball:"1F3D3",badminton_racquet_and_shuttlecock:"1F3F8",boxing_glove:"1F94A",martial_arts_uniform:"1F94B",goal_net:"1F945",golf:"26F3",fishing_pole_and_fish:"1F3A3",diving_mask:"1F93F",running_shirt_with_sash:"1F3BD",ski:"1F3BF",sled:"1F6F7",curling_stone:"1F94C",dart:"1F3AF","yo-yo":"1FA80",kite:"1FA81","8ball":"1F3B1",crystal_ball:"1F52E",nazar_amulet:"1F9FF",video_game:"1F3AE",slot_machine:"1F3B0",game_die:"1F3B2",jigsaw:"1F9E9",teddy_bear:"1F9F8",black_joker:"1F0CF",mahjong:"1F004",flower_playing_cards:"1F3B4",performing_arts:"1F3AD",art:"1F3A8",thread:"1F9F5",yarn:"1F9F6",atm:"1F3E7",put_litter_in_its_place:"1F6AE",potable_water:"1F6B0",wheelchair:"267F",mens:"1F6B9",womens:"1F6BA",restroom:"1F6BB",baby_symbol:"1F6BC",wc:"1F6BE",passport_control:"1F6C2",customs:"1F6C3",baggage_claim:"1F6C4",left_luggage:"1F6C5",children_crossing:"1F6B8",no_entry:"26D4",no_entry_sign:"1F6AB",no_bicycles:"1F6B3",no_smoking:"1F6AD",do_not_litter:"1F6AF","non-potable_water":"1F6B1",no_pedestrians:"1F6B7",no_mobile_phones:"1F4F5",underage:"1F51E",arrows_clockwise:"1F503",arrows_counterclockwise:"1F504",back:"1F519",end:"1F51A",on:"1F51B",soon:"1F51C",top:"1F51D",place_of_worship:"1F6D0",menorah_with_nine_branches:"1F54E",six_pointed_star:"1F52F",aries:"2648",taurus:"2649",gemini:"264A",cancer:"264B",leo:"264C",virgo:"264D",libra:"264E",scorpius:"264F",sagittarius:"2650",capricorn:"2651",aquarius:"2652",pisces:"2653",ophiuchus:"26CE",twisted_rightwards_arrows:"1F500",repeat:"1F501",repeat_one:"1F502",fast_forward:"23E9",rewind:"23EA",arrow_up_small:"1F53C",arrow_double_up:"23EB",arrow_down_small:"1F53D",arrow_double_down:"23EC",cinema:"1F3A6",low_brightness:"1F505",high_brightness:"1F506",signal_strength:"1F4F6",vibration_mode:"1F4F3",mobile_phone_off:"1F4F4",trident:"1F531",name_badge:"1F4DB",beginner:"1F530",o:"2B55",white_check_mark:"2705",x:"274C",negative_squared_cross_mark:"274E",heavy_plus_sign:"2795",heavy_minus_sign:"2796",heavy_division_sign:"2797",curly_loop:"27B0",loop:"27BF",question:"2753",grey_question:"2754",grey_exclamation:"2755",exclamation:"2757",keycap_ten:"1F51F",capital_abcd:"1F520",abcd:"1F521",symbols:"1F523",abc:"1F524",ab:"1F18E",cl:"1F191",cool:"1F192",free:"1F193",id:"1F194",new:"1F195",ng:"1F196",ok:"1F197",sos:"1F198",up:"1F199",vs:"1F19A",koko:"1F201",u6709:"1F236",u6307:"1F22F",ideograph_advantage:"1F250",u5272:"1F239",u7121:"1F21A",u7981:"1F232",accept:"1F251",u7533:"1F238",u5408:"1F234",u7a7a:"1F233",u55b6:"1F23A",u6e80:"1F235",red_circle:"1F534",large_orange_circle:"1F7E0",large_yellow_circle:"1F7E1",large_green_circle:"1F7E2",large_blue_circle:"1F535",large_purple_circle:"1F7E3",large_brown_circle:"1F7E4",black_circle:"26AB",white_circle:"26AA",large_red_square:"1F7E5",large_orange_square:"1F7E7",large_yellow_square:"1F7E8",large_green_square:"1F7E9",large_blue_square:"1F7E6",large_purple_square:"1F7EA",large_brown_square:"1F7EB",black_large_square:"2B1B",white_large_square:"2B1C",black_medium_small_square:"25FE",white_medium_small_square:"25FD",large_orange_diamond:"1F536",large_blue_diamond:"1F537",small_orange_diamond:"1F538",small_blue_diamond:"1F539",small_red_triangle:"1F53A",small_red_triangle_down:"1F53B",diamond_shape_with_a_dot_inside:"1F4A0",radio_button:"1F518",white_square_button:"1F533",black_square_button:"1F532"},xows_tpl_emot_map={":":{")":"1F642","(":"1F641",O:"1F62E",P:"1F61B",D:"1F604","*":"1F617","|":"1F610","#":"1F910",S:"1F616",$:"1F633","/":"1F615",".":"1F636",X:"1F922"},8:{")":"1F60E"},":&APOS;":{")":"1F602","(":"1F622",D:"1F923"},";":{")":"1F609",P:"1F61C"},X:{")":"1F606",D:"1F606",P:"1F61D"}};function xows_tpl_template_load(_,e){let o=xows_options.root+"/themes/"+xows_tpl_theme+"/"+_+".html";xows_options.uncache&&(o+="?"+xows_gen_nonce_asc(4));const s=new XMLHttpRequest;s.open("GET",o,!0),s._isinst=e,s.onreadystatechange=function(){4===this.readyState&&(200===this.status?xows_tpl_template_parse(this.responseText,this.responseURL,this._isinst):xows_log(0,"tpl_template_load",'file "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"'))},xows_tpl_template_parse_remain++,xows_log(2,"tpl_template_load","loading file",o),s.send()}function xows_tpl_template_done(){for(;xows_tpl_fragment.childNodes.length>0;)document.body.appendChild(xows_tpl_fragment.firstChild);xows_log(2,"tpl_template_done","Template parsing completed","Fragment transfered into document"),xows_tpl_fragment=null,xows_tpl_fw_onready()}function xows_tpl_template_parse(_,e,o){xows_log(2,"tpl_template_parse","parsing template",e),_=xows_l10n_parse(_);const s=xows_clean_dom(xows_tpl_template_parser.parseFromString(_,"text/html").body);if(!s)return void xows_log(0,"tpl_template_parse",'template "'+e+'" parse error');let t,c;const n=[],i=[];if(!o)for(t=(c=s.querySelectorAll("[has_template]")).length;t--;)n.push(c[t].getAttribute("id")),c[t].removeAttribute("has_template");for(t=(c=s.querySelectorAll("[is_instance]")).length;t--;)i.push(c[t].className),c[t].parentNode.removeChild(c[t]);let r=e.substring(e.lastIndexOf("/")+1).split(".")[0];if(o)xows_tpl_model[r]=document.createDocumentFragment(),xows_tpl_model[r].appendChild(s.firstChild);else{let _=xows_tpl_fragment.querySelector("#"+r);for(_||(_=xows_tpl_fragment);s.childNodes.length>0;)_.appendChild(s.firstChild);for(t=n.length;t--;)xows_tpl_template_load(n[t],!1)}for(t=i.length;t--;)xows_tpl_template_load(i[t],!0);0===--xows_tpl_template_parse_remain&&xows_tpl_template_done()}function xows_tpl_init(_){_&&(xows_tpl_fw_onready=_),xows_options.root&&(xows_options.root=xows_options.root),xows_options.theme&&(xows_tpl_theme=xows_options.theme);const e=document.createElement("link");e.rel="stylesheet",e.type="text/css";e.href=xows_options.root+"/themes/"+xows_tpl_theme+"/style.css",xows_options.uncache&&(e.href+="?"+xows_gen_nonce_asc(4)),document.head.appendChild(e),xows_tpl_template_parse_remain=0,xows_tpl_fragment=document.createDocumentFragment(),xows_tpl_template_load("body")}const XOWS_HTML_ESCAP_MAP={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&apos;",'"':"&quot;","\n":"<br>"};function xows_html_escap_fnc(_){return XOWS_HTML_ESCAP_MAP[_]}function xows_html_escape(_){return _.replace(/[\&<>'"\n]/g,xows_html_escap_fnc)}function xows_tpl_embed_image(_,e){return'<a href="'+_+'" target="_blank"><img src="'+_+'" '+("GIF"===e?XOWS_ATTR_NOLOAD:"")+"/></a>"}function xows_tpl_embed_movie(_,e){return'<iframe src="'+_+'"/>'}function xows_tpl_embed_audio(_,e){return'<audio controls src="'+_+'" '+XOWS_ATTR_NOLOAD+"/>"}function xows_tpl_embed_youtube(_,e){let o=_.match(/(v=|embed\/|youtu\.be\/)(.+)/)[2];return'<iframe src="https://www.youtube.com/embed/'+(o=o.replace(/t=/,"start="))+'"/>'}function xows_tpl_embed_dailymo(_,e){return'<iframe src="https://www.dailymotion.com/embed/video/'+_.match(/(video|dai\.ly)\/([\w\d]+)/)[2]+'"/>'}function xows_tpl_embed_vimeo(_,e){return'<iframe src="https://player.vimeo.com/video/'+_.match(/\/([\d]+)/)[1]+'"/>'}function xows_tpl_embed_dwnl(_,e){const o=decodeURI(_.match(/(.+\/)*(.+\..+)/)[2]);return console.warn("xows_tpl_embed_dwnl: "+o),'<a class="download" href="'+_+'" target="_blank">'+o+"</a>"}let xows_tpl_embed_files={JPG:xows_tpl_embed_image,JPEG:xows_tpl_embed_image,GIF:xows_tpl_embed_image,PNG:xows_tpl_embed_image,WEBP:xows_tpl_embed_image,SVG:xows_tpl_embed_image,MP4:xows_tpl_embed_movie,MPEG:xows_tpl_embed_movie,AVI:xows_tpl_embed_movie,MP3:xows_tpl_embed_audio,OGG:xows_tpl_embed_audio},xows_tpl_embed_sites={"www.youtube.com":xows_tpl_embed_youtube,"youtu.be":xows_tpl_embed_youtube,"www.dailymotion.com":xows_tpl_embed_dailymo,"dai.ly":xows_tpl_embed_dailymo,"vimeo.com":xows_tpl_embed_vimeo};function xows_tpl_add_embed_site(_,e){xows_tpl_embed_sites[_]=e}function xows_tpl_add_embed_file(_,e){xows_tpl_embed_files[_]=e}function xows_tpl_add_embed_dwnl(_){xows_tpl_embed_sites[_]=xows_tpl_embed_dwnl}function xows_tpl_enhance_url(_){const e='<a href="'+_+'" title="'+_+'" target="_blank">'+_+"</a>";let o,s,t=null;return(o=_.match(/\.([\w\d]+)(\?|$)/))&&(s=o[1].toUpperCase(),xows_tpl_embed_files[s]&&(t=xows_tpl_embed_files[s](_,s))),t||(o=_.match(/\/\/(.*?[\w\d-_]+\.\w+)\//))&&(s=o[1].toLowerCase(),xows_tpl_embed_sites[s]&&(t=xows_tpl_embed_sites[s](_,s))),t?e+'<br><div class="embd">'+t.replace(/src=/g,XOWS_LAZY_SRC_ATTR+"=")+"</div>":e}function xows_tpl_replace_emoji(_,e){const o=xows_tpl_emoj_map[e];return o?"<emoj>&#x"+o+";</emoj>":_}function xows_tpl_replace_emots(_,e,o,s){const t=xows_tpl_emot_map[o.toUpperCase()][s.toUpperCase()];return t?"<emoj>&#x"+t+";</emoj>":_}function xows_tpl_enrich_content(_){return(_=(_=(_=xows_html_escape(_)).replace(/:([\w-+-_]*):/g,xows_tpl_replace_emoji)).replace(/(\s|^)([Xx8:;]|:&apos;)-?([()|DpPxXoO#$.\/*sS])/g,xows_tpl_replace_emots)).replace(/(http|https|ftp|ftps):\/\/(\S*)/g,xows_tpl_enhance_url)}let xows_tpl_avat_cls_db={};function xows_tpl_spawn_avat_cls(_){if(_&&!(_ in xows_tpl_avat_cls_db)){const e=".h-"+_+' {background-image:url("'+xows_cli_cache_avat_get(_)+'");}\r\n';xows_tpl_avat_cls_db[_]=e;const o=document.createElement("style");o.type="text/css",o.innerHTML=e,document.head.appendChild(o)}}function xows_tpl_spawn_rost_cont(_,e,o,s,t,c){const n=xows_tpl_model[XOWS_CLS_ROST_CONT].firstChild.cloneNode(!0);n.setAttribute("id",_),n.setAttribute("title",e+" ("+_+")"),n.querySelector("."+XOWS_CLS_CONT_NAME).innerHTML=e,n.querySelector("."+XOWS_CLS_CONT_STAT).innerHTML=c||"";const i=n.querySelector("."+XOWS_CLS_CONT_SHOW),r=n.querySelector("."+XOWS_CLS_CONT_SUBS),l=n.querySelector("FIGURE");return s<XOWS_SUBS_TO?(i.classList.add(XOWS_CLS_HIDDEN),r.classList.remove(XOWS_CLS_HIDDEN),l.className=XOWS_CLS_CONT_DENY):(i.setAttribute("show",null!==t?t:-1),xows_tpl_spawn_avat_cls(o),l.className="h-"+o),n}function xows_tpl_update_rost_cont(_,e,o,s,t,c){const n=_.getAttribute("id");_.setAttribute("title",e+" ("+n+")"),_.querySelector("."+XOWS_CLS_CONT_NAME).innerHTML=e,_.querySelector("."+XOWS_CLS_CONT_STAT).innerHTML=c||"";const i=_.querySelector("."+XOWS_CLS_CONT_SHOW),r=_.querySelector("."+XOWS_CLS_CONT_SUBS),l=_.querySelector("FIGURE");s<XOWS_SUBS_TO?(i.classList.add(XOWS_CLS_HIDDEN),r.classList.remove(XOWS_CLS_HIDDEN),l.className=XOWS_CLS_CONT_DENY):(i.classList.remove(XOWS_CLS_HIDDEN),i.setAttribute("show",null!==t?t:-1),r.classList.add(XOWS_CLS_HIDDEN),xows_tpl_spawn_avat_cls(o),l.className="h-"+o)}function xows_tpl_spawn_room_occu(_,e,o,s,t,c){const n=xows_tpl_model[XOWS_CLS_ROOM_OCCU].firstChild.cloneNode(!0);return n.setAttribute("id",_),n.setAttribute("jid",s),n.setAttribute("title",e+" ("+s+")"),n.querySelector("."+XOWS_CLS_CONT_NAME).innerHTML=e,n.querySelector("."+XOWS_CLS_CONT_SHOW).setAttribute("show",null!==t?t:-1),n.querySelector("."+XOWS_CLS_CONT_STAT).innerHTML=c||"",n.querySelector("."+XOWS_CLS_OCCU_SUBS).disabled=!s||0===s.length,xows_tpl_spawn_avat_cls(o),n.querySelector("FIGURE").className="h-"+o,n}function xows_tpl_update_room_occu(_,e,o,s,t,c){_.setAttribute("jid",s),_.setAttribute("title",e+" ("+s+")"),_.querySelector("."+XOWS_CLS_CONT_NAME).innerHTML=e,_.querySelector("."+XOWS_CLS_CONT_SHOW).setAttribute("show",null!==t?t:-1),_.querySelector("."+XOWS_CLS_CONT_STAT).innerHTML=c||"",_.querySelector("."+XOWS_CLS_OCCU_SUBS).disabled=!s||0===s.length,xows_tpl_spawn_avat_cls(o),_.querySelector("FIGURE").className="h-"+o}function xows_tpl_spawn_rost_room(_,e,o,s){const t=xows_tpl_model[XOWS_CLS_ROST_ROOM].firstChild.cloneNode(!0);t.setAttribute("id",_),t.setAttribute("title",e+" ("+_+")"),t.querySelector("."+XOWS_CLS_ROOM_NAME).innerHTML=e,t.querySelector("."+XOWS_CLS_ROOM_DESC).innerHTML=o;const c=t.querySelector("."+XOWS_CLS_ROOM_AVAT);return s&&c.classList.add(XOWS_CLS_ROOM_LOCK),t}function xows_tpl_update_rost_room(_,e,o,s){const t=_.getAttribute("id");_.setAttribute("title",e+" ("+t+")"),_.querySelector("."+XOWS_CLS_ROOM_NAME).innerHTML=e,_.querySelector("."+XOWS_CLS_ROOM_DESC).innerHTML=o;const c=_.querySelector("."+XOWS_CLS_ROOM_AVAT);s?c.classList.add(XOWS_CLS_ROOM_LOCK):c.classList.remove(XOWS_CLS_ROOM_LOCK)}function xows_tpl_spawn_rost_subs(_,e){const o=xows_tpl_model[XOWS_CLS_ROST_SUBS].firstChild.cloneNode(!0);return o.setAttribute("id",_),e&&o.setAttribute("name",e),o.setAttribute("title",_+" ("+e+")"),o.querySelector("."+XOWS_CLS_SUBS_BARE).innerHTML=e||_,o}function xows_tpl_mesg_full_spawn(_,e,o,s,t,c,n,i){const r=xows_tpl_model[XOWS_CLS_MESG_FULL].firstChild.cloneNode(!0);return r.classList.add(t?XOWS_CLS_MESG_SENT:XOWS_CLS_MESG_RECV),c&&r.classList.add(XOWS_CLS_MESG_RECP),r.setAttribute("id",_),r.setAttribute("from",e),r.setAttribute("time",s),r.querySelector("."+XOWS_CLS_MESG_FROM).innerHTML=n,r.querySelector("."+XOWS_CLS_MESG_DATE).innerHTML=xows_l10n_date(s),r.querySelector("P").innerHTML=xows_tpl_enrich_content(o),xows_tpl_spawn_avat_cls(i),r.querySelector("FIGURE").className="h-"+i,r}function xows_tpl_mesg_aggr_spawn(_,e,o,s,t,c){const n=xows_tpl_model[XOWS_CLS_MESG_AGGR].firstChild.cloneNode(!0);return n.classList.add(t?XOWS_CLS_MESG_SENT:XOWS_CLS_MESG_RECV),c&&n.classList.add(XOWS_CLS_MESG_RECP),n.setAttribute("id",_),n.setAttribute("from",e),n.setAttribute("time",s),n.querySelector("."+XOWS_CLS_MESG_HOUR).innerHTML=xows_l10n_houre(s),n.querySelector("P").innerHTML=xows_tpl_enrich_content(o),n}const xows_doc={},xows_doc_frag_db={};let xows_doc_loader_scroll=99999,xows_doc_loader_client=null,xows_doc_loader_attrib="";const xows_doc_loader_stack=[];function xows_doc_cache(_){xows_doc[_]=document.getElementById(_)}function xows_doc_listener_add(_,e,o,s=!0){_.addEventListener(e,o,{capture:!1,passive:s})}function xows_doc_listener_rem(_,e,o,s=!0){_.removeEventListener(e,o,{capture:!1,passive:s})}function xows_doc_cls_has(_,e){return xows_doc[_].classList.contains(e)}function xows_doc_cls_tog(_,e){xows_doc[_].classList.toggle(e)}function xows_doc_cls_add(_,e){xows_doc[_].classList.add(e)}function xows_doc_cls_rem(_,e){xows_doc[_].classList.remove(e)}function xows_doc_cls_set(_,e,o){o?xows_doc[_].classList.add(e):xows_doc[_].classList.remove(e)}function xows_doc_show(_,e){e?xows_doc[_].classList.remove(XOWS_CLS_HIDDEN):xows_doc[_].classList.add(XOWS_CLS_HIDDEN)}function xows_doc_hidden(_){return xows_doc[_].classList.contains(XOWS_CLS_HIDDEN)}function xows_doc_frag_backup(_,e){_ in xows_doc_frag_db||(xows_doc_frag_db[_]={}),xows_doc_frag_db[_][e]?xows_doc_frag_db[_][e].innerHTML="":xows_doc_frag_db[_][e]=document.createDocumentFragment();for(;xows_doc[e].childNodes.length;)xows_doc_frag_db[_][e].appendChild(xows_doc[e].firstChild)}function xows_doc_frag_copy(_,e,o){let s,t,c,n=!1;if(e?e in xows_doc_frag_db&&o in xows_doc_frag_db[e]&&(s=xows_doc_frag_db[e][o]):s=xows_doc[o],_?(_ in xows_doc_frag_db||(xows_doc_frag_db[_]={}),xows_doc_frag_db[_][o]||(xows_doc_frag_db[_][o]=document.createDocumentFragment()),t=xows_doc_frag_db[_][o]):((t=xows_doc[o]).innerHTML="",n=!0),s&&t!==s)for(let _=0,e=s.childNodes.length;_<e;++_)c=s.childNodes[_].cloneNode(!0),t.appendChild(c),n&&c.id&&(xows_doc[c.id]=c)}function xows_doc_frag_restore(_,e){if(_ in xows_doc_frag_db){let o;for(xows_doc[e].innerHTML="";xows_doc_frag_db[_][e].childNodes.length;)o=xows_doc_frag_db[_][e].firstChild,xows_doc[e].appendChild(o),o.id&&(xows_doc[o.id]=o)}}function xows_doc_frag(_,e){return xows_doc_frag_db[_]?xows_doc_frag_db[_][e]:null}function xows_doc_frag_element(_,e){let o;for(const s in xows_doc_frag_db[_])if(o=xows_doc_frag_db[_][s].getElementById(e))return o;return null}function xows_doc_get_child(_,e){let o=_.childNodes.length;for(;o--;)if(_.childNodes[o].id===e)return _.childNodes[o];return null}function xows_doc_init(_){const e=document.querySelectorAll("[id]");let o=e.length;for(;o--;)xows_doc_cache(e[o].id);xows_doc_listener_add(xows_doc.hnd_lside,"click",xows_gui_evt_click_hnd),xows_doc_listener_add(xows_doc.hnd_rside,"click",xows_gui_evt_click_hnd),xows_doc_listener_add(xows_doc.rost_tabs,"click",xows_gui_evt_click_rost_tabs),xows_doc_listener_add(xows_doc.cont_ul,"click",xows_gui_evt_click_rost_ul),xows_doc_listener_add(xows_doc.subs_ul,"click",xows_gui_evt_click_subs_ul),xows_doc_listener_add(xows_doc.cont_add,"click",xows_gui_evt_click_cont_add),xows_doc_listener_add(xows_doc.room_ul,"click",xows_gui_evt_click_rost_ul),xows_doc_listener_add(xows_doc.room_add,"click",xows_gui_evt_click_room_add),xows_doc_listener_add(xows_doc.room_upd,"click",xows_gui_room_list_reload),xows_doc_listener_add(xows_doc.occu_list,"click",xows_gui_evt_click_occu_list),xows_doc_listener_add(xows_doc.menu_show,"click",xows_gui_evt_click_show_menu),xows_doc_listener_add(xows_doc.drop_show,"click",xows_gui_evt_click_show_menu),xows_doc_listener_add(xows_doc.menu_user,"click",xows_gui_evt_click_user_menu),xows_doc_listener_add(xows_doc.user_stat,"keypress",xows_gui_evt_keyp_user_stat),xows_doc_listener_add(xows_doc.send_edit,"keydown",xows_gui_evt_keyud_send_edit,!1),xows_doc_listener_add(xows_doc.send_edit,"keyup",xows_gui_evt_keyud_send_edit),xows_doc_listener_add(xows_doc.send_edit,"input",xows_gui_evt_input_send_edit),xows_doc_listener_add(xows_doc.chat_main,"scroll",xows_gui_evt_scroll_chat_main),xows_doc_listener_add(xows_doc.chat_main,"click",xows_gui_evt_click_chat_main),xows_doc_listener_add(xows_doc.chat_file,"change",xows_gui_evt_change_chat_file),xows_doc_listener_add(xows_doc.chat_upld,"click",xows_gui_evt_click_chat_upld),xows_doc_listener_add(xows_doc.menu_emoj,"click",xows_gui_evt_click_emoj_menu),xows_doc_listener_add(xows_doc.drop_emoj,"click",xows_gui_evt_click_emoj_menu),xows_doc_listener_add(xows_doc.menu_room,"click",xows_gui_evt_click_room_menu),xows_doc_listener_add(xows_doc.drop_room,"click",xows_gui_evt_click_room_menu),xows_doc_listener_add(xows_doc.chat_noti,"click",xows_gui_evt_click_chat_noti),xows_doc_listener_add(xows_doc.chat_mute,"click",xows_gui_evt_click_chat_noti),xows_doc_listener_add(xows_doc.page_upld,"click",xows_gui_evt_click_page_upld),xows_doc_listener_add(xows_doc.page_cont,"keyup",xows_gui_evt_key_page_cont),xows_doc_listener_add(xows_doc.page_cont,"click",xows_gui_evt_click_page_cont),xows_doc_listener_add(xows_doc.page_card,"keyup",xows_gui_evt_key_page_card),xows_doc_listener_add(xows_doc.page_card,"click",xows_gui_evt_click_page_card),xows_doc_listener_add(xows_doc.page_room,"keyup",xows_gui_evt_key_page_room),xows_doc_listener_add(xows_doc.page_room,"click",xows_gui_evt_click_page_room),xows_doc_listener_add(xows_doc.page_join,"keyup",xows_gui_evt_key_page_join),xows_doc_listener_add(xows_doc.page_join,"click",xows_gui_evt_click_page_join),xows_doc_listener_add(xows_doc.page_auth,"keyup",xows_gui_evt_key_page_auth),xows_doc_listener_add(xows_doc.page_auth,"click",xows_gui_evt_click_page_auth),xows_options.allow_register&&(xows_doc_show("auth_regi",!0),xows_doc_listener_add(xows_doc.page_regi,"keyup",xows_gui_evt_key_page_regi),xows_doc_listener_add(xows_doc.page_regi,"click",xows_gui_evt_click_page_regi)),xows_doc_listener_add(xows_doc.page_info,"click",xows_gui_evt_click_page_info);let s={capture:!1,passive:!0};document.addEventListener("visibilitychange",xows_gui_evt_focus,s),window.addEventListener("focus",xows_gui_evt_focus,s),window.addEventListener("blur",xows_gui_evt_focus,s),window.addEventListener("beforeunload",xows_gui_evt_unload,s),xows_gui_notify_sound=new Audio("/"+xows_options.root+"/sounds/notify.mp3?456"),xows_doc_frag_copy("empty",null,"chat_hist"),xows_doc_frag_copy("empty",null,"occu_list"),xows_log(2,"gui_start","document ready"),xows_is_func(_)&&_()}function xows_doc_loader_clear(){xows_doc_loader_stack.length=0,xows_doc_loader_scroll=99999,xows_log(2,"doc_loader_clear","loader stack cleared")}function xows_doc_loader_setup(_,e){xows_doc_loader_attrib=e,xows_log(2,"doc_loader_setup","now search elements with attribute",e),xows_doc_loader_client!==_&&(xows_doc_loader_client&&(xows_doc_listener_rem(xows_doc_loader_client,"scroll",xows_doc_loader_check),xows_log(2,"doc_loader_setup","removing scroll listener from element","<"+xows_doc_loader_client.tagName+' id="'+xows_doc_loader_client.getAttribute("id")+'">')),(xows_doc_loader_client=_)&&(xows_doc_listener_add(xows_doc_loader_client,"scroll",xows_doc_loader_check),xows_log(2,"doc_loader_setup","adding scroll listener to element","<"+_.tagName+' id="'+_.getAttribute("id")+'">'))),xows_doc_loader_scroll=99999}function xows_doc_loader_monitor(_){const e=Array.from(_.querySelectorAll("["+xows_doc_loader_attrib+"]"));if(e.length){xows_log(2,"doc_loader_monitor","adding to monitoring stack",e.length+" new element(s)");let _=e.length;for(;_--;)xows_doc_loader_stack.push(e[_])}}function xows_doc_loader_check(_){if(!xows_doc_loader_stack.length)return;if(Math.abs(xows_doc_loader_client.scrollTop-xows_doc_loader_scroll)<120)return;xows_doc_loader_scroll=xows_doc_loader_client.scrollTop;const e=xows_doc_loader_client.getBoundingClientRect();let o,s,t=xows_doc_loader_stack.length;for(;t--;)(o=(s=xows_doc_loader_stack[t]).getBoundingClientRect()).bottom>e.top&&o.top<=e.bottom&&(s.hasAttribute(XOWS_ATTR_NOLOAD)?s.removeAttribute(XOWS_ATTR_NOLOAD):(s.classList.add(XOWS_CLS_FLATTEN),s.parentNode.classList.add(XOWS_CLS_EMBD_LOAD),s.onload=function(){this.parentNode.classList.remove(XOWS_CLS_EMBD_LOAD),this.classList.remove(XOWS_CLS_FLATTEN)}),s.src=s.getAttribute(xows_doc_loader_attrib),s.removeAttribute(xows_doc_loader_attrib),xows_doc_loader_stack.splice(t,1),xows_log(2,"doc_loader_check","loading",s.src))}const XOWS_MESG_AGGR_THRESHOLD=6e5,XOWS_GUI_HIST_SIZE=55;let xows_gui_locale="en-US",xows_gui_auth=null,xows_gui_peer=null,xows_gui_notify_sound=null,xows_gui_has_focus=!0;function xows_gui_peer_element(_,e){return _===xows_gui_peer?xows_doc[e]?xows_doc[e]:document.getElementById(e):xows_doc_frag_element(_.bare,e)}const xows_gui_peer_scroll_db={};function xows_gui_peer_scroll_backup(_){_.bare in xows_gui_peer_scroll_db||(xows_gui_peer_scroll_db[_.bare]={}),xows_gui_peer_scroll_db[_.bare]={scrollTop:xows_doc.chat_main.scrollTop,scrollHeight:xows_doc.chat_main.scrollHeight,clientHeight:xows_doc.chat_main.clientHeight}}function xows_gui_peer_scroll_restore(_){_.bare in xows_gui_peer_scroll_db&&(xows_doc.chat_main.scrollTop=xows_gui_peer_scroll_db[_.bare].scrollTop)}function xows_gui_peer_scroll_top(_){return _!==xows_gui_peer?xows_gui_peer_scroll_db[_.bare].scrollTop:xows_doc.chat_main.scrollTop}function xows_gui_peer_scroll_bot(_){const e=_!==xows_gui_peer?xows_gui_peer_scroll_db[_.bare]:xows_doc.chat_main;return e.scrollHeight-e.scrollTop-e.clientHeight}function xows_gui_peer_scroll_off(_){const e=_!==xows_gui_peer?xows_gui_peer_scroll_db[_.bare]:xows_doc.chat_main;return e.scrollHeight-e.scrollTop}function xows_gui_peer_scroll_down(_){const e=_!==xows_gui_peer?xows_gui_peer_scroll_db[_.bare]:xows_doc.chat_main;e.scrollTop=e.scrollHeight}function xows_gui_peer_scroll_seek(_,e){const o=_!==xows_gui_peer?xows_gui_peer_scroll_db[_.bare]:xows_doc.chat_main;o.scrollTop=o.scrollHeight-e}let xows_gui_error_page="page_auth";function xows_gui_connect(){const _=xows_options.domain?xows_gui_auth.user+"@"+xows_options.domain:xows_gui_auth.user;xows_cli_set_callback("connect",xows_gui_loggedin),xows_cli_set_callback("ownchange",xows_gui_user_update),xows_cli_set_callback("contpush",xows_gui_cont_push),xows_cli_set_callback("contrem",xows_gui_cont_remove),xows_cli_set_callback("subspush",xows_gui_subs_push),xows_cli_set_callback("subsrem",xows_gui_subs_remove),xows_cli_set_callback("roompush",xows_gui_room_push),xows_cli_set_callback("occupush",xows_gui_occu_push),xows_cli_set_callback("occurem",xows_gui_occu_remove),xows_cli_set_callback("message",xows_gui_hist_push),xows_cli_set_callback("chatstate",xows_gui_recv_chatstate),xows_cli_set_callback("receipt",xows_gui_recv_receipt),xows_cli_set_callback("subject",xows_gui_recv_subject),xows_cli_set_callback("error",xows_gui_cli_error),xows_cli_set_callback("close",xows_gui_cli_close),xows_gui_error_page="page_auth",xows_cli_connect(xows_options.url,_,xows_gui_auth.pass,!1)}function xows_gui_register(){const _=xows_options.domain?xows_gui_auth.user+"@"+xows_options.domain:xows_gui_auth.user;xows_cli_set_callback("register",xows_gui_cli_register),xows_cli_set_callback("close",xows_gui_cli_close),xows_cli_set_callback("error",xows_gui_cli_error),xows_gui_error_page="page_regi",xows_cli_connect(xows_options.url,_,xows_gui_auth.pass,!0)}function xows_gui_cont_list_reload(){xows_doc.cont_ul.innerHTML="",xows_doc_cls_add("cont_ul",XOWS_CLS_ROST_LOAD),xows_cli_roster_get_query()}function xows_gui_cont_push(_){if(null===_)return void xows_doc_cls_rem("cont_ul",XOWS_CLS_ROST_LOAD);const e=document.getElementById(_.bare);e?(xows_tpl_update_rost_cont(e,_.name,_.avat,_.subs,_.show,_.stat),_===xows_gui_peer&&xows_gui_chat_fram_update()):(xows_doc_cls_rem("cont_ul",XOWS_CLS_ROST_LOAD),xows_doc.cont_ul.appendChild(xows_tpl_spawn_rost_cont(_.bare,_.name,_.avat,_.subs,_.show,_.stat)),xows_doc_frag_copy(_.bare,"empty","chat_hist"),xows_gui_peer_scroll_backup(_),xows_doc_frag_copy(_.bare,"empty","occu_list"))}function xows_gui_cont_remove(_){const e=document.getElementById(_);e&&e.parentNode.removeChild(e)}function xows_gui_room_list_reload(){xows_doc.room_ul.innerHTML="",xows_doc_cls_add("room_ul",XOWS_CLS_ROST_LOAD),xows_cli_muc_items_query()}function xows_gui_room_push(_){if(null===_)return void xows_doc_cls_rem("room_ul",XOWS_CLS_ROST_LOAD);const e=document.getElementById(_.bare);e?(xows_tpl_update_rost_room(e,_.name,_.desc,_.lock),_===xows_gui_peer&&xows_gui_chat_fram_update()):(xows_doc_cls_rem("room_ul",XOWS_CLS_ROST_LOAD),xows_doc.room_ul.appendChild(xows_tpl_spawn_rost_room(_.bare,_.name,_.desc,_.lock)),xows_doc_frag_copy(_.bare,"empty","chat_hist"),xows_gui_peer_scroll_backup(_),xows_doc_frag_copy(_.bare,"empty","occu_list"))}function xows_gui_occu_push(_,e){const o=xows_gui_peer_element(_,e.jid);if(o)xows_tpl_update_room_occu(o,e.name,e.avat,e.full,e.show,e.stat),xows_gui_hist_avat_upd(_,e.jid,e.avat);else{const o=xows_gui_peer_element(_,"moderator"===e.role?"modo_ul":"memb_ul"),s=xows_tpl_spawn_room_occu(e.jid,e.name,e.avat,e.full,e.show,e.stat);e.self&&(s.querySelector("."+XOWS_CLS_OCCU_SUBS).classList.add(XOWS_CLS_HIDDEN),"owner"===e.affi&&(xows_doc.menu_room.disabled=!1)),e.full&&xows_cli_get_cont(e.full)&&s.querySelector("."+XOWS_CLS_OCCU_SUBS).classList.add(XOWS_CLS_HIDDEN),o.appendChild(s)}}function xows_gui_occu_remove(_,e){const o=xows_gui_peer_element(_,e);o&&o.parentNode.removeChild(o)}function xows_gui_loggedin(_){if(xows_gui_auth.cred&&(xows_log(2,"xows_gui_loggedin","Saving credential"),window.PasswordCredential)){const _={id:xows_gui_auth.user,password:xows_gui_auth.pass},e=new PasswordCredential(_);navigator.credentials.store(e)}xows_gui_auth=null,xows_doc_show("page_main",!0),xows_doc_show("page_wait",!1),xows_gui_peer=null,xows_doc_loader_setup(xows_doc.chat_main,XOWS_LAZY_SRC_ATTR),xows_cli_service_exist(XOWS_NS_HTTPUPLOAD)&&(xows_doc.chat_upld.disabled=!1,xows_tpl_add_embed_dwnl(xows_cli_service_url[XOWS_NS_HTTPUPLOAD])),xows_cli_service_exist(XOWS_NS_MUC)&&(xows_doc.room_tab.disabled=!1),xows_gui_user_update(_),xows_gui_room_list_reload()}const xows_gui_writing_list=[];function xows_gui_writing_notif_clear(){0!==xows_gui_writing_list.length&&(xows_gui_writing_list.length=0),xows_doc_show("chat_stat",!1),xows_doc.chat_stat.innerHTML=""}function xows_gui_writing_notif_set(_,e){const o=xows_gui_writing_list,s=o.indexOf(_);e?s<0&&o.push(_):s>=0&&o.splice(s,1);const t=o.length;if(t>0){if(xows_gui_peer)if(xows_doc_show("chat_stat",!0),xows_gui_peer.type===XOWS_PEER_CONT)xows_doc.chat_stat.innerHTML="<b>"+xows_gui_peer.name+"</b> "+xows_l10n_get("is currently writing");else{let _="";if(t>1){const e=t>2?2:t-1;for(let s=0;s<e;++s)_+="<b>"+xows_jid_to_nick(o[s])+"</b>",s<e-1&&(_+=", ");_+=" "+xows_l10n_get("and")+" <b>";const s=t-e;_+=s>1?s+" "+xows_l10n_get("other(s)")+"</b> ":xows_jid_to_nick(o[t-1])+"</b> ",xows_doc.chat_stat.innerHTML=_+xows_l10n_get("are currently writing")}else xows_doc.chat_stat.innerHTML="<b>"+xows_jid_to_nick(o[0])+"</b> "+xows_l10n_get("is currently writing")}}else xows_gui_writing_notif_clear()}function xows_gui_user_update(_){xows_doc.user_stat.placeholder=_.stat?_.stat:xows_l10n_get("No status defined"),xows_doc.user_stat.value="",xows_doc.user_stat.blur(),xows_doc.user_show.setAttribute("show",_.show),xows_doc.user_name.innerHTML=_.name,xows_doc.user_addr.innerHTML="("+_.bare+")",xows_tpl_spawn_avat_cls(_.avat),xows_doc.user_avat.className="h-"+_.avat}function xows_gui_chat_fram_update(){if(!xows_gui_peer)return xows_doc.chat_titl.innerHTML="",xows_doc.chat_addr.innerHTML="",xows_doc.head_meta.innerHTML="",xows_doc.send_wrap.setAttribute("placeholder",""),xows_doc.chat_stat.innerHTML="",void xows_doc_show("chat_show",!1);xows_doc.chat_titl.innerHTML=xows_gui_peer.name,xows_gui_peer.type===XOWS_PEER_CONT?(xows_doc_show("chat_show",!0),xows_doc_show("chat_addr",!0),xows_doc.chat_show.setAttribute("show",xows_gui_peer.show),xows_doc.chat_addr.innerHTML="("+xows_gui_peer.bare+")",xows_doc.head_meta.innerHTML=xows_gui_peer.stat?xows_gui_peer.stat:""):(xows_doc_show("chat_show",!1),xows_doc_show("chat_addr",!1),xows_doc.head_meta.innerHTML=xows_gui_peer.subj),xows_doc_show("chat_noti",xows_gui_peer.noti),xows_doc_show("chat_mute",!xows_gui_peer.noti),xows_doc.send_wrap.setAttribute("placeholder",xows_l10n_get("Send a message to")+" "+xows_gui_peer.name+" ...")}function xows_gui_rost_switch(_){let e=null;if("cont_tab"===_?xows_doc_hidden("cont_list")&&(xows_doc_show("cont_list",!0),xows_doc_show("room_list",!1),xows_doc_cls_rem("room_tab","tab-enabled"),xows_doc_cls_add("cont_tab","tab-enabled"),xows_doc_cls_add("col_rside","column-hide"),e=xows_doc.cont_ul):xows_doc_hidden("room_list")&&(xows_doc_show("room_list",!0),xows_doc_show("cont_list",!1),xows_doc_cls_rem("cont_tab","tab-enabled"),xows_doc_cls_add("room_tab","tab-enabled"),xows_doc_cls_rem("col_rside","column-hide"),e=xows_doc.room_ul),e){const _=e.querySelector(".peer-selected");xows_gui_switch_peer(_?_.id:null)}}function xows_gui_switch_peer(_){const e=xows_gui_peer;if(e){if(_===e.bare)return;xows_cli_chatstate_set(e,XOWS_CHAT_GONE)}const o=_?xows_cli_get_peer(_):null;e&&(xows_gui_peer_scroll_backup(e),xows_doc_frag_backup(e.bare,"chat_hist"),xows_doc_frag_backup(e.bare,"occu_list"),o&&o.type===e.type&&document.getElementById(e.bare).classList.remove("peer-selected")),xows_doc_show("chat_fram",null!==o),o?(document.getElementById(o.bare).classList.add("peer-selected"),xows_doc_frag_restore(o.bare,"chat_hist"),xows_doc_frag_restore(o.bare,"occu_list"),xows_gui_peer_scroll_restore(o),xows_doc_cls_set("col_rside","column-hide",o.type!==XOWS_PEER_ROOM),xows_gui_peer=o,o.type===XOWS_PEER_ROOM&&(o.join||xows_cli_room_join(o)),xows_gui_unread_reset(o),xows_doc_loader_clear(),xows_doc_loader_monitor(xows_doc.chat_main),xows_doc_loader_check(),xows_doc.hist_ul.childNodes.length<40&&xows_gui_mam_query(!1,40,0),xows_gui_peer_scroll_bot(o)<50&&xows_gui_peer_scroll_down(o),xows_log(2,"gui_switch_peer",'peer "'+o.bare+'"',"selected")):(xows_gui_peer=null,xows_doc_frag_copy(null,"empty","chat_hist"),xows_doc_frag_copy(null,"empty","occu_list"),xows_doc_cls_add("col_rside","column-hide"),xows_log(2,"gui_switch_peer","peer","unselect")),xows_gui_writing_notif_clear(),xows_gui_chat_fram_update()}function xows_gui_unread_notify(_,e){let o,s,t;_.type===XOWS_PEER_ROOM?(s="."+XOWS_CLS_ROOM_UNRD,t=xows_doc.room_unrd):(s="."+XOWS_CLS_CONT_UNRD,t=xows_doc.cont_unrd),o=t.firstChild?parseInt(t.innerHTML):0,t.innerHTML=o+1,t.classList.remove(XOWS_CLS_HIDDEN);const c=document.getElementById(_.bare);if(c){const _=c.querySelector(s);o=_.firstChild?parseInt(_.innerHTML):0,_.innerHTML=o+1,_.classList.remove(XOWS_CLS_HIDDEN)}}function xows_gui_unread_reset(_){let e,o,s;_.type===XOWS_PEER_ROOM?(o="."+XOWS_CLS_ROOM_UNRD,s=xows_doc.room_unrd):(o="."+XOWS_CLS_CONT_UNRD,s=xows_doc.cont_unrd),e=s.firstChild?parseInt(s.innerHTML):0;const t=document.getElementById(_.bare);if(t){const _=t.querySelector(o);e-=_.firstChild?parseInt(_.innerHTML):0,_.innerHTML="",_.classList.add(XOWS_CLS_HIDDEN)}s.innerHTML=e>0?e:"",e<=0&&s.classList.add(XOWS_CLS_HIDDEN)}function xows_gui_subs_push(_,e){let o=xows_doc.subs_ul.childNodes.length;for(;o--;)if(xows_doc.subs_ul.childNodes[o].id===_)return;xows_doc.subs_ul.appendChild(xows_tpl_spawn_rost_subs(_,e)),xows_doc_show("subs_unrd",!0),xows_doc.subs_unrd.innerHTML=xows_doc.subs_ul.childNodes.length}function xows_gui_subs_remove(_){let e=xows_doc.subs_ul.childNodes.length;for(;e--;)if(xows_doc.subs_ul.childNodes[e].id===_){xows_doc.subs_ul.removeChild(xows_doc.subs_ul.childNodes[e]);break}const o=xows_doc.subs_ul.childNodes.length;o?xows_doc.subs_unrd.innerHTML=o:(xows_doc.subs_unrd.innerHTML="",xows_doc_show("subs_unrd",!1))}function xows_gui_recv_chatstate(_,e,o){_===xows_gui_peer&&xows_gui_writing_notif_set(e,o>XOWS_CHAT_PAUS)}function xows_gui_hist_gen_mesg(_,e,o,s,t,c,n,i){let r=!0;if(_){(c-_.getAttribute("time")>XOWS_MESG_AGGR_THRESHOLD||_.getAttribute("from")!==s)&&(r=!1)}else r=!1;return r?xows_tpl_mesg_aggr_spawn(o,s,t,c,n,i):xows_tpl_mesg_full_spawn(o,s,t,c,n,i,e.name,e.avat)}function xows_gui_hist_push(_,e,o,s,t,c,n){const i=xows_cli_get_autor(_,o),r=_!==xows_gui_peer;if(r&&xows_gui_unread_notify(_,e),xows_gui_has_focus||c||!_.noti||xows_gui_notify_new(i.name,s,i.avat),!c&&!hist_end.classList.contains(XOWS_CLS_HIDDEN))return void xows_gui_peer_element(_,"hist_new").classList.remove(XOWS_CLS_HIDDEN);const l=xows_gui_peer_element(_,"hist_ul");if(xows_doc_get_child(l,e))return;const a=xows_gui_peer_scroll_bot(_),x=xows_gui_hist_gen_mesg(l.lastChild,i,e,o,s,t,c,n);l.appendChild(x),l.childNodes.length>XOWS_GUI_HIST_SIZE&&(l.removeChild(l.firstChild),xows_gui_peer_element(_,"hist_beg").innerHTML=""),!c&&a>100?xows_gui_peer_element(_,"hist_new").classList.remove(XOWS_CLS_HIDDEN):xows_gui_peer_scroll_down(_),r||(xows_doc_loader_monitor(x),xows_doc_loader_check())}function xows_gui_hist_avat_upd(_,e,o){if(!o)return;const s=xows_gui_peer_element(_,"hist_ul"),t="h-"+o;let c,n,i=s.childNodes.length;for(;i--;)(n=s.childNodes[i]).getAttribute("from")===e&&(c=n.querySelector("FIGURE"))&&(c.className=t)}function xows_gui_recv_receipt(_,e){const o=xows_gui_peer_element(_,e);o?o.querySelector("P").classList.add(XOWS_CLS_MESG_RECP):xows_log(1,"gui_hist_set_receipt","message not found",e)}function xows_gui_recv_subject(_,e){_===xows_gui_peer&&(xows_doc.head_meta.innerHTML=e||"")}let xows_gui_mam_query_timeout=null;function xows_gui_mam_query(_,e=20,o=100){if(!xows_gui_mam_query_timeout){let s,t;if(_){if(xows_doc_hidden("hist_end"))return;xows_doc.hist_ul.childNodes.length&&(s=parseInt(xows_doc.hist_ul.lastChild.getAttribute("time"))),xows_doc_cls_add("hist_end","hist-loading")}else{if(xows_doc.hist_beg.innerHTML.length)return;xows_doc.hist_ul.childNodes.length&&(t=parseInt(xows_doc.hist_ul.firstChild.getAttribute("time"))),xows_doc_cls_add("hist_beg","hist-loading")}xows_gui_mam_query_timeout=setTimeout(xows_cli_mam_query,o,xows_gui_peer,e,s,t,xows_gui_mam_handle)}}function xows_gui_mam_handle(_,e,o){const s=_!==xows_gui_peer,t=xows_gui_peer_element(_,"hist_ul"),c=xows_gui_peer_element(_,"hist_beg"),n=xows_gui_peer_element(_,"hist_end");c.classList.remove("hist-loading"),n.classList.remove("hist-loading");const i=0===t.childNodes.length;let r;e.length&&!i&&t.firstChild.getAttribute("time")>=e[e.length-1].time&&(r=t.firstChild);let l=t.childNodes.length-XOWS_GUI_HIST_SIZE+e.length;if(l>0)if(r){for(;l--;)t.removeChild(t.lastChild);n.classList.remove(XOWS_CLS_HIDDEN)}else{for(;l--;)t.removeChild(t.firstChild);c.innerHTML=""}const a=xows_gui_peer_scroll_off(_);let x,w,u,d=0;for(let o=0,c=e.length;o<c;++o)xows_doc_get_child(t,e[o].id)||(w=xows_gui_hist_gen_mesg(u,x=xows_cli_get_autor(_,e[o].from),e[o].id,e[o].from,e[o].body,e[o].time,x===xows_cli_own,!0),u=r?t.insertBefore(w,r):t.appendChild(w),s||xows_doc_loader_monitor(w),d++);if(o){let _=!1;e.length&&0===d?e[0].id===t.firstChild.id?_=!0:e[e.length-1].id!==t.lastChild.id&&xows_log(1,"gui_mam_handle","Complete MAM query exception","bound messages ID mismatches"):_=void 0!==r||i,_?c.innerHTML=xows_l10n_get("Start of history"):n.classList.add(XOWS_CLS_HIDDEN)}s||(r&&xows_gui_peer_scroll_seek(_,a),i&&xows_gui_peer_scroll_down(_),xows_doc_loader_check()),xows_gui_mam_query_timeout=null}let xows_gui_muc_cfg_form=null;function xows_gui_muc_cfg_handle(_,e){xows_gui_muc_cfg_form=e;for(let _=0,o=e.length;_<o;++_)switch(e[_].var){case"muc#roomconfig_roomname":xows_doc.room_titl.value=e[_].value;break;case"muc#roomconfig_roomdesc":xows_doc.room_desc.value=e[_].value;break;case"muc#roomconfig_persistentroom":xows_doc.room_pers.checked=e[_].value;break;case"muc#roomconfig_publicroom":xows_doc.room_publ.checked=e[_].value;break;case"muc#roomconfig_roomsecret":case"muc#roomconfig_allowmemberinvites":break;case"muc#roomconfig_membersonly":xows_doc.room_mbon.checked=e[_].value;break;case"muc#roomconfig_changesubject":case"muc#roomconfig_moderatedroom":xows_doc.room_modo.checked=e[_].value;break;case"muc#roomconfig_whois":xows_doc.room_jids.value=e[_].value;break;case"muc#roomconfig_historylength":xows_doc.room_hmax.value=e[_].value;break;case"muc#roomconfig_defaulthistorymessages":xows_doc.room_hdef.value=e[_].value;break;case"muc#roomconfig_enablearchiving":xows_doc.room_arch.checked=e[_].value}xows_doc_show("room_conf",!0),xows_doc_show("room_edit",!1),xows_doc_show("page_room",!0)}function xows_gui_evt_click_hnd(_){xows_cli_activity_wakeup();const e=_.target===xows_doc.hnd_lside?xows_doc.col_lside:xows_doc.col_rside;window.matchMedia("(min-width: 800px)").matches?(xows_doc_cls_rem(e.id,"column-wide"),xows_doc_cls_set(e.id,"column-thin",e.clientWidth>55)):(xows_doc_cls_rem(e.id,"column-thin"),xows_doc_cls_set(e.id,"column-wide",e.clientWidth<55))}function xows_gui_evt_click_rost_tabs(_){xows_cli_activity_wakeup();const e=_.target.closest("button");e&&xows_gui_rost_switch(e.getAttribute("id"))}function xows_gui_evt_click_rost_ul(_){xows_cli_activity_wakeup();const e=_.target.closest("li");if(e)if("IMG"===_.target.tagName||"BUTTON"===_.target.tagName){xows_cli_subscribe_request(e.id),xows_doc.info_titl.innerHTML=xows_l10n_get("Resend authorization");const _="New authorization request was sent to contact.";xows_doc.info_text.innerHTML=xows_l10n_get(_),xows_doc_show("page_info",!0)}else xows_gui_switch_peer(e.getAttribute("id"))}function xows_gui_evt_click_subs_ul(_){if(xows_cli_activity_wakeup(),"BUTTON"!==_.target.tagName)return;const e=_.target,o="allow"===e.getAttribute("name"),s=e.closest("li"),t=s.hasAttribute("name")?s.getAttribute("name"):null;s&&xows_cli_subscribe_allow(s.id,o,t)}function xows_gui_evt_click_cont_add(_){xows_cli_activity_wakeup();xows_doc.cont_text.innerHTML=xows_l10n_get("Enter the JID address of the contact to add"),xows_doc.cont_text.classList.remove("dialog-text-error"),xows_doc.cont_bare.value="",xows_doc.cont_bare.readOnly=!1,xows_doc_show("page_cont",!0)}function xows_gui_evt_click_room_add(_){xows_cli_activity_wakeup(),xows_doc.join_room.value="",xows_doc_show("page_join",!0)}function xows_gui_evt_click_occu_list(_){if(xows_cli_activity_wakeup(),"IMG"!==_.target.tagName&&"BUTTON"!==_.target.tagName)return;const e=_.target.closest("li");if(e){const _=xows_jid_to_bare(e.getAttribute("jid")),o="Add this contact to your contact list ?";xows_doc.cont_text.innerHTML=xows_l10n_get(o),xows_doc.cont_text.classList.remove("dialog-text-error"),xows_doc.cont_bare.value=_,xows_doc.cont_bare.readOnly=!0,xows_doc_show("page_cont",!0)}}function xows_gui_evt_click_chat_upld(_){xows_cli_activity_wakeup(),xows_doc.chat_file.value="",xows_doc.chat_file.click()}function xows_gui_evt_click_page_auth(_){switch(_.target.id){case"auth_cnct":return xows_doc_show("page_auth",!1),xows_doc_show("page_wait",!0),xows_doc.wait_text.innerHTML=xows_l10n_get("Connecting..."),(xows_gui_auth={}).user=xows_doc.auth_user.value.toLowerCase(),xows_gui_auth.pass=xows_doc.auth_pass.value,xows_gui_auth.cred=xows_doc.auth_cred.checked,xows_doc.auth_pass.value="",void xows_gui_connect();case"auth_regi":xows_doc_show("page_auth",!1),xows_doc_show("page_regi",!0)}}function xows_gui_evt_key_page_auth(_){13===_.keyCode&&xows_doc.auth_cnct.click()}function xows_gui_evt_click_page_regi(_){switch(_.target.id){case"regi_capt":return void xows_doc_cls_add("regi_capt","captcha-checked");case"regi_subm":return void(xows_doc_cls_has("regi_capt","captcha-checked")&&(xows_doc_show("page_regi",!1),xows_doc_show("page_wait",!0),xows_doc.wait_text.innerHTML=xows_l10n_get("Connecting..."),(xows_gui_auth={}).user=xows_doc.regi_user.value.toLowerCase(),xows_gui_auth.pass=xows_doc.regi_pass.value,xows_doc.regi_pass.value="",xows_gui_register()));case"regi_canc":xows_doc_show("page_regi",!1),xows_doc_show("page_auth",!0)}}function xows_gui_evt_key_page_regi(_){13===_.keyCode&&xows_doc.regi_subm.click()}function xows_gui_evt_click_page_upld(_){switch(_.target.id){case"upld_canc":xows_doc.upld_canc.disabled=!0,xows_cli_upld_abort();case"upld_clos":xows_doc_show("page_upld",!1)}}function xows_gui_evt_click_page_cont(_){switch(_.target.id){case"cont_subm":{let _=xows_doc.cont_bare.value;if(!xows_is_jid(_)){const _="Please enter a valid JID address in the form: user@domain.tld";return xows_doc.cont_text.innerHTML="<b>"+xows_l10n_get(_)+"<b>",void xows_doc.cont_text.classList.add("dialog-text-warn")}const e=_.split("@")[0];xows_cli_change_roster(_,e[0].toUpperCase()+e.slice(1))}case"cont_canc":xows_doc_show("page_cont",!1)}}function xows_gui_evt_key_page_cont(_){13===_.keyCode&&xows_doc.cont_subm.click()}function xows_gui_evt_click_page_card(_){switch(_.target.id){case"card_avat":return void xows_doc.card_file.click();case"card_subm":let e,o,s;xows_cli_change_profile(e=xows_doc.card_name.value,o=xows_doc.card_avat.data,s=xows_doc.card_open.checked);case"card_canc":xows_doc_show("page_card",!1)}}function xows_gui_evt_key_page_card(_){13===_.keyCode&&xows_doc.card_subm.click()}function xows_gui_evt_change_card_file(_){if(xows_doc.card_file.files[0]){const _=new FileReader;_.onload=function(_){const e=new Image;e.onload=function(_){const e=xows_gen_avatar(XOWS_AVAT_SIZE,this);xows_doc.card_avat.data=e,xows_doc.card_avat.style.backgroundImage='url("'+e+'")'},e.src=_.target.result},_.readAsDataURL(xows_doc.card_file.files[0])}}function xows_gui_evt_click_page_room(_){switch(_.target.id){case"room_subm":if(xows_doc_hidden("room_conf"))xows_cli_send_subject(xows_gui_peer,xows_doc.room_subj.value);else{const _=xows_gui_muc_cfg_form;for(let e=0,o=_.length;e<o;++e)switch(_[e].var){case"muc#roomconfig_roomname":_[e].value=xows_doc.room_titl.value;break;case"muc#roomconfig_roomdesc":_[e].value=xows_doc.room_desc.value;break;case"muc#roomconfig_persistentroom":_[e].value=xows_doc.room_pers.checked?"1":"0";break;case"muc#roomconfig_publicroom":_[e].value=xows_doc.room_publ.checked?"1":"0";break;case"muc#roomconfig_membersonly":_[e].value=xows_doc.room_mbon.checked?"1":"0";break;case"muc#roomconfig_moderatedroom":_[e].value=xows_doc.room_modo.checked?"1":"0";break;case"muc#roomconfig_whois":_[e].value=xows_doc.room_jids.value;break;case"muc#roomconfig_historylength":_[e].value=xows_doc.room_hmax.value;break;case"muc#roomconfig_defaulthistorymessages":_[e].value=xows_doc.room_hdef.value;break;case"muc#roomconfig_enablearchiving":_[e].value=xows_doc.room_arch.checked?"1":"0"}xows_cli_room_cfg_set(xows_gui_peer,_)}case"room_canc":xows_doc_show("page_room",!1)}}function xows_gui_evt_key_page_room(_){13===_.keyCode&&xows_doc.room_subm.click()}function xows_gui_evt_click_page_join(_){switch(_.target.id){case"join_subm":{const _=xows_cli_room_join(null,xows_doc.join_room.value,xows_cli_own.name);_&&xows_gui_switch_peer(_.bare)}case"join_canc":xows_doc_show("page_join",!1)}}function xows_gui_evt_key_page_join(_){13===_.keyCode&&xows_doc.join_subm.click()}function xows_gui_evt_click_page_info(_){"BUTTON"===_.target.tagName&&(xows_doc.page_info.classList.remove("dialog-background"),xows_doc_show("page_info",!1))}function xows_gui_evt_click_emoj_menu(_){const e=_.target.closest("li");e&&(xows_doc.send_edit.innerHTML+=":"+e.getAttribute("name")+":",xows_doc.send_wrap.classList.remove("send-phld"),xows_doc.send_edit.focus()),xows_doc_cls_tog("drop_emoj",XOWS_CLS_HIDDEN),xows_cli_activity_wakeup()}function xows_gui_evt_click_show_menu(_){const e=_.target.closest("li");if(e){const _=parseInt(e.getAttribute("name"));if(!(_>=0))return xows_doc.auth_text.innerHTML=xows_l10n_get("Please enter your username and password"),xows_doc.auth_user.value="",xows_doc.auth_pass.value="",navigator.credentials&&navigator.credentials.preventSilentAccess(),xows_gui_disconnect(),void xows_init_login_user();xows_cli_change_presence(_)}xows_doc_cls_tog("drop_show",XOWS_CLS_HIDDEN),xows_cli_activity_wakeup()}function xows_gui_evt_click_user_menu(_){xows_doc.card_name.value=xows_cli_own.name;const e=xows_cli_cache_avat_get(xows_cli_own.avat);xows_doc.card_avat.style.width=XOWS_AVAT_SIZE+"px",xows_doc.card_avat.style.height=XOWS_AVAT_SIZE+"px",xows_doc.card_avat.style.backgroundImage='url("'+e+'")',xows_doc.card_avat.data=xows_cli_cache_avat_get(xows_cli_own.avat),xows_doc_show("page_card",!0),xows_cli_activity_wakeup()}function xows_gui_evt_click_room_menu(_){const e=_.target.closest("li");if(e)switch(e.getAttribute("name")){case"subject":xows_doc.room_subj.value=xows_doc.head_meta.innerHTML,xows_doc_show("room_conf",!1),xows_doc_show("room_edit",!0),xows_doc_show("page_room",!0);break;case"config":xows_cli_room_cfg_get(xows_gui_peer,xows_gui_muc_cfg_handle)}xows_doc_cls_tog("drop_room",XOWS_CLS_HIDDEN),xows_cli_activity_wakeup()}function xows_gui_evt_click_chat_noti(_){"chat_noti"===_.target.id?(xows_gui_notify_allow=0,xows_doc_show("chat_mute",!0),xows_doc_show("chat_noti",!1),xows_gui_peer.noti=!1):xows_gui_notify_allow_query()}const xows_gui_evt_keydown=new Array(256);function xows_gui_evt_keyud_send_edit(_){if(xows_gui_evt_keydown[_.keyCode]="keydown"===_.type,"keydown"===_.type)if(13===_.keyCode){if(xows_gui_evt_keydown[16])return;if(_.preventDefault(),xows_gui_peer){let _=xows_doc.send_edit.innerText;_.length&&(xows_cli_send_message(xows_gui_peer,_),xows_doc_cls_add("send_wrap","send-phld"),xows_doc.send_edit.innerHTML=""),xows_cli_chatstate_set(xows_gui_peer,XOWS_CHAT_ACTI)}}else xows_gui_peer&&xows_cli_chatstate_set(xows_gui_peer,XOWS_CHAT_COMP);xows_cli_activity_wakeup()}function xows_gui_evt_input_send_edit(_){if(xows_doc.send_edit.innerText.length<2&&0===xows_doc.send_edit.innerText.trim().length)return xows_doc_cls_add("send_wrap","send-phld"),void(xows_doc.send_edit.innerHTML="");xows_doc_cls_has("send_wrap","send-phld")&&xows_doc_cls_rem("send_wrap","send-phld")}function xows_gui_evt_keyp_user_stat(_){if(13===_.keyCode){const _=xows_doc.user_stat.value;xows_doc.user_stat.value="",xows_cli_change_status(_),xows_doc.user_stat.placeholder=_.length?_:xows_l10n_get("No status defined"),xows_doc.user_stat.blur()}xows_cli_activity_wakeup()}function xows_gui_evt_scroll_chat_main(_){const e=xows_doc.chat_main;e.scrollHeight!==e.clientHeight&&(e.scrollTop<20&&xows_gui_mam_query(!1),e.scrollHeight-e.scrollTop-e.clientHeight<20&&(xows_doc_show("hist_new",!1),xows_doc_hidden("hist_end")||xows_gui_mam_query(!0)))}function xows_gui_evt_click_chat_main(_){"hist_new"===_.target.id&&(xows_doc_hidden("hist_end")?xows_doc.chat_main.scrollTop=xows_doc.chat_main.scrollHeight:(xows_doc.hist_ul.innerHTML="",xows_doc.hist_beg.innerHTML="",xows_doc_show("hist_end",!1),xows_gui_mam_query(!1,XOWS_GUI_HIST_SIZE,0)))}function xows_gui_evt_change_chat_file(_){xows_gui_peer.bare&&xows_doc.chat_file.files[0]&&(xows_doc_cls_rem("upld_text","dialog-text-error"),xows_doc_show("upld_canc",!0),xows_doc_show("upld_clos",!1),xows_doc.upld_pbar.parentNode.classList.remove(XOWS_CLS_HIDDEN),xows_doc.upld_pbar.style.width="0%",xows_doc.upld_text.innerHTML=xows_l10n_get("Uploading")+" : ",xows_doc.upld_text.innerHTML+=xows_doc.chat_file.files[0].name,xows_cli_upld_query(xows_doc.chat_file.files[0],xows_gui_cli_upld_error,xows_gui_cli_upld_success,xows_gui_cli_upld_progress,xows_gui_cli_upld_abort),xows_doc_show("page_upld",!0))}function xows_gui_evt_focus(){const _=xows_gui_has_focus;(xows_gui_has_focus=document.hasFocus())&&!_&&xows_cli_activity_wakeup()}function xows_gui_evt_mouseup(_){const e=_.target.closest("li"),o=_.target.closest("button");e&&console.warn("xows_gui_evt_mouseup: "+e.getAttribute("name")),o&&console.warn("xows_gui_evt_mouseup: "+o.id)}function xows_gui_evt_unload(_){xows_log(2,"gui_evt_unload","Unload event from browser"),xows_gui_disconnect()}let xows_gui_notify_allow=0,xows_gui_notify_await=null;function xows_gui_notify_allow_handle(_){xows_gui_notify_allow=_,"granted"===_&&(xows_gui_peer&&(xows_gui_peer.noti=!0,xows_doc_show("chat_mute",!1),xows_doc_show("chat_noti",!0)),xows_gui_notify_await&&(xows_gui_notify_new(xows_gui_notify_await.title,xows_gui_notify_await.body,xows_gui_notify_await.avat),xows_gui_notify_await=null))}function xows_gui_notify_allow_query(){xows_gui_notify_allow=0,Notification.requestPermission().then(xows_gui_notify_allow_handle)}function xows_gui_notify_new(_,e,o){switch(xows_gui_notify_allow){case"denied":return;case"granted":{xows_gui_notify_sound.play();const s=xows_cli_cache_avat_get(o);let t;t=s?new Notification(_,{body:e,icon:s}):new Notification(_,{body:e,icon:"/"+xows_options.root+"/icon.svg"})}break;default:xows_gui_notify_await={title:_,body:e,avat:o},xows_gui_notify_allow_query()}}function xows_gui_reset(){xows_gui_switch_peer(null);const _=["page_main","page_upld","page_cont","page_card","page_join","page_room","page_regi","page_info","page_auth","page_wait","drop_show","chat_fram","hist_end","chat_stat","drop_emoj","hist_new","room_list"];let e=_.length;for(;e--;)xows_doc_show(_[e],!1);xows_doc.cont_ul.innerHTML="",xows_doc.room_ul.innerHTML="",xows_doc.hist_ul.innerHTML="",xows_doc.modo_ul.innerHTML="",xows_doc.memb_ul.innerHTML="",xows_doc.hist_beg.innerHTML="",xows_doc_cls_add("cont_tab","tab-enabled"),xows_doc_cls_rem("room_tab","tab-enabled"),xows_doc_show("cont_list",!0),xows_doc_cls_rem("col_lside","column-thin"),xows_doc_cls_rem("col_lside","column-wide"),xows_doc_cls_rem("col_lside","column-hide"),xows_doc_cls_rem("col_rside","column-thin"),xows_doc_cls_rem("col_rside","column-wide"),xows_doc_cls_add("col_rside","column-hide");for(const _ in xows_doc_frag_db)"empty"!==_&&delete xows_doc_frag_db[_];xows_gui_error_page="page_auth"}function xows_gui_disconnect(){xows_log(2,"gui_disconnect","Cleaning GUI session"),xows_gui_peer&&xows_cli_chatstate_set(xows_gui_peer,XOWS_CHAT_GONE),xows_gui_reset(),xows_cli_disconnect()}function xows_gui_cli_upld_progress(_){xows_doc.upld_pbar.style.width=_+"%"}function xows_gui_cli_upld_error(_){xows_doc_show("upld_canc",!1),xows_doc_show("upld_clos",!0),xows_doc.upld_pbar.parentNode.classList.add(XOWS_CLS_HIDDEN),xows_doc_cls_add("upld_text","dialog-text-error"),xows_doc.upld_text.innerHTML="<b>"+xows_l10n_get("Upload failed")+"</b><br>"+_}function xows_gui_cli_upld_abort(){xows_doc_show("page_upld",!1)}function xows_gui_cli_upld_success(_){xows_doc_show("page_upld",!1),setTimeout(xows_cli_send_message,400,xows_gui_peer,_)}function xows_gui_cli_register(_){xows_log(2,"gui_cli_register","Show info page"),xows_doc.info_titl.innerHTML=xows_l10n_get("Account creation"),xows_doc.info_head.innerHTML="<b>"+xows_l10n_get("Congratulation !")+"</b>";let e=xows_l10n_get("The account")+" <b>"+_+"</b> ";e+=xows_l10n_get("was successfully created.")+"<br><br>",e+=xows_l10n_get("You can now login using")+" <b>",e+=xows_options.domain?_.split("@")[0]:_,e+="</b> "+xows_l10n_get("as username."),xows_doc.info_text.classList="dialog-text",xows_doc.info_text.innerHTML=e,xows_gui_error_page="page_auth",xows_doc_show("page_regi",!1),xows_doc_show("page_wait",!1),xows_doc_show("page_upld",!1),xows_doc_show("page_auth",!0),xows_doc.page_info.classList.add("dialog-background"),xows_doc_show("page_info",!0)}function xows_gui_cli_error(_,e){let o,s;switch(_){case 0:s=xows_l10n_get("Error"),o="dialog-text-error";break;case 1:s=xows_l10n_get("Warning"),o="dialog-text-warn";break;case 2:s=xows_l10n_get("Success"),o="dialog-text-success";break;default:s=xows_l10n_get("Information"),o=""}xows_doc.info_titl.innerHTML=s,xows_doc.info_text.classList="dialog-text "+o,xows_doc.info_text.innerHTML="<b>"+xows_l10n_get(e)+"<b>",xows_gui_error_page="page_auth",xows_doc_show("page_regi",!1),xows_doc_show("page_wait",!1),xows_doc_show("page_upld",!1),xows_doc_show("page_auth",!0),xows_doc_show("page_info",!0)}function xows_gui_cli_close(_,e){let o,s,t;switch(_){case XOWS_SIG_ERR:o="dialog-text-error",t=xows_gui_error_page;break;case XOWS_SIG_WRN:s=xows_l10n_get("Warning"),o="dialog-text-warn",t="page_info";break;case XOWS_SIG_LOG:s=xows_l10n_get("Success"),o="dialog-text-success",t="page_info";break;default:return}"page_info"===t&&(xows_doc.info_titl.innerHTML=s);const c=xows_doc[t].querySelector(".dialog-text");c&&(c.innerHTML="<b>"+xows_l10n_get(e)+"<b>",c.classList="dialog-text "+o),xows_gui_error_page="page_auth",xows_doc_show("page_upld",!1),xows_doc_show("page_regi",!1),xows_doc_show("page_auth",!0),xows_doc_show("page_wait",!1),xows_gui_disconnect(),xows_doc_show(t,!0)}let xows_options={root:"xows",url:"ws://localhost/xmpp-websocket/",domain:"localhost",locale:"en-US",theme:"dark",verbose:1,uncache:!1,allow_register:!1,legacy_vcard:!1,vcard4_notify:!0,avatar_notify:!1};function xows_init_login_user(){xows_log(2,"xows_init_login_user","Normal login way"),xows_doc_show("auth_save",window.PasswordCredential),xows_doc_show("page_auth",!0),xows_doc_show("page_wait",!1)}function xows_init_login_auto(_){_?(xows_log(2,"xows_init_login_auto","Found credential","try audacious login way"),xows_doc_show("page_auth",!1),xows_doc_show("page_wait",!0),xows_doc.wait_text.innerHTML=xows_l10n_get("Connecting..."),xows_gui_auth={user:_.id,pass:_.password},xows_gui_connect()):(xows_log(2,"xows_init_login_auto","No credential found","Fallback to normal login"),xows_init_login_user())}function xows_init_ondoc(){if(window.PasswordCredential){const _={password:!0,mediation:"optional"};navigator.credentials.get(_).then(xows_init_login_auto,xows_init_login_user)}else xows_init_login_user()}function xows_init_ontpl(){xows_doc_init(xows_init_ondoc)}function xows_init_onl10n(){xows_tpl_init(xows_init_ontpl)}function xows_init(_){_&&("root"in _&&(xows_options.root=_.root),"url"in _&&(xows_options.url=_.url),"domain"in _&&(xows_options.domain=_.domain),"locale"in _&&(xows_options.locale=_.locale),"theme"in _&&(xows_options.theme=_.theme),"verbose"in _&&(xows_options.verbose=_.verbose),"uncache"in _&&(xows_options.uncache=_.uncache),"allow_register"in _&&(xows_options.allow_register=_.allow_register),"legacy_vcard"in _&&(xows_options.legacy_vcard=_.legacy_vcard),"vcard4_notify"in _&&(xows_options.vcard4_notify=_.vcard4_notify),"avatar_notify"in _&&(xows_options.avatar_notify=_.avatar_notify)),xows_l10n_select(xows_options.locale,xows_init_onl10n)}
