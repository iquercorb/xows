"use strict";const e="Xows",o="0.9.9b",_="https://github.com/iquercorb/xows",s=new Path2D("m7.39 0.00182c-0.949 0.0386-1.99 0.696-2.81 1.54l2.42 3.79c-2.24 1.41-3.3 3.4-3.98 5.57-2.24 0.214-0.682-4.16-0.836-5.17 0 0-3.6 5.7-1.55 7.3 1.46 1.15 3.94 1.59 3.94 1.59l-3.15 3.99c2.14 0.72 6.9 0.794 6.9 0.794l2.73-4.25h1.91l2.73 4.25s4.76-0.0743 6.9-0.794l-3.15-3.99s2.47-0.444 3.94-1.59c2.04-1.6-1.65-7.3-1.65-7.3-0.152 1.01 1.5 5.38-0.739 5.17-0.675-2.17-1.74-4.16-3.98-5.57l2.42-3.79c-0.827-0.845-1.86-1.5-2.81-1.54-0.135-0.00482-0.27 0.00193-0.401 0.0232l-3.64 4.52h-1.14l-3.64-4.52a2.01 2.01 0 0 0-0.401-0.0232zm1.42 8.17c1.69 0 1.44 2.58 1.44 2.58s-0.968 0.027-1.88 0.027-1.54-0.0482-1.54-0.726c0-0.678 0.285-1.88 1.97-1.88zm6.39 0c1.69 0 1.97 1.2 1.97 1.88 0 0.678-0.63 0.726-1.54 0.726a77.5 77.5 0 0 1-1.88-0.027s-0.241-2.58 1.44-2.58z");function xows_asbool(e){if("string"==typeof e){const o=parseInt(e);return Number.isNaN(o)?"TRUE"===e.toUpperCase():Boolean(o)}return Boolean(e)}function xows_isfunc(e){return e&&e.constructor&&e.call&&e.apply}function xows_def_readonly(e,o,_){Object.defineProperty(e,o,{value:_,writable:!1})}function xows_log(e,o,_,s,t){if(e>Mn.lib_verbose)return;let n,c="";e>1&&t&&(c+="%c",n="color:"+t),c+=_,s&&(c+=": "+s);const i=o+": "+c;switch(e){case 0:case 1:console.warn(i);break;default:n?console.log(i,n):console.log(i)}}const t="0123456789abcdef",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function xows_str_to_utf8(e){let o,_,s="";for(let t=0,n=e.length;t<n;++t)(o=e.charCodeAt(t))<128?s+=e.charAt(t):o<2048?s+=String.fromCharCode(192|o>>6,128|63&o):o<55296||o>=57344?s+=String.fromCharCode(224|o>>12,128|o>>6&63,128|63&o):(++t,o=65536+((1023&o)<<10|1023&(_=e.charCodeAt(t))),s+=String.fromCharCode(240|o>>18,128|o>>12&63,128|o>>6&63,128|63&o));return s}function xows_str_bytes_len(e){let o,_=0;for(let s=0,t=e.length;s<t;++s)(o=e.charCodeAt(s))<128?_++:o<2048?_+=2:o<55296||o>=57344?_+=3:(++s,_+=4);return _}function xows_str_to_bytes(e,o){let _,s;const t=new Uint8Array(o||xows_str_bytes_len(e));for(let o=0,n=0,c=e.length;o<c;++o)(_=e.charCodeAt(o))<128?t[n++]=_:_<2048?(t[n++]=192|_>>6,t[n++]=128|63&_):_<55296||_>=57344?(t[n++]=224|_>>12,t[n++]=128|_>>6&63,t[n++]=128|63&_):(++o,_=65536+((1023&_)<<10|1023&(s=e.charCodeAt(o))),t[n++]=240|_>>18,t[n++]=128|_>>12&63,t[n++]=128|_>>6&63,t[n++]=128|63&_);return t}function xows_bytes_to_str(e){return String.fromCharCode.apply(null,e)}function xows_bytes_to_b64(e){const o=e.length,_=o%3;let s,t,c,i="";for(s=0,t=o-_;s<t;)c=e[s++]<<16|e[s++]<<8|e[s++],i+=n[63&c>>18],i+=n[63&c>>12],i+=n[63&c>>6],i+=n[63&c];return 0!==_&&(c=e[s++]<<16,_>1&&(c|=e[s]<<8),i+=n[63&c>>18],i+=n[63&c>>12],i+=_>1?n[63&c>>6]:"=",i+="="),i}function xows_b64_to_bytes(e){const o=atob(e),_=new Uint8Array(o.length);for(let e=0;e<o.length;e++)_[e]=o.charCodeAt(e);return _}function xows_bytes_to_hex(e){let o,_="";for(let s=0,n=e.length;s<n;++s)o=e[s],_+=t.charAt(o>>>4&15)+t.charAt(15&o);return _}function xows_bytes_to_int(e,o=0){return e[0+o]|e[1+o]<<8|e[2+o]<<16|e[3+o]<<24}function xows_gen_uuid(){if(window.crypto.randomUUID)return window.crypto.randomUUID();const e=new Uint8Array(16);window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let o="";for(let _=0,s=0;s<16;++s)8!==_&&13!==_&&18!==_&&23!==_||(o+="-",_++),o+=t.charAt(e[s]>>>4&15)+t.charAt(15&e[s]),_+=2;return o}function xows_gen_nonce_hex(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let _="";for(let s=0;s<e;++s)_+=t.charAt(o[s]>>>4&15)+t.charAt(15&o[s]);return _}function xows_gen_nonce_asc(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let _="";for(let s=0;s<e;++s)_+=n[o[s]%62];return _}function xows_gen_nonce_num(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let _="";for(let s=0;s<e;++s)_+=t[o[s]%10];return _}function xows_hash_md5(e){let o;function P1(e,_,s,t,n,c,i){return((o=e+((t^_&(s^t))+n+i))<<c|o>>>32-c)+_}function P2(e,_,s,t,n,c,i){return((o=e+((s^t&(_^s))+n+i))<<c|o>>>32-c)+_}function P3(e,_,s,t,n,c,i){return((o=e+((_^s^t)+n+i))<<c|o>>>32-c)+_}function P4(e,_,s,t,n,c,i){return((o=e+((s^(_|~t))+n+i))<<c|o>>>32-c)+_}let _,s,t,n=0;if("string"==typeof e)t=xows_str_to_bytes(e,64+((s=8*(_=xows_str_bytes_len(e)))+64>>9<<6));else for(s=8*(_=e.length),t=new Uint8Array(64+(s+64>>9<<6));n<_;++n)t[n]=e[n];t[_]|=128;let c=t.length-8;t[c]=255&s,t[c+1]=s>>8&255,t[c+2]=s>>16&255,t[c+3]=s>>24&255;const i=new Uint32Array(16),r=new Uint32Array(4);let l,a,u,d;for(r[0]=1732584193,r[1]=4023233417,r[2]=2562383102,r[3]=271733878,c=0;c<t.length;){for(n=0;n<16;++n)i[n]=t[c++]|t[c++]<<8|t[c++]<<16|t[c++]<<24;l=r[0],a=P4(a=P4(a=P4(a=P4(a=P3(a=P3(a=P3(a=P3(a=P2(a=P2(a=P2(a=P2(a=P1(a=P1(a=P1(a=P1(a=r[1],u=P1(u=r[2],d=P1(d=r[3],l=P1(l,a,u,d,i[0],7,3614090360),a,u,i[1],12,3905402710),l,a,i[2],17,606105819),d,l,i[3],22,3250441966),u=P1(u,d=P1(d,l=P1(l,a,u,d,i[4],7,4118548399),a,u,i[5],12,1200080426),l,a,i[6],17,2821735955),d,l,i[7],22,4249261313),u=P1(u,d=P1(d,l=P1(l,a,u,d,i[8],7,1770035416),a,u,i[9],12,2336552879),l,a,i[10],17,4294925233),d,l,i[11],22,2304563134),u=P1(u,d=P1(d,l=P1(l,a,u,d,i[12],7,1804603682),a,u,i[13],12,4254626195),l,a,i[14],17,2792965006),d,l,i[15],22,1236535329),u=P2(u,d=P2(d,l=P2(l,a,u,d,i[1],5,4129170786),a,u,i[6],9,3225465664),l,a,i[11],14,643717713),d,l,i[0],20,3921069994),u=P2(u,d=P2(d,l=P2(l,a,u,d,i[5],5,3593408605),a,u,i[10],9,38016083),l,a,i[15],14,3634488961),d,l,i[4],20,3889429448),u=P2(u,d=P2(d,l=P2(l,a,u,d,i[9],5,568446438),a,u,i[14],9,3275163606),l,a,i[3],14,4107603335),d,l,i[8],20,1163531501),u=P2(u,d=P2(d,l=P2(l,a,u,d,i[13],5,2850285829),a,u,i[2],9,4243563512),l,a,i[7],14,1735328473),d,l,i[12],20,2368359562),u=P3(u,d=P3(d,l=P3(l,a,u,d,i[5],4,4294588738),a,u,i[8],11,2272392833),l,a,i[11],16,1839030562),d,l,i[14],23,4259657740),u=P3(u,d=P3(d,l=P3(l,a,u,d,i[1],4,2763975236),a,u,i[4],11,1272893353),l,a,i[7],16,4139469664),d,l,i[10],23,3200236656),u=P3(u,d=P3(d,l=P3(l,a,u,d,i[13],4,681279174),a,u,i[0],11,3936430074),l,a,i[3],16,3572445317),d,l,i[6],23,76029189),u=P3(u,d=P3(d,l=P3(l,a,u,d,i[9],4,3654602809),a,u,i[12],11,3873151461),l,a,i[15],16,530742520),d,l,i[2],23,3299628645),u=P4(u,d=P4(d,l=P4(l,a,u,d,i[0],6,4096336452),a,u,i[7],10,1126891415),l,a,i[14],15,2878612391),d,l,i[5],21,4237533241),u=P4(u,d=P4(d,l=P4(l,a,u,d,i[12],6,1700485571),a,u,i[3],10,2399980690),l,a,i[10],15,4293915773),d,l,i[1],21,2240044497),u=P4(u,d=P4(d,l=P4(l,a,u,d,i[8],6,1873313359),a,u,i[15],10,4264355552),l,a,i[6],15,2734768916),d,l,i[13],21,1309151649),u=P4(u,d=P4(d,l=P4(l,a,u,d,i[4],6,4149444226),a,u,i[11],10,3174756917),l,a,i[2],15,718787259),d,l,i[9],21,3951481745),r[0]+=l,r[1]+=a,r[2]+=u,r[3]+=d}const x=new Uint8Array(16);for(n=0,c=0;n<4;++n)x[c++]=255&r[n],x[c++]=r[n]>>8&255,x[c++]=r[n]>>16&255,x[c++]=r[n]>>24&255;return x}function xows_hash_sha1(e){let o,_,s,t=0;if("string"==typeof e)s=xows_str_to_bytes(e,64+((_=8*(o=xows_str_bytes_len(e)))+64>>9<<6));else for(_=8*(o=e.length),s=new Uint8Array(64+(_+64>>9<<6));t<o;++t)s[t]=e[t];s[o]|=128;let n=s.length-4;s[n]=_>>24&255,s[n+1]=_>>16&255,s[n+2]=_>>8&255,s[n+3]=255&_;const c=new Uint32Array(16),i=new Uint32Array(5);let r,l,a,u,d,x,w,p;for(i[0]=1732584193,i[1]=4023233417,i[2]=2562383102,i[3]=271733878,i[4]=3285377520,n=0;n<s.length;){for(t=0;t<16;++t)c[t]=s[n++]<<24|s[n++]<<16|s[n++]<<8|s[n++];for(r=i[0],l=i[1],a=i[2],u=i[3],d=i[4],t=0;t<80;++t)t>15&&(p=c[t-3&15]^c[t-8&15]^c[t-14&15]^c[15&t],c[15&t]=p<<1|p>>>31),t<20?(x=1518500249,w=u^l&(a^u)):t<40?(x=1859775393,w=l^a^u):t<60?(x=2400959708,w=l&a|l&u|a&u):(x=3395469782,w=l^a^u),p=(r<<5|r>>>27)+w+(d+c[15&t]+x),d=u,u=a,a=l<<30|l>>>2,l=r,r=p;i[0]+=r,i[1]+=l,i[2]+=a,i[3]+=u,i[4]+=d}const m=new Uint8Array(20);for(t=0,n=0;t<5;++t)m[n++]=i[t]>>24&255,m[n++]=i[t]>>16&255,m[n++]=i[t]>>8&255,m[n++]=255&i[t];return m}function xows_hmac_sha1(e,o){"string"==typeof e&&(e=xows_str_to_bytes(e)),e.length>64&&(e=xows_hash_sha1(e));const _=new Uint8Array(64+o.length),s=new Uint8Array(84);let t=0;for(;t<e.length;++t)_[t]=54^e[t],s[t]=92^e[t];for(;t<64;++t)_[t]=54,s[t]=92;"string"==typeof o&&(o=xows_str_to_bytes(o));for(let e=0;e<o.length;++e)_[t++]=o[e];const n=xows_hash_sha1(_);for(let e=0,o=64;e<20;++e)s[o++]=n[e];return xows_hash_sha1(s)}function xows_hash_sha256(e){const o=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);let _,s,t,n=0;if("string"==typeof e)t=xows_str_to_bytes(e,64+((s=8*(_=xows_str_bytes_len(e)))+64>>9<<6));else for(s=8*(_=e.length),t=new Uint8Array(64+(s+64>>9<<6));n<_;++n)t[n]=e[n];t[_]|=128;let c=t.length-4;t[c]=s>>24&255,t[c+1]=s>>16&255,t[c+2]=s>>8&255,t[c+3]=255&s;const i=new Uint32Array(64),r=new Uint32Array(8);let l,a,u,d,x,w,p,m,g,f;for(r[0]=1779033703,r[1]=3144134277,r[2]=1013904242,r[3]=2773480762,r[4]=1359893119,r[5]=2600822924,r[6]=528734635,r[7]=1541459225,c=0;c<t.length;){for(n=0;n<16;++n)i[n]=t[c++]<<24|t[c++]<<16|t[c++]<<8|t[c++];for(l=r[0],a=r[1],u=r[2],d=r[3],x=r[4],w=r[5],p=r[6],m=r[7],n=0;n<64;n++)n>15&&(g=((f=i[n-2])>>>17|f<<15)^(f>>>19|f<<13)^f>>>10,i[n]=g+i[n-7],g=((f=i[n-15])>>>7|f<<25)^(f>>>18|f<<14)^f>>>3,i[n]+=g+i[n-16]),d+=f=m+(g=(x>>>6|x<<26)^(x>>>11|x<<21)^(x>>>25|x<<7))+(p^x&(w^p))+o[n]+i[n],f+=(g=(l>>>2|l<<30)^(l>>>13|l<<19)^(l>>>22|l<<10))+(l&a|u&(l|a)),m=p,p=w,w=x,x=d,d=u,u=a,a=l,l=f;r[0]+=l,r[1]+=a,r[2]+=u,r[3]+=d,r[4]+=x,r[5]+=w,r[6]+=p,r[7]+=m}const h=new Uint8Array(32);for(n=0,c=0;n<8;++n)h[c++]=r[n]>>24&255,h[c++]=r[n]>>16&255,h[c++]=r[n]>>8&255,h[c++]=255&r[n];return h}function xows_hash_sdbm(e){let o=0;for(let _=0;_<e.length;++_)o=e.charCodeAt(_)+(o<<6)+(o<<16)-o;const _=new Uint8Array(4);return _[0]=o>>24&255,_[1]=o>>16&255,_[2]=o>>8&255,_[3]=255&o,_}function xows_scram_mksalt(e){const o=atob(e),_=new Uint8Array(o.length+4);let s=0;for(;s<o.length;s++)_[s]=o.charCodeAt(s);return _[s++]=0,_[s++]=0,_[s++]=0,_[s++]=1,_}const c=new Intl.Collator;function xows_strcmp(e,o){return c.compare(e,o)}function xows_capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}const i=/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;function xows_isjid(e){return i.test(e)}function xows_jid_bare(e){const o=e.indexOf("/");return-1!==o?e.substring(0,o):e}function xows_jid_node(e){const o=e.indexOf("@");return-1!==o?e.substring(0,o):""}function xows_jid_host(e){const o=e.indexOf("@");if(-1!==o){const _=e.indexOf("/");return e.substring(o+1,-1!==_?_:null)}return""}function xows_jid_resc(e){const o=e.indexOf("/");return-1!==o?e.substring(o+1):""}function xows_uri_to_data(e){return 0===e.indexOf("data:")?e.substring(e.indexOf(",")+1):null}function xows_uri_to_type(e){return 0===e.indexOf("data:")?e.substring(5,e.indexOf(";")):null}const r=new Map([["&","&amp;"],["<","&lt;"],[">","&gt;"],["'","&apos;"],['"',"&quot;"],["\n","<br>"]]);function xows_html_esc_func(e){return r.get(e)}function xows_html_escape(e){return e.replace(/[\&<>'"\n]/g,xows_html_esc_func)}const l=["#22A849","#24ABC1","#F2C40C","#395BBF","#9B54B3","#E97333","#CF3838","#395BBF","#F2C40C","#22A849","#24ABC1","#9B54B3","#CF3838","#E97333"];function xows_gen_avatar(e,o,_){const t=document.createElement("canvas"),n=t.getContext("2d");if(o){let _;const s=o.naturalWidth,c=o.naturalHeight;if(s>e||c>e){let i,r,l;s>c?(r=.5*(s-(i=c)),l=0):(r=0,l=.5*(c-(i=s))),t.width=s,t.height=c,n.drawImage(o,0,0);const a=n.getImageData(r,l,i,i),u=new Int32Array(a.data.buffer);_=new ImageData(e,e);const d=new Int32Array(_.data.buffer),x=1/(e/i),w=Math.round(x),p=1/(w*w);for(let o=0;o<e;++o)for(let _=0;_<e;++_){const s=Math.round(_*x)*i+Math.round(o*x);let t=0,n=0,c=0,r=0;for(let e=0;e<w;++e)for(let o=0;o<w;++o){const _=u[s+(e*i+o)];r+=_>>24&255,c+=_>>16&255,n+=_>>8&255,t+=255&_}t=Math.round(t*p),n=Math.round(n*p),c=Math.round(c*p),r=Math.round(r*p),d[_*e+o]=r<<24|c<<16|n<<8|t}t.width=t.height=e,n.putImageData(_,0,0)}else t.width=t.height=e,n.drawImage(o,0,0,e,e)}else if(t.width=t.height=e,_){const o=Math.abs(_)%14;n.fillStyle=l[o],n.rect(0,0,e,e),n.fill(),n.fillStyle="#FFF";const t=.7,c=.5*e;n.translate(c-24*t,c-21*t);const i=e/24*t;n.scale(i,i),n.fill(s)}return t.toDataURL("image/png")}function xows_sdp_parse(e){const o={},_=e.split("\r\n");for(let e=0;e<_.length;++e){const s=_[e];switch(s.charAt(0)){case"v":o.version=s.substring(2);break;case"o":{const e=s.substring(2).split(" ");o.origin={username:e[0],sessionId:e[1],sessionVersion:e[2],netType:e[3],ipVer:parseInt(e[4].charAt(2)),address:e[5]};break}case"s":o.name=s.substring(2);break;case"t":{const e=s.substring(2).split(" ");o.timing={start:e[0],stop:e[1]};break}case"m":{o.media||(o.media=[]);const e=s.substring(2).split(" ");o.media.push({type:e[0],port:parseInt(e[1]),protocols:e[2],payloads:e.slice(3)});break}case"c":if(o.media){const e=o.media[o.media.length-1],_=s.substring(2).split(" ");e.connection={type:_[0],version:parseInt(_[1].charAt(2)),ip:_[2]}}break;case"a":{const e=o.media?o.media[o.media.length-1]:o,_=s.indexOf(":"),t=_>0?s.substring(_+1).split(" "):null,n=_>0?s.substring(2,_):s.substring(2);switch(n){case"group":e.group={type:t[0],mids:t.slice(1)};break;case"msid-semantic":e.msidSemantic={semantic:t[0],token:t[1]};break;case"ice-options":e.iceOptions=t[0];break;case"fingerprint":e.fingerprint||(e.fingerprint=[]),e.fingerprint.push({type:t[0],hash:t[1]});break;case"sendrecv":case"sendonly":case"recvonly":case"inactive":e.direction=n;break;case"extmap":{e.extmap||(e.extmap=[]);const o={value:parseInt(t[0]),uri:t[1]},_=t[0].split("/");_[1]&&(o.direction=_[1]),e.extmap.push(o);break}case"fmtp":e.fmtp||(e.fmtp=[]),e.fmtp.push({payload:parseInt(t[0]),config:t[1].split(";")});break;case"ice-ufrag":e.iceUfrag=t[0];break;case"ice-pwd":e.icePwd=t[0];break;case"msid":e.msid={group:t[0],id:t[1]};break;case"rtcp-fb":{e.rtcpFb||(e.rtcpFb=[]);const o={payload:parseInt(t[0]),type:t[1]};t[2]&&(o.subtype=t[2]),e.rtcpFb.push(o);break}case"rtcp-mux":e.rtcpMux=!0;break;case"rtcp-rsize":e.rtcpRsize=!0;break;case"rtpmap":{e.rtpmap||(e.rtpmap=[]);const o={payload:parseInt(t[0])},_=t[1].split("/");o.codec=_[0],_[1]&&(o.rate=_[1]),_[2]&&(o.channels=_[2]),e.rtpmap.push(o);break}case"ssrc":{e.ssrc||(e.ssrc=[]);const o={id:parseInt(t[0])};if(t[1]){const e=t[1].split(":");o.attribute=e[0],o.value=e[1]}e.ssrc.push(o);break}case"ssrc-group":e.ssrcGroup||(e.ssrcGroup=[]),e.ssrcGroup.push({semantics:t[0],ssrcs:t.slice(1)});break;case"candidate":{e.candidate||(e.candidate=[]);const o={network:1,foundation:t[0],component:t[1],protocol:t[2].toLowerCase(),priority:t[3],ip:t[4],port:t[5]};for(let e=6;e<t.length;e+=2)switch(t[e]){case"typ":o.type=t[e+1];break;case"raddr":o.raddr=t[e+1];break;case"rport":o.rport=t[e+1];break;case"generation":o.generation=t[e+1];break;case"tcptype":o.tcptype=t[e+1]}e.candidate.push(o);break}default:e[n]=!t||t[0]}break}}}return o}function xows_sdp_get_medias(e){const o={audio:!1,video:!1};let _=e.indexOf("m=");for(;_>0;){_+=2;const s=e.indexOf("\n",_),t=e.substring(_,s).split(" ")[0];"audio"!==t||o.audio||(o.audio=!0),"video"!==t||o.video||(o.video=!0),_=e.indexOf("m=",_)}return o}function xows_sdp_get_sid(e){let o=e.indexOf("o=");if(o>0){o+=2;const _=e.indexOf("\n",o);return e.substring(o,_).split(" ")[1]}return""}let a={},u="en",d=function(){};function xows_l10n_select(e,o){xows_isfunc(o)&&(d=o);let _=Mn.lib_path+"locale/LC_list.json";Mn.tpl_force_uncache&&(_+="?"+xows_gen_nonce_asc(4));const s=new XMLHttpRequest;s.open("GET",_,!0),s.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_select","parsing locale list",this.responseURL);let o=JSON.parse(this.responseText);if(!o)return void xows_log(0,"l10n_select",'locale list "'+this.responseURL+'" parse error');if(o[e])return xows_log(2,"l10n_select","found available locale",e),void xows_l10n_db_load(o[e]);if(-1!==e.indexOf("-")){let _=e.split("-")[0].toLowerCase();if(o[_])return xows_log(2,"l10n_select","found available language",_),void xows_l10n_db_load(o[_])}xows_log(1,"l10n_select",'invalid or unavailable locale "'+e+'"',"using default"),d()}else xows_init_failure(this.status,this.responseURL)},xows_log(2,"l10n_select","loading locale list",_),s.send()}function xows_l10n_db_load(e,o){xows_isfunc(o)&&(d=o);let _=Mn.lib_path+"locale/"+e+"/LC_db.json";Mn.tpl_force_uncache&&(_+="?"+xows_gen_nonce_asc(4));const s=new XMLHttpRequest;s.open("GET",_,!0),s.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_db_load","parsing JSON data",this.responseURL);let o=JSON.parse(this.responseText);if(!o)return void xows_log(0,"l10n_db_load",'data "'+this.responseURL+'" parse error');a=o,u=e,d()}else xows_log(0,"l10n_db_load",'file "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"'),d()},xows_log(2,"l10n_db_load","loading locale db",_),s.send()}function xows_l10n_get(e){const o=a[e];return o||e}function xows_l10n_parse_fn(e,o){const _=a[o];return _||o}function xows_l10n_parse(e){return e.replace(/\${['"](.*?)['"]}/g,xows_l10n_parse_fn)}function xows_l10n_has(e){return null!==a[e]&&void 0!==a[e]}function xows_l10n_date(e){const o=new Date(e),_=new Date,s=new Date(e);return _.setHours(0,0,0,0),s.setHours(0,0,0,0),_===s?xows_l10n_get("at")+" "+o.toLocaleTimeString(u):o.toLocaleDateString(u,{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}function xows_l10n_houre(e,o){const _=new Date(e).toLocaleTimeString(u,{hour:"2-digit",minute:"2-digit"});return o?_.replace(/AM|PM/,""):_}const x=new DOMParser,w=document.implementation.createDocument("jabber:client","Xows"),p=new Map([["&","&amp;"],["<","&lt;"],[">","&gt;"],["'","&apos;"],['"',"&quot;"]]),m=new Map([["&amp;","&"],["&lt;","<"],["&gt;",">"],["&apos;","'"],["&quot;",'"']]),g=/[\&<>'"]/g;function xows_xml_escap_fn(e){return p.get(e)}function xows_xml_escape(e){return e.replace(g,xows_xml_escap_fn)}function xows_xml_unesc_fn(e){return m.get(e)}function xows_xml_unesc(e){return e.replace(/\&\w*;/g,xows_xml_unesc_fn)}function xows_xml_parent(e,o){if("string"==typeof o||"number"==typeof o)e.appendChild(w.createTextNode(o));else if("object"==typeof o){const _=o.length;if(void 0!==_)for(let s=0;s<_;++s)xows_xml_parent(e,o[s]);else e.appendChild(o)}}function xows_xml_node(e,o,_){const s=w.createElement(e);if("object"==typeof o)for(const e in o)o.hasOwnProperty(e)&&null!==o[e]&&void 0!==o[e]&&s.setAttribute(e,o[e]);return _&&xows_xml_parent(s,_),s}function xows_xml_serialize(e){let o="<"+e.nodeName;for(let _=0;_<e.attributes.length;++_)o+=" "+e.attributes[_].nodeName+"='"+xows_xml_escape(e.attributes[_].nodeValue)+"'";const _=e.childNodes.length;if(0!==_){o+=">";for(let s=0;s<_;++s)1===e.childNodes[s].nodeType?o+=xows_xml_serialize(e.childNodes[s]):o+=xows_xml_escape(e.childNodes[s].nodeValue);o+="</"+e.nodeName+">"}else o+="/>";return o}function xows_xml_parse(e){return x.parseFromString(e,"text/xml")}function xows_xml_innertext(e){if(!e)return"";const o=e.childNodes.length;if(0===o&&3===e.nodeType)return xows_xml_unesc(e.nodeValue);let _="";for(let s=0;s<o;++s)3===e.childNodes[s].nodeType&&(_+=e.childNodes[s].nodeValue);return xows_xml_unesc(_)}function xows_xml_ns_select(e,o){const _=e.querySelectorAll("*");for(let e=0;e<_.length;++e)if(_[e].namespaceURI===o)return _[e];return null}function xows_xml_ns_select_all(e,o){const _=[],s=e.querySelectorAll("*");for(let e=0;e<s.length;++e)s[e].namespaceURI===o&&_.push(s[e]);return _}function xows_xml_beatify_tag(e){const o=e.replace(/-/g," ");return o[0].toUpperCase()+o.substring(1)}let f=null,h=null,b=null,y=-1;function xows_sasl_get_request(){return y<0?(xows_log(1,"sasl_get_reques","no SASL mechanism selected"),null):A[y].req()}function xows_sasl_get_response(e){return y<0?(xows_log(1,"sasl_get_response","no SASL mechanism selected"),null):A[y].res(e)}function xows_sasl_chk_integrity(e){return y<0?(xows_log(1,"sasl_chk_integrity","no SASL mechanism selected"),!1):A[y].chk(e)}function xows_sasl_get_mechanism(){return y>=0?A[y].name:null}function xows_sasl_get_data(){return f}function xows_sasl_plain_req(){let e=f.z+"\0";return e+=f.c+"\0",e+=h,h=null,e}function xows_sasl_plain_resp(e){return""}function xows_sasl_plain_chk(e){return!0}let v=null,F=null,k=null;function xows_sasl_sha1_req(){v=xows_gen_nonce_asc(24);let e="n="+f.c;return F=e+=",r="+v,"n,,"+e}function xows_sasl_sha1_resp(e){let o,_,s,t,n=e.split(",");for(let e=0;e<n.length;++e)"r"===(t=n[e].match(/([a-z]+)=(.+)/))[1]&&(o=t[2]),"s"===t[1]&&(_=t[2]),"i"===t[1]&&(s=t[2]);if(o.substring(0,24)!==v)return h=null,xows_log(0,"sasl_sha1_resp","SCRAM-SHA-1 challenge error","missing cnonce in server nonce"),"";let c,i,r="c=biws,r="+o,l=F;if(l+=","+e+","+r,h){let e,o;e=o=xows_hmac_sha1(h,xows_scram_mksalt(_));for(let _=1;_<s;++_){o=xows_hmac_sha1(h,o);for(let _=0;_<20;++_)e[_]^=o[_]}c=xows_hmac_sha1(e,"Client Key"),i=xows_hmac_sha1(e,"Server Key"),f.salt=_,f.iter=s,f.ckey=Array.from(c),f.skey=Array.from(i),h=null}else{if(f.salt!==_||f.iter!==s)return h=null,xows_log(0,"sasl_sha1_resp","SCRAM-SHA-1 saved data error","Salt or Iteration does not match"),"";c=Uint8Array.from(f.ckey),i=Uint8Array.from(f.skey)}const a=xows_hmac_sha1(xows_hash_sha1(c),l);for(let e=0;e<20;e++)c[e]^=a[e];const u=xows_hmac_sha1(i,l);return k=xows_bytes_to_b64(u),r+=",p="+xows_bytes_to_b64(c)}function xows_sasl_sha1_chk(e){const o=e.match(/(v)=(.+)/);return k===o[2]||(xows_log(0,"sasl_sha1_chk","SCRAM-SHA-1 integrity check failed","supplied server signature mismatches the computed one"),!1)}function xows_sasl_md5_req(){return""}function xows_sasl_md5_resp(e){let o,_,s,t,n,c,i=e.split(",");for(let e=0;e<i.length;++e)"realm"===(c=i[e].match(/([a-z]+)="?([^"]+)/))[1]&&(o=c[2]),"nonce"===c[1]&&(_=c[2]),"qop"===c[1]&&(s=c[2]),"host"===c[1]&&(t=c[2]),"rspauth"===c[1]&&(n=c[2]);if(void 0!==n)return"";const r=f.c,l=f.z;let a="xmpp/"+l.split("@")[1];void 0!==t&&(a+="/"+t);const u=xows_gen_nonce_asc(24);let d;if(h)d=xows_bytes_to_str(xows_hash_md5(r+":"+o+":"+h)),f.realm=o,f.y=d,h=null;else{if(f.realm!==o)return h=null,xows_log(0,"sasl_md5_resp","DIGEST-MD5 saved data error","Realm does not match"),"";d=f.y}const x="00000001";let w="charset=utf-8,";return w+='username="'+r+'",',w+='realm="'+o+'",',w+='nonce="'+_+'",',w+='cnonce="'+u+'",',w+="nc="+x+",",w+='digest-uri="'+a+'",',w+='response="'+xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_hex(xows_hash_md5(d+":"+_+":"+u+":"+l))+":"+_+":"+x+":"+u+":"+s+":"+xows_bytes_to_hex(xows_hash_md5("AUTHENTICATE:"+a))))+'",',w+="qop=auth"}function xows_sasl_md5_chk(e){return!0}const A=[{name:"SCRAM-SHA-1",req:xows_sasl_sha1_req,res:xows_sasl_sha1_resp,chk:xows_sasl_sha1_chk},{name:"DIGEST-MD5",req:xows_sasl_md5_req,res:xows_sasl_md5_resp,chk:xows_sasl_md5_chk},{name:"PLAIN",req:xows_sasl_plain_req,res:xows_sasl_plain_resp,chk:xows_sasl_plain_chk}];function xows_sasl_select(e){y=-1;for(let o=0;o<A.length;++o)if(e.includes(A[o].name))return y=o,A[o].name;return null}function xows_sasl_prepare(e,o,_,s){return y<0?(xows_log(1,"sasl_prepare","No SASL mechanism selected"),!1):(e?f=e:(f={mech:xows_sasl_get_mechanism(),z:xows_str_to_utf8(o),c:xows_str_to_utf8(_)},h=xows_str_to_utf8(s)),!0)}const E=0,q=32;let S=null,C=null,T=null,D=function(){},j=function(){},I=function(){};function xows_sck_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"open":D=o;break;case"recv":j=o;break;case"close":I=o}}function xows_sck_onerror(e){}function xows_sck_onclose(e){let o,_=E;if(1e3!==e.code)switch(_=q,e.code){case 1001:o="Going Away";break;case 1002:o="Protocol error";break;case 1003:o="Unsupported Data";break;case 1004:o="Reserved";break;case 1005:o="No Status Rcvd";break;case 1006:o="Abnormal Closure";break;case 1007:o="Invalid frame payload data";break;case 1008:o="Policy Violation";break;case 1009:o="Message Too Big";break;case 1010:o="Mandatory Ext.";break;case 1011:o="Internal Error";break;case 1012:o="Service Restart";break;case 1013:o="Try Again Later";break;case 1014:o="Bad Gateway";break;case 1015:o="TLS handshake";break;default:o="Unknow error ("+e.code+")"}else o="socket closed";xows_log(_?0:2,"sck_onclose",o),S=null,I(_,o)}function xows_sck_onopen(e){xows_log(2,"sck_onopen","socket connected"),D()}function xows_sck_onmesg(e){xows_log(3,"sck_recv",e.data,null,"#AB5655"),j(e.data)}function xows_sck_setup(e,o){xows_log(2,"sck_setup","setup new connection",e),C=e,T=o}function xows_sck_connect(){(S=new WebSocket(C,T)).onclose=xows_sck_onclose,S.onerror=xows_sck_onerror,S.onmessage=xows_sck_onmesg,S.onopen=xows_sck_onopen,xows_log(2,"sck_connect","socket connecting",C)}function xows_sck_close(){S&&(xows_log(2,"sck_close","closing connection"),S.close(),S=null)}function xows_sck_send(e){S.send(e),xows_log(3,"sck_send",e,null,"#55ABAB")}const N=64,M=128,L=256,B=512;let P=null;const R={bare:null,user:null,pass:null,save:!1,regi:!1};let O=null;const G={full:null,bare:null,node:null,resc:null};let U=!1,H=function(){};function xows_xmp_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"sessready":_e=o;break;case"sessclose":se=o;break;case"rostpush":je=o;break;case"presrecv":Je=o;break;case"pressubs":Ke=o;break;case"presfail":Xe=o;break;case"presmuco":We=o;break;case"msgrecv":we=o;break;case"msgchst":fe=o;break;case"msgrecp":qe=o;break;case"msgretr":Te=o;break;case"msgpubs":wo=o;break;case"mucsubj":pe=o;break;case"mucnoti":me=o;break;case"jingrecv":o_=o;break;case"error":H=o}}function xows_xmp_message_forge(e,o,_,s,t,n,c,i,r,l,a,u,d,x,w,p){return c||(c=(new Date).getTime()),{id:e,to:o,from:_,type:s,body:t,xoob:n,time:c,recp:i,retr:r,repl:l,rpid:a,rpto:u,orid:d,szid:x,ocid:w,page:p}}function xows_xmp_error_log(e,o,_){let s;const t=e.querySelector("error");if(t){const e=xows_xml_ns_select(t,ce);e&&(s=xows_xml_beatify_tag(e.tagName));const o=t.querySelector("text");o&&(s+=": "+xows_xml_innertext(o))}return xows_log(o,_,"query ("+e.getAttribute("id")+") error",s),s}function xows_xmp_error_parse(e){let o=null;const _=e.querySelector("error");if(_){o={},_.hasAttribute("code")&&(o.code=_.getAttribute("code")),_.hasAttribute("type")&&(o.type=_.getAttribute("type"));const e=xows_xml_ns_select(_,ce);o.name=e?e.tagName:"";const s=_.querySelector("text");o.text=s?xows_xml_innertext(s):""}return o}function xows_xmp_reset(e=!0){U=!1,P=null,O=null,xows_xmp_sm3_reset(),e&&(R.jbar=null,R.user=null,R.pass=null,R.save=!1,R.regi=!1),G.jbar=null,G.jful=null,G.node=null,G.resc=null}function xows_xmp_connect(e,o,_,s,t){xows_sck_close(),xows_xmp_reset(),xows_sck_set_callback("open",xows_xmp_sck_onopen),xows_sck_set_callback("recv",xows_xmp_sck_onrecv),xows_sck_set_callback("close",xows_xmp_sck_onclose),P=e;const n=o.split("@");if(O=null,void 0!==n[1]&&0!==n[1].length&&(O=n[1]),null===O)return xows_log(0,"xmp_connect","wrong JID format"),void xows_xmp_failure(M,"invalid username (JID domain missing)");R.jbar=o,R.user=n[0],R.pass=_,R.save=s,R.regi=t,xows_sck_setup(e,"xmpp"),xows_sck_connect()}let z=!1;function xows_xmp_resume(){xows_log(2,"xmp_resume","try reconnect"),xows_sck_close(),xows_sck_connect()}function xows_xmp_failure(e,o){xows_log(2,"xmp_failure","connection failure",o),U?(U=!1,z=!0):z||(xows_xmp_reset(),xows_xmp_fram_close_send()),se(e,o)}function xows_xmp_disconnect(){xows_log(2,"xmp_disconnect","user disconnect"),xows_xmp_reset(),z=!1,xows_xmp_fram_close_send(),se(0)}function xows_xmp_onuload(){S&&(U=!1,S.send("<presence xmlns='jabber:client' type='unavailable'/>"),S.send("<close xmlns='urn:ietf:params:xml:ns:xmpp-framing'/>"))}function xows_xmp_sck_onopen(){xows_xmp_fram_open_send()}function xows_xmp_sck_onclose(e,o){e&&(U?(xows_log(1,"xmp_sck_onclose","connection lost"),e|=B):(xows_log(1,"xmp_sck_onclose","connection failled"),e|=N),xows_xmp_failure(e,"unable to connect to remote server"))}const V="jabber:client";function xows_xmp_sck_onrecv(e){const o=xows_xml_parse(e).firstChild,_=o.tagName;return"a"===_?xows_xmp_sm3_a_recv(o):"r"===_?xows_xmp_sm3_r_recv(o):(xows_xmp_sm3_handle_recv(),"iq"===_?xows_xmp_iq_recv(o):"message"===_?xows_xmp_message_recv(o):"presence"===_?xows_xmp_presence_recv(o):"challenge"===_?xows_xmp_sasl_challenge_recv(o):"success"===_?xows_xmp_sasl_success_recv(o):"failure"===_?xows_xmp_sasl_failure_recv(o):"open"===_?xows_xmp_fram_open_recv(o):"close"===_?xows_xmp_fram_close_recv(o):"stream:error"===_?xows_xmp_stream_error_recv(o):"stream:features"===_?xows_xmp_stream_features_recv(o):"enabled"===_?xows_xmp_sm3_enabled_recv(o):"failed"===_?xows_xmp_sm3_failed_recv(o):"resumed"===_?xows_xmp_sm3_resumed_recv(o):void xows_log(1,"xmp_recv","unprocessed stanza",event.data))}const Y=[],J=new Map;function xows_xmp_send(e,o,_){"presence"!==e.tagName&&"message"!==e.tagName&&"iq"!==e.tagName||e.namespaceURI||e.setAttribute("xmlns",V);let s=e.getAttribute("id");if(s||(s=xows_gen_uuid(),e.setAttribute("id",s)),xows_isfunc(o)&&J.set(s,{onresult:o,onparse:_}),S&&U)xows_sck_send(xows_xml_serialize(e)),xows_xmp_sm3_handle_sent();else{xows_log(2,"xows_xmp_send","enqueue stanza");const o=(new Date).toISOString();xows_xml_parent(e,xows_xml_node("delay",{xmlns:ie,stamp:o})),Y.push(xows_xml_serialize(e))}}function xows_xmp_send_raw(e,o,_){if(S){if("iq"===e.tagName){e.namespaceURI||e.setAttribute("xmlns",V);let s=e.getAttribute("id");s||(s=xows_gen_uuid(),e.setAttribute("id",s)),xows_isfunc(o)&&J.set(s,{onresult:o,onparse:_})}xows_sck_send(xows_xml_serialize(e))}else xows_log(0,"xmp_send_raw","socket is closed")}function xows_xmp_flush(){if(S)for(xows_log(2,"xows_xmp_flush","flushing stanzas queue");Y.length;)xows_sck_send(Y.shift());else xows_log(0,"xmp_send_raw","socket is closed")}const K="urn:ietf:params:xml:ns:xmpp-framing";function xows_xmp_fram_open_recv(e){return"1.0"===e.getAttribute("version")&&e.namespaceURI===K||(xows_log(0,"xmp_fram_open_recv","invalid server framing"),xows_xmp_failure(N,"invalid server framing")),!0}function xows_xmp_fram_open_send(){xows_log(2,"xmp_fram_open_send","open stream"),xows_sck_send("<open to='"+O+"' version='1.0' xmlns='urn:ietf:params:xml:ns:xmpp-framing'/>")}function xows_xmp_fram_close_recv(e){return U?(xows_log(1,"xmp_fram_close_recv","unexpected stream close"),xows_xmp_failure(B,"the server closed the stream")):(xows_log(2,"xmp_fram_close_recv","stream closed"),xows_sck_close()),!0}function xows_xmp_fram_close_send(){S&&(xows_log(2,"xmp_fram_close_send","closes stream"),xows_sck_send("<close xmlns='urn:ietf:params:xml:ns:xmpp-framing'/>"))}const W="urn:xmpp:sm:3",X={id:null,max:null,hr:0,hs:0},$={s:0,r:0},Q={s:null,r:null};function xows_xmp_sm3_reset(){X.id=null,X.max=null,X.hr=0,X.hs=0,Q.r&&(clearTimeout(Q.r),Q.r=null),Q.s&&(clearTimeout(Q.s),Q.s=null),$.r=0,$.s=0}function xows_xmp_sm3_handle_recv(e){Q.r&&(clearTimeout(Q.r),Q.r=null),U&&X.id&&(X.hr++,e||$.r>=10?($.r=0,xows_sck_send("<a xmlns='urn:xmpp:sm:3' h='"+X.hr+"'/>")):($.r++,Q.r=setTimeout(xows_xmp_sm3_handle_sent,6e4,!0)))}function xows_xmp_sm3_handle_sent(e){Q.s&&(clearTimeout(Q.s),Q.s=null),U&&X.id&&(e||$.s>=10?($.s=0,xows_sck_send("<r xmlns='urn:xmpp:sm:3'/>")):($.s++,Q.s=setTimeout(xows_xmp_sm3_handle_sent,6e4,!0)))}function xows_xmp_sm3_enabled_recv(e){e.namespaceURI===W&&e.hasAttribute("resume")&&(X.id=e.getAttribute("id"),e.hasAttribute("max")&&(X.max=e.getAttribute("max")),xows_log(2,"xmp_sm3_enabled_recv","server enabled resume",X.id))}function xows_xmp_sm3_resumed_recv(e){U=!0,z=!1,xows_log(2,"xmp_sm3_resumed_recv","session resumed",parseInt(e.getAttribute("h"))),_e(G,!0)}function xows_xmp_sm3_failed_recv(e){z&&(xows_log(1,"xmp_sm3_failed_recv","session resume failed"),z=!1,xows_xmp_sm3_reset(),xows_xmp_bind_query())}function xows_xmp_sm3_a_recv(e){return Q.s&&(clearTimeout(Q.s),Q.s=null),$.s=0,X.hs=parseInt(e.getAttribute("h")),!0}function xows_xmp_sm3_r_recv(e){return Q.r&&(clearTimeout(Q.r),Q.r=null),$.r=0,xows_sck_send("<a xmlns='urn:xmpp:sm:3' h='"+X.hr+"'/>"),!0}function xows_xmp_sm3_enable_query(){xows_sck_send("<enable xmlns='urn:xmpp:sm:3' resume='true'/>")}function xows_xmp_sm3_resume_query(){xows_log(2,"xmp_sm3_resume_query","request stream resume"),xows_sck_send("<resume xmlns='urn:xmpp:sm:3' previd='"+X.id+"' h='"+X.hr+"'/>")}const Z="urn:ietf:params:xml:ns:xmpp-sasl",ee="urn:ietf:params:xml:ns:xmpp-bind",oe="urn:ietf:params:xml:ns:xmpp-streams";let _e=function(){},se=function(){};const te=[];function xows_xmp_stream_error_recv(e){return xows_log(0,"xmp_stream_error_recv",xows_xml_ns_select(e,oe).tagName),xows_xmp_failure(N,"the server reported stream error"),!0}function xows_xmp_stream_features_recv(e){const o=e.getElementsByTagName("mechanism");if(o.length){ne.length=0;for(let e=0;e<o.length;++e)ne.push(xows_xml_innertext(o[e]));if(xows_log(2,"xmp_stream_features_recv","received authentication mechanisms",ne.join(", ")),R.regi){e.querySelector("register")?xows_xmp_regi_get_query(null,xows_xmp_regi_server_get_parse):(xows_log(0,"xmp_stream_features_recv","registration not allowed"),xows_xmp_failure(L,"account registration is not allowed by the server"))}else xows_xmp_sasl_auth_send();return!0}te.length=0;for(let o=0;o<e.childNodes.length;++o)te.push(e.childNodes[o].namespaceURI);return xows_log(2,"xmp_stream_features_recv","received features",te.join(", ")),z&&X.id?xows_xmp_sm3_resume_query():xows_xmp_bind_query(),!1}const ne=[];function xows_xmp_sasl_auth_send(){const e=xows_sasl_select(ne);if(!e)return xows_log(0,"xmp_sasl_auth_send","no suitable SASL mechanism"),void xows_xmp_failure(N,"unable to find a suitable authentication mechanism");xows_log(2,"xmp_sasl_auth_send","select authentication mechanism",e);let o=null;if(!(R.pass||(o=xows_cach_auth_get())&&o.mech===e))return void xows_xmp_failure(N,"unable to find authentication data for automatic login");xows_sasl_prepare(o,R.jbar,R.user,R.pass);const _=xows_sasl_get_request();_&&(xows_log(2,"xmp_sasl_auth_send","sending authentication request",_),xows_xmp_send_raw(xows_xml_node("auth",{xmlns:Z,mechanism:e},btoa(_))))}function xows_xmp_sasl_challenge_recv(e){const o=atob(xows_xml_innertext(e));xows_log(2,"xmp_sasl_challenge_recv","received authentication challenge",o);const _=xows_sasl_get_response(o);return xows_log(2,"xmp_sasl_challenge_recv","sending challenge response",_),xows_xmp_send_raw(xows_xml_node("response",{xmlns:Z},btoa(_))),!0}function xows_xmp_sasl_failure_recv(e){const o=e.firstChild;let _;switch(o.tagName){case"not-authorized":_="wrong username or password";break;default:_=xows_l10n_get("authentication error")+" ("+o.tagName+")"}return xows_log(0,"xmp_sasl_failure_recv",o.tagName),setTimeout(xows_xmp_failure,1e3*Mn.login_fail_delay,M,_),!0}function xows_xmp_sasl_success_recv(e){const o=xows_xml_innertext(e);return 0!==o.length&&xows_log(2,"xmp_sasl_success_recv","received server proof signature",o),xows_sasl_chk_integrity(atob(o))?(xows_log(2,"xmp_sasl_success_recv","authentication success"),R.save&&xows_cach_auth_save(xows_sasl_get_data()),xows_xmp_fram_open_send(),!0):(xows_log(0,"xmp_sasl_success_recv","SASL integrity error"),xows_xmp_failure(N,"server integrity check failed"),!0)}function xows_xmp_bind_parse(e){if("error"===e.getAttribute("type"))return xows_xmp_error_log(e,0,"xmp_bind_parse"),void xows_xmp_failure(N,"resource bind error");const o=xows_xml_innertext(e.querySelector("jid"));G.jful=o,G.jbar=xows_jid_bare(o),G.node=xows_jid_node(o),G.resc=xows_jid_resc(o),xows_log(2,"xmp_bind_parse","resource bind",G.jful),U=!0;for(let e=0;e<te.length;++e)if(te[e]===W){xows_xmp_sm3_enable_query();break}_e(G,!1)}function xows_xmp_bind_query(e=null){xows_log(2,"xmp_bind_query","query bind resource",e||"from server");const o=xows_xml_node("bind",{xmlns:ee});e&&xows_xml_parent(o,xows_xml_node("resource",null,e)),xows_xmp_send_raw(xows_xml_node("iq",{type:"set"},o),xows_xmp_bind_parse)}const ce="urn:ietf:params:xml:ns:xmpp-stanzas";function xows_xmp_iq_recv(e){const o=e.getAttribute("id");if(J.has(o)){const _=J.get(o);return J.delete(o),xows_isfunc(_.onresult)&&_.onresult(e,_.onparse),!0}if("get"===e.getAttribute("type")){const o=e.firstChild;if(void 0!==o){const _=o.namespaceURI;if(_===$e)return xows_xmp_ping_reply(e);if(_===Qe)return xows_xmp_iq_time_reply(e);if(_===Ze)return xows_xmp_iq_version_reply(e);if(_===eo)return xows_xmp_disco_info_reply(e)}return!1}if("set"===e.getAttribute("type")){const o=e.firstChild;if(void 0!==o){const _=o.namespaceURI;if(_===De)return xows_xmp_rost_push_recv(e);if(_===Ho)return xows_xmp_jing_recv(e)}return!1}return!1}function xows_xmp_iq_unhandled(e,o,_){return"error"===o&&!xows_isfunc(_)&&(xows_xmp_error_log(e,1,"xmp_iq_unhandled"),H(e.getAttribute("from"),xows_xmp_error_parse(e)),!0)}function xows_xmp_iq_parse(e,o){const _=e.getAttribute("type");xows_xmp_iq_unhandled(e,_,o)||xows_isfunc(o)&&o(e.getAttribute("from"),_,xows_xmp_error_parse(e))}function xows_xmp_iq_error_send(e,o,_,s){xows_xmp_send(xows_xml_node("iq",{id:e,type:"error",to:o},xows_xml_node("error",{type:_},xows_xml_node(s,{xmlns:ce}))))}function xows_xmp_iq_result_send(e,o){xows_xmp_send(xows_xml_node("iq",{id:e,type:"result",to:o}))}const ie="urn:xmpp:delay",re="urn:xmpp:message-correct:0",le="urn:xmpp:reply:0",ae="urn:xmpp:sid:0",ue="urn:xmpp:occupant-id:0",de="urn:xmpp:styling:0",xe="jabber:x:oob";let we=function(){},pe=function(){},me=function(){};function xows_xmp_message_recv(e){const o=e.getAttribute("id"),_=e.getAttribute("from"),s=e.getAttribute("to"),t=e.getAttribute("type");if("error"===t)return we(xows_xmp_message_forge(o,s,_,t),xows_xmp_error_parse(e)),!0;let n,c,i,r,l,a,u,d,x,w;for(let p=0;p<e.childNodes.length;++p){const m=e.childNodes[p];if(1!==m.nodeType)continue;const g=m.tagName,f=m.namespaceURI;if(f===yo)return xows_xmp_mam_result_recv(m);if(f===ao)return xows_xmp_pubsub_recv(_,m);if(f===no){const e=m.querySelector("message");return!!e&&xows_xmp_message_recv(e)}if(f===Ee){if("request"===g){xows_xmp_message_receipt_send(_,o);continue}return qe(o,_,s,m.getAttribute("id")),!0}if(f===Se)return Te(o,_,t,m.getAttribute("id")),!0;if("subject"===g)return pe(o,_,xows_xml_innertext(m)),!0;if(f!==qo)if(f!==ge)if(f!==ie)if(f!==ue)if(f!==ae)if(f!==le)if(f!==re)if(f!==xe)"body"!==g||(c=xows_xml_innertext(m));else{i=xows_xml_innertext(m.querySelector("url"))}else l=m.getAttribute("id");else a=m.getAttribute("id"),m.hasAttribute("to")&&(u=m.getAttribute("to"));else"origin-id"===g&&(d=m.getAttribute("id")),"stanza-id"===g&&(x=m.getAttribute("id"));else w=m.getAttribute("id");else n=new Date(m.getAttribute("stamp")).getTime();else r=ke.get(g);else if("groupchat"===t){const e=m.querySelectorAll("status");if(e.length){const s=[];for(let o=0;o<e.length;++o)s.push(parseInt(e[o].getAttribute("code")));return me(o,_,s),!0}}}let p=!1;return c&&(we(xows_xmp_message_forge(o,s,_,t,c,i,n,null,null,l,a,u,d,x,w)),p=!0),void 0!==r&&(fe(o,_,t,r,w),p=!0),p||xows_log(1,"xmp_message_recv","unhandled message ("+_+")",t),p}function xows_xmp_message_body_send(e,o,_,s,t,n,c,i){const r=xows_gen_uuid(),l=xows_xml_node("message",{id:r,to:o,type:e},xows_xml_node("body",null,_));return i&&xows_xml_parent(l,xows_xml_node("x",{xmlns:xe},xows_xml_node("url",null,i))),xows_xml_parent(l,xows_xml_node("origin-id",{id:r,xmlns:ae})),t&&xows_xml_parent(l,xows_xml_node("replace",{id:t,xmlns:re})),n&&xows_xml_parent(l,xows_xml_node("reply",{id:n,to:c,xmlns:le})),s&&"chat"===e&&xows_xml_parent(l,xows_xml_node("request",{xmlns:Ee})),xows_xmp_send(l),r}const ge="http://jabber.org/protocol/chatstates";let fe=function(){};const he=0,be=1,ye=2,ve=3,Fe=4,ke=new Map([["gone",0],["active",1],["inactive",2],["paused",3],["composing",4]]),Ae=["gone","active","inactive","paused","composing"];function xows_xmp_message_chatstate_send(e,o,_){const s=Ae[_],t=xows_gen_uuid(),n=xows_xml_node("message",{id:t,to:e,type:o},xows_xml_node(s,{xmlns:ge}));xows_xml_parent(n,xows_xml_node("no-store",{xmlns:"urn:xmpp:hints"})),xows_xml_parent(n,xows_xml_node("origin-id",{id:t,xmlns:ae})),xows_xmp_send(n)}const Ee="urn:xmpp:receipts";let qe=function(){};function xows_xmp_message_receipt_send(e,o){xows_xmp_send(xows_xml_node("message",{to:e},xows_xml_node("received",{id:o,xmlns:Ee})))}const Se="urn:xmpp:message-retract:1",Ce="urn:xmpp:message-retract:1#tombstone";let Te=function(){};function xows_xmp_message_retract_send(e,o,_){const s=xows_gen_uuid(),t=xows_xml_node("message",{id:s,to:e,type:o},xows_xml_node("retract",{id:_,xmlns:Se}));xows_xml_parent(t,xows_xml_node("store",{xmlns:"urn:xmpp:hints"})),xows_xml_parent(t,xows_xml_node("origin-id",{id:s,xmlns:ae})),xows_xmp_send(t)}const De="jabber:iq:roster";let je=function(){};function xows_xmp_rost_push_recv(e){xows_xmp_send(xows_xml_node("iq",{id:e.getAttribute("id"),type:"result"},xows_xml_node("query",{xmlns:De})));const o=e.querySelector("item"),_=o.getAttribute("jid"),s=o.getAttribute("name"),t=Ye.get(o.getAttribute("subscription"));let n=o.querySelector("group");n=n?xows_xml_innertext(n):null,je(_,s,t,n)}function xows_xmp_rost_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=[];if("error"===_)xows_xmp_error_log(e,1,"xmp_rost_get_parse"),s=xows_xmp_error_parse(e);else{const o=e.getElementsByTagName("item");for(let e=0;e<o.length;++e)t.push({jid:o[e].getAttribute("jid"),name:o[e].getAttribute("name"),subs:Ye.get(o[e].getAttribute("subscription")),group:xows_xml_innertext(o[e].querySelector("group"))})}o(t,s)}function xows_xmp_rost_get_query(e){xows_xmp_send(xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:De})),xows_xmp_rost_get_parse,e)}function xows_xmp_rost_set_query(e,o,_,s){const t=xows_xml_node("item",{jid:e});o?(t.setAttribute("name",o),_&&xows_xml_parent(t,xows_xml_node("group",null,_))):t.setAttribute("subscription","remove"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("query",{xmlns:De},t)),xows_xmp_iq_parse,s)}const Ie=0,Ne=1,Me=2,Le=3,Be=4,Pe=5,Re=new Map([["dnd",1],["xa",2],["away",3],["chat",5]]),Oe=new Map([[1,"dnd"],[2,"xa"],[3,"away"],[4,null],[5,"chat"]]),Ge=-1,Ue=0,He=1,ze=2,Ve=3,Ye=new Map([["remove",-1],["none",0],["from",1],["to",2],["both",3]]);let Je=function(){},Ke=function(){},We=function(){},Xe=function(){};function xows_xmp_presence_recv(e){const o=e.getAttribute("from");let _=Be,s=0;if(e.hasAttribute("type")){const s=e.getAttribute("type");switch(s){case"unavailable":_=Ie;break;case"subscribe":case"unsubscribe":case"subscribed":case"unsubscribed":{const _=e.querySelector("nick"),t=_?xows_xml_innertext(_):null;Ke(o,s,t)}return!0;case"error":{const _=xows_xmp_error_parse(e);xows_log(1,"xmp_presence_recv","error",o+" - "+_.type),Xe(o,_)}return!0}}let t,n,c,i,r=null;for(let o=0;o<e.childNodes.length;++o){const l=e.childNodes[o];if(1!==l.nodeType)continue;const a=l.tagName,u=l.namespaceURI;switch(a){case"show":{const e=xows_xml_innertext(l);_=e?Re.get(e):Be;continue}case"priority":s=parseInt(xows_xml_innertext(l));continue;case"status":t=xows_xml_innertext(l);continue}switch(u){case io:{const e=l.querySelector("photo");e&&(r=xows_xml_innertext(e))}continue;case __:n={node:l.getAttribute("node"),ver:l.getAttribute("ver")};continue;case ue:c=l.getAttribute("id");continue;case qo:{const e=l.querySelector("item");i={affi:Go.get(e.getAttribute("affiliation")),role:No.get(e.getAttribute("role")),jful:e.getAttribute("jid"),nick:e.getAttribute("nick"),code:[]};const o=l.querySelectorAll("status");for(let e=0;e<o.length;++e)i.code.push(parseInt(o[e].getAttribute("code")));if(l.querySelector("destroy")){const e=l.querySelector("reason");i.destroy=e?xows_xml_innertext(e):"Unspecified reason"}}continue}}return void 0!==i?We(o,_,t,i,c,r):Je(o,_,s,t,n,r),!0}function xows_xmp_presence_send(e,o,s,t,n,c,i){const r=xows_xml_node("presence");if(e&&r.setAttribute("to",e),o&&r.setAttribute("type",o),s>Ie&&(s!==Be&&xows_xml_parent(r,xows_xml_node("show",null,Oe.get(s))),xows_xml_parent(r,xows_xml_node("priority",null,20*s)),"string"==typeof i&&xows_xml_parent(r,xows_xml_node("x",{xmlns:io},xows_xml_node("photo",null,i))),xows_xml_parent(r,xows_xml_node("c",{xmlns:__,hash:"sha-1",node:_,ver:xows_xmp_caps_self_verif()}))),"string"==typeof t&&xows_xml_parent(r,xows_xml_node("status",null,t)),n&&xows_xml_parent(r,xows_xml_node("nick",{xmlns:fo},n)),c){const e=xows_xml_node("x",{xmlns:Eo});c.pass&&xows_xml_parent(e,xows_xml_node("password",null,c.pass)),xows_xml_parent(r,e)}xows_xmp_send(r)}const $e="urn:xmpp:ping";function xows_xmp_ping_reply(e){const o=e.getAttribute("from");xows_xmp_send(xows_xml_node("iq",{id:e.getAttribute("id"),to:o,type:"result"}))}const Qe="urn:xmpp:time";function xows_xmp_iq_time_reply(e){const o=e.getAttribute("from"),_=e.getAttribute("id"),s=new Date;let t=s.getTimezoneOffset()/60,n=t<0?"-":"";n+=((t=Math.abs(t))>9?t:"0"+t)+":00";const c=s.toJSON();xows_xmp_send(xows_xml_node("iq",{to:o,id:_,type:"result"},xows_xml_node("time",{xmlns:Qe},[xows_xml_node("tzo",null,n),xows_xml_node("utc",null,c)])))}const Ze="jabber:iq:version";function xows_xmp_iq_version_reply(_){xows_xmp_send(xows_xml_node("iq",{to:_.getAttribute("from"),id:_.getAttribute("id"),type:"result"},xows_xml_node("query",{xmlns:Ze},[xows_xml_node("name",null,e),xows_xml_node("version",null,o)])))}const eo="http://jabber.org/protocol/disco#info",oo="http://jabber.org/protocol/disco#items";function xows_xmp_disco_info_reply(e){const o=e.getAttribute("from"),_=e.getAttribute("id"),s=e.querySelector("query"),t=s?s.getAttribute("node"):null,n=xows_xmp_caps_self_features();xows_xmp_send(xows_xml_node("iq",{to:o,id:_,type:"result"},xows_xml_node("query",{xmlns:eo,node:t},n)))}function xows_xmp_disco_info_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null,n=null;const c=[],i=[];if("error"===_)xows_xmp_error_log(e,1,"xmp_disco_info_parse"),s=xows_xmp_error_parse(e);else{const o=e.querySelector("query");t=o.getAttribute("node");const _=o.querySelectorAll("identity");for(let e=0;e<_.length;++e)c.push({category:_[e].getAttribute("category"),type:_[e].getAttribute("type"),name:_[e].getAttribute("name")});const s=o.querySelectorAll("feature");for(let e=0;e<s.length;++e)s[e].hasAttribute("var")&&i.push(s[e].getAttribute("var"));const r=o.querySelector("x");n=r?xows_xmp_xdata_parse(r):null}o(e.getAttribute("from"),t,c,i,n,s)}function xows_xmp_disco_info_query(e,o,_){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("query",{xmlns:eo,node:o})),xows_xmp_disco_info_parse,_)}function xows_xmp_disco_items_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s;const t=[];if("error"===_)xows_xmp_error_log(e,1,"xmp_disco_items_parse"),s=xows_xmp_error_parse(e);else{const o=e.getElementsByTagName("item");for(let e=0;e<o.length;++e)t.push({jid:o[e].getAttribute("jid"),name:o[e].getAttribute("name")})}o(e.getAttribute("from"),t,s)}function xows_xmp_disco_items_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("query",{xmlns:oo})),xows_xmp_disco_items_parse,o)}const _o="urn:xmpp:extdisco:2";function xows_xmp_extdisco_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;const s=[];let t;if("error"===_)xows_xmp_error_log(e,1,"xmp_extdisco_parse"),t=xows_xmp_error_parse(e);else{const o=e.querySelectorAll("service");for(let e=0;e<o.length;++e)s.push({type:o[e].getAttribute("type"),host:o[e].getAttribute("host"),port:o[e].getAttribute("port"),transport:o[e].getAttribute("transport"),username:o[e].getAttribute("username"),password:o[e].getAttribute("password"),restricted:o[e].getAttribute("restricted")})}o(e.getAttribute("from"),s,t)}function xows_xmp_extdisco_query(e,o,_){const s=xows_xml_node("services",{xmlns:_o});o&&s.setAttribute("type",o),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},s),xows_xmp_extdisco_parse,_)}const so="jabber:x:data";function xows_xmp_xdata_parse(e){const o=[],_=e.getElementsByTagName("field");for(let e=0;e<_.length;++e){const s={required:null!==_[e].querySelector("required"),type:_[e].getAttribute("type"),label:_[e].getAttribute("label"),var:_[e].getAttribute("var")},t=_[e].querySelector(":scope > desc");t&&(s.desc=xows_xml_innertext(t));const n=_[e].querySelectorAll(":scope > value");if(n.length){s.value=[];for(let e=0;e<n.length;++e)s.value.push(xows_xml_innertext(n[e]))}const c=_[e].querySelectorAll(":scope > option");if(c.length){s.option=[];for(let e=0;e<c.length;++e)s.option.push({label:c[e].getAttribute("label"),value:xows_xml_innertext(c[e].querySelector(":scope > value"))})}o.push(s)}return o}function xows_xmp_xdata_make(e){const o=xows_xml_node("x",{xmlns:so,type:"submit"});if(e&&e.length){let _;for(let s=0;s<e.length;++s){if(_=xows_xml_node("field"),e[s].var&&_.setAttribute("var",e[s].var),e[s].type&&_.setAttribute("type",e[s].type),e[s].value){const o=e[s].value;for(let e=0;e<o.length;++e)xows_xml_parent(_,xows_xml_node("value",null,o[e]))}xows_xml_parent(o,_)}}return o}function xows_xmp_xdata_cancel(){return xows_xml_node("x",{xmlns:so,type:"cancel"})}const to="jabber:iq:register";function xows_xmp_regi_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null,n=null;if("error"===_)xows_xmp_error_log(e,1,"xmp_regi_get_parse"),s=xows_xmp_error_parse(e);else{const o=e.querySelector("username"),_=e.querySelector("password"),s=e.querySelector("email");t={registered:!!e.querySelector("registered"),username:o?xows_xml_innertext(o):null,password:_?xows_xml_innertext(_):null,email:s?xows_xml_innertext(s):null};const c=e.querySelector("x");c&&(n=xows_xmp_xdata_parse(c))}o(e.getAttribute("from"),t,n,s)}function xows_xmp_regi_get_query(e,o){const _=xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:to}));null!==e&&_.setAttribute("to",e),xows_xmp_send_raw(_,xows_xmp_regi_get_parse,o)}function xows_xmp_regi_set_query(e,o,_,s){const t=xows_xml_node("query",{xmlns:to});null!==o&&(null!==o.username&&xows_xml_parent(t,xows_xml_node("username",null,o.username)),null!==o.password&&xows_xml_parent(t,xows_xml_node("password",null,o.password)),null!==o.email&&xows_xml_parent(t,xows_xml_node("email",null,o.email))),null!==_&&xows_xml_parent(t,xows_xmp_xdata_make(_));const n=xows_xml_node("iq",{type:"set"},t);null!==e&&n.setAttribute("to",e),xows_xmp_send_raw(n,xows_xmp_iq_parse,s)}function xows_xmp_regi_server_set_parse(e,o,_){if("error"===o){xows_log(0,"xmp_regi_server_set_parse",_.name);let e=null;e="409"===_.code||"conflict"===_.name?"unsername already exists":"406"===_.code||"not-acceptable"===_.name?"username contains illegal characters":xows_l10n_get("unable to register")+" ("+_.name+")",setTimeout(xows_xmp_failure,1e3*Mn.login_fail_delay,L,e)}else xows_log(2,"xmp_regi_server_set_parse","success"),R.regi=!1,xows_xmp_sasl_auth_send()}function xows_xmp_regi_server_get_parse(e,o,_,s){if(_)for(let e=0;e<_.length;++e)"username"===_[e].var&&(_[e].value=[R.user]),"password"===_[e].var&&(_[e].value=[R.pass]);else null!==o.username&&(o.username=R.user),null!==o.password&&(o.password=R.pass);xows_xmp_regi_set_query(null,o,_,xows_xmp_regi_server_set_parse)}function xows_xmp_regi_pass_set_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null;if("error"===_){xows_xmp_error_log(e,1,"xmp_regi_pass_set_parse"),s=xows_xmp_error_parse(e);const o=e.querySelector("x");o&&(t=xows_xmp_xdata_parse(o))}o(_,t,s)}function xows_xmp_regi_pass_set_query(e,o,_){const s=xows_xml_node("query",{xmlns:to});e&&(xows_xml_parent(s,xows_xml_node("username",null,R.user)),xows_xml_parent(s,xows_xml_node("password",null,e))),null!==o&&xows_xml_parent(s,xows_xmp_xdata_make(o)),xows_xmp_send(xows_xml_node("iq",{type:"set"},s),xows_xmp_regi_pass_set_parse,_)}function xows_xmp_regi_remove_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null;if("error"===_){xows_xmp_error_log(e,1,"xmp_regi_remove_parse"),s=xows_xmp_error_parse(e);const o=e.querySelector("x");o&&(t=xows_xmp_xdata_parse(o))}o(_,t,s)}function xows_xmp_regi_remove_query(e,o,_){const s=xows_xml_node("query",{xmlns:to});xows_xml_parent(s,o?xows_xmp_xdata_make(o):xows_xml_node("remove"));const t={type:"set"};e&&(t.to=e),xows_xmp_send(xows_xml_node("iq",t,s),xows_xmp_regi_remove_parse,_)}const no="urn:xmpp:carbons:2";function xows_xmp_carbons_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node(e?"enable":"disable",{xmlns:no})),xows_xmp_iq_parse,o)}const co="vcard-temp",io="vcard-temp:x:update";function xows_xmp_vcardt_set_query(e,o){const _=[];for(let o=0;o<e.children.length;++o)_.push(e.children[o]);xows_xmp_send(xows_xml_node("iq",{type:"set",to:G.jbar},xows_xml_node("vCard",{xmlns:co},_)),xows_xmp_iq_parse,o)}function xows_xmp_vcardt_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null;"error"===_?(xows_xmp_error_log(e,1,"xmp_vcardt_get_parse"),s=xows_xmp_error_parse(e)):t=e.querySelector("vCard"),o(e.getAttribute("from"),t,s)}function xows_xmp_vcardt_get_query(e,o){const _=xows_xml_node("iq",{type:"get"},xows_xml_node("vCard",{xmlns:co}));null!==e&&_.setAttribute("to",e),xows_xmp_send(_,xows_xmp_vcardt_get_parse,o)}const ro="urn:xmpp:pep-vcard-conversion:0",lo="http://jabber.org/protocol/pubsub",ao="http://jabber.org/protocol/pubsub#event",uo="http://jabber.org/protocol/pubsub#owner",xo="http://jabber.org/protocol/pubsub#publish-options";let wo=function(){};function xows_xmp_pubsub_recv(e,o){const _=o.querySelector("items");if(!_)return!1;const s=[],t=_.querySelectorAll("item");for(let e=0;e<t.length;++e)s.push({id:t[e].getAttribute("id"),child:t[e].firstChild});const n=[],c=_.querySelectorAll("retract");for(let e=0;e<c.length;++e)n.push({id:c[e].getAttribute("id")});return wo(e,_.getAttribute("node"),s,n),!0}function xows_xmp_pubsub_publish(e,o,_,s){const t=[o];_&&t.push(xows_xml_node("publish-options",{node:e},xows_xmp_xdata_make([{var:"FORM_TYPE",type:"hidden",value:[xo]},{var:"pubsub#access_model",value:[_]},{var:"pubsub#persist_items",value:["true"]}]))),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:lo},t)),xows_xmp_iq_parse,s)}function xows_xmp_pubsub_conf_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null,n=null;"error"===_?(xows_xmp_error_log(e,1,"xmp_pubsub_conf_get_parse"),s=xows_xmp_error_parse(e)):(t=e.querySelector("configure").getAttribute("node"),n=xows_xmp_xdata_parse(e.querySelector("x"))),o(e.getAttribute("from"),t,n,s)}function xows_xmp_pubsub_conf_get_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"get"},xows_xml_node("pubsub",{xmlns:uo},xows_xml_node("configure",{node:e}))),xows_xmp_pubsub_conf_get_parse,o)}function xows_xmp_pubsub_conf_set_query(e,o,_){const s=xows_xmp_xdata_make(o);xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:uo},xows_xml_node("configure",{node:e},s))),xows_xmp_iq_parse,_)}function xows_xmp_pubsub_conf_set_cancel(e,o){const _=xows_xmp_xdata_cancel();xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:uo},xows_xml_node("configure",{node:e},_))),xows_xmp_iq_parse,o)}function xows_xmp_pubsub_retract(e,o,_){const s=xows_xml_node("item",{id:o});xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:lo},xows_xml_node("retract",{node:e,notify:"true"},s))),xows_xmp_iq_parse,_)}const po="urn:xmpp:bookmarks:1";function xows_xmp_bookmark_publish(e,o,_,s,t){const n=xows_xml_node("conference",{xmlns:po,name:o,autojoin:_});s&&xows_xml_parent(n,xows_xml_node("nick",null,s));const c=xows_xml_node("publish",{node:po},xows_xml_node("item",{id:e},n));xows_xmp_pubsub_publish(po,c,"whitelist",t)}function xows_xmp_bookmark_retract(e,o){xows_xmp_pubsub_retract(po,e,o)}function xows_xmp_bookmark_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s;const t=[];if("error"===_)xows_xmp_error_log(e,1,"xmp_nick_get_parse"),s=xows_xmp_error_parse(e);else{const o=e.querySelectorAll("item");for(let e=0;e<o.length;++e)t.push({id:o[e].getAttribute("id"),child:o[e].firstChild})}o(e.getAttribute("from"),t,[],s)}function xows_xmp_bookmark_get_query(e){xows_xmp_send(xows_xml_node("iq",{type:"get"},xows_xml_node("pubsub",{xmlns:lo},xows_xml_node("items",{node:po}))),xows_xmp_bookmark_get_parse,e)}const mo="urn:xmpp:vcard4",go="urn:ietf:params:xml:ns:vcard-4.0";function xows_xmp_vcard4_publish(e,o,_){const s=xows_xml_node("publish",{node:mo},xows_xml_node("item",null,xows_xml_node("vcard",{xmlns:go},e)));xows_xmp_pubsub_publish(mo,s,o,_)}function xows_xmp_vcard4_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null;"error"===_?(xows_xmp_error_log(e,1,"xmp_vcard4_get_parse"),s=xows_xmp_error_parse(e)):t=e.querySelector("vcard"),o(e.getAttribute("from"),t,s)}function xows_xmp_vcard4_get_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("vcard",{xmlns:go})),xows_xmp_vcard4_get_parse,o)}const fo="http://jabber.org/protocol/nick";function xows_xmp_nick_publish(e,o){const _=xows_xml_node("publish",{node:fo},xows_xml_node("item",null,xows_xml_node("nick",{xmlns:fo},e)));xows_xmp_pubsub_publish(fo,_,null,o)}function xows_xmp_nick_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null;"error"===_?(xows_xmp_error_log(e,1,"xmp_nick_get_parse"),s=xows_xmp_error_parse(e)):t=e.querySelector("nick"),o(e.getAttribute("from"),t,s)}function xows_xmp_nick_get_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:lo},xows_xml_node("items",{node:fo}))),xows_xmp_nick_get_parse,o)}const ho="urn:xmpp:avatar:data",bo="urn:xmpp:avatar:metadata";function xows_xmp_avat_data_publish(e,o,_){const s=xows_xml_node("publish",{node:ho},xows_xml_node("item",{id:e},xows_xml_node("data",{xmlns:ho},o)));xows_xmp_pubsub_publish(ho,s,null,_)}function xows_xmp_avat_meta_publish(e,o,_,s,t,n){let c;if(e){const n=xows_xml_node("info",{id:e,type:o,bytes:_,width:s,height:t});c=xows_xml_node("publish",{node:bo},xows_xml_node("item",{id:e},xows_xml_node("metadata",{xmlns:bo},n)))}else c=xows_xml_node("publish",{node:bo},xows_xml_node("item",null,xows_xml_node("metadata",{xmlns:bo})));xows_xmp_pubsub_publish(bo,c,null,n)}function xows_xmp_avat_data_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null,n=null;if("error"===_)xows_xmp_error_log(e,1,"xmp_avat_data_get_parse"),s=xows_xmp_error_parse(e);else{const o=e.querySelector("item");o&&(t=o.getAttribute("id"),n=xows_xml_innertext(o.querySelector("data")))}o(e.getAttribute("from"),t,n,s)}function xows_xmp_avat_data_get_query(e,o,_){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:lo},xows_xml_node("items",{node:ho},xows_xml_node("item",{id:o})))),xows_xmp_avat_data_get_parse,_)}function xows_xmp_avat_meta_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null;"error"===_?(xows_xmp_error_log(e,1,"xmp_avat_meta_get_parse"),s=xows_xmp_error_parse(e)):t=e.querySelector("metadata"),o(e.getAttribute("from"),t,s)}function xows_xmp_avat_meta_get_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:lo},xows_xml_node("items",{node:bo}))),xows_xmp_avat_meta_get_parse,o)}const yo="urn:xmpp:mam:2",vo="http://jabber.org/protocol/rsm",Fo=new Map,ko=new Map;function xows_xmp_mam_result_recv(e){const o=e.getAttribute("id"),_=e.getAttribute("queryid");if(!Fo.has(_))return void xows_log(1,"xmp_recv_mam_result","unknown queryid for MAM result",_);const s=e.querySelector("forwarded");if(!s)return!1;const t=s.querySelector("message");if(!t)return!1;const n=t.getAttribute("id"),c=t.getAttribute("type"),i=t.getAttribute("from"),r=t.getAttribute("to");let l,a,u,d,x,w,p,m,g,f;for(let e=0;e<t.childNodes.length;++e){const o=t.childNodes[e];if(1!==o.nodeType)continue;const _=o.namespaceURI,s=o.tagName;if(_!==ge)if(_!==Ee)if(_!==Se)if(_!==re)if(_!==le)if(_!==ae)if(_!==ue)if(_!==xe)"body"===s&&(l=o.hasChildNodes()?xows_xml_innertext(o):"");else{a=xows_xml_innertext(o.querySelector("url"))}else f=o.getAttribute("id");else"origin-id"===s&&(m=o.getAttribute("id")),"stanza-id"===s&&(g=o.getAttribute("id"));else w=o.getAttribute("id"),o.hasAttribute("to")&&(p=o.getAttribute("to"));else d=o.getAttribute("id");else x=o.getAttribute("id");else u=o.getAttribute("id")}let h=null;const b=s.querySelector("delay");return b&&(h=new Date(b.getAttribute("stamp")).getTime()),x&&(l=null),g||(g=o),Fo.get(_).push(xows_xmp_message_forge(n,r,i,c,l,a,h,u,x,d,w,p,m,g,f,o)),xows_log(2,"xmp_recv_mam_result","Adding archived message to result stack","from "+i),!0}function xows_xmp_mam_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;if("error"===_)return void xows_xmp_error_log(e,1,"xmp_mam_parse");const s=e.getAttribute("id");if(!ko.has(s))return void xows_log(1,"xmp_mam_parse","MAM query id not found",s);const t=ko.get(s);if(ko.delete(s),!Fo.has(t.qid))return void xows_log(1,"xmp_mam_parse","MAM result queryid not found",t.qid);const n=Fo.get(t.qid);Fo.delete(t.qid);const c=e.querySelector("fin");if(c){let e,_,s,i,r=0;if(i="true"===c.getAttribute("complete"),(e=c.querySelector("count"))&&(r=parseInt(xows_xml_innertext(e))),!(e=c.querySelector("first")))return xows_log(2,"xmp_mam_parse","No result received"),void o(t.to,t.jid,[],r,i);_=xows_xml_innertext(e),(e=c.querySelector("last"))&&(s=xows_xml_innertext(e));let l,a=0;const u=n.length;for(;a<u&&n[a].page!==_;a++);if(a>=u)xows_log(0,"xmp_mam_parse","first result page not found in stack",_),l=[];else{const e=a;let o=0;do{if(a===u){xows_log(1,"xmp_mam_parse","last result page not found (reached end of stack)",s);break}o++}while(n[a++].page!==s);l=n.splice(e,o)}xows_log(2,"xmp_mam_parse","results collected","("+l.length+"/"+r+") '"+_+"'=>'"+s+"'"),o(t.to,t.jid,l,r,i)}}function xows_xmp_mam_query(e,o,_,s,t,n,c){const i=[];i.push({var:"FORM_TYPE",type:"hidden",value:[yo]}),_&&i.push({var:"with",value:[_]}),s&&i.push({var:"start",value:[new Date(s).toJSON()]}),t&&i.push({var:"end",value:[new Date(t).toJSON()]});const r=xows_xml_node("set",{xmlns:vo},xows_xml_node("max",null,o));!n&&s||xows_xml_parent(r,xows_xml_node("before",null,n));const l=xows_gen_nonce_asc(12);Fo.set(l,[]);const a=xows_gen_uuid(),u=xows_xml_node("iq",{id:a,type:"set"},xows_xml_node("query",{xmlns:yo,queryid:l},[xows_xmp_xdata_make(i),r]));null!==e&&u.setAttribute("to",e),ko.set(a,{to:e,jid:_,qid:l}),xows_log(2,"xmp_mam_query","send Archive query","with "+_+" start "+s+" end "+t),xows_xmp_send(u,xows_xmp_mam_parse,c)}const Ao="urn:xmpp:http:upload:0";function xows_xmp_upld_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;const s=e.getAttribute("id");let t,n=null,c=[],i=null;if("error"===_){xows_xmp_error_log(e,1,"xmp_upld_parse"),t=xows_xmp_error_parse(e);const o=xows_xml_ns_select(e,Ao);o&&(t.upld=o.tagName)}else{i=e.querySelector("put").getAttribute("url"),n=e.querySelector("get").getAttribute("url");const o=e.querySelectorAll("header");if(o.length)for(let e=0;e<o.length;++e)c.push({name:o[e].getAttribute("name"),data:xows_xml_innertext(o[e])})}o(s,i,c,n,t)}function xows_xmp_upld_query(e,o,_,s,t,n){let c={xmlns:Ao,filename:_,size:s};t&&(c.type=t),xows_xmp_send(xows_xml_node("iq",{id:o,to:e,type:"get"},xows_xml_node("request",c)),xows_xmp_upld_parse,n)}const Eo="http://jabber.org/protocol/muc",qo="http://jabber.org/protocol/muc#user",So="http://jabber.org/protocol/muc#owner",Co="http://jabber.org/protocol/muc#admin",To=0,Do=1,jo=2,Io=3,No=new Map([["none",0],["visitor",1],["participant",2],["moderator",3]]),Mo=new Map([[0,"none"],[1,"visitor"],[2,"participant"],[3,"moderator"]]),Lo=-1,Bo=0,Po=1,Ro=2,Oo=3,Go=new Map([["outcast",-1],["none",0],["member",1],["admin",2],["owner",3]]),Uo=new Map([[-1,"outcast"],[0,"none"],[1,"member"],[2,"admin"],[3,"owner"]]);function xows_xmp_muc_cfg_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null;"error"===_?(xows_xmp_error_log(e,1,"xmp_muc_cfg_get_parse"),s=xows_xmp_error_parse(e)):t=xows_xmp_xdata_parse(e.querySelector("x")),o(e.getAttribute("from"),t,s)}function xows_xmp_muc_cfg_get_guery(e,o){xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("query",{xmlns:So})),xows_xmp_muc_cfg_get_parse,o)}function xows_xmp_muc_cfg_set_cancel(e,o){const _=xows_xmp_xdata_cancel();xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:So},_)),xows_xmp_iq_parse,o)}function xows_xmp_muc_cfg_set_query(e,o,_){const s=xows_xmp_xdata_make(o);xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:So},s)),xows_xmp_iq_parse,_)}function xows_xmp_muc_destroy_query(e,o,_,s,t){const n=xows_xml_node("destroy",null,null);o&&n.setAttribute("jid",o),_&&xows_xml_parent(n,xows_xml_node("password",null,_)),s&&xows_xml_parent(n,xows_xml_node("reason",null,s)),xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:So},n)),xows_xmp_iq_parse,t)}function xows_xmp_muc_affi_set_query(e,o,_){const s=xows_xml_node("query",{xmlns:Co}),t=o.reason?xows_xml_node("reason",null,o.reason):null;xows_xml_parent(s,xows_xml_node("item",{jid:o.jid,affiliation:Uo.get(o.affi)},t)),xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},s),xows_xmp_iq_parse,_)}function xows_xmp_muc_affi_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=[];if("error"===_)xows_xmp_error_log(e,1,"xmp_muc_affi_get_parse"),s=xows_xmp_error_parse(e);else{const o=e.querySelector("query").childNodes;for(let e=0;e<o.length;++e)t.push({affi:Go.get(o[e].getAttribute("affiliation")),jid:o[e].getAttribute("jid"),nick:o[e].getAttribute("nick")})}o(e.getAttribute("from"),t,s)}function xows_xmp_muc_affi_get_query(e,o,_){xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("query",{xmlns:Co},xows_xml_node("item",{affiliation:o}))),xows_xmp_muc_affi_get_parse,_)}function xows_xmp_muc_subject_send(e,o){const _=xows_gen_uuid();return xows_xmp_send(xows_xml_node("message",{id:_,to:e,type:"groupchat"},xows_xml_node("subject",null,xows_xml_escape(o)))),_}function xows_xmp_muc_role_set_query(e,o,_){const s=xows_xml_node("query",{xmlns:Co}),t=o.reason?xows_xml_node("reason",null,o.reason):null;xows_xml_parent(s,xows_xml_node("item",{nick:o.nick,role:Mo.get(o.role)},t)),xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},s),xows_xmp_iq_parse,_)}function xows_xmp_muc_role_get_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=[];if("error"===_)xows_xmp_error_log(e,1,"xmp_muc_role_get_parse"),s=xows_xmp_error_parse(e);else{const o=e.querySelector("query").childNodes;for(let e=0;e<o.length;++e)t.push({role:No.get(o[e].getAttribute("role")),nick:o[e].getAttribute("nick")})}o(e.getAttribute("from"),t,s)}function xows_xmp_muc_role_get_query(e,o,_){xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("query",{xmlns:Co},xows_xml_node("item",{role:o}))),xows_xmp_muc_role_get_parse,_)}function xows_xmp_muc_nick_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s,t=null;if("error"===_)xows_xmp_error_log(e,1,"xmp_muc_nick_parse"),s=xows_xmp_error_parse(e);else{const o=e.querySelector("identity");t=o?o.getAttribute("name"):null}o(e.getAttribute("from"),t,s)}function xows_xmp_muc_nick_query(e,o){xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("query",{xmlns:eo,node:"x-roomuser-item"})),xows_xmp_muc_nick_parse,o)}const Ho="urn:xmpp:jingle:1",zo="urn:xmpp:jingle:errors:1",Vo="urn:xmpp:jingle:apps:rtp:1",Yo="urn:xmpp:jingle:apps:rtp:audio",Jo="urn:xmpp:jingle:apps:rtp:video",Ko="urn:xmpp:jingle:transports:ice-udp:1",Wo="urn:xmpp:jingle:apps:rtp:rtcp-fb:0",Xo="urn:xmpp:jingle:apps:rtp:rtp-hdrext:0",$o="urn:xmpp:jingle:apps:dtls:0",Qo="urn:xmpp:jingle:apps:grouping:0",Zo="urn:xmpp:jingle:apps:rtp:ssma:0",e_="urn:xmpp:jingle:apps:rtp:info:1";let o_=function(){};function xows_xmp_jing_jingle2sdp(e){const o=e.querySelectorAll("description");for(let e=0;e<o.length;++e)if(o[e].namespaceURI!==Vo)return null;let _="v=0\r\no=- "+Math.round(Date.now()/1)+" 0 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\n";const s=e.querySelector("group");if(s){_+="a=group:"+s.getAttribute("semantics");const e=s.querySelectorAll("content");for(let o=0;o<e.length;++o)_+=" "+e[o].getAttribute("name");_+="\r\n"}const t=e.querySelectorAll(":scope > content");for(let e=0;e<t.length;++e){const o=t[e].querySelector("description"),s=t[e].querySelector("transport"),n=s.querySelectorAll("fingerprint");_+="m="+o.getAttribute("media"),_+=n.length?" 1 RTP/SAVPF":" RTP/AVPF";const c=o.querySelectorAll("payload-type");for(let e=0;e<c.length;++e)_+=" "+c[e].getAttribute("id");switch(_+="\r\n",_+="c=IN IP4 0.0.0.0\r\n",s.getAttribute("senders")){case"both":_+="a=sendrecv";break;case"initiator":_+="a=sendonly";break;case"responder":_+="a=recvonly";break;case"none":_+="a=inactive"}_+="\r\n",_+="a=mid:"+t[e].getAttribute("name")+"\r\n",s.hasAttribute("ufrag")&&(_+="a=ice-ufrag:"+s.getAttribute("ufrag")+"\r\n"),s.hasAttribute("pwd")&&(_+="a=ice-pwd:"+s.getAttribute("pwd")+"\r\n");const i=s.querySelectorAll("fingerprint");for(let e=0;e<i.length;++e)_+="a=fingerprint:"+i[e].getAttribute("hash")+" "+xows_xml_innertext(i[e])+"\r\n";i.length&&(_+="a=setup:"+i[0].getAttribute("setup")+"\r\n");const r=o.querySelectorAll("rtp-hdrext");for(let e=0;e<r.length;++e)_+="a=extmap:"+r[e].getAttribute("id"),"initiator"==r[e].getAttribute("senders")&&(_+="/recvonly"),_+=" "+r[e].getAttribute("uri")+"\r\n";for(let e=0;e<c.length;++e){const o=c[e].querySelectorAll("parameter");if(o.length){_+="a=fmtp:"+c[e].getAttribute("id")+" ";for(let e=0;e<o.length;++e)_+=o[e].getAttribute("name")+"="+o[e].getAttribute("value"),e<o.length-1&&(_+=";");_+="\r\n"}}for(let e=0;e<c.length;++e){const o=c[e].querySelectorAll("rtcp-fb");if(o.length)for(let s=0;s<o.length;++s)_+="a=rtcp-fb:"+c[e].getAttribute("id"),_+=" "+o[s].getAttribute("type"),o[s].hasAttribute("subtype")&&(_+=" "+o[s].getAttribute("subtype")),_+="\r\n"}o.querySelector("rtcp-mux")&&(_+="a=rtcp-mux\r\n");for(let e=0;e<c.length;++e)_+="a=rtpmap:"+c[e].getAttribute("id")+" ",_+=c[e].getAttribute("name"),c[e].hasAttribute("clockrate")&&(_+="/"+c[e].getAttribute("clockrate")),c[e].hasAttribute("channels")&&(_+="/"+c[e].getAttribute("channels")),_+="\r\n";const l=o.querySelectorAll("source");for(let e=0;e<l.length;++e){_+="a=ssrc:"+l[e].getAttribute("ssrc");const o=l[e].querySelector("parameter");o&&(_+=" "+o.getAttribute("name")+":"+o.getAttribute("value")),_+="\r\n"}const a=o.querySelectorAll("ssrc-group");for(let e=0;e<a.length;++e){_+="a=ssrc-group:"+a[e].getAttribute("semantics");const o=a[e].querySelectorAll("source");for(let e=0;e<o.length;++e)_+=" "+o[e].getAttribute("ssrc");_+="\r\n"}const u=s.querySelectorAll("candidate");for(let e=0;e<u.length;++e)_+="a=candidate:"+u[e].getAttribute("foundation"),_+=" "+u[e].getAttribute("component"),_+=" "+u[e].getAttribute("protocol").toUpperCase(),_+=" "+u[e].getAttribute("priority"),_+=" "+u[e].getAttribute("ip"),_+=" "+u[e].getAttribute("port"),u[e].hasAttribute("type")&&(_+=" typ "+u[e].getAttribute("type")),u[e].hasAttribute("rel-addr")&&(_+=" raddr "+u[e].getAttribute("rel-addr")),u[e].hasAttribute("rel-port")&&(_+=" rport "+u[e].getAttribute("rel-port")),u[e].hasAttribute("generation")&&(_+=" generation "+u[e].getAttribute("generation")),_+="\r\n"}return _}function xows_xmp_jing_sdp2jingle(e){const o=xows_sdp_parse(e),_=xows_xml_node("jingle",{xmlns:Ho}),s=xows_xml_node("group",{xmlns:Qo,semantics:o.group.type});for(const e in o.group.mids)xows_xml_parent(s,xows_xml_node("content",{name:e}));xows_xml_parent(_,s);for(let e=0;e<o.media.length;++e){const s=xows_xml_node("content",{creator:"initiator",name:o.media[e].mid}),t=xows_xml_node("description",{xmlns:Vo,media:o.media[e].type});if(o.media[e].rtpmap){const _=o.media[e].rtpmap;for(let e=0;e<_.length;++e)xows_xml_parent(t,xows_xml_node("payload-type",{id:_[e].payload,name:_[e].codec,clockrate:_[e].rate,channels:_[e].channels}))}if(o.media[e].fmtp){const _=o.media[e].fmtp;for(let e=0;e<_.length;++e){const o=t.querySelector("payload-type[id='"+_[e].payload+"']");if(o)for(let s=0;s<_[e].config.length;++s){const t=_[e].config[s].split("=");xows_xml_parent(o,xows_xml_node("parameter",{name:t[0],value:t[1]}))}}}if(o.media[e].rtcpFb){const _=o.media[e].rtcpFb;for(let e=0;e<_.length;++e){const o=t.querySelector("payload-type[id='"+_[e].payload+"']");o&&xows_xml_parent(o,xows_xml_node("rtcp-fb",{xmlns:Wo,type:_[e].type,subtype:_[e].subtype}))}}if(o.media[e].ssrcGroup){const _=o.media[e].ssrcGroup;for(let e=0;e<_.length;++e){const o=xows_xml_node("ssrc-group",{xmlns:Zo,semantics:_[e].semantics});for(let s=0;s<_[e].ssrcs.length;++s)xows_xml_parent(o,xows_xml_node("source",{ssrc:_[e].ssrcs[s]}));xows_xml_parent(t,o)}}if(o.media[e].ssrc){const _=o.media[e].ssrc;for(let e=0;e<_.length;++e)xows_xml_parent(t,xows_xml_node("source",{xmlns:Zo,ssrc:_[e].id},xows_xml_node("parameter",{name:_[e].attribute,value:_[e].value})))}if(o.media[e].extmap){const _=o.media[e].extmap;for(let e=0;e<_.length;++e){const o=xows_xml_node("rtp-hdrext",{xmlns:Xo,id:_[e].value,uri:_[e].uri});"recvonly"===_[e].direction&&o.setAttribute("senders","initiator"),xows_xml_parent(t,o)}}o.media[e].rtcpMux&&xows_xml_parent(t,xows_xml_node("rtcp-mux")),xows_xml_parent(s,t);const n=xows_xml_node("transport",{xmlns:Ko,pwd:o.media[e].icePwd,ufrag:o.media[e].iceUfrag});switch(o.media[e].direction){case"sendrecv":n.setAttribute("senders","both");break;case"sendonly":n.setAttribute("senders","initiator");break;case"recvonly":n.setAttribute("senders","responder");break;case"inactive":n.setAttribute("senders","none")}if(o.media[e].fingerprint||o.fingerprint){const _=o.media[e].fingerprint?o.media[e].fingerprint:o.fingerprint;for(let s=0;s<_.length;++s)xows_xml_parent(n,xows_xml_node("fingerprint",{xmlns:$o,hash:_[s].type,setup:o.media[e].setup},_[s].hash))}if(o.media[e].candidate){const _=o.media[e].candidate;for(let e=0;e<_.length;++e){xows_xml_parent(n,xows_xml_node("candidate",{component:_[e].component,network:_[e].network,foundation:_[e].foundation,generation:_[e].generation,protocol:_[e].protocol,priority:_[e].priority,ip:_[e].ip,port:_[e].port,type:_[e].type,"rel-addr":_[e].raddr,"rel-port":_[e].rport}))}}xows_xml_parent(s,n),xows_xml_parent(_,s)}return _}function xows_xmp_jing_recv(e){const o=e.getAttribute("id"),_=e.getAttribute("from"),s=e.querySelector("jingle"),t=s.getAttribute("action");let n;switch(t){case"session-terminate":{const e=s.querySelector("reason");e&&e.childNodes[0]&&(n=e.childNodes[0].tagName)}break;case"session-initiate":case"session-accept":if(null===(n=xows_xmp_jing_jingle2sdp(s)))return xows_log(1,"xmp_recv_jingle","error","RTP to SDP conversion failed"),void xows_xmp_iq_error_send(o,_,"cancel","bad-request");break;case"session-info":s.childNodes.length&&(n=s.childNodes[0].tagName)}o_(_,o,s.getAttribute("sid"),t,n)}function xows_xmp_jing_parse(e,o){const _=e.getAttribute("type");if(xows_xmp_iq_unhandled(e,_,o))return;if(!xows_isfunc(o))return;let s;if("error"===_){xows_xmp_error_log(e,1,"xmp_jing_parse"),s=xows_xmp_error_parse(e);const o=xows_xml_ns_select(e,zo);o&&(s.jing=o.tagName)}o(e.getAttribute("from"),_,s)}function xows_xmp_jing_initiate_sdp(e,o,_){const s=xows_xmp_jing_sdp2jingle(o),t=xows_gen_nonce_asc(16);return s.setAttribute("initiator",G.jful),s.setAttribute("action","session-initiate"),s.setAttribute("sid",t),xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},s),xows_xmp_jing_parse,_),t}function xows_xmp_jing_accept_sdp(e,o,_,s){const t=xows_xmp_jing_sdp2jingle(_);t.setAttribute("responder",G.jful),t.setAttribute("action","session-accept"),t.setAttribute("sid",o),xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},t),xows_xmp_jing_parse,s)}function xows_xmp_jing_info(e,o,_,s,t){let n={xmlns:e_};s&&(n=Object.assign(n,s)),xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},xows_xml_node("jingle",{xmlns:Ho,sid:o,action:"session-info"},xows_xml_node(_,n,null))),xows_xmp_jing_parse,t)}function xows_xmp_jing_terminate(e,o,_,s){xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},xows_xml_node("jingle",{xmlns:Ho,sid:o,action:"session-terminate"},xows_xml_node("reason",null,xows_xml_node(_)))),xows_xmp_jing_parse,s)}function xows_xmp_jing_error(e,o,_,s,t){xows_xmp_send(xows_xml_node("iq",{id:e,type:"error",to:o},xows_xml_node("error",{type:_},[xows_xml_node(t,{xmlns:ce}),xows_xml_node(s,{xmlns:zo})])))}const __="http://jabber.org/protocol/caps";function xows_xmp_caps_self_features(){let o=bo,_=fo,s=po;return Mn.cli_pepnotify_avat&&(o+="+notify"),Mn.cli_pepnotify_nick&&(_+="+notify"),Mn.cli_pepnotify_bkms&&(s+="+notify"),[xows_xml_node("identity",{category:"client",name:e,type:"web"}),xows_xml_node("feature",{var:__}),xows_xml_node("feature",{var:eo}),xows_xml_node("feature",{var:oo}),xows_xml_node("feature",{var:$e}),xows_xml_node("feature",{var:Qe}),xows_xml_node("feature",{var:Ze}),xows_xml_node("feature",{var:ge}),xows_xml_node("feature",{var:Ee}),xows_xml_node("feature",{var:re}),xows_xml_node("feature",{var:de}),xows_xml_node("feature",{var:ae}),xows_xml_node("feature",{var:Se}),xows_xml_node("feature",{var:le}),xows_xml_node("feature",{var:xe}),xows_xml_node("feature",{var:co}),xows_xml_node("feature",{var:_}),xows_xml_node("feature",{var:ho}),xows_xml_node("feature",{var:o}),xows_xml_node("feature",{var:s}),xows_xml_node("feature",{var:Ho}),xows_xml_node("feature",{var:Vo}),xows_xml_node("feature",{var:Yo}),xows_xml_node("feature",{var:Jo})]}let s_=null;function xows_xmp_caps_self_verif(){if(s_)return s_;const e=xows_xmp_caps_self_features();let o="";const _=[];for(let o=0;o<e.length;++o)if("identity"===e[o].tagName){let s="";s+=e[o].getAttribute("category")+"/",s+=e[o].getAttribute("type")+"/",e[o].hasAttribute("xml:lang")&&(s+=e[o].getAttribute("xml:lang")),s+="/",s+=e[o].getAttribute("name"),_.push(s)}_.sort();for(let e=0;e<_.length;++e)o+=_[e]+"<";const s=[];for(let o=0;o<e.length;++o)"feature"===e[o].tagName&&s.push(e[o].getAttribute("var"));s.sort();for(let e=0;e<s.length;++e)o+=s[e]+"<";return s_=xows_bytes_to_b64(xows_hash_sha1(xows_str_to_utf8(o)))}const t_=new Map;function xows_cach_avat_save(e,o,_){if(!o){o=xows_bytes_to_hex(xows_hash_sha1(xows_b64_to_bytes(xows_uri_to_data(e))))}return t_.set(o,e),_||localStorage.setItem(o,e),o}function xows_cach_avat_has(e){return!!t_.has(e)||!!localStorage.hasOwnProperty(e)}function xows_cach_avat_get(e){return t_.has(e)?t_.get(e):localStorage.hasOwnProperty(e)?(t_.set(e,localStorage.getItem(e)),t_.get(e)):null}function xows_cach_avat_temp_data(e,o){const _=xows_hash_sdbm(e);if(o||(o=xows_bytes_to_hex(_)),t_.has(o))return t_.get(o);{const e=xows_gen_avatar(rs,null,xows_bytes_to_int(_));return t_.set(o,e),e}}function xows_cach_avat_temp_hash(e){return xows_bytes_to_hex(xows_hash_sdbm(e))}const n_=new Map;function xows_cach_peer_iden(e){return e.type===y_&&e.ocid?e.ocid:e.addr}function xows_cach_peer_save(e){const o=xows_cach_peer_iden(e);let _;try{_=JSON.parse(localStorage.getItem(o))}catch(e){xows_log(1,"cach_peer_save","JSON parse error",o)}_?(_.name=e.name,_.avat=e.avat,_.noti=e.noti,"string"==typeof e.stat&&(_.stat=e.stat)):_={name:e.name,avat:e.avat,stat:e.stat,noti:e.noti},n_.set(o,_),localStorage.setItem(o,JSON.stringify(_))}function xows_cach_peer_has(e){return!!n_.has(e)||!!localStorage.hasOwnProperty(e)}function xows_cach_peer_get(e){if(n_.has(e))return n_.get(e);if(localStorage.hasOwnProperty(e)){try{n_.set(e,JSON.parse(localStorage.getItem(e)))}catch(o){return xows_log(1,"cach_peer_get","JSON parse error",e),localStorage.removeItem(e),null}return n_.get(e)}return null}function xows_cach_peer_fetch(e){const o=xows_cach_peer_get(xows_cach_peer_iden(e));o&&(o.name&&(e.name=o.name),o.avat&&(e.avat=o.avat),o.stat&&(e.stat=o.stat),o.noti&&(e.noti=o.noti))}const c_=new Map;function xows_cach_caps_save(e,o){c_.set(e,o),localStorage.setItem(e,JSON.stringify(o))}function xows_cach_caps_has(e){return!!c_.has(e)||!!localStorage.hasOwnProperty(e)}function xows_cach_caps_get(e){if(c_.has(e))return c_.get(e);if(localStorage.hasOwnProperty(e)){try{c_.set(e,JSON.parse(localStorage.getItem(e)))}catch(o){return xows_log(1,"cach_caps_get","JSON parse error",o),localStorage.removeItem(e),null}return c_.get(e)}return null}function xows_cach_auth_save(e){if(Mn.login_sasl_store)try{localStorage.setItem("auth_data",JSON.stringify(e))}catch(e){xows_log(1,"cach_auth_save","storage error",e)}}function xows_cach_auth_has(){return localStorage.hasOwnProperty("auth_data")}function xows_cach_auth_get(){if(!localStorage.hasOwnProperty("auth_data"))return null;let e=null;try{e=JSON.parse(localStorage.getItem("auth_data"))}catch(e){xows_log(1,"cach_auth_get","JSON parse error",e)}return e}function xows_cach_auth_reset(){localStorage.removeItem("auth_data")}let i_=1;function xows_load_task_bit(){const e=i_;return i_=e<<1,e}const r_=new Map;function xows_load_task_set(e,o){r_.set(e,o)}const l_=new Map;function xows_load_task_push(e,o,_,...s){if(0===o)return void _(e,...s);let t;if(l_.has(e)){if(e.load&o)return void xows_log(2,"load_task_push","Ignoring already planed tasks #"+e.load,e.addr||e.name);xows_log(2,"load_task_push","Updating tasks mask #"+e.load+"|"+o,e.addr||e.name),t=l_.get(e)}else xows_log(2,"load_task_push","Setting tasks mask #"+e.load+"|"+o,e.addr||e.name),t=[],l_.set(e,t);e.load|=o,t.push({mask:o,onload:_,param:s});let n=1;do{if(o&n){const o=r_.get(n);xows_isfunc(o)?(xows_load_timeout_run(e,n),o(e)):(xows_log(1,"load_task_push","No task for bit #"+n,e.addr||e.name),xows_load_task_done(e,n))}n<<=1}while(n!=i_)}function xows_load_task_done(e,o){xows_log(2,"load_task_done","Task #"+o+" done",e.addr||e.name),e.load&=~o,xows_load_timeout_clear(e,o);const _=l_.get(e);if(!_)return void xows_log(1,"load_task_done","No stack for item",e.addr||e.name);let s=null;for(let o=0;o<_.length;++o)if(0==(_[o].mask&e.load)){s=_[o],_.splice(o,1);break}null!==s&&(_.length||l_.delete(e),s.onload(e,...s.param),xows_load_onempty_check())}const a_=new Map;function xows_load_timeout_run(e,o,_=1e3){let s;a_.has(e)?(s=a_.get(e)).has(o)&&clearTimeout(s.get(o)):(s=new Map,a_.set(e,s)),s.set(o,setTimeout(xows_load_task_done,_,e,o))}function xows_load_timeout_clear(e,o){if(a_.has(e)){const _=a_.get(e);_.has(o)&&(clearTimeout(_.get(o)),_.delete(o),_.size||(xows_log(2,"load_timeout_clear","Clear timeout DB",e.addr||e.name),a_.delete(e)))}else xows_log(1,"load_timeout_clear","No timeout DB",e.addr||e.name)}function xows_load_await_task(e){}const u_={onempty:null,hto:null,param:null};function xows_load_onempty_set(e,o,..._){if(0===l_.size)return xows_log(2,"load_onempty_set","Stack already empty",o.name),void o(..._);const s=u_;s.hto&&(clearTimeout(s.hto),s.hto=null),s.param=_,s.onempty=o,e>0&&(s.hto=setTimeout(xows_load_onempty_check,e,!0)),xows_log(2,"load_onempty_set","Configured onempty",s.onempty.name)}function xows_load_onempty_check(e){if(u_.onempty&&(xows_log(2,"load_onempty_check","remain",l_.size),e||0===l_.size)){const o=u_;o.hto&&(clearTimeout(o.hto),o.hto=null),e&&xows_log(1,"load_onempty_check","Timed out");const _=o.onempty,s=o.param;o.onempty=null,o.param=null,xows_log(2,"load_onempty_check","Fireing onempty",_.name),_(...s)}}const d_=new Map;function xows_cli_entity_has(e,o){return!!d_.has(e)&&d_.get(e).feat.includes(o)}const x_=[],w_=new Map,p_=[];function xows_cli_extservs_has(...e){let o;o=Mn.cli_extern_services;for(let _=0;_<o.length;++_)if(e.includes(o[_].type))return!0;o=p_;for(let _=0;_<o.length;++_)if(e.includes(o[_].type))return!0;return!1}function xows_cli_extservs_get(...e){let o;const _=[];o=Mn.cli_extern_services;for(let s=0;s<o.length;++s)e.includes(o[s].type)&&_.push(o[s]);o=p_;for(let s=0;s<o.length;++s)e.includes(o[s].type)&&_.push(o[s]);return _}const m_=new Intl.Collator(void 0,{sensitivity:"accent"});function xows_cli_comp(e,o){return 0===m_.compare(e,o)}const g_=/[\&<>'"\/@:\u2100\u2101\u2105\u2106\u226E\u226F\u2A74\uFE13\uFE60\uFE64\uFE65\uFE6B\uFF02\uFF06\uFF07\uFF0F\uFF1C\uFF1E\uFF20]/g;function xows_cli_isnodeprep(e){return!g_.test(e)}const f_=0,h_=1,b_=2,y_=4,v_=7,F_={jful:null,jbar:null,addr:null,name:null,avat:null,show:0,stat:null,noti:!1,load:0};function xows_cli_self_clear(){F_.jful=null,F_.jbar=null,F_.addr=null,F_.name=null,F_.avat=null,F_.show=0,F_.stat=null,F_.noti=!1,F_.load=0}function xows_cli_isself_addr(e){return xows_cli_comp(F_.addr,xows_jid_bare(e))}xows_def_readonly(F_,"type",h_),xows_def_readonly(F_,"self",F_),Object.seal(F_);const k_=[];function xows_cli_cont_new(e,o,_,s){const t={name:o||e,subs:_,avat:s,show:0,stat:"",noti:!0,chat:0,jlck:e,jrpc:e,live:!1,load:0};return xows_def_readonly(t,"type",h_),xows_def_readonly(t,"addr",e),xows_def_readonly(t,"jbar",e),xows_def_readonly(t,"ress",new Map),xows_def_readonly(t,"self",null),Object.seal(t),k_.push(t),t}function xows_cli_cont_rem(e){const o=k_.indexOf(e);k_.splice(o,1)}function xows_cli_cont_get(e){const o=xows_jid_bare(e);for(let e=0;e<k_.length;++e)if(xows_cli_comp(k_[e].addr,o))return k_[e];return null}const A_=[];function xows_cli_room_new(e,o){const _=e.split("@");o||(o=_[0][0].toUpperCase()+_[0].slice(1));const s={name:o,desc:"",subj:null,publ:!0,prot:!1,pass:null,modr:!1,anon:!0,open:!0,nocc:0,init:!1,join:null,role:0,affi:0,nick:null,locl:w_.get(Eo).includes(_[1]),occu:[],writ:[],noti:!0,book:!1,live:!1,load:0};return xows_def_readonly(s,"type",b_),xows_def_readonly(s,"addr",e),xows_def_readonly(s,"jlck",e),xows_def_readonly(s,"self",null),Object.seal(s),A_.push(s),s}function xows_cli_room_rem(e){const o=A_.indexOf(e);A_.splice(o,1)}function xows_cli_room_get(e){const o=xows_jid_bare(e);for(let e=0;e<A_.length;++e)if(xows_cli_comp(A_[e].addr,o))return A_[e];return null}function xows_cli_occu_new(e,o,_,s,t,n){const c=s?xows_jid_bare(s):null,i={name:xows_jid_resc(o),addr:o,jlck:o,jrpc:o,affi:0,role:0,jful:s,jbar:c,avat:t,show:4,stat:"",chat:0,noti:!0,live:!1,load:0};return n=n?F_:null,xows_def_readonly(i,"type",y_),xows_def_readonly(i,"room",e),xows_def_readonly(i,"ocid",_),xows_def_readonly(i,"self",n),Object.seal(i),e.occu.push(i),i}function xows_cli_occu_rem(e){const o=e.room,_=o.occu.indexOf(e);o.occu.splice(_,1)}function xows_cli_occu_get(e,o,_){for(let s=0;s<e.occu.length;++s)if(_&&e.occu[s].ocid===_||xows_cli_comp(e.occu[s].addr,o))return e.occu[s];return null}function xows_cli_occu_get_or_new(e,o,_){for(let s=0;s<e.occu.length;++s)if(_&&e.occu[s].ocid===_||xows_cli_comp(e.occu[s].addr,o))return e.occu[s];const s=xows_cach_peer_get(_||o);return xows_cli_occu_new(e,o,_,null,s?s.avat:null,!1)}function xows_cli_occu_self(e){for(let o=0;o<e.occu.length;++o)if(null!==e.occu[o].self)return e.occu[o]}const E_=[];function xows_cli_ocpm_rem(e){const o=E_.indexOf(e);E_.splice(o,1)}function xows_cli_ocpm_has(e){return E_.includes(e)}function xows_cli_ocpm_add(e){const o=E_.includes(e);return o||E_.push(e),!o}function xows_cli_peer_get(e,o){if(!e)return F_;const _=xows_jid_bare(e);if(_==F_.addr)return F_;if(o&h_)for(let e=0;e<k_.length;++e)if(xows_cli_comp(k_[e].addr,_))return k_[e];if(o&(b_|y_)){let s=null;for(let e=0;e<A_.length;++e)if(xows_cli_comp(A_[e].addr,_)){s=A_[e];break}if(!(o&y_&&e.includes("/")))return s;if(s)for(let o=0;o<s.occu.length;++o)if(xows_cli_comp(s.occu[o].addr,e))return s.occu[o];for(let o=0;o<E_.length;++o)if(xows_cli_comp(E_[o].addr,e))return E_[o]}return null}const q_=1,S_=2,C_=4,T_=8;function xows_cli_peer_push(e,o,..._){switch(xows_cach_peer_save(e),e.type){case h_:e.self?R_(e,o,..._):J_(e,o,..._);break;case y_:ks(e,o,..._),xows_cli_ocpm_has(e)&&$_(e,o,..._);break;case b_:bs(e,o,..._)}}function xows_cli_peer_iden(e){return e.type===y_&&e.ocid?e.ocid:e.addr}function xows_cli_peer_subsste(e){if(e.self)return 2;let o;switch(e.type){case h_:o=e;break;case y_:if(null===e.jbar)return 2;for(let _=0;_<k_.length;++_)if(xows_cli_comp(k_[_].addr,e.jbar)){o=k_[_];break}}return o?0===o.subs?1:2:0}function xows_cli_author_get(e,o,_){switch(e.type){case b_:if(!xows_cli_comp(o,e.join))return xows_cli_occu_get_or_new(e,o,_);for(let o=0;o<e.occu.length;++o)if(null!==e.occu[o].self)return e.occu[o];break;case h_:{const e=xows_jid_bare(o);if(xows_cli_comp(F_.addr,e))return F_;for(let o=0;o<k_.length;++o)if(xows_cli_comp(k_[o].addr,e))return k_[o]}break;case y_:if(xows_cli_comp(o,e.room.join)){for(let o=0;o<e.room.occu.length;++o)if(null!==e.room.occu[o].self)return e.room.occu[o]}else for(let e=0;e<E_.length;++e)if(xows_cli_comp(E_[e].addr,o))return E_[e]}return xows_log(0,"cli_author_get","author not found",o),null}const D_=xows_load_task_bit(),j_=xows_load_task_bit(),I_=xows_load_task_bit(),N_=xows_load_task_bit(),M_=xows_load_task_bit();function xows_cli_init(){xows_log(2,"cli_init","client module initialized"),xows_xmp_set_callback("sessready",xows_cli_xmp_onready),xows_xmp_set_callback("sessclose",xows_cli_xmp_onclose),xows_xmp_set_callback("error",xows_cli_xmp_onerror),xows_xmp_set_callback("rostpush",xows_cli_rost_onpush),xows_xmp_set_callback("presrecv",xows_cli_pres_onrecv),xows_xmp_set_callback("pressubs",xows_cli_pres_onsubs),xows_xmp_set_callback("presfail",xows_cli_pres_onfail),xows_xmp_set_callback("presmuco",xows_cli_muc_onpres),xows_xmp_set_callback("msgrecv",xows_cli_msg_onrecv),xows_xmp_set_callback("msgchst",xows_cli_chst_onrecv),xows_xmp_set_callback("msgrecp",xows_cli_msg_onrecp),xows_xmp_set_callback("msgretr",xows_cli_msg_onretr),xows_xmp_set_callback("msgpubs",xows_cli_msg_onpubs),xows_xmp_set_callback("mucsubj",xows_cli_muc_onsubj),xows_xmp_set_callback("mucnoti",xows_cli_muc_onnoti),xows_xmp_set_callback("jingrecv",xows_cli_call_jing_onrecv),xows_doc_listener_add(window,"beforeunload",xows_cli_onuload),xows_doc_listener_add(window,"unload",xows_cli_onuload),xows_load_task_set(D_,xows_cli_avat_fetch),xows_load_task_set(j_,xows_cli_pep_nick_fetch),xows_load_task_set(I_,xows_cli_muc_info_query),xows_load_task_set(N_,xows_cli_muc_nick_query),xows_load_task_set(M_,xows_load_await_task)}function xows_cli_reset(){xows_log(2,"cli_reset","reset client state"),xows_cli_pres_show_set(Ie),xows_cli_self_clear(),d_.clear(),w_.clear(),x_.length=0,p_.length=0,k_.length=0,A_.length=0,E_.length=0}let L_=function(){},B_=function(){},P_=function(){},R_=function(){};function xows_cli_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"ready":L_=o;break;case"error":P_=o;break;case"close":B_=o;break;case"selfpush":R_=o;break;case"subspush":W_=o;break;case"contpush":J_=o;break;case"contpull":K_=o;break;case"roompush":bs=o;break;case"roompull":ys=o;break;case"occupush":$_=o;break;case"occupull":Q_=o;break;case"mucjoin":vs=o;break;case"mucexit":Fs=o;break;case"mucpush":ks=o;break;case"mucpull":As=o;break;case"mucsubj":Es=o;break;case"msgrecv":X_=o;break;case"msgrecp":Z_=o;break;case"msgretr":_s=o;break;case"msgchst":es=o;break;case"upldprog":gs=o;break;case"upldload":fs=o;break;case"calloffer":Bs=o;break;case"callanwse":Ps=o;break;case"callstate":Rs=o;break;case"calltermd":Os=o;break;case"callerror":Gs=o}}function xows_cli_xmp_onerror(e,o){P_(e,o)}const O_=0,G_=1,U_=2,H_=4;function xows_cli_cnx_login(e,o,_,s,t){xows_cli_reset(),xows_xmp_connect(e,o,_,s,t)}function xows_cli_xmp_onready(e,o){z_?xows_cli_session_start(o):(F_.addr=e.jbar,F_.jbar=e.jbar,F_.jful=e.jful,xows_cach_peer_fetch(F_),F_.name||(F_.name=xows_capitalize(e.node)),xows_cli_warmup_start())}let z_=null,V_=null;function xows_cli_cnx_resume(e=!1){if(!e)return xows_log(2,"cli_resume","stop resume process"),z_&&(clearTimeout(z_),z_=null),void(V_&&(clearTimeout(V_),V_=null));z_||(xows_log(2,"cli_resume","start resume process"),z_=setTimeout(xows_cli_cnx_timeout,6e4*Mn.resume_timeout)),xows_log(2,"cli_resume","attempt to reconnect in "+Mn.resume_try_delay+" seconds"),V_&&clearTimeout(V_),V_=setTimeout(xows_xmp_resume,1e3*Mn.resume_try_delay)}function xows_cli_cnx_timeout(){xows_log(2,"cli_cnx_timeout","resume timed out"),z_&&(clearTimeout(z_),z_=null),V_&&(clearTimeout(V_),V_=null),B_(H_,"unable to resume connection"),xows_xmp_disconnect(0)}function xows_cli_cnx_close(){xows_log(2,"cli_disconnect","prepare disconnect");for(const e of Us.keys())xows_cli_call_self_hangup(e,"success");for(let e=0;e<k_.length;++e)k_[e].jlck!==k_[e].addr&&xows_cli_chst_self_set(k_[e],he);for(let e=0;e<A_.length;++e)A_[e].join&&xows_cli_chst_self_set(A_[e],he);xows_cli_pres_show_set(Ie),xows_xmp_disconnect(0)}function xows_cli_onuload(){for(const[e,o]of Us.entries())xows_xmp_jing_terminate(e.jrpc,o.sid,"failed-application");xows_xmp_onuload()}function xows_cli_cnx_cntd(){return null!==F_.jful}function xows_cli_xmp_onclose(e,o){z_?xows_cli_cnx_resume(!0):(e?(xows_log(2,"cli_xmp_onclose","session error",o),F_.jful?(e|=G_,xows_log(2,"cli_xmp_onclose","lost connection",o),xows_cli_cnx_resume(!0)):e|=U_):(xows_cli_reset(),xows_log(2,"cli_xmp_onclose","session closed by user",o)),B_(e,o))}function xows_cli_warmup_start(){xows_log(2,"cli_warmup_start","ignition"),xows_xmp_disco_info_query(F_.addr,null,xows_cli_warmup_discnfo_self)}function xows_cli_warmup_discnfo_self(e,o,_,s,t,n){d_.set(e,{iden:_,feat:s,item:[]});for(let e=0;e<s.length;++e)x_.push(s[e]);xows_xmp_disco_info_query(O,null,xows_cli_warmup_discnfo_host)}function xows_cli_warmup_discnfo_host(e,o,_,s,t,n){d_.set(e,{iden:_,feat:s,item:[]}),xows_xmp_disco_items_query(O,xows_cli_warmup_discitms_host)}const Y_=[];function xows_cli_warmup_discitms_host(e,o,_){if(o.length){const _=d_.get(e);for(let e=0,s=o.length;e<s;++e){const s=o[e].jid;xows_log(2,"cli_init_discoitems_host","discovered item",s),_.item.push(s),Y_.push(s)}xows_xmp_disco_info_query(Y_.shift(),null,xows_cli_warmup_discnfo_item)}else xows_cli_entity_has(O,_o)?xows_xmp_extdisco_query(O,null,xows_cli_warmup_extdisc_host):xows_xmp_rost_get_query(xows_cli_warmup_roster)}function xows_cli_warmup_discnfo_item(e,o,_,s,t,n){d_.set(e,{iden:_,feat:s,item:[]}),Y_.length?xows_xmp_disco_info_query(Y_.shift(),null,xows_cli_warmup_discnfo_item):xows_cli_entity_has(O,_o)?xows_xmp_extdisco_query(O,null,xows_cli_warmup_extdisc_host):xows_xmp_rost_get_query(xows_cli_warmup_roster)}function xows_cli_warmup_extdisc_host(e,o,_){for(let e=0,_=o.length;e<_;++e){xows_log(2,"cli_extdisco_parse","discovered external",o[e].type+" ("+o[e].host+":"+o[e].port+")"),p_.push(o[e])}xows_xmp_rost_get_query(xows_cli_warmup_roster)}function xows_cli_warmup_roster(e,o){xows_cli_rost_parse(e,o),xows_load_task_push(F_,D_|j_,xows_cli_warmup_config)}function xows_cli_warmup_config(){xows_cli_peer_push(F_,255),d_.get(O).feat.includes(no)&&(xows_log(2,"cli_warmup_config","Enable Messages Carbons"),xows_xmp_carbons_query(!0,null));for(const[e,o]of d_)o.feat.includes(Eo)&&(w_.has(Eo)||w_.set(Eo,[]),xows_log(2,"cli_warmup_config","Using Multi-User-Chat service",e),w_.get(Eo).push(e)),o.feat.includes(Ao)&&(w_.has(Ao)||w_.set(Ao,[]),xows_log(2,"cli_warmup_config","Using HTTP-File-Upload service",e),w_.get(Ao).push(e));Mn.cli_pepnotify_bkms||xows_cli_pep_book_fetch(),w_.has(Eo)?xows_cli_muc_list_query(xows_cli_warmup_finish):xows_cli_warmup_finish()}function xows_cli_warmup_finish(){xows_load_onempty_set(2e3,xows_cli_session_start)}function xows_cli_session_start(e){if(z_){if(xows_log(1,"cli_session_start","resume session"),xows_cli_cnx_resume(!1),!e)for(let e=0;e<A_.length;++e)A_[e].live&&(A_[e].join=null,xows_load_task_push(A_[e],M_,vs),xows_cli_muc_join(A_[e]))}else xows_log(2,"cli_session_start","takeoff");e||xows_cli_pres_show_set(Be),xows_load_onempty_set(2e3,L_,F_,e)}let J_=function(){},K_=function(){};function xows_cli_rost_onpush(e,o,_,s){let t=xows_cli_cont_get(e);if(_===Ge)return void(t&&K_(t));t?(o&&(t.name=o),t.subs=_):xows_cach_peer_fetch(t=xows_cli_cont_new(e,o,_));let n=0,c=0;t.subs&ze&&xows_isjid(e)&&(n|=D_|j_,c|=T_|C_),xows_load_task_push(t,n,xows_cli_peer_push,c)}function xows_cli_rost_reset(){for(let e=0;e<k_.length;++e){const o=k_[e];o.ress.clear(),o.show=Ie,J_(o,q_)}}function xows_cli_rost_parse(e,o){if(e.length)for(let o=0,_=e.length;o<_;++o)xows_cli_rost_onpush(e[o].jid,e[o].name,e[o].subs,e[o].group);else J_(null)}function xows_cli_rost_fetch(){xows_xmp_rost_get_query(xows_cli_rost_parse)}function xows_cli_rost_set(e,o){xows_xmp_rost_set_query(e,o,null,null)}let W_=function(){};function xows_cli_pres_onrecv(e,o,_,s,t,n){if(xows_cli_isself_addr(e))return;const c=xows_cli_cont_get(e);if(!c)return void xows_log(1,"cli_pres_onrecv","unknown/unsubscribed Contact",e);xows_log(2,"cli_pres_onrecv","received presence show="+o,e),c.jlck=c.jbar;let i=xows_jid_resc(e);if(o>Ie){if(c.ress.has(i))c.ress.get(i).show=o,c.ress.get(i).prio=_,c.ress.get(i).stat=s;else if(c.ress.set(i,{id:i,show:o,prio:_,stat:s,node:null}),t){const o=t.node+"#"+t.ver;c.ress.get(i).node=o,xows_cach_caps_has(o)||xows_xmp_disco_info_query(e,o,xows_cli_entity_caps_parse)}}else c.ress.has(i)&&c.ress.delete(i),c.chat=0;const r=c.show,l=c.stat;c.show=Ie;let a=-128;for(const e of c.ress.values())e.prio>a&&(a=e.prio,c.show=e.show,c.stat=e.stat);let u=0;r!==c.show&&(u|=q_),l!==c.stat&&(u|=S_);let d=0;c.show>Ie&&("string"==typeof n?n.length>0?n!==c.avat&&(xows_cach_avat_has(n)?c.avat=n:d|=D_,u|=T_):c.avat=null:c.avat||Mn.cli_pepnotify_avat||(d|=D_,u|=T_),Mn.cli_pepnotify_nick||(d|=j_,u|=C_)),xows_load_task_push(c,d,xows_cli_peer_push,u)}function xows_cli_pres_onfail(e,o){if(xows_cli_isself_addr(e))return;const _=xows_cli_peer_get(e,h_|b_);if(_){if(_.type===b_)vs(_,null,o);else if(_.type===h_){let s;switch(o.name){case"remote-server-not-found":s="Remote server not found";break;case"recipient-unavailable":return void P_(e,o.name);default:s="Server error"}J_(_,0,s)}}else xows_log(1,"cli_pres_onfail","unknown/unsubscribed JID",e)}function xows_cli_pres_onsubs(e,o,_){let s=xows_cli_cont_get(e);switch(o){case"subscribe":if(s)s.subs&ze&&xows_cli_subs_answer(s,!0);else{if(!_){const o=e.split("@")[0];_=o[0].toUpperCase()+o.slice(1)}s=xows_cli_cont_new(xows_jid_bare(e),_,Ue,null),W_(s,0)}break;case"unsubscribe":s?(s.subs&=~He,J_(s,0)):xows_log(1,"cli_xmp_onsubscribe","subscribe revoked from unknow contact",e);break;case"subscribed":s?(s.subs|=He,J_(s,0)):xows_log(1,"cli_xmp_onsubscribe","request allowed from unknow contact",e)}}function xows_cli_subs_request(e){let o=xows_cli_cont_get(e);if(!o){const _=e.split("@")[0];o=xows_cli_cont_new(e,_[0].toUpperCase()+_.slice(1),He,null)}xows_xmp_presence_send(e,"subscribe",null,null,F_.name)}function xows_cli_subs_revoke(e){xows_xmp_rost_set_query(e.addr,null,null,null)}function xows_cli_subs_answer(e,o){xows_xmp_presence_send(e.addr,o?"subscribed":"unsubscribed"),o?(e.subs|=He,e.subs!==Ve&&xows_cli_subs_request(e.addr)):K_(e)}function xows_cli_entity_caps_parse(e,o,_,s,t){xows_cach_caps_has(t)||xows_cach_caps_save(t,_)}function xows_cli_entity_caps_test(e,o){return!!xows_cach_caps_has(e)&&xows_cach_caps_get(e).includes(o)}let X_=function(){},$_=function(){},Q_=function(){};function xows_cli_msg_onrecv(e,o){const _=e.from;let s;(s="groupchat"==e.type?xows_cli_room_get(_):xows_cli_peer_get(xows_cli_isself_addr(_)?e.to:_,v_))?(s.type===h_&&(s.jlck=_),s.type===y_&&xows_cli_ocpm_add(s)&&$_(s,0),e.time||(e.time=(new Date).getTime()),X_(s,e,!1,!1,o)):xows_log(1,"cli_xmp_onmessage","unknown/unsubscribed JID",_)}function xows_cli_msg_send(e,o,_,s,t,n){let c,i,r=!0;if(e.type===b_)c="groupchat",i=e.join;else if(c="chat",e.type===y_)i=e.room.join;else if(i=F_.addr,e.jlck!==e.addr){const o=e.ress.get(xows_jid_resc(e.jlck));o&&(r=xows_cli_entity_caps_test(o.node,Ee))}const l=e.jlck,a=xows_xmp_message_body_send(c,l,o,r,_,s,t,n),u=xows_xmp_message_forge(a,l,i,c,o,n,null,null,null,_,s,t,a);X_(e,u,r,!0)}let Z_=function(){};function xows_cli_msg_onrecp(e,o,_,s){let t;xows_cli_isself_addr(o)||((t=xows_cli_peer_get(o,v_))?Z_(t,s):xows_log(1,"cli_xmp_onreceipt","unknown/unsubscribed JID",o))}let es=function(){};function xows_cli_chst_onrecv(e,o,_,s,t){let n;if("chat"===_){if(xows_cli_isself_addr(o))return;n=xows_cli_peer_get(o,v_)}else if((n=xows_cli_room_get(o))&&n.join===o)return;if(n){switch(n.type){case b_:{const e=xows_cli_occu_get(n,o,t);if(e)if(e.chat=s,s>ve)n.writ.includes(e)||n.writ.push(e);else{const o=n.writ.indexOf(e);o>=0&&n.writ.splice(o,1)}}break;case y_:n.chat=s;break;default:n.chat=s,s>0&&(n.jlck=o)}es(n,s)}else xows_log(1,"cli_xmp_onchatstate","unknown/unsubscribed JID",o)}let os=null;function xows_cli_chst_self_set(e,o){if(e.type===y_&&0===e.show)return;let _;if(e.type===b_){if(!e.join)return;_="groupchat"}else _="chat";o>ve?(os?clearTimeout(os):xows_xmp_message_chatstate_send(e.jlck,_,o),os=setTimeout(xows_cli_chst_self_set,4e3,e,ve)):(clearTimeout(os),os=null,xows_xmp_message_chatstate_send(e.jlck,_,o))}let _s=function(){};function xows_cli_msg_onretr(e,o,_,s){let t;(t="chat"===_?xows_cli_peer_get(o,v_):xows_cli_room_get(o))?_s(t,s):xows_log(1,"cli_xmp_onretract","unknown/unsubscribed JID",o)}function xows_cli_msg_retr(e,o){const _=e.type===b_?"groupchat":"chat";xows_xmp_message_retract_send(e.jlck,_,o),e.type!==b_&&_s(e,o)}function xows_cli_pres_update(e){let o,_,s,t=0;F_.show>Ie?(t=F_.show,_=F_.stat,s=F_.avat):o="unavailable",xows_xmp_presence_send(null,o,t,_,null,null,s);for(let e=0;e<A_.length;++e)A_[e].join&&(xows_xmp_presence_send(A_[e].join,o,t,_,null,null,s),o&&(A_[e].join=null));xows_cli_peer_push(F_,e)}function xows_cli_pres_stat_set(e){F_.stat!==e&&(F_.stat=e,xows_cli_pres_update(S_))}let ss=Ie,ts=null;function xows_cli_pres_show_set(e){F_.show=ss=e,F_.addr&&xows_cli_pres_update(q_),ts&&clearTimeout(ts),e>Me&&(ts=setTimeout(xows_cli_pres_show_snooze,6e5))}function xows_cli_pres_show_snooze(){ts&&clearTimeout(ts),F_.show>Me&&(F_.show--,xows_cli_pres_update(q_),ts=setTimeout(xows_cli_pres_show_snooze,6e5))}function xows_cli_pres_show_back(){ts&&clearTimeout(ts),F_.show<ss&&(F_.show=ss,xows_cli_pres_update(q_)),ts=setTimeout(xows_cli_pres_show_snooze,6e5)}const ns={mask:0,open:!1};function xows_cli_self_edit(e,o,_){let s=0;e&&F_.name!==e&&(F_.name=e,s|=C_);const t=o?xows_cach_avat_save(o):null;F_.avat!==t&&(F_.avat=t,s|=T_),0!==s&&(ns.mask=s,ns.open=_,xows_cli_self_publ_nick())}function xows_cli_self_publ_nick(){ns.mask&C_?xows_cli_pep_nick_publ(xows_cli_self_publ_avat):xows_cli_self_publ_avat()}function xows_cli_self_publ_avat(){ns.mask&T_?xows_cli_avat_data_publ(xows_cli_self_publ_vcdt):xows_cli_self_publ_vcdt()}function xows_cli_self_publ_vcdt(){x_.includes(ro)?xows_cli_self_publ_mode():xows_cli_vcdt_publ(xows_cli_self_publ_mode)}function xows_cli_self_publ_mode(){ns.open?(xows_cli_pep_chmod(bo,"open",null),xows_cli_pep_chmod(ho,"open",xows_cli_self_publ_end)):xows_cli_self_publ_end()}function xows_cli_self_publ_end(){xows_cli_pres_update(ns.mask)}const cs={onpubl:null};function xows_cli_vcdt_publ(e){cs.onpubl=e,xows_xmp_vcardt_get_query(null,xows_cli_vcdt_publ_edit)}function xows_cli_vcdt_publ_edit(e,o,_){const s=cs;if(_)return xows_log(1,"cli_vcdt_pub_edit","query onw vCard error",_.name),void(xows_isfunc(s.onpubl)&&s.onpubl(e,"error",_));const t=o.querySelector("NICKNAME");t?t.innerText=F_.name:xows_xml_parent(o,xows_xml_node("NICKNAME",null,F_.name));let n=o.querySelector("PHOTO");if(n&&(n.innerHTML=""),F_.avat){n||xows_xml_parent(o,n=xows_xml_node("PHOTO"));const e=xows_cach_avat_get(F_.avat);xows_xml_parent(n,xows_xml_node("TYPE",null,xows_uri_to_type(e))),xows_xml_parent(n,xows_xml_node("BINVAL",null,xows_uri_to_data(e)))}xows_xmp_vcardt_set_query(o,s.onpubl)}function xows_cli_msg_onpubs(e,o,_,s){xows_log(2,"cli_xmp_onpubsub","received notification",o),o===bo&&_.length&&xows_cli_avat_meta_parse(e,_[0].child),o===fo&&_.length&&xows_cli_pep_nick_parse(e,_[0].child),o===po&&(_.length||s.length)&&xows_cli_pep_book_parse(e,_,s)}const is=new Map;function xows_cli_pep_chmod_parse(e,o,_,s){if(!is.has(o))return;const t=is.get(o);if(is.delete(o),s)xows_isfunc(t.onresult)&&t.onresult(e,"error",s);else{if(_)for(let e=0,s=_.length;e<s;++e)if("pubsub#access_model"===_[e].var){if(_[e].value[0]===t.access)return void xows_xmp_pubsub_conf_set_cancel(o,t.onresult);_[e].value=[t.access];break}xows_xmp_pubsub_conf_set_query(o,_,t.onresult)}}function xows_cli_pep_chmod(e,o,_){is.has(e)||(is.set(e,{access:o,onresult:_}),xows_xmp_pubsub_conf_get_query(e,xows_cli_pep_chmod_parse))}function xows_cli_pep_nick_parse(e,o,_){const s=xows_cli_peer_get(e,h_|y_);if(s){if(_)xows_log(1,"cli_nick_parse","error parse nickname",e);else{const e=xows_xml_innertext(o);e&&(s.name=e)}s.load&j_?xows_load_task_done(s,j_):xows_cli_peer_push(s,C_)}else xows_log(1,"cli_nick_parse","unknown/unsubscribed JID",e)}function xows_cli_pep_nick_fetch(e){xows_xmp_nick_get_query(e.addr,xows_cli_pep_nick_parse)}function xows_cli_pep_nick_publ(e){xows_xmp_nick_publish(F_.name,e)}function xows_cli_pep_book_parse(e,o,_,s){if(s)xows_log(1,"cli_pep_book_parse","bookmarks error result",s.name);else{for(let e=0;e<o.length;++e){let _=o[e].id,s=o[e].child.getAttribute("name"),t=o[e].child.getAttribute("autojoin"),n=xows_cli_room_get(_);if(n){if(n.locl&&n.publ)return}else n=xows_cli_room_new(_,s);n.book=!0,t&&xows_cli_muc_join(n),xows_load_task_push(n,I_,xows_cli_peer_push,255)}for(let e=0;e<_.length;++e){const o=_[e].id,s=xows_cli_room_get(o);s?(s.book=!1,xows_cli_peer_push(s,255)):xows_log(1,"cli_pep_book_parse","bookmark room not found",o)}}}function xows_cli_pep_book_publ(e,o,_,s){const t=_||e.name,n=s||(e.nick?e.nick:xows_jid_resc(e.join));xows_xmp_bookmark_publish(e.addr,t,o,n,null),Mn.cli_pepnotify_bkms||(e.book=!0,xows_cli_peer_push(e,0))}function xows_cli_pep_book_retr(e){xows_xmp_bookmark_retract(e.addr),Mn.cli_pepnotify_bkms||(e.book=!1,xows_cli_peer_push(e,0))}function xows_cli_pep_book_fetch(){xows_xmp_bookmark_get_query(xows_cli_pep_book_parse)}const rs=48,ls={daturi:null,onpubl:null};function xows_cli_avat_data_publ(e){let o;if(!F_.avat)return void xows_xmp_avat_meta_publish(null,null,null,null,null,e);o=xows_cach_avat_get(F_.avat);const _=ls;_.daturi=o,_.onpubl=e;const s=xows_uri_to_data(o);xows_xmp_avat_data_publish(xows_bytes_to_hex(xows_hash_sha1(xows_b64_to_bytes(s))),s,xows_cli_avat_meta_publ)}function xows_cli_avat_meta_publ(e,o,_){if("result"!==o)return void xows_log(1,"cli_pep_avat_meta_publ","data publication error");const s=ls,t=xows_b64_to_bytes(xows_uri_to_data(s.daturi));xows_xmp_avat_meta_publish(xows_bytes_to_hex(xows_hash_sha1(t)),xows_uri_to_type(s.daturi),t.length,rs,rs,s.onpubl)}const as=[];function xows_cli_avat_fetch(e){as.includes(e)||(as.push(e),xows_xmp_avat_meta_get_query(e.addr,xows_cli_avat_meta_parse))}function xows_cli_avat_fetch_done(e,o){e.avat=o;let _=as.indexOf(e);as.splice(_,1),e.load&D_?xows_load_task_done(e,D_):xows_cli_peer_push(e,T_)}function xows_cli_avat_vcdt_parse(e,o,_){const s=xows_cli_peer_get(e,h_|y_);if(!s)return void xows_log(1,"cli_avat_fetch2_vcdt_parse","unknown/unsubscribed JID",e);let t=null;if(_)xows_log(1,"cli_avat_fetch2_vcdt_parse","error parsing vcard",e);else{const e=o.querySelector("PHOTO");if(e){const o=e.querySelector("TYPE"),_=e.querySelector("BINVAL");o&&_?xows_log(2,"cli_avat_fetch2_vcdt_parse","Set avatar from photo",t=xows_cach_avat_save("data:"+xows_xml_innertext(o)+";base64,"+xows_xml_innertext(_))):xows_log(2,"cli_avat_fetch2_vcdt_parse","No photo")}}xows_cli_avat_fetch_done(s,t)}function xows_cli_avat_meta_parse(e,o,_){const s=xows_cli_peer_get(e,h_|y_);if(!s)return void xows_log(1,"cli_avat_pepmeta_parse","unknown/unsubscribed JID",e);let t=null;o&&(t=o.querySelector("info"));let n=!1;if(_?(xows_log(1,"cli_avat_pepmeta_parse","error result",s.addr),n=!0):t||(xows_log(1,"cli_avat_pepmeta_parse","avatar unavailable",s.addr),n=!0),n){if(Mn.cli_avat_autopub&&s===F_){const e=xows_cach_avat_temp_data(s.addr,null);return xows_log(1,"cli_avat_pepmeta_parse","publish own default (generated) avatar"),xows_cli_avat_fetch_done(s,xows_cach_avat_save(e)),void xows_cli_avat_data_publ()}return void(as.includes(s)?xows_xmp_vcardt_get_query(s.addr,xows_cli_avat_vcdt_parse):xows_cli_avat_fetch_done(s,null))}const c=t.getAttribute("id");xows_cach_avat_has(c)?(xows_log(2,"cli_avat_pepmeta_parse","Cached data",s.addr),xows_cli_avat_fetch_done(s,c)):(xows_log(2,"cli_avat_pepmeta_parse","Fetching data",s.addr),us.set(c,t.getAttribute("type")),xows_xmp_avat_data_get_query(s.addr,c,xows_cli_avat_data_parse))}const us=new Map;function xows_cli_avat_data_parse(e,o,_,s){const t=xows_cli_peer_get(e,h_|y_);if(!t)return void xows_log(1,"cli_avat_fetch2_data_parse","unknown/unsubscribed JID",e);const n=us.get(o);if(us.delete(o),s)return xows_log(1,"cli_avat_fetch2_data_parse","error result",e),void(as.includes(t)?xows_xmp_vcardt_get_query(t.addr,xows_cli_avat_vcdt_parse):xows_cli_avat_fetch_done(t,null));xows_cach_avat_save("data:"+n+";base64,"+_,o),xows_cli_avat_fetch_done(t,o)}const ds=new Map;function xows_cli_mam_fetch_parse(e,o,_,s,t){const n=xows_cli_peer_get(e||o,v_);if(!n)return void xows_log(1,"cli_mam_collect","unknown/unsubscribed JID",e||o);const c=[];for(let e=0;e<_.length;++e)_[e].retract&&c.push(_[e].retract);if(c.length)if(n.type===h_)for(let e=0;e<_.length;++e)c.includes(_[e].orid)&&(_[e].discard=!0);else for(let e=0;e<_.length;++e)c.includes(_[e].szid)&&(_[e].discard=!0);const i=ds.get(n);if(!i)return void xows_log(1,"cli_mam_collect","unexpected MAM result",e||o);i.start?i.pool=i.pool.concat(_):i.pool=_.concat(i.pool);const r=i.pool;let l=0;for(let e=0;e<r.length;++e)!r[e].body||r[e].discard||r[e].replace||l++;if(!t&&l<i.need)return i.start?i.start=r[r.length-1].time+1:i.end=r[0].time-1,i.max=2*(i.need-l),void xows_cli_mam_fetch_query(n);xows_log(2,"cli_mam_collect",l+" gathered messages for",n.addr),xows_isfunc(i.onresult)&&i.onresult(n,null!==i.start,r,l,t),ds.delete(n)}function xows_cli_mam_fetch_query(e){if(!x_.includes(yo))return void xows_log(0,"cli_mam_fetch_query","MAM feature not available");if(!ds.has(e))return;const o=ds.get(e);e.type===b_?xows_xmp_mam_query(e.addr,o.max,null,o.start,o.end,null,xows_cli_mam_fetch_parse):xows_xmp_mam_query(null,o.max,e.addr,o.start,o.end,null,xows_cli_mam_fetch_parse)}function xows_cli_mam_fetch(e,o,_,s,t){if(!x_.includes(yo))return xows_log(1,"cli_mam_fetch","MAM feature not available"),void(xows_isfunc(t)&&t(e,null!==_,[],0,!0));if(ds.has(e))return;xows_log(2,"cli_mam_fetch","fetch history for",e.addr);const n={peer:e,need:o,max:o,start:_,end:s,onresult:t,pool:[]};ds.set(e,n),xows_cli_mam_fetch_query(e)}const xs=1,ws=2,ps=3,ms=4;let gs=function(){},fs=function(){};const hs=new Map;function xows_cli_upld_has(e){return hs.has(e)}function xows_cli_upld_query(e,o){if(hs.has(e))return void xows_log(1,"cli_upld_query","Upload already pending",e.name);if(!w_.has(Ao))return void xows_log(1,"cli_upld_query","No suitable service unavailable");hs.set(e,{file:o});const _=xows_gen_uuid();hs.set(_,e),xows_xmp_upld_query(w_.get(Ao)[0],_,o.name,o.size,o.type,xows_cli_upld_parse)}function xows_cli_upld_parse(e,o,_,s,t){const n=hs.get(e);hs.delete(e);const c=hs.get(n);if(t){const e=xows_xml_beatify_tag(t.upld?t.upld:t.name);return fs(n,ps,e),void hs.delete(n)}c.url=s;const i=new XMLHttpRequest;c.xhr=i,i.upload.onprogress=(e=>{xows_cli_upld_onprogr(n,e)}),i.upload.onabort=(e=>{xows_cli_upld_onabort(n,e)}),i.upload.onerror=(e=>{xows_cli_upld_onerror(n,e)}),i.onreadystatechange=(()=>{xows_cli_upld_onstate(n,i)}),i.open("PUT",o,!0),i.setRequestHeader("Content-Type","main_menucation/octet-stream");for(let e=0;e<_.length;++e)i.setRequestHeader(_[e].name,_[e].data);i.send(c.file)}function xows_cli_upld_abort(e){if(!hs.has(e))return void xows_log(1,"cli_upld_abort","No pending download",e.name);hs.get(e).xhr.abort()}function xows_cli_upld_onprogr(e,o){hs.get(e);gs(e,o.loaded/o.total*100)}function xows_cli_upld_onstate(e,o){if(4===o.readyState){const _=hs.get(e);if(201===o.status)setTimeout(fs,500,e,xs,_.url);else{const _=o.statusText+" ("+o.status+")";fs(e,ms,_)}hs.delete(e)}}function xows_cli_upld_onerror(e,o){fs(e,ms,xows_l10n_get("HTTP server unreachable")),hs.delete(e)}function xows_cli_upld_onabort(e,o){fs(e,ws,null),hs.delete(e)}let bs=function(){},ys=function(){},vs=function(){},Fs=function(){},ks=function(){},As=function(){},Es=function(){};const qs={stack:[],ondisco:null};function xows_cli_muc_list_parse(e,o){bs(null);for(let e=0;e<o.length;++e){xows_load_task_push(xows_cli_room_new(o[e].jid),I_,xows_cli_peer_push,255)}const _=qs;if(_.ondisco){for(let o=0;o<_.stack.length;++o)if(_.stack[o]===e){_.stack.splice(o,1);break}_.stack.length||(_.ondisco(),_.ondisco=null)}}function xows_cli_muc_list_query(e){if(!w_.has(Eo))return void xows_log(1,"cli_muc_discoitems_query","aborted","no MUC service available");const o=qs;xows_isfunc(e)&&(o.ondisco=e);const _=w_.get(Eo);for(let e=0,s=_.length;e<s;++e)o.ondisco&&o.stack.push(_[e]),xows_xmp_disco_items_query(_[e],xows_cli_muc_list_parse)}function xows_cli_muc_info_parse(e,o,_,s,t,n){let c=null;_.length>0&&(c=_[0].name);let i=xows_cli_room_get(e);i?c&&(i.name=c):i=xows_cli_room_new(e,c);for(let e=0;e<s.length;++e)"muc_public"===s[e]&&(i.publ=!0),"muc_hidden"===s[e]&&(i.publ=!1),"muc_passwordprotected"===s[e]&&(i.prot=!0),"muc_unsecured"===s[e]&&(i.prot=!1),"muc_membersonly"===s[e]&&(i.open=!1),"muc_open"===s[e]&&(i.open=!0),"muc_moderated"===s[e]&&(i.modr=!0),"muc_unmoderated"===s[e]&&(i.modr=!1),"muc_semianonymous"===s[e]&&(i.anon=!0),"muc_nonanonymous"===s[e]&&(i.anon=!1);if(t)for(let e=0;e<t.length;++e)"muc#roomconfig_roomname"===t[e].var&&t[e].value&&(i.name=t[e].value[0]),"muc#roominfo_description"===t[e].var&&t[e].value&&(i.desc=t[e].value[0]),"muc#roominfo_subject"===t[e].var&&t[e].value&&(i.subj=t[e].value[0]),"muc#roominfo_occupants"==t[e].var&&t[e].value&&(i.nocc=parseInt(t[e].value[0]));i.load&I_?xows_load_task_done(i,I_):xows_cli_peer_push(i,C_|S_)}function xows_cli_muc_info_query(e){xows_xmp_disco_info_query(e.addr,null,xows_cli_muc_info_parse)}function xows_cli_muc_nick_parse(e,o,_){let s=xows_cli_room_get(e);s?(null!==o?(s.nick=o,s.affi=Po):s.nick="",s.load&N_&&xows_load_task_done(s,N_)):xows_log(1,"cli_muc_join_nick_result","unknown/unsubscribed Room",e)}function xows_cli_muc_nick_query(e){xows_xmp_muc_nick_query(e.addr,xows_cli_muc_nick_parse)}function xows_cli_muc_join(e,o){if("string"==typeof e){let o;if(xows_isjid(e))o=e;else{if(!w_.has(Eo))return void xows_log(1,"cli_muc_join","aborted","no MUC service available");o=e.toLowerCase()+"@"+w_.get(Eo)[0]}e=xows_cli_room_new(o)}else if(e.join)return;if(e.pass=o,null===e.nick)xows_load_task_push(e,N_,xows_cli_muc_join);else{bs(e);let o=e.addr+"/";o+=e.nick?e.nick:F_.name;const _={pass:e.pass};xows_xmp_presence_send(o,null,F_.show,F_.stat,null,_,F_.avat)}}function xows_cli_muc_leave(e){xows_xmp_presence_send(e.join,"unavailable")}function xows_cli_muc_onpres(e,o,_,s,t,n){let c,i=xows_cli_room_get(e);if(!i)return void xows_log(1,"cli_muc_onpres","unknown/unsubscribed Room",e);if(xows_log(2,"cli_muc_onpres","received occupant",e),s.code.includes(110))if(c=!0,o>Ie)null===i.join&&(i.join=e,s.code.includes(201)?(xows_log(2,"cli_muc_onpres","own room creation",e),i.init=!0,bs(i,255),vs(i)):(xows_log(2,"cli_muc_onpres","own room join",e),xows_cli_muc_info_query(i),xows_load_task_push(i,M_,vs)));else if(!s.code.includes(303)){xows_log(2,"cli_muc_onpres","own room leave",e),i.join=null;for(let e=0;e<i.occu.length;++e)xows_cli_ocpm_has(i.occu[e])&&Q_(i.occu[e]);return i.occu.length=0,void Fs(i,s)}let r=0,l=xows_cli_occu_get(i,e,t);if(l)if(o>Ie)l.addr!==e&&(l.addr=e,l.jlck=e,l.jrpc=e,l.name=xows_jid_resc(e),r|=C_);else{if(!s.code.includes(303))return l.show=o,xows_cli_ocpm_has(l)&&Q_(l),void As(l);{s.prev=l.addr,l.name=s.nick;const e=i.addr+"/"+l.name;l.addr=e,l.jlck=e,l.self&&(i.join=e),r|=C_}}else l=xows_cli_occu_new(i,e,t,s.jful,null,c);o!==l.show&&(l.show=o,r|=q_),_!==l.stat&&(l.stat=_,r|=S_),l.affi=s.affi,l.role=s.role,l.jful=s.jful,l.jbar=s.jful?xows_jid_bare(s.jful):null,c&&(i.role=s.role,i.affi!==s.affi&&(i.affi=s.affi,bs(i,255)));let a=0;"string"==typeof n?n.length>0?n!==l.avat&&(xows_cach_avat_has(n)?l.avat=n:a|=D_,r|=T_):l.avat=null:l.avat||(a|=D_,r|=T_),xows_load_task_push(l,a,xows_cli_peer_push,r,s)}function xows_cli_muc_onnoti(e,o,_){const s=xows_cli_room_get(o);if(s){for(let e=0;e<_.length;++e)_[e];_.includes(104)&&xows_cli_muc_info_query(s)}else xows_log(1,"cli_xmp_onsubject","unknown/unsubscribed JID",o)}function xows_cli_muc_onsubj(e,o,_){const s=xows_cli_room_get(o);s?(s.subj=_,Es(s,_),s.load&M_&&xows_load_task_done(s,M_)):xows_log(1,"cli_xmp_onsubject","unknown/unsubscribed JID",o)}function xows_cli_muc_nick_set(e,o){xows_xmp_presence_send(e.addr+"/"+o,null,F_.show,F_.stat,null,null,F_.avat)}function xows_cli_muc_subj_set(e,o){xows_xmp_muc_subject_send(e.addr,o)}function xows_cli_muc_affi_set(e,o){xows_xmp_muc_affi_set_query(e.room.addr,{jid:e.jbar,affi:o},null)}function xows_cli_muc_role_set(e,o){xows_xmp_muc_role_set_query(e.room.addr,{nick:e.name,role:o},null)}const Ss=new Map;function xows_cli_muc_cfg_get_parse(e,o,_){const s=xows_cli_room_get(e);if(!s)return void xows_log(1,"cli_muc_cfg_get_parse","unknown/unsubscribed Room",e);const t=Ss.get(s);xows_isfunc(t)&&t(s,o),Ss.delete(s)}function xows_cli_muc_cfg_get(e,o){Ss.has(e)||(Ss.set(e,o),xows_xmp_muc_cfg_get_guery(e.addr,xows_cli_muc_cfg_get_parse))}function xows_cli_muc_cfg_set_parse(e,o,_){if("result"!==o)return;const s=xows_cli_room_get(e);if(!s)return void xows_log(1,"cli_muc_cfg_set_parse","unknown/unsubscribed Room",e);const t=Ss.get(s);xows_isfunc(t)&&t(s,o,_),s.init=!1,Ss.delete(s)}function xows_cli_muc_cfg_set_cancel(e,o){xows_xmp_muc_cfg_set_cancel(e.addr,o)}function xows_cli_muc_cfg_set(e,o,_){Ss.has(e)||(Ss.set(e,_),xows_xmp_muc_cfg_set_query(e.addr,o,xows_cli_muc_cfg_set_parse))}const Cs=new Map;function xows_cli_muc_regi_set_result(e,o,_){const s=xows_cli_room_get(e);if(!s)return void xows_log(1,"cli_muc_register_parse","unknown/unsubscribed Room",e);const t=Cs.get(s);"error"!==o&&(s.nick=t.nick),xows_isfunc(t.onresult)&&t.onresult(s,o,_),Cs.delete(s)}function xows_cli_muc_regi_get_result(e,o,_,s){const t=xows_cli_room_get(e);if(!t)return void xows_log(1,"cli_muc_regi_get_result","unknown/unsubscribed Room",e);const n=Cs.get(t);if(s)return xows_isfunc(n.onresult)&&n.onresult(t,"error",s),void Cs.delete(t);if(o.registered)return t.nick=n.nick,xows_isfunc(n.onresult)&&n.onresult(t,"registered",null),void Cs.delete(t);if(_)for(let e=0,o=_.length;e<o;++e)"muc#register_roomnick"===_[e].var&&(_[e].value=[n.nick]);xows_xmp_regi_set_query(e,null,_,xows_cli_muc_regi_set_result)}function xows_cli_muc_regi_get_query(e,o,_){Cs.has(e)||(Cs.set(e,{onresult:_,nick:o}),xows_xmp_regi_get_query(e.addr,xows_cli_muc_regi_get_result))}function xows_cli_muc_destroy_result(e,o,_){const s=xows_cli_room_get(e);if(s){if(_)return xows_log(1,"cli_muc_destroy_result","Room destruction error",_.name),void P_(_);xows_log(2,"cli_muc_destroy_result","Room destroyed",s.addr),ys(s)}else xows_log(1,"cli_muc_destroy_result","unknown/unsubscribed Room",e)}function xows_cli_muc_destroy_query(e,o,_,s){xows_xmp_muc_destroy_query(e.addr,o,_,s,xows_cli_muc_destroy_result)}const Ts={onresult:null,password:null,attempt:0};function xows_cli_regi_chpas_parse(e,o,_){const s=Ts;if("error"===e){if(s.attempt>0&&xows_isfunc(s.onparse)&&s.onparse(e,_),o)for(let e=0;e<o.length;++e)"username"===o[e].var&&(o[e].value=[R.user]),"old_password"===o[e].var&&(o[e].value=[R.pass]),"password"===o[e].var&&(o[e].value=[s.password]);s.attempt++,xows_xmp_regi_pass_set_query(null,null,o,xows_cli_regi_chpas_parse)}else R.pass=s.password,xows_isfunc(s.onparse)&&s.onparse(e,null),s.password=null}function xows_cli_regi_chpas(e,o){const _=Ts;_.onparse=o,_.password=e,_.attempt=0,xows_xmp_regi_pass_set_query(e,null,xows_cli_regi_chpas_parse)}function xows_cli_regi_remove(e,o,_){xows_xmp_regi_remove_query(e?e.addr:null,o,_)}const Ds=!0,js=!1,Is=0,Ns=1,Ms=2,Ls=3;let Bs=function(){},Ps=function(){},Rs=function(){},Os=function(){},Gs=function(){};const Us=new Map;function xows_cli_call_best_resc(e){if(e.type===y_)return e.addr;if(e.jlck!==e.jbar)return e.jlck;{let o=null;const _=Array.from(e.ress.values());return _.length&&(_.length>1&&(_.sort(function(e,o){return o.show-e.show}),_.sort(function(e,o){return o.prio-e.prio})),o=_[0].id),o?e.jbar+"/"+o:e.jbar}}function xows_cli_call_create(e,o,_){const s=xows_wrtc_new(xows_cli_extservs_get("stun","turn"),xows_cli_wrtc_onsdesc,xows_cli_wrtc_ontrack,xows_cli_wrtc_onstate,xows_cli_wrtc_onerror,e),t={sid:null,ste:_};return xows_def_readonly(t,"dir",o),xows_def_readonly(t,"rpc",s),xows_def_readonly(t,"loc",{pnd:!1,sdp:null,str:null}),xows_def_readonly(t,"rmt",{pnd:!1,sdp:null,str:null}),Object.seal(t),Us.set(e,t),t}function xows_cli_call_exists(e){return Us.has(e)}function xows_cli_call_count(){return Us.size}function xows_cli_call_buzy(){for(const e of Us.values())if(e.ste>=Ms)return!0;return!1}function xows_cli_call_misd(e){const o=Us.get(e);return o.dir===Ds&&o.ste===Is&&!o.loc.sdp}function xows_cli_call_medias(e){const o=Us.get(e);let _=null;o.rmt.str?_={audio:o.rmt.str.getAudioTracks().length>0,video:o.rmt.str.getVideoTracks().length>0}:o.rmt.sdp&&(_=xows_sdp_get_medias(o.rmt.sdp));let s=null;o.loc.str?s={audio:o.loc.str.getAudioTracks().length>0,video:o.loc.str.getVideoTracks().length>0}:o.loc.sdp&&(s=xows_sdp_get_medias(o.loc.sdp));let t=o.dir===Ds?_:s,n=o.dir===Ds?s:_;return n&&(t.audio=t.audio&&n.audio,t.video=t.video&&n.video),xows_log(2,"xows_cli_call_medias","selected medias","audio="+t.audio+" video="+t.video),t}function xows_cli_call_is_inbd(e){return Us.get(e).dir===Ds}function xows_cli_call_is_cntd(e){return Us.get(e).ste===Ls}function xows_cli_call_peer_list(){return Array.from(Us.keys())}function xows_cli_call_self_mute(e,o,_){if(!Us.has(e))return;const s=Us.get(e),t=s.loc.str;let n;switch(o){case"video":n=t.getVideoTracks();break;case"audio":n=t.getAudioTracks();break;default:n=t.getTracks()}for(let e=0;e<n.length;++e)n[e].enabled=!_;const c=_?"mute":"unmute";xows_xmp_jing_info(e.jrpc,s.sid,c,{name:o},xows_cli_call_jing_parse)}function xows_cli_call_self_hold(e,o,_){if(!Us.has(e))return;const s=Us.get(e),t=s.rmt.str.getAudioTracks();for(let e=0;e<t.length;++e)t[e].enabled=!_;const n=_?"hold":"unhold";xows_xmp_jing_info(e.jrpc,s.sid,n,xows_cli_call_jing_parse)}function xows_cli_call_clear(e){if(!Us.has(e))return;const o=Us.get(e);if(o.loc.str)for(const e of o.loc.str.getTracks())e.stop();if(o.rmt.str)for(const e of o.rmt.str.getTracks())e.stop();o.rpc&&xows_wrtc_close(o.rpc),Us.delete(e),e.jrpc=null}function xows_cli_call_self_invite(e,o,_){e.jrpc=xows_cli_call_best_resc(e);const s=xows_cli_call_create(e,js,Ms),t=new MediaStream;for(const e of o.getAudioTracks())t.addTrack(e);if(_)for(const e of _.getVideoTracks())t.addTrack(e);s.loc.str=t,xows_wrtc_set_local_stream(s.rpc,t)}function xows_cli_call_self_accept(e,o,_){if(!Us.has(e))return void xows_log(1,"cli_call_accept","No open session for",e.addr);const s=Us.get(e);s.ste=Ms;const t=new MediaStream;for(const e of o.getAudioTracks())t.addTrack(e);if(_)for(const e of _.getVideoTracks())t.addTrack(e);s.loc.str=t,xows_wrtc_set_local_stream(s.rpc,t)}function xows_cli_call_self_hangup(e,o){if(!Us.has(e))return;const _=Us.get(e);_.sid&&(o||(o="success"),xows_xmp_jing_terminate(e.jrpc,_.sid,o)),xows_cli_call_clear(e)}function xows_cli_call_peer_invite(e,o,_,s){e.jrpc=o,e.type===y_&&xows_cli_ocpm_add(e)&&$_(e);const t=xows_cli_call_create(e,Ds,Ns);t.sid=_,t.rmt.sdp=s,xows_wrtc_set_remote_sdp(t.rpc,s)}function xows_cli_call_peer_accept(e,o){const _=Us.get(e);_.rmt.sdp=o,xows_wrtc_set_remote_sdp(_.rpc,o)}function xows_cli_call_peer_hangup(e,o){Us.get(e).ste=Is,Os(e,o),xows_cli_call_clear(e)}function xows_cli_call_jing_parse(e,o,_){const s=xows_cli_peer_get(e,v_);s?"error"===o&&(Gs(s,!1,_),xows_cli_call_clear(s)):xows_log(1,"cli_jing_parse","unknown/unsubscribed JID",e)}function xows_cli_call_jing_onrecv(e,o,_,s,t){const n=xows_cli_peer_get(e,v_);if(!n)return xows_log(1,"cli_xmp_onjingle","refused "+s,"from unknow peer: "+e),void xows_xmp_iq_error_send(o,e,"cancel","service-unavailable");const c=Us.get(n);if(c&&c.sid&&c.sid!==_)return xows_log(1,"cli_xmp_onjingle","Invalid SID from",e),void xows_xmp_jing_error(o,e,"cancel","unknown-session","item-not-found");if("session-initiate"===s){if(c&&c.dir===js)return xows_log(1,"cli_xmp_onjingle","Unexpected offer from",e),void xows_xmp_jing_error(o,e,"cancel","tie-break","conflict")}else{if(!c)return xows_log(1,"cli_xmp_onjingle","Unknow SID from",e),void xows_xmp_jing_error(o,e,"cancel","unknown-session","item-not-found");if("session-accept"===s&&(c.rmt.sdp||c.dir===Ds))return xows_log(1,"cli_xmp_onjingle","Unexpected offer from",e),void xows_xmp_jing_error(o,e,"cancel","out-of-order","unexpected-request")}switch(s){case"session-initiate":xows_cli_call_peer_invite(n,e,_,t);break;case"session-accept":xows_cli_call_peer_accept(n,t);break;case"session-info":switch(t){case"ringing":case"active":case"hold":case"unhold":case"mute":case"unmute":break;default:return void xows_xmp_jing_error(o,e,"cancel","unsupported-info","feature-not-implemented")}Rs(n,t);break;case"session-terminate":xows_cli_call_peer_hangup(n,t);break;default:xows_xmp_iq_error_send(o,e,"cancel","bad-request")}xows_xmp_iq_result_send(o,e)}function xows_cli_wrtc_onsdesc(e,o,_){const s=Us.get(_);s.loc.sdp=o,s.dir===Ds?(xows_log(2,"cli_wrtc_onsdesc","Sending SPD answer to",_.addr),xows_xmp_jing_accept_sdp(_.jrpc,s.sid,o,xows_cli_call_jing_parse)):(xows_log(2,"cli_wrtc_onsdesc","Sending SPD offer to",_.addr),s.sid=xows_xmp_jing_initiate_sdp(_.jrpc,o,xows_cli_call_jing_parse))}function xows_cli_wrtc_ontrack(e,o,_){const s=Us.get(_);s.rmt.str=o,s.dir===Ds?(xows_log(2,"cli_wrtc_ontrack","Received offer stream from",_.addr),xows_xmp_jing_info(_.jrpc,s.sid,"ringing",xows_cli_call_jing_parse),Bs(_,o)):(xows_log(2,"cli_wrtc_ontrack","Received answer stream from",_.addr),Ps(_,o))}function xows_cli_wrtc_onstate(e,o,_){"connected"===o&&(Us.get(_).ste=Ls),Rs(_,o)}function xows_cli_wrtc_onerror(e,o,_){let s;s=o.errorCode?"failed-transport":"failed-application",Us.get(_).ste=Is,Gs(_,!0,o),xows_cli_call_self_hangup(_,s)}const Hs=1,zs=2,Vs=new DOMParser;let Ys=function(){},Js=[],Ks="dark";const Ws={100:"1F4AF",1234:"1F522",grinning:"1F600",smiley:"1F603",smile:"1F604",grin:"1F601",laughing:"1F606",sweat_smile:"1F605",rolling_on_the_floor_laughing:"1F923",joy:"1F602",slightly_smiling_face:"1F642",upside_down_face:"1F643",wink:"1F609",blush:"1F60A",innocent:"1F607",smiling_face_with_3_hearts:"1F970",heart_eyes:"1F60D","star-struck":"1F929",kissing_heart:"1F618",kissing:"1F617",kissing_closed_eyes:"1F61A",kissing_smiling_eyes:"1F619",yum:"1F60B",stuck_out_tongue:"1F61B",stuck_out_tongue_winking_eye:"1F61C",zany_face:"1F92A",stuck_out_tongue_closed_eyes:"1F61D",money_mouth_face:"1F911",hugging_face:"1F917",face_with_hand_over_mouth:"1F92D",shushing_face:"1F92B",thinking_face:"1F914",zipper_mouth_face:"1F910",face_with_raised_eyebrow:"1F928",neutral_face:"1F610",expressionless:"1F611",no_mouth:"1F636",smirk:"1F60F",unamused:"1F612",face_with_rolling_eyes:"1F644",grimacing:"1F62C",lying_face:"1F925",relieved:"1F60C",pensive:"1F614",sleepy:"1F62A",drooling_face:"1F924",sleeping:"1F634",mask:"1F637",face_with_thermometer:"1F912",face_with_head_bandage:"1F915",nauseated_face:"1F922",face_vomiting:"1F92E",sneezing_face:"1F927",hot_face:"1F975",cold_face:"1F976",woozy_face:"1F974",dizzy_face:"1F635",exploding_head:"1F92F",face_with_cowboy_hat:"1F920",partying_face:"1F973",sunglasses:"1F60E",nerd_face:"1F913",face_with_monocle:"1F9D0",confused:"1F615",worried:"1F61F",slightly_frowning_face:"1F641",open_mouth:"1F62E",hushed:"1F62F",astonished:"1F632",flushed:"1F633",pleading_face:"1F97A",frowning:"1F626",anguished:"1F627",fearful:"1F628",cold_sweat:"1F630",disappointed_relieved:"1F625",cry:"1F622",sob:"1F62D",scream:"1F631",confounded:"1F616",persevere:"1F623",disappointed:"1F61E",sweat:"1F613",weary:"1F629",tired_face:"1F62B",yawning_face:"1F971",triumph:"1F624",rage:"1F621",angry:"1F620",face_with_symbols_on_mouth:"1F92C",smiling_imp:"1F608",imp:"1F47F",skull:"1F480",hankey:"1F4A9",clown_face:"1F921",japanese_ogre:"1F479",japanese_goblin:"1F47A",ghost:"1F47B",alien:"1F47D",space_invader:"1F47E",robot_face:"1F916",smiley_cat:"1F63A",smile_cat:"1F638",joy_cat:"1F639",heart_eyes_cat:"1F63B",smirk_cat:"1F63C",kissing_cat:"1F63D",scream_cat:"1F640",crying_cat_face:"1F63F",pouting_cat:"1F63E",see_no_evil:"1F648",hear_no_evil:"1F649",speak_no_evil:"1F64A",kiss:"1F48B",love_letter:"1F48C",cupid:"1F498",gift_heart:"1F49D",sparkling_heart:"1F496",heartpulse:"1F497",heartbeat:"1F493",revolving_hearts:"1F49E",two_hearts:"1F495",heart_decoration:"1F49F",broken_heart:"1F494",orange_heart:"1F9E1",yellow_heart:"1F49B",green_heart:"1F49A",blue_heart:"1F499",purple_heart:"1F49C",brown_heart:"1F90E",black_heart:"1F5A4",white_heart:"1F90D",anger:"1F4A2",boom:"1F4A5",dizzy:"1F4AB",sweat_drops:"1F4A6",dash:"1F4A8",bomb:"1F4A3",speech_balloon:"1F4AC",thought_balloon:"1F4AD",zzz:"1F4A4",wave:"1F44B",raised_back_of_hand:"1F91A",hand:"270B","spock-hand":"1F596",ok_hand:"1F44C",pinching_hand:"1F90F",crossed_fingers:"1F91E",i_love_you_hand_sign:"1F91F",the_horns:"1F918",call_me_hand:"1F919",point_left:"1F448",point_right:"1F449",point_up_2:"1F446",middle_finger:"1F595",point_down:"1F447","+1":"1F44D","-1":"1F44E",fist:"270A",facepunch:"1F44A","left-facing_fist":"1F91B","right-facing_fist":"1F91C",clap:"1F44F",raised_hands:"1F64C",open_hands:"1F450",palms_up_together:"1F932",handshake:"1F91D",pray:"1F64F",nail_care:"1F485",selfie:"1F933",muscle:"1F4AA",mechanical_arm:"1F9BE",mechanical_leg:"1F9BF",leg:"1F9B5",foot:"1F9B6",ear:"1F442",ear_with_hearing_aid:"1F9BB",nose:"1F443",brain:"1F9E0",tooth:"1F9B7",bone:"1F9B4",eyes:"1F440",tongue:"1F445",lips:"1F444",baby:"1F476",child:"1F9D2",boy:"1F466",girl:"1F467",adult:"1F9D1",person_with_blond_hair:"1F471",man:"1F468",bearded_person:"1F9D4",woman:"1F469",older_adult:"1F9D3",older_man:"1F474",older_woman:"1F475",person_frowning:"1F64D",person_with_pouting_face:"1F64E",no_good:"1F645",ok_woman:"1F646",information_desk_person:"1F481",raising_hand:"1F64B",deaf_person:"1F9CF",bow:"1F647",face_palm:"1F926",shrug:"1F937",cop:"1F46E",guardsman:"1F482",construction_worker:"1F477",prince:"1F934",princess:"1F478",man_with_turban:"1F473",man_with_gua_pi_mao:"1F472",person_with_headscarf:"1F9D5",man_in_tuxedo:"1F935",bride_with_veil:"1F470",pregnant_woman:"1F930","breast-feeding":"1F931",angel:"1F47C",santa:"1F385",mrs_claus:"1F936",superhero:"1F9B8",supervillain:"1F9B9",mage:"1F9D9",fairy:"1F9DA",vampire:"1F9DB",merperson:"1F9DC",elf:"1F9DD",genie:"1F9DE",zombie:"1F9DF",massage:"1F486",haircut:"1F487",walking:"1F6B6",standing_person:"1F9CD",kneeling_person:"1F9CE",runner:"1F3C3",dancer:"1F483",man_dancing:"1F57A",dancers:"1F46F",person_in_steamy_room:"1F9D6",person_climbing:"1F9D7",fencer:"1F93A",horse_racing:"1F3C7",snowboarder:"1F3C2",surfer:"1F3C4",rowboat:"1F6A3",swimmer:"1F3CA",bicyclist:"1F6B4",mountain_bicyclist:"1F6B5",person_doing_cartwheel:"1F938",wrestlers:"1F93C",water_polo:"1F93D",handball:"1F93E",juggling:"1F939",person_in_lotus_position:"1F9D8",bath:"1F6C0",sleeping_accommodation:"1F6CC",two_women_holding_hands:"1F46D",couple:"1F46B",two_men_holding_hands:"1F46C",couplekiss:"1F48F",couple_with_heart:"1F491",family:"1F46A",bust_in_silhouette:"1F464",busts_in_silhouette:"1F465",footprints:"1F463",monkey_face:"1F435",monkey:"1F412",gorilla:"1F98D",orangutan:"1F9A7",dog:"1F436",dog2:"1F415",guide_dog:"1F9AE",poodle:"1F429",wolf:"1F43A",fox_face:"1F98A",raccoon:"1F99D",cat:"1F431",cat2:"1F408",lion_face:"1F981",tiger:"1F42F",tiger2:"1F405",leopard:"1F406",horse:"1F434",racehorse:"1F40E",unicorn_face:"1F984",zebra_face:"1F993",deer:"1F98C",cow:"1F42E",ox:"1F402",water_buffalo:"1F403",cow2:"1F404",pig:"1F437",pig2:"1F416",boar:"1F417",pig_nose:"1F43D",ram:"1F40F",sheep:"1F411",goat:"1F410",dromedary_camel:"1F42A",camel:"1F42B",llama:"1F999",giraffe_face:"1F992",elephant:"1F418",rhinoceros:"1F98F",hippopotamus:"1F99B",mouse:"1F42D",mouse2:"1F401",rat:"1F400",hamster:"1F439",rabbit:"1F430",rabbit2:"1F407",hedgehog:"1F994",bat:"1F987",bear:"1F43B",koala:"1F428",panda_face:"1F43C",sloth:"1F9A5",otter:"1F9A6",skunk:"1F9A8",kangaroo:"1F998",badger:"1F9A1",feet:"1F43E",turkey:"1F983",chicken:"1F414",rooster:"1F413",hatching_chick:"1F423",baby_chick:"1F424",hatched_chick:"1F425",bird:"1F426",penguin:"1F427",eagle:"1F985",duck:"1F986",swan:"1F9A2",owl:"1F989",flamingo:"1F9A9",peacock:"1F99A",parrot:"1F99C",frog:"1F438",crocodile:"1F40A",turtle:"1F422",lizard:"1F98E",snake:"1F40D",dragon_face:"1F432",dragon:"1F409",sauropod:"1F995","t-rex":"1F996",whale:"1F433",whale2:"1F40B",dolphin:"1F42C",fish:"1F41F",tropical_fish:"1F420",blowfish:"1F421",shark:"1F988",octopus:"1F419",shell:"1F41A",snail:"1F40C",butterfly:"1F98B",bug:"1F41B",ant:"1F41C",bee:"1F41D",beetle:"1F41E",cricket:"1F997",scorpion:"1F982",mosquito:"1F99F",microbe:"1F9A0",bouquet:"1F490",cherry_blossom:"1F338",white_flower:"1F4AE",rose:"1F339",wilted_flower:"1F940",hibiscus:"1F33A",sunflower:"1F33B",blossom:"1F33C",tulip:"1F337",seedling:"1F331",evergreen_tree:"1F332",deciduous_tree:"1F333",palm_tree:"1F334",cactus:"1F335",ear_of_rice:"1F33E",herb:"1F33F",four_leaf_clover:"1F340",maple_leaf:"1F341",fallen_leaf:"1F342",leaves:"1F343",grapes:"1F347",melon:"1F348",watermelon:"1F349",tangerine:"1F34A",lemon:"1F34B",banana:"1F34C",pineapple:"1F34D",mango:"1F96D",apple:"1F34E",green_apple:"1F34F",pear:"1F350",peach:"1F351",cherries:"1F352",strawberry:"1F353",kiwifruit:"1F95D",tomato:"1F345",coconut:"1F965",avocado:"1F951",eggplant:"1F346",potato:"1F954",carrot:"1F955",corn:"1F33D",cucumber:"1F952",leafy_green:"1F96C",broccoli:"1F966",garlic:"1F9C4",onion:"1F9C5",mushroom:"1F344",peanuts:"1F95C",chestnut:"1F330",bread:"1F35E",croissant:"1F950",baguette_bread:"1F956",pretzel:"1F968",bagel:"1F96F",pancakes:"1F95E",waffle:"1F9C7",cheese_wedge:"1F9C0",meat_on_bone:"1F356",poultry_leg:"1F357",cut_of_meat:"1F969",bacon:"1F953",hamburger:"1F354",fries:"1F35F",pizza:"1F355",hotdog:"1F32D",sandwich:"1F96A",taco:"1F32E",burrito:"1F32F",stuffed_flatbread:"1F959",falafel:"1F9C6",egg:"1F95A",fried_egg:"1F373",shallow_pan_of_food:"1F958",stew:"1F372",bowl_with_spoon:"1F963",green_salad:"1F957",popcorn:"1F37F",butter:"1F9C8",salt:"1F9C2",canned_food:"1F96B",bento:"1F371",rice_cracker:"1F358",rice_ball:"1F359",rice:"1F35A",curry:"1F35B",ramen:"1F35C",spaghetti:"1F35D",sweet_potato:"1F360",oden:"1F362",sushi:"1F363",fried_shrimp:"1F364",fish_cake:"1F365",moon_cake:"1F96E",dango:"1F361",dumpling:"1F95F",fortune_cookie:"1F960",takeout_box:"1F961",crab:"1F980",lobster:"1F99E",shrimp:"1F990",squid:"1F991",oyster:"1F9AA",icecream:"1F366",shaved_ice:"1F367",ice_cream:"1F368",doughnut:"1F369",cookie:"1F36A",birthday:"1F382",cake:"1F370",cupcake:"1F9C1",pie:"1F967",chocolate_bar:"1F36B",candy:"1F36C",lollipop:"1F36D",custard:"1F36E",honey_pot:"1F36F",baby_bottle:"1F37C",glass_of_milk:"1F95B",coffee:"2615",tea:"1F375",sake:"1F376",champagne:"1F37E",wine_glass:"1F377",cocktail:"1F378",tropical_drink:"1F379",beer:"1F37A",beers:"1F37B",clinking_glasses:"1F942",tumbler_glass:"1F943",cup_with_straw:"1F964",beverage_box:"1F9C3",mate_drink:"1F9C9",ice_cube:"1F9CA",chopsticks:"1F962",fork_and_knife:"1F374",spoon:"1F944",hocho:"1F52A",amphora:"1F3FA",eyeglasses:"1F453",goggles:"1F97D",lab_coat:"1F97C",safety_vest:"1F9BA",necktie:"1F454",shirt:"1F455",jeans:"1F456",scarf:"1F9E3",gloves:"1F9E4",coat:"1F9E5",socks:"1F9E6",dress:"1F457",kimono:"1F458",sari:"1F97B","one-piece_swimsuit":"1FA71",briefs:"1FA72",shorts:"1FA73",bikini:"1F459",womans_clothes:"1F45A",purse:"1F45B",handbag:"1F45C",pouch:"1F45D",school_satchel:"1F392",mans_shoe:"1F45E",athletic_shoe:"1F45F",hiking_boot:"1F97E",womans_flat_shoe:"1F97F",high_heel:"1F460",sandal:"1F461",ballet_shoes:"1FA70",boot:"1F462",crown:"1F451",womans_hat:"1F452",tophat:"1F3A9",mortar_board:"1F393",billed_cap:"1F9E2",prayer_beads:"1F4FF",lipstick:"1F484",ring:"1F48D",gem:"1F48E",mute:"1F507",speaker:"1F508",sound:"1F509",loud_sound:"1F50A",loudspeaker:"1F4E2",mega:"1F4E3",postal_horn:"1F4EF",bell:"1F514",no_bell:"1F515",musical_score:"1F3BC",musical_note:"1F3B5",notes:"1F3B6",microphone:"1F3A4",headphones:"1F3A7",radio:"1F4FB",saxophone:"1F3B7",guitar:"1F3B8",musical_keyboard:"1F3B9",trumpet:"1F3BA",violin:"1F3BB",banjo:"1FA95",drum_with_drumsticks:"1F941",iphone:"1F4F1",calling:"1F4F2",telephone_receiver:"1F4DE",pager:"1F4DF",fax:"1F4E0",battery:"1F50B",electric_plug:"1F50C",computer:"1F4BB",minidisc:"1F4BD",floppy_disk:"1F4BE",cd:"1F4BF",dvd:"1F4C0",abacus:"1F9EE",movie_camera:"1F3A5",clapper:"1F3AC",tv:"1F4FA",camera:"1F4F7",camera_with_flash:"1F4F8",video_camera:"1F4F9",vhs:"1F4FC",mag:"1F50D",mag_right:"1F50E",bulb:"1F4A1",flashlight:"1F526",izakaya_lantern:"1F3EE",diya_lamp:"1FA94",notebook_with_decorative_cover:"1F4D4",closed_book:"1F4D5",book:"1F4D6",green_book:"1F4D7",blue_book:"1F4D8",orange_book:"1F4D9",books:"1F4DA",notebook:"1F4D3",ledger:"1F4D2",page_with_curl:"1F4C3",scroll:"1F4DC",page_facing_up:"1F4C4",newspaper:"1F4F0",bookmark_tabs:"1F4D1",bookmark:"1F516",moneybag:"1F4B0",yen:"1F4B4",dollar:"1F4B5",euro:"1F4B6",pound:"1F4B7",money_with_wings:"1F4B8",credit_card:"1F4B3",receipt:"1F9FE",chart:"1F4B9",currency_exchange:"1F4B1",heavy_dollar_sign:"1F4B2","e-mail":"1F4E7",incoming_envelope:"1F4E8",envelope_with_arrow:"1F4E9",outbox_tray:"1F4E4",inbox_tray:"1F4E5",package:"1F4E6",mailbox:"1F4EB",mailbox_closed:"1F4EA",mailbox_with_mail:"1F4EC",mailbox_with_no_mail:"1F4ED",postbox:"1F4EE",memo:"1F4DD",briefcase:"1F4BC",file_folder:"1F4C1",open_file_folder:"1F4C2",date:"1F4C5",calendar:"1F4C6",card_index:"1F4C7",chart_with_upwards_trend:"1F4C8",chart_with_downwards_trend:"1F4C9",bar_chart:"1F4CA",clipboard:"1F4CB",pushpin:"1F4CC",round_pushpin:"1F4CD",paperclip:"1F4CE",straight_ruler:"1F4CF",triangular_ruler:"1F4D0",lock:"1F512",unlock:"1F513",lock_with_ink_pen:"1F50F",closed_lock_with_key:"1F510",key:"1F511",hammer:"1F528",axe:"1FA93",gun:"1F52B",bow_and_arrow:"1F3F9",wrench:"1F527",nut_and_bolt:"1F529",probing_cane:"1F9AF",link:"1F517",toolbox:"1F9F0",magnet:"1F9F2",test_tube:"1F9EA",petri_dish:"1F9EB",dna:"1F9EC",microscope:"1F52C",telescope:"1F52D",satellite_antenna:"1F4E1",syringe:"1F489",drop_of_blood:"1FA78",pill:"1F48A",adhesive_bandage:"1FA79",stethoscope:"1FA7A",door:"1F6AA",chair:"1FA91",toilet:"1F6BD",shower:"1F6BF",bathtub:"1F6C1",razor:"1FA92",lotion_bottle:"1F9F4",safety_pin:"1F9F7",broom:"1F9F9",basket:"1F9FA",roll_of_paper:"1F9FB",soap:"1F9FC",sponge:"1F9FD",fire_extinguisher:"1F9EF",shopping_trolley:"1F6D2",smoking:"1F6AC",moyai:"1F5FF",earth_africa:"1F30D",earth_americas:"1F30E",earth_asia:"1F30F",globe_with_meridians:"1F310",japan:"1F5FE",compass:"1F9ED",volcano:"1F30B",mount_fuji:"1F5FB",bricks:"1F9F1",house:"1F3E0",house_with_garden:"1F3E1",office:"1F3E2",post_office:"1F3E3",european_post_office:"1F3E4",hospital:"1F3E5",bank:"1F3E6",hotel:"1F3E8",love_hotel:"1F3E9",convenience_store:"1F3EA",school:"1F3EB",department_store:"1F3EC",factory:"1F3ED",japanese_castle:"1F3EF",european_castle:"1F3F0",wedding:"1F492",tokyo_tower:"1F5FC",statue_of_liberty:"1F5FD",church:"26EA",mosque:"1F54C",hindu_temple:"1F6D5",synagogue:"1F54D",kaaba:"1F54B",fountain:"26F2",tent:"26FA",foggy:"1F301",night_with_stars:"1F303",sunrise_over_mountains:"1F304",sunrise:"1F305",city_sunset:"1F306",city_sunrise:"1F307",bridge_at_night:"1F309",carousel_horse:"1F3A0",ferris_wheel:"1F3A1",roller_coaster:"1F3A2",barber:"1F488",circus_tent:"1F3AA",steam_locomotive:"1F682",railway_car:"1F683",bullettrain_side:"1F684",bullettrain_front:"1F685",train2:"1F686",metro:"1F687",light_rail:"1F688",station:"1F689",tram:"1F68A",monorail:"1F69D",mountain_railway:"1F69E",train:"1F68B",bus:"1F68C",oncoming_bus:"1F68D",trolleybus:"1F68E",minibus:"1F690",ambulance:"1F691",fire_engine:"1F692",police_car:"1F693",oncoming_police_car:"1F694",taxi:"1F695",oncoming_taxi:"1F696",car:"1F697",oncoming_automobile:"1F698",blue_car:"1F699",truck:"1F69A",articulated_lorry:"1F69B",tractor:"1F69C",motor_scooter:"1F6F5",manual_wheelchair:"1F9BD",motorized_wheelchair:"1F9BC",auto_rickshaw:"1F6FA",bike:"1F6B2",scooter:"1F6F4",skateboard:"1F6F9",busstop:"1F68F",fuelpump:"26FD",rotating_light:"1F6A8",traffic_light:"1F6A5",vertical_traffic_light:"1F6A6",octagonal_sign:"1F6D1",construction:"1F6A7",anchor:"2693",boat:"26F5",canoe:"1F6F6",speedboat:"1F6A4",ship:"1F6A2",airplane_departure:"1F6EB",airplane_arriving:"1F6EC",parachute:"1FA82",seat:"1F4BA",helicopter:"1F681",suspension_railway:"1F69F",mountain_cableway:"1F6A0",aerial_tramway:"1F6A1",rocket:"1F680",flying_saucer:"1F6F8",luggage:"1F9F3",hourglass:"231B",hourglass_flowing_sand:"23F3",watch:"231A",alarm_clock:"23F0",clock12:"1F55B",clock1230:"1F567",clock1:"1F550",clock130:"1F55C",clock2:"1F551",clock230:"1F55D",clock3:"1F552",clock330:"1F55E",clock4:"1F553",clock430:"1F55F",clock5:"1F554",clock530:"1F560",clock6:"1F555",clock630:"1F561",clock7:"1F556",clock730:"1F562",clock8:"1F557",clock830:"1F563",clock9:"1F558",clock930:"1F564",clock10:"1F559",clock1030:"1F565",clock11:"1F55A",clock1130:"1F566",new_moon:"1F311",waxing_crescent_moon:"1F312",first_quarter_moon:"1F313",moon:"1F314",full_moon:"1F315",waning_gibbous_moon:"1F316",last_quarter_moon:"1F317",waning_crescent_moon:"1F318",crescent_moon:"1F319",new_moon_with_face:"1F31A",first_quarter_moon_with_face:"1F31B",last_quarter_moon_with_face:"1F31C",full_moon_with_face:"1F31D",sun_with_face:"1F31E",ringed_planet:"1FA90",star:"2B50",star2:"1F31F",stars:"1F320",milky_way:"1F30C",partly_sunny:"26C5",cyclone:"1F300",rainbow:"1F308",closed_umbrella:"1F302",umbrella_with_rain_drops:"2614",zap:"26A1",snowman_without_snow:"26C4",fire:"1F525",droplet:"1F4A7",ocean:"1F30A",jack_o_lantern:"1F383",christmas_tree:"1F384",fireworks:"1F386",sparkler:"1F387",firecracker:"1F9E8",sparkles:"2728",balloon:"1F388",tada:"1F389",confetti_ball:"1F38A",tanabata_tree:"1F38B",bamboo:"1F38D",dolls:"1F38E",flags:"1F38F",wind_chime:"1F390",rice_scene:"1F391",red_envelope:"1F9E7",ribbon:"1F380",gift:"1F381",ticket:"1F3AB",trophy:"1F3C6",sports_medal:"1F3C5",first_place_medal:"1F947",second_place_medal:"1F948",third_place_medal:"1F949",soccer:"26BD",baseball:"26BE",softball:"1F94E",basketball:"1F3C0",volleyball:"1F3D0",football:"1F3C8",rugby_football:"1F3C9",tennis:"1F3BE",flying_disc:"1F94F",bowling:"1F3B3",cricket_bat_and_ball:"1F3CF",field_hockey_stick_and_ball:"1F3D1",ice_hockey_stick_and_puck:"1F3D2",lacrosse:"1F94D",table_tennis_paddle_and_ball:"1F3D3",badminton_racquet_and_shuttlecock:"1F3F8",boxing_glove:"1F94A",martial_arts_uniform:"1F94B",goal_net:"1F945",golf:"26F3",fishing_pole_and_fish:"1F3A3",diving_mask:"1F93F",running_shirt_with_sash:"1F3BD",ski:"1F3BF",sled:"1F6F7",curling_stone:"1F94C",dart:"1F3AF","yo-yo":"1FA80",kite:"1FA81","8ball":"1F3B1",crystal_ball:"1F52E",nazar_amulet:"1F9FF",video_game:"1F3AE",slot_machine:"1F3B0",game_die:"1F3B2",jigsaw:"1F9E9",teddy_bear:"1F9F8",black_joker:"1F0CF",mahjong:"1F004",flower_playing_cards:"1F3B4",performing_arts:"1F3AD",art:"1F3A8",thread:"1F9F5",yarn:"1F9F6",atm:"1F3E7",put_litter_in_its_place:"1F6AE",potable_water:"1F6B0",wheelchair:"267F",mens:"1F6B9",womens:"1F6BA",restroom:"1F6BB",baby_symbol:"1F6BC",wc:"1F6BE",passport_control:"1F6C2",customs:"1F6C3",baggage_claim:"1F6C4",left_luggage:"1F6C5",children_crossing:"1F6B8",no_entry:"26D4",no_entry_sign:"1F6AB",no_bicycles:"1F6B3",no_smoking:"1F6AD",do_not_litter:"1F6AF","non-potable_water":"1F6B1",no_pedestrians:"1F6B7",no_mobile_phones:"1F4F5",underage:"1F51E",arrows_clockwise:"1F503",arrows_counterclockwise:"1F504",back:"1F519",end:"1F51A",on:"1F51B",soon:"1F51C",top:"1F51D",place_of_worship:"1F6D0",menorah_with_nine_branches:"1F54E",six_pointed_star:"1F52F",aries:"2648",taurus:"2649",gemini:"264A",cancer:"264B",leo:"264C",virgo:"264D",libra:"264E",scorpius:"264F",sagittarius:"2650",capricorn:"2651",aquarius:"2652",pisces:"2653",ophiuchus:"26CE",twisted_rightwards_arrows:"1F500",repeat:"1F501",repeat_one:"1F502",fast_forward:"23E9",rewind:"23EA",arrow_up_small:"1F53C",arrow_double_up:"23EB",arrow_down_small:"1F53D",arrow_double_down:"23EC",cinema:"1F3A6",low_brightness:"1F505",high_brightness:"1F506",signal_strength:"1F4F6",vibration_mode:"1F4F3",mobile_phone_off:"1F4F4",trident:"1F531",name_badge:"1F4DB",beginner:"1F530",o:"2B55",white_check_mark:"2705",x:"274C",negative_squared_cross_mark:"274E",heavy_plus_sign:"2795",heavy_minus_sign:"2796",heavy_division_sign:"2797",curly_loop:"27B0",loop:"27BF",question:"2753",grey_question:"2754",grey_exclamation:"2755",exclamation:"2757",keycap_ten:"1F51F",capital_abcd:"1F520",abcd:"1F521",symbols:"1F523",abc:"1F524",ab:"1F18E",cl:"1F191",cool:"1F192",free:"1F193",id:"1F194",new:"1F195",ng:"1F196",ok:"1F197",sos:"1F198",up:"1F199",vs:"1F19A",koko:"1F201",u6709:"1F236",u6307:"1F22F",ideograph_advantage:"1F250",u5272:"1F239",u7121:"1F21A",u7981:"1F232",accept:"1F251",u7533:"1F238",u5408:"1F234",u7a7a:"1F233",u55b6:"1F23A",u6e80:"1F235",red_circle:"1F534",large_orange_circle:"1F7E0",large_yellow_circle:"1F7E1",large_green_circle:"1F7E2",large_blue_circle:"1F535",large_purple_circle:"1F7E3",large_brown_circle:"1F7E4",black_circle:"26AB",white_circle:"26AA",large_red_square:"1F7E5",large_orange_square:"1F7E7",large_yellow_square:"1F7E8",large_green_square:"1F7E9",large_blue_square:"1F7E6",large_purple_square:"1F7EA",large_brown_square:"1F7EB",black_large_square:"2B1B",white_large_square:"2B1C",black_medium_small_square:"25FE",white_medium_small_square:"25FD",large_orange_diamond:"1F536",large_blue_diamond:"1F537",small_orange_diamond:"1F538",small_blue_diamond:"1F539",small_red_triangle:"1F53A",small_red_triangle_down:"1F53B",diamond_shape_with_a_dot_inside:"1F4A0",radio_button:"1F518",white_square_button:"1F533",black_square_button:"1F532"},Xs={":":{")":"1F642","(":"1F641",O:"1F62E",P:"1F61B",D:"1F604","*":"1F617","|":"1F610","#":"1F910",S:"1F616",$:"1F633","/":"1F615",".":"1F636",X:"1F922"},8:{")":"1F60E"},":'":{")":"1F602","(":"1F622",D:"1F923"},";":{")":"1F609",P:"1F61C"},X:{")":"1F606",D:"1F606",P:"1F61D"}};function xows_tpl_clean(e){for(let o=0;o<e.childNodes.length;++o){const _=e.childNodes[o];8===_.nodeType||3===_.nodeType&&!/\S/.test(_.nodeValue)?e.removeChild(_):1===_.nodeType&&xows_tpl_clean(_)}return e}function xows_tpl_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"embload":Zs=o;break;case"emberror":et=o}}function xows_tpl_init(e){e&&(Ys=e),Mn.gui_theme&&(Ks=Mn.gui_theme);const o=document.createElement("link");let _;o.rel="stylesheet",o.type="text/css",_=Mn.tpl_load_mincss?"/style.min.css":"/style.css",o.href=Mn.lib_path+"themes/"+Ks+_,Mn.tpl_force_uncache&&(o.href+="?"+xows_gen_nonce_asc(4)),document.head.appendChild(o),$s=0,Qs=document.createDocumentFragment(),xows_tpl_template_load("body")}let $s=0;function xows_tpl_template_load(e,o){let _=Mn.lib_path+"themes/"+Ks;switch(o){case Hs:_+="/import/";break;case zs:_+="/instanced/";break;default:_+="/"}_+=e+".html",Mn.tpl_force_uncache&&(_+="?"+xows_gen_nonce_asc(4));const s=new XMLHttpRequest;s.open("GET",_,!0),s._type=o,s.onreadystatechange=function(){4===this.readyState&&(200===this.status?xows_tpl_template_parse(this.responseText,this.responseURL,this._type):xows_init_failure(this.status,this.responseURL))},$s++,xows_log(2,"tpl_template_load","loading file",_),s.send()}let Qs=null;function xows_tpl_template_done(){for(;Qs.childNodes.length>0;)document.body.appendChild(Qs.firstChild);xows_log(2,"tpl_template_done","templates parsing completed"),Qs=null,Ys()}function xows_tpl_template_parse(e,o,_){xows_log(2,"tpl_template_parse","parsing template",o),e=xows_l10n_parse(e);const s=xows_tpl_clean(Vs.parseFromString(e,"text/html").body);if(!s)return void xows_log(0,"tpl_template_parse","template parse error",o);let t;const n=[],c=[];if(_!==zs){t=s.querySelectorAll("[XOWS_TPL_IMPORT]");for(let e=0;e<t.length;++e)t[e].id?(n.push(t[e].id),t[e].removeAttribute("XOWS_TPL_IMPORT")):xows_log(0,"tpl_template_parse","instance declared without id",o)}t=s.querySelectorAll("[XOWS_TPL_INSTANCED]");for(let e=0;e<t.length;++e)t[e].id?(c.push(t[e].id),t[e].parentNode.removeChild(t[e])):xows_log(0,"tpl_template_parse","instance declared without id",o);let i=o.substring(o.lastIndexOf("/")+1).split(".")[0];if(_===zs)s.firstElementChild?(Js[i]=document.createDocumentFragment(),Js[i].appendChild(s.firstElementChild)):xows_log(1,"tpl_template_parse","empty instanciable",i);else{let e=Qs.querySelector("#"+i);for(e||(e=Qs);s.children.length>0;)e.appendChild(s.firstElementChild);for(let e=0;e<n.length;++e)xows_tpl_template_load(n[e],Hs)}for(let e=0;e<c.length;++e)xows_tpl_template_load(c[e],zs);0===--$s&&xows_tpl_template_done()}let Zs=function(){},et=function(){};function xows_tpl_emld(e){Zs(e)}function xows_tpl_emer(e){et(e)}const ot=/^(?:http|https):\/\/(?:[!#$&-;=?-\[\]_a-z~]|%[0-9a-fA-F]{2})+/i,_t=/^```(.*?)\n(.+)```(?:\s?\n|\s?$)/s,st=/^`(\S.+?\S)`/,tt=/(^\*\S.*?[^\s\*]\*)(?:[^\*]|$)/,nt=/(^\*{2}\S.+?\S\*{2})(?:[^\*]|$)/,ct=/(^\*\S.+?\S\*)/,it=/^_\S.+?\S_/,rt=/^~\S.+?\S~/,lt=/^(>+?) .+[^>](?=\n|$)/,at=/^:([\w\-+]+):/,ut=/^([X8:;]|:')([()|DPXO#$.\/*sS])(?=\s|$)/i,dt=new Map([[38,"&amp;"],[60,"&lt;"],[62,"&gt;"],[39,"&apos;"],[34,"&quot;"],[10,"<br>"]]);function xows_tpl_parse_styling(e,o){if(!e||!e.length)return"";let _,s,t=0,n=0,c=!1,i=!1,r=0,l="",a=0;for(;a!==e.length;){if(s=e.charCodeAt(a),r&&10===e.charCodeAt(a-1)&&62!==s)for(;r;)l+="</blockquote>",r--;if(72!==s&&104!==s||!(_=ot.exec(e.substring(a)))){if(58===s||59===s||88===s||120===s||56===s){const o=e.substring(a);if(_=at.exec(o)){const e=Ws[_[1]];if(e){l+="<emo-ji>&#x"+e+";</emo-ji>",a+=_[0].length;continue}}if((0===a||32===e.charCodeAt(a-1))&&(_=ut.exec(o))){const e=Xs[_[1].toUpperCase()][_[2].toUpperCase()];if(e){l+="<emo-ji>&#x"+e+";</emo-ji>",a+=_[0].length;continue}}}if(s>47&&s<58||s>64&&s<91||s>96&&s<123)l+=e.charAt(a++);else if(s>55295&&s<57344)((s=65536+((1023&s)<<10|1023&e.charCodeAt(a+1)))>=8960&&s<=11263||s>=126976&&s<=129792)&&(l+="<emo-ji>&#x"+s.toString(16)+";</emo-ji>"),a+=2;else{if(42===s){if(n){if(n===a){l+="</b>",n=0,a+=2;continue}}else if(42===e.charCodeAt(a+1)&&(_=nt.exec(e.substring(a)))){n=a+(_[1].length-2),l+="<b>",a+=2;continue}if(t){if(t===a){l+="</i>",t=0,a++;continue}}else if(_=n?ct.exec(e.substring(a)):tt.exec(e.substring(a))){t=a+(_[1].length-1),l+="<i>",a++;continue}}if(95===s){if(c){c=!1,l+="</u>",a++;continue}if(c=it.test(e.substring(a))){l+="<u>",a++;continue}}if(126===s){if(i){i=!1,l+="</s>",a++;continue}if(i=rt.test(e.substring(a))){l+="<s>",a++;continue}}if(62===s&&(0===a||10===e.charCodeAt(a-1))){let o=0;for(;_=lt.exec(e.substring(a));)32===e.charCodeAt(a+1)?a+=2:a++,o++;if(o){for(;o>r;)l+="<blockquote>",r++;for(;o<r;)l+="</blockquote>",r--;continue}}if(96===s){const o=e.substring(a);if(_=st.exec(o)){l+="<code>"+_[1]+"</code>",a+=_[0].length;continue}if((0===a||10===e.charCodeAt(a-1))&&(_=_t.exec(o))){l+="<pre>"+_[2]+"</pre>",a+=_[0].length;continue}}dt.has(s)?l+=dt.get(s):l+=e.charAt(a),a++}}else o&&o.push(_[0]),l+='<a href="'+_[0]+'" target="_blank">'+_[0]+"</a>",a+=_[0].length}return l}function xows_tpl_as_iframe(e){return'<iframe sandbox="allow-scripts allow-same-origin" src="'+e+'"/>'}function xows_tpl_embed_wrap(e,o,_,s){let t="<embd-wrap class='";return _&&(t+=_),t+="'>",s&&(t+="<a href='"+e+"' target='_blank'>"+s+"</a>"),t+=o.replace(/src=/g,"loading='lazy' onload='xows_tpl_emld(this)' onerror='xows_tpl_emer(this)' src="),t+="</embd-wrap>"}function xows_tpl_embed_image(e,o){return xows_tpl_embed_wrap(e,'<img src="'+e+'">',"EMBD-IMG LOADING")}function xows_tpl_embed_movie(e,o){return xows_tpl_embed_wrap(e,'<video controls src="'+e+'"></video>',"EMBD-VID")}function xows_tpl_embed_audio(e,o){return xows_tpl_embed_wrap(e,'<audio controls src="'+e+'"/>',"EMBD-SND")}function xows_tpl_embed_youtube(e,o){const _=e.match(/(?:v=|embed\/|shorts\/|youtu\.be\/)([\w\-]+)(\?.+)?/);if(!_)return null;let s=_[1];return _[2]&&(s+=_[2].replace(/t=/,"start=")),xows_tpl_embed_wrap(e,xows_tpl_as_iframe("https://www.youtube.com/embed/"+s),"EMBD-IFR LOADING","YouTube")}function xows_tpl_embed_dailymo(e,o){const _=e.match(/(?:video|dai\.ly)\/([\w\d]+)/);return _?xows_tpl_embed_wrap(e,xows_tpl_as_iframe("https://www.dailymotion.com/embed/video/"+_[1]),"EMBD-IFR LOADING","Dailymotion"):null}function xows_tpl_embed_vimeo(e,o){const _=e.match(/\/([\d]+)/);return _?xows_tpl_embed_wrap(e,xows_tpl_as_iframe("https://player.vimeo.com/video/"+_[1]),"EMBD-IFR LOADING","Vimeo"):null}function xows_tpl_embed_odysee(e,o){const _=e.match(/.com\/(.*)/);return _?xows_tpl_embed_wrap(e,xows_tpl_as_iframe("https://odysee.com/$/embed/"+_[1]),"EMBD-IFR LOADING","Odysee"):null}function xows_tpl_embed_upld(e,o){return xows_tpl_embed_wrap(e,'<a class="dnld-btn" href="'+e+'" target="_blank"></a>',"EMBD-DNL",decodeURI(e.match(/(.+\/)*(.+\..+)/)[2]))}let xt={JPG:xows_tpl_embed_image,JPEG:xows_tpl_embed_image,GIF:xows_tpl_embed_image,PNG:xows_tpl_embed_image,WEBP:xows_tpl_embed_image,SVG:xows_tpl_embed_image,MP4:xows_tpl_embed_movie,MPEG:xows_tpl_embed_movie,AVI:xows_tpl_embed_movie,MP3:xows_tpl_embed_audio,OGG:xows_tpl_embed_audio},wt={"www.youtube.com":xows_tpl_embed_youtube,"youtu.be":xows_tpl_embed_youtube,"www.dailymotion.com":xows_tpl_embed_dailymo,"dai.ly":xows_tpl_embed_dailymo,"vimeo.com":xows_tpl_embed_vimeo,"odysee.com":xows_tpl_embed_odysee},pt={};function xows_tpl_embed_add_site(e,o){wt[e]=o}function xows_tpl_embed_add_file(e,o){xt[e]=o}function xows_tpl_embed_add_upld(e){pt[e]=xows_tpl_embed_upld}function xows_tpl_parse_embeds(e){if(!e.length)return null;let o,_,s,t,n="";for(let c=0;c<e.length;++c)t=null,(o=(s=e[c]).match(/\.([\w\d]+)(\?|$)/))&&(_=o[1].toUpperCase(),xt[_]&&(t=xt[_](s,_))),t||(o=s.match(/\/\/(.*?[\w\d\-_]+\.\w+)\//))&&(_=o[1].toLowerCase(),wt[_]&&(t=wt[_](s,_)),pt[_]&&(t=pt[_](s,_))),t&&(n+=t);return n.length?n:null}const mt=6e5;let gt=new Map;function xows_tpl_spawn_avat_cls(e){let o;if(e.avat)o=e.avat;else{const _=xows_cach_peer_iden(e);xows_cach_avat_temp_data(_,o=xows_cach_avat_temp_hash(_))}if(!gt.has(o)){const e="h-"+o,_=document.createElement("style");_.type="text/css",_.innerText="."+e+' {background-image:url("'+xows_cach_avat_get(o)+'");}\r\n',document.head.appendChild(_),gt.set(o,e)}return gt.get(o)}function xows_tpl_spawn_peer_subs(e){const o=Js["peer-pend"].firstChild.cloneNode(!0);return o.dataset.id=e.addr,o.title=e.addr,o.querySelector("PEER-NAME").innerText=e.addr,o}function xows_tpl_update_peer_subs(e,o){e.title=o.addr,e.querySelector("PEER-NAME").innerText=o.addr}function xows_tpl_spawn_peer_cont(e,o){const _=Js["peer-cont"].firstChild.cloneNode(!0);return _.dataset.id=e.addr,e.subs&ze?(_.title=e.name+" ("+e.addr+")",_.querySelector("PEER-NAME").innerText=e.name,_.querySelector("PEER-META").innerText=e.stat?e.stat:"",_.querySelector("BADG-SHOW").dataset.show=e.show||0,_.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(e)):(_.title=e.addr,_.classList.add("PEER-DENY"),_.querySelector("PEER-NAME").innerText=e.addr,_.querySelector("PEER-META").innerText=xows_l10n_get(o||"Authorization pending"),_.querySelector("BADG-SHOW").hidden=!0,_.querySelector("[name='cont_bt_rtry']").disabled=!1),_}function xows_tpl_update_peer_cont(e,o,_,s){const t=xows_asbool(o.subs&ze),n=e.querySelector("BADG-SHOW");!t!==e.classList.contains("PEER-DENY")&&(e.classList.toggle("PEER-DENY",!t),e.querySelector("[name='cont_bt_rtry']").disabled=t,n.hidden=!t),t?(_&q_&&(n.dataset.show=o.show||0),_&C_&&(e.title=o.name+" ("+o.addr+")",e.querySelector("PEER-NAME").innerText=o.name),_&S_&&(e.querySelector("PEER-META").innerText=o.stat?o.stat:""),_&T_&&(e.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(o))):(e.title=o.addr,e.querySelector("PEER-NAME").innerText=o.addr,e.querySelector("PEER-META").innerText=xows_l10n_get(s||"Authorization pending"))}function xows_tpl_spawn_peer_room(e){const o=Js["peer-room"].firstChild.cloneNode(!0);return o.dataset.id=e.addr,o.title=e.name+" ("+e.addr+")",o.querySelector("PEER-NAME").innerText=e.name,o.querySelector("PEER-META").innerText=e.desc,o.querySelector("BADG-LOCK").hidden=!(e.prot||!e.open),o.querySelector("[name='room_bt_retr']").disabled=!e.book,o}function xows_tpl_update_peer_room(e,o,_){_&C_&&(e.title=o.name+" ("+o.addr+")",e.querySelector("PEER-NAME").innerText=o.name),_&S_&&(e.querySelector("PEER-META").innerText=o.desc),e.querySelector("BADG-LOCK").hidden=!(o.prot||!o.open),e.querySelector("[name='room_bt_retr']").disabled=!o.book}function xows_tpl_spawn_peer_occu(e,o=!1){const _=Js["peer-occu"].firstChild.cloneNode(!0);return _.dataset.id=e.addr,_.dataset.ocid=e.ocid,o&&(_.querySelector("PEER-ACTS").hidden=!0),_.title=e.name+" ("+e.addr+")",_.querySelector("PEER-NAME").innerText=e.name,_.querySelector("PEER-META").innerText=e.stat?e.stat:"",_.querySelector("BADG-SHOW").dataset.show=e.show||0,_.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(e),_}function xows_tpl_update_peer_occu(e,o,_){_&C_&&(e.title=o.name+" ("+o.addr+")",e.querySelector("PEER-NAME").innerText=o.name),_&q_&&(e.querySelector("BADG-SHOW").dataset.show=o.show||0),_&S_&&(e.querySelector("PEER-META").innerText=o.stat?o.stat:""),_&T_&&(e.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(o))}function xows_tpl_mesg_bestref(e,o){return e.type===b_?o.dataset.szid?o.dataset.szid:o.dataset.id:o.dataset.orid?o.dataset.orid:o.dataset.id}function xows_tpl_mesg_null_spawn(e,o,_){const s=Js["hist-null"].firstChild.cloneNode(!0);return s.dataset.id=e,s.dataset.orid=e,s.dataset.szid=e,s.dataset.from=o,s.querySelector("MESG-BODY").innerHTML=_,s}const ft=/^\s*<a href=.+<\/a>\s*$/,ht=[];function xows_tpl_mesg_spawn(e,o,_,s,t,n){const c=Js["hist-mesg"].firstChild.cloneNode(!0);if(c.dataset.id=o.id,c.dataset.from=o.from,c.dataset.time=o.time,o.orid&&(c.dataset.orid=o.orid),o.szid&&(c.dataset.szid=o.szid),o.ocid&&(c.dataset.ocid=o.ocid),n){const o=c.querySelector("MESG-RPLY");if(n.classList.contains("MESG-NULL"))o.classList.add("MESG-FAIL");else{const _=xows_cli_author_get(e,n.dataset.from,n.dataset.ocid);_.self&&c.classList.add("MENTION");let s=xows_cli_peer_iden(_);const t=c.querySelector("RPLY-AVAT");t.dataset.peer=s,t.className=xows_tpl_spawn_avat_cls(_);const i=c.querySelector("RPLY-FROM");i.dataset.peer=s,i.innerText=_.name,o.dataset.to=_.addr}const _=n.querySelector("MESG-BODY");c.querySelector("RPLY-BODY").innerHTML=_?_.innerText:"[...]",o.dataset.id=xows_tpl_mesg_bestref(e,n),o.hidden=!1}let i;t?(i=t.classList.contains("MESG-APPEND"),c.classList.add("MESG-MODIFY")):s&&!n&&(i=s.dataset.from===o.from&&o.time-s.dataset.time<mt),i&&c.classList.add("MESG-APPEND");const r=xows_cli_author_get(e,o.from,o.ocid);let l=xows_cli_peer_iden(r);const a=c.querySelector("MESG-FROM");a.dataset.peer=l,a.innerText=r.name;const u=c.querySelector("MESG-AVAT");u.dataset.peer=l,u.className=xows_tpl_spawn_avat_cls(r),r.self&&(c.classList.add("MESG-SENT"),_||c.classList.add("MESG-RECP"),c.querySelector("MESG-BODY").dataset.raw=xows_html_escape(o.body)),c.querySelector("MESG-HOUR").innerText=xows_l10n_houre(o.time,!0),c.querySelector("MESG-DATE").innerText=xows_l10n_date(o.time);const d=c.querySelector("MESG-BODY"),x=c.querySelector("MESG-EMBD");ht.length=0;const w=xows_tpl_parse_styling(o.body,ht);d.innerHTML=w,o.xoob&&(ht.includes(o.xoob)||ht.push(o.xoob));const p=xows_tpl_parse_embeds(ht);return p&&(x.innerHTML=p,x.hidden=!1,o.body===o.xoob?d.hidden=!0:ft.test(w)&&(d.hidden=!0)),c}function xows_tpl_mesg_update(e,o,_,s,t){if(_&&(e.dataset.orid=_.orid,e.dataset.szid=_.szid,e.dataset.ocid=_.ocid),s&&e.classList.contains("MESG-SENT")&&!e.classList.contains("MESG-RECP")&&e.classList.add("MESG-RECP"),t){const _=e.querySelector("MESG-RPLY");if(t.classList.contains("MESG-NULL"))_.classList.add("MESG-FAIL"),e.classList.remove("MENTION");else{const e=xows_cli_author_get(o,t.dataset.from,t.dataset.ocid);_.dataset.to=e.addr}_.dataset.id=xows_tpl_mesg_bestref(o,t);const s=t.querySelector("MESG-BODY");e.querySelector("RPLY-BODY").innerHTML=s?s.innerText:"[...]"}}function xows_tpl_mesg_edit_insert(e){const o=Js["mesg-edit"].firstChild.cloneNode(!0);o.dataset.id=e.id;const _=e.querySelector("MESG-BODY");return o.querySelector("MESG-INPT").innerHTML=_.dataset.raw,_.parentNode.insertBefore(o,_),e.classList.add("MESG-EDITOR"),o}function xows_tpl_mesg_edit_remove(e){const o=e.querySelector("MESG-MAIN");o&&o.removeChild(o.querySelector("MESG-EDIT")),e.classList.remove("MESG-EDITOR")}function xows_tpl_mesg_trsh_insert(e){const o=Js["mesg-trsh"].firstChild.cloneNode(!0);o.dataset.id=e.id;const _=e.querySelector("MESG-EMBD");return _.parentNode.insertBefore(o,_),e.classList.add("MESG-TRASH"),o}function xows_tpl_mesg_trsh_remove(e){const o=e.querySelector("MESG-MAIN");o&&o.removeChild(o.querySelector("MESG-TRSH")),e.classList.remove("MESG-TRASH")}function xows_tpl_admn_memb_spawn(e,o){let _;e.role?_="memb-role":e.affi&&(_=e.affi==Lo?"memb-outc":"memb-affi");const s=Js[_].firstChild.cloneNode(!0);if(s.dataset.bare=e.jid,s.dataset.nick=e.nick,s.querySelector("MEMB-ADDR").innerText=e.jid?e.jid:"",s.querySelector("MEMB-NICK").innerText=e.nick?e.nick:"",e.affi&&e.affi>Lo){s.dataset.affi=e.affi,o<Oo&&e.affi>=o&&s.setAttribute("disabled","");const _=s.querySelectorAll("MEMB-RADIO");for(let s=0;s<_.length;++s)_[s].dataset.on=_[s].dataset.affi==e.affi,o<Oo&&(_[s].hidden=_[s].dataset.affi>Po)}return s}function xows_tpl_admn_memb_update(e,o,_){const s=e.querySelectorAll("MEMB-RADIO");if(s.length>1)for(let e=0;e<s.length;++e)s[e].dataset.on=s[e].dataset.affi==o;else{const e="true"==s[0].dataset.on;s[0].dataset.on=e?"false":"true",e&&(o=_)}e.dataset.affi=o,null!=_&&(o!=_?e.classList.add("MODIFIED"):e.classList.remove("MODIFIED"))}function xows_tpl_spawn_stream_audio(e){const o=Js["strm-audio"].firstChild.cloneNode(!0);o.title=e.name,o.querySelector("STRM-AVAT").className=xows_tpl_spawn_avat_cls(e);const _=o.querySelector("AUDIO");return _.dataset.part=e.addr,e.self?_.dataset.input=1:_.dataset.outpt=1,o}function xows_tpl_spawn_stream_video(e){const o=Js["strm-video"].firstChild.cloneNode(!0);o.title=e.name;const _=o.querySelector("VIDEO");return _.dataset.part=e.addr,e.self?_.dataset.input=1:_.dataset.outpt=1,o}function xows_doc_init(_){xows_doc_listener_add(xows_doc("scr_page"),"keyup",xows_doc_page_onkeyu),xows_doc_listener_add(xows_doc("page_exit"),"click",xows_doc_page_onclose),xows_doc_listener_add(xows_doc("scr_void"),"click",xows_doc_void_onclick),xows_doc_listener_add(xows_doc("over_view"),"click",xows_doc_view_onclick),xows_tpl_set_callback("embload",xows_doc_embd_onload),xows_tpl_set_callback("emberror",xows_doc_embd_onerror),xows_doc("app_about").innerText=e.toUpperCase()+" v"+o;const s=document.querySelectorAll(".SCROLLABLE");for(let e=0;e<s.length;++e)xows_doc_scroll_create(s[e]),xows_doc_scroll_listen(s[e]);xows_log(2,"doc_init","document ready"),xows_isfunc(_)&&_()}function xows_doc(e){return document.getElementById(e)}function xows_doc_listener_add(e,o,_,s=!0){e.addEventListener(o,_,{capture:!1,passive:s})}function xows_doc_listener_rem(e,o,_,s=!0){e.removeEventListener(o,_,{capture:!1,passive:s})}function xows_doc_cls_has(e,o){return document.getElementById(e).classList.contains(o)}function xows_doc_cls_tog(e,o,_){return document.getElementById(e).classList.toggle(o,_)}function xows_doc_cls_add(e,o){document.getElementById(e).classList.add(o)}function xows_doc_cls_rem(e,o){document.getElementById(e).classList.remove(o)}function xows_doc_show(e,o=!0){document.getElementById(e).hidden=!o}function xows_doc_hide(e,o=!1){document.getElementById(e).hidden=!o}function xows_doc_hidden(e){return document.getElementById(e).hidden}const bt=new Map;function xows_doc_frag_clone(e,o){const _=document.createDocumentFragment();bt.set(e,_);const s=bt.get(o);for(let e=0;e<s.children.length;++e)_.appendChild(s.children[e].cloneNode(!0))}function xows_doc_frag_export(e,o,_=!1){const s=document.createDocumentFragment();bt.set(o,s);const t=document.getElementById(e);if(_)for(let e=0;e<t.children.length;++e)s.appendChild(t.children[e].cloneNode(!0));else for(;t.children.length;)s.appendChild(t.firstChild)}function xows_doc_frag_import(e,o,_=!1){if(!bt.has(e))return;const s=bt.get(e),t=document.getElementById(o);if(t.innerText="",_)for(let e=0;e<s.children.length;++e)t.appendChild(s.childNodes[e].cloneNode(!0));else for(;s.children.length;)t.appendChild(s.firstChild)}function xows_doc_frag_delete(e){bt.delete(e)}const yt=document.getSelection();function xows_doc_sel_caret_around(e,o=!1){const _=document.createRange();_.setStartBefore(e),_.setEndAfter(e),_.collapse(o),yt.removeAllRanges(),yt.addRange(_)}function xows_doc_sel_caret_within(e,o=!1){const _=document.createRange();_.selectNodeContents(e),_.collapse(o),yt.removeAllRanges(),yt.addRange(_)}function xows_doc_sel_paste(e,o=0){yt.deleteFromDocument(),yt.getRangeAt(o).insertNode(e),yt.collapseToEnd()}function xows_doc_embd_onload(e){e.parentNode.classList.remove("LOADPND"),e.parentNode.classList.remove("LOADING")}function xows_doc_embd_onerror(e){e.parentNode.classList.remove("LOADPND"),e.parentNode.classList.remove("LOADING"),e.parentNode.classList.add("LOADERR"),e.closest("MESG-MAIN").querySelector("MESG-BODY").hidden=!1}function xows_doc_blink_bg(e,o){0===o?xows_doc_cls_rem(e,"BLINK-BG"):(xows_doc_cls_add(e,"BLINK-BG"),setTimeout(xows_doc_blink_bg,o,e,0))}function xows_doc_blink_fg(e,o){0===o?xows_doc_cls_rem(e,"BLINK-FG"):(xows_doc_cls_add(e,"BLINK-FG"),setTimeout(xows_doc_blink_fg,o,e,0))}const vt=-1,Ft=0,kt=1,At=2,Et={onabort:null,onvalid:null};function xows_doc_popu_close(){xows_doc_listener_rem(xows_doc("popu_close"),"click",xows_doc_popu_close),xows_doc_listener_rem(xows_doc("popu_abort"),"click",xows_doc_popu_onabort),xows_doc_listener_rem(xows_doc("popu_valid"),"click",xows_doc_popu_onvalid),Et.onabort=null,Et.onvalid=null,xows_doc_hide("over_popu"),xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void")}function xows_doc_popu_onabort(e){Et.onabort&&Et.onabort(),xows_doc_popu_close()}function xows_doc_popu_onvalid(e){Et.onvalid&&Et.onvalid(),xows_doc_popu_close()}function xows_doc_popu_open(e,o,_,s,t,n,c){if(xows_doc_popu_modal())return;let i;switch(xows_doc_popu_close(),e){case vt:i="STYL-ERR";break;case Ft:i="STYL-WRN";break;case kt:i="STYL-SCS";break;case At:i="STYL-ASK"}xows_doc("over_popu").classList=i,xows_doc("popu_text").innerHTML=xows_l10n_get(o),xows_doc_show("popu_close",!_&&!t),xows_doc_show("popu_valid",Boolean(_)),xows_doc_show("popu_abort",Boolean(t)),_&&(xows_doc("popu_valid").innerText=xows_l10n_get(s)),t&&(xows_doc("popu_abort").innerText=xows_l10n_get(n)),Et.onabort=t,Et.onvalid=_,c&&(xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void")),xows_doc_listener_add(xows_doc("popu_close"),"click",xows_doc_popu_close),xows_doc_listener_add(xows_doc("popu_abort"),"click",xows_doc_popu_onabort),xows_doc_listener_add(xows_doc("popu_valid"),"click",xows_doc_popu_onvalid),xows_doc_show("over_popu")}function xows_doc_popu_open_for_save(e,o){xows_doc_hidden("over_popu")&&xows_doc_popu_open(null,"It remains unsaved changes",e,"Save changes",o,"Reset")}function xows_doc_popu_modal(){return!(xows_doc_hidden("over_popu")||!Et.onabort)&&(xows_doc_blink_bg("over_popu",600),!0)}const qt={onabort:null,onvalid:null,oninput:null,modal:!1};function xows_doc_ibox_allow(e){xows_doc("ibox_valid").disabled=!e}function xows_doc_ibox_error(e){xows_doc("ibox_error").innerText=xows_l10n_get(e),xows_doc_blink_fg("ibox_error",600)}function xows_doc_ibox_close(){xows_doc_hidden("over_ibox")||(xows_doc_listener_rem(xows_doc("ibox_close"),"click",xows_doc_ibox_close),xows_doc_listener_rem(xows_doc("ibox_abort"),"click",xows_doc_ibox_onabort),xows_doc_listener_rem(xows_doc("ibox_valid"),"click",xows_doc_ibox_onvalid),xows_doc_listener_rem(xows_doc("ibox_input"),"input",xows_doc_ibox_oninput),qt.onabort=null,qt.onvalid=null,qt.oninput=null,qt.modal&&xows_doc_listener_rem(document,"keyup",xows_doc_ibox_onkey),xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"),xows_doc_hide("over_ibox"),qt.modal=!1)}function xows_doc_ibox_onkey(e){13===e.keyCode&&xows_doc_ibox_onvalid(),27===e.keyCode&&xows_doc_ibox_onabort()}function xows_doc_ibox_oninput(e){const o=xows_doc("ibox_input").value;qt.oninput?qt.oninput(o):xows_doc("ibox_valid").disabled=!o.length}function xows_doc_ibox_onabort(e){qt.onabort&&qt.onabort(),xows_doc_ibox_close()}function xows_doc_ibox_onvalid(e){qt.onvalid&&!qt.onvalid(xows_doc("ibox_input").value)||xows_doc_ibox_close()}function xows_doc_ibox_open(e,o,_,s,t,n,c,i,r,l=!0){if(xows_cli_pres_show_back(),xows_doc_ibox_modal())return;xows_doc_ibox_close(),xows_doc("ibox_head").innerHTML=xows_l10n_get(e),xows_doc("ibox_hint").innerHTML=xows_l10n_get(o);const a=xows_doc("ibox_input");a.placeholder=xows_l10n_get(_),a.value=s||"",qt.onabort=c,qt.onvalid=t,qt.oninput=r,n||(n="Apply"),i||(i="Cancel"),xows_doc("ibox_valid").innerText=xows_l10n_get(n),xows_doc("ibox_abort").innerText=xows_l10n_get(i),xows_doc("ibox_error").innerText="",qt.modal=l,l&&(xows_doc_listener_add(document,"keyup",xows_doc_ibox_onkey),xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void")),xows_doc_ibox_oninput(),xows_doc_listener_add(xows_doc("ibox_close"),"click",xows_doc_ibox_onabort),xows_doc_listener_add(xows_doc("ibox_abort"),"click",xows_doc_ibox_onabort),xows_doc_listener_add(xows_doc("ibox_valid"),"click",xows_doc_ibox_onvalid),xows_doc_listener_add(xows_doc("ibox_input"),"input",xows_doc_ibox_oninput),xows_doc_show("over_ibox"),a.focus()}function xows_doc_ibox_modal(){if(!xows_doc_hidden("over_ibox")){if(qt.modal)return xows_doc_blink_bg("over_ibox",600),!0;xows_doc_ibox_close()}return!1}const St={onvalid:null,onabort:null,modal:!1};function xows_doc_mbox_close(){xows_doc_hidden("over_mbox")||(xows_doc_listener_rem(xows_doc("mbox_close"),"click",xows_doc_mbox_onabort),xows_doc_listener_rem(xows_doc("mbox_abort"),"click",xows_doc_mbox_onabort),xows_doc_listener_rem(xows_doc("mbox_valid"),"click",xows_doc_mbox_onvalid),St.onvalid=null,St.onabort=null,xows_doc_hide("over_mbox"),xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"),St.modal=!1)}function xows_doc_mbox_onvalid(){St.onvalid&&St.onvalid(),xows_doc_mbox_close()}function xows_doc_mbox_onabort(){St.onabort&&St.onabort(),xows_doc_mbox_close()}function xows_doc_mbox_open(e,o,_,s,t,n,c,i=!0){if(xows_cli_pres_show_back(),xows_doc_mbox_modal())return;let r;switch(xows_doc_mbox_close(),e){case vt:r="STYL-ERR";break;case Ft:r="STYL-WRN";break;case kt:r="STYL-SCS";break;case At:r="STYL-ASK"}xows_doc("mbox_icon").classList=r,xows_doc("mbox_head").innerHTML=xows_l10n_get(o),xows_doc("mbox_text").innerHTML=xows_l10n_get(_),St.onabort=n,St.onvalid=s,t||(t="OK"),xows_doc("mbox_valid").innerText=xows_l10n_get(t),n?(c||(c="Cancel"),xows_doc_show("mbox_abort"),xows_doc("mbox_abort").innerText=xows_l10n_get(c)):xows_doc_hide("mbox_abort"),St.modal=i,i&&(xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void")),xows_doc_listener_add(xows_doc("mbox_close"),"click",xows_doc_mbox_close),xows_doc_listener_add(xows_doc("mbox_abort"),"click",xows_doc_mbox_onabort),xows_doc_listener_add(xows_doc("mbox_valid"),"click",xows_doc_mbox_onvalid),xows_doc_show("over_mbox")}function xows_doc_mbox_modal(){if(!xows_doc_hidden("over_mbox")){if(St.modal)return xows_doc_blink_bg("over_mbox",600),!0;xows_doc_mbox_close()}return!1}const Ct={pageid:null,onclose:null,oninput:null,onclick:null};function xows_doc_page_onkeyu(e){if(Ct.pageid&&13===e.keyCode)if(xows_doc_hidden("over_popu")||xows_doc_hidden("popu_valid")){const e=xows_doc(Ct.pageid).querySelector("*[type='submit']");e&&e.click()}else xows_doc("popu_valid").click()}function xows_doc_page_oninput(e){Ct.oninput(e.target)}function xows_doc_page_onclick(e){Ct.onclick(e.target)}function xows_doc_page_onclose(e){xows_doc_popu_modal()||xows_doc_page_close()}function xows_doc_page_close(){if(!Ct.pageid)return;xows_log(2,"doc_page_close",Ct.pageid);const e=xows_doc(Ct.pageid);e.title&&xows_gui_wnd_title_pop(),Ct.oninput&&(xows_doc_listener_rem(e,"input",xows_doc_page_oninput),Ct.oninput=null),Ct.onclick&&(xows_doc_listener_rem(e,"click",xows_doc_page_onclick),Ct.onclick=null),Ct.onclose&&Ct.onclose(),Ct.onclose=null,xows_doc_hide("colr_exit"),xows_doc_hide(Ct.pageid),Ct.pageid=null,xows_doc_popu_close(),xows_doc_hide("scr_page")}function xows_doc_page_open(e,o,_,s,t){xows_cli_pres_show_back(),xows_doc_page_close(),xows_log(2,"doc_page_open",e),xows_doc_show("scr_page"),xows_doc_show(e),Ct.pageid=e,o&&xows_doc_show("colr_exit"),Ct.onclose=_;const n=xows_doc(e);s&&(Ct.oninput=s,xows_doc_listener_add(n,"input",xows_doc_page_oninput)),t&&(Ct.onclick=t,xows_doc_listener_add(n,"click",xows_doc_page_onclick)),n.title&&xows_gui_wnd_title_set(xows_l10n_get(n.title)+" - XOWS"),xows_doc_popu_close()}const Tt={bttn:null,drop:null,onclick:null,onclose:null};function xows_doc_menu_close(){const e=Tt;e.drop&&(e.drop.hidden=!0),e.onclick&&xows_doc_listener_rem(e.drop,"click",e.onclick),e.onclose&&e.onclose(),e.bttn&&e.bttn.blur(),xows_doc_hide("scr_void"),e.drop=null,e.bttn=null,e.onclick=null,e.onclose=null}function xows_doc_menu_toggle(e,o,_,s,t){const n=Tt;if(n.bttn)xows_doc_menu_close();else{const c=xows_doc(o);if(!e||!c)return;n.bttn=e,n.drop=c,n.onclick=_,n.onclose=t,n.onclick&&xows_doc_listener_add(n.drop,"click",n.onclick),xows_doc_show("scr_void"),n.drop.hidden=!1,xows_isfunc(s)&&s(n.bttn,n.drop),n.bttn.focus()}}function xows_doc_view_onclick(e){switch(e.target.id){case"view_optab":window.open(e.target.parentNode.querySelector("IMG").src,"_blank").focus();break;default:xows_doc_view_close()}}function xows_doc_view_close(){const e=xows_doc("over_view");e.hidden||(e.hidden=!0,xows_doc("view_img").src="",xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"))}function xows_doc_view_open(e){"IMG"===e.tagName&&(xows_doc("view_img").src=e.src,xows_doc_show("over_view"),xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void"))}const Dt={peer:null,onclick:null};function xows_doc_prof_onclick(e){"prof_close"!=e.target.id?Dt.onclick&&Dt.onclick(Dt.peer,e.target):xows_doc_prof_close()}function xows_doc_prof_close(){const e=xows_doc("over_prof");e.hidden||(xows_doc_listener_rem(e,"click",xows_doc_prof_onclick),Dt.peer=null,Dt.onclick=null,xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"),e.hidden=!0)}function xows_doc_prof_update(){const e=Dt.peer,o=xows_doc("over_prof"),_=xows_doc("prof_meta");let s,t,n,c,i,r;e.type===b_?(s="Channel information",t=e.addr,n="ROOM-AVAT",_.className="PEER-ROOM",c=_.querySelector(".meta-room"),i=e.desc):(s="Contact profile",t=e.jbar?e.jbar:"",n=xows_tpl_spawn_avat_cls(e),_.className="PEER-CONT",c=_.querySelector(".meta-cont"),i=e.stat,o.querySelector("BADG-SHOW").dataset.show=e.show||0),o.querySelector("DBOX-HEAD").innerText=xows_l10n_get(s),o.querySelector("PEER-NAME").innerText=e.name,o.querySelector("PEER-AVAT").className=n,o.querySelector("BADG-SHOW").hidden=e.type===b_,o.querySelector("PEER-ADDR").innerText=t,c.querySelector("PEER-META").innerText=i;const l=xows_doc("prof_subs"),a=xows_doc("prof_addc");if(e.type&b_|y_){let o;switch(xows_doc_show("prof_muc"),e.affi){case Oo:o="Owner";break;case Ro:o="Administrator";break;case Po:o="Member";break;default:o="Unaffiliated"}const _=xows_doc("prof_affi");let s;switch(_.innerText=xows_l10n_get(o),_.dataset.affi=e.affi,e.role){case Io:s="Moderator";break;case jo:s="Participant";break;default:s="Visitor"}const t=xows_doc("prof_role");t.innerText=xows_l10n_get(s),t.dataset.role=e.role,e.type===y_&&e.jbar&&(r=xows_cli_cont_get(e.jbar))}else xows_doc_hide("prof_muc"),r=e;if(e.self||e.type===b_)xows_doc_hide("prof_cont");else{let o;xows_doc_show("prof_cont");let _=0;if(r){switch(l.hidden=!1,a.hidden=!0,r.subs){case Ve:o="Mutual";break;default:o="Pending"}_=r.subs}else{const s=xows_cli_peer_subsste(e);switch(l.hidden=s<1,a.hidden=s>0,s){case 1:o="Pending",_=1;break;case 2:o="Unavailable",_=-1}}l.innerText=xows_l10n_get(o),l.dataset.subs=_}}function xows_doc_prof_open(e,o){const _=xows_doc("over_prof");Dt.peer=e,Dt.onclick=o;const s=xows_doc("scr_void");s.className="VOID-DARK",s.hidden=!1,xows_doc_listener_add(_,"click",xows_doc_prof_onclick),xows_doc_prof_update(),_.hidden=!1}function xows_doc_void_onclick(e){Tt.bttn&&xows_doc_menu_close(),xows_doc_view_close(),xows_doc_prof_close(),xows_doc_popu_modal(),xows_doc_ibox_modal(),xows_doc_mbox_modal()}function xows_doc_scroll_export(e){const o=document.getElementById(e);o.dataset.scrollbottom=o.scrollBottom||0}function xows_doc_scroll_import(e){const o=document.getElementById(e);o.scrollBottom=parseInt(o.dataset.scrollbottom),It=!0,o.scrollTop=o.scrollHeight-(o.clientHeight+o.scrollBottom)}const jt=new ResizeObserver(xows_doc_scroll_onresize);function xows_doc_scroll_create(e){const o=document.createElement("scroll-bar");o.id="scrollbar_"+xows_gen_nonce_asc(6),e.id||(e.id="scrollable_"+xows_gen_nonce_asc(6)),o.dataset.scrollable=e.id;const _=document.createElement("scroll-hnd");_.hidden=!0,o.appendChild(_),e.parentNode.appendChild(o),e.dataset.scrollbar=o.id,"scrollbottom"in e.dataset&&(e.scrollBottom=parseInt(e.dataset.scrollbottom));for(let o=0;o<e.children.length;++o)e.children[o].dataset.scrollable=e.id;xows_log(2,"doc_scroll_create","create scrollbar",o.id+" <=> "+e.id)}function xows_doc_scroll_listen(e){document.getElementById(e.dataset.scrollbar).addEventListener("mousedown",xows_doc_scroll_onmousedn),e.addEventListener("scroll",xows_doc_scroll_onscroll,{passive:!0}),jt.observe(e);for(let o=0;o<e.children.length;++o)jt.observe(e.children[o])}function xows_doc_scroll_unobserv(e){jt.unobserve(e);for(let o=0;o<e.children.length;++o)jt.unobserve(e.children[o])}let It=!1;function xows_doc_scroll_adjust(e){const o=document.getElementById(e.dataset.scrollbar);o||console.log(e);const _=o.firstElementChild,s=e.clientHeight/e.scrollHeight;if(s<1){let t=o.offsetHeight*s;t<20?(_.scrollOff=20-t,t+=_.scrollOff):_.scrollOff=0;const n=e.scrollTop/e.scrollHeight;_.style.height=t+"px",_.style.top=(o.offsetHeight-_.scrollOff)*n+"px",_.hidden&&(_.hidden=!1)}else _.hidden||(_.hidden=!0)}function xows_doc_scroll_onresize(e,o){for(const o of e){let e;if("scrollable"in o.target.dataset){if(!(e=document.getElementById(o.target.dataset.scrollable)))continue}else e=o.target;"scrollbottom"in e.dataset?(It=!0,e.scrollTop=e.scrollHeight-(e.clientHeight+e.scrollBottom)):xows_doc_scroll_adjust(e)}}function xows_doc_scroll_onscroll(e){const o=e.target;xows_doc_scroll_adjust(o),"scrollbottom"in o.dataset&&(It?It=!1:o.scrollBottom=o.scrollHeight-(o.clientHeight+o.scrollTop))}const Nt={bar:null,hnd:null,abl:null,msy:0,top:0,max:0,off:0};function xows_doc_scroll_onmousedn(e){e.preventDefault();const o=e.target.closest("SCROLL-BAR"),_=document.getElementById(o.dataset.scrollable);if("SCROLL-HND"===e.target.tagName){const s=o.firstElementChild,t=Nt;t.bar=o,t.hnd=o.firstElementChild,t.abl=_,t.msy=e.screenY,t.top=parseInt(o.firstElementChild.style.top),t.max=o.offsetHeight-s.offsetHeight,s.classList.add("SCROLLING"),xows_doc_listener_add(window,"mousemove",xows_doc_scroll_onmousemv),xows_doc_listener_add(window,"mouseup",xows_doc_scroll_onmouseup)}else{const s=e.offsetY/o.offsetHeight;_.scrollTop=_.scrollHeight*s}}function xows_doc_scroll_onmousemv(e){const o=Nt;let _,s=o.top+(e.screenY-o.msy);if(s<0&&(s=0),s>o.max&&(s=o.max),o.hnd.style.top=s+"px",o.hnd.scrollOff){const e=o.bar.offsetHeight-o.hnd.offsetHeight;_=s+.5*(1+(s-(o.bar.offsetHeight-(s+o.hnd.offsetHeight)))/e)*o.hnd.scrollOff}else _=s;const t=_/o.bar.offsetHeight;o.abl.scrollTop=o.abl.scrollHeight*t}function xows_doc_scroll_onmouseup(e){Nt.hnd.classList.remove("SCROLLING"),xows_doc_listener_rem(window,"mousemove",xows_doc_scroll_onmousemv),xows_doc_listener_rem(window,"mouseup",xows_doc_scroll_onmouseup)}function xows_doc_scroll_todown(e,o){It=!0,o?e.scrollTo({top:e.scrollHeight-e.clientHeight,behavior:"smooth"}):e.scrollTop=e.scrollHeight-e.clientHeight,e.dataset.scrollbottom=0}let Mt=null,Lt=null;const Bt=new Map,Pt=new Map,Rt=new Map,Ot=2048;function xows_snd_init(){Mt=new AudioContext,(Lt=Mt.createGain()).connect(Mt.destination),Lt.gain.value=1;for(const e of Rt.values())null===e.node&&e.audio.readyState>0&&(e.node=Mt.createMediaElementSource(e.audio),e.node.connect(Lt))}let Gt=function(){};function xows_snd_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"onvmtr":Gt=o}}function xows_snd_mastr_gain_set(e){Lt.gain.value=e}function xows_snd_input_gain_set(e){for(const o of Pt.values())o.gain.gain.value=e}function xows_snd_outpt_new(e,o){const _=Mt.createMediaStreamSource(o),s=Mt.createGain(),t=Mt.createAnalyser();t.fftSize=Ot,Bt.set(e,{strm:o,node:_,gain:s,anal:t}),_.connect(s),s.connect(Lt)}function xows_snd_outpt_vumtr(e,o,_){if(!Bt.has(e))return null;const s=Bt.get(e);if(o){if(xows_snd_vumtr_has(s.anal))return;s.node.connect(s.anal),xows_snd_vumtr_add(s.anal,_)}else{if(!xows_snd_vumtr_has(s.anal))return;s.node.disconnect(s.anal),xows_snd_vumtr_rem(s.anal)}}function xows_snd_outpt_delete(e,o){if(!Bt.has(e))return;const _=Bt.get(e);if(_.gain.disconnect(),xows_snd_vumtr_has(_.node)&&xows_snd_vumtr_rem(_.node),_.node.disconnect(),o)for(const e of _.strm.getTracks())e.stop();Bt.delete(e)}function xows_snd_outpt_gain_set(e,o){Bt.has(e)&&(Bt.get(e).gain.gain.value=o)}function xows_snd_input_new(e,o){const _=Mt.createMediaStreamSource(o),s=Mt.createGain(),t=Mt.createMediaStreamDestination(),n=Mt.createAnalyser();return n.fftSize=Ot,Pt.set(e,{strm:o,node:_,gain:s,dest:t,anal:n}),_.connect(s),s.connect(t),t.stream}function xows_snd_input_vumtr(e,o,_){if(!Pt.has(e))return null;const s=Pt.get(e);if(o){if(xows_snd_vumtr_has(s.anal))return;s.node.connect(s.anal),xows_snd_vumtr_add(s.anal,_)}else{if(!xows_snd_vumtr_has(s.anal))return;s.node.disconnect(s.anal),xows_snd_vumtr_rem(s.anal)}}function xows_snd_input_node(e){return Pt.has(e)?Pt.get(e).node:null}function xows_snd_input_dest(e){return Pt.has(e)?Pt.get(e).dest.stream:null}function xows_snd_input_delete(e,o){if(!Pt.has(e))return;const _=Pt.get(e);if(_.gain.disconnect(),xows_snd_vumtr_has(_.node)&&xows_snd_vumtr_rem(_.node),_.node.disconnect(),o)for(const e of _.strm.getTracks())e.stop();Pt.delete(e)}let Ut=null;const Ht=new Float32Array(Ot),zt=new Map;function xows_snd_vumtr_add(e,o){zt.set(e,o),Ut||(Ut=setInterval(xows_snd_vumtr_proc,25))}function xows_snd_vumtr_has(e){return zt.has(e)}function xows_snd_vumtr_rem(e){zt.delete(e),0===zt.size&&(clearInterval(Ut),Ut=null)}function xows_snd_vumtr_proc(){for(const[e,o]of zt.entries()){e.getFloatTimeDomainData(Ht);let _=0;for(let o=0;o<e.frequencyBinCount;o++){const e=Math.abs(Ht[o]);e>_&&(_=e)}Gt(_,o)}}function xows_snd_sample_onfailed(e){const o=e.target;xows_log(1,"snd_sample_onfailed","'"+o.name+"' audio sample load failed",o.src),Rt.delete(o.name)}function xows_snd_sample_onloaded(e){const o=Rt.get(e.target.name);Mt&&(o.node=Mt.createMediaElementSource(o.audio),o.node.connect(Lt)),xows_log(2,"snd_sample_onloaded","'"+e.target.name+"' audio sample available")}function xows_snd_sample_load(e,o){const _=new Audio;_.name=e,Rt.set(e,{node:null,audio:_});const s=Mn.lib_path+"sounds/"+o;xows_log(2,"aud_snd_load","loading '"+e+"' sound",s),_.onerror=xows_snd_sample_onfailed,_.canplay=xows_snd_sample_onloaded,_.src=s}function xows_snd_sample_play(e){if(Rt.has(e)){const o=Rt.get(e).audio;o.loop=!1,o.play()}}function xows_snd_sample_loop(e){if(Rt.has(e)){const o=Rt.get(e).audio;o.loop=!0,o.play()}}function xows_snd_sample_stop(e){Rt.has(e)&&Rt.get(e).audio.pause()}const Vt=new Map;function xows_wrtc_gen_credential(e,o){const _=parseInt(Date.now()/1e3)+86400+":"+e;return{username:_,password:xows_bytes_to_b64(xows_hmac_sha1(_,o))}}function xows_wrtc_onerror(e,o){xows_log(1,"wrtc_onerror",o.message);const _=Vt.get(e);xows_isfunc(_.onerror)&&_.onerror(e,o,_.param)}function xows_wrtc_oncnxstate(e){const o=e.target;xows_log(2,"wrtc_oncnxstate","Connection state",o.connectionState);const _=Vt.get(o);xows_isfunc(_.onstate)&&_.onstate(o,o.connectionState,_.param)}function xows_wrtc_onneednego(e){const o=e.target;xows_log(2,"wrtc_onneednego","Create SDP offer"),o.createOffer().then(e=>o.setLocalDescription(e)).then(null,e=>xows_wrtc_onerror(o,e))}function xows_wrtc_onicestate(e){const o=e.target;xows_log(2,"wrtc_onicestate","ICE gathering state",o.iceGatheringState);const _=Vt.get(o);xows_isfunc(_.onstate)&&_.onstate(o,o.iceGatheringState,_.param),"complete"===o.iceGatheringState&&xows_isfunc(_.onsdesc)&&_.onsdesc(o,o.localDescription.sdp,_.param)}function xows_wrtc_oniceerror(e){const o=e.target;xows_log(1,"wrtc_oniceerror",e.name);const _=Vt.get(o);xows_isfunc(_.onerror)&&_.onerror(o,e,_.param)}function xows_wrtc_ontrack(e){if(e.streams.length){const o=e.target;xows_log(2,"wrtc_ontrack","Remote stream available");const _=Vt.get(o);xows_isfunc(_.ontrack)&&_.ontrack(o,e.streams[0],_.param)}}function xows_wrtc_close(e){xows_log(2,"wrtc_close","Deleting RTC object"),e.close(),Vt.delete(e)}function xows_wrtc_new(e,o,_,s,t,n){const c=[];for(let o=0;o<e.length;++o){const _={urls:e[o].type+":"+e[o].host};if(e[o].secret){const s=xows_wrtc_gen_credential(F_.addr,e[o].secret);_.username=s.username,_.credential=s.password}else e[o].username&&(_.username=e[o].username),e[o].password&&(_.credential=e[o].password);c.push(_)}const i=new RTCPeerConnection({iceServers:c});return i.ontrack=xows_wrtc_ontrack,i.onnegotiationneeded=xows_wrtc_onneednego,i.onconnectionstatechange=xows_wrtc_oncnxstate,i.onicegatheringstatechange=xows_wrtc_onicestate,i.onicecandidateerror=xows_wrtc_oniceerror,Vt.set(i,{onerror:t,onstate:s,onsdesc:o,ontrack:_,param:n}),i}function xows_wrtc_set_local_stream(e,o){const _=o.getTracks();for(let o=0;o<_.length;++o)e.addTrack(_[o]);xows_log(2,"wrtc_local_stream","Local stream added"),e.remoteDescription&&(xows_log(2,"wrtc_local_stream","Create SDP Answer"),e.createAnswer().then(o=>e.setLocalDescription(o)).then(null,o=>xows_wrtc_onerror(e,o)))}function xows_wrtc_set_remote_sdp(e,o){const _=e.localDescription?"answer":"offer",s=new RTCSessionDescription({type:_,sdp:o});xows_log(2,"wrtc_set_remote_sdp","Setting remote SDP",_),e.setRemoteDescription(s).then(null,o=>xows_wrtc_onerror(e,o))}function xows_wrtc_has_local(e){return null!==e.localDescription}function xows_wrtc_has_remote(e){return null!==e.remoteDescription}function xows_wrtc_connected(e){return"connected"===e.connectionState}const Yt=xows_load_task_bit(),Jt=xows_load_task_bit();let Kt=null,Wt=null,Xt=null;function xows_gui_devs_poll(){"mediaDevices"in navigator&&(navigator.mediaDevices.enumerateDevices().then(xows_gui_devs_oninfos),navigator.mediaDevices.ondevicechange=xows_gui_devs_onchange)}function xows_gui_devs_onchange(e){navigator.mediaDevices.enumerateDevices().then(xows_gui_devs_oninfos)}function xows_gui_devs_oninfos(e){Xt=e,xows_log(2,"gui_devices_oninfo","received medias infos"),Wt&&xows_gui_doc_update(Wt)}function xows_gui_devs_has(e){if(!Xt)return!1;for(let o=0;o<Xt.length;++o)if(Xt[o].kind===e)return!0;return!1}function xows_gui_cred_store(e){const o=new PasswordCredential(e);navigator.credentials.store(o).then(()=>{xows_log(2,"gui_cred_store","credential stored")},e=>{xows_log(1,"gui_cred_store","error storing credential",e)})}function xows_gui_cred_support(){return"credentials"in navigator&&"PasswordCredential"in window}const $t="void";function xows_gui_frag_new(e,o){o||(o=$t),bt.has(o)?xows_doc_frag_clone(e,o):xows_log(1,"gui_frag_new","source fragment doesn't exist",o)}function xows_gui_frag_export(e){xows_doc_scroll_unobserv(xows_doc("chat_hist")),xows_doc_scroll_unobserv(xows_doc("mucl_list")),xows_doc_scroll_export("chat_hist"),xows_doc_frag_export("peer_col",e)}function xows_gui_frag_import(e){let o=!1;e||(e=$t,o=!0),bt.has(e)?(xows_doc_frag_import(e,"peer_col",o),e!==$t&&xows_doc_scroll_import("chat_hist")):xows_log(1,"gui_peer_frag_import","fragment doesn't exist",e)}function xows_gui_frag_discard(e){xows_doc_frag_delete(e)}function xows_gui_frag_clear(){for(const e of bt.keys())e!==$t&&xows_gui_frag_discard(e)}function xows_gui_init(){xows_doc_scroll_export("chat_hist"),xows_gui_frag_export($t),Mn.gui_allow_register&&xows_doc_show("auth_regi"),xows_gui_devs_poll(),xows_doc_listener_add(document,"keydown",xows_gui_wnd_onkey,!1),xows_doc_listener_add(document,"keyup",xows_gui_wnd_onkey),xows_doc_listener_add(document,"visibilitychange",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"pagehide",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"focus",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"blur",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"beforeunload",xows_gui_wnd_unload),xows_doc_listener_add(window,"popstate",xows_gui_wnd_onback),xows_doc_listener_add(xows_doc("rost_hand"),"click",xows_gui_layout_hand_onclick),xows_doc_listener_add(xows_doc("app_fram"),"click",xows_gui_app_fram_onclick),xows_doc_listener_add(xows_doc("cont_acts"),"click",xows_gui_rost_head_onclick),xows_doc_listener_add(xows_doc("room_acts"),"click",xows_gui_rost_head_onclick),xows_doc_listener_add(xows_doc("occu_acts"),"click",xows_gui_rost_head_onclick),xows_doc_listener_add(xows_doc("cont_list"),"click",xows_gui_rost_list_onclick),xows_doc_listener_add(xows_doc("room_list"),"click",xows_gui_rost_list_onclick),xows_doc_listener_add(xows_doc("occu_list"),"click",xows_gui_rost_list_onclick),xows_doc_listener_add(xows_doc("self_panl"),"click",xows_gui_self_fram_onclick),xows_snd_sample_load("notify","notify.ogg"),xows_snd_sample_load("disable","disable.ogg"),xows_snd_sample_load("enable","enable.ogg"),xows_snd_sample_load("mute","mute.ogg"),xows_snd_sample_load("unmute","unmute.ogg"),xows_snd_sample_load("ringtone","ringtone.ogg"),xows_snd_sample_load("ringbell","ringbell.ogg"),xows_snd_sample_load("hangup","hangup.ogg"),xows_cli_set_callback("ready",xows_gui_cli_onready),xows_cli_set_callback("error",xows_gui_cli_onerror),xows_cli_set_callback("close",xows_gui_cli_onclose),xows_cli_set_callback("selfpush",xows_gui_self_onpush),xows_cli_set_callback("subspush",xows_gui_rost_subs_onpush),xows_cli_set_callback("contpush",xows_gui_rost_cont_onpush),xows_cli_set_callback("contpull",xows_gui_rost_cont_onpull),xows_cli_set_callback("roompush",xows_gui_rost_room_onpush),xows_cli_set_callback("roompull",xows_gui_rost_room_onpull),xows_cli_set_callback("occupush",xows_gui_rost_occu_onpush),xows_cli_set_callback("occupull",xows_gui_rost_occu_onpull),xows_cli_set_callback("mucjoin",xows_gui_muc_onjoin),xows_cli_set_callback("mucexit",xows_gui_muc_onexit),xows_cli_set_callback("mucpush",xows_gui_muc_list_onpush),xows_cli_set_callback("mucpull",xows_gui_muc_list_onpull),xows_cli_set_callback("mucsubj",xows_gui_muc_onsubj),xows_cli_set_callback("msgrecv",xows_gui_hist_onrecv),xows_cli_set_callback("msgrecp",xows_gui_hist_onrecp),xows_cli_set_callback("msgretr",xows_gui_hist_onretr),xows_cli_set_callback("msgchst",xows_gui_edit_onchst),xows_cli_set_callback("upldprog",xows_gui_upld_onporg),xows_cli_set_callback("upldload",xows_gui_upld_onload),xows_cli_set_callback("calloffer",xows_gui_call_onoffer),xows_cli_set_callback("callanwse",xows_gui_call_onanwse),xows_cli_set_callback("callstate",xows_gui_call_onstate),xows_cli_set_callback("calltermd",xows_gui_call_ontermd),xows_cli_set_callback("callerror",xows_gui_call_onerror),xows_snd_set_callback("onvmtr",xows_gui_snd_onvmtr),xows_load_task_set(Yt,xows_gui_mam_fetch_newer),xows_load_task_set(Jt,xows_gui_mam_fetch_older),xows_gui_startup()}function xows_gui_clean(){xows_doc_page_close(),xows_doc_menu_close(),xows_doc_view_close(),xows_doc_popu_close(),xows_doc_ibox_close(),xows_doc_mbox_close(),xows_doc_prof_close()}function xows_gui_reset(){xows_log(2,"gui_reset","set GUI to initial state"),xows_gui_clean(),Wt&&xows_gui_doc_export(Wt),xows_doc_cls_rem("main_wrap","MUCL-WIDE"),xows_doc_cls_add("main_wrap","ROST-WIDE"),xows_doc_hide("scr_page"),xows_doc_hide("scr_main"),xows_doc("cont_pend").innerHTML="",xows_doc("cont_budy").innerHTML="",xows_doc("room_book").innerHTML="",xows_doc("room_publ").innerHTML="",xows_doc("room_priv").innerHTML="",xows_doc("priv_occu").innerHTML="",xows_doc("tab_occu").hidden=!0,xows_doc("tab_room").disabled=!0,xows_gui_app_tab_select("tab_cont");const e=xows_doc("priv_noti");e.dataset.mesg=0,e.dataset.call=0,e.dataset.ring=0,e.innerText="";const o=xows_doc("room_noti");o.dataset.mesg=0,o.dataset.call=0,o.dataset.ring=0,o.innerText="";const _=xows_doc("cont_noti");_.dataset.mesg=0,_.dataset.call=0,_.dataset.ring=0,_.dataset.subs=0,_.innerText="",xows_doc("self_show").dataset.show=0,xows_doc("self_name").innerText="",xows_doc("self_meta").innerText="",xows_doc("self_avat").className="",Object.assign(un,{name:null,addr:null,avat:null,stat:null}),xows_gui_frag_clear()}let Qt=null;function xows_gui_hang_timeout(e){xows_gui_clean(),xows_gui_page_wait_open(e)}function xows_gui_hang_abort(){Qt&&(clearTimeout(Qt),Qt=null)}function xows_gui_hang(e,o){xows_gui_hang_abort(),Qt=setTimeout(xows_gui_hang_timeout,e,o)}let Zt=!1;function xows_gui_startup(){if(xows_gui_cred_support()){const e={password:!0,mediation:"optional"};navigator.credentials.get(e).then(xows_gui_startup_oncreds,xows_gui_page_auth_open)}else{if(xows_cach_auth_has()){if(Mn.login_sasl_store){const e=xows_cach_auth_get().z.split("@")[0];return xows_log(2,"gui_startup","auto connect (stored SASL data)"),void xows_gui_connect(e,null,!1,!1)}xows_cach_auth_reset(),xows_log(2,"gui_startup","stored SASL data erased")}xows_gui_page_auth_open()}}function xows_gui_startup_oncreds(e){e?(xows_log(2,"gui_startup_oncreds","auto connect"),xows_gui_connect(e.id,e.password,!1,!1)):(xows_log(2,"gui_startup_oncreds","no credential"),xows_gui_page_auth_open())}function xows_gui_connect(e,o,_,s=!1){xows_gui_page_wait_open("Connecting..."),(Kt={}).user=e,Kt.pass=o,Kt.save=_,xows_doc_popu_close(),xows_snd_init();let t=Kt.user;Mn.login_force_domain&&(t+="@"+Mn.login_force_domain),xows_cli_cnx_login(Mn.xmpp_url,t,Kt.pass,_,s)}function xows_gui_cli_onready(e,o){if(xows_gui_cred_support()&&Kt.auto){xows_log(2,"gui_cli_onready","Saving credential"),xows_gui_cred_store({id:Kt.user,password:Kt.pass})}if(Zt){if(xows_log(1,"gui_cli_onready","resume session"),Zt=!1,!o){for(let e=0;e<k_.length;++e)xows_gui_doc_has(k_[e])&&xows_load_task_push(k_[e],Yt,xows_gui_hist_resume);for(let e=0;e<A_.length;++e)xows_gui_doc_has(A_[e])&&xows_load_task_push(A_[e],Yt,xows_gui_hist_resume)}xows_gui_hang_abort(),xows_xmp_flush()}else{xows_log(2,"gui_cli_onready","open session"),window.history.pushState({},"",window.location.pathname),xows_gui_peer_switch_to(null);const e=w_.has(Eo);xows_doc("room_bt_upd").disabled=!e;const o=w_.get(Ao);o&&o.length&&xows_tpl_embed_add_upld(o[0])}xows_doc_page_close(),xows_doc_show("scr_main")}function xows_gui_disconnect(){xows_log(2,"gui_disconnect","prepare disconnect"),xows_cli_cnx_close()}function xows_gui_cli_onclose(e,o){let _;if(e){if(e&G_)return xows_log(2,"gui_cli_onclose","session lost",o),Zt=!0,void xows_gui_hang(2100*Mn.resume_try_delay,"Connecting...");xows_log(2,"gui_cli_onclose","session failure",o),Zt=!1,_=e&H_?"Connection lost":e&q?"Network error":e&M?"Authentication failure":e&L?"Registration failure":"Connection failure"}else xows_log(2,"gui_cli_onclose","session closed by user");xows_gui_reset(),xows_gui_page_auth_open(),_&&xows_doc_popu_open(vt,xows_l10n_get(_)+": "+xows_l10n_get(o))}function xows_gui_cli_onerror(e,o){let _=xows_l10n_get("Unhandled error")+": ";_+=xows_xml_beatify_tag(o.name),xows_doc_popu_open(vt,_)}function xows_gui_doc_init(e){if(bt.has(e.addr))return;xows_gui_frag_new(e.addr);const o=xows_gui_doc(e,"chat_fram");e.type===b_?o.classList.add("CHAT-ROOM"):(xows_gui_doc(e,"mucl_col").hidden=!0,o.classList.add("CHAT-BUDY")),xows_gui_doc_update(e)}function xows_gui_doc_reset(e){bt.has(e.addr)&&bt.delete(e.addr),e.live=!1,xows_gui_doc_init(e)}function xows_gui_doc_export(e){xows_gui_frag_export(e.addr),Wt=null}function xows_gui_doc_import(e){if(!e)return void xows_log(1,"gui_doc_import","peer is null");bt.has(e.addr)||xows_gui_doc_init(e),xows_gui_frag_import(e.addr),Wt=e,xows_doc_scroll_listen(xows_doc("chat_hist")),e.type===b_&&xows_doc_scroll_listen(xows_doc("mucl_list")),xows_doc_listener_add(xows_doc("chat_head"),"click",xows_gui_chat_head_onclick),xows_doc_listener_add(xows_doc("chat_hist"),"scrollend",xows_gui_hist_onscroll),xows_doc("call_view").hidden||(xows_doc_listener_add(xows_doc("call_menu"),"click",xows_gui_call_view_onclick),xows_doc_listener_add(xows_doc("call_volu"),"input",xows_gui_call_view_oninput)),xows_doc_listener_add(xows_doc("hist_mesg"),"click",xows_gui_hist_onclick);const o=xows_doc("hist_ring");o.hidden||xows_doc_listener_add(o,"click",xows_gui_hist_ring_onclick);const _=xows_doc("hist_upld");_.hidden||xows_doc_listener_add(_,"click",xows_gui_upld_onclick);const s=xows_doc("edit_alrt");s.hidden||xows_doc_listener_add(s,"click",xows_gui_edit_alrt_onclick);const t=xows_doc("edit_inpt");xows_doc_listener_add(t,"keyup",xows_gui_edit_inpt_oncaret),xows_doc_listener_add(t,"mouseup",xows_gui_edit_inpt_oncaret),xows_doc_listener_add(t,"paste",xows_gui_edit_inpt_onpaste,!1);const n=xows_doc("chat_edit");if(xows_doc_listener_add(n,"input",xows_gui_edit_oninput),xows_doc_listener_add(n,"click",xows_gui_edit_onclick),xows_doc_listener_add(xows_doc("edit_file"),"change",xows_gui_edit_onfile),e.type===b_&&(xows_doc_listener_add(xows_doc("mucl_hand"),"click",xows_gui_layout_hand_onclick),xows_doc_listener_add(xows_doc("mucl_head"),"click",xows_gui_muc_head_onclick),xows_doc_listener_add(xows_doc("mucl_list"),"click",xows_gui_muc_list_onclick)),xows_gui_doc(e,"peer_load").hidden)xows_log(2,"gui_doc_import","updating elements",e.addr),xows_gui_doc_update(e);else{xows_log(2,"gui_doc_import","initial preloading",e.addr);let o=0;switch(e.type){case y_:xows_doc_cls_add("hist_beg","HIST-START");break;default:o|=Jt}xows_load_task_push(e,o,xows_gui_doc_update,tn|nn)}}function xows_gui_doc_reassign(e,o){e===Wt&&xows_gui_frag_export(o),xows_gui_frag_new(e.addr,o),xows_gui_frag_discard(o),e===Wt&&xows_gui_doc_import(e)}function xows_gui_doc_has(e){return bt.has(e.addr)}function xows_gui_doc(e,o){return e===Wt?document.getElementById(o):bt.has(e.addr)?bt.get(e.addr).getElementById(o):null}const en=1,on=2,_n=4,sn=16,tn=255,nn=256;function xows_gui_doc_update(e,o=255){if(bt.has(e.addr)){if(o&en){const o=xows_gui_wnd_noti_allowed()&&e.noti,_=xows_gui_doc(e,"chat_noti");_.title=xows_l10n_get(o?"Disable notifications":"Enable notifications"),_.classList.toggle("DISABLED",!o)}if(e.type===b_){if(o&sn&&(xows_gui_doc(e,"chat_titl").innerText="# "+e.name,xows_gui_doc(e,"chat_bkad").hidden=e.book||e.locl&&e.publ,xows_gui_doc(e,"chat_bkrm").hidden=!e.book),o&_n){xows_gui_doc(e,"chat_meta").innerText=e.subj?e.subj:""}}else{if(o&sn){xows_gui_doc(e,"chat_titl").innerText=e.name,xows_gui_doc(e,"chat_meta").innerText=e.stat?e.stat:"",xows_gui_doc(e,"chat_show").dataset.show=e.show,e.type===y_?(xows_gui_doc(e,"chat_addr").innerText="(# "+e.room.name+")",xows_gui_doc(e,"chat_addc").hidden=0!==xows_cli_peer_subsste(e)):xows_gui_doc(e,"chat_addr").innerText="("+e.addr+")";const o=xows_cli_extservs_has("stun","turn");xows_gui_doc(e,"chat_cala").hidden=!(xows_gui_devs_has("audioinput")&&o),xows_gui_doc(e,"chat_calv").hidden=!(xows_gui_devs_has("videoinput")&&o)}if(o&on){const o=xows_cli_call_buzy()||e.show<=Ne;xows_gui_doc(e,"chat_cala").disabled=o,xows_gui_doc(e,"chat_calv").disabled=o}}if(o&sn){xows_gui_doc(e,"edit_upld").disabled=!w_.has(Ao);const o=xows_l10n_get("Send a message to")+" "+e.name+" ...";xows_gui_doc(e,"edit_inpt").setAttribute("placeholder",o)}if(o&nn){const o=xows_gui_doc(e,"peer_load");o.hidden||(o.hidden=!0),e.live=!0}}}function xows_gui_peer_switch_to(e){if(Wt&&e===Wt.addr)return;let o=e?xows_cli_peer_get(e,v_):null;if(o&&(o.type!==b_||o.join||(xows_cli_muc_join(o),o=null)),Wt){if(!o||o.type===Wt.type){const e=xows_doc("rost_fram").querySelector("ROW-PAGE:not([hidden])").querySelector(".SELECTED");e&&e.classList.remove("SELECTED")}xows_cli_chst_self_set(Wt,he),xows_gui_doc_export(Wt),xows_gui_wnd_title_pop()}if(o){{const e=xows_gui_rost_list_find(o.addr);e.classList.toggle("SELECTED",!0),xows_gui_app_tab_select(e.closest("ROW-PAGE").dataset.tab)}xows_gui_doc_import(o),xows_gui_badg_unrd_reset(o),xows_gui_edit_inpt_setfocus(),xows_gui_layout_chat_view(),xows_gui_wnd_title_set("@"+o.name+" - XOWS"),xows_log(2,"gui_switch_peer",'peer "'+o.addr+'"',"selected")}Wt||(xows_log(2,"gui_switch_peer","unselect peer"),xows_gui_layout_rost_view())}function xows_gui_layout_hand_onclick(e){xows_cli_pres_show_back(),xows_gui_layout_chat_view()}function xows_gui_layout_chat_view(){xows_cli_pres_show_back(),xows_doc_cls_rem("main_wrap","MUCL-WIDE"),xows_doc_cls_rem("main_wrap","ROST-WIDE")}function xows_gui_layout_rost_view(){xows_doc_cls_add("main_wrap","ROST-WIDE")}function xows_gui_layout_muc_toggle(){if(window.matchMedia("(max-width: 799px)").matches)xows_doc_cls_add("main_wrap","MUCL-WIDE");else if(Wt){const e=xows_doc("mucl_col");e.hidden=!e.hidden}}const cn=[];function xows_gui_wnd_title_set(e){cn.push(document.title),document.title=e}function xows_gui_wnd_title_pop(){document.title=cn.pop()}function xows_gui_wnd_onback(e){xows_cli_cnx_cntd()&&!xows_doc_popu_modal()&&(history.forward(),xows_gui_wnd_exit_mbox_open())}let rn=!0;function xows_gui_wnd_onfocus(e){switch(e.type){case"focus":case"blur":rn||xows_cli_pres_show_back();break;case"visibilitychange":z_&&!document.hidden&&xows_cli_cnx_resume(10)}rn=document.hasFocus()}function xows_gui_wnd_unload(e){xows_cli_onuload()}function xows_gui_wnd_noti_onperm(e){Wt&&xows_gui_doc_update(Wt,en)}function xows_gui_wnd_noti_ask(){"granted"!==Notification.permission&&Notification.requestPermission().then(xows_gui_wnd_noti_onperm)}function xows_gui_wnd_noti_allowed(){return"granted"===Notification.permission}function xows_gui_wnd_noti_emit(e,o){if(e.noti)switch(xows_log(2,"gui_wnd_noti_emi",e.name,Notification.permission),Notification.permission){case"denied":return;case"granted":{const _=xows_cach_avat_get(e.avat),s="/"+Mn.lib_path+"/logo.svg",t=_||s;new Notification(e.name,{body:o,icon:t,badge:s});xows_snd_sample_play("notify")}break;default:xows_gui_wnd_noti_ask()}}const ln={constr:null,onmedia:null,onabort:null,payload:null,error:null};function xows_gui_wnd_media_try(e,o,_,s){const t=ln;if(e)t.constr=e,t.onmedia=o,t.onabort=_,t.payload=s,t.error=null;else if(!t.constr)return void xows_log(1,"gui_getmedia_try","invalid usage","constraints not defined");navigator.mediaDevices.getUserMedia(t.constr).then(e=>t.onmedia(t.payload,e),xows_gui_wnd_media_onfail)}function xows_gui_wnd_media_onfail(e){ln.error=e,"NotAllowedError"===e.name?xows_gui_wnd_media_onabort():(xows_log(1,"gui_getmedia_onfail","input devices access failed",e.name),xows_doc_mbox_open(At,"Input devices access","Getting access to input devices failed, would you like to retry ?",xows_gui_wnd_media_try,"Retry",xows_gui_wnd_media_onabort,"Cancel"))}function xows_gui_wnd_media_onabort(){const e=ln;xows_isfunc(e.onabort)&&e.onabort(e.payload,e.error)}const an=new Array(256);function xows_gui_wnd_onkey(e){if(xows_cli_pres_show_back(),an[e.keyCode]="keydown"===e.type,"keydown"===e.type&&(27===e.keyCode&&(xows_gui_mesg_repl_dlg_close(e.target),xows_gui_mesg_retr_dlg_abort(e.target)),13===e.keyCode)){if(an[16])return;switch(e.preventDefault(),e.target.tagName){case"CHAT-INPT":xows_gui_edit_inpt_onenter(e.target);break;case"MESG-INPT":xows_gui_mesg_repl_dlg_valid(e.target)}}}function xows_gui_wnd_exit_mbox_onabort(){}function xows_gui_wnd_exit_mbox_onvalid(){xows_cli_cnx_close(),history.back()}function xows_gui_wnd_exit_mbox_open(){xows_doc_mbox_open(Ft,"Disconnect","Do you really want to disconnect current session ?",xows_gui_wnd_exit_mbox_onvalid,"Yes",xows_gui_wnd_exit_mbox_onabort,"No",!0)}function xows_gui_badg_update_tabs(e,o,_,s){let t,n;switch(e.type){case b_:t=xows_doc("tab_room"),n=xows_doc("room_noti");break;case y_:t=xows_doc("tab_occu"),n=xows_doc("priv_noti");break;default:t=xows_doc("tab_cont"),n=xows_doc("cont_noti")}let c=parseInt(n.dataset.mesg);o&&(c+=o,n.dataset.mesg=c);let i=parseInt(n.dataset.call);_&&(i+=_,n.dataset.call=i);let r=parseInt(n.dataset.ring);s&&(r+=s,n.dataset.ring=r),t.classList.toggle("RINGING",r>0)}function xows_gui_badg_unrd_mesg(e,o){const _=xows_gui_rost_list_find(e.addr);if(!_)return;const s=_.querySelector("BADG-NOTI");s.dataset.mesg=parseInt(s.dataset.mesg)+1,xows_gui_badg_update_tabs(e,1,null,null)}function xows_gui_badg_unrd_call(e,o){const _=xows_gui_rost_list_find(e.addr);if(!_)return;_.classList.toggle("RINGING",o);const s=_.querySelector("BADG-NOTI"),t=parseInt(s.dataset.ring)>0;s.dataset.ring=o?1:0,s.dataset.call=o?0:1,xows_gui_badg_update_tabs(e,null,o?0:1,o?1:t?-1:0)}function xows_gui_badg_unrd_reset(e){const o=xows_gui_rost_list_find(e.addr);if(!o)return;o.classList.remove("RINGING");const _=o.querySelector("BADG-NOTI"),s=-parseInt(_.dataset.mesg),t=-parseInt(_.dataset.ring),n=-parseInt(_.dataset.call);_.dataset.mesg=0,_.dataset.ring=0,_.dataset.call=0,xows_gui_badg_update_tabs(e,s,n,t)}function xows_gui_badg_buzy(e,o){const _=xows_gui_rost_list_find(e.addr);if(_)switch(_.querySelector("BADG-CALL").hidden=!o,e.type){case y_:xows_doc("priv_call").hidden=!o;break;case b_:xows_doc("room_call").hidden=!o;break;default:xows_doc("cont_call").hidden=!o}}function xows_gui_app_fram_onclick(e){if(xows_cli_pres_show_back(),xows_gui_layout_rost_view(),e.target.id,"ROST-TAB"===e.target.tagName){const o=xows_gui_app_tab_select(e.target.id).querySelector(".SELECTED");o&&o.classList.contains("PEER-OCCU")?xows_gui_peer_switch_to(o.dataset.id):xows_gui_peer_switch_to(o?o.dataset.id:null)}}function xows_gui_app_tab_select(e){let o;const _=xows_doc("rost_tabs").querySelectorAll("ROST-TAB");for(let s=0;s<_.length;++s){const t=_[s].id===e;xows_doc_cls_tog(_[s].id,"SELECTED",t);const n=xows_doc(_[s].dataset.page);n.hidden=!t,t&&(o=n)}return o}const un={name:null,addr:null,avat:null,stat:null};function xows_gui_self_onpush(e,o){xows_doc("self_show").dataset.show=e.show,xows_doc("self_meta").innerText=e.stat;const _=xows_doc("drop_self");if(_.querySelector("PEER-ADDR").innerText=e.addr,_.querySelector("PEER-META").innerText=e.stat,un.avat!==e.avat||un.name!==e.name){const s=xows_tpl_spawn_avat_cls(e);xows_doc("self_avat").className=s,_.querySelector("PEER-AVAT").className=s,xows_doc("self_name").innerText=e.name,_.querySelector("PEER-NAME").innerText=e.name;for(let _=0;_<k_.length;++_)k_[_].live&&xows_gui_hist_update(k_[_],e,o);for(let _=0;_<A_.length;++_)A_[_].live&&xows_gui_hist_update(A_[_],e,o)}Object.assign(un,e)}function xows_gui_self_fram_onclick(e){xows_cli_pres_show_back(),"self_acct"!==e.target.id?e.target.closest("#self_bttn")&&xows_doc_menu_toggle(xows_doc("self_bttn"),"drop_self",xows_gui_self_menu_onclick):xows_gui_page_acct_open()}function xows_gui_self_menu_onclick(e){xows_cli_pres_show_back(),xows_doc_menu_toggle(xows_doc("self_bttn"),"drop_self"),"self_bt_edit"===e.target.id&&xows_gui_page_user_open(),e.target.closest("#self_mi_stat")&&xows_gui_self_stat_ibox_open();const o=e.target.closest("LI");if(o){const e=parseInt(o.value);if(!(e>0))return void xows_gui_disconnect();xows_cli_pres_show_set(e)}}function xows_gui_self_stat_ibox_onvalid(e){return e!==F_.stat&&xows_cli_pres_stat_set(e),!0}function xows_gui_self_stat_ibox_oninput(e){}function xows_gui_self_stat_ibox_open(){xows_doc_ibox_open(xows_l10n_get("Edit status message"),xows_l10n_get("Indicate anything you want to mention about your current situation."),xows_l10n_get("Enter a status message..."),F_.stat,xows_gui_self_stat_ibox_onvalid,null,null,null,xows_gui_self_stat_ibox_oninput,!0)}function xows_gui_chat_head_onclick(e){switch(xows_cli_pres_show_back(),e.target.id){case"chat_menu":xows_doc_menu_toggle(e.target,"drop_room",xows_gui_muc_room_menu_onclick,xows_gui_muc_room_menu_onshow,xows_gui_muc_room_menu_onclose);break;case"chat_bkad":xows_gui_muc_bkad_mbox_open(Wt);break;case"chat_bkrm":xows_gui_muc_bkrm_mbox_open(Wt);break;case"chat_noti":Wt.noti=!e.target.classList.toggle("DISABLED"),xows_cach_peer_save(Wt),xows_gui_wnd_noti_allowed()?xows_gui_doc_update(Wt,en):xows_gui_wnd_noti_ask();break;case"chat_mucl":xows_gui_layout_muc_toggle();break;case"chat_addc":xows_gui_rost_subs_rqst_pupu(Wt.jbar);break;case"chat_calv":case"chat_cala":xows_gui_call_self_invite(Wt,{audio:!0,video:"chat_calv"===e.target.id})}}function xows_gui_upld_onclick(e){"upld_exit"===e.target.id&&xows_gui_upld_close(Wt)}function xows_gui_upld_close(e){xows_cli_upld_has(e)&&xows_cli_upld_abort(e);const o=xows_gui_doc(e,"hist_upld");xows_doc_listener_rem(o,"click",xows_gui_upld_onclick),o.hidden=!0}function xows_gui_upld_start(e,o){const _=xows_gui_doc(e,"upld_text");_.classList="",xows_gui_doc(e,"upld_pbar").style.width="0%",_.innerText=o.name;const s=xows_gui_doc(e,"hist_upld");xows_doc_listener_add(s,"click",xows_gui_upld_onclick),s.hidden=!1,e===Wt&&xows_gui_hist_scrl_down(e,!1),xows_cli_upld_query(e,o)}function xows_gui_upld_onporg(e,o){xows_gui_doc(e,"upld_pbar").style.width=o+"%"}function xows_gui_upld_onload(e,o,_){switch(o){case ps:case ms:{const s=xows_gui_doc(e,"upld_text");let t;s.className="STYL-ERR",t=o===ps?"Upload denied":"Upload failed",s.innerHTML="<b>"+xows_l10n_get(t)+"</b> : "+_}return;case xs:xows_cli_msg_send(e,_,null,null,null,_);break;default:xows_log(1,"gui_upld_onload","upload aborted")}xows_gui_upld_close(e)}function xows_gui_page_wait_onclick(e){"wait_abrt"===e.id&&(xows_gui_disconnect(),xows_gui_reset(),xows_gui_page_auth_open())}function xows_gui_page_wait_open(e){xows_doc("wait_text").innerText=xows_l10n_get(e),xows_doc_page_open("page_wait",!1,null,null,xows_gui_page_wait_onclick)}function xows_gui_page_auth_oninput(e){xows_doc("auth_cnct").disabled=!(xows_doc("auth_user").value.length&&xows_doc("auth_pass").value.length)}function xows_gui_page_auth_onclick(e){if("auth_cnct"!==e.id)"auth_regi"===e.id&&xows_gui_page_regi_open();else if(!xows_doc("auth_cnct").disabled){const e=xows_doc("auth_user").value.toLowerCase(),o=xows_doc("auth_pass").value,_=xows_doc("auth_save").checked;xows_doc("auth_pass").value="",xows_gui_connect(e,o,_,!1)}}function xows_gui_page_auth_open(){xows_doc("auth_user").value=Kt?Kt.user:"",xows_doc("auth_pass").value=Kt?Kt.pass:"",xows_doc_show("auth_auto",xows_gui_cred_support()||Mn.login_sasl_store),xows_doc("auth_cnct").disabled=!(xows_doc("auth_user").value.length&&xows_doc("auth_pass").value.length),xows_doc("auth_regi").hidden=!Mn.gui_allow_register,xows_doc_page_open("page_auth",!1,null,xows_gui_page_auth_oninput,xows_gui_page_auth_onclick)}function xows_gui_page_regi_oninput(e){let o=!0;xows_doc("regi_user").value.length&&xows_doc("regi_pass").value.length&&xows_doc_cls_has("regi_capt","CAPTCHA-CHECKED")&&(o=!1),xows_doc("regi_subm").disabled=o}function xows_gui_page_regi_onclick(e){if("regi_capt"===e.id)return xows_doc_cls_add("regi_capt","CAPTCHA-CHECKED"),void xows_gui_page_regi_oninput(e);if("regi_subm"!==e.id)"regi_canc"===e.id&&xows_gui_page_auth_open();else if(!xows_doc("regi_subm").disabled){const e=xows_doc("regi_user").value,o=xows_doc("regi_pass").value;if(!xows_cli_isnodeprep(e))return void xows_doc_popu_open(Ft,"Username contains illegal character: '\"&;<>/:@");xows_gui_connect(e,o,!1,!0)}}function xows_gui_page_regi_open(){xows_doc("regi_user").value="",xows_doc("regi_pass").value="",xows_doc("regi_subm").disabled=!0,xows_doc_cls_rem("regi_capt","CAPTCHA-CHECKED"),xows_doc_page_open("page_regi",!1,null,xows_gui_page_regi_oninput,xows_gui_page_regi_onclick)}function xows_gui_page_user_onabort(){let e;xows_doc("user_name").value=F_.name,F_.avat?(e=xows_cach_avat_get(F_.avat),xows_doc("user_avat").data=e):(e=xows_cach_avat_temp_data(F_.addr,null),xows_doc("user_avat").data=null),xows_doc("user_avat").style.backgroundImage='url("'+e+'")',xows_doc("user_accs").checked=!0}function xows_gui_page_user_onvalid(){xows_cli_self_edit(xows_doc("user_name").value,xows_doc("user_avat").data,xows_doc("user_accs").checked)}function xows_gui_page_user_oninput(e){let o;switch(e.id){case"user_accs":o=!xows_doc("user_accs").checked;break;case"user_name":o=xows_doc("user_name").value!==F_.name}o&&xows_doc_popu_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)}function xows_gui_page_user_onclick(e){if("user_bt_avch"!==e.id){if("user_bt_avrm"===e.id){const e=xows_doc("user_avat");e.data=null;const o=xows_cach_avat_temp_data(F_.addr,null);e.style.backgroundImage='url("'+o+'")',xows_doc_popu_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)}}else xows_doc("user_file").click()}function xows_gui_page_user_onfile(e){const o=xows_doc("user_file");if(o.files[0]){const e=new FileReader;e.onload=function(e){const o=new Image;o.onload=function(e){const o=xows_gen_avatar(rs,this,null),_=xows_doc("user_avat");_.data=o,_.style.backgroundImage='url("'+o+'")',xows_doc_popu_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)},o.src=e.target.result},e.readAsDataURL(o.files[0])}}function xows_gui_page_user_onclose(){xows_doc_listener_rem(xows_doc("user_file"),"change",xows_gui_page_user_onfile)}function xows_gui_page_user_open(){xows_gui_page_user_onabort(),xows_doc("user_addr").innerText=F_.addr,xows_doc_page_open("page_user",!0,xows_gui_page_user_onclose,xows_gui_page_user_oninput,xows_gui_page_user_onclick),xows_doc_listener_add(xows_doc("user_file"),"change",xows_gui_page_user_onfile)}function xows_gui_page_acct_oninput(e){const o=xows_doc("acct_pass"),_=xows_doc("acct_pnew"),s=xows_doc("acct_pcnf");xows_doc("acct_bt_pass").disabled=!o.value||!_.value||!s.value}function xows_gui_page_acct_onchpas(e,o){const _=xows_doc("acct_pass"),s=xows_doc("acct_pnew"),t=xows_doc("acct_pcnf");"error"===e?xows_doc_popu_open(vt,xows_l10n_get("Password change failed")+": "+o.name):xows_doc_popu_open(kt,"Password has been changed successfully"),_.setCustomValidity(""),_.value="",s.value="",t.setCustomValidity(""),t.value=""}function xows_gui_page_acct_onclick(e){const o=xows_doc("acct_pass"),_=xows_doc("acct_pnew"),s=xows_doc("acct_pcnf");if(o.setCustomValidity(""),s.setCustomValidity(""),"acct_bt_pass"===e.id){if(o.value!==R.pass)return xows_doc_popu_open(vt,"The current password you entered is wrong"),void o.setCustomValidity("Wrong password");if(_.value!==s.value)return xows_doc_popu_open(vt,"The password confirmation does not match"),void s.setCustomValidity("Confirmation does not match");xows_cli_regi_chpas(_.value,xows_gui_page_acct_onchpas)}"acct_bt_unrg"===e.id&&xows_gui_acct_unrg_mbox_open()}function xows_gui_page_acct_onclose(){}function xows_gui_page_acct_open(){const e=xows_doc("acct_pass"),o=xows_doc("acct_pnew"),_=xows_doc("acct_pcnf");e.setCustomValidity(""),e.value="",o.value="",_.setCustomValidity(""),_.value="",xows_doc("acct_addr").innerText=F_.addr,xows_doc_page_open("page_acct",!0,xows_gui_page_acct_onclose,xows_gui_page_acct_oninput,xows_gui_page_acct_onclick)}function xows_gui_acct_unrg_mbox_onabort(){}function xows_gui_acct_unrg_mbox_onvalid(){xows_cli_regi_remove(null,null,null)}function xows_gui_acct_unrg_mbox_open(){xows_doc_mbox_open(At,"Account deletion","Are you sure you want to delete your XMPP/Jabber account on this server ? This action cannot be reversed.",xows_gui_acct_unrg_mbox_onvalid,"Yes, farewell",xows_gui_acct_unrg_mbox_onabort,"God damn, NO !")}function xows_gui_prof_onclick(e,o){o&&"prof_addc"==o.id&&(xows_cli_subs_request(e.jbar),xows_doc_prof_update())}function xows_gui_prof_open(e){xows_doc_prof_open(e,xows_gui_prof_onclick)}function xows_gui_rost_head_onclick(e){switch(xows_cli_pres_show_back(),e.target.id){case"cont_bt_add":xows_gui_rost_subs_ibox_open();break;case"room_bt_add":xows_gui_muc_join_ibox_open();break;case"room_bt_upd":xows_gui_rost_roomlst_reload()}}function xows_gui_rost_list_onclick(e){xows_cli_pres_show_back();const o=e.target.closest("LI-PEER");if(o){if("BUTTON"===e.target.tagName)switch(e.target.name){case"cont_bt_rtry":return void xows_gui_rost_subs_rqst_pupu(o.dataset.id);case"cont_bt_unsb":return void xows_gui_rost_unsb_mbox_open(xows_cli_cont_get(o.dataset.id));case"room_bt_retr":return void xows_gui_muc_bkrm_mbox_open(xows_cli_room_get(o.dataset.id))}o.classList.contains("PEER-PEND")?xows_gui_rost_auth_mbox_open(o.dataset.id):xows_gui_peer_switch_to(o.dataset.id)}}function xows_gui_rost_list_find(e,o=null){const _=xows_doc("rost_fram").querySelectorAll("LI-PEER");for(let s=0;s<_.length;++s)if(o&&_[s].dataset.ocid==o||_[s].dataset.id===e)return _[s];return null}function xows_gui_rost_list_insert(e,o,_=!1){let s=null;if(_)s=e.firstElementChild;else{const _=o.dataset.id;for(const o of e.children)if(xows_strcmp(_,o.dataset.id)<0){s=o;break}}e.insertBefore(o,s)}function xows_gui_rost_list_rise(e){let o=null;const _=xows_doc("rost_fram").querySelectorAll("LI-PEER");for(let s=0;s<_.length;++s)if(_[s].dataset.id===e.addr){o=_[s];break}if(o){const e=o.parentNode;o!==e.firstElementChild&&e.insertBefore(o,e.firstElementChild)}}function xows_gui_rost_contlst_update(){xows_doc_cls_rem("cont_list","LOADING");const e=xows_doc("cont_pend"),o=e.childElementCount;e.hidden=0==o,xows_doc("cont_noti").dataset.subs=o;const _=xows_doc("cont_budy");_.hidden=!_.childElementCount}function xows_gui_rost_roomlst_reload(){Wt&&Wt.publ&&xows_gui_peer_switch_to(null),xows_doc_cls_add("room_list","LOADING"),xows_doc("room_publ").innerHTML="",setTimeout(xows_cli_muc_list_query,500)}function xows_gui_rost_roomlst_update(){const e=xows_doc("room_publ");e.hidden=!e.childElementCount;const o=xows_doc("room_priv");o.hidden=!o.childElementCount;const _=xows_doc("room_book");_.hidden=!_.childElementCount}function xows_gui_rost_cont_onpush(e,o,_){if(!e)return void xows_doc_cls_rem("cont_list","LOADING");let s=xows_gui_rost_list_find(e.addr);s&&("PEER-PEND"==s.className?e.subs!=Ue&&(xows_doc("cont_pend").removeChild(s),s=null):(xows_tpl_update_peer_cont(s,e,o,_),xows_gui_doc_update(e),xows_gui_hist_update(e,e,o),e.show<1&&xows_gui_edit_onchst(e,0)));const t=e.subs&ze?xows_doc("cont_budy"):xows_doc("cont_pend");s||(s=xows_tpl_spawn_peer_cont(e,_),xows_gui_doc_init(e)),s.parentNode!=t&&xows_gui_rost_list_insert(t,s),xows_gui_rost_contlst_update()}function xows_gui_rost_cont_onpull(e){const o=xows_gui_rost_list_find(e.addr);if(o){Wt===e&&xows_gui_peer_switch_to(null),o.parentNode.removeChild(o)}xows_gui_rost_contlst_update(),xows_cli_cont_rem(e)}function xows_gui_rost_subs_onpush(e,o){const _=xows_doc("cont_pend");let s=xows_gui_rost_list_find(e.addr);s?xows_tpl_update_peer_subs(s,e):s=xows_tpl_spawn_peer_subs(e),s.parentNode!=_&&xows_gui_rost_list_insert(_,s),xows_gui_rost_contlst_update()}function xows_gui_rost_room_onpush(e,o){if(!e)return xows_doc_cls_rem("room_list","LOADING"),void xows_gui_rost_roomlst_update();let _;_=e.publ&&e.locl?xows_doc("room_publ"):e.book?xows_doc("room_book"):xows_doc("room_priv");let s=xows_gui_rost_list_find(e.addr);s?(xows_tpl_update_peer_room(s,e,o),xows_gui_doc_update(e)):(s=xows_tpl_spawn_peer_room(e),xows_gui_doc_init(e)),s.parentNode!==_&&xows_gui_rost_list_insert(_,s),xows_gui_rost_roomlst_update()}function xows_gui_rost_room_onpull(e){const o=xows_gui_rost_list_find(e.addr);o&&(Wt&&Wt===e&&xows_gui_peer_switch_to(null),xows_log(2,"gui_rost_room_onpull","Remove Room element",e.addr),o.parentNode.removeChild(o)),xows_gui_rost_roomlst_update(),xows_cli_room_rem(e)}function xows_gui_rost_occu_init(e){e.jbar&&xows_cli_cont_get(e.jbar)?xows_gui_peer_switch_to(e.jbar):(xows_cli_ocpm_add(e),xows_gui_rost_occu_onpush(e,255),xows_gui_peer_switch_to(e.addr))}function xows_gui_rost_occu_onpush(e,o,_){const s=xows_doc("priv_occu");if(_&&_.code.includes(303)){if(!_.prev)return void xows_log(1,"gui_cli_onprivpush","missing previous JID for nickname change");let o=xows_gui_rost_list_find(_.prev,e.ocid);o&&(o.dataset.id=e.addr),xows_gui_doc_reassign(e,_.prev)}let t=xows_gui_rost_list_find(e.addr,e.ocid);if(t){if(xows_tpl_update_peer_occu(t,e,o),xows_gui_doc_update(e),xows_gui_hist_update(e,e,o),!(e.show!==Ie||_&&_.code.includes(303))){xows_gui_doc(e,"hist_ul").appendChild(xows_tpl_mesg_null_spawn(0,"internal",e.name+" "+xows_l10n_get("joined the conversation")))}}else t=xows_tpl_spawn_peer_occu(e,!0),xows_gui_doc_init(e);t.parentNode!=s&&xows_gui_rost_list_insert(s,t,!0),xows_doc_show("tab_occu")}function xows_gui_rost_occu_onpull(e){xows_doc("priv_occu");let o=xows_gui_rost_list_find(e.addr,e.ocid);if(o){xows_tpl_update_peer_occu(o,e),xows_gui_doc_update(e),xows_gui_doc(e,"hist_ul").appendChild(xows_tpl_mesg_null_spawn(0,"internal",e.name+" "+xows_l10n_get("has left the conversation")))}}function xows_gui_rost_subs_rqst_pupu(e){xows_cli_subs_request(e),xows_doc_popu_open(kt,"New subscription authorization request was sent")}function xows_gui_rost_subs_ibox_oninput(e){xows_doc_ibox_allow(e.length&&xows_isjid(e))}function xows_gui_rost_subs_ibox_onvalid(e){return xows_gui_rost_subs_rqst_pupu(e),!0}function xows_gui_rost_subs_ibox_open(){xows_doc_ibox_open("Subscribes to contact","A subscription authorization request will be sent to the specified address, you'll have to wait for contact to allow to that request.","Enter contact XMPP address...",null,xows_gui_rost_subs_ibox_onvalid,"Add",null,null,xows_gui_rost_subs_ibox_oninput,!0)}const dn={cont:null};function xows_gui_rost_unsb_mbox_onabort(){}function xows_gui_rost_unsb_mbox_onvalid(){xows_cli_subs_revoke(dn.cont)}function xows_gui_rost_unsb_mbox_open(e){dn.cont=e;let o="Do you really want to remove contact and ";e.subs?o+="revoke subscription authorization ?":o+="abort subscription authorization request ?",xows_doc_mbox_open(Ft,"Revoke contact subscription",o,xows_gui_rost_unsb_mbox_onvalid,"OK",xows_gui_rost_unsb_mbox_onabort,"Cancel")}const xn={cont:null};function xows_gui_rost_auth_mbox_onabort(){xows_cli_subs_answer(xn.cont,!1)}function xows_gui_rost_auth_mbox_onvalid(){xows_cli_subs_answer(xn.cont,!0)}function xows_gui_rost_auth_mbox_open(e){xn.cont=xows_cli_cont_get(e),xows_doc_mbox_open(At,"Contact subscription request","A new contact is requesting subscription authorization. Would you like to grant authorization and add this contact ?",xows_gui_rost_auth_mbox_onvalid,"Allow",xows_gui_rost_auth_mbox_onabort,"Deny")}function xows_gui_hist_scrl_get(e){return e===Wt?document.getElementById("chat_hist").scrollBottom:parseInt(bt.get(e.addr).getElementById("chat_hist").dataset.scrollbottom)}function xows_gui_hist_scrl_down(e,o=!0){xows_gui_edit_alrt_update(Wt,0,0),e===Wt?xows_doc_scroll_todown(document.getElementById("chat_hist"),o):bt.get(e.addr).getElementById("chat_hist").dataset.scrollbottom=0}let wn=null;function xows_gui_hist_onscroll(e){if(!Wt)return;const o=xows_doc("chat_hist");o.scrollTop<=100?wn||(wn=setTimeout(xows_gui_mam_fetch_older,Mn.gui_archive_delay,Wt)):o.scrollTop>100&&wn&&(clearTimeout(wn),wn=null),xows_gui_edit_alrt_update(Wt,o.scrollBottom,o.clientHeight)}function xows_gui_hist_onclick(e){if(xows_cli_pres_show_back(),"IMG"===e.target.tagName)return void xows_doc_view_open(e.target);const o=e.target.closest("MESG-RPLY");if(o)return void xows_gui_hist_mesg_hligh(Wt,o.dataset.id);const _=e.target.closest("LI-MESG");if(_){if(e.type.startsWith("touch")){const e=xows_doc("hist_ul").querySelector("LI-MESG.SELECTED");e&&e.classList.remove("SELECTED"),_&&_.classList.add("SELECTED")}if("BUTTON"===e.target.tagName&&e.target.name)switch(e.target.name){case"mesg_bt_edit":xows_gui_mesg_repl_dlg_open(_);break;case"edit_bt_abort":xows_gui_mesg_repl_dlg_close(_);break;case"edit_bt_valid":xows_gui_mesg_repl_dlg_valid(_.querySelector("MESG-INPT"));break;case"mesg_bt_trsh":xows_gui_mesg_retr_dlg_open(_);break;case"trsh_bt_abort":xows_gui_mesg_retr_dlg_abort(_);break;case"trsh_bt_valid":xows_gui_mesg_retr_dlg_valid(_);break;case"mesg_bt_rply":xows_gui_edit_rply_set(_)}else;}}function xows_gui_hist_update(e,o,_=255){if(!(_&C_|T_))return;const s=xows_gui_doc(e,"hist_ul");if(!s||!s.children.length)return;const t=xows_cli_peer_iden(o);if(_&C_){const e=s.querySelectorAll("MESG-FROM[data-peer='"+t+"'],RPLY-FROM[data-peer='"+t+"']");for(let _=0;_<e.length;++_)e[_].innerText=o.name}if(_&T_){const e=xows_tpl_spawn_avat_cls(o),_=s.querySelectorAll("MESG-AVAT[data-peer='"+t+"'],RPLY-AVAT[data-peer='"+t+"']");for(let o=0;o<_.length;++o)_[o].className=e}}function xows_gui_hist_resume(e){const o=xows_gui_doc(e,"hist_ul");if(!o||!o.children.length)return;const _=o.querySelectorAll(".MESG-SENT");for(let e=0;e<_.length;++e)_[e].classList.contains("MESG-RECP")||_[e].classList.add("MESG-FAIL")}function xows_gui_hist_mesg_find(e,o,_,s=!1){let t,n=(t=e===Wt?document.getElementById("hist_ul"):bt.get(e.addr).getElementById("hist_ul")).querySelector("LI-MESG[data-id='"+o+"']");return n||(n=e.type===b_?t.querySelector("LI-MESG[data-szid='"+o+"']"):t.querySelector("LI-MESG[data-orid='"+o+"']")),s&&!n&&(n=xows_tpl_mesg_null_spawn(o,_,xows_l10n_get("The message is unreachable"))),n}function xows_gui_hist_mesg_repl(e,o,_){o.hidden=!0,o.innerHTML="";const s=xows_gui_doc(e,"hist_ul"),t=xows_tpl_mesg_bestref(e,o),n=s.querySelectorAll("MESG-RPLY[data-id='"+t+"']");for(let o=0;o<n.length;++o)xows_tpl_mesg_update(n[o].closest("LI-MESG"),e,null,null,_);const c=xows_gui_doc(e,"edit_rply");return c.dataset.id===t&&(c.dataset.id=xows_tpl_mesg_bestref(e,_)),s.insertBefore(_,o.nextSibling)}function xows_gui_hist_mesg_retr(e,o){const _=xows_gui_hist_mesg_find(e,o);if(!_)return void xows_log(1,"gui_hist_mesg_retract","retracted message not found",o);_.hidden=!0,_.innerHTML="";const s=xows_gui_doc(e,"hist_ul").querySelectorAll("MESG-RPLY[data-id='"+o+"']");if(s.length){const _=xows_tpl_mesg_null_spawn(o,"",xows_l10n_get("The message was deleted"));for(let o=0;o<s.length;++o)xows_tpl_mesg_update(s[o].closest("LI-MESG"),e,null,null,_)}const t=_.nextSibling;t&&t.dataset.from===_.dataset.from&&t.classList.toggle("MESG-APPEND",_.classList.contains("MESG-APPEND"))}function xows_gui_hist_mesg_hligh(e,o){const _=xows_gui_doc(e,"hist_ul").querySelector(".HIGHLIGHT");if(_&&_.classList.remove("HIGHLIGHT"),!o)return;const s=xows_gui_hist_mesg_find(e,o);s&&(s.classList.add("HIGHLIGHT"),e===Wt&&s.offsetTop-xows_doc("chat_main").scrollTop<0&&s.scrollIntoView({behavior:"smooth",block:"center"}))}let pn=null;function xows_gui_hist_onrecv(e,o,_,s,t){if(t){const _=xows_gui_hist_mesg_find(e,o.id);return _&&_.classList.add("MESG-FAIL"),void xows_log(1,"gui_cli_onmessage","message error",t.name)}if(e.type===b_){const _=xows_gui_hist_mesg_find(e,o.orid?o.orid:o.id);if(_)return void xows_tpl_mesg_update(_,e,o,!0)}let n,c;if(o.repl&&!(n=xows_gui_hist_mesg_find(e,o.repl)))return;o.rpid&&(c=xows_gui_hist_mesg_find(e,o.rpid,o.rpto,!0));const i=xows_gui_doc(e,"hist_ul");let r=i.lastElementChild;for(;r&&r.hidden;)r=r.previousSibling;const l=xows_tpl_mesg_spawn(e,o,_,r,n,c);if(n?xows_gui_hist_mesg_repl(e,n,l):i.appendChild(l),!o.repl&&!e.self){let _=!0;e.type===b_&&(o.rpto&&xows_cli_comp(xows_cli_occu_self(e).addr,o.rpto)||(_=!1)),_&&e!==Wt&&xows_gui_badg_unrd_mesg(e,o.id),_&&!rn&&xows_gui_wnd_noti_emit(e,o.body)}xows_gui_hist_scrl_get(e)>50&&(s?xows_gui_hist_scrl_down(e,!1):xows_gui_edit_alrt_set(e,"UNREAD")),e.type!==b_&&e!==pn&&(xows_gui_rost_list_rise(e),pn=e)}function xows_gui_hist_onrecp(e,o){const _=xows_gui_hist_mesg_find(e,o);_?_.classList.add("MESG-RECP"):xows_log(1,"gui_cli_onreceipt","message not found",o)}function xows_gui_hist_onretr(e,o){xows_gui_hist_mesg_retr(e,o)}function xows_gui_mam_query(e,o,_=0){const s=xows_gui_doc(e,"hist_ul");let t,n=null;if(o)s.children.length&&(n=parseInt(s.lastElementChild.dataset.time)+25);else{if(xows_gui_doc(e,"hist_beg").className.length)return;s.children.length&&(t=parseInt(s.firstElementChild.dataset.time)-25)}0===_&&(_=Mn.cli_archive_count),xows_cli_mam_fetch(e,_,n,t,xows_gui_mam_parse)}function xows_gui_mam_fetch_newer(e){xows_gui_mam_query(e,!0)}function xows_gui_mam_fetch_older(e){let o=Mn.cli_archive_count;if(e.type===b_&&!e.live){let o=Mn.cli_archive_count;o-=xows_gui_doc(e,"hist_ul").children.length}o>0&&xows_gui_mam_query(e,!1,o)}function xows_gui_mam_parse(e,o,_,s,t){const n=xows_gui_doc(e,"hist_ul");let c=null;o||(c=n.firstElementChild);const i=xows_gui_doc(e,"hist_beg");let r,l,a,u=0;for(let o=0;o<_.length;++o){const s=_[o];if(s.retr){xows_gui_hist_mesg_retr(e,s.retr);continue}if(!s.body)continue;if(xows_gui_hist_mesg_find(e,s.orid?s.orid:s.id))continue;if(s.repl){if(!(r=xows_gui_hist_mesg_find(e,s.repl)))continue}else r=null;for(l=s.rpid?xows_gui_hist_mesg_find(e,s.rpid,s.rpto,!0):null;a&&a.hidden;)a=a.previousSibling;const t=xows_tpl_mesg_spawn(e,s,!1,a,r,l);r?xows_gui_hist_mesg_repl(e,r,t):a=n.insertBefore(t,c),u++}xows_log(2,"gui_mam_parse",u+" added messages for",e.addr),t&&(i.className="HIST-START");const d=o?Yt:Jt;e.load&d&&xows_load_task_done(e,d)}function xows_gui_mesg_repl_dlg_close(e){e&&"LI-MESG"===e.tagName||(e=xows_doc("hist_mesg").querySelector(".MESG-EDITOR")),e&&xows_tpl_mesg_edit_remove(e)}function xows_gui_mesg_repl_dlg_open(e){xows_gui_mesg_repl_dlg_close();const o=xows_tpl_mesg_edit_insert(e).querySelector("MESG-INPT");xows_doc_sel_caret_within(o),o.focus()}function xows_gui_mesg_repl_dlg_valid(e){const o=e.closest("LI-MESG"),_=e.innerText.trimEnd();if(_!==o.querySelector("MESG-BODY").dataset.raw){const e=o.querySelector("MESG-RPLY");xows_cli_msg_send(Wt,_,o.dataset.id,e.dataset.id,e.dataset.to)}xows_tpl_mesg_edit_remove(o)}function xows_gui_mesg_retr_dlg_abort(e){e&&"LI-MESG"==e.tagName||(e=xows_doc("hist_mesg").querySelector(".MESG-TRASH")),e&&xows_tpl_mesg_trsh_remove(e)}function xows_gui_mesg_retr_dlg_open(e){xows_gui_mesg_retr_dlg_abort(),xows_tpl_mesg_trsh_insert(e)}function xows_gui_mesg_retr_dlg_valid(e){const o=xows_tpl_mesg_bestref(Wt,e);o&&xows_cli_msg_retr(Wt,o)}function xows_gui_edit_onclick(e){if(xows_cli_pres_show_back(),"edit_inpt"!==e.target.id)switch(e.target.id){case"rply_clos":xows_gui_edit_rply_close();break;case"edit_upld":{const e=xows_doc("edit_file");e.value="",e.click();break}case"edit_emoj":xows_doc_menu_toggle(xows_doc("edit_emoj"),"drop_emoj",xows_gui_emoj_menu_onclick,xows_gui_emoj_menu_onshow);break;default:xows_gui_edit_inpt_setfocus()}}function xows_gui_edit_onfile(e){const o=xows_doc("edit_file").files[0];Wt&&o&&xows_gui_upld_start(Wt,o)}function xows_gui_edit_alrt_onclick(e){xows_gui_hist_scrl_down(Wt,!0)}function xows_gui_edit_alrt_update(e,o,_){const s=xows_gui_doc(e,"edit_alrt");o>=50?(o>_&&s.classList.add("OLDMSG"),s.hidden&&s.classList.length&&(e===Wt&&xows_doc_listener_add(s,"click",xows_gui_edit_alrt_onclick),s.hidden=!1)):(s.hidden||(e===Wt&&xows_doc_listener_rem(s,"click",xows_gui_edit_alrt_onclick),s.hidden=!0),s.classList.remove("OLDMSG"),s.classList.remove("UNREAD"))}function xows_gui_edit_alrt_set(e,o){const _=xows_gui_doc(e,"edit_alrt"),s=xows_gui_hist_scrl_get(e);s<50&&"UNREAD"===o||(_.classList.add(o),xows_gui_edit_alrt_update(e,s,s))}function xows_gui_edit_alrt_reset(e,o){xows_gui_doc(e,"edit_alrt").classList.remove(o);const _=xows_gui_hist_scrl_get(e);xows_gui_edit_alrt_update(e,_,_)}function xows_gui_edit_rply_close(){if(!xows_doc_cls_has("chat_edit","REPLY"))return;xows_doc_cls_rem("chat_edit","REPLY");const e=xows_doc("edit_rply");xows_doc("rply_name").innerText="",e.dataset.id="",e.dataset.to="",xows_gui_hist_mesg_hligh(Wt,null)}function xows_gui_edit_rply_set(e){xows_gui_edit_rply_close();const o=xows_doc("edit_rply"),_=xows_tpl_mesg_bestref(Wt,e);let s,t;s=Wt.type===h_?xows_jid_bare(e.dataset.from):e.dataset.from,t=Wt.type===b_?xows_cli_occu_get_or_new(Wt,s,e.dataset.ocid):Wt,xows_doc("rply_name").innerText=t.name,o.dataset.to=s,o.dataset.id=_,o.hidden=!1,xows_doc_cls_add("chat_edit","REPLY"),xows_gui_hist_mesg_hligh(Wt,_),xows_gui_edit_inpt_setfocus()}let mn=document.createRange();function xows_gui_edit_inpt_sel_save(){mn=yt.getRangeAt(0)}function xows_gui_edit_inpt_sel_load(){const e=xows_doc("edit_inpt");let o=mn;e.contains(o.commonAncestorContainer)||((o=mn=document.createRange()).selectNodeContents(e),o.collapse(!1)),yt.removeAllRanges(),yt.addRange(o)}function xows_gui_edit_inpt_oncaret(e){"keyup"===e.type&&(e.keyCode<35||e.keyCode>40)||xows_gui_edit_inpt_sel_save()}function xows_gui_edit_oninput(e){xows_cli_pres_show_back(),Wt&&xows_cli_chst_self_set(Wt,Fe),xows_gui_edit_inpt_sel_save();const o=document.getElementById("edit_inpt");o.innerText.length<2&&0===o.innerText.trim().length&&(o.innerText="")}function xows_gui_edit_inpt_setfocus(){xows_doc("edit_inpt").focus()}function xows_gui_edit_inpt_onenter(e){if(xows_cli_pres_show_back(),!Wt)return;if(!e.innerText.length)return;const o=xows_doc("edit_rply");xows_cli_msg_send(Wt,e.innerText.trimEnd(),null,o.dataset.id,o.dataset.to),e.innerText="",xows_gui_edit_rply_close(),xows_gui_edit_inpt_sel_save(),xows_cli_chst_self_set(Wt,be)}function xows_gui_edit_inpt_onpaste(e){if(xows_cli_pres_show_back(),!Wt)return;let o=e.clipboardData.getData("text");o.length&&(e.preventDefault(),xows_cli_chst_self_set(Wt,Fe),xows_doc_sel_paste(document.createTextNode(o)),xows_gui_edit_inpt_sel_save())}function xows_gui_edit_inpt_insert(e,o,_=!1){if(xows_cli_pres_show_back(),!Wt)return;const s=document.getElementById("edit_inpt");let t;o?((t=document.createElement(o)).appendChild(document.createTextNode(e)),_||t.setAttribute("contenteditable",!1)):t=document.createTextNode(e),xows_gui_edit_inpt_sel_load(),xows_doc_sel_paste(t),xows_gui_edit_inpt_sel_save(),s.focus()}function xows_gui_edit_onchst(e,o){const _=xows_gui_doc(e,"edit_stat");if(_){if(e.type===b_){const o=e.writ.length;if(o<1)return _.innerText="",void(_.hidden=!0);if(o>1){let s="";const t=o>2?2:o-1;for(let o=0;o<t;++o)s+="<b>"+e.writ[o].name+"</b>",o<t-1&&(s+=", ");s+=" "+xows_l10n_get("and")+" <b>";const n=o-t;s+=n>1?n+" "+xows_l10n_get("other(s)")+"</b> ":e.writ[o-1].name+"</b> ",_.innerHTML=s+xows_l10n_get("are currently writing")}else _.innerHTML="<b>"+e.writ[0].name+"</b> "+xows_l10n_get("is currently writing")}else{if(e.chat<Fe)return _.innerText="",void(_.hidden=!0);_.innerHTML="<b>"+e.name+"</b> "+xows_l10n_get("is currently writing")}_.hidden=!1}}function xows_gui_emoj_menu_onshow(e,o){const _=e.getBoundingClientRect(),s=window.getComputedStyle(o),t=parseInt(s.getPropertyValue("margin-bottom")),n=parseInt(s.getPropertyValue("margin-right"));o.style.right=window.innerWidth-(_.right-n)+"px",o.style.bottom=window.innerHeight-(_.top-t)+"px"}function xows_gui_emoj_menu_onclick(e){if(xows_cli_pres_show_back(),"LI"===e.target.tagName)xows_gui_edit_inpt_insert(e.target.innerText,"EMO-JI",!1);else if("emoj_clos"!==e.target.id)return;xows_gui_edit_inpt_setfocus(),xows_doc_menu_close()}function xows_gui_muc_onjoin(e,o,_){if(_){if("auth"===_.type){if("forbidden"===_.name)return void xows_gui_muc_fail_mbox_open("auth","You cannot join this Channel because you are banned.");if("not-authorized"===_.name)return void xows_gui_muc_pswd_ibox_open(e);if("registration-required"===_.name)return void xows_gui_muc_regi_ibox_open(e)}if("cancel"==_.type){if("gone"===_.name)return void xows_gui_muc_dstr_mbox_open(_.text);if("not-allowed"==_.name)return void xows_gui_muc_fail_mbox_open("create","The specified Channel does not exists and Channel creation is restricted.");if("conflict"===_.name)return void xows_gui_muc_cflt_ibox_open(e);if("item-not-found"===_.name)return void xows_gui_muc_fail_mbox_open("auth","The specified Channel does not exists or is currently locked waiting for configuration.")}return"wait"===_.type&&"service-unavailable"==_.name?void xows_gui_muc_fail_mbox_open("auth","The Channel is temporarily unavailable because it have reached maximum number of occupants."):void xows_gui_muc_fail_mbox_open("","<"+_.name+"> "+_.text)}e.live||xows_gui_peer_switch_to(e.addr),xows_gui_doc_update(e),e.init&&xows_gui_muc_init_mbox_open(e)}function xows_gui_muc_onexit(e,o){if(e===Wt&&xows_gui_peer_switch_to(null),xows_gui_doc_reset(e),o.destroy)return void xows_gui_muc_dstr_mbox_open(o.destroy);let _=null;o.code.includes(301)&&(_="You were banned from the Channel"),o.code.includes(307)&&(_="You were kicked from the Channel"),o.code.includes(321)&&(_="Rules changes caused you to leave the Channel"),o.code.includes(321)&&(_="Server error caused you to leave the Channel"),_&&(_+=" <b>"+e.name+"</b>",xows_doc_popu_open(Ft,_))}function xows_gui_muc_onsubj(e,o){xows_gui_doc_update(e,_n)}function xows_gui_muc_join_ibox_oninput(e){e.length?e.includes("@")?xows_doc_ibox_allow(xows_isjid(e)):xows_doc_ibox_allow(!0):xows_doc_ibox_allow(!1)}function xows_gui_muc_join_ibox_onvalid(e){return xows_isjid(e)||xows_cli_isnodeprep(e)?(xows_cli_muc_join(e),!0):(xows_doc_ibox_error("Channel ID contains illegal character: '\"&;<>/:@"),!1)}function xows_gui_muc_join_ibox_open(){xows_doc_ibox_open("Join or create a Channel","If the specified Channel does not exist and if server does not restrict Channel creation, a new Channel will be created with you as owner.","Enter Channel name or address...",null,xows_gui_muc_join_ibox_onvalid,"Join",null,null,xows_gui_muc_join_ibox_oninput,!0)}function xows_gui_muc_dstr_mbox_open(e){const o=xows_l10n_get("This Channel has been destroyed and is no longer available")+":<br><b>"+e+"</b>";xows_doc_mbox_open(Ft,"Channel unvailable",o,null,null,null,null)}function xows_gui_muc_fail_mbox_open(e,o){let _;switch(e){case"auth":_="Channel access";break;case"create":_="Channel creation";break;default:_="Channel join error"}xows_doc_mbox_open(vt,_,o,null,null,null,null)}const gn={room:null};function xows_gui_muc_init_mbox_onvalid(){const e=gn.room;xows_log(2,"gui_room_init_onvalid","request initial Room config",e.addr),xows_cli_muc_cfg_get(e,xows_gui_page_mucc_open)}function xows_gui_muc_init_mbox_onabort(){xows_cli_muc_cfg_set(gn.room,null)}function xows_gui_muc_init_mbox_open(e){gn.room=e,xows_doc_mbox_open(At,"Channel initialization","You just created a new Channel, would you want to configure it right now ?",xows_gui_muc_init_mbox_onvalid,"Configure",xows_gui_muc_init_mbox_onabort,"Ignore")}const fn={room:null};function xows_gui_muc_regi_ibox_onresult(e,o,_){if("error"!=o)xows_doc_ibox_close(),xows_gui_peer_switch_to(e.addr);else{if(_)switch(_.name){case"conflict":return xows_gui_muc_regi_ibox_open(e),void xows_doc_ibox_error("Nickname is already reserved in this Room");case"not-allowed":case"registration-required":return void xows_gui_muc_fail_mbox_open("auth","You cannot join this Channel because its access is restricted to members only.");case"forbidden":return void xows_gui_muc_fail_mbox_open("auth","You cannot join this Channel because you are banned.")}xows_gui_muc_fail_mbox_open("auth","Channel registration request failed.")}}function xows_gui_muc_regi_ibox_onvalid(e){return xows_cli_muc_regi_get_query(fn.room,e,xows_gui_muc_regi_ibox_onresult),!0}function xows_gui_muc_regi_ibox_open(e){fn.room=e,xows_doc_ibox_open("Channel registration","The nickname will be associated with your XMPP address and being reserved for you in this Room.","Enter nickname to register...",e.nick,xows_gui_muc_regi_ibox_onvalid,"Register",null,null,null,!0)}const hn={room:null};function xows_gui_muc_unrg_mbox_onabort(){}function xows_gui_muc_unrg_mbox_onvalid(){xows_cli_regi_remove(hn.room,null,null)}function xows_gui_muc_unrg_mbox_open(e){hn.room=e,xows_doc_mbox_open(Ft,"Channel unregister","Do you really want to unregister from Channel ?",xows_gui_muc_unrg_mbox_onvalid,"OK",xows_gui_muc_unrg_mbox_onabort,"Cancel")}const bn={room:null};function xows_gui_muc_pswd_ibox_onvalid(e){return xows_cli_muc_join(bn.room,e),!0}function xows_gui_muc_pswd_ibox_open(e){bn.room=e,xows_doc_ibox_open("Channel password","This Channel is password-protected, you must provide password in order to join it.","Enter a password...",e.pass,xows_gui_muc_pswd_ibox_onvalid,"Join",null,null,null,!0),e.pass&&xows_doc_ibox_error("The password you entered is incorrect")}const yn={room:null};function xows_gui_muc_cflt_ibox_onvalid(e){const o=yn.room;return o.nick=e,xows_cli_muc_join(o),!0}function xows_gui_muc_cflt_ibox_open(e){yn.room=e,xows_doc_ibox_open(xows_l10n_get("Nickname conflict"),xows_l10n_get("Your nickname conflicts with another Channel's occupant, please choose another nickname."),xows_l10n_get("Enter a nickname..."),e.nick,xows_gui_muc_cflt_ibox_onvalid,"Join",null,null,null,!0)}const vn={room:null};function xows_gui_muc_subj_ibox_oninput(e){}function xows_gui_muc_subj_ibox_onvalid(e){const o=vn.room,_=e.trimEnd();return _!=o.subj&&xows_cli_muc_subj_set(o,_),!0}function xows_gui_muc_subj_ibox_open(e){e.type===b_&&(vn.room=e,xows_doc_ibox_open(xows_l10n_get("Set topic of")+" #"+e.name,"Set the message of the day, a welcome message or the discussion subject.","Enter a topic...",e.subj,xows_gui_muc_subj_ibox_onvalid,null,null,null,xows_gui_muc_subj_ibox_oninput,!0))}const Fn={room:null};function xows_gui_muc_nick_ibox_onvalid(e){const o=Fn.room,_=e.trimEnd();return _!=xows_jid_resc(o.join)&&xows_cli_muc_nick_set(o,_),!0}function xows_gui_muc_nick_ibox_open(e){e.type===b_&&(Fn.room=e,xows_doc_ibox_open(xows_l10n_get("Nickname for")+" #"+e.name,"Specify your new nickname for this Channel.","Enter a nickname...",xows_jid_resc(e.join),xows_gui_muc_nick_ibox_onvalid,null,null,null,null,!0))}const kn={occu:null,affi:null};function xows_gui_muc_affi_mbox_onabort(){}function xows_gui_muc_affi_mbox_onvalid(){const e=kn;xows_cli_muc_affi_set(e.occu,e.affi)}function xows_gui_muc_affi_mbox_open(e,o){const _=kn;let s,t;if(_.occu=e,_.affi=o,o>Lo){switch(s="Change occupant affiliation",t=xows_l10n_get("Grant Channel affiliation")+" <b>",o){case Oo:t+=xows_l10n_get("Owner");break;case Ro:t+=xows_l10n_get("Administrator");break;case Po:t+=xows_l10n_get("Member");break;case Bo:t+=xows_l10n_get("None")}t+="</b> "+xows_l10n_get("to occupant")}else t=xows_l10n_get(s="Ban occupant");t+=" <b>"+e.name+"</b> ?",xows_doc_mbox_open(At,s,t,xows_gui_muc_affi_mbox_onvalid,"OK",xows_gui_muc_affi_mbox_onabort,"Cancel")}const An={occu:null,role:null};function xows_gui_muc_role_mbox_onabort(){}function xows_gui_muc_role_mbox_onvalid(){const e=An;xows_cli_muc_role_set(e.occu,e.role)}function xows_gui_muc_role_mbox_open(e,o){const _=An;let s,t;if(_.occu=e,_.role=o,o>To){switch(s="Change occupant role",t=xows_l10n_get("Assign the Channel role")+" <b>",o){case Io:t+=xows_l10n_get("Moderator");break;case jo:t+=xows_l10n_get("Participant");break;case Do:t+=xows_l10n_get("Visitor")}t+="</b> "+xows_l10n_get("to occupant")}else t=xows_l10n_get(s="Kick occupant");t+=" <b>"+e.name+"</b> ?",xows_doc_mbox_open(At,s,t,xows_gui_muc_role_mbox_onvalid,"OK",xows_gui_muc_role_mbox_onabort,"Cancel")}function xows_gui_muc_head_onclick(e){xows_cli_pres_show_back(),Wt.type}function xows_gui_muc_list_onclick(e){xows_cli_pres_show_back();const o=e.target.closest("LI-PEER");o&&"occu_bt_menu"===e.target.name&&(o.classList.add("SELECTED"),xows_doc_menu_toggle(e.target,"drop_occu",xows_gui_muc_occu_menu_onclick,xows_gui_muc_occu_menu_onshow,xows_gui_muc_occu_menu_onclose))}function xows_gui_muc_list_find(e,o,_=null){const s=xows_gui_doc(e,"mucl_list").querySelectorAll("LI-PEER");for(let e=0;e<s.length;++e)if(_&&s[e].dataset.ocid===_||s[e].dataset.id===o)return s[e];return null}function xows_gui_muc_list_update(e){const o=xows_gui_doc(e,"ownr_ul");o.hidden=!o.childElementCount;const _=xows_gui_doc(e,"admn_ul");_.hidden=!_.childElementCount;const s=xows_gui_doc(e,"modo_ul");s.hidden=!s.childElementCount;const t=xows_gui_doc(e,"part_ul");t.hidden=!t.childElementCount;const n=xows_gui_doc(e,"vist_ul");n.hidden=!n.childElementCount}function xows_gui_muc_list_insert(e,o){let _=null;const s=o.dataset.id;for(const o of e.children)if(xows_strcmp(s,o.dataset.id)<0){_=o;break}e.insertBefore(o,_)}function xows_gui_muc_list_onpush(e,o,_){const s=e.room;if(_){if(_.code.includes(303)){if(!_.prev)return void xows_log(1,"gui_cli_onoccupush","missing previous JID for nickname change");const o=xows_gui_muc_list_find(e.room,_.prev,e.ocid);o&&(o.dataset.id=e.addr)}_.code.includes(110)&&xows_gui_doc_update(s)}let t="vist_ul";if(e.affi>Po)t=e.affi>Ro?"ownr_ul":"admn_ul";else switch(e.role){case Io:t="modo_ul";break;case jo:t="part_ul"}let n=xows_gui_muc_list_find(e.room,e.addr,e.ocid);n?xows_tpl_update_peer_occu(n,e,o):n=xows_tpl_spawn_peer_occu(e);const c=xows_gui_doc(s,t);if((n.parentNode!=c||_.code.includes(303))&&xows_gui_muc_list_insert(c,n),xows_gui_muc_list_update(s),xows_gui_hist_update(s,e,o),e.self)for(let _=0;_<E_.length;++_)E_[_].room===s&&xows_gui_hist_update(E_[_],e,o)}function xows_gui_muc_list_onpull(e){if(e.self)e.room===Wt&&xows_gui_peer_switch_to(null);else{const o=xows_gui_muc_list_find(e.room,e.addr,e.ocid);if(o){const e=o.parentNode;e.removeChild(o),e.hidden=!e.childElementCount}else xows_log(1,"gui_muc_list_onpull","Occupant element not found",e.addr)}xows_cli_occu_rem(e)}function xows_gui_muc_room_menu_onclose(){}function xows_gui_muc_room_menu_onshow(e,o){const _=e.getBoundingClientRect();console.log(_),o.style.left=_.right-o.offsetWidth+"px",o.style.top=_.bottom+"px";const s=Wt.affi,t=Wt.role;xows_doc_show("room_mi_regi",s===Bo),xows_doc_show("room_mi_unrg",s===Po),xows_doc_show("room_mi_subj",t>jo&&s>Po),xows_doc_show("room_mi_mucc",s===Oo),xows_doc_show("room_mi_muca",s>Po)}function xows_gui_muc_room_menu_onclick(e){xows_doc_menu_close();const o=e.target.closest("LI");if(o)switch(o.id){case"room_mi_info":return void xows_gui_prof_open(Wt);case"room_mi_regi":return void xows_gui_muc_regi_ibox_open(Wt);case"room_mi_unrg":return void xows_gui_muc_unrg_mbox_open(Wt);case"room_mi_mucc":return void xows_cli_muc_cfg_get(Wt,xows_gui_page_mucc_open);case"room_mi_muca":return void xows_gui_page_muca_open(Wt);case"room_mi_subj":return void xows_gui_muc_subj_ibox_open(Wt);case"room_mi_nick":return void xows_gui_muc_nick_ibox_open(Wt);case"room_mi_exit":return void xows_cli_muc_leave(Wt)}}function xows_gui_muc_occu_menu_onclose(){xows_doc("mucl_list").querySelector(".SELECTED").classList.remove("SELECTED")}function xows_gui_muc_occu_menu_onshow(e,o){const _=e.getBoundingClientRect();o.style.left=_.left-o.offsetWidth+"px";const s=_.top+.5*_.height;let t=s+o.offsetHeight-window.screen.height;t<0&&(t=0),o.style.top=s-t+"px";const n=xows_cli_occu_get(Wt,xows_xml_unesc(e.closest("LI-PEER").dataset.id)),c=Wt.affi===Oo,i=!n.self&&Wt.affi>Po,r=!n.self&&(i||Wt.role>jo),l=c||n.affi<Ro&&Wt.affi>=n.affi,a=xows_doc("occu_mi_priv"),u=xows_doc("occu_sm_affi"),d=xows_doc("occu_sm_role"),x=xows_doc("occu_mi_kick"),w=xows_doc("occu_mi_outc");if(xows_doc_cls_rem("occu_mi_info","menu-separ"),xows_doc_cls_rem("occu_mi_priv","menu-separ"),a.hidden=n.self,!i&&!r||!l)return u.hidden=!0,d.hidden=!0,x.hidden=!0,void(w.hidden=!0);if(xows_doc_cls_add(n.self?"occu_mi_info":"occu_mi_priv","menu-separ"),u.hidden=!i,d.hidden=!r,x.hidden=!r,w.hidden=!i,i){const e=xows_doc("occu_mi_ownr"),o=xows_doc("occu_mi_admn"),_=xows_doc("occu_mi_memb"),s=xows_doc("occu_mi_none");e.querySelector("MENU-RADIO").dataset.on=n.affi===Oo,o.querySelector("MENU-RADIO").dataset.on=n.affi===Ro,_.querySelector("MENU-RADIO").dataset.on=n.affi===Po,s.querySelector("MENU-RADIO").dataset.on=n.affi===Bo,e.classList.toggle("MENU-GRAYD",!c),o.classList.toggle("MENU-GRAYD",!c)}if(r){const e=xows_doc("occu_mi_modo"),o=xows_doc("occu_mi_part"),_=xows_doc("occu_mi_vist");e.querySelector("MENU-RADIO").dataset.on=n.role===Io,o.querySelector("MENU-RADIO").dataset.on=n.role===jo,_.querySelector("MENU-RADIO").dataset.on=n.role===Do;const s=Wt.role>n.role||Wt.affi>n.affi;e.classList.toggle("MENU-GRAYD",!i),o.classList.toggle("MENU-GRAYD",!s),_.classList.toggle("MENU-GRAYD",!s)}}function xows_gui_muc_occu_menu_onclick(e){xows_cli_pres_show_back();const o=xows_doc("mucl_list").querySelector(".SELECTED");xows_doc_menu_close();const _=e.target.closest("LI");if(!_)return;const s=xows_cli_occu_get(Wt,xows_xml_unesc(o.dataset.id));let t=null,n=null;switch(_.id){case"occu_mi_info":return void xows_gui_prof_open(s);case"occu_mi_priv":return void xows_gui_rost_occu_init(s);case"occu_mi_ownr":t=Oo;break;case"occu_mi_admn":t=Ro;break;case"occu_mi_memb":t=Po;break;case"occu_mi_none":t=Bo;break;case"occu_mi_modo":n=Io;break;case"occu_mi_part":n=jo;break;case"occu_mi_vist":n=Do;break;case"occu_mi_kick":n=To;break;case"occu_mi_outc":t=Lo}null!=t&&t!=s.affi&&(t>Po&&t>s.affi||t===Lo?xows_gui_muc_affi_mbox_open(s,t):xows_cli_muc_affi_set(s,t)),null!=n&&n!=s.role&&(n===To?xows_gui_muc_role_mbox_open(s,n):xows_cli_muc_role_set(s,n))}const En={room:null};function xows_gui_muc_bkrm_mbox_onabort(){}function xows_gui_muc_bkrm_mbox_onvalid(){xows_cli_pep_book_retr(En.room)}function xows_gui_muc_bkrm_mbox_open(e){En.room=e;xows_doc_mbox_open(Ft,"Delete Channel bookmark","Do you really want to delete Channel bookmark ?",xows_gui_muc_bkrm_mbox_onvalid,"OK",xows_gui_muc_bkrm_mbox_onabort,"Cancel")}const qn={room:null};function xows_gui_muc_bkad_mbox_onabort(){qn.room=null}function xows_gui_muc_bkad_mbox_onvalid(){const e=qn;xows_cli_pep_book_publ(e.room),e.room=null}function xows_gui_muc_bkad_mbox_open(e){qn.room=e,xows_doc_mbox_open(At,"Add Bookmark","Add Channel to bookmarks ?",xows_gui_muc_bkad_mbox_onvalid,"OK",xows_gui_muc_bkad_mbox_onabort,"Cancel")}const Sn={room:null,xform:null,cancel:!0};function xows_gui_page_mucc_onresult(e,o,_){"result"===o&&(Sn.cancel=!1,xows_doc_page_close())}function xows_gui_page_mucc_onvalid(){const e=Sn.room,o=Sn.xform;xows_doc("mucc_pass");xows_doc("mucc_pass").value||(xows_doc("mucc_prot").checked=!1);for(let e=0;e<o.length;++e){o[e].value||(o[e].value=[]);const _=o[e].value;switch(o[e].var){case"muc#roomconfig_roomname":_[0]=xows_doc("mucc_titl").value;break;case"muc#roomconfig_roomdesc":_[0]=xows_doc("mucc_desc").value;break;case"muc#roomconfig_persistentroom":_[0]=xows_doc("mucc_pers").checked?"1":"0";break;case"muc#roomconfig_publicroom":_[0]=xows_doc("mucc_publ").checked?"1":"0";break;case"muc#roomconfig_passwordprotectedroom":_[0]=xows_doc("mucc_prot").checked?"1":"0";break;case"muc#roomconfig_roomsecret":_[0]=xows_doc("mucc_prot").checked?xows_doc("mucc_pass").value:"";break;case"muc#roomconfig_membersonly":_[0]=xows_doc("mucc_mbon").checked?"1":"0";break;case"muc#roomconfig_moderatedroom":_[0]=xows_doc("mucc_modo").checked?"1":"0";break;case"muc#roomconfig_whois":_[0]=xows_doc("mucc_anon").value;break;case"muc#roomconfig_presencebroadcast":_.length=0,xows_doc("mucc_lsvi").checked&&_.push("visitor"),xows_doc("mucc_lspa").checked&&_.push("participant"),xows_doc("mucc_lsmo").checked&&_.push("moderator");break;case"muc#roomconfig_historylength":_[0]=xows_doc("mucc_hmax").value;break;case"muc#roomconfig_defaulthistorymessages":_[0]=xows_doc("mucc_hdef").value;break;case"muc#roomconfig_enablearchiving":case"mam":_[0]=xows_doc("mucc_arch").checked?"1":"0";break;case"muc#roomconfig_maxusers":_[0]=xows_doc("mucc_maxo").value;break;case"muc#roomconfig_allowpm":_[0]=xows_doc("mucc_alpm").value}}xows_cli_muc_cfg_set(e,o,xows_gui_page_mucc_onresult)}function xows_gui_page_mucc_onabort(){const e=Sn.xform;for(let o=0;o<e.length;++o){const _=e[o].value;switch(e[o].var){case"muc#roomconfig_roomname":xows_doc("mucc_titl").value=_?_[0]:"";break;case"muc#roomconfig_roomdesc":xows_doc("mucc_desc").value=_?_[0]:"";break;case"muc#roomconfig_lang":break;case"muc#roomconfig_persistentroom":xows_doc("mucc_pers").checked=!!_&&xows_asbool(_[0]);break;case"muc#roomconfig_publicroom":xows_doc("mucc_publ").checked=!!_&&xows_asbool(_[0]);break;case"muc#roomconfig_passwordprotectedroom":break;case"muc#roomconfig_roomsecret":{const e=!!_&&xows_asbool(_[0]);xows_doc("mucc_prot").checked=e,xows_doc("mucc_pass").disabled=!e,xows_doc("mucc_pass").value=_?_[0]:""}break;case"muc#roomconfig_membersonly":xows_doc("mucc_mbon").checked=!!_&&xows_asbool(_[0]);break;case"muc#roomconfig_moderatedroom":xows_doc("mucc_modo").checked=!!_&&xows_asbool(_[0]);break;case"muc#roomconfig_whois":xows_doc("mucc_anon").value=_[0];break;case"muc#roomconfig_presencebroadcast":xows_doc("mucc_lsvi").checked=_.includes("visitor"),xows_doc("mucc_lspa").checked=_.includes("participant"),xows_doc("mucc_lsmo").checked=_.includes("moderator");break;case"muc#roomconfig_historylength":xows_doc("mucc_hmax").value=_[0];break;case"muc#roomconfig_defaulthistorymessages":xows_doc("mucc_hdef").value=_[0];break;case"muc#roomconfig_enablearchiving":case"mam":xows_doc("mucc_arch").checked=xows_asbool(_[0]);break;case"muc#roomconfig_maxusers":xows_doc("mucc_maxo").value=_[0];break;case"muc#roomconfig_allowpm":xows_doc("mucc_alpm").value=_[0]}}}function xows_gui_page_mucc_oninput(e){let o=!1;const _=Sn.xform,s=xows_doc("mucc_pass");xows_doc("mucc_prot").checked?s.disabled=!1:(s.disabled=!0,s.value="");for(let e=0;e<_.length;++e){const s=_[e].value;switch(_[e].var){case"muc#roomconfig_roomname":s?s[0]!==xows_doc("mucc_titl").value&&(o=!0):xows_doc("mucc_titl").value&&(o=!0);break;case"muc#roomconfig_roomdesc":s?s[0]!==xows_doc("mucc_desc").value&&(o=!0):xows_doc("mucc_desc").value&&(o=!0);break;case"muc#roomconfig_persistentroom":s?xows_asbool(s[0])!==xows_doc("mucc_pers").checked&&(o=!0):xows_doc("mucc_pers").checked&&(o=!0);break;case"muc#roomconfig_publicroom":s?xows_asbool(s[0])!==xows_doc("mucc_publ").checked&&(o=!0):xows_doc("mucc_publ").checked&&(o=!0);break;case"muc#roomconfig_passwordprotectedroom":s?xows_asbool(s[0])!==xows_doc("mucc_prot").checked&&(o=!0):xows_doc("mucc_prot").checked&&(o=!0);break;case"muc#roomconfig_roomsecret":s?s[0]!==xows_doc("mucc_pass").value&&(o=!0):xows_doc("mucc_pass").value&&(o=!0);break;case"muc#roomconfig_membersonly":s?xows_asbool(s[0])!==xows_doc("mucc_mbon").checked&&(o=!0):xows_doc("mucc_mbon").checked&&(o=!0);break;case"muc#roomconfig_moderatedroom":s?xows_asbool(s[0])!==xows_doc("mucc_modo").checked&&(o=!0):xows_doc("mucc_modo").checked&&(o=!0);break;case"muc#roomconfig_whois":s[0]!==xows_doc("mucc_anon").value&&(o=!0);break;case"muc#roomconfig_presencebroadcast":s.includes("visitor")!==xows_doc("mucc_lsvi").checked&&(o=!0),s.includes("participant")!==xows_doc("mucc_lspa").checked&&(o=!0),s.includes("moderator")!==xows_doc("mucc_lsmo").checked&&(o=!0);break;case"muc#roomconfig_historylength":s?s[0]!==xows_doc("mucc_hmax").value&&(o=!0):xows_doc("mucc_hmax").value&&(o=!0);break;case"muc#roomconfig_defaulthistorymessages":s?s[0]!==xows_doc("mucc_hdef").value&&(o=!0):xows_doc("mucc_hdef").value&&(o=!0);break;case"muc#roomconfig_enablearchiving":case"mam":s?xows_asbool(s[0])!==xows_doc("mucc_arch").checked&&(o=!0):xows_doc("mucc_arch").checked&&(o=!0);break;case"muc#roomconfig_maxusers":s&&s[0]!==xows_doc("mucc_maxo").value&&(o=!0);break;case"muc#roomconfig_allowpm":s&&s[0]!==xows_doc("mucc_alpm").value&&(o=!0)}if(o)break}o?xows_doc_popu_open_for_save(xows_gui_page_mucc_onvalid,xows_gui_page_mucc_onabort):xows_doc_popu_close()}function xows_gui_page_mucc_onclose(){const e=Sn;e.room.init?xows_cli_muc_cfg_set(e.room,null,null):e.cancel&&xows_cli_muc_cfg_set_cancel(e.room,null),e.xform=null,e.room=null}function xows_gui_page_mucc_open(e,o){xows_doc("mucc_room").innerText="# "+e.name+" ("+e.addr+")";const _=Sn;_.room=e,_.xform=o,_.cancel=!0;const s=xows_doc("page_mucc").querySelectorAll("FIELDSET");for(let e=0;e<s.length;++e)s[e].hidden=!0;for(let e=0;e<o.length;++e){const _=o[e].var;if(!_)continue;const s=xows_doc(_);if(s&&(s.hidden=!1),"muc#roomconfig_maxusers"===_){const _=o[e].option,s=xows_doc("mucc_maxo");s.innerHtml="";for(let e=0;e<_.length;++e){const o=document.createElement("option");o.setAttribute("value",_[e].value),o.innerText=_[e].label,s.appendChild(o)}}"mam"===_&&(xows_doc("muc#roomconfig_enablearchiving").hidden=!1)}xows_gui_page_mucc_onabort(),xows_doc_page_open("page_mucc",!0,xows_gui_page_mucc_onclose,xows_gui_page_mucc_oninput,xows_gui_page_mucc_oninput)}const Cn={room:null,stage:0,items:null},Tn=["outcast","owner","admin","member"];function xows_gui_page_muca_getitem(e){const o=Cn.items;for(let _=0;_<o.length;++_)if(o[_].jid==e.dataset.bare)return o[_];return null}function xows_gui_page_muca_onload(e,o){const _=Cn,s=_.room,t=xows_doc("muca_outc"),n=xows_doc("muca_affi");if(0==_.stage&&(t.innerHTML="",n.innerHTML="",t.classList.add("LOADING"),n.classList.add("LOADING"),_.items=[]),o&&o.length){_.items=_.items.concat(o);for(let e=0;e<o.length;++e){if(xows_cli_isself_addr(o[e].jid))continue;const _=xows_tpl_admn_memb_spawn(o[e],s.affi);-1==o[e].affi?t.appendChild(_):n.appendChild(_)}}if(1==_.stage&&s.affi<Oo&&(_.stage=3),_.stage<4)return void xows_xmp_muc_affi_get_query(s.addr,Tn[_.stage++],xows_gui_page_muca_onload);t.classList.remove("LOADING"),n.classList.remove("LOADING");const c="<li>"+xows_l10n_get("List is empty")+"</li>";let i,r,l;""==t.innerHTML&&(t.innerHTML=c),""==n.innerHTML&&(n.innerHTML=c),(i=t.offsetHeight)>(l=4*(r=i/t.children.length))&&(i=l),xows_doc("muca_banv").style.height=i+"px",(i=n.offsetHeight)>(l=4*(r=i/n.children.length))&&(i=l),xows_doc("muca_mbrv").style.height=i+"px"}function xows_gui_page_muca_onclose(){const e=Cn;e.room=null,e.stage=0,e.items=null}function xows_gui_page_muca_onvalid(){xows_doc_cls_add("muca_outc","LOADING"),xows_doc_cls_add("muca_affi","LOADING");const e=Cn;let o=xows_doc("page_muca").querySelectorAll(".MODIFIED");for(let _=0;_<o.length;++_){const s=xows_gui_page_muca_getitem(o[_]);s.affi=parseInt(o[_].dataset.affi),xows_xmp_muc_affi_set_query(e.room.addr,s,null)}e.stage=0,xows_gui_page_muca_onload(null,null)}function xows_gui_page_muca_onabort(){let e=xows_doc("page_muca").querySelectorAll(".MODIFIED");for(let o=0;o<e.length;++o){const _=xows_gui_page_muca_getitem(e[o]);xows_tpl_admn_memb_update(e[o],_.affi,_.affi)}}function xows_gui_page_muca_oninput(e){if("muca_bt_dstr"!==e.id){if("MEMB-RADIO"===e.tagName){const o=e.closest("LI-MEMB"),_=xows_gui_page_muca_getitem(o);xows_tpl_admn_memb_update(o,parseInt(e.dataset.affi),_.affi)}xows_doc("page_muca").querySelectorAll(".MODIFIED").length>0?xows_doc_popu_open_for_save(xows_gui_page_muca_onvalid,xows_gui_page_muca_onabort):xows_doc_popu_close()}else xows_gui_muc_dstr_ibox_open(Cn.room,null,null)}function xows_gui_page_muca_open(e){xows_doc("muca_room").innerText="# "+e.name+" ("+e.addr+")";const o=Cn;o.room=e,xows_doc_show("muca_dstr",e.affi===Oo),o.stage=0,xows_gui_page_muca_onload(null,null),xows_doc_page_open("page_muca",!0,xows_gui_page_muca_onclose,xows_gui_page_muca_oninput,xows_gui_page_muca_oninput)}const Dn={room:null,alt:null,pass:null};function xows_gui_muc_dstr_ibox_oninput(e){}function xows_gui_muc_dstr_ibox_onabort(){}function xows_gui_muc_dstr_ibox_onvalid(e){const o=Dn;return xows_doc_page_close(),xows_cli_muc_destroy_query(o.room,o.alt,o.pass,e),!0}function xows_gui_muc_dstr_ibox_open(e,o,_){const s=Dn;s.room=e,s.alt=o,s.pass=_,xows_doc_ibox_open("Channel destruction","You can specify a reason for Channel destruction.","Enter reason...",null,xows_gui_muc_dstr_ibox_onvalid,"Destroy Channel",xows_gui_muc_dstr_ibox_onabort,"Cancel",xows_gui_muc_dstr_ibox_oninput,!0)}function xows_gui_snd_onvmtr(e,o){const _=e>.01?"var(--link-base)":"var(--text-tone4)";o.style.borderColor!==_&&(o.style.borderColor=_)}function xows_gui_call_view_onclick(e){if(xows_cli_pres_show_back(),"BUTTON"!==e.target.tagName)return;let o;switch(e.target.id){case"call_spkr":{const _=xows_doc("call_volu"),s=(o=e.target.classList.toggle("MUTTED"))?0:parseInt(_.value)/100;xows_snd_outpt_gain_set(Wt,s),_.disabled=o,xows_snd_sample_play(o?"mute":"unmute")}break;case"call_came":o=e.target.classList.toggle("MUTTED"),xows_cli_call_self_mute(Wt,"video",o),xows_snd_sample_play(o?"disable":"enable");break;case"call_micr":o=e.target.classList.toggle("MUTTED"),xows_cli_call_self_mute(Wt,"audio",o),xows_snd_sample_play(o?"disable":"enable");break;case"call_hgup":xows_gui_call_self_hangup(Wt,"success");break;case"call_expd":{const e=xows_doc_cls_tog("chat_fram","CALL-FULL")?"Reduce":"Expand";xows_doc("call_expd").title=xows_l10n_get(e)}}}function xows_gui_call_view_oninput(e){const o=parseInt(e.target.value)/100;xows_snd_outpt_gain_set(Wt,o);let _="";o>.66?_="RNG-MAX":o<.33&&(_="RNG-MIN"),xows_doc("call_spkr").className=_}function xows_gui_call_view_open(e){const o=xows_gui_doc(e,"call_view"),_=xows_cli_call_medias(e).video;o.classList.toggle("CALL-VIDEO",_),xows_gui_doc(e,"call_expd").title=xows_l10n_get("Expand");const s=xows_gui_doc(e,"call_spkr"),t=xows_gui_doc(e,"call_volu");s.className="",t.disabled=!1,t.value=50;const n=xows_gui_doc(e,"call_came");if(xows_gui_doc(e,"call_micr").className="",n.className="",n.hidden=!xows_cli_call_medias(e).video,o.hidden){if(e===Wt&&(xows_doc_listener_add(xows_doc("call_menu"),"click",xows_gui_call_view_onclick),xows_doc_listener_add(xows_doc("call_volu"),"input",xows_gui_call_view_oninput)),_){const _=o.querySelector("[data-input]"),s=o.querySelector("[data-outpt]");"AUDIO"===_.tagName&&xows_snd_input_vumtr(e,!0,_.parentNode),"AUDIO"===s.tagName&&xows_snd_outpt_vumtr(e,!0,s.parentNode)}o.hidden=!1}}function xows_gui_call_view_close(e){const o=xows_gui_doc(e,"call_view");e===Wt&&(xows_doc_listener_rem(xows_doc("call_menu"),"click",xows_gui_call_view_onclick),xows_doc_listener_rem(xows_doc("call_volu"),"input",xows_gui_call_view_oninput)),xows_snd_input_vumtr(e,!1),xows_snd_outpt_vumtr(e,!1),o.hidden=!0,xows_gui_doc(e,"call_grid").innerHTML="",xows_doc("chat_fram").classList.remove("CALL-FULL")}function xows_gui_call_view_part_add(e,o,_){const s=xows_gui_doc(e,"call_grid"),t=_.getVideoTracks().length;let n,c=s.querySelector("[data-part='"+o.addr+"']");c?c.srcObject=_:((c=t?(n=xows_tpl_spawn_stream_video(o)).querySelector("video"):(n=xows_tpl_spawn_stream_audio(o)).querySelector("audio")).muted=!0,o.self?t&&(n.hidden=!0):(xows_snd_outpt_new(e,_),xows_snd_outpt_gain_set(e,parseInt(xows_gui_doc(e,"call_volu").value)/100),c.srcObject=_,c.autoplay=!0),o.self?s.insertBefore(n,s.firstElementChild):s.appendChild(n))}const jn=0,In=1,Nn=2;function xows_gui_hist_ring_onclick(e){switch(e.target.id){case"ring_bt_clos":break;case"ring_bt_deny":xows_gui_call_self_cancel(Wt);break;case"ring_bt_pkup":return void xows_gui_call_self_accept(Wt);default:return}xows_gui_hist_ring_close(Wt)}function xows_gui_hist_ring_show(e,o,_){const s=xows_gui_doc(e,"hist_ring");let t,n,c,i=!1,r=!1;switch(o!==jn&&(r=xows_cli_call_is_inbd(e),i=xows_cli_call_medias(e).video),o){case Nn:r?(c=!0,t=i?"Incoming video call...":"Incoming audio call..."):(n=!0,t="Call in progress...");break;case In:t="Network negotiation...";break;case jn:switch(_){case"decline":t="The call has been declined";break;case"buzy":t="The other party is buzy";break;case"success":t=xows_cli_call_misd(e)?"You missed a call":"The other party hung up";break;case"incompatible-parameters":t=xows_cli_call_is_inbd(e)?"Input devices access failed":"The other party lacks suitable devices";break;case"failed-transport":case"failed-application":case"unsupported-applications":case"unsupported-transports":t="The other party encountered error";break;default:t=xows_l10n_get("Call failure")+": "+xows_xml_beatify_tag(_)}}s.classList.toggle("RING-VDEO",i),s.classList.toggle("RING-RING",o===Nn),s.classList.toggle("RING-NEGO",o===In),s.classList.toggle("RING-TERM",o===jn),s.classList.toggle("RING-INBD",r),s.querySelector("RING-TEXT").innerText=xows_l10n_get(t),c?xows_snd_sample_loop("ringbell"):xows_snd_sample_stop("ringbell"),n?xows_snd_sample_loop("ringtone"):xows_snd_sample_stop("ringtone"),s.hidden&&(e===Wt&&xows_doc_listener_add(s,"click",xows_gui_hist_ring_onclick),s.hidden=!1,xows_gui_hist_scrl_down(e,!1),xows_gui_edit_alrt_set(e,"RINGING"))}function xows_gui_hist_ring_close(e){xows_snd_sample_stop("ringtone"),xows_snd_sample_stop("ringbell");const o=xows_gui_doc(e,"hist_ring");e===Wt&&xows_doc_listener_rem(o,"click",xows_gui_hist_ring_onclick),o.hidden=!0,xows_gui_edit_alrt_reset(e,"RINGING")}function xows_gui_call_exit(e){xows_gui_badg_buzy(e,!1),xows_snd_input_delete(e,!0),xows_snd_outpt_delete(e,!0),xows_gui_call_view_close(e),xows_gui_doc_update(e,on)}function xows_gui_call_self_invite(e,o){xows_gui_wnd_media_try(o,xows_gui_call_self_invite_onmedia,xows_gui_call_self_cancel,e)}function xows_gui_call_self_invite_onmedia(e,o){xows_cli_call_self_invite(e,xows_snd_input_new(e,o),o),xows_gui_doc_update(e,on),xows_gui_hist_ring_show(e,In,null),xows_gui_call_view_part_add(e,F_,o)}function xows_gui_call_self_accept(e,o){o||((o=xows_cli_call_medias(e)).audio=o.audio&&xows_gui_devs_has("audioinput"),o.video=o.video&&xows_gui_devs_has("videoinput")),xows_gui_wnd_media_try(o,xows_gui_call_self_accept_onmedia,xows_gui_call_self_cancel,e)}function xows_gui_call_self_accept_onmedia(e,o){xows_cli_call_self_accept(e,xows_snd_input_new(e,o),o),xows_gui_doc_update(e,on),xows_gui_hist_ring_show(e,In,null);const _=xows_cli_call_medias(e);_.audio=_.audio&&xows_gui_devs_has("audioinput"),_.video=_.video&&xows_gui_devs_has("videoinput"),xows_gui_call_view_part_add(e,F_,o)}function xows_gui_call_self_cancel(e,o){let _;o?(xows_doc_mbox_open(vt,"Input devices access failed","Access to input devices is required for call session, configure your browser to allow it and try again.",null,null,null,null),_="incompatible-parameters"):_=xows_cli_call_is_inbd(e)?"decline":"success",xows_cli_call_exists(e)&&(xows_gui_hist_ring_show(e,jn,_),xows_gui_call_self_hangup(e,_))}function xows_gui_call_self_hangup(e,o){xows_cli_call_self_hangup(e,o),xows_gui_call_exit(e),xows_snd_sample_play("hangup")}function xows_gui_call_onoffer(e,o){xows_gui_call_view_part_add(e,e,o),e!==Wt&&xows_gui_badg_unrd_call(e,!0),xows_gui_hist_ring_show(e,Nn,null)}function xows_gui_call_onanwse(e,o){xows_gui_call_view_part_add(e,e,o)}function xows_gui_call_onstate(e,o){"ringing"===o&&xows_gui_hist_ring_show(e,Nn,null),"gathering"===o&&xows_gui_hist_ring_show(e,In,null),"connected"===o&&(xows_gui_hist_ring_close(e),xows_gui_badg_buzy(e,!0),xows_gui_call_view_open(e))}function xows_gui_call_ontermd(e,o){xows_gui_hist_ring_show(e,jn,o),xows_gui_call_exit(e),xows_snd_sample_play("hangup")}function xows_gui_call_onerror(e,o,_){let s;if(o)s=_.errorCode?"Network Error ("+_.errorCode+")":"Internal Error ("+_.name+")";else{if("unsupported-info"===_.jing)return void xows_log(1,"cli_jing_parse","received unsuported info from",e.addr);s="Remote Peer Error ("+_.name+")"}xows_gui_call_exit(e),xows_gui_hist_ring_show(e,jn,s)}let Mn={lib_path:"/xows",lib_verbose:1,tpl_load_mincss:!1,tpl_force_uncache:!1,xmpp_url:"ws://localhost/xmpp-websocket/",login_force_domain:"",login_sasl_store:!1,login_fail_delay:2,resume_timeout:3,resume_try_delay:10,gui_locale:"en-US",gui_theme:"dark",gui_allow_register:!1,gui_archive_delay:500,cli_archive_count:50,cli_avat_autopub:!0,cli_pepnotify_bkms:!0,cli_pepnotify_nick:!0,cli_pepnotify_avat:!0,cli_extern_services:[]};function xows_init(e){if(e&&(e.hasOwnProperty("lib_path")&&(Mn.lib_path=e.lib_path),e.hasOwnProperty("lib_verbose")&&(Mn.lib_verbose=e.lib_verbose),e.hasOwnProperty("tpl_force_uncache")&&(Mn.tpl_force_uncache=e.tpl_force_uncache),e.hasOwnProperty("tpl_load_mincss")&&(Mn.tpl_load_mincss=e.tpl_load_mincss),e.hasOwnProperty("xmpp_url")&&(Mn.xmpp_url=e.xmpp_url),e.hasOwnProperty("login_force_domain")&&(Mn.login_force_domain=e.login_force_domain),e.hasOwnProperty("login_sasl_store")&&(Mn.login_sasl_store=e.login_sasl_store),e.hasOwnProperty("login_fail_delay")&&(Mn.login_fail_delay=e.login_fail_delay),e.hasOwnProperty("resume_timeout")&&(Mn.resume_timeout=e.resume_timeout),e.hasOwnProperty("resume_try_delay")&&(Mn.resume_try_delay=e.resume_try_delay),e.hasOwnProperty("gui_locale")&&(Mn.gui_locale=e.gui_locale),e.hasOwnProperty("gui_theme")&&(Mn.gui_theme=e.gui_theme),e.hasOwnProperty("gui_allow_register")&&(Mn.gui_allow_register=e.gui_allow_register),e.hasOwnProperty("gui_archive_delay")&&(Mn.gui_archive_delay=e.gui_archive_delay),e.hasOwnProperty("cli_archive_count")&&(Mn.cli_archive_count=e.cli_archive_count),e.hasOwnProperty("cli_pepnotify_bkms")&&(Mn.cli_pepnotify_bkms=e.cli_pepnotify_bkms),e.hasOwnProperty("cli_pepnotify_nick")&&(Mn.cli_pepnotify_nick=e.cli_pepnotify_nick),e.hasOwnProperty("cli_avat_autopub")&&(Mn.cli_avat_autopub=e.cli_avat_autopub),e.hasOwnProperty("cli_pepnotify_avat")&&(Mn.cli_pepnotify_avat=e.cli_pepnotify_avat),e.hasOwnProperty("cli_extern_services")&&(Mn.cli_extern_services=e.cli_extern_services)),Mn.lib_path){let e=Mn.lib_path;1===e.length&&"/"===e.charAt(0)?Mn.lib_path="":("/"!==e.charAt(e.length-1)&&(e+="/"),Mn.lib_path=e)}xows_log(2,"init","Starts Library Initialization"),xows_l10n_select(Mn.gui_locale,xows_init_module_tpl)}function xows_init_module_tpl(){xows_tpl_init(xows_init_module_doc)}function xows_init_module_doc(){xows_doc_init(xows_init_finalize)}function xows_init_finalize(){xows_cli_init(),xows_gui_init()}function xows_init_failure(e,o){let _="<h1>XOWS init failed</h1><h4>Asset file loading error ( HTTP error "+e+" )</h4>";_+="<big><code>"+o.match(/(.+?)(?:\?.*|$)/)[1]+"</code></big>",_+="<h5>Did you set the proper library/assets root path ?</h5>",document.body.style="padding:20px;text-align:center;background:#1A1A1F;color:#FC8484",document.body.innerHTML=_}