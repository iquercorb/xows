"use strict";const e="Xows",o="0.9.2",t="https://github.com/sedenion/xows",_=-1,s=-2,n=0,i=1,r=new Path2D("m7.39 0.00182c-0.949 0.0386-1.99 0.696-2.81 1.54l2.42 3.79c-2.24 1.41-3.3 3.4-3.98 5.57-2.24 0.214-0.682-4.16-0.836-5.17 0 0-3.6 5.7-1.55 7.3 1.46 1.15 3.94 1.59 3.94 1.59l-3.15 3.99c2.14 0.72 6.9 0.794 6.9 0.794l2.73-4.25h1.91l2.73 4.25s4.76-0.0743 6.9-0.794l-3.15-3.99s2.47-0.444 3.94-1.59c2.04-1.6-1.65-7.3-1.65-7.3-0.152 1.01 1.5 5.38-0.739 5.17-0.675-2.17-1.74-4.16-3.98-5.57l2.42-3.79c-0.827-0.845-1.86-1.5-2.81-1.54-0.135-0.00482-0.27 0.00193-0.401 0.0232l-3.64 4.52h-1.14l-3.64-4.52a2.01 2.01 0 0 0-0.401-0.0232zm1.42 8.17c1.69 0 1.44 2.58 1.44 2.58s-0.968 0.027-1.88 0.027-1.54-0.0482-1.54-0.726c0-0.678 0.285-1.88 1.97-1.88zm6.39 0c1.69 0 1.97 1.2 1.97 1.88 0 0.678-0.63 0.726-1.54 0.726a77.5 77.5 0 0 1-1.88-0.027s-0.241-2.58 1.44-2.58z");function xows_hasbits(e,o){return(e&o)===o}function xows_asbool(e){if(e.length){const o=parseInt(e);return NaN!==o?Boolean(o):"TRUE"===e.toUpperCase()}return Boolean(e)}function xows_isfunc(e){return e&&e.constructor&&e.call&&e.apply}function xows_def_readonly(e,o,t){Object.defineProperty(e,o,{value:t,writable:!1})}function xows_random(e){let o=e+=1831565813;return o=Math.imul(o^o>>>15,1|o),(((o^=o+Math.imul(o^o>>>7,61|o))^o>>>14)>>>0)/4294967296}function xows_log(e,o,t,_,s){if(e>ns.verbose)return;let n,i="";e>1&&s&&(i+="%c",n="color:"+s),i+=t,_&&(i+=": "+_);const r=o+": "+i;switch(e){case 0:case 1:console.warn(r);break;default:n?console.log(r,n):console.log(r)}}const c="0123456789abcdef",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function xows_str_to_utf8(e){let o,t,_="";for(let s=0,n=e.length;s<n;++s)(o=e.charCodeAt(s))<128?_+=e.charAt(s):o<2048?_+=String.fromCharCode(192|o>>6,128|63&o):o<55296||o>=57344?_+=String.fromCharCode(224|o>>12,128|o>>6&63,128|63&o):(++s,o=65536+((1023&o)<<10|1023&(t=e.charCodeAt(s))),_+=String.fromCharCode(240|o>>18,128|o>>12&63,128|o>>6&63,128|63&o));return _}function xows_str_bytes_len(e){let o,t=0;for(let _=0,s=e.length;_<s;++_)(o=e.charCodeAt(_))<128?t++:o<2048?t+=2:o<55296||o>=57344?t+=3:(++_,t+=4);return t}function xows_str_to_bytes(e,o){let t,_;const s=new Uint8Array(o||xows_str_bytes_len(e));for(let o=0,n=0,i=e.length;o<i;++o)(t=e.charCodeAt(o))<128?s[n++]=t:t<2048?(s[n++]=192|t>>6,s[n++]=128|63&t):t<55296||t>=57344?(s[n++]=224|t>>12,s[n++]=128|t>>6&63,s[n++]=128|63&t):(++o,t=65536+((1023&t)<<10|1023&(_=e.charCodeAt(o))),s[n++]=240|t>>18,s[n++]=128|t>>12&63,s[n++]=128|t>>6&63,s[n++]=128|63&t);return s}function xows_bytes_to_str(e){return String.fromCharCode.apply(null,e)}function xows_bytes_to_b64(e){const o=e.length,t=o%3;let _,s,n,i="";for(_=0,s=o-t;_<s;)n=e[_++]<<16|e[_++]<<8|e[_++],i+=a[63&n>>18],i+=a[63&n>>12],i+=a[63&n>>6],i+=a[63&n];return 0!==t&&(n=e[_++]<<16,t>1&&(n|=e[_]<<8),i+=a[63&n>>18],i+=a[63&n>>12],i+=t>1?a[63&n>>6]:"=",i+="="),i}function xows_bytes_to_hex(e){let o,t="";for(let _=0,s=e.length;_<s;++_)o=e[_],t+=c.charAt(o>>>4&15)+c.charAt(15&o);return t}function xows_gen_uuid(){return window.crypto.randomUUID()}function xows_gen_nonce_hex(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let t="";for(let _=0;_<e;++_)t+=c.charAt(o[_]>>>4&15)+c.charAt(15&o[_]);return t}function xows_gen_nonce_asc(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let t="";for(let _=0;_<e;++_)t+=a[o[_]%62];return t}function xows_gen_nonce_num(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let t="";for(let _=0;_<e;++_)t+=c[o[_]%10];return t}function xows_hash_md5(e){let o;function P1(e,t,_,s,n,i,r){return((o=e+((s^t&(_^s))+n+r))<<i|o>>>32-i)+t}function P2(e,t,_,s,n,i,r){return((o=e+((_^s&(t^_))+n+r))<<i|o>>>32-i)+t}function P3(e,t,_,s,n,i,r){return((o=e+((t^_^s)+n+r))<<i|o>>>32-i)+t}function P4(e,t,_,s,n,i,r){return((o=e+((_^(t|~s))+n+r))<<i|o>>>32-i)+t}let t,_,s,n=0;if("string"==typeof e)s=xows_str_to_bytes(e,64+((_=8*(t=xows_str_bytes_len(e)))+64>>9<<6));else for(_=8*(t=e.length),s=new Uint8Array(64+(_+64>>9<<6));n<t;++n)s[n]=e[n];s[t]|=128;let i=s.length-8;s[i]=255&_,s[i+1]=_>>8&255,s[i+2]=_>>16&255,s[i+3]=_>>24&255;const r=new Uint32Array(16),c=new Uint32Array(4);let a,l,u,d;for(c[0]=1732584193,c[1]=4023233417,c[2]=2562383102,c[3]=271733878,i=0;i<s.length;){for(n=0;n<16;++n)r[n]=s[i++]|s[i++]<<8|s[i++]<<16|s[i++]<<24;a=c[0],l=P4(l=P4(l=P4(l=P4(l=P3(l=P3(l=P3(l=P3(l=P2(l=P2(l=P2(l=P2(l=P1(l=P1(l=P1(l=P1(l=c[1],u=P1(u=c[2],d=P1(d=c[3],a=P1(a,l,u,d,r[0],7,3614090360),l,u,r[1],12,3905402710),a,l,r[2],17,606105819),d,a,r[3],22,3250441966),u=P1(u,d=P1(d,a=P1(a,l,u,d,r[4],7,4118548399),l,u,r[5],12,1200080426),a,l,r[6],17,2821735955),d,a,r[7],22,4249261313),u=P1(u,d=P1(d,a=P1(a,l,u,d,r[8],7,1770035416),l,u,r[9],12,2336552879),a,l,r[10],17,4294925233),d,a,r[11],22,2304563134),u=P1(u,d=P1(d,a=P1(a,l,u,d,r[12],7,1804603682),l,u,r[13],12,4254626195),a,l,r[14],17,2792965006),d,a,r[15],22,1236535329),u=P2(u,d=P2(d,a=P2(a,l,u,d,r[1],5,4129170786),l,u,r[6],9,3225465664),a,l,r[11],14,643717713),d,a,r[0],20,3921069994),u=P2(u,d=P2(d,a=P2(a,l,u,d,r[5],5,3593408605),l,u,r[10],9,38016083),a,l,r[15],14,3634488961),d,a,r[4],20,3889429448),u=P2(u,d=P2(d,a=P2(a,l,u,d,r[9],5,568446438),l,u,r[14],9,3275163606),a,l,r[3],14,4107603335),d,a,r[8],20,1163531501),u=P2(u,d=P2(d,a=P2(a,l,u,d,r[13],5,2850285829),l,u,r[2],9,4243563512),a,l,r[7],14,1735328473),d,a,r[12],20,2368359562),u=P3(u,d=P3(d,a=P3(a,l,u,d,r[5],4,4294588738),l,u,r[8],11,2272392833),a,l,r[11],16,1839030562),d,a,r[14],23,4259657740),u=P3(u,d=P3(d,a=P3(a,l,u,d,r[1],4,2763975236),l,u,r[4],11,1272893353),a,l,r[7],16,4139469664),d,a,r[10],23,3200236656),u=P3(u,d=P3(d,a=P3(a,l,u,d,r[13],4,681279174),l,u,r[0],11,3936430074),a,l,r[3],16,3572445317),d,a,r[6],23,76029189),u=P3(u,d=P3(d,a=P3(a,l,u,d,r[9],4,3654602809),l,u,r[12],11,3873151461),a,l,r[15],16,530742520),d,a,r[2],23,3299628645),u=P4(u,d=P4(d,a=P4(a,l,u,d,r[0],6,4096336452),l,u,r[7],10,1126891415),a,l,r[14],15,2878612391),d,a,r[5],21,4237533241),u=P4(u,d=P4(d,a=P4(a,l,u,d,r[12],6,1700485571),l,u,r[3],10,2399980690),a,l,r[10],15,4293915773),d,a,r[1],21,2240044497),u=P4(u,d=P4(d,a=P4(a,l,u,d,r[8],6,1873313359),l,u,r[15],10,4264355552),a,l,r[6],15,2734768916),d,a,r[13],21,1309151649),u=P4(u,d=P4(d,a=P4(a,l,u,d,r[4],6,4149444226),l,u,r[11],10,3174756917),a,l,r[2],15,718787259),d,a,r[9],21,3951481745),c[0]+=a,c[1]+=l,c[2]+=u,c[3]+=d}const x=new Uint8Array(16);for(n=0,i=0;n<4;++n)x[i++]=255&c[n],x[i++]=c[n]>>8&255,x[i++]=c[n]>>16&255,x[i++]=c[n]>>24&255;return x}function xows_hash_sha1(e){let o,t,_,s=0;if("string"==typeof e)_=xows_str_to_bytes(e,64+((t=8*(o=xows_str_bytes_len(e)))+64>>9<<6));else for(t=8*(o=e.length),_=new Uint8Array(64+(t+64>>9<<6));s<o;++s)_[s]=e[s];_[o]|=128;let n=_.length-4;_[n]=t>>24&255,_[n+1]=t>>16&255,_[n+2]=t>>8&255,_[n+3]=255&t;const i=new Uint32Array(16),r=new Uint32Array(5);let c,a,l,u,d,x,w,p;for(r[0]=1732584193,r[1]=4023233417,r[2]=2562383102,r[3]=271733878,r[4]=3285377520,n=0;n<_.length;){for(s=0;s<16;++s)i[s]=_[n++]<<24|_[n++]<<16|_[n++]<<8|_[n++];for(c=r[0],a=r[1],l=r[2],u=r[3],d=r[4],s=0;s<80;++s)s>15&&(p=i[s-3&15]^i[s-8&15]^i[s-14&15]^i[15&s],i[15&s]=p<<1|p>>>31),s<20?(x=1518500249,w=u^a&(l^u)):s<40?(x=1859775393,w=a^l^u):s<60?(x=2400959708,w=a&l|a&u|l&u):(x=3395469782,w=a^l^u),p=(c<<5|c>>>27)+w+(d+i[15&s]+x),d=u,u=l,l=a<<30|a>>>2,a=c,c=p;r[0]+=c,r[1]+=a,r[2]+=l,r[3]+=u,r[4]+=d}const m=new Uint8Array(20);for(s=0,n=0;s<5;++s)m[n++]=r[s]>>24&255,m[n++]=r[s]>>16&255,m[n++]=r[s]>>8&255,m[n++]=255&r[s];return m}function xows_hmac_sha1(e,o){"string"==typeof e&&(e=xows_str_to_bytes(e)),e.length>64&&(e=xows_hash_sha1(e));const t=new Uint8Array(64+o.length),_=new Uint8Array(84);let s,n,i;for(n=0,i=e.length;n<i;++n)t[n]=54^e[n],_[n]=92^e[n];for(;n<64;++n)t[n]=54,_[n]=92;for("string"==typeof o&&(o=xows_str_to_bytes(o)),s=0,i=o.length;s<i;++s)t[n++]=o[s];const r=xows_hash_sha1(t);for(s=0,n=64;s<20;++s)_[n++]=r[s];return xows_hash_sha1(_)}function xows_hash_sha256(e){const o=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);let t,_,s,n=0;if("string"==typeof e)s=xows_str_to_bytes(e,64+((_=8*(t=xows_str_bytes_len(e)))+64>>9<<6));else for(_=8*(t=e.length),s=new Uint8Array(64+(_+64>>9<<6));n<t;++n)s[n]=e[n];s[t]|=128;let i=s.length-4;s[i]=_>>24&255,s[i+1]=_>>16&255,s[i+2]=_>>8&255,s[i+3]=255&_;const r=new Uint32Array(64),c=new Uint32Array(8);let a,l,u,d,x,w,p,m,g,f;for(c[0]=1779033703,c[1]=3144134277,c[2]=1013904242,c[3]=2773480762,c[4]=1359893119,c[5]=2600822924,c[6]=528734635,c[7]=1541459225,i=0;i<s.length;){for(n=0;n<16;++n)r[n]=s[i++]<<24|s[i++]<<16|s[i++]<<8|s[i++];for(a=c[0],l=c[1],u=c[2],d=c[3],x=c[4],w=c[5],p=c[6],m=c[7],n=0;n<64;n++)n>15&&(g=((f=r[n-2])>>>17|f<<15)^(f>>>19|f<<13)^f>>>10,r[n]=g+r[n-7],g=((f=r[n-15])>>>7|f<<25)^(f>>>18|f<<14)^f>>>3,r[n]+=g+r[n-16]),d+=f=m+(g=(x>>>6|x<<26)^(x>>>11|x<<21)^(x>>>25|x<<7))+(p^x&(w^p))+o[n]+r[n],f+=(g=(a>>>2|a<<30)^(a>>>13|a<<19)^(a>>>22|a<<10))+(a&l|u&(a|l)),m=p,p=w,w=x,x=d,d=u,u=l,l=a,a=f;c[0]+=a,c[1]+=l,c[2]+=u,c[3]+=d,c[4]+=x,c[5]+=w,c[6]+=p,c[7]+=m}const h=new Uint8Array(32);for(n=0,i=0;n<8;++n)h[i++]=c[n]>>24&255,h[i++]=c[n]>>16&255,h[i++]=c[n]>>8&255,h[i++]=255&c[n];return h}const l=/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;function xows_isjid(e){return l.test(e)}function xows_jid_bare(e){const o=e.indexOf("/");return-1!==o?e.substring(0,o):e}function xows_jid_node(e){const o=e.indexOf("@");return-1!==o?e.substring(0,o):""}function xows_jid_host(e){const o=e.indexOf("@");if(-1!==o){const t=e.indexOf("/");return e.substring(o+1,-1!==t?t:null)}return""}function xows_jid_resc(e){const o=e.indexOf("/");return-1!==o?e.substring(o+1):""}function xows_url_to_data(e){return 0===e.indexOf("data:")?e.substring(e.indexOf(",")+1):null}function xows_url_to_bytes(e){return 0===e.indexOf("data:")?atob(e.substring(e.indexOf(",")+1)):null}function xows_url_to_type(e){return 0===e.indexOf("data:")?e.substring(5,e.indexOf(";")):null}const u=new Map([["&","&amp;"],["<","&lt;"],[">","&gt;"],["'","&apos;"],['"',"&quot;"],["\n","<br>"]]);function xows_html_esc_func(e){return u.get(e)}function xows_html_escape(e){return e.replace(/[\&<>'"\n]/g,xows_html_esc_func)}function xows_clean_dom(e){let o,t=e.childNodes.length;for(;t--;)8===(o=e.childNodes[t]).nodeType||3===o.nodeType&&!/\S/.test(o.nodeValue)?e.removeChild(o):1===o.nodeType&&xows_clean_dom(o);return e}function xows_gen_avatar(e,o,t,_){const s=document.createElement("canvas"),n=s.getContext("2d");if(o){let t;const _=o.naturalWidth,i=o.naturalHeight;if(_>e||i>e){let r,c,a;_>i?(c=.5*(_-(r=i)),a=0):(c=0,a=.5*(i-(r=_))),s.width=_,s.height=i,n.drawImage(o,0,0);const l=n.getImageData(c,a,r,r),u=new Int32Array(l.data.buffer);t=new ImageData(e,e);const d=new Int32Array(t.data.buffer),x=1/(e/r),w=Math.round(x),p=1/(w*w);let m,g,f,h,b,F,y,v,k,A;for(m=0;m<e;++m)for(g=0;g<e;++g){for(b=Math.round(g*x)*r+Math.round(m*x),F=0,y=0,v=0,k=0,h=0;h<w;++h)for(f=0;f<w;++f)k+=(A=u[b+(h*r+f)])>>24&255,v+=A>>16&255,y+=A>>8&255,F+=255&A;F=Math.round(F*p),y=Math.round(y*p),v=Math.round(v*p),k=Math.round(k*p),d[g*e+m]=k<<24|v<<16|y<<8|F}s.width=s.height=e,n.putImageData(t,0,0)}else s.width=s.height=e,n.drawImage(o,0,0,e,e)}else if(s.width=s.height=e,t){let o=0,_=t.length;for(;_--;)o+=t.charCodeAt(_);const s=360*xows_random(o);n.fillStyle="hsl("+s+",100%,40%)",n.rect(0,0,e,e),n.fill(),n.fillStyle="#FFF";const i=.7,c=.5*e;n.translate(c-24*i,c-21*i);const a=e/24*i;n.scale(a,a),n.fill(r)}return s.toDataURL("image/png")}function xows_sdp_parse(e){const o={},t=e.split("\r\n");for(let e=0;e<t.length;++e){const _=t[e];switch(_.charAt(0)){case"v":o.version=_.substring(2);break;case"o":{const e=_.substring(2).split(" ");o.origin={username:e[0],sessionId:e[1],sessionVersion:e[2],netType:e[3],ipVer:parseInt(e[4].charAt(2)),address:e[5]};break}case"s":o.name=_.substring(2);break;case"t":{const e=_.substring(2).split(" ");o.timing={start:e[0],stop:e[1]};break}case"m":{o.media||(o.media=[]);const e=_.substring(2).split(" ");o.media.push({type:e[0],port:parseInt(e[1]),protocols:e[2],payloads:e.slice(3)});break}case"c":if(o.media){const e=o.media[o.media.length-1],t=_.substring(2).split(" ");e.connection={type:t[0],version:parseInt(t[1].charAt(2)),ip:t[2]}}break;case"a":{const e=o.media?o.media[o.media.length-1]:o,t=_.indexOf(":"),s=t>0?_.substring(t+1).split(" "):null,n=t>0?_.substring(2,t):_.substring(2);switch(n){case"group":e.group={type:s[0],mids:s.slice(1)};break;case"msid-semantic":e.msidSemantic={semantic:s[0],token:s[1]};break;case"ice-options":e.iceOptions=s[0];break;case"fingerprint":e.fingerprint||(e.fingerprint=[]),e.fingerprint.push({type:s[0],hash:s[1]});break;case"sendrecv":case"sendonly":case"recvonly":case"inactive":e.direction=n;break;case"extmap":{e.extmap||(e.extmap=[]);const o={value:parseInt(s[0]),uri:s[1]},t=s[0].split("/");t[1]&&(o.direction=t[1]),e.extmap.push(o);break}case"fmtp":e.fmtp||(e.fmtp=[]),e.fmtp.push({payload:parseInt(s[0]),config:s[1].split(";")});break;case"ice-ufrag":e.iceUfrag=s[0];break;case"ice-pwd":e.icePwd=s[0];break;case"msid":e.msid={group:s[0],id:s[1]};break;case"rtcp-fb":{e.rtcpFb||(e.rtcpFb=[]);const o={payload:parseInt(s[0]),type:s[1]};s[2]&&(o.subtype=s[2]),e.rtcpFb.push(o);break}case"rtcp-mux":e.rtcpMux=!0;break;case"rtcp-rsize":e.rtcpRsize=!0;break;case"rtpmap":{e.rtpmap||(e.rtpmap=[]);const o={payload:parseInt(s[0])},t=s[1].split("/");o.codec=t[0],t[1]&&(o.rate=t[1]),t[2]&&(o.channels=t[2]),e.rtpmap.push(o);break}case"ssrc":{e.ssrc||(e.ssrc=[]);const o={id:parseInt(s[0])};if(s[1]){const e=s[1].split(":");o.attribute=e[0],o.value=e[1]}e.ssrc.push(o);break}case"ssrc-group":e.ssrcGroup||(e.ssrcGroup=[]),e.ssrcGroup.push({semantics:s[0],ssrcs:s.slice(1)});break;case"candidate":{e.candidate||(e.candidate=[]);const o={network:1,foundation:s[0],component:s[1],protocol:s[2].toLowerCase(),priority:s[3],ip:s[4],port:s[5]};for(let e=6;e<s.length;e+=2)switch(s[e]){case"typ":o.type=s[e+1];break;case"raddr":o.raddr=s[e+1];break;case"rport":o.rport=s[e+1];break;case"generation":o.generation=s[e+1];break;case"tcptype":o.tcptype=s[e+1]}e.candidate.push(o);break}default:e[n]=!s||s[0]}break}}}return o}function xows_sdp_get_medias(e){const o={};let t=e.indexOf("m=");for(;t>0;){t+=2;const _=e.indexOf("\n",t),s=e.substring(t,_).split(" ")[0];"audio"!==s||o.audio||(o.audio=!0),"video"!==s||o.video||(o.video=!0),t=e.indexOf("m=",t)}return o}function xows_sdp_get_sid(e){const o=e.indexOf("o=");if(o>0){o+=2;const t=e.indexOf("\n",o);return e.substring(o,t).split(" ")[1]}return""}let d={},x="en",w=function(){};function xows_l10n_select(e,o){xows_isfunc(o)&&(w=o);let t=ns.root+"/locale/LC_list.json";ns.uncache&&(t+="?"+xows_gen_nonce_asc(4));const _=new XMLHttpRequest;_.open("GET",t,!0),_.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_select","parsing locale list",this.responseURL);let o=JSON.parse(this.responseText);if(!o)return void xows_log(0,"l10n_select",'locale list "'+this.responseURL+'" parse error');if(o[e])return xows_log(2,"l10n_select","found available locale",e),void xows_l10n_db_load(o[e]);if(-1!==e.indexOf("-")){let t=e.split("-")[0].toLowerCase();if(o[t])return xows_log(2,"l10n_select","found available language",t),void xows_l10n_db_load(o[t])}xows_log(1,"l10n_select",'invalid or unavailable locale "'+e+'"',"using default"),w()}else xows_init_fatal(this.status,this.responseURL)},xows_log(2,"l10n_select","loading locale list",t),_.send()}function xows_l10n_db_load(e,o){xows_isfunc(o)&&(w=o);let t=ns.root+"/locale/"+e+"/LC_db.json";ns.uncache&&(t+="?"+xows_gen_nonce_asc(4));const _=new XMLHttpRequest;_.open("GET",t,!0),_.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_db_load","parsing JSON data",this.responseURL);let o=JSON.parse(this.responseText);if(!o)return void xows_log(0,"l10n_db_load",'data "'+this.responseURL+'" parse error');d=o,x=e,w()}else xows_log(0,"l10n_db_load",'file "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"'),w()},xows_log(2,"l10n_db_load","loading locale db",t),_.send()}function xows_l10n_get(e){const o=d[e];return o&&0!==o.length?o:e}function xows_l10n_parseFunc(e,o){const t=d[o];return t&&0!==t.length?t:o}function xows_l10n_parse(e){return e.replace(/\${['"](.*)['"]}/g,xows_l10n_parseFunc)}function xows_l10n_hasLocale(e){return null!==d[e]&&void 0!==d[e]}function xows_l10n_date(e){const o=new Date(e),t=new Date,_=new Date(e);return t.setHours(0,0,0,0),_.setHours(0,0,0,0),t===_?xows_l10n_get("at")+" "+o.toLocaleTimeString(x):o.toLocaleDateString(x,{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}function xows_l10n_houre(e){return new Date(e).toLocaleTimeString(x,{hour:"2-digit",minute:"2-digit"})}const p=new DOMParser,m=document.implementation.createDocument("jabber:client","Xows"),g=new Map([["&","&amp;"],["<","&lt;"],[">","&gt;"],["'","&apos;"],['"',"&quot;"],["\n","<br>"]]),f=new Map([["&amp;","&"],["&lt;","<"],["&gt;",">"],["&apos;","'"],["&quot;",'"']]);function xows_xml_escap_fnc(e){return g.get(e)}function xows_xml_escape(e){return e.replace(/[\&<>'"]/g,xows_xml_escap_fnc)}function xows_xml_unesc_fnc(e){return f.get(e)}function xows_xml_unesc(e){return e.replace(/\&\w*;/g,xows_xml_unesc_fnc)}function xows_xml_parent(e,o){if("string"==typeof o||"number"==typeof o)e.appendChild(m.createTextNode(o));else if("object"==typeof o){const t=o.length;if(void 0!==t)for(let _=0;_<t;++_)xows_xml_parent(e,o[_]);else e.appendChild(o)}}function xows_xml_node(e,o,t){const _=m.createElement(e);if("object"==typeof o)for(const e in o)o.hasOwnProperty(e)&&null!==o[e]&&void 0!==o[e]&&_.setAttribute(e,o[e]);return t&&xows_xml_parent(_,t),_}function xows_xml_edit(e,o,t){let _=e.querySelector(o);if(_){for(;_.firstChild;)_.removeChild(_.lastChild);xows_xml_parent(_,t)}else _=xows_xml_node(o,null,t);return _}function xows_xml_serialize(e){let o,t,_="<"+e.nodeName;for(t=e.attributes.length,o=0;o<t;++o)_+=" "+e.attributes[o].nodeName+'="'+e.attributes[o].nodeValue+'"';if(0!==(t=e.childNodes.length)){for(_+=">",o=0;o<t;++o)1===e.childNodes[o].nodeType?_+=xows_xml_serialize(e.childNodes[o]):_+=xows_xml_escape(e.childNodes[o].nodeValue);_+="</"+e.nodeName+">"}else _+="/>";return _}function xows_xml_parse(e){return xows_clean_dom(p.parseFromString(e,"text/xml"))}function xows_xml_innertext(e){if(!e)return"";const o=e.childNodes.length;if(0===o&&3===e.nodeType)return xows_xml_unesc(e.nodeValue);let t="";for(let _=0;_<o;++_)3===e.childNodes[_].nodeType&&(t+=e.childNodes[_].nodeValue);return xows_xml_unesc(t)}let h=null,b="",F=function(){return""},y=function(e){return""},v=function(e){return!0},k=function(){},A=function(){};function xows_sasl_get_selected(){return b}function xows_sasl_plain_req(){let e=h.authz+"\0";return e+=h.authc+"\0",e+=h.passw,h={},e}function xows_sasl_plain_resp(e){return""}function xows_sasl_plain_chk(e){return!0}function xows_sasl_sha1_req(){h.cnonce=xows_gen_nonce_asc(24);let e="n="+h.authc;return e+=",r="+h.cnonce,h.client_first_message_bare=e,"n,,"+e}function xows_sasl_sha1_resp(e){let o,t,_,s,n,i,r,c=e.split(",");for(o=0,_=c.length;o<_;++o)"r"===(r=c[o].match(/([a-z]+)=(.+)/))[1]&&(s=r[2]),"s"===r[1]&&(n=r[2]),"i"===r[1]&&(i=r[2]);if(s.substring(0,24)!==h.cnonce)return h={},xows_log(0,"sasl_sha1_resp","SCRAM-SHA-1 challenge error","missing cnonce in server nonce"),xows_isfunc(k)&&k(),"";let a,l,u="c=biws,r="+s,d=h.client_first_message_bare;for(d+=","+e+","+u,a=l=xows_hmac_sha1(h.passw,atob(n)+"\0\0\0"),o=1;o<i;++o)for(l=xows_hmac_sha1(h.passw,l),t=0;t<20;++t)a[t]^=l[t];let x=xows_hmac_sha1(a,"Client Key");const w=xows_hmac_sha1(a,"Server Key"),p=xows_hmac_sha1(xows_hash_sha1(x),d);for(t=0;t<20;t++)x[t]^=p[t];h={};const m=xows_hmac_sha1(w,d);return h.sproof=xows_bytes_to_b64(m),u+=",p="+xows_bytes_to_b64(x)}function xows_sasl_sha1_chk(e){const o=e.match(/(v)=(.+)/),t=h.sproof;return h={},t===o[2]||(xows_log(0,"sasl_sha1_chk","SCRAM-SHA-1 integrity check failed","supplied server signature mismatches the computed one"),!1)}function xows_sasl_md5_req(){return""}function xows_sasl_md5_resp(e){let o,t,_,s,n,i,r=e.split(",");for(let e=0,c=r.length;e<c;++e)"realm"===(i=r[e].match(/([a-z]+)="?([^"]+)/))[1]&&(o=i[2]),"nonce"===i[1]&&(t=i[2]),"qop"===i[1]&&(_=i[2]),"host"===i[1]&&(s=i[2]),"rspauth"===i[1]&&(n=i[2]);if(void 0!==n)return"";const c=h.authc,a=h.authz,l=h.passw;h={};let u="xmpp/"+a.split("@")[1];void 0!==s&&(u+="/"+s);const d=xows_gen_nonce_asc(24),x="00000001";let w="charset=utf-8,";return w+='username="'+c+'",',w+='realm="'+o+'",',w+='nonce="'+t+'",',w+='cnonce="'+d+'",',w+="nc="+x+",",w+='digest-uri="'+u+'",',w+='response="'+xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_str(xows_hash_md5(c+":"+o+":"+l))+":"+t+":"+d+":"+a))+":"+t+":"+x+"1:"+d+":"+_+":"+xows_bytes_to_hex(xows_hash_md5("AUTHENTICATE:"+u))))+'",',w+="qop=auth"}function xows_sasl_md5_chk(e){return!0}const q=[{name:"SCRAM-SHA-1",req:xows_sasl_sha1_req,res:xows_sasl_sha1_resp,chk:xows_sasl_sha1_chk},{name:"DIGEST-MD5",req:xows_sasl_md5_req,res:xows_sasl_md5_resp,chk:xows_sasl_md5_chk},{name:"PLAIN",req:xows_sasl_plain_req,res:xows_sasl_plain_resp,chk:xows_sasl_plain_chk}];function xows_sasl_init(e,o,t,_,s,n){let i=-1;for(let o=0,t=q.length;o<t;++o)if(e.includes(q[o].name)){b=q[o].name,i=o;break}return-1!==i&&(k=n,A=s,F=q[i].req,y=q[i].res,v=q[i].chk,(h={}).authz=xows_str_to_utf8(o),h.authc=xows_str_to_utf8(t),h.passw=xows_str_to_utf8(_),!0)}let E=null,C=null,S=function(){},T=function(){},D=function(){};function xows_sck_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"open":S=o;break;case"recv":T=o;break;case"close":D=o}}function xows_sck_error(e){xows_log(0,"sck_error","Socket connection error"),E=null}function xows_sck_closed(e){if(1e3!==e.code){let o;switch(e.code){case 1001:o="Going Away";break;case 1002:o="Protocol error";break;case 1003:o="Unsupported Data";break;case 1004:o="Reserved";break;case 1005:o="No Status Rcvd";break;case 1006:o="Abnormal Closure";break;case 1007:o="Invalid frame payload data";break;case 1008:o="Policy Violation";break;case 1009:o="Message Too Big";break;case 1010:o="Mandatory Ext.";break;case 1011:o="Internal Error";break;case 1012:o="Service Restart";break;case 1013:o="Try Again Later";break;case 1014:o="Bad Gateway";break;case 1015:o="TLS handshake";break;default:o="Unhandled error ("+e.code+")"}xows_log(0,"sck_closed",o),D(_,"Socket connection error")}else xows_log(2,"sck_closed","socket closed"),D(3);E=null}function xows_sck_opened(e){xows_log(2,"sck_opened","socket connected"),S()}function xows_sck_recv(e){xows_log(3,"sck_recv",e.data,null,"#AB5655"),T(e.data)}function xows_sck_create(e,o){xows_log(3,"sck_create","socket connecting",e),(E=new WebSocket(C=e,o)).onclose=xows_sck_closed,E.onerror=xows_sck_error,E.onmessage=xows_sck_recv,E.onopen=xows_sck_opened}function xows_sck_destroy(){E&&(xows_log(3,"sck_destroy","closing WebSocket"),E.close(),E=null)}function xows_sck_send(e){E.send(e),xows_log(3,"sck_send",e,null,"#55ABAB")}let N=null,j=null;const L={bare:null,user:null,pass:null,regi:!1},B={full:null,bare:null,node:null,resc:null};let P=function(){};function xows_xmp_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"session":H=o;break;case"presence":Ne=o;break;case"subscrib":je=o;break;case"occupant":Le=o;break;case"rostpush":ge=o;break;case"message":ee=o;break;case"chatstate":_e=o;break;case"receipt":de=o;break;case"retract":pe=o;break;case"subject":oe=o;break;case"pubsub":Xe=o;break;case"jingle":jo=o;break;case"error":P=o;break;case"close":U=o}}function xows_xmp_connect(e,o,t,s){xows_sck_destroy(),xows_sck_set_callback("open",xows_xmp_sck_onopen),xows_sck_set_callback("recv",xows_xmp_sck_onrecv),xows_sck_set_callback("close",xows_xmp_sck_onclose),N=e,B.full=null,B.bare=null,B.node=null,B.resc=null;const n=o.split("@");if(j=null,void 0!==n[1]&&0!==n[1].length&&(j=n[1]),null===j){let e="Incomplete JID (undefined domain)";return xows_log(0,"xmp_connect",e),void U(_,e)}L.bare=o,L.user=n[0],L.pass=t,L.regi=s,xows_sck_create(e,"xmpp")}function xows_xmp_connectloss(e){let o;B.resc?(xows_log(2,"xmp_connectloss","connection lost",B.resc),B.resc=null,o=s):o=_,U(o,e)}function xows_xmp_reconnect(){xows_log(2,"xmp_reconnect","try reconnect",N),N&&L.bare&&L.user&&L.pass&&(xows_sck_destroy(),xows_sck_create(N,"xmpp"))}function xows_xmp_flyyoufools(){E&&(B.resc=null,L.user=null,E.send("<presence xmlns='jabber:client' type='unavailable'/>"),E.send("<close xmlns='urn:ietf:params:xml:ns:xmpp-framing'/>"))}function xows_xmp_sck_onopen(){xows_xmp_fram_open_send()}function xows_xmp_sck_onclose(e,o){L.user&&xows_xmp_connectloss(o)}const M="jabber:client";function xows_xmp_sck_onrecv(e){const o=xows_xml_parse(e).firstChild,t=o.tagName;return"iq"===t?xows_xmp_iq_recv(o):"message"===t?xows_xmp_message_recv(o):"presence"===t?xows_xmp_presence_recv(o):"challenge"===t?xows_xmp_sasl_challenge_recv(o):"success"===t?xows_xmp_sasl_success_recv(o):"failure"===t?xows_xmp_sasl_failure_recv(o):"open"===t?xows_xmp_fram_open_recv(o):"close"===t?xows_xmp_fram_close_recv(o):"stream:error"===t?xows_xmp_stream_error_recv(o):"stream:features"===t?xows_xmp_stream_features_recv(o):void xows_log(1,"xmp_recv","unprocessed stanza",event.data)}function xows_xmp_send(e,o,t){if(!E)return;"presence"!==e.tagName&&"message"!==e.tagName&&"iq"!==e.tagName||e.getAttribute("xmlns")||e.setAttribute("xmlns",M);let _=e.getAttribute("id");_||(_=xows_gen_uuid(),e.setAttribute("id",_)),xows_isfunc(o)&&J.set(_,{onresult:o,onparse:t}),xows_sck_send(xows_xml_serialize(e))}const I="urn:ietf:params:xml:ns:xmpp-framing";function xows_xmp_fram_open_recv(e){if("1.0"!=e.getAttribute("version")||e.getAttribute("xmlns")!=I){const e="Invalid server framing";xows_log(0,"xmp_fram_open_recv",e),xows_xmp_fram_close_send(_,e)}return!0}function xows_xmp_fram_open_send(){xows_log(2,"xmp_fram_open_send","open framed stream"),xows_xmp_send(xows_xml_node("open",{to:j,version:"1.0",xmlns:I}))}function xows_xmp_fram_close_recv(e){return xows_log(2,"xmp_fram_close_recv","framed stream closed"),B.resc?xows_xmp_connectloss("Server closed the stream"):(xows_sck_destroy(),U(3)),!0}function xows_xmp_fram_close_send(e,o){B.resc=null,xows_xmp_send(xows_xml_node("close",{xmlns:I})),xows_log(2,"xmp_fram_close_send","close framed stream"),e<0?U(e,o):(L.bare=null,L.user=null,L.pass=null)}const O="urn:ietf:params:xml:ns:xmpp-sasl",R="urn:ietf:params:xml:ns:xmpp-bind",G="urn:ietf:params:xml:ns:xmpp-session";let H=function(){},U=function(){};const z=[];function xows_xmp_stream_error_recv(e){return xows_log(0,"xmp_stream_error_recv",e.firstChild.tagName,xows_xml_innertext(e.querySelector("text"))),xows_xmp_connectloss("Server thrown a stream error"),!0}function xows_xmp_stream_features_recv(e){const o=e.getElementsByTagName("mechanism");if(o.length){V.length=0;for(let e=0,t=o.length;e<t;++e)V.push(xows_xml_innertext(o[e]));if(xows_log(2,"xmp_stream_features_recv","received authentication mechanisms",V.join(", ")),L.regi){if(e.querySelector("register"))xows_xmp_regi_get_query(null,xows_xmp_regi_server_get_parse);else{let e="Account registration is not allowed by server";xows_log(0,"xmp_stream_features_recv",e),xows_xmp_fram_close_send(_,e)}}else xows_xmp_sasl_auth_send();return!0}{z.length=0;let o=e.childNodes.length;for(;o--;)z.push(e.childNodes[o].getAttribute("xmlns"));xows_log(2,"xmp_stream_features_recv","received features",z.join(", ")),xows_xmp_bind_query()}return!1}const V=[];function xows_xmp_sasl_auth_send(){if(!xows_sasl_init(V,L.bare,L.user,L.pass)){let e="Unable to find a suitable authentication mechanism";return xows_log(0,"xmp_sasl_auth_send",e),void xows_xmp_fram_close_send(_,e)}const e=xows_sasl_get_selected();xows_log(2,"xmp_sasl_auth_send","select authentication mechanism",e);const o=F();0!==o.length&&(xows_log(2,"xmp_sasl_auth_send","sending authentication request",o),xows_xmp_send(xows_xml_node("auth",{xmlns:O,mechanism:e},btoa(o))))}function xows_xmp_sasl_challenge_recv(e){const o=atob(xows_xml_innertext(e));xows_log(2,"xmp_sasl_challenge_recv","received authentication challenge",o);const t=y(o);return xows_log(2,"xmp_sasl_challenge_recv","sending challenge response",t),xows_xmp_send(xows_xml_node("response",{xmlns:O},btoa(t))),!0}function xows_xmp_sasl_failure_recv(e){let o;const t=e.firstChild.tagName;switch(t.toLowerCase()){case"not-authorized":o="Wrong username or password";break;default:o="Authentication failure"}return xows_log(0,"xmp_sasl_failure_recv",t),setTimeout(xows_xmp_fram_close_send,ns.login_delay,_,o),!0}function xows_xmp_sasl_success_recv(e){const o=xows_xml_innertext(e);if(0!==o.length&&xows_log(2,"xmp_sasl_success_recv","received server proof signature",o),!v(atob(o))){const e="Server integrity check failed";return xows_log(0,"xmp_sasl_success_recv",e),xows_xmp_fram_close_send(_,e),!0}return xows_log(2,"xmp_sasl_success_recv","authentication success"),xows_xmp_fram_open_send(),!0}function xows_xmp_bind_parse(e){if("error"===e.getAttribute("type")){const o="bind resource error";return xows_log(0,"xmp_bind_parse",o,xows_xmp_iq_error_text(e)),void xows_xmp_fram_close_send(_,o)}const o=xows_xml_innertext(e.querySelector("jid"));B.full=o,B.bare=xows_jid_bare(o),B.node=xows_jid_node(o),B.resc=xows_jid_resc(o),xows_log(2,"xmp_bind_parse","binded resource",B.full),H(B)}function xows_xmp_bind_query(e=null){xows_log(2,"xmp_bind_query","query bind resource",e||"from server");const o=xows_xml_node("bind",{xmlns:R});e&&xows_xml_parent(o,xows_xml_node("resource",null,e)),xows_xmp_send(xows_xml_node("iq",{type:"set"},o),xows_xmp_bind_parse)}function xows_xmp_session_parse(e){if("error"===e.getAttribute("type")){const o="session establishment failure";return xows_log(0,"xmp_session_parse",o,xows_xmp_iq_error_text(e)),void xows_xmp_fram_close_send(_,o)}xows_log(2,"xmp_session_parse","session established"),H(B)}function xows_xmp_session_query(){xows_log(2,"xmp_session_query","query for session"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("session",{xmlns:G})),xows_xmp_session_parse)}const W="urn:ietf:params:xml:ns:xmpp-stanzas",J=new Map;function xows_xmp_iq_recv(e){const o=e.getAttribute("id");if(J.has(o)){const t=J.get(o);return J.delete(o),xows_isfunc(t.onresult)&&t.onresult(e,t.onparse),!0}if("get"===e.getAttribute("type")){const o=e.firstChild;if(void 0!==o){const t=o.getAttribute("xmlns");if(t===Be)return xows_xmp_ping_reply(e);if(t===Pe)return xows_xmp_iq_time_reply(e);if(t===Me)return xows_xmp_iq_version_reply(e);if(t===Ie)return xows_xmp_disco_info_reply(e)}return!1}if("set"===e.getAttribute("type")){const o=e.firstChild;if(void 0!==o){const t=o.getAttribute("xmlns");if(t===me)return xows_xmp_rost_push_recv(e);if(t===vo)return xows_xmp_jing_recv(e)}return!1}return!1}function xows_xmp_iq_parse(e,o){let t,s,n,i;const r=e.getAttribute("id"),c=e.getAttribute("type");if("error"===c){const o=e.querySelector("error");t=o.getAttribute("type"),s=o.getAttribute("code"),n=o.firstChild.tagName,i=xows_xml_innertext(e.querySelector("text"));const c=xows_xmp_iq_error_text(e);xows_log(1,"xmp_iq_parse","query '"+r+"' error",c),P(_,c)}xows_isfunc(o)&&o(e.getAttribute("from"),c,t,s,n,i)}function xows_xmp_iq_error_send(e,o,t,_,s){xows_xmp_send(xows_xml_node("iq",{id:e,type:"error",to:o},xows_xml_node("error",{type:t},xows_xml_node(_,{xmlns:W},content))))}function xows_xmp_iq_result_send(e,o){xows_xmp_send(xows_xml_node("iq",{id:e,type:"result",to:o}))}function xows_xmp_iq_error_text(e){let o;const t=e.querySelector("error");if(t){o=(o=(o=t.firstChild.tagName).replace(/-/g," "))[0].toUpperCase()+o.substring(1);const e=t.querySelector("text");e&&(o+=": "+xows_xml_innertext(e))}return o}const Y="urn:xmpp:delay",X="urn:xmpp:message-correct:0",K="urn:xmpp:reply:0",$="urn:xmpp:sid:0",Q="urn:xmpp:occupant-id:0",Z="urn:xmpp:styling:0";let ee=function(){},oe=function(){};function xows_xmp_message_recv(e){const o=e.getAttribute("id"),t=e.getAttribute("from"),_=e.getAttribute("to"),s=e.getAttribute("type");if("error"===s){xows_xmp_iq_error_text(e);return xows_log(1,"xmp_message_recv","error message ("+t+")",xows_xmp_iq_error_text(e)),!0}let n,i,r,c,a,l,u,d,x,w=e.childNodes.length;for(;w--;){const p=e.childNodes[w];if(1!==p.nodeType)continue;const m=p.tagName,g=p.getAttribute("xmlns");if(g===to)return xows_log(2,"xmp_message_recv","received Archive result"),xows_xmp_mam_result_recv(p);if(g===Je)return xows_log(2,"xmp_message_recv","received PubSub Event"),xows_xmp_pubsub_recv(t,p);if(g===Ue){xows_log(2,"xmp_message_recv","received forwarded Carbons");const e=p.querySelector("message");return!!e&&xows_xmp_message_recv(e)}if(g===ue&&"chat"===s){if("request"!==m)return de(o,t,_,p.getAttribute("id")),!0;xows_xmp_message_receipt_send(t,o)}if(g!==te)if(g!==Y)if(g!==Q)if(g!==$)if(g!==K)if(g!==X)if(g!==xe){if("subject"===m)return oe(o,t,xows_xml_innertext(p)),!0;"body"!==m||(i=xows_xml_innertext(p))}else pe(o,t,s,p.getAttribute("id"));else u=p.getAttribute("id");else d=p.getAttribute("id"),p.hasAttribute("to")&&(x=p.getAttribute("to"));else"origin-id"===m&&(c=p.getAttribute("id")),"stanza-id"===m&&(a=p.getAttribute("id"));else l=p.getAttribute("id");else n=new Date(p.getAttribute("stamp")).getTime();else r=ae[m]}return void 0!==i?(ee({id:o,from:t,to:_,type:s,body:i,time:n,replace:u,replyid:d,replyto:x,origid:c,stnzid:a,occuid:l}),!0):void 0!==r?(_e(o,t,s,r,l),!0):(xows_log(1,"xmp_message_recv","unhandled message ("+t+")",s),!1)}function xows_xmp_message_body_send(e,o,t,_,s,n,i){const r=xows_gen_uuid(),c=xows_xml_node("message",{id:r,to:o,type:e},xows_xml_node("body",null,t));return xows_xml_parent(c,xows_xml_node("origin-id",{id:r,xmlns:$})),s&&xows_xml_parent(c,xows_xml_node("replace",{id:s,xmlns:X})),n&&xows_xml_parent(c,xows_xml_node("reply",{id:n,to:i,xmlns:K})),_&&"chat"===e&&xows_xml_parent(c,xows_xml_node("request",{xmlns:ue})),xows_log(2,"xmp_message_body_send","send message","type "+e+" to "+o),xows_xmp_send(c),r}const te="http://jabber.org/protocol/chatstates";let _e=function(){};const se=0,ne=1,ie=2,re=3,ce=4,ae={gone:0,active:1,inactive:2,paused:3,composing:4},le=["gone","active","inactive","paused","composing"];function xows_xmp_message_chatstate_send(e,o,t){const _=le[t];xows_log(2,"xmp_message_chatstate_send","send chat state",_+" to "+e),xows_xmp_send(xows_xml_node("message",{to:e,type:o},xows_xml_node(_,{xmlns:te})))}const ue="urn:xmpp:receipts";let de=function(){};function xows_xmp_message_receipt_send(e,o){xows_log(2,"xmp_message_receipt_send","send message Receipt","received "+o+" to "+e),xows_xmp_send(xows_xml_node("message",{to:e},xows_xml_node("received",{id:o,xmlns:ue})))}const xe="urn:xmpp:message-retract:1",we="urn:xmpp:message-retract:1#tombstone";let pe=function(){};function xows_xmp_message_retract_send(e,o,t){xows_log(2,"xmp_message_retract_send","send message Retraction",t+" to "+e),xows_xmp_send(xows_xml_node("message",{to:e,type:o},xows_xml_node("retract",{id:t,xmlns:xe})))}const me="jabber:iq:roster";let ge=function(){};function xows_xmp_rost_push_recv(e){xows_xmp_send(xows_xml_node("iq",{id:e.getAttribute("id"),type:"result"},xows_xml_node("query",{xmlns:me})));const o=e.querySelector("item"),t=o.getAttribute("jid"),_=o.getAttribute("name"),s=Se[o.getAttribute("subscription")];let n=o.querySelector("group");n=n?xows_xml_innertext(n):null,xows_log(2,"xmp_rost_push_recv","received Roster Push"),ge(t,_,s,n)}function xows_xmp_rost_get_parse(e,o){if("error"===e.getAttribute("type"))return void xows_log(1,"xmp_rost_get_parse","parse get Roster",xows_xmp_iq_error_text(e));const t=e.getElementsByTagName("item"),_=[];for(let e=0,o=t.length;e<o;++e)_.push({bare:t[e].getAttribute("jid"),name:t[e].getAttribute("name"),subs:Se[t[e].getAttribute("subscription")],group:xows_xml_innertext(t[e].querySelector("group"))});xows_isfunc(o)&&o(_)}function xows_xmp_rost_get_query(e){xows_xmp_send(xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:me})),xows_xmp_rost_get_parse,e)}function xows_xmp_rost_set_query(e,o,t,_){xows_log(2,"xmp_rost_set_query","query set Roster",e);const s=xows_xml_node("item",{jid:e});o?(s.setAttribute("name",o),t&&xows_xml_parent(s,xows_xml_node("group",null,t))):s.setAttribute("subscription","remove"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("query",{xmlns:me},s)),xows_xmp_iq_parse,_)}const fe=0,he=1,be=2,Fe=3,ye=4,ve=5,ke=-1,Ae=0,qe=1,Ee=2,Ce=3,Se={remove:-1,none:0,from:1,to:2,both:3},Te=new Map([["dnd",1],["xa",2],["away",3],["chat",5]]),De=["","dnd","xa","away","","chat"];let Ne=function(){},je=function(){},Le=function(){};function xows_xmp_presence_recv(e){const o=e.getAttribute("from");let t,s,n,i,r,c,a;if(e.hasAttribute("type")){const s=e.getAttribute("type");switch(s){case"unavailable":t=-1;break;case"subscribe":case"unsubscribe":case"subscribed":case"unsubscribed":{xows_log(2,"xmp_presence_recv","received subscrib",o+" type:"+s);const t=e.querySelector("nick"),_=t?xows_xml_innertext(t):null;return je(o,s,_),!0}case"error":{const t="("+o+") "+xows_xmp_iq_error_text(e);return xows_log(1,"xmp_presence_recv","error",o+" - "+t),P(_,t),!0}}}let l=e.childNodes.length;for(;l--;){const o=e.childNodes[l];if(1!==o.nodeType)continue;const _=o.tagName,u=o.getAttribute("xmlns");switch(_){case"show":{const e=xows_xml_innertext(o);t=e?Te.get(e):ye;continue}case"priority":s=xows_xml_innertext(o);continue;case"status":n=xows_xml_innertext(o);continue}switch(u){case Ve:i=xows_xml_innertext(o.firstChild);continue;case Lo:r={node:o.getAttribute("node"),ver:o.getAttribute("ver")};continue;case Q:c=o.getAttribute("id");continue;case ao:{const e=o.querySelector("item");a={affiliation:yo[e.getAttribute("affiliation")],role:mo[e.getAttribute("role")],jid:e.getAttribute("jid"),nickname:e.getAttribute("nickname"),code:[]};const t=o.querySelectorAll("status");let _=t.length;for(;_--;)a.code.push(parseInt(t[_].getAttribute("code")));continue}}}return void 0!==a?(xows_log(2,"xmp_presence_recv","received MUC presence",o),Le(o,t,n,a,c,i)):(xows_log(2,"xmp_presence_recv","received presence",o+" show:"+t),Ne(o,t,s,n,r,i)),!0}function xows_xmp_presence_send(e,o,_,s,n,i,r){const c=xows_xml_node("presence");e&&c.setAttribute("to",e),o&&c.setAttribute("type",o),_>fe&&(xows_xml_parent(c,xows_xml_node("show",null,De[_])),xows_xml_parent(c,xows_xml_node("priority",null,20*_)),s&&xows_xml_parent(c,xows_xml_node("status",null,s)),xows_xml_parent(c,xows_xml_node("x",{xmlns:Ve},n?xows_xml_node("photo",null,n):null)),xows_xml_parent(c,xows_xml_node("c",{xmlns:Lo,hash:"sha-1",node:t,ver:xows_xmp_caps_self_verif()}))),i&&xows_xml_parent(c,xows_xml_node("x",{xmlns:co})),r&&xows_xml_parent(c,xows_xml_node("nick",{xmlns:Ze},r)),xows_log(2,"xmp_presence_send",o||"show",e||_),xows_xmp_send(c)}const Be="urn:xmpp:ping";function xows_xmp_ping_reply(e){const o=e.getAttribute("from"),t=e.getAttribute("id");xows_log(2,"xmp_ping_reply","responds to Ping",o),xows_xmp_send(xows_xml_node("iq",{id:t,to:o,type:"result"}))}const Pe="urn:xmpp:time";function xows_xmp_iq_time_reply(e){const o=e.getAttribute("from"),t=e.getAttribute("id"),_=new Date;let s=_.getTimezoneOffset()/60,n=s<0?"-":"";n+=((s=Math.abs(s))>9?s:"0"+s)+":00";const i=_.toJSON();xows_log(2,"xmp_iq_time_reply","responds to Time",o),xows_xmp_send(xows_xml_node("iq",{to:o,id:t,type:"result"},xows_xml_node("time",{xmlns:Pe},[xows_xml_node("tzo",null,n),xows_xml_node("utc",null,i)])))}const Me="jabber:iq:version";function xows_xmp_iq_version_reply(t){const _=t.getAttribute("from"),s=t.getAttribute("id");xows_log(2,"xmp_iq_version_reply","responds to Version",_),xows_xmp_send(xows_xml_node("iq",{to:_,id:s,type:"result"},xows_xml_node("query",{xmlns:Me},[xows_xml_node("name",null,e),xows_xml_node("version",null,o)])))}const Ie="http://jabber.org/protocol/disco#info",Oe="http://jabber.org/protocol/disco#items";function xows_xmp_disco_info_reply(e){const o=e.getAttribute("from"),t=e.getAttribute("id"),_=e.querySelector("query"),s=_?_.getAttribute("node"):null;xows_log(2,"xmp_disco_info_reply","responds to disco#info",o);const n=xows_xmp_caps_self_features();xows_xmp_send(xows_xml_node("iq",{to:o,id:t,type:"result"},xows_xml_node("query",{xmlns:Ie,node:s},n)))}function xows_xmp_disco_info_parse(e,o){if("error"===e.getAttribute("type"))return void xows_log(1,"xmp_disco_info_parse","parse Disco#info",xows_xmp_iq_error_text(e));const t=e.querySelector("query");let _,s,n;const i=[];for(_=0,s=(n=t.getElementsByTagName("identity")).length;_<s;++_)i.push({category:n[_].getAttribute("category"),type:n[_].getAttribute("type"),name:n[_].getAttribute("name")});const r=[];for(_=0,s=(n=t.getElementsByTagName("feature")).length;_<s;++_)n[_].hasAttribute("var")&&r.push(n[_].getAttribute("var"));const c=t.querySelector("x"),a=c?xows_xmp_xdata_parse(c):null;xows_isfunc(o)&&o(e.getAttribute("from"),i,r,a,t.getAttribute("node"))}function xows_xmp_disco_info_query(e,o,t){xows_log(2,"xmp_disco_info_query","query disco#info",e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("query",{xmlns:Ie,node:o})),xows_xmp_disco_info_parse,t)}function xows_xmp_disco_items_parse(e,o){if("error"===e.getAttribute("type"))return void xows_log(1,"xmp_disco_items_parse","parse Disco#items",xows_xmp_iq_error_text(e));const t=e.getElementsByTagName("item"),_=[];for(let e=0,o=t.length;e<o;++e)_.push({jid:t[e].getAttribute("jid"),name:t[e].getAttribute("name")});xows_isfunc(o)&&o(e.getAttribute("from"),_)}function xows_xmp_disco_items_query(e,o){xows_log(2,"xmp_disco_items_query","query disco#items",e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("query",{xmlns:Oe})),xows_xmp_disco_items_parse,o)}const Re="urn:xmpp:extdisco:2";function xows_xmp_extdisco_parse(e,o){if("error"===e.getAttribute("type"))return xows_log(1,"xmp_extdisco_parse","parse extdisco",xows_xmp_iq_error_text(e)),void(xows_isfunc(o)&&o(null));let t,_,s;const n=[];for(t=0,_=(s=e.querySelector("services").getElementsByTagName("service")).length;t<_;++t)n.push({type:s[t].getAttribute("type"),host:s[t].getAttribute("host"),port:s[t].getAttribute("port"),transport:s[t].getAttribute("transport"),username:s[t].getAttribute("username"),password:s[t].getAttribute("password"),restricted:s[t].getAttribute("restricted")});xows_isfunc(o)&&o(e.getAttribute("from"),n)}function xows_xmp_extdisco_query(e,o,t){xows_log(2,"xmp_extdisco_query","query extdisco");const _=xows_xml_node("services",{xmlns:Re});o&&_.setAttribute("type",o),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},_),xows_xmp_extdisco_parse,t)}const Ge="jabber:x:data";function xows_xmp_xdata_parse(e){const o=[],t=e.getElementsByTagName("field");for(let e=0;e<t.length;++e){const _={required:null!==t[e].querySelector("required"),type:t[e].getAttribute("type"),label:t[e].getAttribute("label"),var:t[e].getAttribute("var"),value:xows_xml_innertext(t[e].querySelector(":scope > value"))},s=t[e].querySelector(":scope > desc");s&&(_.desc=xows_xml_innertext(s));const n=t[e].querySelectorAll(":scope > option");if(n.length){_.option=[];for(let e=0;e<n.length;++e)_.option.push({label:n[e].getAttribute("label"),value:xows_xml_innertext(n[e].querySelector(":scope > value"))})}o.push(_)}return o}function xows_xmp_xdata_make(e){const o=xows_xml_node("x",{xmlns:Ge,type:"submit"});if(e&&e.length){let t;for(let _=0,s=e.length;_<s;++_)t=xows_xml_node("field"),e[_].var&&t.setAttribute("var",e[_].var),e[_].type&&t.setAttribute("type",e[_].type),e[_].value&&xows_xml_parent(t,xows_xml_node("value",null,e[_].value)),xows_xml_parent(o,t)}return o}function xows_xmp_xdata_cancel(){return xows_xml_node("x",{xmlns:Ge,type:"cancel"})}const He="jabber:iq:register";function xows_xmp_regi_get_parse(e,o){if("error"===e.getAttribute("type"))return void xows_log(1,"xmp_regi_get_parse","parse get Register",xows_xmp_iq_error_text(e));const t=e.querySelector("username"),_=e.querySelector("password"),s=e.querySelector("email"),n=e.querySelector("x"),i=!!e.querySelector("registered"),r=t?xows_xml_innertext(t):null,c=_?xows_xml_innertext(_):null,a=s?xows_xml_innertext(s):null,l=n?xows_xmp_xdata_parse(n):null;xows_isfunc(o)&&o(e.getAttribute("from"),i,r,c,a,l)}function xows_xmp_regi_get_query(e,o){xows_log(2,"xmp_regi_get_query","query get Register");const t=xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:He}));null!==e&&t.setAttribute("to",e),xows_xmp_send(t,xows_xmp_regi_get_parse,o)}function xows_xmp_regi_set_query(e,o,t,_,s,n){xows_log(2,"xmp_regi_submit","submit Register");const i=xows_xml_node("query",{xmlns:He});null!==o&&xows_xml_parent(i,xows_xml_node("username",null,o)),null!==t&&xows_xml_parent(i,xows_xml_node("password",null,t)),null!==_&&xows_xml_parent(i,xows_xml_node("email",null,_)),null!==s&&xows_xml_parent(i,xows_xmp_xdata_make(s));const r=xows_xml_node("iq",{type:"set"},i);null!==e&&r.setAttribute("to",e),xows_xmp_send(r,xows_xmp_iq_parse,n)}function xows_xmp_regi_server_set_parse(e,o,t,s,n,i){let r=null;"error"===o?("409"!==s&&"conflict"!==n||(r=i||"Unsername already exists"),"406"!==s&&"not-acceptable"!==n||(r=i||"Username contains illegal characters")):"result"===o?(xows_log(2,"xmp_regi_server_set_parse","success"),L.regi=!1,xows_xmp_sasl_auth_send()):r="Unexpected registration error",null!==r&&(xows_log(0,"xmp_regi_server_set_parse",r),setTimeout(xows_xmp_fram_close_send,ns.login_delay,_,r))}function xows_xmp_regi_server_get_parse(e,o,t,_,s,n){if(void 0!==n){let e=n.length;for(;e--;)"username"===n[e].var&&(n[e].value=L.user),"password"===n[e].var&&(n[e].value=L.pass)}else null!==t&&(t=L.user),null!==_&&(_=L.pass);xows_xmp_regi_set_query(null,t,_,null,n,xows_xmp_regi_server_set_parse)}const Ue="urn:xmpp:carbons:2";function xows_xmp_carbons_query(e,o){const t=e?"enable":"disable";xows_log(2,"xmp_carbons_query","query Message Carbons",t),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node(t,{xmlns:Ue})),xows_xmp_iq_parse,o)}const ze="vcard-temp",Ve="vcard-temp:x:update";function xows_xmp_vcardt_set_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"set",to:B.bare},xows_xml_node("vCard",{xmlns:ze},e)),xows_xmp_iq_parse,o)}function xows_xmp_vcardt_get_parse(e,o){"error"!==e.getAttribute("type")?xows_isfunc(o)&&o(e.getAttribute("from"),e.querySelector("vCard")):xows_log(1,"xmp_vcardt_get_parse","parse get vcard-Temp",xows_xmp_iq_error_text(e))}function xows_xmp_vcardt_get_query(e,o){xows_log(2,"xmp_vcardt_get_query_","query get vcard-Temp",e);const t=xows_xml_node("iq",{type:"get"},xows_xml_node("vCard",{xmlns:ze}));null!==e&&t.setAttribute("to",e),xows_xmp_send(t,xows_xmp_vcardt_get_parse,o)}const We="http://jabber.org/protocol/pubsub",Je="http://jabber.org/protocol/pubsub#event",Ye="http://jabber.org/protocol/pubsub#publish-options";let Xe=function(){};function xows_xmp_pubsub_recv(e,o){const t=o.querySelector("items");if(!t)return!1;const _=t.getAttribute("node"),s=[];for(let e=0,o=t.childNodes.length;e<o;++e)s.push({id:t.childNodes[e].getAttribute("id"),data:t.childNodes[e].firstChild});return Xe(e,_,s),!0}function xows_xmp_pubsub_publish(e,o,t,_){xows_log(2,"xmp_pubsub_publish","publish PEP node",e);const s=[o];t&&s.push(xows_xml_node("publish-options",{node:e},xows_xmp_xdata_make([{var:"FORM_TYPE",type:"hidden",value:Ye},{var:"pubsub#access_model",value:t}]))),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:We},s)),xows_xmp_iq_parse,_)}const Ke="urn:xmpp:bookmarks:1";function xows_xmp_bookmark_publish(e,o,t,_,s){const n=xows_xml_node("conference",{xmlns:Ke,name:o,autojoin:t});_&&xows_xml_parent(n,xows_xml_node("nick",null,_));const i=xows_xml_node("publish",{node:Ke},xows_xml_node("item",{id:e},n));xows_xmp_pubsub_publish(Ke,i,"whitelist",s)}const $e="urn:xmpp:vcard4",Qe="urn:ietf:params:xml:ns:vcard-4.0";function xows_xmp_vcard4_publish(e,o,t){xows_log(2,"xmp_vcard4_publish","publish vCard4",nick);const _=xows_xml_node("publish",{node:$e},xows_xml_node("item",null,xows_xml_node("vcard",{xmlns:Qe},e)));xows_xmp_pubsub_publish($e,_,o,t)}function xows_xmp_vcard4_get_parse(e,o){let t=null;"error"===e.getAttribute("type")?xows_log(1,"xmp_vcard4_get_parse","parse get vCard-4",xows_xmp_iq_error_text(e)):t=e.querySelector("vcard"),xows_isfunc(o)&&o(e.getAttribute("from"),t)}function xows_xmp_vcard4_get_query(e,o){xows_log(2,"xmp_vcard4_get_query","query get vCard-4",e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("vcard",{xmlns:Qe})),xows_xmp_vcard4_get_parse,o)}const Ze="http://jabber.org/protocol/nick";function xows_xmp_nick_publish(e,o){xows_log(2,"xmp_nick_publish","publish Nickname",e);const t=xows_xml_node("publish",{node:Ze},xows_xml_node("item",null,xows_xml_node("nick",{xmlns:Ze},e)));xows_xmp_pubsub_publish(Ze,t,null,o)}function xows_xmp_nick_get_parse(e,o){const t=e.getAttribute("from");"error"!==e.getAttribute("type")?xows_isfunc(o)&&o(t,e.querySelector("nick")):xows_log(1,"xmp_nick_get_parse","parse get Nickname ("+t+")",xows_xmp_iq_error_text(e))}function xows_xmp_nick_get_query(e,o){xows_log(2,"xmp_nick_get_query","query get Nickname",e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:We},xows_xml_node("items",{node:Ze},xows_xml_node("item",null)))),xows_xmp_nick_get_parse,o)}const eo="urn:xmpp:avatar:data",oo="urn:xmpp:avatar:metadata";function xows_xmp_avat_data_publish(e,o,t,_){xows_log(2,"xmp_avat_data_publish","publish Avatar-Data",e);const s=xows_xml_node("publish",{node:eo},xows_xml_node("item",{id:e},xows_xml_node("data",{xmlns:eo},o)));xows_xmp_pubsub_publish(eo,s,null,_)}function xows_xmp_avat_meta_publish(e,o,t,_,s,n,i){xows_log(2,"xmp_avat_meta_publish","publish Avatar-Metadata",e);const r=xows_xml_node("info",{id:e,type:o,bytes:t,width:_,height:s}),c=xows_xml_node("publish",{node:oo},xows_xml_node("item",{id:e},xows_xml_node("metadata",{xmlns:oo},r)));xows_xmp_pubsub_publish(oo,c,n,i)}function xows_xmp_avat_data_get_parse(e,o){let t,_=null;"error"===e.getAttribute("type")&&xows_log(1,"xmp_avat_data_get_parse","parse get Avatar-Data",xows_xmp_iq_error_text(e));const s=e.querySelector("item");s&&(t=s.getAttribute("id"),_=xows_xml_innertext(s.querySelector("data"))),xows_isfunc(o)&&o(e.getAttribute("from"),t,_)}function xows_xmp_avat_data_get_query(e,o,t){xows_log(2,"xmp_avat_data_get_query","query get Avatar-Data",e+" hash:"+o),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:We},xows_xml_node("items",{node:eo},xows_xml_node("item",{id:o})))),xows_xmp_avat_data_get_parse,t)}function xows_xmp_avat_meta_get_parse(e,o){const t=e.getAttribute("from");"error"!==e.getAttribute("type")?xows_isfunc(o)&&o(t,e.querySelector("metadata")):xows_log(1,"xmp_avat_meta_get_parse","parse get Avatar-Metadata ("+t+")",xows_xmp_iq_error_text(e))}function xows_xmp_avat_meta_get_query(e,o){xows_log(2,"xmp_avat_meta_get_query","query get Avatar-Metadata",e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:We},xows_xml_node("items",{node:oo}))),xows_xmp_avat_meta_get_parse,o)}const to="urn:xmpp:mam:2",_o="http://jabber.org/protocol/rsm",so=new Map,no=new Map;function xows_xmp_mam_result_recv(e){const o=e.getAttribute("id"),t=e.getAttribute("queryid");if(!so.has(t))return void xows_log(1,"xmp_recv_mam_result","unknown queryid for MAM result",t);const _=e.querySelector("forwarded");if(!_)return!1;const s=_.querySelector("message");if(!s)return!1;const n=s.getAttribute("id"),i=s.getAttribute("from"),r=s.getAttribute("to");let c,a,l,u,d,x,w,p,m;const g=s.childNodes.length;for(let e=0;e<g;++e){const o=s.childNodes[e];if(1!==o.nodeType)continue;const t=o.getAttribute("xmlns"),_=o.tagName;t!==te&&(t!==ue?t!==xe?t!==X?t!==K?t!==$?t!==Q?"body"===_&&(c=o.hasChildNodes()?xows_xml_innertext(o):""):x=o.getAttribute("id"):("origin-id"===_&&(u=o.getAttribute("id")),"stanza-id"===_&&(d=o.getAttribute("id"))):(p=o.getAttribute("id"),o.hasAttribute("to")&&(m=o.getAttribute("to"))):a=o.getAttribute("id"):l=o.getAttribute("id"):w=o.getAttribute("id"))}let f=null;const h=_.querySelector("delay");return h&&(f=new Date(h.getAttribute("stamp")).getTime()),l&&(c=null),so.get(t).push({page:o,id:n,from:i,to:r,time:f,receipt:w,body:c,replace:a,retract:l,replyid:p,replyto:m,origid:u,stnzid:d,occuid:x}),xows_log(2,"xmp_recv_mam_result","Adding archived message to result stack","from "+i),!0}function xows_xmp_mam_parse(e,o){const t=e.getAttribute("id");if(!no.has(t))return void xows_log(1,"xmp_mam_parse","MAM query id not found",t);const _=no.get(t);if(no.delete(t),"error"===e.getAttribute("type"))return void xows_log(1,"xmp_mam_parse","Archive query failure ("+_.to+")",xows_xmp_iq_error_text(e));if(!so.has(_.qid))return void xows_log(1,"xmp_mam_parse","MAM result queryid not found",qid);const s=so.get(_.qid);so.delete(_.qid);const n=e.querySelector("fin");if(n){let e,t,i,r,c,a,l=0;if(r="true"===n.getAttribute("complete"),(e=n.querySelector("count"))&&(l=parseInt(xows_xml_innertext(e))),!(e=n.querySelector("first")))return xows_log(2,"xmp_mam_parse","No result received"),void(xows_isfunc(o)&&o(_.to,_.jid,[],l,r));t=xows_xml_innertext(e),(e=n.querySelector("last"))&&(i=xows_xml_innertext(e));const u=s.length;for(c=0;c<u&&s[c].page!==t;c++);if(c>=u)xows_log(0,"xmp_mam_parse","first result page not found in stack",t),a=[];else{let e=c,o=0;do{if(c===u){xows_log(1,"xmp_mam_parse","last result page not found (reached end of stack)",i);break}o++}while(s[c++].page!==i);a=s.splice(e,o)}xows_log(2,"xmp_mam_parse","results collected","("+a.length+"/"+l+") '"+t+"'=>'"+i+"'"),xows_isfunc(o)&&o(_.to,_.jid,a,l,r)}}function xows_xmp_mam_query(e,o,t,_,s,n,i){const r=[];r.push({var:"FORM_TYPE",type:"hidden",value:to}),t&&r.push({var:"with",value:t}),_&&r.push({var:"start",value:new Date(_).toJSON()}),s&&r.push({var:"end",value:new Date(s).toJSON()});const c=xows_xml_node("set",{xmlns:_o},xows_xml_node("max",null,o));!n&&_||xows_xml_parent(c,xows_xml_node("before",null,n));const a=xows_gen_nonce_asc(12);so.set(a,[]);const l=xows_gen_uuid(),u=xows_xml_node("iq",{id:l,type:"set"},xows_xml_node("query",{xmlns:to,queryid:a},[xows_xmp_xdata_make(r),c]));null!==e&&u.setAttribute("to",e),no.set(l,{to:e,jid:t,qid:a}),xows_log(2,"xmp_mam_query","send Archive query","with "+t+" start "+_+" end "+s),xows_xmp_send(u,xows_xmp_mam_parse,i)}const io="urn:xmpp:http:upload:0",ro=new Map;function xows_xmp_upld_parse(e,o){const t=e.getAttribute("id");if(!ro.has(t))return void xows_log(1,"xmp_upld_parse","query parameters not found");const _=ro.get(t);if(ro.delete(t),"error"===e.getAttribute("type")){const t=xows_xmp_iq_error_text(e);return xows_log(1,"xmp_upld_parse","HTTP-Upload query error",t),void(xows_isfunc(o)&&o(_.name,null,null,null,t))}const s=e.querySelector("slot"),n=s.querySelector("put"),i=n.getAttribute("url"),r=n.getElementsByTagName("header"),c=s.querySelector("get").getAttribute("url");xows_log(2,"xmp_upld_parse","accepted HTTP-Upload slot",i),xows_isfunc(o)&&o(_.name,i,r,c)}function xows_xmp_upld_query(e,o,t,_,s){xows_log(2,"xmp_upld_query","send HTTP-Upload query",t+" bytes required");let n={xmlns:io,filename:o,size:t};_&&(n.type=_);const i=xows_gen_uuid(),r=xows_xml_node("iq",{id:i,to:e,type:"get"},xows_xml_node("request",n));ro.set(i,{name:o}),xows_xmp_send(r,xows_xmp_upld_parse,s)}const co="http://jabber.org/protocol/muc",ao="http://jabber.org/protocol/muc#user",lo="http://jabber.org/protocol/muc#owner",uo=0,xo=1,wo=2,po=3,mo={none:0,visitor:1,participant:2,moderator:3},go=-1,fo=0,ho=1,bo=2,Fo=3,yo={outcast:-1,none:0,member:1,admin:2,owner:3};function xows_xmp_muc_subject_send(e,o){const t=xows_gen_uuid();return xows_log(2,"xmp_muc_subject_send","send subject to",e),xows_xmp_send(xows_xml_node("message",{id:t,to:e,type:"groupchat"},xows_xml_node("subject",null,xows_xml_escape(o)))),t}function xows_xmp_muc_cfg_get_parse(e,o){"error"!==e.getAttribute("type")?xows_isfunc(o)&&o(e.getAttribute("from"),xows_xmp_xdata_parse(e.querySelector("x"))):xows_log(1,"xmp_muc_cfg_get_parse","parse get MUC config",xows_xmp_iq_error_text(e))}function xows_xmp_muc_cfg_get_guery(e,o){xows_log(2,"xmp_muc_cfg_get_guery","query get MUC config",e),xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("query",{xmlns:lo})),xows_xmp_muc_cfg_get_parse,o)}function xows_xmp_muc_cfg_set_cancel(e,o){xows_log(2,"xmp_muc_cfg_set_cancel","cancel set MUC config",e);const t=xows_xmp_xdata_cancel();xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:lo},t)),xows_xmp_iq_parse,o)}function xows_xmp_muc_cfg_set_query(e,o,t){xows_log(2,"xmp_muc_cfg_set_query","query set MUC config",e);const _=xows_xmp_xdata_make(o);xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:lo},_)),xows_xmp_iq_parse,t)}function xows_xmp_muc_role_query(e,o,t,_,s){xows_log(2,"xmp_muc_role_set_query","query set MUC role",e);const n=_?xows_xml_node("reason",null,_):null;xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:lo},xows_xml_node("item",{nick:o,role:t},n))),xows_xmp_iq_parse,s)}function xows_xmp_muc_affi_query(e,o,t,_,s){xows_log(2,"xmp_muc_role_set_query","query set MUC role",e);const n=_?xows_xml_node("reason",null,_):null;xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:lo},xows_xml_node("item",{affiliation:t,jid:o},n))),xows_xmp_iq_parse,s)}function xows_xmp_muc_destroy_query(e,o,t,_,s){xows_log(2,"xmp_muc_destroy_query","query destroy MUC room",e);const n=xows_xml_node("destroy",null,null);o&&n.setAttribute("jid",o),t&&xows_xml_parent(n,xows_xml_node("password",null,t)),_&&xows_xml_parent(n,xows_xml_node("reason",null,_)),xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:lo},n)),xows_xmp_iq_parse,s)}const vo="urn:xmpp:jingle:1",ko="urn:xmpp:jingle:apps:rtp:1",Ao="urn:xmpp:jingle:apps:rtp:audio",qo="urn:xmpp:jingle:apps:rtp:video",Eo="urn:xmpp:jingle:transports:ice-udp:1",Co="urn:xmpp:jingle:apps:rtp:rtcp-fb:0",So="urn:xmpp:jingle:apps:rtp:rtp-hdrext:0",To="urn:xmpp:jingle:apps:dtls:0",Do="urn:xmpp:jingle:apps:grouping:0",No="urn:xmpp:jingle:apps:rtp:ssma:0";let jo=function(){};function xows_xmp_jing_jingle2sdp(e){const o=e.querySelectorAll("description");for(let e=0;e<o.length;++e)if(o[e].getAttribute("xmlns")!==ko)return null;let t="v=0\r\no=- "+Math.round(Date.now()/1)+" 0 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\n";const _=e.querySelector("group");if(_){t+="a=group:"+_.getAttribute("semantics");const e=_.querySelectorAll("content");for(let o=0;o<e.length;++o)t+=" "+e[o].getAttribute("name");t+="\r\n"}const s=e.querySelectorAll(":scope > content");for(let e=0;e<s.length;++e){const o=s[e].querySelector("description"),_=s[e].querySelector("transport"),n=_.querySelectorAll("fingerprint");t+="m="+o.getAttribute("media"),t+=n.length?" 1 RTP/SAVPF":" RTP/AVPF";const i=o.querySelectorAll("payload-type");for(let e=0;e<i.length;++e)t+=" "+i[e].getAttribute("id");switch(t+="\r\n",t+="c=IN IP4 0.0.0.0\r\n",_.getAttribute("senders")){case"both":t+="a=sendrecv";break;case"initiator":t+="a=sendonly";break;case"responder":t+="a=recvonly";break;case"none":t+="a=inactive"}t+="\r\n",t+="a=mid:"+s[e].getAttribute("name")+"\r\n",_.hasAttribute("ufrag")&&(t+="a=ice-ufrag:"+_.getAttribute("ufrag")+"\r\n"),_.hasAttribute("pwd")&&(t+="a=ice-pwd:"+_.getAttribute("pwd")+"\r\n");const r=_.querySelectorAll("fingerprint");for(let e=0;e<r.length;++e)t+="a=fingerprint:"+r[e].getAttribute("hash")+" "+xows_xml_innertext(r[e])+"\r\n";r.length&&(t+="a=setup:"+r[0].getAttribute("setup")+"\r\n");const c=o.querySelectorAll("rtp-hdrext");for(let e=0;e<c.length;++e)t+="a=extmap:"+c[e].getAttribute("id"),"initiator"==c[e].getAttribute("senders")&&(t+="/recvonly"),t+=" "+c[e].getAttribute("uri")+"\r\n";for(let e=0;e<i.length;++e){const o=i[e].querySelectorAll("parameter");if(o.length){t+="a=fmtp:"+i[e].getAttribute("id")+" ";for(let e=0;e<o.length;++e)t+=o[e].getAttribute("name")+"="+o[e].getAttribute("value"),e<o.length-1&&(t+=";");t+="\r\n"}}for(let e=0;e<i.length;++e){const o=i[e].querySelectorAll("rtcp-fb");if(o.length)for(let _=0;_<o.length;++_)t+="a=rtcp-fb:"+i[e].getAttribute("id"),t+=" "+o[_].getAttribute("type"),o[_].hasAttribute("subtype")&&(t+=" "+o[_].getAttribute("subtype")),t+="\r\n"}o.querySelector("rtcp-mux")&&(t+="a=rtcp-mux\r\n");for(let e=0;e<i.length;++e)t+="a=rtpmap:"+i[e].getAttribute("id")+" ",t+=i[e].getAttribute("name"),i[e].hasAttribute("clockrate")&&(t+="/"+i[e].getAttribute("clockrate")),i[e].hasAttribute("channels")&&(t+="/"+i[e].getAttribute("channels")),t+="\r\n";const a=o.querySelectorAll("source");for(let e=0;e<a.length;++e){t+="a=ssrc:"+a[e].getAttribute("ssrc");const o=a[e].querySelector("parameter");o&&(t+=" "+o.getAttribute("name")+":"+o.getAttribute("value")),t+="\r\n"}const l=o.querySelectorAll("ssrc-group");for(let e=0;e<l.length;++e){t+="a=ssrc-group:"+l[e].getAttribute("semantics");const o=l[e].querySelectorAll("source");for(let e=0;e<o.length;++e)t+=" "+o[e].getAttribute("ssrc");t+="\r\n"}const u=_.querySelectorAll("candidate");for(let e=0;e<u.length;++e)t+="a=candidate:"+u[e].getAttribute("foundation"),t+=" "+u[e].getAttribute("component"),t+=" "+u[e].getAttribute("protocol").toUpperCase(),t+=" "+u[e].getAttribute("priority"),t+=" "+u[e].getAttribute("ip"),t+=" "+u[e].getAttribute("port"),u[e].hasAttribute("type")&&(t+=" typ "+u[e].getAttribute("type")),u[e].hasAttribute("rel-addr")&&(t+=" raddr "+u[e].getAttribute("rel-addr")),u[e].hasAttribute("rel-port")&&(t+=" rport "+u[e].getAttribute("rel-port")),u[e].hasAttribute("generation")&&(t+=" generation "+u[e].getAttribute("generation")),t+="\r\n"}return t}function xows_xmp_jing_sdp2jingle(e){const o=xows_sdp_parse(e),t=xows_xml_node("jingle",{xmlns:vo}),_=xows_xml_node("group",{xmlns:Do,semantics:o.group.type});for(const e in o.group.mids)xows_xml_parent(_,xows_xml_node("content",{name:e}));xows_xml_parent(t,_);for(let e=0;e<o.media.length;++e){const _=xows_xml_node("content",{creator:"initiator",name:o.media[e].mid}),s=xows_xml_node("description",{xmlns:ko,media:o.media[e].type});if(o.media[e].rtpmap){const t=o.media[e].rtpmap;for(let e=0;e<t.length;++e)xows_xml_parent(s,xows_xml_node("payload-type",{id:t[e].payload,name:t[e].codec,clockrate:t[e].rate,channels:t[e].channels}))}if(o.media[e].fmtp){const t=o.media[e].fmtp;for(let e=0;e<t.length;++e){const o=s.querySelector("payload-type[id='"+t[e].payload+"']");if(o)for(let _=0;_<t[e].config.length;++_){const s=t[e].config[_].split("=");xows_xml_parent(o,xows_xml_node("parameter",{name:s[0],value:s[1]}))}}}if(o.media[e].rtcpFb){const t=o.media[e].rtcpFb;for(let e=0;e<t.length;++e){const o=s.querySelector("payload-type[id='"+t[e].payload+"']");o&&xows_xml_parent(o,xows_xml_node("rtcp-fb",{xmlns:Co,type:t[e].type,subtype:t[e].subtype}))}}if(o.media[e].ssrcGroup){const t=o.media[e].ssrcGroup;for(let e=0;e<t.length;++e){const o=xows_xml_node("ssrc-group",{xmlns:No,semantics:t[e].semantics});for(let _=0;_<t[e].ssrcs.length;++_)xows_xml_parent(o,xows_xml_node("source",{ssrc:t[e].ssrcs[_]}));xows_xml_parent(s,o)}}if(o.media[e].ssrc){const t=o.media[e].ssrc;for(let e=0;e<t.length;++e)xows_xml_parent(s,xows_xml_node("source",{xmlns:No,ssrc:t[e].id},xows_xml_node("parameter",{name:t[e].attribute,value:t[e].value})))}if(o.media[e].extmap){const t=o.media[e].extmap;for(let e=0;e<t.length;++e){const o=xows_xml_node("rtp-hdrext",{xmlns:So,id:t[e].value,uri:t[e].uri});"recvonly"===t[e].direction&&o.setAttribute("senders","initiator"),xows_xml_parent(s,o)}}o.media[e].rtcpMux&&xows_xml_parent(s,xows_xml_node("rtcp-mux")),xows_xml_parent(_,s);const n=xows_xml_node("transport",{xmlns:Eo,pwd:o.media[e].icePwd,ufrag:o.media[e].iceUfrag});switch(o.media[e].direction){case"sendrecv":n.setAttribute("senders","both");break;case"sendonly":n.setAttribute("senders","initiator");break;case"recvonly":n.setAttribute("senders","responder");break;case"inactive":n.setAttribute("senders","none")}if(o.media[e].fingerprint||o.fingerprint){const t=o.media[e].fingerprint?o.media[e].fingerprint:o.fingerprint;for(let _=0;_<t.length;++_)xows_xml_parent(n,xows_xml_node("fingerprint",{xmlns:To,hash:t[_].type,setup:o.media[e].setup},t[_].hash))}if(o.media[e].candidate){const t=o.media[e].candidate;for(let e=0;e<t.length;++e){xows_xml_parent(n,xows_xml_node("candidate",{component:t[e].component,network:t[e].network,foundation:t[e].foundation,generation:t[e].generation,protocol:t[e].protocol,priority:t[e].priority,ip:t[e].ip,port:t[e].port,type:t[e].type,"rel-addr":t[e].raddr,"rel-port":t[e].rport}))}}xows_xml_parent(_,n),xows_xml_parent(t,_)}return t}function xows_xmp_jing_recv(e){const o=e.getAttribute("from"),t=e.querySelector("jingle"),_=t.getAttribute("action");let s;if("session-terminate"===_){const e=t.querySelector("reason");e&&e.childNodes[0]&&(s=e.childNodes[0].tagName)}else if(null===(s=xows_xmp_jing_jingle2sdp(t)))return xows_log(1,"xmp_recv_jingle","error","RTP to SDP conversion failed"),void xows_xmp_iq_error_send(e.getAttribute("id"),o,"cancel","bad-request");xows_log(2,"xmp_recv_jingle","received "+_,o),jo(o,e.getAttribute("id"),t.getAttribute("sid"),_,s)}function xows_xmp_jing_result(e,o){if("error"===e.getAttribute("type")){const t=xows_xmp_iq_error_text(e);return xows_log(1,"xmp_jingle_parse","Jingle query error",t),void(xows_isfunc(o)&&o(_,t))}xows_isfunc(o)&&o(3)}function xows_xmp_jing_initiate_sdp(e,o,t){const _=xows_xmp_jing_sdp2jingle(o),s=xows_gen_nonce_asc(16);_.setAttribute("initiator",B.full),_.setAttribute("action","session-initiate"),_.setAttribute("sid",s),xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},_),xows_xmp_jing_result,t)}function xows_xmp_jing_accept_sdp(e,o,t,_){const s=xows_xmp_jing_sdp2jingle(t);s.setAttribute("responder",B.full),s.setAttribute("action","session-accept"),s.setAttribute("sid",o),xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},s),xows_xmp_jing_result,_)}function xows_xmp_jing_terminate(e,o,t,_){xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},xows_xml_node("jingle",{xmlns:vo,sid:o,action:"session-terminate"},xows_xml_node("reason",null,xows_xml_node(t)))),xows_xmp_jing_result,_)}const Lo="http://jabber.org/protocol/caps";function xows_xmp_caps_self_features(){let o=$e,t=oo;return ns.vcard4_notify&&(o+="+notify"),ns.avatar_notify&&(t+="+notify"),[xows_xml_node("identity",{category:"client",name:e,type:"web"}),xows_xml_node("feature",{var:Lo}),xows_xml_node("feature",{var:Ie}),xows_xml_node("feature",{var:Oe}),xows_xml_node("feature",{var:Be}),xows_xml_node("feature",{var:Pe}),xows_xml_node("feature",{var:Me}),xows_xml_node("feature",{var:te}),xows_xml_node("feature",{var:ue}),xows_xml_node("feature",{var:X}),xows_xml_node("feature",{var:Z}),xows_xml_node("feature",{var:$}),xows_xml_node("feature",{var:xe}),xows_xml_node("feature",{var:K}),xows_xml_node("feature",{var:ze}),xows_xml_node("feature",{var:Qe}),xows_xml_node("feature",{var:o}),xows_xml_node("feature",{var:eo}),xows_xml_node("feature",{var:t}),xows_xml_node("feature",{var:Ke+"+notify"}),xows_xml_node("feature",{var:vo}),xows_xml_node("feature",{var:ko}),xows_xml_node("feature",{var:Ao}),xows_xml_node("feature",{var:qo})]}function xows_xmp_caps_self_verif(){const e=xows_xmp_caps_self_features();let o,t=e.length,_="";for(o=0;o<t;++o)"identity"===e[o].tagName&&(_+=e[o].getAttribute("category")+"/",_+=e[o].getAttribute("type")+"/",_+=(e[o].hasAttribute("xml:lang")?e[o].getAttribute("xml:lang"):"")+"/",_+=e[o].getAttribute("name")+"<");for(o=0;o<t;++o)"feature"===e[o].tagName&&(_+=e[o].getAttribute("var")+"<");return xows_bytes_to_b64(xows_hash_sha1(_))}const Bo=new Map;function xows_cach_avat_save(e,o,t){const _=o||xows_bytes_to_hex(xows_hash_sha1(xows_url_to_bytes(e)));return Bo.set(_,e),t||localStorage.setItem(_,e),_}function xows_cach_avat_has(e){return!!Bo.has(e)||!!localStorage.hasOwnProperty(e)}function xows_cach_avat_get(e){return Bo.has(e)?Bo.get(e):localStorage.hasOwnProperty(e)?(Bo.set(e,localStorage.getItem(e)),Bo.get(e)):null}const Po=new Map;function xows_cach_peer_save(e,o,t,_,s){let n=null;if(o&&t&&_&&null!==s)n={name:o,avat:t,desc:_,noti:s};else{try{n=JSON.parse(localStorage.getItem(e))}catch(e){xows_log(1,"cli_cache_peer_add","JSON parse error",e)}null!==n?(o&&(n.name=o),t&&(n.avat=t),_&&(n.desc=_),null!==s&&(n.noti=s)):n={name:o,avat:t,desc:_,noti:s}}Po.set(e,n),localStorage.setItem(e,JSON.stringify(n))}function xows_cach_peer_has(e){return!!Po.has(e)||!!localStorage.hasOwnProperty(e)}function xows_cach_peer_get(e){if(Po.has(e))return Po.get(e);if(localStorage.hasOwnProperty(e)){try{Po.set(e,JSON.parse(localStorage.getItem(e)))}catch(o){return xows_log(1,"cli_cache_peer_get","JSON parse error",o),localStorage.removeItem(e),null}return Po.get(e)}return null}const Mo=new Map;function xows_cach_caps_save(e,o){Mo.set(e,o),localStorage.setItem(e,JSON.stringify(o))}function xows_cach_caps_has(e){return!!Mo.has(e)||!!localStorage.hasOwnProperty(e)}function xows_cach_caps_get(e){if(Mo.has(e))return Mo.get(e);if(localStorage.hasOwnProperty(e)){try{Mo.set(e,JSON.parse(localStorage.getItem(e)))}catch(o){return xows_log(1,"cli_cache_caps_get","JSON parse error",o),localStorage.removeItem(e),null}return Mo.get(e)}return null}const Io=[],Oo=new Map;function xows_cli_entity_has(e,o){return!!Oo.has(e)&&Oo.get(e).feat.includes(o)}const Ro=new Map,Go=[];function xows_cli_external_has(e){const o=Array.from(arguments);let t;t=ns.extern_services;for(let e=0;e<t.length;++e)if(o.includes(t[e].type))return!0;t=Go;for(let e=0;e<t.length;++e)if(o.includes(t[e].type))return!0;return!1}function xows_cli_external_get(e){const o=Array.from(arguments);let t;const _=[];t=ns.extern_services;for(let e=0;e<t.length;++e)o.includes(t[e].type)&&_.push(t[e]);t=Go;for(let e=0;e<t.length;++e)o.includes(t[e].type)&&_.push(t[e]);return _}const Ho=0,Uo=1,zo=2,Vo=3;let Wo={jid:null,bare:null,name:null,avat:null,show:0,stat:null,vcrd:null};function xows_cli_isself(e){return e.startsWith(Wo.bare)}Object.defineProperty(Wo,"type",{value:Uo,writable:!1}),Object.seal(Wo);const Jo=[];function xows_cli_cont_new(e,o,t,_){const s={lock:e,name:o||e,subs:t,avat:_,show:0,stat:"",noti:!0,chat:0,call:null};return xows_def_readonly(s,"type",Uo),xows_def_readonly(s,"bare",e),xows_def_readonly(s,"ress",new Map),Object.seal(s),Jo.push(s),s}function xows_cli_cont_get(e){const o=xows_jid_bare(e);let t=Jo.length;for(;t--;)if(Jo[t].bare===o)return Jo[t];return null}function xows_cli_cont_best_jid(e){if(e.lock!=e.bare)return e.lock;{let o=null;const t=Array.from(e.ress.values());return t.length&&(t.length>1&&(t.sort(function(e,o){return o.show-e.show}),t.sort(function(e,o){return o.prio-e.prio})),o=t[0].id),o?e.bare+"/"+o:e.bare}}const Yo=[];function xows_cli_room_new(e,o,t,_,s){const n={name:o,desc:t,subj:"",publ:s,prot:_,join:null,role:0,affi:0,occu:[],noti:!0,init:!1,book:!1,writ:[]};return xows_def_readonly(n,"type",zo),xows_def_readonly(n,"bare",e),xows_def_readonly(n,"lock",e),Object.seal(n),Yo.push(n),n}function xows_cli_room_get(e){const o=xows_jid_bare(e);let t=Yo.length;for(;t--;)if(Yo[t].bare===o)return Yo[t];return null}function xows_cli_occu_new(e,o,t,_,s,n){let i,r=!1;_&&(i=xows_jid_bare(_),r=xows_cli_isself(_));const c={name:n||xows_jid_resc(o),affi:0,role:0,full:_,bare:i,avat:s,show:4,stat:"",chat:0};return xows_def_readonly(c,"type",Vo),xows_def_readonly(c,"room",e),xows_def_readonly(c,"jid",o),xows_def_readonly(c,"uid",t||o),xows_def_readonly(c,"self",r),Object.seal(c),e.occu.push(c),c}function xows_cli_occu_get(e,o,t){let _=e.occu.length;for(;_--;)if(e.occu[_].uid===t||e.occu[_].jid===o)return e.occu[_];return null}function xows_cli_occu_any(e,o,t){let _=e.occu.length;for(;_--;)if(e.occu[_].uid===t||e.occu[_].jid===o)return e.occu[_];const s=t||o,n=xows_cach_peer_get(s);return xows_cli_occu_new(e,o,t,null,n?n.avat:xows_cli_avat_temp(s))}function xows_cli_peer_get(e){const o=xows_jid_bare(e);let t=Yo.length;for(;t--;)if(Yo[t].bare===o)return Yo[t];for(t=Jo.length;t--;)if(Jo[t].bare===o)return Jo[t];return null}function xows_cli_peer_update(e,o,t,_){if(!e||xows_cli_isself(e))xows_log(2,"cli_peer_update","received own profile data"),xows_cach_peer_save(Wo.bare,o,t,_,null),o&&(Wo.name=o),t&&(Wo.avat=t),_&&(Wo.stat=_),Ko(Wo),(t||_)&&xows_cli_presence_update();else{const s=xows_cli_peer_get(e);if(!s)return void xows_log(1,"cli_peer_update","unknown/unsubscribed peer",e);if(xows_log(2,"cli_peer_update","received profile data for",e),s.type===Uo)o&&(s.name=o),t&&(s.avat=t),_&&(s.stat=_),xows_cach_peer_save(e,o,t,_,null),rt(s);else{const n=xows_cli_occu_get(s,e);n&&(o&&(n.name=o),t&&(n.avat=t),xows_cach_peer_save(n.uid,o,t,_,null),qt(s,n))}}}function xows_cli_peer_iden(e){return e.type===Vo?e.uid?e.uid:e.jid:e.bare}function xows_cli_author_get(e,o,t){return t||e.type===zo?o===e.join?Wo:xows_cli_occu_any(e,o,t):o.startsWith(Wo.bare)?Wo:xows_cli_cont_get(o)}let Xo=function(){},Ko=function(){},$o=function(){},Qo=function(){};function xows_cli_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"connect":Xo=o;break;case"selfchange":Ko=o;break;case"contpush":rt=o;break;case"contrem":ct=o;break;case"subspush":at=o;break;case"subsrem":lt=o;break;case"roompush":kt=o;break;case"roomrem":At=o;break;case"occupush":qt=o;break;case"occurem":Et=o;break;case"message":ut=o;break;case"chatstate":xt=o;break;case"receipt":dt=o;break;case"retract":pt=o;break;case"subject":Ct=o;break;case"callerror":Tt=o;break;case"callinit":Dt=o;break;case"callaccept":Nt=o;break;case"callend":jt=o;break;case"error":$o=o;break;case"timeout":tt=o;break;case"close":Qo=o}}function xows_cli_xmp_onerror(e,o){$o(e,o)}function xows_cli_connect(e,o,t,_){return Jo.length=0,Yo.length=0,Ro.clear(),Oo.clear(),Go.length=0,Ft=ns.history_size/2,Wo.jid=null,Wo.bare=null,Wo.name=null,Wo.avat=null,Wo.stat=null,Wo.vcrd=null,xows_cli_activity_stop(),xows_xmp_set_callback("session",xows_cli_xmp_onsession),xows_xmp_set_callback("presence",xows_cli_xmp_onpresence),xows_xmp_set_callback("subscrib",xows_cli_xmp_onsubscribe),xows_xmp_set_callback("occupant",xows_cli_xmp_onoccupant),xows_xmp_set_callback("rostpush",xows_cli_xmp_onrostpush),xows_xmp_set_callback("message",xows_cli_xmp_onmessage),xows_xmp_set_callback("chatstate",xows_cli_xmp_onchatstate),xows_xmp_set_callback("receipt",xows_cli_xmp_onreceipt),xows_xmp_set_callback("retract",xows_cli_xmp_onretract),xows_xmp_set_callback("subject",xows_cli_xmp_onsubject),xows_xmp_set_callback("pubsub",xows_cli_xmp_onpubsub),xows_xmp_set_callback("jingle",xows_cli_xmp_onjingle),xows_xmp_set_callback("error",xows_cli_xmp_onerror),xows_xmp_set_callback("close",xows_cli_xmp_onclose),xows_xmp_connect(e,o,t,_)}function xows_cli_xmp_onsession(e){Wo.jid=e.full,Wo.bare=e.bare;const o=xows_cach_peer_get(Wo.bare);if(null!==o&&(o.name&&(Wo.name=o.name),o.avat&&(Wo.avat=o.avat),o.desc&&(Wo.stat=o.desc)),null===Wo.name){const e=B.node;Wo.name=e.charAt(0).toUpperCase()+e.slice(1)}Wo.avat||(Wo.avat=xows_cli_avat_temp(Wo.bare)),_t?xows_xmp_rost_get_query(xows_cli_initialize):(xows_cli_disco_queue(Wo.bare),xows_cli_disco_queue(j),xows_cli_disco_start(xows_cli_disco_finish,!0))}function xows_cli_connected(){return null!==Wo.jid}const Zo=[];function xows_cli_discoinfo_query(e,o=null){Zo.push(e),xows_xmp_disco_info_query(e,o,xows_cli_discoinfo_parse)}function xows_cli_discoinfo_parse(e,o,t,_){xows_log(2,"cli_discoinfo_parse","discovered entiy",e),Oo.set(e,{iden:o,feat:t,item:[]}),o.length&&e.includes("@")&&"conference"===o[0].category&&xows_cli_muc_discoinfo_parse(e,o,t,_),t.includes(Oe)&&(Zo.push(e),xows_xmp_disco_items_query(e,xows_cli_discoitems_parse)),t.includes(Re)&&(Zo.push(e),xows_xmp_extdisco_query(e,null,xows_cli_extdisco_parse)),xows_cli_disco_ended(e)}function xows_cli_discoitems_parse(e,o){const t=Oo.get(e);"conference"===t.iden[0].category&&kt(null);for(let e=0,_=o.length;e<_;++e)t.item.push(o[e].jid),xows_cli_discoinfo_query(o[e].jid);xows_cli_disco_ended(e)}function xows_cli_extdisco_parse(e,o){for(let e=0,t=o.length;e<t;++e){xows_log(2,"cli_extdisco_parse","discovered external",o[e].type+" ("+o[e].host+":"+o[e].port+")"),Go.push(o[e])}xows_cli_disco_ended(e)}const et=[];let ot=null;function xows_cli_disco_queue(e){et.push(e)}function xows_cli_disco_start(e,o=!1){xows_log(2,"cli_discoinfo_start","start new discovery cycle"),Zo.length,o&&(Oo.clear(),Ro.clear(),Go.length=0),ot=e;for(let e=0,o=et.length;e<o;++e)xows_cli_discoinfo_query(et[e]);et.length=0}function xows_cli_disco_ended(e){Zo.splice(Zo.indexOf(e),1),Zo.length||(xows_isfunc(ot)&&ot(),ot=null)}function xows_cli_disco_finish(){Oo.get(j).feat.includes(Ue)&&xows_xmp_carbons_query(!0);for(const[e,o]of Oo)o.feat.includes(co)&&(Ro.has(co)||Ro.set(co,[]),Ro.get(co).push(e)),o.feat.includes(io)&&(Ro.has(io)||Ro.set(io,[]),Ro.get(io).push(e));xows_xmp_rost_get_query(xows_cli_initialize)}function xows_cli_initialize(e){if(xows_cli_rost_get_parse(e),Wo.show=mt=ye,xows_xmp_presence_send(null,null,ye,Wo.stat),_t){_t=!1;let e=Yo.length;for(;e--;)Yo[e].join&&(Yo[e].join=null,xows_cli_muc_join(Yo[e]))}else ns.vcard4_notify||xows_cli_vcard_query(Wo.bare),ns.avatar_notify||xows_cli_avat_meta_query(Wo.bare),xows_cli_nick_query(Wo.bare),Ko(Wo);xows_log(2,"cli_initialize","client ready"),Xo(Wo)}let tt=function(){},_t=!1;function xows_cli_xmp_onclose(e,o){xows_log(2,"cli_xmp_onclose","connexion cloded","("+e+") "+o),_t?xows_cli_reconnect():(e==s?(xows_log(1,"cli_xmp_onclose","lost connection",o),_t=!0,xows_cli_rost_reset(),xows_cli_reconnect(5)):Wo.jid&&(xows_log(1,"cli_xmp_onclose","session destroy",o),Jo.length=0,Yo.length=0,Wo.jid=null,Wo.bare=null,Wo.name=null,Wo.avat=null,Wo.stat=null,Wo.vcrd=null,xows_cli_activity_stop()),Qo(e,o))}const st=5e3;let nt=null,it=0;function xows_cli_reconn_try(){_t&&xows_xmp_reconnect(),nt=null,it--}function xows_cli_reconnect(e){_t&&(e&&(it=e),xows_log(2,"cli_reconnect","attempt left",it),xows_cli_activity_stop(),it?nt||(nt=setTimeout(xows_cli_reconn_try,st)):tt())}function xows_cli_disconnect(){Wo.jid&&(xows_log(2,"cli_disconnect","prepare disconnect"),_t=!1,xows_cli_jing_terminate(),xows_cli_show_select(0),xows_xmp_fram_close_send(3))}function xows_cli_flyyoufools(){if(Lt.size)for(const[e,o]of Lt.entries())xows_xmp_jing_terminate(e.call,o,"failed-application");xows_xmp_flyyoufools()}let rt=function(){},ct=function(){};function xows_cli_xmp_onrostpush(e,o,t,_){if(t<0){xows_log(2,"cli_rost_update","Roster update",e+' "'+o+'" subscription: '+t);let _=Jo.length;for(;_--;)if(Jo[_].bare===e){xows_log(2,"cli_rost_update","removing Contact",e),Jo.splice(_,1),ct(e);break}return}let s=xows_cli_cont_get(e);if(null!==s)s.name=o||e,s.subs=t,xows_log(2,"cli_rost_update","update Contact",e+' "'+o+'" subscription: '+t);else{let _=null;const n=xows_cach_peer_get(e);null!==n&&(o=n.name,_=n.avat),_||(_=xows_cli_avat_temp(e)),s=xows_cli_cont_new(e,o,t,_),xows_log(2,"cli_rost_update","new Contact",e+' "'+o+'" subscription: '+t)}ns.avatar_notify||xows_cli_avat_meta_query(e),xows_cli_nick_query(e),rt(s)}function xows_cli_rost_reset(){let e=Jo.length;for(;e--;){const o=Jo[e];o.ress.clear(),o.show=0,o.stat="",rt(o)}}function xows_cli_rost_get_parse(e){if(e.length)for(let o=0,t=e.length;o<t;++o)xows_cli_xmp_onrostpush(e[o].bare,e[o].name,e[o].subs,e[o].group);else rt(null)}function xows_cli_rost_get_query(){xows_xmp_rost_get_query(xows_cli_rost_get_parse)}function xows_cli_rost_edit(e,o){xows_log(2,"cli_roster_edit",(o?"add":"remove")+" contact",e),xows_xmp_rost_set_query(e,o,null,null),o&&(xows_log(2,"cli_roster_edit","request subscribe to",e),xows_xmp_presence_send(e,"subscribe"))}let at=function(){},lt=function(){};function xows_cli_xmp_onpresence(e,o,t,_,s,n){const i=xows_cli_cont_get(e);if(!i)return void(xows_jid_bare(e)!==B.bare&&xows_log(1,"cli_xmp_onpresence","unknown/unsubscribed Contact",e));i.lock=i.bare;let r=xows_jid_resc(e);if(o>0){if(i.ress.has(r))xows_log(2,"cli_xmp_onpresence","updating Resource for "+i.bare,r),i.ress.get(r).show=o,i.ress.get(r).prio=t,i.ress.get(r).stat=_;else if(xows_log(2,"cli_xmp_onpresence","adding Resource for "+i.bare,r),i.ress.set(r,{id:r,show:o,prio:t,stat:_,node:null}),s){const o=s.node+"#"+s.ver;i.ress.get(r).node=o,xows_cach_caps_has(o)||(xows_log(2,"cli_xmp_onpresence","query entity caps for "+i.bare,o),xows_xmp_disco_info_query(e,o,xows_cli_entity_caps_parse))}}else i.ress.has(r)&&(xows_log(2,"cli_xmp_onpresence","removing Resource for "+i.bare,r),i.ress.delete(r)),i.chat=0;i.show=0,i.stat=null;let c=-128;for(const e of i.ress.values())e.prio>c&&(c=e.prio,i.show=e.show,i.stat=e.stat);xows_log(2,"cli_xmp_onpresence","updated Presence for "+i.bare,"show:"+i.show+" stat:"+i.stat),n&&ns.legacy_vcard&&(xows_cach_avat_has(n)?i.avat=n:xows_cli_vcard_query(i.bare),xows_cli_nick_query(i.bare)),xows_cach_peer_save(i.bare,null,null,i.stat,null),rt(i)}function xows_cli_entity_caps_parse(e,o,t,_,s){xows_cach_caps_has(s)||(xows_log(2,"cli_entity_caps_parse","caching entity caps",s),xows_cach_caps_save(s,t))}function xows_cli_entity_caps_test(e,o){return!!xows_cach_caps_has(e)&&xows_cach_caps_get(e).includes(o)}function xows_cli_xmp_onsubscribe(e,o,t){let _;switch(o){case"subscribe":_="request";break;case"unsubscribed":_="denied";break;case"subscribed":_="allowed";break;case"unsubscribe":_="removed"}if(xows_log(2,"cli_xmp_onsubscribe","Subscription "+_+" by",e),"subscribe"===o){const o=xows_cli_cont_get(e);o?(xows_log(2,"cli_xmp_onsubscribe","request automatically allowed","Contact in Roster"),xows_cli_subscribe_allow(o.bare,!0,t)):at(xows_jid_bare(e),t)}}function xows_cli_subscribe_request(e){xows_log(2,"cli_subscribe_request","request subscribe to",e),xows_xmp_presence_send(e,"subscribe")}function xows_cli_subscribe_allow(e,o,t){if(xows_xmp_presence_send(e,o?"subscribed":"unsubscribed"),xows_log(2,"cli_subscribe_request",(o?"allow":"deny")+" subscription from",e),o&&!xows_cli_cont_get(e)){let o;if(t)o=t;else{const t=e.split("@")[0];o=t[0].toUpperCase()+t.slice(1)}xows_cli_rost_edit(e,o)}lt(e)}let ut=function(){};function xows_cli_xmp_onmessage(e){const o=e.type,t=e.from;let _;switch(o){case"chat":xows_cli_isself(t)?_=xows_cli_cont_get(e.to):(_=xows_cli_cont_get(t)).lock=t;break;case"groupchat":_=xows_cli_room_get(t);break;default:return void xows_log(1,"cli_xmp_onmessage","invalid message type",o)}_?(e.time||(e.time=(new Date).getTime()),xows_log(2,"cli_xmp_onmessage","chat message",t+' "'+e.body+'"'),ut(_,e,!1)):xows_log(1,"cli_xmp_onmessage","unknown/unsubscribed JID",t)}function xows_cli_send_message(e,o,t,_,s){let n,i,r;if(e.type===zo)n="groupchat",i=e.join,r=!0;else if(n="chat",i=Wo.bare,e.lock!==e.bare){const o=e.ress.get(xows_jid_resc(e.lock));o&&(r=xows_cli_entity_caps_test(o.node,ue))}const c=e.lock;xows_log(2,"cli_user_send_message","send "+n+" message",c+' "'+o+'"');const a=xows_xmp_message_body_send(n,c,o,r,t,_,s),l={id:a,from:i,to:c,type:n,body:o,time:(new Date).getTime(),replace:t,replyid:_,replyto:s,origid:a,stnzid:null,occuid:null};ut(e,l,r)}let dt=function(){};function xows_cli_xmp_onreceipt(e,o,t,_){let s;xows_cli_isself(o)?xows_log(2,"cli_xmp_onreceipt","receipt from other Resource ignored",o):(s=xows_cli_peer_get(o))?(xows_log(2,"cli_xmp_onreceipt","message receipt received",o+" "+_),dt(s,_)):xows_log(1,"cli_xmp_onreceipt","unknown/unsubscribed JID",o)}let xt=function(){};function xows_cli_xmp_onchatstate(e,o,t,_,s){let n;if("chat"===t){if(xows_cli_isself(o))return;n=xows_cli_cont_get(o)}else if((n=xows_cli_room_get(o)).join===o)return;if(n){if(n.type===Uo)n.chat=_,_>0&&(n.lock=o);else{const e=xows_cli_occu_get(n,o,s);if(e)if(e.chat=_,_>re)n.writ.includes(e)||n.writ.push(e);else{const o=n.writ.indexOf(e);o>=0&&n.writ.splice(o,1)}}xows_log(2,"cli_xmp_onchatstate","chat state",o+" "+_),xt(n,_)}else xows_log(1,"cli_xmp_onchatstate","unknown/unsubscribed JID",o)}let wt=null;function xows_cli_chatstate_define(e,o){const t=e.type===zo?"groupchat":"chat";o>re?(wt?clearTimeout(wt):xows_xmp_message_chatstate_send(e.lock,t,o),wt=setTimeout(xows_cli_chatstate_define,4e3,e,re)):(clearTimeout(wt),wt=null,xows_xmp_message_chatstate_send(e.lock,t,o))}let pt=function(){};function xows_cli_xmp_onretract(e,o,t,_){let s;(s="chat"===t?xows_cli_cont_get(o):xows_cli_room_get(o))?pt(s,_):xows_log(1,"cli_xmp_onretract","unknown/unsubscribed JID",o)}function xows_cli_retract_send(e,o){const t=e.type===zo?"groupchat":"chat";xows_xmp_message_retract_send(e.lock,t,o),e.type===Uo&&pt(e,o)}function xows_cli_change_profile(e,o,t){e&&(Wo.name=e,xows_log(2,"cli_change_profile","change nickname",e)),o?(xows_log(2,"cli_change_profile","change avatar"),Wo.avat=xows_cach_avat_save(o)):(xows_log(2,"cli_change_profile","set default avatar"),Wo.avat=xows_cli_avat_temp(Wo.bare)),xows_cli_vcard_publish(t),xows_cli_nick_publish(),xows_cli_avat_data_publish(t),xows_cli_presence_update(),Ko(Wo)}function xows_cli_presence_update(){let e,o,t,_;Wo.show>0?(o=Wo.show,t=Wo.stat,_=Wo.avat):e="unavailable",xows_log(2,"cli_presence_update","send updated presence"),xows_xmp_presence_send(null,e,o,t,_);let s=Yo.length;for(;s--;)Yo[s].join&&(xows_xmp_presence_send(Yo[s].join,e,o,t,_),e&&(Yo[s].join=null));Ko(Wo)}let mt=0;function xows_cli_show_select(e){Wo.show=mt=e,xows_cli_presence_update()}function xows_cli_status_define(e){Wo.stat!==e&&(Wo.stat=e,xows_cach_peer_save(Wo.bare,null,null,e,null),xows_cli_presence_update())}let gt=null;function xows_cli_activity_sleep(){gt&&clearTimeout(gt),Wo.show>be&&(gt=setTimeout(xows_cli_activity_sleep,6e5),Wo.show--,xows_cli_presence_update())}function xows_cli_activity_wakeup(){gt&&clearTimeout(gt),gt=setTimeout(xows_cli_activity_sleep,6e5),Wo.show<mt&&(Wo.show=mt,xows_cli_presence_update())}function xows_cli_activity_stop(){gt&&clearTimeout(gt),Wo.show=mt=0}function xows_cli_xmp_onpubsub(e,o,t){o===$e&&t.length&&(xows_log(2,"cli_xmp_onpubsub","received vCard notification",e),xows_cli_vcard_parse(e,t[0].data)),o===oo&&t.length&&(xows_log(2,"cli_xmp_onpubsub","received Avatar notification",e),xows_cli_avat_meta_parse(e,t[0].data)),o===Ze&&t.length&&(xows_log(2,"cli_xmp_onpubsub","received Nickname notification",e),xows_cli_nick_parse(e,t[0].data)),o===Ke&&t.length&&(xows_log(2,"cli_xmp_onpubsub","received Bookmarks notification",e),xows_cli_book_parse(e,t))}function xows_cli_vcard_publish(e){const o=xows_cach_avat_get(Wo.avat);Wo.vcrd||(Wo.vcrd=xows_xml_node("vcard"));const t=xows_cli_entity_has(Wo.bare,$e),_=Wo.vcrd;if(t&&!ns.legacy_vcard)xows_xml_edit(_,"nickname",xows_xml_node("text",null,Wo.name)),xows_xml_edit(_,"note",xows_xml_node("text",null,Wo.stat)),o&&xows_xml_edit(_,"photo",xows_xml_node("uri",null,o));else if(xows_xml_edit(_,"NICKNAME",Wo.name),xows_xml_edit(_,"DESC",Wo.stat),o){const e=xows_url_to_type(o),t=xows_url_to_data(o);xows_xml_edit(_,"PHOTO",[xows_xml_node("TYPE",null,e),xows_xml_node("BINVAL",null,t)])}xows_log(2,"cli_vcard_publish","publish own vCard");const s=[];for(let e=0,o=_.childNodes.length;e<o;++e)s.push(_.childNodes[e].cloneNode(!0));t&&!ns.legacy_vcard?xows_xmp_vcard4_publish(s,e?"open":"presence"):xows_xmp_vcardt_set_query(s)}function xows_cli_vcard_parse(e,o){let t,_,s;if(xows_log(2,"cli_vcard_handle","parse recevied vCard",e),o){let e;if(Wo.vcrd=o,xows_cli_entity_has(Wo.bare,$e)&&!ns.legacy_vcard)(e=o.querySelector("nickname"))&&(t=xows_xml_innertext(e.firstChild)),(e=o.querySelector("note"))&&(_=xows_xml_innertext(e.firstChild)),(e=o.querySelector("photo"))&&(s=xows_xml_innertext(e.firstChild));else if((e=o.querySelector("NICKNAME"))&&(t=xows_xml_innertext(e)),(e=o.querySelector("NOTE"))?_=xows_xml_innertext(e):(e=o.querySelector("DESC"))&&(_=xows_xml_innertext(e)),e=o.querySelector("PHOTO")){s="data:"+xows_xml_innertext(e.querySelector("TYPE"))+";base64,"+xows_xml_innertext(e.querySelector("BINVAL"))}t&&!t.length&&(t=null),_&&!_.length&&(_=null),s&&!s.length&&(s=null)}xows_cli_peer_update(e,t,s?xows_cach_avat_save(s):null,_)}function xows_cli_vcard_query(e){xows_log(2,"cli_vcard_query","query vCard for",e),xows_cli_entity_has(Wo.bare,$e)&&!ns.legacy_vcard?xows_xmp_vcard4_get_query(e,xows_cli_vcard_parse):xows_xmp_vcardt_get_query(e,xows_cli_vcard_parse)}function xows_cli_nick_parse(e,o){xows_log(2,"cli_nick_parse","parse received Nickname",e),xows_cli_peer_update(e,xows_xml_innertext(o),null,null)}function xows_cli_nick_query(e){xows_log(2,"cli_nick_query","query nickname",e),xows_xmp_nick_get_query(e,xows_cli_nick_parse)}function xows_cli_nick_publish(){xows_log(2,"cli_nick_publish","publish own Nickname",Wo.name),xows_xmp_nick_publish(Wo.name)}const ft=48,ht=new Map;function xows_cli_avat_meta_parse(e,o){if(o){const t=o.querySelector("info");if(t){const o=t.getAttribute("id");ht.set(o,{type:t.getAttribute("type"),width:t.getAttribute("width"),height:t.getAttribute("height"),bytes:t.getAttribute("bytes")}),xows_cach_avat_has(o)?xows_cli_avat_data_parse(e,o,null):xows_xmp_avat_data_get_query(e,o,xows_cli_avat_data_parse)}}}function xows_cli_avat_data_parse(e,o,t){let _=null;if(t){if(xows_log(2,"cli_avat_data_handle","handle received Avatar-Data",o),!ht.has(o))return;_=xows_cach_avat_save("data:"+ht.get(o).type+";base64,"+t,o),ht.delete(o)}else xows_log(2,"cli_avat_data_handle","handle cached Avatar-Data",o),_=o;xows_cli_peer_update(e,null,_,null)}function xows_cli_avat_meta_query(e){xows_log(2,"cli_avat_meta_query","query Avatar-Metadata",e),xows_xmp_avat_meta_get_query(e,xows_cli_avat_meta_parse)}let bt=null;function xows_cli_avat_data_publish(e){const o=xows_cach_avat_get(Wo.avat);if(o){const t=xows_url_to_data(o),_=xows_url_to_type(o),s=atob(t),n=xows_bytes_to_hex(xows_hash_sha1(s));bt={open:e,hash:n,type:_,bytes:s.length},xows_log(2,"cli_avat_data_publish","publish new Avatar-Data",n),xows_xmp_avat_data_publish(n,t,e?"open":"presence",xows_cli_avat_meta_publish)}}function xows_cli_avat_meta_publish(e=null,o="result"){if("result"===o&&(xows_log(2,"cli_avat_meta_publish","publish updated Avatar-Metadata"),bt)){const e=bt.open,o=bt.hash,t=bt.type,_=bt.bytes;xows_xmp_avat_meta_publish(o,t,_,ft,ft,e?"open":"presence",null)}bt=null}function xows_cli_avat_temp(e){let o;return o=e.includes("/")?xows_jid_resc(e).toLowerCase():xows_jid_node(e),xows_cach_avat_save(xows_gen_avatar(ft,null,o),null,!0)}function xows_cli_book_parse(e,o){let t,_,s,n,i;for(let e=0,r=o.length;e<r;++e){_=o[e].id,s=o[e].data.getAttribute("name"),n=o[e].data.getAttribute("autojoin");const r=o[e].data.querySelector("nick");if(r&&(i=xows_xml_innertext(r)),t=xows_cli_room_get(_)){if(t.publ)return}else t=xows_cli_room_new(_,s,"",!1,!1);t.book=!0,n&&xows_cli_muc_join(t),xows_cli_discoinfo_query(t.bare)}}function xows_cli_book_publish(e,o,t,_){const s=t||e.name,n=_||xows_jid_resc(e.join);xows_log(2,"cli_book_publish","add bookmark",s+" ("+e.bare+")"),xows_xmp_bookmark_publish(e.bare,s,o,n)}let Ft=32;const yt=new Map;function xows_cli_mam_collect(e,o,t,_,s){const n=xows_cli_peer_get(e||o);if(!n)return void xows_log(1,"cli_mam_collect","unknown/unsubscribed JID",e||o);const i=[];let r=t.length;for(;r--;)t[r].retract&&i.push(t[r].retract);if(r=t.length,n.type===Uo)for(;r--;)i.includes(t[r].origid)&&(t[r].body=null);else for(;r--;)i.includes(t[r].stnzid)&&(t[r].body=null);const c=yt.get(n);c.start?c.pool=c.pool.concat(t):c.pool=t.concat(c.pool);const a=c.pool;let l=0;for(r=a.length;r--;)a[r].body&&!a[r].replace&&l++;if(!s&&l<c.count){c.start?c.start=a[a.length-1].time+1:c.end=a[0].time-1;const e=2*(c.count-l);return e<Ft&&(c.max=e),void setTimeout(xows_cli_mam_request,100,n)}xows_log(2,"cli_mam_collect",l+" gathered messages for",n.bare),xows_isfunc(c.onresult)&&c.onresult(n,a,l,s),yt.delete(n)}function xows_cli_mam_request(e){if(!yt.has(e))return;const o=yt.get(e);e.type===Uo?xows_xmp_mam_query(null,o.max,e.bare,o.start,o.end,null,xows_cli_mam_collect):xows_xmp_mam_query(e.bare,o.max,null,o.start,o.end,null,xows_cli_mam_collect)}function xows_cli_mam_fetch(e,o,t,_,s){if(yt.has(e))return;xows_log(2,"cli_mam_fetch","fetch history for",e.bare);const n=o>Ft?Ft:o;yt.set(e,{peer:e,count:o,max:n,start:t,end:_,onresult:s,pool:new Array}),xows_cli_mam_request(e)}const vt=new Map;function xows_cli_upld_abort(e){xows_log(2,"cli_upld_abort","abort requested",e);const o=vt.get(e);o.xhr&&o.xhr.abort(),vt.delete(e)}function xows_cli_upld_put_progress(e){const o=e.target._name,t=vt.get(o);xows_isfunc(t.onprogress)&&t.onprogress(o,e.loaded/e.total*100)}function xows_cli_upld_put_error(e){const o=e.target._name,t="HTTP PUT failed";xows_log(1,"cli_upld_put_error",t,o);const _=vt.get(o);xows_isfunc(_.onerror)&&_.onerror(o,t),vt.delete(o)}function xows_cli_upld_put_abort(e){const o=e.target._name;xows_log(1,"cli_upld_put_abort","HTTP PUT aborted by user",o);const t=vt.get(o);xows_isfunc(t.onabort)&&t.onabort(o),vt.delete(o)}function xows_cli_upld_xhr_state(e){if(4===e.readyState){if(201!==e.status)return void xows_log(1,"cli_upld_xhr_state","server responded",e.status);const o=e.upload._name,t=vt.get(o);xows_isfunc(t.onload)&&setTimeout(t.onload,500,o,t.url),vt.delete(o)}}function xows_cli_upld_result(e,o,t,_,s){const n=vt.get(e);if(!o){const o="upload denied: "+s;return xows_log(1,"cli_upld_result",o,e),xows_isfunc(n.onerror)&&n.onerror(e,o),void vt.delete(e)}n.url=_;const i=new XMLHttpRequest;n.xhr=i,i.open("PUT",o,!0),i.setRequestHeader("Content-Type","main_menucation/octet-stream");for(let e=0;e<t.length;++e)i.setRequestHeader(t[e].getAttribute("name"),t[e].innerHTML);xows_log(2,"cli_upld_result","sending HTTP PUT request",o),i.upload._name=e,i.upload.onprogress=xows_cli_upld_put_progress,i.upload.onerror=xows_cli_upld_put_error,i.upload.onabort=xows_cli_upld_put_abort,i.onreadystatechange=function(){xows_cli_upld_xhr_state(this)},i.send(n.file)}function xows_cli_upld_query(e,o,t,s,n){if(!vt.has(e.name)){if(!Ro.has(io)){const e="HTTP File Upload (XEP-0363) service is unavailable";return xows_log(1,"cli_upld_query",e),void $o(_,e)}xows_log(2,"cli_upld_query","HTTP-Upload query",e.name),vt.set(e.name,{file:e,onerror:o,onload:t,onprogress:s,onabort:n}),xows_xmp_upld_query(Ro.get(io)[0],e.name,e.size,e.type,xows_cli_upld_result)}}let kt=function(){},At=function(){},qt=function(){},Et=function(){},Ct=function(){};function xows_cli_muc_discoitems_query(){if(!Ro.has(co))return void xows_log(1,"cli_muc_discoitems_query","aborted","no MUC service available");const e=Ro.get(co);for(let o=0,t=e.length;o<t;++o)xows_xmp_disco_items_query(e[o],xows_cli_discoitems_parse)}function xows_cli_muc_discoinfo_parse(e,o,t,_){let s,n,i,r="",c="",a=!1,l=!1;for(i=o.length?o[0].name:e.split("@")[0],s=0,n=t.length;s<n;++s)"muc_passwordprotected"===t[s]&&(a=!0),"muc_public"===t[s]&&(l=!0),"muc_hidden"===t[s]&&(l=!1);if(_)for(s=0,n=_.length;s<n;++s)"muc#roominfo_description"==_[s].var&&(c=_[s].value),"muc#roominfo_subject"==_[s].var&&(r=_[s].value);let u=xows_cli_room_get(e);u?(u.name=i,u.desc=c,u.prot=a,u.publ=l,xows_log(2,"cli_muc_room_parse","refresh Room",i+" ("+e+') :"'+c+'"')):(u=xows_cli_room_new(e,i,c,a,l),xows_log(2,"cli_muc_room_parse","adding Room",i+" ("+e+') :"'+c+'"')),kt(u)}const St=new Map;function xows_cli_muc_getcfg_result(e,o){const t=xows_cli_room_get(e);if(!t)return void xows_log(1,"cli_muc_cfg_get_parse","unknown/unsubscribed Room",e);const _=St.get(t);xows_isfunc(_)&&_(t,o),St.delete(t)}function xows_cli_muc_getcfg_query(e,o){St.has(e)||(St.set(e,o),xows_xmp_muc_cfg_get_guery(e.bare,xows_cli_muc_getcfg_result))}function xows_cli_muc_setcfg_result(e,o){if("result"!==o)return;const t=xows_cli_room_get(e);if(!t)return void xows_log(1,"cli_muc_cfg_set_parse","unknown/unsubscribed Room",e);xows_cli_discoinfo_query(t.bare);const _=St.get(t);xows_isfunc(_)&&_(t,o),t.init=!1,St.delete(t)}function xows_cli_muc_setcfg_cancel(e,o){xows_xmp_muc_cfg_set_cancel(e.bare,o)}function xows_cli_muc_setcfg_query(e,o,t){St.has(e)||(St.set(e,t),xows_xmp_muc_cfg_set_query(e.bare,o,xows_cli_muc_setcfg_result))}function xows_cli_muc_register_result(e,o,t,_,s,n){if(xows_cli_room_get(e)){if(!o&&n){for(let e=0,o=n.length;e<o;++e)"muc#register_roomnick"===n[e].var&&(n[e].value=Wo.name);xows_xmp_regi_set_query(e,null,null,null,n,null)}}else xows_log(1,"cli_muc_register_parse","unknown/unsubscribed Room",e)}function xows_cli_muc_register_query(e){xows_xmp_regi_get_query(e.bare,xows_cli_muc_register_result)}function xows_cli_muc_join(e,o,t,_){if(!Ro.has(co))return void xows_log(1,"cli_muc_join","aborted","no MUC service available");let s;if(e){if(e.join)return;s=e.bare}else s=o.toLowerCase()+"@"+Ro.get(co)[0];xows_log(2,"cli_muc_join","request join",s),xows_xmp_presence_send(s+"/"+(t||Wo.name),null,Wo.show,Wo.stat,Wo.avat,!0)}function xows_cli_xmp_onoccupant(e,o,t,_,s,n){let i=xows_cli_room_get(e);i||(i=xows_cli_room_new(xows_jid_bare(e),xows_jid_node(e),"",!1,!1),kt(i),xows_cli_discoinfo_query(i.bare));for(let t=0;t<_.code.length;++t)switch(_.code[t]){case 110:if(!(o>0))return i.join=null,xows_log(2,"cli_xmp_onoccupant","leaving Room",i.bare),void Et(i,null);i.join=e,xows_log(2,"cli_xmp_onoccupant","Joined Room as",e);continue;case 201:i.init=!0;continue;case 210:continue}if(0===o){let o=i.occu.length;for(;o--;)if(i.occu[o].jid===e){i.occu.splice(o,1);break}return void Et(i,e)}const r=_.jid,c=r?xows_jid_bare(r):null,a=_.nickname?_.nickname:xows_jid_resc(e);let l=xows_cli_occu_get(i,e,s);l?(xows_log(2,"cli_xmp_onoccupant","refresh Occupant",e),l.name=a,l.full=_.jid,l.bare=c):(xows_log(2,"cli_xmp_onoccupant","adding Occupant",e),l=xows_cli_occu_new(i,e,s,r,null,a)),l.show=o,l.stat=t,l.affi=_.affiliation,l.role=_.role,l.self&&(i.affi=_.affiliation,i.role=_.role),n&&ns.legacy_vcard?xows_cach_avat_has(n)?l.avat=n:xows_cli_vcard_query(e):l.avat||xows_cli_avat_meta_query(e),xows_cach_peer_save(l.uid,l.name,l.avat,null,null),qt(i,l,_.code)}function xows_cli_xmp_onsubject(e,o,t){const _=xows_cli_room_get(o);_?(_.subj=t,Ct(_,t)):xows_log(1,"cli_xmp_onsubject","unknown/unsubscribed JID",o)}function xows_cli_muc_set_subject(e,o){xows_log(2,"cli_send_subject","send subject",e.bare+' "'+o+'"'),xows_xmp_muc_subject_send(e.bare,o)}let Tt=function(){},Dt=function(){},Nt=function(){},jt=function(){};const Lt=new Map;function xows_cli_xmp_onjingle(e,o,t,_,s){const n=xows_cli_peer_get(e);if(!n)return xows_log(1,"cli_xmp_onjingle","refused "+_,"from unknow peer: "+e),void xows_xmp_iq_error_send(o,e,"cancel","service-unavailable");switch(xows_log(2,"cli_xmp_onjingle",_,e),_){case"session-initiate":n.call=e,Lt.set(n,t),Dt(n,t,s);break;case"session-accept":Nt(n,t,s);break;case"session-terminate":n.call=null,Lt.delete(n),jt(n,t,s)}}function xows_cli_jing_result(e,o){e<=n&&(xows_log(1,"cli_jing_result","jingle query error",o),Tt(n,o))}function xows_cli_jing_initiate_sdp(e,o){if(Lt.has(e))return;e.call=xows_cli_cont_best_jid(e);const t=xows_xmp_jing_initiate_sdp(e.call,o,xows_cli_jing_result);Lt.set(e,t)}function xows_cli_jing_accept_sdp(e,o){if(!Lt.has(e))return;const t=Lt.get(e);xows_xmp_jing_accept_sdp(e.call,t,o,xows_cli_jing_result)}function xows_cli_jing_terminate(e,o){if(!Lt.has(e))return;const t=Lt.get(e);xows_xmp_jing_terminate(e.call,t,o),e.call=null,Lt.delete(e)}const Bt=new DOMParser;let Pt=function(){},Mt=0,It=[],Ot=null,Rt="dark";const Gt={100:"1F4AF",1234:"1F522",grinning:"1F600",smiley:"1F603",smile:"1F604",grin:"1F601",laughing:"1F606",sweat_smile:"1F605",rolling_on_the_floor_laughing:"1F923",joy:"1F602",slightly_smiling_face:"1F642",upside_down_face:"1F643",wink:"1F609",blush:"1F60A",innocent:"1F607",smiling_face_with_3_hearts:"1F970",heart_eyes:"1F60D","star-struck":"1F929",kissing_heart:"1F618",kissing:"1F617",kissing_closed_eyes:"1F61A",kissing_smiling_eyes:"1F619",yum:"1F60B",stuck_out_tongue:"1F61B",stuck_out_tongue_winking_eye:"1F61C",zany_face:"1F92A",stuck_out_tongue_closed_eyes:"1F61D",money_mouth_face:"1F911",hugging_face:"1F917",face_with_hand_over_mouth:"1F92D",shushing_face:"1F92B",thinking_face:"1F914",zipper_mouth_face:"1F910",face_with_raised_eyebrow:"1F928",neutral_face:"1F610",expressionless:"1F611",no_mouth:"1F636",smirk:"1F60F",unamused:"1F612",face_with_rolling_eyes:"1F644",grimacing:"1F62C",lying_face:"1F925",relieved:"1F60C",pensive:"1F614",sleepy:"1F62A",drooling_face:"1F924",sleeping:"1F634",mask:"1F637",face_with_thermometer:"1F912",face_with_head_bandage:"1F915",nauseated_face:"1F922",face_vomiting:"1F92E",sneezing_face:"1F927",hot_face:"1F975",cold_face:"1F976",woozy_face:"1F974",dizzy_face:"1F635",exploding_head:"1F92F",face_with_cowboy_hat:"1F920",partying_face:"1F973",sunglasses:"1F60E",nerd_face:"1F913",face_with_monocle:"1F9D0",confused:"1F615",worried:"1F61F",slightly_frowning_face:"1F641",open_mouth:"1F62E",hushed:"1F62F",astonished:"1F632",flushed:"1F633",pleading_face:"1F97A",frowning:"1F626",anguished:"1F627",fearful:"1F628",cold_sweat:"1F630",disappointed_relieved:"1F625",cry:"1F622",sob:"1F62D",scream:"1F631",confounded:"1F616",persevere:"1F623",disappointed:"1F61E",sweat:"1F613",weary:"1F629",tired_face:"1F62B",yawning_face:"1F971",triumph:"1F624",rage:"1F621",angry:"1F620",face_with_symbols_on_mouth:"1F92C",smiling_imp:"1F608",imp:"1F47F",skull:"1F480",hankey:"1F4A9",clown_face:"1F921",japanese_ogre:"1F479",japanese_goblin:"1F47A",ghost:"1F47B",alien:"1F47D",space_invader:"1F47E",robot_face:"1F916",smiley_cat:"1F63A",smile_cat:"1F638",joy_cat:"1F639",heart_eyes_cat:"1F63B",smirk_cat:"1F63C",kissing_cat:"1F63D",scream_cat:"1F640",crying_cat_face:"1F63F",pouting_cat:"1F63E",see_no_evil:"1F648",hear_no_evil:"1F649",speak_no_evil:"1F64A",kiss:"1F48B",love_letter:"1F48C",cupid:"1F498",gift_heart:"1F49D",sparkling_heart:"1F496",heartpulse:"1F497",heartbeat:"1F493",revolving_hearts:"1F49E",two_hearts:"1F495",heart_decoration:"1F49F",broken_heart:"1F494",orange_heart:"1F9E1",yellow_heart:"1F49B",green_heart:"1F49A",blue_heart:"1F499",purple_heart:"1F49C",brown_heart:"1F90E",black_heart:"1F5A4",white_heart:"1F90D",anger:"1F4A2",boom:"1F4A5",dizzy:"1F4AB",sweat_drops:"1F4A6",dash:"1F4A8",bomb:"1F4A3",speech_balloon:"1F4AC",thought_balloon:"1F4AD",zzz:"1F4A4",wave:"1F44B",raised_back_of_hand:"1F91A",hand:"270B","spock-hand":"1F596",ok_hand:"1F44C",pinching_hand:"1F90F",crossed_fingers:"1F91E",i_love_you_hand_sign:"1F91F",the_horns:"1F918",call_me_hand:"1F919",point_left:"1F448",point_right:"1F449",point_up_2:"1F446",middle_finger:"1F595",point_down:"1F447","+1":"1F44D","-1":"1F44E",fist:"270A",facepunch:"1F44A","left-facing_fist":"1F91B","right-facing_fist":"1F91C",clap:"1F44F",raised_hands:"1F64C",open_hands:"1F450",palms_up_together:"1F932",handshake:"1F91D",pray:"1F64F",nail_care:"1F485",selfie:"1F933",muscle:"1F4AA",mechanical_arm:"1F9BE",mechanical_leg:"1F9BF",leg:"1F9B5",foot:"1F9B6",ear:"1F442",ear_with_hearing_aid:"1F9BB",nose:"1F443",brain:"1F9E0",tooth:"1F9B7",bone:"1F9B4",eyes:"1F440",tongue:"1F445",lips:"1F444",baby:"1F476",child:"1F9D2",boy:"1F466",girl:"1F467",adult:"1F9D1",person_with_blond_hair:"1F471",man:"1F468",bearded_person:"1F9D4",woman:"1F469",older_adult:"1F9D3",older_man:"1F474",older_woman:"1F475",person_frowning:"1F64D",person_with_pouting_face:"1F64E",no_good:"1F645",ok_woman:"1F646",information_desk_person:"1F481",raising_hand:"1F64B",deaf_person:"1F9CF",bow:"1F647",face_palm:"1F926",shrug:"1F937",cop:"1F46E",guardsman:"1F482",construction_worker:"1F477",prince:"1F934",princess:"1F478",man_with_turban:"1F473",man_with_gua_pi_mao:"1F472",person_with_headscarf:"1F9D5",man_in_tuxedo:"1F935",bride_with_veil:"1F470",pregnant_woman:"1F930","breast-feeding":"1F931",angel:"1F47C",santa:"1F385",mrs_claus:"1F936",superhero:"1F9B8",supervillain:"1F9B9",mage:"1F9D9",fairy:"1F9DA",vampire:"1F9DB",merperson:"1F9DC",elf:"1F9DD",genie:"1F9DE",zombie:"1F9DF",massage:"1F486",haircut:"1F487",walking:"1F6B6",standing_person:"1F9CD",kneeling_person:"1F9CE",runner:"1F3C3",dancer:"1F483",man_dancing:"1F57A",dancers:"1F46F",person_in_steamy_room:"1F9D6",person_climbing:"1F9D7",fencer:"1F93A",horse_racing:"1F3C7",snowboarder:"1F3C2",surfer:"1F3C4",rowboat:"1F6A3",swimmer:"1F3CA",bicyclist:"1F6B4",mountain_bicyclist:"1F6B5",person_doing_cartwheel:"1F938",wrestlers:"1F93C",water_polo:"1F93D",handball:"1F93E",juggling:"1F939",person_in_lotus_position:"1F9D8",bath:"1F6C0",sleeping_accommodation:"1F6CC",two_women_holding_hands:"1F46D",couple:"1F46B",two_men_holding_hands:"1F46C",couplekiss:"1F48F",couple_with_heart:"1F491",family:"1F46A",bust_in_silhouette:"1F464",busts_in_silhouette:"1F465",footprints:"1F463",monkey_face:"1F435",monkey:"1F412",gorilla:"1F98D",orangutan:"1F9A7",dog:"1F436",dog2:"1F415",guide_dog:"1F9AE",poodle:"1F429",wolf:"1F43A",fox_face:"1F98A",raccoon:"1F99D",cat:"1F431",cat2:"1F408",lion_face:"1F981",tiger:"1F42F",tiger2:"1F405",leopard:"1F406",horse:"1F434",racehorse:"1F40E",unicorn_face:"1F984",zebra_face:"1F993",deer:"1F98C",cow:"1F42E",ox:"1F402",water_buffalo:"1F403",cow2:"1F404",pig:"1F437",pig2:"1F416",boar:"1F417",pig_nose:"1F43D",ram:"1F40F",sheep:"1F411",goat:"1F410",dromedary_camel:"1F42A",camel:"1F42B",llama:"1F999",giraffe_face:"1F992",elephant:"1F418",rhinoceros:"1F98F",hippopotamus:"1F99B",mouse:"1F42D",mouse2:"1F401",rat:"1F400",hamster:"1F439",rabbit:"1F430",rabbit2:"1F407",hedgehog:"1F994",bat:"1F987",bear:"1F43B",koala:"1F428",panda_face:"1F43C",sloth:"1F9A5",otter:"1F9A6",skunk:"1F9A8",kangaroo:"1F998",badger:"1F9A1",feet:"1F43E",turkey:"1F983",chicken:"1F414",rooster:"1F413",hatching_chick:"1F423",baby_chick:"1F424",hatched_chick:"1F425",bird:"1F426",penguin:"1F427",eagle:"1F985",duck:"1F986",swan:"1F9A2",owl:"1F989",flamingo:"1F9A9",peacock:"1F99A",parrot:"1F99C",frog:"1F438",crocodile:"1F40A",turtle:"1F422",lizard:"1F98E",snake:"1F40D",dragon_face:"1F432",dragon:"1F409",sauropod:"1F995","t-rex":"1F996",whale:"1F433",whale2:"1F40B",dolphin:"1F42C",fish:"1F41F",tropical_fish:"1F420",blowfish:"1F421",shark:"1F988",octopus:"1F419",shell:"1F41A",snail:"1F40C",butterfly:"1F98B",bug:"1F41B",ant:"1F41C",bee:"1F41D",beetle:"1F41E",cricket:"1F997",scorpion:"1F982",mosquito:"1F99F",microbe:"1F9A0",bouquet:"1F490",cherry_blossom:"1F338",white_flower:"1F4AE",rose:"1F339",wilted_flower:"1F940",hibiscus:"1F33A",sunflower:"1F33B",blossom:"1F33C",tulip:"1F337",seedling:"1F331",evergreen_tree:"1F332",deciduous_tree:"1F333",palm_tree:"1F334",cactus:"1F335",ear_of_rice:"1F33E",herb:"1F33F",four_leaf_clover:"1F340",maple_leaf:"1F341",fallen_leaf:"1F342",leaves:"1F343",grapes:"1F347",melon:"1F348",watermelon:"1F349",tangerine:"1F34A",lemon:"1F34B",banana:"1F34C",pineapple:"1F34D",mango:"1F96D",apple:"1F34E",green_apple:"1F34F",pear:"1F350",peach:"1F351",cherries:"1F352",strawberry:"1F353",kiwifruit:"1F95D",tomato:"1F345",coconut:"1F965",avocado:"1F951",eggplant:"1F346",potato:"1F954",carrot:"1F955",corn:"1F33D",cucumber:"1F952",leafy_green:"1F96C",broccoli:"1F966",garlic:"1F9C4",onion:"1F9C5",mushroom:"1F344",peanuts:"1F95C",chestnut:"1F330",bread:"1F35E",croissant:"1F950",baguette_bread:"1F956",pretzel:"1F968",bagel:"1F96F",pancakes:"1F95E",waffle:"1F9C7",cheese_wedge:"1F9C0",meat_on_bone:"1F356",poultry_leg:"1F357",cut_of_meat:"1F969",bacon:"1F953",hamburger:"1F354",fries:"1F35F",pizza:"1F355",hotdog:"1F32D",sandwich:"1F96A",taco:"1F32E",burrito:"1F32F",stuffed_flatbread:"1F959",falafel:"1F9C6",egg:"1F95A",fried_egg:"1F373",shallow_pan_of_food:"1F958",stew:"1F372",bowl_with_spoon:"1F963",green_salad:"1F957",popcorn:"1F37F",butter:"1F9C8",salt:"1F9C2",canned_food:"1F96B",bento:"1F371",rice_cracker:"1F358",rice_ball:"1F359",rice:"1F35A",curry:"1F35B",ramen:"1F35C",spaghetti:"1F35D",sweet_potato:"1F360",oden:"1F362",sushi:"1F363",fried_shrimp:"1F364",fish_cake:"1F365",moon_cake:"1F96E",dango:"1F361",dumpling:"1F95F",fortune_cookie:"1F960",takeout_box:"1F961",crab:"1F980",lobster:"1F99E",shrimp:"1F990",squid:"1F991",oyster:"1F9AA",icecream:"1F366",shaved_ice:"1F367",ice_cream:"1F368",doughnut:"1F369",cookie:"1F36A",birthday:"1F382",cake:"1F370",cupcake:"1F9C1",pie:"1F967",chocolate_bar:"1F36B",candy:"1F36C",lollipop:"1F36D",custard:"1F36E",honey_pot:"1F36F",baby_bottle:"1F37C",glass_of_milk:"1F95B",coffee:"2615",tea:"1F375",sake:"1F376",champagne:"1F37E",wine_glass:"1F377",cocktail:"1F378",tropical_drink:"1F379",beer:"1F37A",beers:"1F37B",clinking_glasses:"1F942",tumbler_glass:"1F943",cup_with_straw:"1F964",beverage_box:"1F9C3",mate_drink:"1F9C9",ice_cube:"1F9CA",chopsticks:"1F962",fork_and_knife:"1F374",spoon:"1F944",hocho:"1F52A",amphora:"1F3FA",eyeglasses:"1F453",goggles:"1F97D",lab_coat:"1F97C",safety_vest:"1F9BA",necktie:"1F454",shirt:"1F455",jeans:"1F456",scarf:"1F9E3",gloves:"1F9E4",coat:"1F9E5",socks:"1F9E6",dress:"1F457",kimono:"1F458",sari:"1F97B","one-piece_swimsuit":"1FA71",briefs:"1FA72",shorts:"1FA73",bikini:"1F459",womans_clothes:"1F45A",purse:"1F45B",handbag:"1F45C",pouch:"1F45D",school_satchel:"1F392",mans_shoe:"1F45E",athletic_shoe:"1F45F",hiking_boot:"1F97E",womans_flat_shoe:"1F97F",high_heel:"1F460",sandal:"1F461",ballet_shoes:"1FA70",boot:"1F462",crown:"1F451",womans_hat:"1F452",tophat:"1F3A9",mortar_board:"1F393",billed_cap:"1F9E2",prayer_beads:"1F4FF",lipstick:"1F484",ring:"1F48D",gem:"1F48E",mute:"1F507",speaker:"1F508",sound:"1F509",loud_sound:"1F50A",loudspeaker:"1F4E2",mega:"1F4E3",postal_horn:"1F4EF",bell:"1F514",no_bell:"1F515",musical_score:"1F3BC",musical_note:"1F3B5",notes:"1F3B6",microphone:"1F3A4",headphones:"1F3A7",radio:"1F4FB",saxophone:"1F3B7",guitar:"1F3B8",musical_keyboard:"1F3B9",trumpet:"1F3BA",violin:"1F3BB",banjo:"1FA95",drum_with_drumsticks:"1F941",iphone:"1F4F1",calling:"1F4F2",telephone_receiver:"1F4DE",pager:"1F4DF",fax:"1F4E0",battery:"1F50B",electric_plug:"1F50C",computer:"1F4BB",minidisc:"1F4BD",floppy_disk:"1F4BE",cd:"1F4BF",dvd:"1F4C0",abacus:"1F9EE",movie_camera:"1F3A5",clapper:"1F3AC",tv:"1F4FA",camera:"1F4F7",camera_with_flash:"1F4F8",video_camera:"1F4F9",vhs:"1F4FC",mag:"1F50D",mag_right:"1F50E",bulb:"1F4A1",flashlight:"1F526",izakaya_lantern:"1F3EE",diya_lamp:"1FA94",notebook_with_decorative_cover:"1F4D4",closed_book:"1F4D5",book:"1F4D6",green_book:"1F4D7",blue_book:"1F4D8",orange_book:"1F4D9",books:"1F4DA",notebook:"1F4D3",ledger:"1F4D2",page_with_curl:"1F4C3",scroll:"1F4DC",page_facing_up:"1F4C4",newspaper:"1F4F0",bookmark_tabs:"1F4D1",bookmark:"1F516",moneybag:"1F4B0",yen:"1F4B4",dollar:"1F4B5",euro:"1F4B6",pound:"1F4B7",money_with_wings:"1F4B8",credit_card:"1F4B3",receipt:"1F9FE",chart:"1F4B9",currency_exchange:"1F4B1",heavy_dollar_sign:"1F4B2","e-mail":"1F4E7",incoming_envelope:"1F4E8",envelope_with_arrow:"1F4E9",outbox_tray:"1F4E4",inbox_tray:"1F4E5",package:"1F4E6",mailbox:"1F4EB",mailbox_closed:"1F4EA",mailbox_with_mail:"1F4EC",mailbox_with_no_mail:"1F4ED",postbox:"1F4EE",memo:"1F4DD",briefcase:"1F4BC",file_folder:"1F4C1",open_file_folder:"1F4C2",date:"1F4C5",calendar:"1F4C6",card_index:"1F4C7",chart_with_upwards_trend:"1F4C8",chart_with_downwards_trend:"1F4C9",bar_chart:"1F4CA",clipboard:"1F4CB",pushpin:"1F4CC",round_pushpin:"1F4CD",paperclip:"1F4CE",straight_ruler:"1F4CF",triangular_ruler:"1F4D0",lock:"1F512",unlock:"1F513",lock_with_ink_pen:"1F50F",closed_lock_with_key:"1F510",key:"1F511",hammer:"1F528",axe:"1FA93",gun:"1F52B",bow_and_arrow:"1F3F9",wrench:"1F527",nut_and_bolt:"1F529",probing_cane:"1F9AF",link:"1F517",toolbox:"1F9F0",magnet:"1F9F2",test_tube:"1F9EA",petri_dish:"1F9EB",dna:"1F9EC",microscope:"1F52C",telescope:"1F52D",satellite_antenna:"1F4E1",syringe:"1F489",drop_of_blood:"1FA78",pill:"1F48A",adhesive_bandage:"1FA79",stethoscope:"1FA7A",door:"1F6AA",chair:"1FA91",toilet:"1F6BD",shower:"1F6BF",bathtub:"1F6C1",razor:"1FA92",lotion_bottle:"1F9F4",safety_pin:"1F9F7",broom:"1F9F9",basket:"1F9FA",roll_of_paper:"1F9FB",soap:"1F9FC",sponge:"1F9FD",fire_extinguisher:"1F9EF",shopping_trolley:"1F6D2",smoking:"1F6AC",moyai:"1F5FF",earth_africa:"1F30D",earth_americas:"1F30E",earth_asia:"1F30F",globe_with_meridians:"1F310",japan:"1F5FE",compass:"1F9ED",volcano:"1F30B",mount_fuji:"1F5FB",bricks:"1F9F1",house:"1F3E0",house_with_garden:"1F3E1",office:"1F3E2",post_office:"1F3E3",european_post_office:"1F3E4",hospital:"1F3E5",bank:"1F3E6",hotel:"1F3E8",love_hotel:"1F3E9",convenience_store:"1F3EA",school:"1F3EB",department_store:"1F3EC",factory:"1F3ED",japanese_castle:"1F3EF",european_castle:"1F3F0",wedding:"1F492",tokyo_tower:"1F5FC",statue_of_liberty:"1F5FD",church:"26EA",mosque:"1F54C",hindu_temple:"1F6D5",synagogue:"1F54D",kaaba:"1F54B",fountain:"26F2",tent:"26FA",foggy:"1F301",night_with_stars:"1F303",sunrise_over_mountains:"1F304",sunrise:"1F305",city_sunset:"1F306",city_sunrise:"1F307",bridge_at_night:"1F309",carousel_horse:"1F3A0",ferris_wheel:"1F3A1",roller_coaster:"1F3A2",barber:"1F488",circus_tent:"1F3AA",steam_locomotive:"1F682",railway_car:"1F683",bullettrain_side:"1F684",bullettrain_front:"1F685",train2:"1F686",metro:"1F687",light_rail:"1F688",station:"1F689",tram:"1F68A",monorail:"1F69D",mountain_railway:"1F69E",train:"1F68B",bus:"1F68C",oncoming_bus:"1F68D",trolleybus:"1F68E",minibus:"1F690",ambulance:"1F691",fire_engine:"1F692",police_car:"1F693",oncoming_police_car:"1F694",taxi:"1F695",oncoming_taxi:"1F696",car:"1F697",oncoming_automobile:"1F698",blue_car:"1F699",truck:"1F69A",articulated_lorry:"1F69B",tractor:"1F69C",motor_scooter:"1F6F5",manual_wheelchair:"1F9BD",motorized_wheelchair:"1F9BC",auto_rickshaw:"1F6FA",bike:"1F6B2",scooter:"1F6F4",skateboard:"1F6F9",busstop:"1F68F",fuelpump:"26FD",rotating_light:"1F6A8",traffic_light:"1F6A5",vertical_traffic_light:"1F6A6",octagonal_sign:"1F6D1",construction:"1F6A7",anchor:"2693",boat:"26F5",canoe:"1F6F6",speedboat:"1F6A4",ship:"1F6A2",airplane_departure:"1F6EB",airplane_arriving:"1F6EC",parachute:"1FA82",seat:"1F4BA",helicopter:"1F681",suspension_railway:"1F69F",mountain_cableway:"1F6A0",aerial_tramway:"1F6A1",rocket:"1F680",flying_saucer:"1F6F8",luggage:"1F9F3",hourglass:"231B",hourglass_flowing_sand:"23F3",watch:"231A",alarm_clock:"23F0",clock12:"1F55B",clock1230:"1F567",clock1:"1F550",clock130:"1F55C",clock2:"1F551",clock230:"1F55D",clock3:"1F552",clock330:"1F55E",clock4:"1F553",clock430:"1F55F",clock5:"1F554",clock530:"1F560",clock6:"1F555",clock630:"1F561",clock7:"1F556",clock730:"1F562",clock8:"1F557",clock830:"1F563",clock9:"1F558",clock930:"1F564",clock10:"1F559",clock1030:"1F565",clock11:"1F55A",clock1130:"1F566",new_moon:"1F311",waxing_crescent_moon:"1F312",first_quarter_moon:"1F313",moon:"1F314",full_moon:"1F315",waning_gibbous_moon:"1F316",last_quarter_moon:"1F317",waning_crescent_moon:"1F318",crescent_moon:"1F319",new_moon_with_face:"1F31A",first_quarter_moon_with_face:"1F31B",last_quarter_moon_with_face:"1F31C",full_moon_with_face:"1F31D",sun_with_face:"1F31E",ringed_planet:"1FA90",star:"2B50",star2:"1F31F",stars:"1F320",milky_way:"1F30C",partly_sunny:"26C5",cyclone:"1F300",rainbow:"1F308",closed_umbrella:"1F302",umbrella_with_rain_drops:"2614",zap:"26A1",snowman_without_snow:"26C4",fire:"1F525",droplet:"1F4A7",ocean:"1F30A",jack_o_lantern:"1F383",christmas_tree:"1F384",fireworks:"1F386",sparkler:"1F387",firecracker:"1F9E8",sparkles:"2728",balloon:"1F388",tada:"1F389",confetti_ball:"1F38A",tanabata_tree:"1F38B",bamboo:"1F38D",dolls:"1F38E",flags:"1F38F",wind_chime:"1F390",rice_scene:"1F391",red_envelope:"1F9E7",ribbon:"1F380",gift:"1F381",ticket:"1F3AB",trophy:"1F3C6",sports_medal:"1F3C5",first_place_medal:"1F947",second_place_medal:"1F948",third_place_medal:"1F949",soccer:"26BD",baseball:"26BE",softball:"1F94E",basketball:"1F3C0",volleyball:"1F3D0",football:"1F3C8",rugby_football:"1F3C9",tennis:"1F3BE",flying_disc:"1F94F",bowling:"1F3B3",cricket_bat_and_ball:"1F3CF",field_hockey_stick_and_ball:"1F3D1",ice_hockey_stick_and_puck:"1F3D2",lacrosse:"1F94D",table_tennis_paddle_and_ball:"1F3D3",badminton_racquet_and_shuttlecock:"1F3F8",boxing_glove:"1F94A",martial_arts_uniform:"1F94B",goal_net:"1F945",golf:"26F3",fishing_pole_and_fish:"1F3A3",diving_mask:"1F93F",running_shirt_with_sash:"1F3BD",ski:"1F3BF",sled:"1F6F7",curling_stone:"1F94C",dart:"1F3AF","yo-yo":"1FA80",kite:"1FA81","8ball":"1F3B1",crystal_ball:"1F52E",nazar_amulet:"1F9FF",video_game:"1F3AE",slot_machine:"1F3B0",game_die:"1F3B2",jigsaw:"1F9E9",teddy_bear:"1F9F8",black_joker:"1F0CF",mahjong:"1F004",flower_playing_cards:"1F3B4",performing_arts:"1F3AD",art:"1F3A8",thread:"1F9F5",yarn:"1F9F6",atm:"1F3E7",put_litter_in_its_place:"1F6AE",potable_water:"1F6B0",wheelchair:"267F",mens:"1F6B9",womens:"1F6BA",restroom:"1F6BB",baby_symbol:"1F6BC",wc:"1F6BE",passport_control:"1F6C2",customs:"1F6C3",baggage_claim:"1F6C4",left_luggage:"1F6C5",children_crossing:"1F6B8",no_entry:"26D4",no_entry_sign:"1F6AB",no_bicycles:"1F6B3",no_smoking:"1F6AD",do_not_litter:"1F6AF","non-potable_water":"1F6B1",no_pedestrians:"1F6B7",no_mobile_phones:"1F4F5",underage:"1F51E",arrows_clockwise:"1F503",arrows_counterclockwise:"1F504",back:"1F519",end:"1F51A",on:"1F51B",soon:"1F51C",top:"1F51D",place_of_worship:"1F6D0",menorah_with_nine_branches:"1F54E",six_pointed_star:"1F52F",aries:"2648",taurus:"2649",gemini:"264A",cancer:"264B",leo:"264C",virgo:"264D",libra:"264E",scorpius:"264F",sagittarius:"2650",capricorn:"2651",aquarius:"2652",pisces:"2653",ophiuchus:"26CE",twisted_rightwards_arrows:"1F500",repeat:"1F501",repeat_one:"1F502",fast_forward:"23E9",rewind:"23EA",arrow_up_small:"1F53C",arrow_double_up:"23EB",arrow_down_small:"1F53D",arrow_double_down:"23EC",cinema:"1F3A6",low_brightness:"1F505",high_brightness:"1F506",signal_strength:"1F4F6",vibration_mode:"1F4F3",mobile_phone_off:"1F4F4",trident:"1F531",name_badge:"1F4DB",beginner:"1F530",o:"2B55",white_check_mark:"2705",x:"274C",negative_squared_cross_mark:"274E",heavy_plus_sign:"2795",heavy_minus_sign:"2796",heavy_division_sign:"2797",curly_loop:"27B0",loop:"27BF",question:"2753",grey_question:"2754",grey_exclamation:"2755",exclamation:"2757",keycap_ten:"1F51F",capital_abcd:"1F520",abcd:"1F521",symbols:"1F523",abc:"1F524",ab:"1F18E",cl:"1F191",cool:"1F192",free:"1F193",id:"1F194",new:"1F195",ng:"1F196",ok:"1F197",sos:"1F198",up:"1F199",vs:"1F19A",koko:"1F201",u6709:"1F236",u6307:"1F22F",ideograph_advantage:"1F250",u5272:"1F239",u7121:"1F21A",u7981:"1F232",accept:"1F251",u7533:"1F238",u5408:"1F234",u7a7a:"1F233",u55b6:"1F23A",u6e80:"1F235",red_circle:"1F534",large_orange_circle:"1F7E0",large_yellow_circle:"1F7E1",large_green_circle:"1F7E2",large_blue_circle:"1F535",large_purple_circle:"1F7E3",large_brown_circle:"1F7E4",black_circle:"26AB",white_circle:"26AA",large_red_square:"1F7E5",large_orange_square:"1F7E7",large_yellow_square:"1F7E8",large_green_square:"1F7E9",large_blue_square:"1F7E6",large_purple_square:"1F7EA",large_brown_square:"1F7EB",black_large_square:"2B1B",white_large_square:"2B1C",black_medium_small_square:"25FE",white_medium_small_square:"25FD",large_orange_diamond:"1F536",large_blue_diamond:"1F537",small_orange_diamond:"1F538",small_blue_diamond:"1F539",small_red_triangle:"1F53A",small_red_triangle_down:"1F53B",diamond_shape_with_a_dot_inside:"1F4A0",radio_button:"1F518",white_square_button:"1F533",black_square_button:"1F532"},Ht={":":{")":"1F642","(":"1F641",O:"1F62E",P:"1F61B",D:"1F604","*":"1F617","|":"1F610","#":"1F910",S:"1F616",$:"1F633","/":"1F615",".":"1F636",X:"1F922"},8:{")":"1F60E"},":'":{")":"1F602","(":"1F622",D:"1F923"},";":{")":"1F609",P:"1F61C"},X:{")":"1F606",D:"1F606",P:"1F61D"}};let Ut=function(){},zt=function(){};function xows_tpl_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"embload":Ut=o;break;case"emberror":zt=o}}function xows_tpl_emld(e){Ut(e)}function xows_tpl_emer(e){zt(e)}function xows_tpl_template_load(e,o){let t=ns.root+"/themes/"+Rt+"/"+e+".html";ns.uncache&&(t+="?"+xows_gen_nonce_asc(4));const _=new XMLHttpRequest;_.open("GET",t,!0),_._isinst=o,_.onreadystatechange=function(){4===this.readyState&&(200===this.status?xows_tpl_template_parse(this.responseText,this.responseURL,this._isinst):xows_init_fatal(this.status,this.responseURL))},Mt++,xows_log(2,"tpl_template_load","loading file",t),_.send()}function xows_tpl_template_done(){for(;Ot.childNodes.length>0;)document.body.appendChild(Ot.firstChild);xows_log(2,"tpl_template_done","templates parsing completed"),Ot=null,Pt()}function xows_tpl_template_parse(e,o,t,_){xows_log(2,"tpl_template_parse","parsing template",o),e=xows_l10n_parse(e);const s=Bt.parseFromString(e,"text/html"),n=xows_clean_dom(Bt.parseFromString(e,"text/html").body);if(!n)return void xows_log(0,"tpl_template_parse","template parse error",o);let i,r;const c=[],a=[];if(!t)for(i=(r=n.querySelectorAll("[XOWS_TPL_IMPORT]")).length;i--;)r[i].id?(c.push(r[i].id),r[i].removeAttribute("XOWS_TPL_IMPORT")):xows_log(0,"tpl_template_parse","instance declared without id",o);for(i=(r=n.querySelectorAll("[XOWS_TPL_INSTANCED]")).length;i--;)r[i].id?(a.push(r[i].id),r[i].parentNode.removeChild(r[i])):xows_log(0,"tpl_template_parse","instance declared without id",o);let l=o.substring(o.lastIndexOf("/")+1).split(".")[0];if(t)n.firstChild?(It[l]=document.createDocumentFragment(),It[l].appendChild(n.firstChild)):document.head.appendChild(s.head.firstChild);else{let e=Ot.querySelector("#"+l);for(e||(e=Ot);n.childNodes.length>0;)e.appendChild(n.firstChild);for(i=c.length;i--;)xows_tpl_template_load(c[i],!1)}for(i=a.length;i--;)xows_tpl_template_load(a[i],!0);0===--Mt&&xows_tpl_template_done()}function xows_tpl_init(e){e&&(Pt=e),ns.root&&(ns.root=ns.root),ns.theme&&(Rt=ns.theme);const o=document.createElement("link");o.rel="stylesheet",o.type="text/css";o.href=ns.root+"/themes/"+Rt+"/style.css",ns.uncache&&(o.href+="?"+xows_gen_nonce_asc(4)),document.head.appendChild(o),Mt=0,Ot=document.createDocumentFragment(),xows_tpl_template_load("body")}const Vt=/^\s*<a href=.+<\/a>\s*$/,Wt=/^(?:http|https):\/\/(?:[!#$&-;=?-\[\]_a-z~]|%[0-9a-fA-F]{2})+/i,Jt=/^```(.*?)\n(.+)```(?:\s?\n|\s?$)/s,Yt=/^`(\S.+?\S)`/,Xt=/(^\*\S.*?[^\s\*]\*)(?:[^\*]|$)/,Kt=/(^\*{2}\S.+?\S\*{2})(?:[^\*]|$)/,$t=/(^\*\S.+?\S\*)/,Qt=/^_\S.+?\S_/,Zt=/^~\S.+?\S~/,e_=/^(>+?) .+[^>](?=\n|$)/,o_=/^:([\w\-+]+):/,t_=/^([X8:;]|:')([()|DPXO#$.\/*sS])(?=\s|$)/i,__=new Map([[38,"&amp;"],[60,"&lt;"],[62,"&gt;"],[39,"&apos;"],[34,"&quot;"],[10,"<br>"]]),s_=new Array;function xows_tpl_parse_styling(e){if(!e||!e.length)return"";let o,t,_=0,s=0,n=!1,i=!1,r=0,c="",a=0;for(s_.length=0;a!==e.length;){if(t=e.charCodeAt(a),r&&10===e.charCodeAt(a-1)&&62!==t)for(;r;)c+="</blockquote>",r--;if(72!==t&&104!==t||!(o=Wt.exec(e.substring(a)))){if(58===t||59===t||88===t||120===t||56===t){const t=e.substring(a);if(o=o_.exec(t)){const e=Gt[o[1]];if(e){c+="<emo-ji>&#x"+e+";</emo-ji>",a+=o[0].length;continue}}if((0===a||32===e.charCodeAt(a-1))&&(o=t_.exec(t))){const e=Ht[o[1].toUpperCase()][o[2].toUpperCase()];if(e){c+="<emo-ji>&#x"+e+";</emo-ji>",a+=o[0].length;continue}}}if(t>47&&t<58||t>64&&t<91||t>96&&t<123)c+=e.charAt(a++);else if(t>55295&&t<57344)((t=65536+((1023&t)<<10|1023&e.charCodeAt(a+1)))>=8960&&t<=11263||t>=126976&&t<=129792)&&(c+="<emo-ji>&#x"+t.toString(16)+";</emo-ji>"),a+=2;else{if(42===t){if(s){if(s===a){c+="</b>",s=0,a+=2;continue}}else if(42===e.charCodeAt(a+1)&&(o=Kt.exec(e.substring(a)))){s=a+(o[1].length-2),c+="<b>",a+=2;continue}if(_){if(_===a){c+="</i>",_=0,a++;continue}}else if(o=s?$t.exec(e.substring(a)):Xt.exec(e.substring(a))){_=a+(o[1].length-1),c+="<i>",a++;continue}}if(95===t){if(n){n=!1,c+="</u>",a++;continue}if(n=Qt.test(e.substring(a))){c+="<u>",a++;continue}}if(126===t){if(i){i=!1,c+="</s>",a++;continue}if(i=Zt.test(e.substring(a))){c+="<s>",a++;continue}}if(62===t&&(0===a||10===e.charCodeAt(a-1))){let t=0;for(;o=e_.exec(e.substring(a));)32===e.charCodeAt(a+1)?a+=2:a++,t++;if(t){for(;t>r;)c+="<blockquote>",r++;for(;t<r;)c+="</blockquote>",r--;continue}}if(96===t){const t=e.substring(a);if(o=Yt.exec(t)){c+="<code>"+o[1]+"</code>",a+=o[0].length;continue}if((0===a||10===e.charCodeAt(a-1))&&(o=Jt.exec(t))){c+="<pre>"+o[2]+"</pre>",a+=o[0].length;continue}}__.has(t)?c+=__.get(t):c+=e.charAt(a),a++}}else s_.push(o[0]),c+='<a href="'+o[0]+'" target="_blank">'+o[0]+"</a>",a+=o[0].length}return c}function xows_tpl_embed_wrap(e,o,t,_){let s="<embd-wrap class='";return t&&(s+=t),s+="'>",_&&(s+="<a href='"+e+"' target='_blank'>"+_+"</a>"),s+=o.replace(/src=/g,"loading='lazy' onload='xows_tpl_emld(this)' onerror='xows_tpl_emer(this)' src="),s+="</embd-wrap>"}function xows_tpl_embed_image(e,o){return xows_tpl_embed_wrap(e,'<img src="'+e+'">',"EMBD-IMG LOADING")}function xows_tpl_embed_movie(e,o){return xows_tpl_embed_wrap(e,'<video controls src="'+e+'"></video>',"EMBD-VID")}function xows_tpl_embed_audio(e,o){return xows_tpl_embed_wrap(e,'<audio controls src="'+e+'"/>',"EMBD-SND")}function xows_tpl_embed_youtube(e,o){const t=e.match(/(?:v=|embed\/|shorts\/|youtu\.be\/)([\w\-]+)(\?.+)?/);if(!t)return null;let _=t[1];return t[2]&&(_+=t[2].replace(/t=/,"start=")),xows_tpl_embed_wrap(e,'<iframe src="https://www.youtube.com/embed/'+_+'"/>',"EMBD-IFR LOADING","YouTube")}function xows_tpl_embed_dailymo(e,o){const t=e.match(/(?:video|dai\.ly)\/([\w\d]+)/);return t?xows_tpl_embed_wrap(e,'<iframe src="https://www.dailymotion.com/embed/video/'+t[1]+'"/>',"EMBD-IFR LOADING","Dailymotion"):null}function xows_tpl_embed_vimeo(e,o){const t=e.match(/\/([\d]+)/);return t?xows_tpl_embed_wrap(e,'<iframe src="https://player.vimeo.com/video/'+t[1]+'"></iframe>',"EMBD-IFR LOADING","Vimeo"):null}function xows_tpl_embed_odysee(e,o){const t=e.match(/.com\/(.*)/);return t?xows_tpl_embed_wrap(e,'<iframe src="https://odysee.com/$/embed/'+t[1]+'"></iframe>',"EMBD-IFR LOADING","Odysee"):null}function xows_tpl_embed_upld(e,o){return xows_tpl_embed_wrap(e,'<a class="dnld-btn" href="'+e+'" target="_blank"></a>',"EMBD-DNL",decodeURI(e.match(/(.+\/)*(.+\..+)/)[2]))}let n_={JPG:xows_tpl_embed_image,JPEG:xows_tpl_embed_image,GIF:xows_tpl_embed_image,PNG:xows_tpl_embed_image,WEBP:xows_tpl_embed_image,SVG:xows_tpl_embed_image,MP4:xows_tpl_embed_movie,MPEG:xows_tpl_embed_movie,AVI:xows_tpl_embed_movie,MP3:xows_tpl_embed_audio,OGG:xows_tpl_embed_audio},i_={"www.youtube.com":xows_tpl_embed_youtube,"youtu.be":xows_tpl_embed_youtube,"www.dailymotion.com":xows_tpl_embed_dailymo,"dai.ly":xows_tpl_embed_dailymo,"vimeo.com":xows_tpl_embed_vimeo,"odysee.com":xows_tpl_embed_odysee},r_={};function xows_tpl_embed_add_site(e,o){i_[e]=o}function xows_tpl_embed_add_file(e,o){n_[e]=o}function xows_tpl_embed_add_upld(e){r_[e]=xows_tpl_embed_upld}function xows_tpl_parse_embeds(e){if(!e.length)return null;let o,t,_,s,n="";for(let i=0,r=e.length;i<r;++i)s=null,(o=(_=e[i]).match(/\.([\w\d]+)(\?|$)/))&&(t=o[1].toUpperCase(),n_[t]&&(s=n_[t](_,t))),s||(o=_.match(/\/\/(.*?[\w\d\-_]+\.\w+)\//))&&(t=o[1].toLowerCase(),i_[t]&&(s=i_[t](_,t)),r_[t]&&(s=r_[t](_,t))),s&&(n+=s);return n.length?n:null}let c_=new Map;function xows_tpl_spawn_avat_cls(e){if(e){if(!c_.has(e)){const o="h-"+e,t=document.createElement("style");t.type="text/css",t.innerText="."+o+' {background-image:url("'+xows_cach_avat_get(e)+'");}\r\n',document.head.appendChild(t),c_.set(e,o)}return c_.get(e)}return""}function xows_tpl_spawn_rost_cont(e,o,t,_,s,n){const i=It["peer-cont"].firstChild.cloneNode(!0);i.id=e,i.title=o+" ("+e+")",i.querySelector("PEER-NAME").innerText=o;const r=i.querySelector("BADG-SHOW");if(_<Ee)i.classList.add("PEER-DENY"),i.querySelector("PEER-META").innerText=xows_l10n_get("Authorization pending"),r.hidden=!0,i.querySelector("[name='cont_bt_rtry']").disabled=!1;else{i.querySelector("PEER-META").innerText=n||"",r.dataset.show=s||0;const o=i.querySelector("PEER-AVAT");o.dataset.jid=e,o.className=xows_tpl_spawn_avat_cls(t)}return i}function xows_tpl_update_rost_cont(e,o,t,_,s,n){e.title=o+" ("+e.id+")",e.querySelector("PEER-NAME").innerText=o;const i=e.querySelector("BADG-SHOW"),r=e.querySelector("[name='cont_bt_rtry']");_<Ee?(e.classList.add("PEER-DENY"),e.querySelector("PEER-META").innerText=xows_l10n_get("Authorization pending"),i.hidden=!0,r.disabled=!1):(e.classList.remove("PEER-DENY"),e.querySelector("PEER-META").innerText=n||"",i.hidden=!1,i.dataset.show=s||0,r.disabled=!0,e.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(t))}function xows_tpl_spawn_rost_room(e,o,t,_){const s=It["peer-room"].firstChild.cloneNode(!0);return s.id=e,s.title=o+" ("+e+")",s.querySelector("PEER-NAME").innerText=o,s.querySelector("PEER-META").innerText=t,s}function xows_tpl_update_rost_room(e,o,t,_){e.title=o+" ("+e.id+")",e.querySelector("PEER-NAME").innerText=o,e.querySelector("PEER-META").innerText=t}function xows_tpl_spawn_rost_subs(e,o){const t=It["peer-pend"].firstChild.cloneNode(!0);return t.id=e,t.title=o+" ("+e+")",o&&t.setAttribute("name",o),t.querySelector("PEER-NAME").innerText=o||e,t}function xows_tpl_spawn_room_occu(e,o,t,_,s,n){const i=It["peer-occu"].firstChild.cloneNode(!0);i.id=e,i.title=o+" ("+e+")",i.dataset.jid=_||"",i.querySelector("PEER-NAME").innerText=o,i.querySelector("PEER-META").innerText=n||"",i.querySelector("BADG-SHOW").dataset.show=s||0,i.querySelector("[name='occu_bt_subs']").disabled=!(_&&_.length);const r=i.querySelector("PEER-AVAT");return r.dataset.jid=e,r.className=xows_tpl_spawn_avat_cls(t),i}function xows_tpl_update_room_occu(e,o,t,_,s,n){e.title=o+" ("+e.id+")",e.dataset.jid=_||"",e.querySelector("PEER-NAME").innerText=o,e.querySelector("PEER-META").innerText=n||"",e.querySelector("BADG-SHOW").dataset.show=s||0,e.querySelector("[name='occu_bt_subs']").disabled=!(_&&_.length),e.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(t)}function xows_tpl_mesg_spawn(e,o,t,_,s,n){const i=It["hist-mesg"].firstChild.cloneNode(!0);if(i.dataset.id=o.id,i.dataset.from=o.from,i.dataset.time=o.time,o.origid&&(i.dataset.origid=o.origid),o.stnzid&&(i.dataset.stnzid=o.stnzid),o.occuid&&(i.dataset.occuid=o.occuid),n){const o=xows_cli_author_get(e,n.dataset.from,n.dataset.occuid);o===Wo&&i.classList.add("MENTION");let t=xows_cli_peer_iden(o);const _=i.querySelector("RPLY-AVAT");_.dataset.peer=t,_.className=xows_tpl_spawn_avat_cls(o.avat);const s=i.querySelector("RPLY-FROM");s.dataset.peer=t,s.innerText=o.name,i.querySelector("RPLY-BODY").innerHTML=n.querySelector("MESG-BODY").innerText;const r=i.querySelector("MESG-RPLY");r.dataset.ref=n.dataset.stnzid?n.dataset.stnzid:n.dataset.origid?n.dataset.origid:n.dataset.id,r.hidden=!1}let r;s?(r=s.classList.contains("MESG-APPEND"),i.classList.add("MESG-MODIFY")):_&&!n&&o.time-_.dataset.time<D_&&_.dataset.from===o.from&&(r=!0),r&&i.classList.add("MESG-APPEND");const c=xows_cli_author_get(e,o.from,o.occuid);let a=xows_cli_peer_iden(c);const l=i.querySelector("MESG-FROM");l.dataset.peer=a,l.innerText=c.name;const u=i.querySelector("MESG-AVAT");u.dataset.peer=a,u.className=xows_tpl_spawn_avat_cls(c.avat),c===Wo&&(i.classList.add("MESG-SENT"),t||i.classList.add("MESG-RECP"),i.querySelector("MESG-BODY").dataset.raw=xows_html_escape(o.body)),i.querySelector("MESG-HOUR").innerText=xows_l10n_houre(o.time),i.querySelector("MESG-DATE").innerText=xows_l10n_date(o.time);const d=i.querySelector("MESG-BODY"),x=i.querySelector("MESG-EMBD"),w=xows_tpl_parse_styling(o.body);d.innerHTML=w;const p=xows_tpl_parse_embeds(s_);return p&&(x.innerHTML=p,x.hidden=!1,Vt.test(w)&&(d.hidden=!0)),i}function xows_tpl_mesg_update(e,o,t){o.origid&&(e.dataset.origid=o.origid),o.stnzid&&(e.dataset.stnzid=o.stnzid),o.occuid&&(e.dataset.occuid=o.occuid),t&&e.classList.add("MESG-RECP")}function xows_tpl_mesg_edit_insert(e){const o=It["mesg-edit"].firstChild.cloneNode(!0);o.dataset.id=e.id;const t=e.querySelector("MESG-BODY");return o.querySelector("MESG-INPT").innerHTML=t.dataset.raw,t.parentNode.insertBefore(o,t),e.classList.add("MESG-EDITOR"),o}function xows_tpl_mesg_edit_remove(e){const o=e.querySelector("MESG-MAIN");o&&o.removeChild(o.querySelector("MESG-EDIT")),e.classList.remove("MESG-EDITOR")}function xows_tpl_mesg_trsh_insert(e){const o=It["mesg-trsh"].firstChild.cloneNode(!0);o.dataset.id=e.id;const t=e.querySelector("MESG-EMBD");return t.parentNode.insertBefore(o,t),e.classList.add("MESG-TRASH"),o}function xows_tpl_mesg_trsh_remove(e){const o=e.querySelector("MESG-MAIN");o&&o.removeChild(o.querySelector("MESG-TRSH")),e.classList.remove("MESG-TRASH")}function xows_tpl_spawn_stream_audio(e,o,t){const _=It["strm-audio"].firstChild.cloneNode(!0);_.dataset.from=e,_.title=o;const s=_.querySelector("STRM-AVAT");return s.dataset.jid=e,s.className=xows_tpl_spawn_avat_cls(t),_}function xows_tpl_spawn_stream_video(e,o,t){const _=It["strm-video"].firstChild.cloneNode(!0);return _.dataset.from=e,_.title=o,_}function xows_doc(e){return document.getElementById(e)}const a_=new Map,l_=document.getSelection(),u_=document.createRange();function xows_doc_listener_add(e,o,t,_=!0){e.addEventListener(o,t,{capture:!1,passive:_})}function xows_doc_listener_rem(e,o,t,_=!0){e.removeEventListener(o,t,{capture:!1,passive:_})}function xows_doc_cls_has(e,o){return document.getElementById(e).classList.contains(o)}function xows_doc_cls_tog(e,o,t){return document.getElementById(e).classList.toggle(o,t)}function xows_doc_cls_add(e,o){document.getElementById(e).classList.add(o)}function xows_doc_cls_rem(e,o){document.getElementById(e).classList.remove(o)}function xows_doc_show(e,o=!0){document.getElementById(e).hidden=!o}function xows_doc_hide(e,o=!1){document.getElementById(e).hidden=!o}function xows_doc_hidden(e){return document.getElementById(e).hidden}function xows_doc_frag_clone(e,o,t){let _,s;a_.has(e)||a_.set(e,new Map),_=a_.get(o).get(t),s=document.createDocumentFragment(),a_.get(e).set(t,s);for(let e=0,o=_.childNodes.length;e<o;++e)s.appendChild(_.childNodes[e].cloneNode(!0))}function xows_doc_frag_export(e,o,t){let _,s;if(a_.has(e)||a_.set(e,new Map),_=document.getElementById(o),s=document.createDocumentFragment(),a_.get(e).set(o,s),t)for(let e=0,o=_.childNodes.length;e<o;++e)s.appendChild(_.childNodes[e].cloneNode(!0));else for(;_.childNodes.length;)s.appendChild(_.firstChild)}function xows_doc_frag_import(e,o,t){if(a_.has(e)){let _,s;if(_=a_.get(e).get(o),(s=document.getElementById(o)).innerText="",t)for(let e=0,o=_.childNodes.length;e<o;++e)s.appendChild(_.childNodes[e].cloneNode(!0));else for(;_.childNodes.length;)s.appendChild(_.firstChild)}}function xows_doc_frag_delete(e){a_.delete(e)}function xows_doc_frag_clear(){a_.clear()}function xows_doc_frag_element(e,o){return a_.has(e)?a_.get(e).get(o):null}function xows_doc_frag_find(e,o){if(a_.has(e)){const t=a_.get(e);if(t.has(o))return t.get(o);let _;for(const e of t.values())if(_=e.getElementById(o))return _}return null}function xows_doc_frag_element_find(e,o,t){if(a_.has(e)){const _=a_.get(e);if(_.has(o))return _.get(o).getElementById(t)}return null}function xows_doc_caret_around(e,o=!1){l_.removeAllRanges(),u_.setStartBefore(e),u_.setEndAfter(e),u_.collapse(o),l_.addRange(u_)}function xows_doc_caret_at(e,o=!1){l_.removeAllRanges(),u_.selectNodeContents(e),u_.collapse(o),l_.addRange(u_)}function xows_doc_sel_rng(e){return l_.getRangeAt(e)}function xows_doc_init(t){xows_doc_listener_add(xows_doc("main_tabs"),"click",xows_gui_rost_widen),xows_doc_listener_add(xows_doc("main_hndr"),"click",xows_gui_main_open),xows_doc_listener_add(xows_doc("main_hndl"),"click",xows_gui_main_open),xows_doc_listener_add(xows_doc("rost_tabs"),"click",xows_gui_rost_tabs_onclick),xows_doc_listener_add(xows_doc("rost_fram"),"click",xows_gui_rost_fram_onclick),xows_doc_listener_add(xows_doc("user_panl"),"click",xows_gui_user_panl_onclick),xows_doc_listener_add(xows_doc("chat_head"),"click",xows_gui_chat_head_onclick),xows_doc_listener_add(xows_doc("chat_main"),"scroll",xows_gui_chat_main_onscroll),xows_doc_listener_add(xows_doc("chat_hist"),"click",xows_gui_chat_hist_onclick),xows_doc_listener_add(xows_doc("chat_hist"),"touchstart",xows_gui_chat_hist_onclick);const _=new ResizeObserver(xows_gui_chat_main_onresize);_.observe(xows_doc("chat_main")),_.observe(xows_doc("chat_hist"));const s=xows_doc("chat_panl");xows_doc_listener_add(s,"click",xows_gui_chat_panl_onclick),xows_doc_listener_add(xows_doc("chat_file"),"change",xows_gui_chat_file_onchange),xows_doc_listener_add(xows_doc("drop_emoj"),"click",xows_gui_drop_emoj_onclick),xows_doc_listener_add(s,"input",xows_gui_chat_inpt_oninput),xows_doc_listener_add(xows_doc("room_head"),"click",xows_gui_room_head_onclick),xows_doc_listener_add(xows_doc("occu_list"),"click",xows_gui_occu_list_onclick),xows_doc_listener_add(xows_doc("scr_page"),"keyup",xows_doc_page_onkeyu),xows_doc_listener_add(xows_doc("page_exit"),"click",xows_doc_page_onclose),ns.allow_register&&xows_doc_show("auth_regi"),xows_doc_listener_add(xows_doc("scr_void"),"click",xows_doc_void_onclick),xows_doc_listener_add(xows_doc("over_view"),"click",xows_doc_view_onclick),xows_doc_listener_add(xows_doc("mbox_close"),"click",xows_doc_mbox_close),xows_doc_listener_add(xows_doc("mbox_abort"),"click",xows_doc_mbox_onabort),xows_doc_listener_add(xows_doc("mbox_valid"),"click",xows_doc_mbox_onvalid),xows_doc_listener_add(xows_doc("ibox_close"),"click",xows_doc_ibox_close),xows_doc_listener_add(xows_doc("ibox_abort"),"click",xows_doc_ibox_onabort),xows_doc_listener_add(xows_doc("ibox_valid"),"click",xows_doc_ibox_onvalid),xows_doc_listener_add(document,"keydown",xows_gui_wnd_onkey,!1),xows_doc_listener_add(document,"keyup",xows_gui_wnd_onkey),xows_doc_listener_add(document,"visibilitychange",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"pagehide",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"focus",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"blur",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"beforeunload",xows_cli_flyyoufools),xows_doc_listener_add(window,"unload",xows_cli_flyyoufools),xows_doc_listener_add(window,"popstate",xows_gui_nav_onpopstate),xows_tpl_set_callback("embload",xows_doc_media_onload),xows_tpl_set_callback("emberror",xows_doc_media_onerror),xows_doc("app_about").innerText=e.toUpperCase()+" v"+o,xows_log(2,"doc_init","document ready"),xows_isfunc(t)&&t()}function xows_doc_media_onload(e){e.parentNode.classList.remove("LOADPND"),e.parentNode.classList.remove("LOADING"),xows_gui_chat_main_onresize()}function xows_doc_media_onerror(e){e.parentNode.classList.remove("LOADPND"),e.parentNode.classList.remove("LOADING"),e.parentNode.classList.add("LOADERR"),e.closest("MESG-MAIN").querySelector("MESG-BODY").hidden=!1}function xows_doc_blink(e,o){xows_doc_cls_has(e,"BLINK")?xows_doc_cls_rem(e,"BLINK"):(xows_doc_cls_add(e,"BLINK"),setTimeout(xows_doc_blink,o,e))}const d_=-1,x_=0,w_=1,p_=2;let m_=null,g_=null;function xows_doc_mbox_close(){m_=null,g_=null,xows_doc_hide("over_mbox"),xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void")}function xows_doc_mbox_onabort(e){m_&&(m_(),xows_doc_mbox_close())}function xows_doc_mbox_onvalid(e){g_&&(g_(),xows_doc_mbox_close())}function xows_doc_mbox_open(e,o,t,_,s,n,i){if(xows_doc_mbox_modal())return;let r;switch(xows_doc_mbox_close(),e){case d_:r="MBOX-ERR";break;case x_:r="MBOX-WRN";break;case w_:r="MBOX-SCS";break;case p_:r="MBOX-ASK"}xows_doc("over_mbox").classList=r,xows_doc("mbox_text").innerHTML=xows_l10n_get(o),xows_doc_show("mbox_close",!t&&!s),xows_doc_show("mbox_valid",Boolean(t)),xows_doc_show("mbox_abort",Boolean(s)),t&&(xows_doc("mbox_valid").innerText=xows_l10n_get(_)),s&&(xows_doc("mbox_abort").innerText=xows_l10n_get(n)),m_=s,g_=t,i&&(xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void")),xows_doc_show("over_mbox")}function xows_doc_mbox_open_for_save(e,o){xows_doc_hidden("over_mbox")&&xows_doc_mbox_open(null,"It remains unsaved changes",e,"Save changes",o,"Reset")}function xows_doc_mbox_modal(){return!(xows_doc_hidden("over_mbox")||!m_)&&(xows_doc_blink("over_mbox",600),!0)}let f_=null,h_=null;function xows_doc_ibox_close(){xows_doc_listener_rem(document,"keyup",xows_doc_ibox_onkey),f_=null,h_=null,xows_doc_hide("over_ibox");const e=xows_doc("scr_void");e.hidden||(e.className="",e.hidden=!0,xows_doc_listener_rem(document,"keyup",xows_doc_ibox_onkey))}function xows_doc_ibox_onabort(e){f_&&f_(),xows_doc_ibox_close()}function xows_doc_ibox_onvalid(e){h_&&h_(xows_doc("ibox_inpt").value),xows_doc_ibox_close()}function xows_doc_ibox_onkey(e){13===e.keyCode&&xows_doc_ibox_onvalid(),27===e.keyCode&&xows_doc_ibox_onabort()}function xows_doc_ibox_open(e,o,t,_,s,n,i){if(xows_doc_ibox_modal())return;xows_doc_ibox_close(),xows_doc("ibox_text").innerHTML=xows_l10n_get(e),xows_doc("ibox_hint").innerHTML=xows_l10n_get(o);const r=xows_doc("ibox_inpt");if(r.placeholder=t,r.value=_,f_=n,h_=s,i){const e=xows_doc("scr_void");e.className="VOID-DARK",e.hidden=!1,xows_doc_listener_add(document,"keyup",xows_doc_ibox_onkey)}xows_doc_show("over_ibox")}function xows_doc_ibox_modal(){return!xows_doc_hidden("over_ibox")&&(xows_doc_blink("over_ibox",600),!0)}let b_=null,F_=null,y_=null,v_=null;function xows_doc_page_oninput(e){y_(e.target)}function xows_doc_page_onclick(e){v_(e.target)}function xows_doc_page_onclose(e){xows_doc_mbox_modal()||xows_doc_page_close()}function xows_doc_page_close(e){if(!b_)return;xows_log(2,"doc_page_close",(e?"soft":"hard")+" close",b_);const o=xows_doc(b_);o.title&&xows_gui_title_pop(),y_&&(xows_doc_listener_rem(o,"input",xows_doc_page_oninput),y_=null),v_&&(xows_doc_listener_rem(o,"click",xows_doc_page_onclick),v_=null),F_&&F_(),F_=null,xows_doc_hide("colr_exit"),xows_doc_hide(b_),b_=null,xows_doc_mbox_close(),e||xows_gui_main_open()}function xows_doc_page_open(e,o,t,_,s){xows_cli_activity_wakeup();let n=null!==b_;n&&xows_doc_page_close(!0),xows_log(2,"doc_page_open",e),n||(xows_doc_hide("scr_main"),xows_doc_show("scr_page")),xows_doc_show(e),b_=e,o&&xows_doc_show("colr_exit"),F_=t;const i=xows_doc(e);_&&(y_=_,xows_doc_listener_add(i,"input",xows_doc_page_oninput)),s&&(v_=s,xows_doc_listener_add(i,"click",xows_doc_page_onclick)),i.title&&xows_gui_title_push(xows_l10n_get(i.title)+" - XOWS"),xows_doc_mbox_close()}function xows_doc_page_onkeyu(e){if(b_&&13===e.keyCode)if(xows_doc_hidden("over_mbox")||xows_doc_hidden("mbox_valid")){const e=xows_doc(b_).querySelector("*[type='submit']");e&&e.click()}else xows_doc("mbox_valid").click()}function xows_doc_page_opened(e){return b_==e}const k_={bttn:null,drop:null};function xows_doc_menu_close(){const e=k_.bttn,o=k_.drop;o&&(o.hidden=!0,xows_doc_listener_rem(o,"click",onclick)),e&&e.blur(),xows_doc_hide("scr_void"),k_.bttn=null,k_.drop=null}function xows_doc_menu_toggle(e,o,t){if(k_.bttn)xows_doc_menu_close();else{const _=xows_doc(o);if(!e||!_)return;k_.bttn=e,k_.drop=_,xows_doc_show("scr_void"),xows_doc_listener_add(_,"click",t),_.hidden=!1,e.focus()}}function xows_doc_view_open(e){"IMG"===e.tagName&&(xows_doc("view_img").src=e.src,xows_doc_show("over_view"),xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void"))}function xows_doc_view_close(){const e=xows_doc("over_view");e.hidden||(e.hidden=!0,xows_doc("view_img").src="",xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"))}function xows_doc_view_onclick(e){switch(e.target.id){case"view_optab":window.open(e.target.parentNode.querySelector("IMG").src,"_blank").focus();break;default:xows_doc_view_close()}}function xows_doc_void_onclick(e){k_.bttn&&xows_doc_menu_close(),xows_doc_view_close(),xows_doc_mbox_modal(),xows_doc_ibox_modal()}let A_=null,q_=function(){},E_=function(){},C_=function(){};const S_=[];let T_=!1;function xows_wrtc_gen_credential(e,o){const t=parseInt(Date.now()/1e3)+86400+":"+e;return{username:t,password:xows_bytes_to_b64(xows_hmac_sha1(t,o))}}function xows_wrtc_onerror(e){xows_log(1,"wrtc_onerror",e.message),C_(e.message)}function xows_wrtc_onstatechange(e){xows_log(2,"wrtc_onstatechange","state",A_.connectionState),"connected"===A_.connectionState&&E_()}function xows_wrtc_setlocaldesc(e){A_.setLocalDescription(e).then(null,xows_wrtc_onerror)}function xows_wrtc_onnegotiation(e){A_.createOffer().then(xows_wrtc_setlocaldesc,xows_wrtc_onerror)}function xows_wrtc_onicestate(e){"complete"==A_.iceGatheringState&&xows_isfunc(q_)&&(xows_log(2,"wrtc_onicestate","Local description available"),q_(A_.localDescription.sdp))}function xows_wrtc_ontrack(e){if(e.streams.length){xows_log(2,"wrtc_ontrack","Remote stream available");const o=S_.shift();xows_isfunc(o.onstream)&&o.onstream(e.streams[0],o.param),T_=!1,xows_wrtc_remote_next()}}function xows_wrtc_clear(){A_&&(A_.close(),A_=null,xows_log(2,"wrtc_setup","WebRTC cleared"))}function xows_wrtc_setup(e,o,t){xows_wrtc_clear();const _=[];for(let o=0;o<e.length;++o){const t={urls:e[o].type+":"+e[o].host};if(e[o].secret){const _=xows_wrtc_gen_credential(Wo.bare,e[o].secret);t.username=_.username,t.credential=_.password}else e[o].username&&(t.username=e[o].username),e[o].password&&(t.credential=e[o].password);_.push(t)}o&&(E_=o),t&&(C_=t),(A_=new RTCPeerConnection({iceServers:_})).ontrack=xows_wrtc_ontrack,A_.onnegotiationneeded=xows_wrtc_onnegotiation,A_.onconnectionstatechange=xows_wrtc_onstatechange,A_.onicegatheringstatechange=xows_wrtc_onicestate,xows_log(2,"wrtc_setup","WebRTC initialized")}function xows_wrtc_local_stream(e,o){if(!A_)return void xows_log(1,"wrtc_local_stream","WebRTC not initialized");o&&(q_=o);const t=e.getTracks();for(let e=0;e<t.length;++e)A_.addTrack(t[e]);xows_log(2,"wrtc_local_stream","Local stream added"),A_.remoteDescription&&A_.createAnswer().then(xows_wrtc_setlocaldesc,xows_wrtc_onerror)}function xows_wrtc_remote_next(){if(!S_.length||T_)return;xows_log(2,"wrtc_remote_next","Remote description added");const e=S_[0];A_.setRemoteDescription(e.desc).then(null,xows_wrtc_onerror),T_=!0}function xows_wrtc_remote_sdp(e,o,t){if(!A_)return void xows_log(1,"wrtc_local_stream","WebRTC not initialized");const _=A_.localDescription?"answer":"offer",s=new RTCSessionDescription({type:_,sdp:e});S_.push({desc:s,onstream:o,param:t}),xows_log(2,"wrtc_remote_sdp","Remote description queued"),xows_wrtc_remote_next()}function xows_wrtc_has_local(){return!!A_&&null!==A_.localDescription}function xows_wrtc_has_remote(){return!!A_&&null!==A_.remoteDescription}function xows_wrtc_ready(){return null!==A_}function xows_wrtc_linked(){return!!A_&&"connected"===A_.connectionState}function xows_wrtc_busy(){return xows_wrtc_has_local()}const D_=6e5;let N_=128,j_=64,L_="en-US",B_=null,P_=null;const M_={ctx:null,vol:null},I_=new Map;function xows_gui_sound_error(e){const o=e.target;xows_log(1,"gui_sound_error","'"+o.title+"' sound load failed",o.src),I_.delete(o.title)}function xows_gui_sound_load(e,o,t){const _=new Audio;I_.set(e,_),_.title=e,_.loop=t;const s=ns.root+"/sounds/"+o;xows_log(2,"gui_sound_load","loading '"+e+"' sound",s),_.onerror=xows_gui_sound_error,_.src=s}function xows_gui_sound_play(e){I_.has(e)&&I_.get(e).play()}function xows_gui_sound_stop(e){I_.has(e)&&I_.get(e).pause()}let O_=!0,R_=!0,G_=!1,H_=null;function xows_gui_ondevicesinfos(e){H_=e,P_&&xows_gui_chat_head_update(P_)}function xows_gui_ondevicechange(e){navigator.mediaDevices.enumerateDevices().then(xows_gui_ondevicesinfos)}function xows_gui_medias_has(e){if(!H_)return!1;for(let o=0;o<H_.length;++o)if(H_[o].kind===e)return!0;return!1}const U_="NULL",z_=new Map;function xows_gui_peer_doc(e,o){return e===P_?document.getElementById(o):xows_doc_frag_find(e.bare,o)}function xows_gui_peer_occu_li(e,o){return e===P_?document.getElementById(o):xows_doc_frag_element_find(e.bare,"occu_list",o)}function xows_gui_peer_hist_reload(e){const o=e!==P_?z_.get(e.bare):xows_doc("chat_main");o.scrollTop=o.scrollHeight-o.clientHeight,o.scrollSaved=0,xows_gui_peer_doc(e,"hist_beg").className="",xows_gui_peer_doc(e,"hist_ul").innerText="",xows_gui_peer_doc(e,"hist_end").hidden=!0,xows_gui_mam_query(e,!1,j_,0)}function xows_gui_peer_scroll_save(e){const o=e!==P_?z_.get(e.bare):xows_doc("chat_main");o.scrollSaved=o.scrollHeight-(o.scrollTop+o.clientHeight)}function xows_gui_peer_scroll_get(e){return e!==P_?z_.get(e.bare).scrollSaved:xows_doc("chat_main").scrollSaved}function xows_gui_peer_scroll_down(e){if(xows_gui_peer_doc(e,"hist_end").hidden){const o=e!==P_?z_.get(e.bare):xows_doc("chat_main");o.scrollTop=o.scrollHeight-o.clientHeight,o.scrollSaved=0}else xows_gui_peer_hist_reload(e)}function xows_gui_peer_scroll_adjust(e){const o=e!==P_?z_.get(e.bare):xows_doc("chat_main");o.scrollTop=o.scrollHeight-(o.clientHeight+(o.scrollSaved||0))}function xows_gui_peer_doc_init(e){xows_doc_frag_clone(e.bare,U_,"chat_head"),xows_doc_frag_clone(e.bare,U_,"chat_hist"),xows_doc_frag_clone(e.bare,U_,"chat_panl"),xows_doc_frag_clone(e.bare,U_,"room_head"),xows_doc_frag_clone(e.bare,U_,"occu_list"),xows_gui_peer_doc(e,"hist_ul").hidden=!0,xows_gui_peer_doc(e,"chat_titl").innerText=e.name;const o=xows_gui_peer_doc(e,"meta_inpt");e.type===zo?(o.innerText=e.subj?e.subj:"",o.className=e.subj?"":"PLACEHOLD",xows_gui_peer_doc(e,"chat_bt_bkmk").hidden=e.book||e.publ):(o.innerText=e.stat?e.stat:"",xows_gui_peer_doc(e,"chat_show").dataset.show=chat_show,xows_gui_peer_doc(e,"chat_addr").innerText="("+e.bare+")");const t=xows_l10n_get("Send a message to")+" "+e.name+" ...";xows_gui_peer_doc(e,"chat_inpt").setAttribute("placeholder",t),z_.set(e.bare,{scrollTop:0,scrollHeight:0,clientHeight:0,scrollSaved:0}),xows_gui_chat_noti_update(e)}function xows_gui_peer_doc_export(e){const o=xows_doc("chat_main");z_.set(e.bare,{scrollTop:o.scrollTop,scrollHeight:o.scrollHeight,clientHeight:o.clientHeight,scrollSaved:o.scrollSaved||0}),xows_doc_frag_export(e.bare,"chat_head"),xows_doc_frag_export(e.bare,"chat_hist"),xows_doc_frag_export(e.bare,"chat_panl"),xows_doc_frag_export(e.bare,"room_head"),xows_doc_frag_export(e.bare,"occu_list")}function xows_gui_peer_doc_import(e){if(e){xows_doc_frag_import(e.bare,"chat_head"),xows_doc_frag_import(e.bare,"chat_hist"),xows_doc_frag_import(e.bare,"chat_panl"),xows_doc_frag_import(e.bare,"room_head"),xows_doc_frag_import(e.bare,"occu_list");const o=xows_wrtc_busy();xows_gui_peer_doc(e,"chat_bt_cala").disabled=o,xows_gui_peer_doc(e,"chat_bt_calv").disabled=o;const t=xows_doc("chat_main");t.scrollTop=t.scrollHeight-(t.clientHeight+z_.get(e.bare).scrollSaved)}else xows_doc_frag_import(U_,"chat_head",!0),xows_doc_frag_import(U_,"chat_hist",!0),xows_doc_frag_import(U_,"chat_panl",!0),xows_doc_frag_import(U_,"room_head",!0),xows_doc_frag_import(U_,"occu_list",!0)}function xows_gui_init(){xows_doc_frag_export(U_,"chat_head",!0),xows_doc_frag_export(U_,"chat_hist",!0),xows_doc_frag_export(U_,"chat_panl",!0),xows_doc_frag_export(U_,"room_head",!0),xows_doc_frag_export(U_,"occu_list",!0),R_=!0,navigator.mediaDevices&&(navigator.mediaDevices.enumerateDevices().then(xows_gui_ondevicesinfos),navigator.mediaDevices.ondevicechange=xows_gui_ondevicechange),xows_gui_sound_load("notify","notify.ogg"),xows_gui_sound_load("disable","disable.ogg"),xows_gui_sound_load("enable","enable.ogg"),xows_gui_sound_load("mute","mute.ogg"),xows_gui_sound_load("unmute","unmute.ogg"),xows_gui_sound_load("ringtone","ringtone.ogg",!0),xows_gui_sound_load("ringbell","ringbell.ogg",!0),xows_gui_sound_load("hangup","hangup.ogg"),N_=ns.history_size,j_=N_/2}function xows_gui_connect(e=!1){xows_cli_set_callback("connect",xows_gui_cli_onconnect),xows_cli_set_callback("selfchange",xows_gui_cli_onselfchange),xows_cli_set_callback("contpush",xows_gui_cli_oncontpush),xows_cli_set_callback("contrem",xows_gui_cli_oncontrem),xows_cli_set_callback("subspush",xows_gui_cli_onsubspush),xows_cli_set_callback("subsrem",xows_gui_cli_onsubsrem),xows_cli_set_callback("roompush",xows_gui_cli_onroompush),xows_cli_set_callback("roomrem",xows_gui_cli_onroomrem),xows_cli_set_callback("occupush",xows_gui_cli_onoccupush),xows_cli_set_callback("occurem",xows_gui_cli_onoccurem),xows_cli_set_callback("message",xows_gui_cli_onmessage),xows_cli_set_callback("chatstate",xows_gui_cli_onchatstate),xows_cli_set_callback("receipt",xows_gui_cli_onreceipt),xows_cli_set_callback("retract",xows_gui_cli_onretract),xows_cli_set_callback("subject",xows_gui_cli_onsubject),xows_cli_set_callback("error",xows_gui_cli_onerror),xows_cli_set_callback("close",xows_gui_cli_onclose),xows_cli_set_callback("timeout",xows_gui_cli_ontimeout),xows_cli_set_callback("callerror",xows_gui_cli_oncallerror),xows_cli_set_callback("callinit",xows_gui_cli_oncallinit),xows_cli_set_callback("callaccept",xows_gui_cli_oncallaccept),xows_cli_set_callback("callend",xows_gui_cli_oncallend),xows_doc_mbox_close(),R_=!1,M_.ctx||(M_.ctx=new AudioContext,M_.vol=M_.ctx.createGain(),M_.vol.connect(M_.ctx.destination),M_.vol.gain.value=0),ns.domain&&(B_.user+="@"+ns.domain),xows_cli_connect(ns.url,B_.user,B_.pass,e)}function xows_gui_cli_onconnect(e){if(B_){if(B_.cred&&(xows_log(2,"gui_loggedin","Saving credential"),window.PasswordCredential)){const e={id:B_.user,password:B_.pass},o=new PasswordCredential(e);navigator.credentials.store(o)}B_=null}if(xows_gui_main_open(),xows_gui_rost_widen(),G_){G_=!1;let e=Jo.length;for(;e--;)xows_gui_mam_query(Jo[e],!0,j_,0,!0);for(e=Yo.length;e--;)xows_gui_mam_query(Yo[e],!0,j_,0,!0)}else{window.history.pushState({},"",window.location.pathname),P_=null;const e=Ro.has(io);xows_doc("edit_bt_upld").disabled=!e,e&&xows_tpl_embed_add_upld(Ro.get(io)[0]);const o=Ro.has(co);xows_doc("tab_room").disabled=!o}}function xows_gui_disconnect(){P_&&xows_cli_chatstate_define(P_,se),xows_gui_call_terminate(),xows_cli_disconnect()}function xows_gui_cli_ontimeout(){document.hidden||(xows_log(2,"gui_cli_ontimeout","connection timeout","disconnecting"),xows_gui_disconnect(),xows_gui_reset(),xows_gui_page_auth_open(),xows_doc_mbox_open(_,"Connection lost"))}function xows_gui_cli_onclose(e,o){if(xows_log(2,"gui_cli_onclose","connexion cloded","("+e+") "+o),e==s)return G_=!0,xows_doc_mbox_close(),void xows_gui_page_wait_open("Connecting...");R_||(xows_gui_reset(),xows_gui_page_auth_open()),o&&xows_doc_mbox_open(e,o)}function xows_gui_cli_onerror(e,o){xows_doc_mbox_open(e,o)}function xows_gui_nav_onpopstate(e){xows_cli_connected()&&!xows_doc_mbox_modal()&&(history.forward(),xows_gui_mbox_exit_open())}function xows_gui_wnd_onfocus(e){switch(e.type){case"focus":case"blur":O_||xows_cli_activity_wakeup();break;case"visibilitychange":_t&&!document.hidden&&xows_cli_reconnect(10)}O_=document.hasFocus()}let V_=null;function xows_gui_notify_query_handle(e){let o;for(const e in a_)(o=xows_cli_peer_get(e))&&xows_gui_chat_noti_update(o);"granted"===e&&V_&&(xows_gui_notify_push(V_.peer,V_.body),V_=null)}function xows_gui_notify_query(){"granted"!==Notification.permission&&Notification.requestPermission().then(xows_gui_notify_query_handle)}function xows_gui_notify_permi(e){return Notification.permission===e}function xows_gui_notify_push(e,o){if(e.noti)switch(xows_log(2,"gui_notify_push",e.name,Notification.permission),Notification.permission){case"denied":return;case"granted":{const t=xows_cach_avat_get(e.avat);new Notification(e.name,{body:o,icon:t||"/"+ns.root+"/icon.svg"});xows_gui_sound_play("notify")}break;default:V_={peer:e,body:o},xows_gui_notify_query()}}let W_=[];function xows_gui_title_push(e){W_.push(document.title),document.title=e}function xows_gui_title_pop(){document.title=W_.pop()}const J_=new Array(256);function xows_gui_wnd_onkey(e){if(xows_cli_activity_wakeup(),J_[e.keyCode]="keydown"===e.type,"keydown"===e.type&&(27===e.keyCode&&(xows_gui_mesg_edit_close(e.target),xows_gui_mesg_trsh_abort(e.target)),13===e.keyCode)){if(J_[16])return;switch(e.preventDefault(),e.target.tagName){case"CHAT-INPT":xows_gui_chat_inpt_enter(e.target);break;case"STAT-INPT":xows_gui_stat_inpt_enter(e.target);break;case"HEAD-META":xows_gui_meta_inpt_enter(e.target);break;case"MESG-INPT":xows_gui_mesg_edit_valid(e.target)}}}function xows_gui_reset(){xows_log(2,"gui_reset","reset DOM states"),xows_doc_hide("scr_page"),xows_doc_hide("scr_main"),xows_doc_page_close(!0),xows_doc_menu_close(),xows_doc_view_close(),xows_doc_mbox_close(),xows_doc_cls_rem("main_wrap","COLR-WIDE"),xows_doc_cls_rem("main_wrap","COLL-WIDE"),xows_doc_cls_add("main_colr","COL-HIDE"),xows_doc("subs_ul").innerHTML="",xows_doc("cont_ul").innerHTML="",xows_doc("book_ul").innerHTML="",xows_doc("room_ul").innerHTML="",xows_doc("priv_ul").innerHTML="",xows_doc("tab_room").disabled=!0,xows_gui_rost_switch("tab_cont");const e=xows_doc("room_noti");e.dataset.mesg=0,e.dataset.call=0,e.dataset.ring=0,e.innerText="";const o=xows_doc("cont_noti");o.dataset.mesg=0,o.dataset.call=0,o.dataset.ring=0,o.innerText="",xows_doc("self_show").dataset.show=0,xows_doc("self_name").innerText="",xows_doc("self_meta").innerText="",xows_doc("self_avat").className="",xows_gui_switch_peer(null),xows_doc_cls_add("chat_inpt","PLACEHOLD"),xows_doc("chat_inpt").innerText="",xows_doc_frag_clear(),xows_doc_frag_export(U_,"chat_head",!0),xows_doc_frag_export(U_,"chat_hist",!0),xows_doc_frag_export(U_,"chat_panl",!0),xows_doc_frag_export(U_,"room_head",!0),xows_doc_frag_export(U_,"occu_list",!0),R_=!0}function xows_gui_switch_peer(e){const o=P_;if(o){if(e===o.bare)return;xows_cli_chatstate_define(o,se),xows_gui_upld_onclose()}const t=e?xows_cli_peer_get(e):null;o&&(xows_gui_peer_doc_export(o),t&&t.type===o.type&&document.getElementById(o.bare).classList.remove("SELECTED"));const _=xows_doc("chat_fram");if(_.hidden=null===t,_.classList.toggle("CALL-OPEN",Z_.has(t)),o&&xows_gui_title_pop(),t){P_=t,document.getElementById(t.bare).classList.add("SELECTED"),xows_gui_peer_doc_import(t);const e=t.type===zo;_.classList.toggle("CHAT-ROOM",e),_.classList.toggle("CHAT-CONT",!e),xows_doc_cls_tog("main_colr","COL-HIDE",!e),e&&(t.join||xows_cli_muc_join(t)),xows_doc_hidden("hist_ul")&&(xows_doc_show("hist_ul"),xows_gui_peer_scroll_adjust(t),xows_gui_mam_query(t,!1,j_,0)),xows_gui_unread_reset(t),xows_gui_title_push("@"+t.name+" - XOWS"),xows_log(2,"gui_switch_peer",'peer "'+t.bare+'"',"selected")}else P_&&(xows_log(2,"gui_switch_peer","unselect peer"),P_=null,xows_gui_peer_doc_import(null),xows_doc_cls_add("main_colr","COL-HIDE"))}function xows_gui_panel_close(){xows_doc_cls_rem("main_wrap","COLR-WIDE"),xows_doc_cls_rem("main_wrap","COLL-WIDE")}function xows_gui_main_open(){xows_doc_hidden("scr_page")||(xows_doc_page_close(!0),xows_doc_hide("scr_page"),xows_doc_menu_close(),xows_doc_view_close(),xows_doc_show("scr_main")),xows_gui_panel_close(),xows_doc_hidden("chat_fram")&&xows_gui_title_push(xows_l10n_get("Home")+" - XOWS")}function xows_gui_mbox_exit_onabort(){}function xows_gui_mbox_exit_onvalid(){xows_cli_flyyoufools(),history.back()}function xows_gui_mbox_exit_open(){xows_doc_mbox_open(x_,"Do you really want to disconnect current session ?",xows_gui_mbox_exit_onvalid,"Yes",xows_gui_mbox_exit_onabort,"No",!0)}const Y_={};function xows_gui_mbox_subs_edit_onabort(){Y_.bare=null,Y_.name=null}function xows_gui_mbox_subs_edit_onvalid(){xows_cli_rost_edit(Y_.bare,Y_.name),Y_.bare=null,Y_.name=null}function xows_gui_mbox_subs_edit_open(e,o){let t,_;Y_.bare=e,o?(Y_.name=o,_=p_,t="Add contact and request authorisation ?"):(_=x_,t="Remove contact and revoke authorization ?"),xows_doc_mbox_open(_,t,xows_gui_mbox_subs_edit_onvalid,"OK",xows_gui_mbox_subs_edit_onabort,"Cancel",!0)}const X_={};function xows_gui_mbox_subs_auth_onabort(){xows_cli_subscribe_allow(X_.bare,!1),X_.bare=null,X_.name=null}function xows_gui_mbox_subs_auth_onvalid(){xows_cli_subscribe_allow(X_.bare,!0,X_.name),X_.bare=null,X_.name=null}function xows_gui_mbox_subs_auth_open(e,o){X_.bare=e,X_.name=o,xows_doc_mbox_open(p_,"Allow contact subscription ?",xows_gui_mbox_subs_auth_onvalid,"Allow",xows_gui_mbox_subs_auth_onabort,"Deny",!0)}let K_=null;function xows_gui_mbox_bookmark_onabort(){K_=null}function xows_gui_mbox_bookmark_onvalid(){xows_cli_book_publish(K_),K_=null}function xows_gui_mbox_bookmark_open(e){K_=e,xows_doc_mbox_open(p_,"Add Room to bookmarks ?",xows_gui_mbox_bookmark_onvalid,"Add Bookmark",xows_gui_mbox_bookmark_onabort,"Cancel",!0)}function xows_gui_rost_tabs_onclick(e){xows_cli_activity_wakeup();const o=e.target.closest("ROST-TAB");o&&xows_gui_rost_switch(o.id)}function xows_gui_rost_widen(){xows_cli_activity_wakeup(),window.matchMedia("(max-width: 799px)").matches&&(xows_doc_cls_has("main_wrap","COLL-WIDE")||(xows_doc_cls_rem("main_wrap","COLR-WIDE"),xows_doc_cls_add("main_wrap","COLL-WIDE")))}function xows_gui_rost_switch(e){let o,t=!1;const _="tab_room"===e;_&&!xows_doc_cls_has("tab_room","SELECTED")&&(t=!0,o=xows_doc("room_list"));const s="tab_cont"===e;if(s&&!xows_doc_cls_has("tab_cont","SELECTED")&&(t=!0,o=xows_doc("cont_list")),!t)return;let n;xows_doc_cls_tog("tab_cont","SELECTED",s),xows_doc("rost_cont").hidden=!s,xows_doc_cls_tog("tab_room","SELECTED",_),xows_doc("rost_room").hidden=!_,o&&(n=o.querySelector(".SELECTED")),xows_gui_switch_peer(n?n.id:null)}function xows_gui_calling_set(e,o){const t=document.getElementById(e.bare);t&&(t.querySelector("badg-call").hidden=!o,e.type===Uo?xows_doc("cont_call").hidden=!o:xows_doc("room_call").hidden=!o)}function xows_gui_unread_tab_update(e,o,t,_){let s,n;e.type===zo?(s=xows_doc("tab_room"),n=xows_doc("room_noti")):(s=xows_doc("tab_cont"),n=xows_doc("cont_noti"));let i=parseInt(n.dataset.mesg);o&&(i+=o,n.dataset.mesg=i);let r=parseInt(n.dataset.call);t&&(r+=t,n.dataset.call=r);let c=parseInt(n.dataset.ring);_&&(c+=_,n.dataset.ring=c),s.classList.toggle("RINGING",c>0);let a=i>0||r>0||c>0;n.hidden=!a}function xows_gui_unread_add(e,o){const t=document.getElementById(e.bare);if(!t)return;const _=t.querySelector("BADG-NOTI");_.dataset.mesg=parseInt(_.dataset.mesg)+1,xows_gui_unread_tab_update(e,1)}function xows_gui_unread_call(e,o){const t=document.getElementById(e.bare);if(!t)return;t.classList.toggle("RINGING",o);const _=t.querySelector("BADG-NOTI"),s=parseInt(_.dataset.ring)>0;_.dataset.ring=o?1:0,_.dataset.call=o?0:1,xows_gui_unread_tab_update(e,null,o?0:1,o?1:s?-1:0)}function xows_gui_unread_reset(e){const o=document.getElementById(e.bare);if(!o)return;o.classList.remove("RINGING");const t=o.querySelector("BADG-NOTI"),_=-parseInt(t.dataset.mesg),s=-parseInt(t.dataset.ring),n=-parseInt(t.dataset.call);t.dataset.mesg=0,t.dataset.ring=0,t.dataset.call=0,t.hidden=!0,xows_gui_unread_tab_update(e,_,n,s)}function xows_gui_rost_fram_onclick(e){if(xows_cli_activity_wakeup(),e.target.closest("HEAD-ACTS")){switch(e.target.id){case"cont_bt_add":xows_gui_page_cont_open();break;case"room_bt_add":xows_gui_page_join_open();break;case"room_bt_upd":xows_gui_room_list_reload()}return}const o=e.target.closest("LI-PEER");if(o){if("BUTTON"===e.target.tagName)switch(e.target.name){case"cont_bt_rtry":return xows_cli_subscribe_request(o.id),void xows_doc_mbox_open(w_,"New authorization request was sent");case"cont_bt_unsb":return void xows_gui_mbox_subs_edit_open(o.id)}"PEER-PEND"!==o.className?(xows_gui_switch_peer(o.id),xows_gui_panel_close()):xows_gui_mbox_subs_auth_open(o.id,o.name)}}function xows_gui_cont_list_reload(){xows_gui_switch_peer(null),xows_doc("subs_ul").hidden=!0,xows_doc("subs_ul").innerText="",xows_doc("cont_ul").hidden=!0,xows_doc("cont_ul").innerText="",xows_doc_cls_add("cont_list","LOADING"),xows_cli_rost_get_query()}function xows_gui_cli_oncontpush(e){if(null===e)return void xows_doc_cls_rem("cont_list","LOADING");const o=document.getElementById(e.bare);if(o){if(!o.classList.contains("PEER-PEND"))return xows_tpl_update_rost_cont(o,e.name,e.avat,e.subs,e.show,e.stat),xows_gui_chat_head_update(e),xows_gui_hist_update(e,e),void(e.show<1&&xows_gui_cli_onchatstate(e,0));{const e=xows_doc("subs_ul");e.removeChild(o);const t=e.childElementCount;e.hidden=!t,xows_doc("cont_noti").dataset.subs=t}}const t=xows_doc("cont_ul");t.hidden&&(t.classList.remove("LOADING"),t.hidden=!1),t.appendChild(xows_tpl_spawn_rost_cont(e.bare,e.name,e.avat,e.subs,e.show,e.stat)),xows_gui_peer_doc_init(e)}function xows_gui_cli_oncontrem(e){const o=xows_doc("cont_ul"),t=document.getElementById(e);t&&t.parentNode===o&&(P_&&P_.bare===e&&xows_gui_switch_peer(null),o.removeChild(t),o.hidden=!o.childElementCount,xows_doc_frag_delete(e))}function xows_gui_cli_onsubspush(e,o){if(document.getElementById(e))return;const t=xows_doc("subs_ul");t.appendChild(xows_tpl_spawn_rost_subs(e,o));const _=t.childElementCount;t.hidden=!_,xows_doc("cont_noti").dataset.subs=_}function xows_gui_cli_onsubsrem(e){const o=xows_doc("subs_ul"),t=document.getElementById(e);if(t&&t.parentNode===o){o.removeChild(t);const e=o.childElementCount;o.hidden=!e,xows_doc("cont_noti").dataset.subs=e}}function xows_gui_room_list_reload(){P_&&P_.publ&&xows_gui_switch_peer(null),xows_doc_hide("room_ul"),xows_doc("room_ul").innerHTML="",xows_doc_cls_add("room_list","LOADING"),setTimeout(xows_cli_muc_discoitems_query,500)}function xows_gui_cli_onroompush(e){if(!e)return void xows_doc_cls_rem("room_list","LOADING");const o=e.publ?xows_doc("room_ul"):e.book?xows_doc("book_ul"):xows_doc("priv_ul"),t=document.getElementById(e.bare);if(t){if(t.parentNode!==o){const e=t.parentNode;o.appendChild(t),e.hidden=!e.childElementCount}xows_tpl_update_rost_room(t,e.name,e.desc,e.lock),xows_gui_chat_head_update(e)}else o.appendChild(xows_tpl_spawn_rost_room(e.bare,e.name,e.desc,e.lock)),xows_gui_peer_doc_init(e);o.hidden=!1}function xows_gui_cli_onroomrem(e){const o=document.getElementById(e);if(o){P_&&P_.bare===e&&xows_gui_switch_peer(null);const t=o.parentNode;t.removeChild(o),t.hidden=t.childNodes.length<2,xows_doc_frag_delete(e)}}function xows_gui_cli_onselfchange(e){const o=xows_doc("user_panl");xows_doc("self_show").dataset.show=e.show,xows_tpl_spawn_avat_cls(e.avat);const t=o.querySelectorAll("PEER-AVAT");for(let o=0;o<t.length;++o)t[o].className="h-"+e.avat;const _=o.querySelectorAll("PEER-NAME");for(let o=0;o<_.length;++o)_[o].innerText=e.name;const s=o.querySelectorAll("PEER-META");for(let o=0;o<s.length;++o)s[o].innerText=e.stat,s[o].className=e.stat?"":"PLACEHOLD";const n=o.querySelectorAll("PEER-ADDR");for(let o=0;o<n.length;++o)n[o].innerText=e.bare;let i=Jo.length;for(;i--;)xows_gui_hist_update(Jo[i],e);for(i=Yo.length;i--;)xows_gui_hist_update(Yo[i],e)}function xows_gui_user_panl_onclick(e){xows_cli_activity_wakeup(),"self_bt_conf"===e.target.id&&xows_gui_page_user_open(),e.target.closest("#menu_show")&&xows_doc_menu_toggle(xows_doc("menu_show"),"drop_show",xows_gui_menu_show_onclick)}function xows_gui_menu_show_onclick(e){xows_cli_activity_wakeup(),xows_doc_menu_toggle(xows_doc("menu_show"),"drop_show"),"self_bt_edit"===e.target.id&&xows_gui_page_user_open(),e.target.closest("#menu_stat")&&xows_gui_ibox_stat_open();const o=e.target.closest("LI");if(o){const e=parseInt(o.value);if(!(e>0))return void xows_gui_disconnect();xows_cli_show_select(e)}}function xows_gui_ibox_stat_ovalid(e){e!=Wo.stat&&xows_cli_status_define(e)}function xows_gui_ibox_stat_open(){xows_doc_ibox_open(xows_l10n_get("Edit status message"),xows_l10n_get("Indicate anything you want to mention about your current situation."),xows_l10n_get("Enter a status message..."),Wo.stat,xows_gui_ibox_stat_ovalid,null,!0)}function xows_gui_chat_cnfg_update(e){e.role;xows_gui_peer_doc(e,"chat_bt_subj").hidden=e.role<po,xows_gui_peer_doc(e,"chat_bt_cnfg").hidden=e.affi<bo}function xows_gui_chat_noti_update(e){const o=xows_gui_peer_doc(e,"chat_bt_noti"),t=e.noti&&xows_gui_notify_permi("granted");o.title=xows_l10n_get(t?"Disable notifications":"Enable notifications"),o.classList.toggle("DISABLED",!t)}function xows_gui_chat_head_update(e){xows_gui_peer_doc(e,"chat_titl").innerText=e.name;const o=xows_gui_peer_doc(e,"meta_inpt");if(e.type===Uo){o.innerText=e.stat,xows_gui_peer_doc(e,"chat_show").dataset.show=e.show;const t=xows_cli_external_has("stun","turn");xows_gui_peer_doc(e,"chat_bt_cala").hidden=!(xows_gui_medias_has("audioinput")&&t),xows_gui_peer_doc(e,"chat_bt_calv").hidden=!(xows_gui_medias_has("videoinput")&&t)}else o.innerText=e.subj,o.className=e.subj?"":"PLACEHOLD",xows_gui_peer_doc(e,"chat_bt_bkmk").hidden=e.book||e.publ}function xows_gui_chat_head_onclick(e){switch(xows_cli_activity_wakeup(),e.target.id){case"chat_bt_subj":xows_gui_ibox_subj_open(P_);break;case"chat_bt_bkmk":P_&&xows_gui_mbox_bookmark_open(P_);break;case"chat_bt_noti":P_.noti=!e.target.classList.toggle("DISABLED"),xows_cach_peer_save(P_.bare,null,null,null,P_.noti),xows_gui_notify_permi("granted")?xows_gui_chat_noti_update(P_):xows_gui_notify_query();break;case"chat_bt_cnfg":xows_cli_muc_getcfg_query(P_,xows_gui_page_room_open);break;case"chat_bt_occu":window.matchMedia("(max-width: 799px)").matches?xows_doc_cls_add("main_wrap","COLR-WIDE"):xows_doc_cls_tog("main_colr","COL-HIDE");break;case"chat_bt_calv":case"chat_bt_cala":{const o="chat_bt_calv"===e.target.id;xows_gui_call_invite(P_,{audio:!0,video:o});break}}}let $_=null;function xows_gui_ibox_subj_onvalid(e){const o=$_,t=e.trimEnd();t!=o.subj&&xows_cli_muc_set_subject(o,t)}function xows_gui_ibox_subj_open(e){e.type===zo&&($_=e,xows_doc_ibox_open(xows_l10n_get("Set topic of")+" #"+e.name,xows_l10n_get("Set the message of the day, a welcome message or the discussion subject."),xows_l10n_get("Enter a topic..."),e.subj,xows_gui_ibox_subj_onvalid,null,!0))}function xows_gui_cli_onsubject(e,o){const t=xows_gui_peer_doc(e,"meta_inpt");t.innerText=o||"",t.className=o?"":"PLACEHOLD"}function xows_gui_call_menu_onclick(e){if(xows_cli_activity_wakeup(),"BUTTON"!==e.target.tagName)return;let o;switch(e.target.id){case"call_bt_spk":o=e.target.classList.toggle("MUTTED"),M_.vol.gain.value=o?0:parseInt(call_in_vol.value)/100,xows_doc("call_in_vol").disabled=o,xows_gui_sound_play(o?"mute":"unmute");break;case"call_bt_cam":xows_gui_call_input_enable(!(o=e.target.classList.toggle("MUTTED")),"video"),xows_gui_sound_play(o?"disable":"enable");break;case"call_bt_mic":xows_gui_call_input_enable(!(o=e.target.classList.toggle("MUTTED")),"audio"),xows_gui_sound_play(o?"disable":"enable");break;case"call_bt_hup":xows_gui_call_terminate(P_,"success");break;case"call_bt_geo":xows_doc("chat_fram").classList.toggle("CALL-FULL")}}function xows_gui_call_in_vol_oninput(e){const o=parseInt(e.target.value)/100;M_.vol.gain.value=o,xows_log(2,"gui_call_in_vol_oninput","volume",o);let t="";o>.66?t="RNG-MAX":o<.33&&(t="RNG-MIN"),xows_doc("call_bt_spk").className=t}let Q_=null;function xows_gui_chat_call_fx(){const e=xows_doc("call_grid").querySelectorAll("audio");for(let o=0;o<e.length;++o){e[o].fftNode.getFloatTimeDomainData(e[o].fftBuff);let t,_=0;for(let s=0;s<e[o].fftBuff.length;s++)(t=Math.abs(e[o].fftBuff[s]))>_&&(_=t);const s=_>.08?"var(--link-base)":"var(--text-tone3)";e[o].parentNode.style.borderColor!==s&&(e[o].parentNode.style.borderColor=s)}}function xows_gui_chat_call_open(){const e=xows_doc("call_bt_spk"),o=xows_doc("call_in_vol");e.className="",o.disabled=!1,o.value=50,M_.vol.gain.value=parseInt(xows_doc("call_in_vol").value)/100;const t=es.constraints.video,_=xows_doc("call_bt_mic");if(_.classList.remove("MUTTED"),t){xows_doc("call_bt_cam");_.classList.remove("MUTTED")}xows_doc("call_bt_cam").hidden=!t,xows_doc_listener_add(xows_doc("call_menu"),"click",xows_gui_call_menu_onclick),xows_doc_listener_add(xows_doc("call_in_vol"),"input",xows_gui_call_in_vol_oninput),xows_doc_cls_add("chat_fram","CALL-OPEN")}function xows_gui_chat_call_close(){Q_&&(clearInterval(Q_),Q_=null),M_.vol.gain.value=0,xows_doc_listener_rem(xows_doc("call_menu"),"click",xows_gui_call_menu_onclick),xows_doc_listener_rem(xows_doc("call_in_vol"),"input",xows_gui_call_in_vol_oninput),xows_doc("call_bt_geo").title=xows_l10n_get("Expand"),xows_doc("chat_fram").classList.remove("CALL-OPEN","CALL-FULL"),xows_doc("call_grid").innerHTML=""}function xows_gui_chat_call_add_stream(e,o){const t=xows_doc("call_grid"),_=e===Wo,s=o.getVideoTracks().length;if(s&&_)return;const n=_?e.jid:e.call;let i,r=t.querySelector("div[jid='"+n+"']");r?r.firstChild.srcObject=o:((i=s?(r=xows_tpl_spawn_stream_video(n,e.name,e.avat)).querySelector("video"):(r=xows_tpl_spawn_stream_audio(n,e.name,e.avat)).querySelector("audio")).muted=!0,i.srcNode=M_.ctx.createMediaStreamSource(o),s||(i.fftNode=M_.ctx.createAnalyser(),i.fftNode.fftSize=2048,i.fftBuff=new Float32Array(i.fftNode.frequencyBinCount),i.srcNode.connect(i.fftNode),Q_||(Q_=setInterval(xows_gui_chat_call_fx,50))),_||i.srcNode.connect(M_.vol),i.srcObject=o,i.autoplay=!0,_?t.insertBefore(r,t.firstChild):t.appendChild(r))}function xows_gui_hist_ring_onclick(e){switch(xows_gui_hist_ring_close(),xows_gui_sound_stop("ringbell"),e.target.id){case"ring_bt_pkup":xows_gui_call_accept(P_);break;case"ring_bt_deny":xows_gui_call_terminate(P_,"decline")}}function xows_gui_hist_ring_open(e,o,t){const _=xows_gui_peer_doc(e,"hist_ring"),s=!!t&&t.video;let n,i,r,c;switch(o){case"decline":n="CALL-TERM",i=xows_l10n_get("The call has been declined");break;case"buzy":n="CALL-TERM",i=xows_l10n_get("The other person is buzy");break;case"success":n="CALL-TERM",i=xows_wrtc_linked()?xows_l10n_get("The other person has hung up"):xows_l10n_get("You missed a call");break;case"initiate":n=s?"CALL-VID":"CALL-AUD",i=xows_l10n_get("Call in progress..."),r=!0;break;case"incall":n=s?"CALL-VID":"CALL-AUD",i=xows_l10n_get(s?"Incoming video call...":"Incoming audio call..."),r=!0,c=!0;break;default:n="CALL-TERM",i=xows_l10n_get("Unexpected end of call")+": "+xows_l10n_get(o)}_.querySelector("RING-ICON").className=n,_.querySelector("RING-TEXT").innerText=i,xows_gui_peer_doc(e,"ring_bt_deny").hidden=!r,xows_gui_peer_doc(e,"ring_bt_pkup").hidden=!c,xows_gui_peer_doc(e,"ring_bt_clos").hidden=r,_.classList.toggle("RINGING",r),_.hidden=!1,xows_gui_peer_scroll_down(e)}function xows_gui_hist_ring_close(){xows_doc("hist_ring").hidden=!0}const Z_=new Map,es={sdp:null,sid:null,constraints:null,stream:null};function xows_gui_call_clear(){if(xows_gui_chat_call_close(),es.stream){const e=es.stream.getTracks();let o=e.length;for(;o--;)e[o].stop();es.stream=null}es.sdp=null,es.sid=null,xows_gui_sound_stop("ringtone"),xows_gui_sound_stop("ringbell"),xows_gui_sound_play("hangup"),xows_wrtc_clear()}function xows_gui_call_terminate(e,o){if(o&&xows_cli_jing_terminate(e,o),!Z_.has(e))return;xows_gui_peer_doc(e,"chat_bt_cala").disabled=!1,xows_gui_peer_doc(e,"chat_bt_calv").disabled=!1,xows_gui_calling_set(e,!1);const t=Z_.get(e);if(t.stream){const e=t.stream.getTracks();let o=e.length;for(;o--;)e[o].stop();t.stream=null}Z_.delete(e),Z_.size||xows_gui_call_clear()}function xows_gui_call_accept(e){if(!Z_.has(e))return;const o=xows_sdp_get_medias(Z_.get(e).sdp);xows_gui_call_input_ask({audio:o.audio&&xows_gui_medias_has("audioinput"),video:o.video&&xows_gui_medias_has("videoinput")})}function xows_gui_call_invite(e,o){Z_.has(e)||(Z_.set(e,{sid:null,sdp:null,stream:null}),xows_gui_call_input_ask(o))}function xows_gui_call_input_enable(e,o){if(es.stream){const t=es.stream;let _=null;switch(o){case"video":_=t.getVideoTracks();break;case"audio":_=t.getAudioTracks();break;default:_=t.getTracks()}if(_)for(let o=0;o<_.length;++o)_[o].enabled=e}}function xows_gui_call_input_error(){const e=xows_l10n_get("Unable to get device stream for media call session");xows_doc_mbox_open(n,e,xows_gui_call_media_get,"Retry",xows_gui_chat_call_close,"Cancel")}function xows_gui_call_input_setup(e){es.stream=e,xows_gui_chat_call_add_stream(Wo,e),xows_wrtc_ready()||xows_wrtc_setup(xows_cli_external_get("stun","turn"),xows_gui_wrtc_onlinked,xows_gui_wrtc_onerror),xows_wrtc_has_remote()||(xows_gui_hist_ring_open(P_,"initiate",es.constraints),xows_gui_sound_play("ringtone")),xows_wrtc_local_stream(e,xows_gui_wrtc_onsdp);for(const e of Z_.keys())xows_gui_peer_doc(e,"chat_bt_cala").disabled=!0,xows_gui_peer_doc(e,"chat_bt_calv").disabled=!0}function xows_gui_call_input_ask(e){H_?(es.constraints=e,navigator.mediaDevices.getUserMedia(e).then(xows_gui_call_input_setup,xows_gui_call_input_error)):xows_log(1,"gui_call_input_ask","Feature unavailable")}function xows_gui_wrtc_onerror(e){xows_doc_mbox_open(n,"Call session error: "+e),xows_gui_hist_ring_close(),xows_gui_call_terminate()}function xows_gui_wrtc_onsdp(e){es.sdp=e;const o=!xows_wrtc_has_remote();for(const t of Z_.keys())o?xows_cli_jing_initiate_sdp(t,e):xows_cli_jing_accept_sdp(t,e)}function xows_gui_wrtc_onstream(e,o){Z_.get(o).stream=e,xows_gui_chat_call_add_stream(o,e),xows_wrtc_has_local()&&xows_gui_hist_ring_close()}function xows_gui_wrtc_onlinked(){xows_gui_sound_stop("ringtone"),xows_gui_sound_stop("ringbell");for(const e of Z_.keys())xows_gui_calling_set(e,!0);xows_gui_chat_call_open()}function xows_gui_cli_oncallerror(e,o){xows_doc_mbox_open(n,"Call session error: "+o),xows_gui_hist_ring_close();for(const e of Z_.keys())xows_gui_call_terminate(e,"failed-application");xows_gui_call_clear()}function xows_gui_cli_oncallinit(e,o,t){xows_wrtc_busy()?xows_gui_call_terminate(e,"busy"):(Z_.set(e,{sid:o,sdp:t,stream:null}),xows_wrtc_ready()||xows_wrtc_setup(xows_cli_external_get("stun","turn"),xows_gui_wrtc_onlinked,xows_gui_wrtc_onerror),xows_wrtc_remote_sdp(t,xows_gui_wrtc_onstream,e),xows_gui_hist_ring_open(e,"incall",xows_sdp_get_medias(t)),e!==P_&&xows_gui_unread_call(e,!0),xows_gui_sound_play("ringbell"))}function xows_gui_cli_oncallaccept(e,o,t){if(!Z_.has(e))return void xows_log(1,"gui_cli_oncallaccept","accept from unknown remote",e.bare);Z_.get(e).sdp=t,xows_wrtc_remote_sdp(t,xows_gui_wrtc_onstream,e)}function xows_gui_cli_oncallend(e,o,t){xows_gui_hist_ring_open(e,t),e!==P_&&xows_gui_unread_call(e,!1),xows_gui_call_terminate(e,null)}function xows_gui_chat_main_onscroll(e){const o=xows_doc("chat_main");if(o.scrollHeight===o.clientHeight)return;xows_gui_peer_scroll_save(P_),o.scrollTop<.8*xows_doc("hist_beg").offsetHeight&&xows_gui_mam_query(P_,!1,j_),o.scrollSaved>o.clientHeight&&xows_gui_chat_nav_open(P_);const t=xows_doc("hist_end");t.hidden?o.scrollSaved<50&&xows_gui_chat_nav_close(P_):o.scrollSaved<.8*t.offsetHeight&&xows_gui_mam_query(P_,!0,j_)}function xows_gui_chat_hist_onclick(e){if(xows_cli_activity_wakeup(),e.target.id&&e.target.id.startsWith("ring"))return void xows_gui_hist_ring_onclick(e);if("IMG"===e.target.tagName)return void xows_doc_view_open(e.target);const o=e.target.closest("MESG-RPLY");if(o)return void xows_gui_hist_mesg_focus(P_,o.dataset.ref);const t=e.target.closest("LI-MESG");if(t){if(e.type.startsWith("touch")){const e=xows_doc("hist_ul").querySelector("LI-MESG.SELECTED");e&&e.classList.remove("SELECTED"),mesg&&mesg.classList.add("SELECTED")}if("BUTTON"===e.target.tagName&&e.target.name)switch(e.target.name){case"mesg_bt_edit":xows_gui_mesg_edit_open(t);break;case"edit_bt_abort":xows_gui_mesg_edit_close(t);break;case"edit_bt_valid":xows_gui_mesg_edit_valid(t.querySelector("MESG-INPT"));break;case"mesg_bt_trsh":xows_gui_mesg_trsh_open(t);break;case"trsh_bt_abort":xows_gui_mesg_trsh_abort(t);break;case"trsh_bt_valid":xows_gui_mesg_trsh_valid(t);break;case"mesg_bt_rply":xows_gui_chat_rply_set(t)}else;}}function xows_gui_mesg_edit_close(e){let o;(o=e&&"LI-MESG"===e.tagName?e:xows_doc("chat_hist").querySelector(".MESG-EDITOR"))&&xows_tpl_mesg_edit_remove(o)}function xows_gui_mesg_edit_open(e){xows_gui_mesg_edit_close();const o=xows_tpl_mesg_edit_insert(e).querySelector("MESG-INPT");xows_doc_caret_at(o),o.focus()}function xows_gui_mesg_edit_valid(e){const o=e.closest("LI-MESG"),t=e.innerText.trimEnd();if(t!==o.querySelector("MESG-BODY").dataset.raw){const e=o.querySelector("MESG-RPLY");xows_cli_send_message(P_,t,o.dataset.id,e.dataset.id,e.dataset.to)}xows_tpl_mesg_edit_remove(o)}function xows_gui_mesg_trsh_abort(e){let o;(o=e&&"LI-MESG"===e.tagName?e:xows_doc("chat_hist").querySelector(".MESG-TRASH"))&&xows_tpl_mesg_trsh_remove(o)}function xows_gui_mesg_trsh_open(e){xows_gui_mesg_trsh_abort(),xows_tpl_mesg_trsh_insert(e)}function xows_gui_mesg_trsh_valid(e){let o=null;P_.type===zo?e.dataset.stnzid&&(o=e.dataset.stnzid):e.dataset.origid&&(o=e.dataset.origid),o&&xows_cli_retract_send(P_,o)}function xows_gui_chat_main_onresize(e,o){P_&&xows_gui_peer_scroll_adjust(P_)}function xows_gui_hist_update(e,o){const t=xows_gui_peer_doc(e,"hist_ul");if(!t||!t.childNodes.length)return;const _=xows_cli_peer_iden(o);let s;const n=t.querySelectorAll("MESG-FROM[data-peer='"+_+"'],RPLY-FROM[data-peer='"+_+"']");for(s=n.length;s--;)o.name!=n[s].innerText&&(n[s].innerText=o.name);if(!o.avat)return;const i=xows_tpl_spawn_avat_cls(o.avat),r=t.querySelectorAll("MESG-AVAT[data-peer='"+_+"'],RPLY-AVAT[data-peer='"+_+"']");for(s=r.length;s--;)i!=r[s].className&&(r[s].className=i)}function xows_gui_hist_mesg_get(e,o){const t=e===P_?document.getElementById("hist_ul"):xows_doc_frag_element_find(e.bare,"chat_hist","hist_ul");let _=t.querySelector("LI-MESG[data-id='"+o+"']");return _||(_=e.type===zo?t.querySelector("LI-MESG[data-stnzid='"+o+"']"):t.querySelector("LI-MESG[data-origid='"+o+"']")),_}function xows_gui_hist_mesg_discard(e,o){const t=xows_gui_hist_mesg_get(e,o);return t?(t.hidden=!0,t.innerHTML="",t):null}function xows_gui_hist_mesg_retract(e,o){const t=xows_gui_hist_mesg_get(e,o);if(!t)return;t.hidden=!0,t.innerHTML="";const _=t.nextSibling;_&&_.dataset.from===t.dataset.from&&_.classList.toggle("MESG-APPEND",t.classList.contains("MESG-APPEND"))}function xows_gui_hist_mesg_focus(e,o){const t=xows_gui_peer_doc(e,"hist_ul").querySelector(".FOCUS");if(t&&t.classList.remove("FOCUS"),!o)return;const _=xows_gui_hist_mesg_get(e,o);_&&(_.classList.add("FOCUS"),e===P_&&_.offsetTop-xows_doc("chat_main").scrollTop<0&&_.scrollIntoView({behavior:"smooth",block:"center"}))}function xows_gui_cli_onmessage(e,o,t){const _=e===Wo;if(e.type===zo){const t=xows_gui_hist_mesg_get(e,o.stnzid?o.stnzid:o.id);if(t)return void xows_tpl_mesg_update(t,o,!0)}let s,n;if(!o.replace||(s=xows_gui_hist_mesg_discard(e,o.replace))){if(o.replyid&&(n=xows_gui_hist_mesg_get(e,o.replyid)),o.replace||(e!==P_&&xows_gui_unread_add(e,o.id),_||O_||xows_gui_notify_push(e,o.body)),xows_gui_peer_doc(e,"hist_end").hidden||s){const _=xows_gui_peer_doc(e,"hist_ul");_.childNodes.length+1>N_&&(_.removeChild(_.firstChild),xows_gui_peer_doc(e,"hist_beg").className="");const i=xows_tpl_mesg_spawn(e,o,t,_.lastChild,s,n);s?_.insertBefore(i,s.nextSibling):_.appendChild(i)}!_&&xows_gui_peer_scroll_get(e)>=50?xows_gui_chat_nav_open(e,!0):xows_gui_peer_scroll_down(e)}}function xows_gui_cli_onreceipt(e,o){const t=xows_gui_hist_mesg_get(e,o);t?t.classList.add("MESG-RECP"):xows_log(1,"gui_cli_onreceipt","message not found",o)}function xows_gui_cli_onretract(e,o){xows_gui_hist_mesg_retract(e,o)}let os=new Map;function xows_gui_mam_query(e,o,t=20,_=100,s=!1){if(os.has(e.bare))return;const n=xows_gui_peer_doc(e,"hist_ul");if(!n)return;let i,r;if(o){const o=xows_gui_peer_doc(e,"hist_end");if(!s&&o.hidden)return;n.childNodes.length&&(i=parseInt(n.lastChild.dataset.time)+25),o.classList.add("LOADING")}else{const o=xows_gui_peer_doc(e,"hist_beg");if(!s&&o.className.length)return;n.childNodes.length&&(r=parseInt(n.firstChild.dataset.time)-25),o.className="LOADING"}os.set(e.bare,setTimeout(xows_cli_mam_fetch,_,e,t,i,r,xows_gui_mam_parse))}function xows_gui_mam_parse(e,o,t,_){const s=xows_gui_peer_doc(e,"hist_ul");let n=null,i=!0;o.length&&s.childNodes.length&&(s.firstChild.dataset.time>=o[o.length-1].time?n=s.firstChild:i=!1);const r=xows_gui_peer_doc(e,"hist_beg"),c=xows_gui_peer_doc(e,"hist_end");r.className="",c.className="";let a=s.childNodes.length-N_+t;if(a>0)if(i){for(;a--;)s.removeChild(s.lastChild);c.hidden=!1}else{for(;a--;)s.removeChild(s.firstChild);r.className=""}i?xows_gui_peer_scroll_save(e):xows_gui_peer_scroll_adjust(e);let l,u,d,x=0;const w=o.length;for(let t=0;t<w;++t){const _=o[t];if(_.retract){xows_gui_hist_mesg_retract(e,_.retract);continue}if(!_.body)continue;if(xows_gui_hist_mesg_get(e,_.id))continue;if(_.replace){if(!(l=xows_gui_hist_mesg_discard(e,_.replace)))continue}else l=null;const i=xows_tpl_mesg_spawn(e,_,!1,d,l,u=_.replyid?xows_gui_hist_mesg_get(e,_.replyid):null);l?s.insertBefore(i,l.nextSibling):d=s.insertBefore(i,n),x++}xows_log(2,"gui_mam_parse",x+" added messages for",e.bare),_&&(t&&!x&&o[0].id===s.firstChild.dataset.id&&(i=!0),i?r.className="HIST-START":c.hidden=!0),i?xows_gui_peer_scroll_adjust(e):xows_gui_peer_scroll_save(e),os.delete(e.bare)}function xows_gui_upld_progress(e,o){xows_doc("upld_pbar").style.width=o+"%"}function xows_gui_upld_error(e,o){xows_doc_cls_add("upld_text","MBOX-ERR"),xows_doc("upld_text").innerHTML="<b>"+xows_l10n_get("Error")+"</b> : "+o}function xows_gui_upld_load(e,o){xows_cli_send_message(P_,o),xows_doc_hide("hist_upld")}function xows_gui_upld_abort(e){xows_gui_upld_onclose()}function xows_gui_upld_onclose(){xows_doc_listener_rem(xows_doc("upld_exit"),"click",xows_gui_upld_onclose),xows_doc_hide("hist_upld")}function xows_gui_upld_open(e){const o=xows_doc("upld_text");o.classList="",xows_doc("upld_pbar").style.width="0%",o.innerText=e.name,xows_cli_upld_query(e,xows_gui_upld_error,xows_gui_upld_load,xows_gui_upld_progress,xows_gui_upld_abort),xows_doc_listener_add(xows_doc("upld_exit"),"click",xows_gui_upld_onclose),xows_doc_show("hist_upld"),xows_gui_peer_scroll_down(P_)}function xows_gui_chat_file_onchange(e){const o=xows_doc("chat_file").files[0];P_.bare&&o&&xows_gui_upld_open(o)}function xows_gui_chat_panl_onclick(e){switch(xows_cli_activity_wakeup(),e.target.id){case"chat_nav":return xows_gui_chat_nav_close(P_),void xows_gui_peer_scroll_down(P_);case"rply_clos":xows_gui_chat_rply_close();break;case"chat_edit":xows_gui_chat_inpt_focus();break;case"chat_inpt":{const e=xows_doc_sel_rng(0);if(e.collapsed){const o=e.endContainer;if("EMO-JI"===o.parentNode.tagName)return void xows_doc_caret_around(o.parentNode,!e.endOffset)}ts=e;break}case"edit_bt_upld":{const e=xows_doc("chat_file");e.value="",e.click();break}case"edit_bt_emoj":xows_doc_menu_toggle(xows_doc("edit_bt_emoj"),"drop_emoj")}}function xows_gui_chat_nav_open(e,o=!1){const t=xows_gui_peer_doc(e,"chat_nav");t.innerText=xows_l10n_get(o?"New unread messages":"Back to recent messages"),t.classList.toggle("UNDREAD",o),t.hidden=!1}function xows_gui_chat_nav_close(e){xows_gui_peer_doc(e,"chat_nav").hidden=!0}function xows_gui_chat_rply_close(){if(!xows_doc_cls_has("chat_panl","REPLY"))return;xows_doc("chat_panl").classList.remove("REPLY");const e=xows_doc("chat_rply");xows_doc("rply_name").innerText="",e.dataset.id="",e.dataset.to="",xows_gui_hist_mesg_focus(P_,null)}function xows_gui_chat_rply_set(e){xows_gui_chat_rply_close();const o=xows_doc("chat_rply");let t,_,s;P_.type===zo?(s=e.dataset.from,_=e.dataset.stnzid?e.dataset.stnzid:e.dataset.id,t=xows_cli_occu_any(P_,s,e.dataset.occuid)):(s=xows_jid_bare(e.dataset.from),_=e.dataset.origid?e.dataset.origid:e.dataset.id,t=P_),xows_doc("rply_name").innerText=t.name,o.dataset.to=s,o.dataset.id=_,o.hidden=!1,xows_doc("chat_panl").classList.add("REPLY"),xows_gui_hist_mesg_focus(P_,_),xows_gui_chat_inpt_focus()}function xows_gui_chat_inpt_enter(e){if(P_){if(e.innerText.length){const o=xows_doc("chat_rply");xows_cli_send_message(P_,e.innerText.trimEnd(),null,o.dataset.id,o.dataset.to),e.innerText="",xows_gui_chat_rply_close(),e.className="PLACEHOLD"}xows_cli_chatstate_define(P_,ne)}}let ts=null;function xows_gui_chat_inpt_oninput(e){xows_cli_activity_wakeup(),P_&&xows_cli_chatstate_define(P_,ce),ts=xows_doc_sel_rng(0);const o=document.getElementById("chat_inpt");if(o.innerText.length<2&&0===o.innerText.trim().length)return o.className="PLACEHOLD",void(o.innerText="");o.className=""}function xows_gui_chat_inpt_focus(){const e=xows_doc("chat_inpt");e.focus();const o=xows_doc_sel_rng(0);o.endContainer!=e&&xows_doc_caret_around(o.endContainer)}function xows_gui_chat_inpt_insert(e,o){const t=document.getElementById("chat_inpt");ts||(xows_doc_caret_at(t,!0),ts=xows_doc_sel_rng(0));const _=ts;let s;_&&!_.collapsed&&_.deleteContents(),o?(s=document.createElement(o)).appendChild(document.createTextNode(e)):s=document.createTextNode(e),_.insertNode(s),t.classList.remove("PLACEHOLD"),t.focus(),xows_doc_caret_around(s),ts=xows_doc_sel_rng(0)}function xows_gui_drop_emoj_onclick(e){xows_cli_activity_wakeup();const o=e.target.closest("LI");o&&xows_gui_chat_inpt_insert(o.childNodes[0].nodeValue,"EMO-JI")}function xows_gui_cli_onchatstate(e,o){const t=xows_gui_peer_doc(e,"chat_stat");if(e.type===Uo){if(e.chat<ce)return t.innerText="",void(t.hidden=!0);t.innerHTML="<b>"+e.name+"</b> "+xows_l10n_get("is currently writing")}else{const o=e.writ.length;if(o<1)return t.innerText="",void(t.hidden=!0);if(o>1){let _="";const s=o>2?2:o-1;for(let o=0;o<s;++o)_+="<b>"+e.writ[o].name+"</b>",o<s-1&&(_+=", ");_+=" "+xows_l10n_get("and")+" <b>";const n=o-s;_+=n>1?n+" "+xows_l10n_get("other(s)")+"</b> ":e.writ[o-1].name+"</b> ",t.innerHTML=_+xows_l10n_get("are currently writing")}else t.innerHTML="<b>"+e.writ[0].name+"</b> "+xows_l10n_get("is currently writing")}t.hidden=!1}function xows_gui_room_cnfg_update(e,o){const t=e.role>wo,_=xows_gui_peer_doc(e,"occu_bt_kick");_.hidden=!t;const s=xows_gui_peer_doc(e,"occu_bt_cnfg");s.hidden=e.affi<bo,o&&!o.self?(_.disabled=!t,s.disabled=e.affi<o.affi):(_.disabled=!0,s.disabled=!0)}function xows_gui_room_head_update(e){}function xows_gui_occu_switch(e){const o=document.getElementById("occu_list").querySelector(".SELECTED");o&&o.classList.remove("SELECTED"),document.getElementById(e).classList.add("SELECTED");const t=xows_cli_occu_get(P_,e);xows_gui_room_cnfg_update(P_,t)}function xows_gui_room_head_onclick(e){xows_cli_activity_wakeup(),e.target.id}function xows_gui_cli_onoccupush(e,o,t){t&&t.includes(110)&&(xows_gui_page_join_onjoind(e,null,t.includes(201)),xows_gui_chat_cnfg_update(e),xows_gui_room_cnfg_update(e));let _=xows_gui_peer_occu_li(e,o.jid);if(_)xows_tpl_update_room_occu(_,o.name,o.avat,o.full,o.show,o.stat);else{_=xows_tpl_spawn_room_occu(o.jid,o.name,o.avat,o.full,o.show,o.stat);const t=!o.self&&o.full&&!xows_cli_cont_get(o.full);_.querySelector("[name='occu_bt_subs']").hidden=!t;const s=xows_gui_peer_doc(e,o.role===po?"modo_ul":"memb_ul");s.appendChild(_),s.hidden=!1}xows_gui_hist_update(e,o)}function xows_gui_cli_onoccurem(e,o){if(o){const t=xows_gui_peer_occu_li(e,o);if(t){const e=t.parentNode;e.removeChild(t),e.hidden=!e.childElementCount}}else if(e===P_){xows_gui_switch_peer(null);const e=xows_doc("room_list").querySelector(".SELECTED");e&&e.classList.remove("SELECTED")}}function xows_gui_occu_list_onclick(e){xows_cli_activity_wakeup();const o=e.target.closest("PEER-OCCU");if(o){if("BUTTON"===e.target.tagName)switch(e.target.name){case"occu_bt_subs":{const e=bare.split("@")[0],t=e[0].toUpperCase()+e.slice(1);return void xows_gui_mbox_subs_edit_open(xows_jid_bare(o.dataset.jid),t)}default:return}P_.role>wo&&P_.role>ho&&xows_gui_occu_switch(o.id)}}function xows_gui_page_wait_onclick(e){"wait_abrt"===e.id&&(xows_gui_disconnect(),xows_gui_reset(),xows_gui_page_auth_open())}function xows_gui_page_wait_open(e){xows_doc("wait_text").innerText=xows_l10n_get(e),xows_doc_page_open("page_wait"),xows_doc_page_open("page_wait",!1,null,null,xows_gui_page_wait_onclick)}function xows_gui_page_auth_oninput(e){let o=!0;xows_doc("auth_user").value.length&&xows_doc("auth_pass").value.length&&(o=!1),xows_doc("auth_cnct").disabled=o}function xows_gui_page_auth_onclick(e){"auth_cnct"!==e.id?"auth_regi"===e.id&&xows_gui_page_regi_open():xows_doc("auth_cnct").disabled||(xows_gui_page_wait_open("Connecting..."),(B_={}).user=xows_doc("auth_user").value.toLowerCase(),B_.pass=xows_doc("auth_pass").value,B_.cred=xows_doc("auth_cred").checked,xows_doc("auth_pass").value="",xows_gui_connect(!1))}function xows_gui_page_auth_open(){xows_doc("auth_user").value="",xows_doc("auth_pass").value="",xows_doc("auth_cnct").disabled=!0,xows_doc_page_open("page_auth",!1,null,xows_gui_page_auth_oninput,xows_gui_page_auth_onclick)}function xows_gui_page_regi_oninput(e){let o=!0;xows_doc("regi_user").value.length&&xows_doc("regi_pass").value.length&&xows_doc_cls_has("regi_capt","CAPTCHA-CHECKED")&&(o=!1),xows_doc("regi_subm").disabled=o}function xows_gui_page_regi_onclick(e){if("regi_capt"===e.id)return xows_doc_cls_add("regi_capt","CAPTCHA-CHECKED"),void xows_gui_page_regi_oninput(e);"regi_subm"!==e.id?"regi_canc"===e.id&&xows_gui_page_auth_open():xows_doc("regi_subm").disabled||(xows_gui_page_wait_open("Please wait..."),(B_={}).user=xows_doc("regi_user").value.toLowerCase(),B_.pass=xows_doc("regi_pass").value,xows_doc("regi_pass").value="",xows_gui_connect(!0))}function xows_gui_page_regi_open(){xows_doc("regi_user").value="",xows_doc("regi_pass").value="",xows_doc("regi_subm").disabled=!0,xows_doc_cls_rem("regi_capt","CAPTCHA-CHECKED"),xows_doc_page_open("page_regi",!1,null,xows_gui_page_regi_oninput,xows_gui_page_regi_onclick)}function xows_gui_page_user_onabort(){xows_doc("card_name").value=Wo.name;const e=xows_cach_avat_get(Wo.avat);xows_doc("card_avat").style.backgroundImage='url("'+e+'")',xows_doc("card_avat").data=e,xows_doc("card_open").checked=!0}function xows_gui_page_user_onvalid(){xows_cli_change_profile(xows_doc("card_name").value,xows_doc("card_avat").data,xows_doc("card_open").checked)}function xows_gui_page_user_oninput(e){let o;switch(e.id){case"card_open":o=!xows_doc("card_open").checked;break;case"card_name":o=xows_doc("card_name").value!=Wo.name}o&&xows_doc_mbox_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)}function xows_gui_page_user_onclick(e){if("card_avch"!==e.id){if("card_avrm"===e.id){const e=xows_doc("card_avat");e.data=null;const o=xows_cli_avat_temp(Wo.bare);e.style.backgroundImage='url("'+xows_cach_avat_get(o)+'")',xows_doc_mbox_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)}}else xows_doc("card_file").click()}function xows_gui_page_user_ev_file(e){const o=xows_doc("card_file");if(o.files[0]){const e=new FileReader;e.onload=function(e){const o=new Image;o.onload=function(e){const o=xows_gen_avatar(ft,this),t=xows_doc("card_avat");t.data=o,t.style.backgroundImage='url("'+o+'")',xows_doc_mbox_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)},o.src=e.target.result},e.readAsDataURL(o.files[0])}}function xows_gui_page_user_onclose(){xows_doc_listener_rem(xows_doc("card_file"),"change",xows_gui_page_user_ev_file)}function xows_gui_page_user_open(){xows_gui_page_user_onabort(),xows_doc_page_open("page_user",!0,xows_gui_page_user_onclose,xows_gui_page_user_oninput,xows_gui_page_user_onclick),xows_doc_listener_add(xows_doc("card_file"),"change",xows_gui_page_user_ev_file)}function xows_gui_page_cont_onvalid(){let e=xows_doc("cont_bare").value;const o=e.split("@")[0],t=o[0].toUpperCase()+o.slice(1);xows_doc_page_close(),xows_cli_rost_edit(e,t)}function xows_gui_page_cont_oninput(e){const o=xows_doc("cont_bare");o.value.length&&xows_isjid(o.value)?xows_doc_mbox_open(null,"Add contact and request authorisation",xows_gui_page_cont_onvalid,"Submit"):xows_doc_mbox_close()}function xows_gui_page_cont_open(){xows_doc("cont_bare").value="",xows_doc_page_open("page_cont",!0,null,xows_gui_page_cont_oninput)}const _s={};function xows_gui_page_join_onjoind(e,o,t){xows_doc_page_opened("page_join")&&(xows_gui_switch_peer(e.bare),xows_gui_panel_close(),t?(_s.room=e,xows_doc("join_room").disabled=!0,xows_doc_mbox_open(null,"The Room will be created, do you want to configure it ?",xows_gui_page_join_onvalid,"Configure",xows_gui_page_join_onabort,"Join now")):xows_doc_page_close())}function xows_gui_page_join_onvalid(){const e=_s.room;if(e)xows_log(2,"gui_page_join_onvalid","request initial Room config",e.bare),xows_cli_muc_getcfg_query(e,xows_gui_page_room_open);else{xows_cli_muc_join(null,xows_doc("join_room").value,Wo.name)}}function xows_gui_page_join_onabort(){const e=_s.room;e&&xows_cli_muc_setcfg_query(e,null,xows_gui_page_join_onjoind)}function xows_gui_page_join_oninput(e){xows_doc("join_room").value.length?xows_doc_mbox_open(null,"Join Room (create it if does not exist)",xows_gui_page_join_onvalid,"Join"):xows_doc_mbox_close()}function xows_gui_page_join_onclose(){_s.room=null}function xows_gui_page_join_open(){const e=xows_doc("join_room");e.disabled=!1,e.value="",xows_doc_page_open("page_join",!0,xows_gui_page_join_onclose,xows_gui_page_join_oninput)}const ss={room:null,form:null,cancel:!0};function xows_gui_page_room_onresult(e,o){"result"===o&&(ss.cancel=!1,xows_doc_page_close())}function xows_gui_page_room_onvalid(){const e=ss.room,o=ss.form;for(let e=0,t=o.length;e<t;++e)switch(o[e].var){case"muc#roomconfig_roomname":o[e].value=xows_doc("room_titl").value;break;case"muc#roomconfig_roomdesc":o[e].value=xows_doc("room_desc").value;break;case"muc#roomconfig_persistentroom":o[e].value=xows_doc("room_pers").checked?"1":"0";break;case"muc#roomconfig_publicroom":o[e].value=xows_doc("room_publ").checked?"1":"0";break;case"muc#roomconfig_membersonly":o[e].value=xows_doc("room_mbon").checked?"1":"0";break;case"muc#roomconfig_moderatedroom":o[e].value=xows_doc("room_modo").checked?"1":"0";break;case"muc#roomconfig_whois":o[e].value=xows_doc("room_anon").value;break;case"muc#roomconfig_presencebroadcast":o[e].value="moderator";break;case"muc#roomconfig_historylength":o[e].value=xows_doc("room_hmax").value;break;case"muc#roomconfig_defaulthistorymessages":o[e].value=xows_doc("room_hdef").value;break;case"muc#roomconfig_enablearchiving":o[e].value=xows_doc("room_arch").checked?"1":"0"}xows_cli_muc_setcfg_query(e,o,xows_gui_page_room_onresult)}function xows_gui_page_room_onabort(){const e=ss.form;for(let o=0,t=e.length;o<t;++o)switch(e[o].var){case"muc#roomconfig_roomname":xows_doc("room_titl").value=e[o].value;break;case"muc#roomconfig_roomdesc":xows_doc("room_desc").value=e[o].value;break;case"muc#roomconfig_persistentroom":xows_doc("room_pers").checked=xows_asbool(e[o].value);break;case"muc#roomconfig_publicroom":xows_doc("room_publ").checked=xows_asbool(e[o].value);break;case"muc#roomconfig_membersonly":xows_doc("room_mbon").checked=xows_asbool(e[o].value);break;case"muc#roomconfig_changesubject":case"muc#roomconfig_moderatedroom":xows_doc("room_modo").checked=xows_asbool(e[o].value);break;case"muc#roomconfig_whois":xows_doc("room_anon").value=e[o].value;break;case"muc#roomconfig_historylength":xows_doc("room_hmax").value=e[o].value;break;case"muc#roomconfig_defaulthistorymessages":xows_doc("room_hdef").value=e[o].value;break;case"muc#roomconfig_enablearchiving":xows_doc("room_arch").checked=xows_asbool(e[o].value)}}function xows_gui_page_room_oninput(e){let o=!1;const t=ss.form;for(let e=0,_=t.length;e<_;++e){switch(t[e].var){case"muc#roomconfig_roomname":t[e].value!==xows_doc("room_titl").value&&(o=!0);break;case"muc#roomconfig_roomdesc":t[e].value!==xows_doc("room_desc").value&&(o=!0);break;case"muc#roomconfig_persistentroom":xows_asbool(t[e].value)!==xows_doc("room_pers").checked&&(o=!0);break;case"muc#roomconfig_publicroom":xows_asbool(t[e].value)!==xows_doc("room_publ").checked&&(o=!0);break;case"muc#roomconfig_membersonly":xows_asbool(t[e].value)!==xows_doc("room_mbon").checked&&(o=!0);break;case"muc#roomconfig_moderatedroom":xows_asbool(t[e].value)!==xows_doc("room_modo").checked&&(o=!0);break;case"muc#roomconfig_whois":t[e].value!==xows_doc("room_anon").value&&(o=!0);break;case"muc#roomconfig_historylength":t[e].value!==xows_doc("room_hmax").value&&(o=!0);break;case"muc#roomconfig_defaulthistorymessages":t[e].value!==xows_doc("room_hdef").value&&(o=!0);break;case"muc#roomconfig_enablearchiving":xows_asbool(t[e].value)!==xows_doc("room_arch").checked&&(o=!0)}if(o)break}o&&xows_doc_mbox_open_for_save(xows_gui_page_room_onvalid,xows_gui_page_room_onabort)}function xows_gui_page_room_onclose(){const e=ss.room;e.init?xows_cli_muc_setcfg_query(e,null,null):ss.cancel&&xows_cli_muc_setcfg_cancel(e),ss.form=null,ss.room=null}function xows_gui_page_room_open(e,o){ss.room=e,ss.form=o,xows_doc("room_bare").innerText=e.bare,xows_gui_page_room_onabort(),xows_doc_page_open("page_room",!0,xows_gui_page_room_onclose,xows_gui_page_room_oninput,xows_gui_page_room_oninput)}let ns={root:"/xows",url:"ws://localhost/xmpp-websocket/",domain:"localhost",locale:"en-US",theme:"dark",verbose:1,uncache:!1,allow_register:!1,legacy_vcard:!1,vcard4_notify:!0,avatar_notify:!0,login_delay:2e3,history_size:256,extern_services:[]};function xows_init_login_user(){xows_log(2,"init_login_user","normal login"),window.PasswordCredential?xows_doc_show("auth_save"):xows_doc_hide("auth_save"),xows_gui_page_auth_open()}function xows_init_login_auto(e){e?(xows_log(2,"init_login_auto","found credential","try auto login"),xows_gui_page_wait_open("Connecting..."),B_={user:e.id,pass:e.password},xows_gui_connect()):(xows_log(2,"init_login_auto","No credential found","Fallback to normal login"),xows_init_login_user())}function xows_init_ondoc(){if(xows_gui_init(),window.PasswordCredential){const e={password:!0,mediation:"optional"};navigator.credentials.get(e).then(xows_init_login_auto,xows_init_login_user)}else xows_init_login_user()}function xows_init_ontpl(){xows_doc_init(xows_init_ondoc)}function xows_init_onl10n(){xows_tpl_init(xows_init_ontpl)}function xows_init(e){e&&(e.hasOwnProperty("root")&&(ns.root=e.root),e.hasOwnProperty("url")&&(ns.url=e.url),e.hasOwnProperty("domain")&&(ns.domain=e.domain),e.hasOwnProperty("locale")&&(ns.locale=e.locale),e.hasOwnProperty("theme")&&(ns.theme=e.theme),e.hasOwnProperty("verbose")&&(ns.verbose=e.verbose),e.hasOwnProperty("uncache")&&(ns.uncache=e.uncache),e.hasOwnProperty("allow_register")&&(ns.allow_register=e.allow_register),e.hasOwnProperty("legacy_vcard")&&(ns.legacy_vcard=e.legacy_vcard),e.hasOwnProperty("vcard4_notify")&&(ns.vcard4_notify=e.vcard4_notify),e.hasOwnProperty("avatar_notify")&&(ns.avatar_notify=e.avatar_notify),e.hasOwnProperty("fail_delay")&&(ns.fail_delay=e.fail_delay),e.hasOwnProperty("history_size")&&(ns.history_size=e.history_size),e.hasOwnProperty("extern_services")&&(ns.extern_services=e.extern_services)),"/"!=ns.root.charAt(0)&&(ns.root="/"+ns.root),xows_log(2,"init","xows init start"),xows_l10n_select(ns.locale,xows_init_onl10n)}function xows_init_fatal(e,o){let t="<h1>XOWS init failed</h1><h4>Asset file loading error ( HTTP error "+e+" )</h4>";t+="<big><code>"+o.match(/(.+?)(?:\?.*|$)/)[1]+"</code></big>",t+="<h5>Did you set the proper library/assets root path ?</h5>",document.body.style="padding:20px;text-align:center;background:#1A1A1F;color:#FC8484",document.body.innerHTML=t}
