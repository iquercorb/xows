"use strict";const e="Xows",o="0.9.8",_="https://github.com/iquercorb/xows",t=-1,s=-2,n=0,c=1,i=new Path2D("m7.39 0.00182c-0.949 0.0386-1.99 0.696-2.81 1.54l2.42 3.79c-2.24 1.41-3.3 3.4-3.98 5.57-2.24 0.214-0.682-4.16-0.836-5.17 0 0-3.6 5.7-1.55 7.3 1.46 1.15 3.94 1.59 3.94 1.59l-3.15 3.99c2.14 0.72 6.9 0.794 6.9 0.794l2.73-4.25h1.91l2.73 4.25s4.76-0.0743 6.9-0.794l-3.15-3.99s2.47-0.444 3.94-1.59c2.04-1.6-1.65-7.3-1.65-7.3-0.152 1.01 1.5 5.38-0.739 5.17-0.675-2.17-1.74-4.16-3.98-5.57l2.42-3.79c-0.827-0.845-1.86-1.5-2.81-1.54-0.135-0.00482-0.27 0.00193-0.401 0.0232l-3.64 4.52h-1.14l-3.64-4.52a2.01 2.01 0 0 0-0.401-0.0232zm1.42 8.17c1.69 0 1.44 2.58 1.44 2.58s-0.968 0.027-1.88 0.027-1.54-0.0482-1.54-0.726c0-0.678 0.285-1.88 1.97-1.88zm6.39 0c1.69 0 1.97 1.2 1.97 1.88 0 0.678-0.63 0.726-1.54 0.726a77.5 77.5 0 0 1-1.88-0.027s-0.241-2.58 1.44-2.58z");function xows_hasbits(e,o){return(e&o)===o}function xows_asbool(e){if(e.length){const o=parseInt(e);return NaN!==o?Boolean(o):"TRUE"===e.toUpperCase()}return Boolean(e)}function xows_isfunc(e){return e&&e.constructor&&e.call&&e.apply}function xows_def_readonly(e,o,_){Object.defineProperty(e,o,{value:_,writable:!1})}function xows_random(e){let o=e+=1831565813;return o=Math.imul(o^o>>>15,1|o),(((o^=o+Math.imul(o^o>>>7,61|o))^o>>>14)>>>0)/4294967296}function xows_log(e,o,_,t,s){if(e>Ns.verbose)return;let n,c="";e>1&&s&&(c+="%c",n="color:"+s),c+=_,t&&(c+=": "+t);const i=o+": "+c;switch(e){case 0:case 1:console.warn(i);break;default:n?console.log(i,n):console.log(i)}}const r="0123456789abcdef",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function xows_str_to_utf8(e){let o,_,t="";for(let s=0,n=e.length;s<n;++s)(o=e.charCodeAt(s))<128?t+=e.charAt(s):o<2048?t+=String.fromCharCode(192|o>>6,128|63&o):o<55296||o>=57344?t+=String.fromCharCode(224|o>>12,128|o>>6&63,128|63&o):(++s,o=65536+((1023&o)<<10|1023&(_=e.charCodeAt(s))),t+=String.fromCharCode(240|o>>18,128|o>>12&63,128|o>>6&63,128|63&o));return t}function xows_str_bytes_len(e){let o,_=0;for(let t=0,s=e.length;t<s;++t)(o=e.charCodeAt(t))<128?_++:o<2048?_+=2:o<55296||o>=57344?_+=3:(++t,_+=4);return _}function xows_str_to_bytes(e,o){let _,t;const s=new Uint8Array(o||xows_str_bytes_len(e));for(let o=0,n=0,c=e.length;o<c;++o)(_=e.charCodeAt(o))<128?s[n++]=_:_<2048?(s[n++]=192|_>>6,s[n++]=128|63&_):_<55296||_>=57344?(s[n++]=224|_>>12,s[n++]=128|_>>6&63,s[n++]=128|63&_):(++o,_=65536+((1023&_)<<10|1023&(t=e.charCodeAt(o))),s[n++]=240|_>>18,s[n++]=128|_>>12&63,s[n++]=128|_>>6&63,s[n++]=128|63&_);return s}function xows_bytes_to_str(e){return String.fromCharCode.apply(null,e)}function xows_bytes_to_b64(e){const o=e.length,_=o%3;let t,s,n,c="";for(t=0,s=o-_;t<s;)n=e[t++]<<16|e[t++]<<8|e[t++],c+=a[63&n>>18],c+=a[63&n>>12],c+=a[63&n>>6],c+=a[63&n];return 0!==_&&(n=e[t++]<<16,_>1&&(n|=e[t]<<8),c+=a[63&n>>18],c+=a[63&n>>12],c+=_>1?a[63&n>>6]:"=",c+="="),c}function xows_bytes_to_hex(e){let o,_="";for(let t=0,s=e.length;t<s;++t)o=e[t],_+=r.charAt(o>>>4&15)+r.charAt(15&o);return _}function xows_bytes_to_int(e,o=0){return e[0+o]|e[1+o]<<8|e[2+o]<<16|e[3+o]<<24}function xows_gen_uuid(){if(window.crypto.randomUUID)return window.crypto.randomUUID();const e=new Uint8Array(16);window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let o="";for(let _=0,t=0;t<16;++t)8!==_&&13!==_&&18!==_&&23!==_||(o+="-",_++),o+=r.charAt(e[t]>>>4&15)+r.charAt(15&e[t]),_+=2;return o}function xows_gen_nonce_hex(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let _="";for(let t=0;t<e;++t)_+=r.charAt(o[t]>>>4&15)+r.charAt(15&o[t]);return _}function xows_gen_nonce_asc(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let _="";for(let t=0;t<e;++t)_+=a[o[t]%62];return _}function xows_gen_nonce_num(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let _="";for(let t=0;t<e;++t)_+=r[o[t]%10];return _}function xows_hash_md5(e){let o;function P1(e,_,t,s,n,c,i){return((o=e+((s^_&(t^s))+n+i))<<c|o>>>32-c)+_}function P2(e,_,t,s,n,c,i){return((o=e+((t^s&(_^t))+n+i))<<c|o>>>32-c)+_}function P3(e,_,t,s,n,c,i){return((o=e+((_^t^s)+n+i))<<c|o>>>32-c)+_}function P4(e,_,t,s,n,c,i){return((o=e+((t^(_|~s))+n+i))<<c|o>>>32-c)+_}let _,t,s,n=0;if("string"==typeof e)s=xows_str_to_bytes(e,64+((t=8*(_=xows_str_bytes_len(e)))+64>>9<<6));else for(t=8*(_=e.length),s=new Uint8Array(64+(t+64>>9<<6));n<_;++n)s[n]=e[n];s[_]|=128;let c=s.length-8;s[c]=255&t,s[c+1]=t>>8&255,s[c+2]=t>>16&255,s[c+3]=t>>24&255;const i=new Uint32Array(16),r=new Uint32Array(4);let a,l,u,d;for(r[0]=1732584193,r[1]=4023233417,r[2]=2562383102,r[3]=271733878,c=0;c<s.length;){for(n=0;n<16;++n)i[n]=s[c++]|s[c++]<<8|s[c++]<<16|s[c++]<<24;a=r[0],l=P4(l=P4(l=P4(l=P4(l=P3(l=P3(l=P3(l=P3(l=P2(l=P2(l=P2(l=P2(l=P1(l=P1(l=P1(l=P1(l=r[1],u=P1(u=r[2],d=P1(d=r[3],a=P1(a,l,u,d,i[0],7,3614090360),l,u,i[1],12,3905402710),a,l,i[2],17,606105819),d,a,i[3],22,3250441966),u=P1(u,d=P1(d,a=P1(a,l,u,d,i[4],7,4118548399),l,u,i[5],12,1200080426),a,l,i[6],17,2821735955),d,a,i[7],22,4249261313),u=P1(u,d=P1(d,a=P1(a,l,u,d,i[8],7,1770035416),l,u,i[9],12,2336552879),a,l,i[10],17,4294925233),d,a,i[11],22,2304563134),u=P1(u,d=P1(d,a=P1(a,l,u,d,i[12],7,1804603682),l,u,i[13],12,4254626195),a,l,i[14],17,2792965006),d,a,i[15],22,1236535329),u=P2(u,d=P2(d,a=P2(a,l,u,d,i[1],5,4129170786),l,u,i[6],9,3225465664),a,l,i[11],14,643717713),d,a,i[0],20,3921069994),u=P2(u,d=P2(d,a=P2(a,l,u,d,i[5],5,3593408605),l,u,i[10],9,38016083),a,l,i[15],14,3634488961),d,a,i[4],20,3889429448),u=P2(u,d=P2(d,a=P2(a,l,u,d,i[9],5,568446438),l,u,i[14],9,3275163606),a,l,i[3],14,4107603335),d,a,i[8],20,1163531501),u=P2(u,d=P2(d,a=P2(a,l,u,d,i[13],5,2850285829),l,u,i[2],9,4243563512),a,l,i[7],14,1735328473),d,a,i[12],20,2368359562),u=P3(u,d=P3(d,a=P3(a,l,u,d,i[5],4,4294588738),l,u,i[8],11,2272392833),a,l,i[11],16,1839030562),d,a,i[14],23,4259657740),u=P3(u,d=P3(d,a=P3(a,l,u,d,i[1],4,2763975236),l,u,i[4],11,1272893353),a,l,i[7],16,4139469664),d,a,i[10],23,3200236656),u=P3(u,d=P3(d,a=P3(a,l,u,d,i[13],4,681279174),l,u,i[0],11,3936430074),a,l,i[3],16,3572445317),d,a,i[6],23,76029189),u=P3(u,d=P3(d,a=P3(a,l,u,d,i[9],4,3654602809),l,u,i[12],11,3873151461),a,l,i[15],16,530742520),d,a,i[2],23,3299628645),u=P4(u,d=P4(d,a=P4(a,l,u,d,i[0],6,4096336452),l,u,i[7],10,1126891415),a,l,i[14],15,2878612391),d,a,i[5],21,4237533241),u=P4(u,d=P4(d,a=P4(a,l,u,d,i[12],6,1700485571),l,u,i[3],10,2399980690),a,l,i[10],15,4293915773),d,a,i[1],21,2240044497),u=P4(u,d=P4(d,a=P4(a,l,u,d,i[8],6,1873313359),l,u,i[15],10,4264355552),a,l,i[6],15,2734768916),d,a,i[13],21,1309151649),u=P4(u,d=P4(d,a=P4(a,l,u,d,i[4],6,4149444226),l,u,i[11],10,3174756917),a,l,i[2],15,718787259),d,a,i[9],21,3951481745),r[0]+=a,r[1]+=l,r[2]+=u,r[3]+=d}const x=new Uint8Array(16);for(n=0,c=0;n<4;++n)x[c++]=255&r[n],x[c++]=r[n]>>8&255,x[c++]=r[n]>>16&255,x[c++]=r[n]>>24&255;return x}function xows_hash_sha1(e){let o,_,t,s=0;if("string"==typeof e)t=xows_str_to_bytes(e,64+((_=8*(o=xows_str_bytes_len(e)))+64>>9<<6));else for(_=8*(o=e.length),t=new Uint8Array(64+(_+64>>9<<6));s<o;++s)t[s]=e[s];t[o]|=128;let n=t.length-4;t[n]=_>>24&255,t[n+1]=_>>16&255,t[n+2]=_>>8&255,t[n+3]=255&_;const c=new Uint32Array(16),i=new Uint32Array(5);let r,a,l,u,d,x,w,p;for(i[0]=1732584193,i[1]=4023233417,i[2]=2562383102,i[3]=271733878,i[4]=3285377520,n=0;n<t.length;){for(s=0;s<16;++s)c[s]=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++];for(r=i[0],a=i[1],l=i[2],u=i[3],d=i[4],s=0;s<80;++s)s>15&&(p=c[s-3&15]^c[s-8&15]^c[s-14&15]^c[15&s],c[15&s]=p<<1|p>>>31),s<20?(x=1518500249,w=u^a&(l^u)):s<40?(x=1859775393,w=a^l^u):s<60?(x=2400959708,w=a&l|a&u|l&u):(x=3395469782,w=a^l^u),p=(r<<5|r>>>27)+w+(d+c[15&s]+x),d=u,u=l,l=a<<30|a>>>2,a=r,r=p;i[0]+=r,i[1]+=a,i[2]+=l,i[3]+=u,i[4]+=d}const m=new Uint8Array(20);for(s=0,n=0;s<5;++s)m[n++]=i[s]>>24&255,m[n++]=i[s]>>16&255,m[n++]=i[s]>>8&255,m[n++]=255&i[s];return m}function xows_hmac_sha1(e,o){"string"==typeof e&&(e=xows_str_to_bytes(e)),e.length>64&&(e=xows_hash_sha1(e));const _=new Uint8Array(64+o.length),t=new Uint8Array(84);let s,n,c;for(n=0,c=e.length;n<c;++n)_[n]=54^e[n],t[n]=92^e[n];for(;n<64;++n)_[n]=54,t[n]=92;for("string"==typeof o&&(o=xows_str_to_bytes(o)),s=0,c=o.length;s<c;++s)_[n++]=o[s];const i=xows_hash_sha1(_);for(s=0,n=64;s<20;++s)t[n++]=i[s];return xows_hash_sha1(t)}function xows_hash_sha256(e){const o=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);let _,t,s,n=0;if("string"==typeof e)s=xows_str_to_bytes(e,64+((t=8*(_=xows_str_bytes_len(e)))+64>>9<<6));else for(t=8*(_=e.length),s=new Uint8Array(64+(t+64>>9<<6));n<_;++n)s[n]=e[n];s[_]|=128;let c=s.length-4;s[c]=t>>24&255,s[c+1]=t>>16&255,s[c+2]=t>>8&255,s[c+3]=255&t;const i=new Uint32Array(64),r=new Uint32Array(8);let a,l,u,d,x,w,p,m,g,f;for(r[0]=1779033703,r[1]=3144134277,r[2]=1013904242,r[3]=2773480762,r[4]=1359893119,r[5]=2600822924,r[6]=528734635,r[7]=1541459225,c=0;c<s.length;){for(n=0;n<16;++n)i[n]=s[c++]<<24|s[c++]<<16|s[c++]<<8|s[c++];for(a=r[0],l=r[1],u=r[2],d=r[3],x=r[4],w=r[5],p=r[6],m=r[7],n=0;n<64;n++)n>15&&(g=((f=i[n-2])>>>17|f<<15)^(f>>>19|f<<13)^f>>>10,i[n]=g+i[n-7],g=((f=i[n-15])>>>7|f<<25)^(f>>>18|f<<14)^f>>>3,i[n]+=g+i[n-16]),d+=f=m+(g=(x>>>6|x<<26)^(x>>>11|x<<21)^(x>>>25|x<<7))+(p^x&(w^p))+o[n]+i[n],f+=(g=(a>>>2|a<<30)^(a>>>13|a<<19)^(a>>>22|a<<10))+(a&l|u&(a|l)),m=p,p=w,w=x,x=d,d=u,u=l,l=a,a=f;r[0]+=a,r[1]+=l,r[2]+=u,r[3]+=d,r[4]+=x,r[5]+=w,r[6]+=p,r[7]+=m}const h=new Uint8Array(32);for(n=0,c=0;n<8;++n)h[c++]=r[n]>>24&255,h[c++]=r[n]>>16&255,h[c++]=r[n]>>8&255,h[c++]=255&r[n];return h}function xows_hash_sdbm(e){let o=0;for(let _=0;_<e.length;++_)o=e.charCodeAt(_)+(o<<6)+(o<<16)-o;const _=new Uint8Array(4);return _[0]=o>>24&255,_[1]=o>>16&255,_[2]=o>>8&255,_[3]=255&o,_}const l=/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;function xows_isjid(e){return l.test(e)}function xows_jid_bare(e){const o=e.indexOf("/");return-1!==o?e.substring(0,o):e}function xows_jid_node(e){const o=e.indexOf("@");return-1!==o?e.substring(0,o):""}function xows_jid_host(e){const o=e.indexOf("@");if(-1!==o){const _=e.indexOf("/");return e.substring(o+1,-1!==_?_:null)}return""}function xows_jid_resc(e){const o=e.indexOf("/");return-1!==o?e.substring(o+1):""}function xows_url_to_data(e){return 0===e.indexOf("data:")?e.substring(e.indexOf(",")+1):null}function xows_url_to_bytes(e){return 0===e.indexOf("data:")?atob(e.substring(e.indexOf(",")+1)):null}function xows_url_to_type(e){return 0===e.indexOf("data:")?e.substring(5,e.indexOf(";")):null}const u=new Map([["&","&amp;"],["<","&lt;"],[">","&gt;"],["'","&apos;"],['"',"&quot;"],["\n","<br>"]]);function xows_html_esc_func(e){return u.get(e)}function xows_html_escape(e){return e.replace(/[\&<>'"\n]/g,xows_html_esc_func)}function xows_clean_dom(e){let o,_=e.childNodes.length;for(;_--;)8===(o=e.childNodes[_]).nodeType||3===o.nodeType&&!/\S/.test(o.nodeValue)?e.removeChild(o):1===o.nodeType&&xows_clean_dom(o);return e}const d=["#22A849","#24ABC1","#F2C40C","#395BBF","#9B54B3","#E97333","#CF3838","#395BBF","#F2C40C","#22A849","#24ABC1","#9B54B3","#CF3838","#E97333"];function xows_gen_avatar(e,o,_){const t=document.createElement("canvas"),s=t.getContext("2d");if(o){let _;const n=o.naturalWidth,c=o.naturalHeight;if(n>e||c>e){let i,r,a;n>c?(r=.5*(n-(i=c)),a=0):(r=0,a=.5*(c-(i=n))),t.width=n,t.height=c,s.drawImage(o,0,0);const l=s.getImageData(r,a,i,i),u=new Int32Array(l.data.buffer);_=new ImageData(e,e);const d=new Int32Array(_.data.buffer),x=1/(e/i),w=Math.round(x),p=1/(w*w);let m,g,f,h,b,y,F,v,k,A;for(m=0;m<e;++m)for(g=0;g<e;++g){for(b=Math.round(g*x)*i+Math.round(m*x),y=0,F=0,v=0,k=0,h=0;h<w;++h)for(f=0;f<w;++f)k+=(A=u[b+(h*i+f)])>>24&255,v+=A>>16&255,F+=A>>8&255,y+=255&A;y=Math.round(y*p),F=Math.round(F*p),v=Math.round(v*p),k=Math.round(k*p),d[g*e+m]=k<<24|v<<16|F<<8|y}t.width=t.height=e,s.putImageData(_,0,0)}else t.width=t.height=e,s.drawImage(o,0,0,e,e)}else if(t.width=t.height=e,_){const o=Math.abs(_)%14;s.fillStyle=d[o],s.rect(0,0,e,e),s.fill(),s.fillStyle="#FFF";const t=.7,n=.5*e;s.translate(n-24*t,n-21*t);const c=e/24*t;s.scale(c,c),s.fill(i)}return t.toDataURL("image/png")}function xows_sdp_parse(e){const o={},_=e.split("\r\n");for(let e=0;e<_.length;++e){const t=_[e];switch(t.charAt(0)){case"v":o.version=t.substring(2);break;case"o":{const e=t.substring(2).split(" ");o.origin={username:e[0],sessionId:e[1],sessionVersion:e[2],netType:e[3],ipVer:parseInt(e[4].charAt(2)),address:e[5]};break}case"s":o.name=t.substring(2);break;case"t":{const e=t.substring(2).split(" ");o.timing={start:e[0],stop:e[1]};break}case"m":{o.media||(o.media=[]);const e=t.substring(2).split(" ");o.media.push({type:e[0],port:parseInt(e[1]),protocols:e[2],payloads:e.slice(3)});break}case"c":if(o.media){const e=o.media[o.media.length-1],_=t.substring(2).split(" ");e.connection={type:_[0],version:parseInt(_[1].charAt(2)),ip:_[2]}}break;case"a":{const e=o.media?o.media[o.media.length-1]:o,_=t.indexOf(":"),s=_>0?t.substring(_+1).split(" "):null,n=_>0?t.substring(2,_):t.substring(2);switch(n){case"group":e.group={type:s[0],mids:s.slice(1)};break;case"msid-semantic":e.msidSemantic={semantic:s[0],token:s[1]};break;case"ice-options":e.iceOptions=s[0];break;case"fingerprint":e.fingerprint||(e.fingerprint=[]),e.fingerprint.push({type:s[0],hash:s[1]});break;case"sendrecv":case"sendonly":case"recvonly":case"inactive":e.direction=n;break;case"extmap":{e.extmap||(e.extmap=[]);const o={value:parseInt(s[0]),uri:s[1]},_=s[0].split("/");_[1]&&(o.direction=_[1]),e.extmap.push(o);break}case"fmtp":e.fmtp||(e.fmtp=[]),e.fmtp.push({payload:parseInt(s[0]),config:s[1].split(";")});break;case"ice-ufrag":e.iceUfrag=s[0];break;case"ice-pwd":e.icePwd=s[0];break;case"msid":e.msid={group:s[0],id:s[1]};break;case"rtcp-fb":{e.rtcpFb||(e.rtcpFb=[]);const o={payload:parseInt(s[0]),type:s[1]};s[2]&&(o.subtype=s[2]),e.rtcpFb.push(o);break}case"rtcp-mux":e.rtcpMux=!0;break;case"rtcp-rsize":e.rtcpRsize=!0;break;case"rtpmap":{e.rtpmap||(e.rtpmap=[]);const o={payload:parseInt(s[0])},_=s[1].split("/");o.codec=_[0],_[1]&&(o.rate=_[1]),_[2]&&(o.channels=_[2]),e.rtpmap.push(o);break}case"ssrc":{e.ssrc||(e.ssrc=[]);const o={id:parseInt(s[0])};if(s[1]){const e=s[1].split(":");o.attribute=e[0],o.value=e[1]}e.ssrc.push(o);break}case"ssrc-group":e.ssrcGroup||(e.ssrcGroup=[]),e.ssrcGroup.push({semantics:s[0],ssrcs:s.slice(1)});break;case"candidate":{e.candidate||(e.candidate=[]);const o={network:1,foundation:s[0],component:s[1],protocol:s[2].toLowerCase(),priority:s[3],ip:s[4],port:s[5]};for(let e=6;e<s.length;e+=2)switch(s[e]){case"typ":o.type=s[e+1];break;case"raddr":o.raddr=s[e+1];break;case"rport":o.rport=s[e+1];break;case"generation":o.generation=s[e+1];break;case"tcptype":o.tcptype=s[e+1]}e.candidate.push(o);break}default:e[n]=!s||s[0]}break}}}return o}function xows_sdp_get_medias(e){const o={audio:!1,video:!1};let _=e.indexOf("m=");for(;_>0;){_+=2;const t=e.indexOf("\n",_),s=e.substring(_,t).split(" ")[0];"audio"!==s||o.audio||(o.audio=!0),"video"!==s||o.video||(o.video=!0),_=e.indexOf("m=",_)}return o}function xows_sdp_get_sid(e){const o=e.indexOf("o=");if(o>0){o+=2;const _=e.indexOf("\n",o);return e.substring(o,_).split(" ")[1]}return""}let x={},w="en",p=function(){};function xows_l10n_select(e,o){xows_isfunc(o)&&(p=o);let _=Ns.root+"/locale/LC_list.json";Ns.uncache&&(_+="?"+xows_gen_nonce_asc(4));const t=new XMLHttpRequest;t.open("GET",_,!0),t.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_select","parsing locale list",this.responseURL);let o=JSON.parse(this.responseText);if(!o)return void xows_log(0,"l10n_select",'locale list "'+this.responseURL+'" parse error');if(o[e])return xows_log(2,"l10n_select","found available locale",e),void xows_l10n_db_load(o[e]);if(-1!==e.indexOf("-")){let _=e.split("-")[0].toLowerCase();if(o[_])return xows_log(2,"l10n_select","found available language",_),void xows_l10n_db_load(o[_])}xows_log(1,"l10n_select",'invalid or unavailable locale "'+e+'"',"using default"),p()}else xows_init_fatal(this.status,this.responseURL)},xows_log(2,"l10n_select","loading locale list",_),t.send()}function xows_l10n_db_load(e,o){xows_isfunc(o)&&(p=o);let _=Ns.root+"/locale/"+e+"/LC_db.json";Ns.uncache&&(_+="?"+xows_gen_nonce_asc(4));const t=new XMLHttpRequest;t.open("GET",_,!0),t.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_db_load","parsing JSON data",this.responseURL);let o=JSON.parse(this.responseText);if(!o)return void xows_log(0,"l10n_db_load",'data "'+this.responseURL+'" parse error');x=o,w=e,p()}else xows_log(0,"l10n_db_load",'file "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"'),p()},xows_log(2,"l10n_db_load","loading locale db",_),t.send()}function xows_l10n_get(e){const o=x[e];return o&&0!==o.length?o:e}function xows_l10n_parseFunc(e,o){const _=x[o];return _&&0!==_.length?_:o}function xows_l10n_parse(e){return e.replace(/\${['"](.*?)['"]}/g,xows_l10n_parseFunc)}function xows_l10n_hasLocale(e){return null!==x[e]&&void 0!==x[e]}function xows_l10n_date(e){const o=new Date(e),_=new Date,t=new Date(e);return _.setHours(0,0,0,0),t.setHours(0,0,0,0),_===t?xows_l10n_get("at")+" "+o.toLocaleTimeString(w):o.toLocaleDateString(w,{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}function xows_l10n_houre(e){return new Date(e).toLocaleTimeString(w,{hour:"2-digit",minute:"2-digit"}).replace(/AM|PM/,"")}const m=new DOMParser,g=document.implementation.createDocument("jabber:client","Xows"),f=new Map([["&","&amp;"],["<","&lt;"],[">","&gt;"],["'","&apos;"],['"',"&quot;"],["\n","<br>"]]),h=new Map([["&amp;","&"],["&lt;","<"],["&gt;",">"],["&apos;","'"],["&quot;",'"']]);function xows_xml_escap_fnc(e){return f.get(e)}function xows_xml_escape(e){return e.replace(/[\&<>'"]/g,xows_xml_escap_fnc)}function xows_xml_unesc_fnc(e){return h.get(e)}function xows_xml_unesc(e){return e.replace(/\&\w*;/g,xows_xml_unesc_fnc)}function xows_xml_parent(e,o){if("string"==typeof o||"number"==typeof o)e.appendChild(g.createTextNode(o));else if("object"==typeof o){const _=o.length;if(void 0!==_)for(let t=0;t<_;++t)xows_xml_parent(e,o[t]);else e.appendChild(o)}}function xows_xml_node(e,o,_){const t=g.createElement(e);if("object"==typeof o)for(const e in o)o.hasOwnProperty(e)&&null!==o[e]&&void 0!==o[e]&&t.setAttribute(e,o[e]);return _&&xows_xml_parent(t,_),t}function xows_xml_edit(e,o,_){let t=e.querySelector(o);if(t){for(;t.firstChild;)t.removeChild(t.lastChild);xows_xml_parent(t,_)}else t=xows_xml_node(o,null,_);return t}function xows_xml_serialize(e){let o,_,t="<"+e.nodeName;for(_=e.attributes.length,o=0;o<_;++o)t+=" "+e.attributes[o].nodeName+'="'+e.attributes[o].nodeValue+'"';if(0!==(_=e.childNodes.length)){for(t+=">",o=0;o<_;++o)1===e.childNodes[o].nodeType?t+=xows_xml_serialize(e.childNodes[o]):t+=xows_xml_escape(e.childNodes[o].nodeValue);t+="</"+e.nodeName+">"}else t+="/>";return t}function xows_xml_parse(e){return xows_clean_dom(m.parseFromString(e,"text/xml"))}function xows_xml_innertext(e){if(!e)return"";const o=e.childNodes.length;if(0===o&&3===e.nodeType)return xows_xml_unesc(e.nodeValue);let _="";for(let t=0;t<o;++t)3===e.childNodes[t].nodeType&&(_+=e.childNodes[t].nodeValue);return xows_xml_unesc(_)}let b=null,y="",F=function(){return""},v=function(e){return""},k=function(e){return!0},A=function(){},E=function(){};function xows_sasl_get_selected(){return y}function xows_sasl_plain_req(){let e=b.authz+"\0";return e+=b.authc+"\0",e+=b.passw,b={},e}function xows_sasl_plain_resp(e){return""}function xows_sasl_plain_chk(e){return!0}function xows_sasl_sha1_req(){b.cnonce=xows_gen_nonce_asc(24);let e="n="+b.authc;return e+=",r="+b.cnonce,b.client_first_message_bare=e,"n,,"+e}function xows_sasl_sha1_resp(e){let o,_,t,s,n,c,i,r=e.split(",");for(o=0,t=r.length;o<t;++o)"r"===(i=r[o].match(/([a-z]+)=(.+)/))[1]&&(s=i[2]),"s"===i[1]&&(n=i[2]),"i"===i[1]&&(c=i[2]);if(s.substring(0,24)!==b.cnonce)return b={},xows_log(0,"sasl_sha1_resp","SCRAM-SHA-1 challenge error","missing cnonce in server nonce"),xows_isfunc(A)&&A(),"";let a,l,u="c=biws,r="+s,d=b.client_first_message_bare;for(d+=","+e+","+u,a=l=xows_hmac_sha1(b.passw,atob(n)+"\0\0\0"),o=1;o<c;++o)for(l=xows_hmac_sha1(b.passw,l),_=0;_<20;++_)a[_]^=l[_];let x=xows_hmac_sha1(a,"Client Key");const w=xows_hmac_sha1(a,"Server Key"),p=xows_hmac_sha1(xows_hash_sha1(x),d);for(_=0;_<20;_++)x[_]^=p[_];b={};const m=xows_hmac_sha1(w,d);return b.sproof=xows_bytes_to_b64(m),u+=",p="+xows_bytes_to_b64(x)}function xows_sasl_sha1_chk(e){const o=e.match(/(v)=(.+)/),_=b.sproof;return b={},_===o[2]||(xows_log(0,"sasl_sha1_chk","SCRAM-SHA-1 integrity check failed","supplied server signature mismatches the computed one"),!1)}function xows_sasl_md5_req(){return""}function xows_sasl_md5_resp(e){let o,_,t,s,n,c,i=e.split(",");for(let e=0,r=i.length;e<r;++e)"realm"===(c=i[e].match(/([a-z]+)="?([^"]+)/))[1]&&(o=c[2]),"nonce"===c[1]&&(_=c[2]),"qop"===c[1]&&(t=c[2]),"host"===c[1]&&(s=c[2]),"rspauth"===c[1]&&(n=c[2]);if(void 0!==n)return"";const r=b.authc,a=b.authz,l=b.passw;b={};let u="xmpp/"+a.split("@")[1];void 0!==s&&(u+="/"+s);const d=xows_gen_nonce_asc(24),x="00000001";let w="charset=utf-8,";return w+='username="'+r+'",',w+='realm="'+o+'",',w+='nonce="'+_+'",',w+='cnonce="'+d+'",',w+="nc="+x+",",w+='digest-uri="'+u+'",',w+='response="'+xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_str(xows_hash_md5(r+":"+o+":"+l))+":"+_+":"+d+":"+a))+":"+_+":"+x+"1:"+d+":"+t+":"+xows_bytes_to_hex(xows_hash_md5("AUTHENTICATE:"+u))))+'",',w+="qop=auth"}function xows_sasl_md5_chk(e){return!0}const q=[{name:"SCRAM-SHA-1",req:xows_sasl_sha1_req,res:xows_sasl_sha1_resp,chk:xows_sasl_sha1_chk},{name:"DIGEST-MD5",req:xows_sasl_md5_req,res:xows_sasl_md5_resp,chk:xows_sasl_md5_chk},{name:"PLAIN",req:xows_sasl_plain_req,res:xows_sasl_plain_resp,chk:xows_sasl_plain_chk}];function xows_sasl_init(e,o,_,t,s,n){let c=-1;for(let o=0,_=q.length;o<_;++o)if(e.includes(q[o].name)){y=q[o].name,c=o;break}return-1!==c&&(A=n,E=s,F=q[c].req,v=q[c].res,k=q[c].chk,(b={}).authz=xows_str_to_utf8(o),b.authc=xows_str_to_utf8(_),b.passw=xows_str_to_utf8(t),!0)}let S=null,C=null,D=function(){},T=function(){},j=function(){};function xows_sck_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"open":D=o;break;case"recv":T=o;break;case"close":j=o}}function xows_sck_error(e){xows_log(0,"sck_error","Socket connection error"),S=null}function xows_sck_closed(e){if(1e3!==e.code){let o;switch(e.code){case 1001:o="Going Away";break;case 1002:o="Protocol error";break;case 1003:o="Unsupported Data";break;case 1004:o="Reserved";break;case 1005:o="No Status Rcvd";break;case 1006:o="Abnormal Closure";break;case 1007:o="Invalid frame payload data";break;case 1008:o="Policy Violation";break;case 1009:o="Message Too Big";break;case 1010:o="Mandatory Ext.";break;case 1011:o="Internal Error";break;case 1012:o="Service Restart";break;case 1013:o="Try Again Later";break;case 1014:o="Bad Gateway";break;case 1015:o="TLS handshake";break;default:o="Unhandled error ("+e.code+")"}xows_log(0,"sck_closed",o),j(t,"Socket connection error")}else xows_log(2,"sck_closed","socket closed"),j(3);S=null}function xows_sck_opened(e){xows_log(2,"sck_opened","socket connected"),D()}function xows_sck_recv(e){xows_log(3,"sck_recv",e.data,null,"#AB5655"),T(e.data)}function xows_sck_create(e,o){xows_log(3,"sck_create","socket connecting",e),(S=new WebSocket(C=e,o)).onclose=xows_sck_closed,S.onerror=xows_sck_error,S.onmessage=xows_sck_recv,S.onopen=xows_sck_opened}function xows_sck_destroy(){S&&(xows_log(3,"sck_destroy","closing WebSocket"),S.close(),S=null)}function xows_sck_send(e){S.send(e),xows_log(3,"sck_send",e,null,"#55ABAB")}let L=null,N=null;const I={bare:null,user:null,pass:null,regi:!1},M={full:null,bare:null,node:null,resc:null};let B=function(){};function xows_xmp_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"session":U=o;break;case"presence":Ne=o;break;case"subscrib":Ie=o;break;case"occupant":Me=o;break;case"presfail":Be=o;break;case"rostpush":he=o;break;case"message":oe=o;break;case"chatstate":ne=o;break;case"receipt":we=o;break;case"retract":ge=o;break;case"subject":_e=o;break;case"mucnoti":te=o;break;case"pubsub":Ze=o;break;case"jingle":Go=o;break;case"error":B=o;break;case"close":z=o}}function xows_xmp_connect(e,o,_,s){xows_sck_destroy(),xows_sck_set_callback("open",xows_xmp_sck_onopen),xows_sck_set_callback("recv",xows_xmp_sck_onrecv),xows_sck_set_callback("close",xows_xmp_sck_onclose),L=e,M.jbar=null,M.jful=null,M.node=null,M.resc=null;const n=o.split("@");if(N=null,void 0!==n[1]&&0!==n[1].length&&(N=n[1]),null===N){let e="Incomplete JID (undefined domain)";return xows_log(0,"xmp_connect",e),void z(t,e)}I.jbar=o,I.user=n[0],I.pass=_,I.regi=s,xows_sck_create(e,"xmpp")}function xows_xmp_connectloss(e){let o;M.resc?(xows_log(2,"xmp_connectloss","connection lost",M.resc),M.resc=null,o=s):o=t,z(o,e)}function xows_xmp_reconnect(){xows_log(2,"xmp_reconnect","try reconnect",L),L&&I.jbar&&I.user&&I.pass&&(xows_sck_destroy(),xows_sck_create(L,"xmpp"))}function xows_xmp_flyyoufools(){S&&(M.resc=null,I.user=null,S.send("<presence xmlns='jabber:client' type='unavailable'/>"),S.send("<close xmlns='urn:ietf:params:xml:ns:xmpp-framing'/>"))}function xows_xmp_sck_onopen(){xows_xmp_fram_open_send()}function xows_xmp_sck_onclose(e,o){I.user&&xows_xmp_connectloss(o)}function xows_xmp_message_forge(e,o,_,t,s,n,c,i,r,a,l,u,d,x,w){return n||(n=(new Date).getTime()),{id:e,to:o,from:_,type:t,body:s,time:n,recp:c,retr:i,repl:r,rpid:a,rpto:l,orid:u,szid:d,ocid:x,page:w}}const P="jabber:client";function xows_xmp_sck_onrecv(e){const o=xows_xml_parse(e).firstChild,_=o.tagName;return"iq"===_?xows_xmp_iq_recv(o):"message"===_?xows_xmp_message_recv(o):"presence"===_?xows_xmp_presence_recv(o):"challenge"===_?xows_xmp_sasl_challenge_recv(o):"success"===_?xows_xmp_sasl_success_recv(o):"failure"===_?xows_xmp_sasl_failure_recv(o):"open"===_?xows_xmp_fram_open_recv(o):"close"===_?xows_xmp_fram_close_recv(o):"stream:error"===_?xows_xmp_stream_error_recv(o):"stream:features"===_?xows_xmp_stream_features_recv(o):void xows_log(1,"xmp_recv","unprocessed stanza",event.data)}function xows_xmp_send(e,o,_){if(!S)return;"presence"!==e.tagName&&"message"!==e.tagName&&"iq"!==e.tagName||e.getAttribute("xmlns")||e.setAttribute("xmlns",P);let t=e.getAttribute("id");t||(t=xows_gen_uuid(),e.setAttribute("id",t)),xows_isfunc(o)&&W.set(t,{onresult:o,onparse:_}),xows_sck_send(xows_xml_serialize(e))}const O="urn:ietf:params:xml:ns:xmpp-framing";function xows_xmp_fram_open_recv(e){if("1.0"!=e.getAttribute("version")||e.getAttribute("xmlns")!=O){const e="Invalid server framing";xows_log(0,"xmp_fram_open_recv",e),xows_xmp_fram_close_send(t,e)}return!0}function xows_xmp_fram_open_send(){xows_log(2,"xmp_fram_open_send","open framed stream"),xows_xmp_send(xows_xml_node("open",{to:N,version:"1.0",xmlns:O}))}function xows_xmp_fram_close_recv(e){return xows_log(2,"xmp_fram_close_recv","framed stream closed"),M.resc?xows_xmp_connectloss("Server closed the stream"):(xows_sck_destroy(),z(3)),!0}function xows_xmp_fram_close_send(e,o){M.resc=null,xows_xmp_send(xows_xml_node("close",{xmlns:O})),xows_log(2,"xmp_fram_close_send","close framed stream"),e<0?z(e,o):(I.jbar=null,I.user=null,I.pass=null)}const R="urn:ietf:params:xml:ns:xmpp-sasl",G="urn:ietf:params:xml:ns:xmpp-bind",H="urn:ietf:params:xml:ns:xmpp-session";let U=function(){},z=function(){};const V=[];function xows_xmp_stream_error_recv(e){return xows_log(0,"xmp_stream_error_recv",e.firstChild.tagName,xows_xml_innertext(e.querySelector("text"))),xows_xmp_connectloss("Server thrown a stream error"),!0}function xows_xmp_stream_features_recv(e){const o=e.getElementsByTagName("mechanism");if(o.length){Y.length=0;for(let e=0,_=o.length;e<_;++e)Y.push(xows_xml_innertext(o[e]));if(xows_log(2,"xmp_stream_features_recv","received authentication mechanisms",Y.join(", ")),I.regi){if(e.querySelector("register"))xows_xmp_regi_get_query(null,xows_xmp_regi_server_get_parse);else{let e="Account registration is not allowed by server";xows_log(0,"xmp_stream_features_recv",e),xows_xmp_fram_close_send(t,e)}}else xows_xmp_sasl_auth_send();return!0}{V.length=0;let o=e.childNodes.length;for(;o--;)V.push(e.childNodes[o].getAttribute("xmlns"));xows_log(2,"xmp_stream_features_recv","received features",V.join(", ")),xows_xmp_bind_query()}return!1}const Y=[];function xows_xmp_sasl_auth_send(){if(!xows_sasl_init(Y,I.jbar,I.user,I.pass)){let e="Unable to find a suitable authentication mechanism";return xows_log(0,"xmp_sasl_auth_send",e),void xows_xmp_fram_close_send(t,e)}const e=xows_sasl_get_selected();xows_log(2,"xmp_sasl_auth_send","select authentication mechanism",e);const o=F();0!==o.length&&(xows_log(2,"xmp_sasl_auth_send","sending authentication request",o),xows_xmp_send(xows_xml_node("auth",{xmlns:R,mechanism:e},btoa(o))))}function xows_xmp_sasl_challenge_recv(e){const o=atob(xows_xml_innertext(e));xows_log(2,"xmp_sasl_challenge_recv","received authentication challenge",o);const _=v(o);return xows_log(2,"xmp_sasl_challenge_recv","sending challenge response",_),xows_xmp_send(xows_xml_node("response",{xmlns:R},btoa(_))),!0}function xows_xmp_sasl_failure_recv(e){let o;const _=e.firstChild.tagName;switch(_.toLowerCase()){case"not-authorized":o="Wrong username or password";break;default:o="Authentication failure"}return xows_log(0,"xmp_sasl_failure_recv",_),setTimeout(xows_xmp_fram_close_send,Ns.login_delay,t,o),!0}function xows_xmp_sasl_success_recv(e){const o=xows_xml_innertext(e);if(0!==o.length&&xows_log(2,"xmp_sasl_success_recv","received server proof signature",o),!k(atob(o))){const e="Server integrity check failed";return xows_log(0,"xmp_sasl_success_recv",e),xows_xmp_fram_close_send(t,e),!0}return xows_log(2,"xmp_sasl_success_recv","authentication success"),xows_xmp_fram_open_send(),!0}function xows_xmp_bind_parse(e){if("error"===e.getAttribute("type")){const o="bind resource error";return xows_xmp_error_log(e,0,"xmp_bind_parse",o),void xows_xmp_fram_close_send(t,o)}const o=xows_xml_innertext(e.querySelector("jid"));M.jful=o,M.jbar=xows_jid_bare(o),M.node=xows_jid_node(o),M.resc=xows_jid_resc(o),xows_log(2,"xmp_bind_parse","binded resource",M.jful),U(M)}function xows_xmp_bind_query(e=null){xows_log(2,"xmp_bind_query","query bind resource",e||"from server");const o=xows_xml_node("bind",{xmlns:G});e&&xows_xml_parent(o,xows_xml_node("resource",null,e)),xows_xmp_send(xows_xml_node("iq",{type:"set"},o),xows_xmp_bind_parse)}function xows_xmp_session_parse(e){if("error"===e.getAttribute("type")){const o="session establishment failure";return xows_xmp_error_log(e,0,"xmp_session_parse",o),void xows_xmp_fram_close_send(t,o)}xows_log(2,"xmp_session_parse","session established"),U(M)}function xows_xmp_session_query(){xows_log(2,"xmp_session_query","query for session"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("session",{xmlns:H})),xows_xmp_session_parse)}const J="urn:ietf:params:xml:ns:xmpp-stanzas",W=new Map;function xows_xmp_iq_recv(e){const o=e.getAttribute("id");if(W.has(o)){const _=W.get(o);return W.delete(o),xows_isfunc(_.onresult)&&_.onresult(e,_.onparse),!0}if("get"===e.getAttribute("type")){const o=e.firstChild;if(void 0!==o){const _=o.getAttribute("xmlns");if(_===Pe)return xows_xmp_ping_reply(e);if(_===Oe)return xows_xmp_iq_time_reply(e);if(_===Re)return xows_xmp_iq_version_reply(e);if(_===Ge)return xows_xmp_disco_info_reply(e)}return!1}if("set"===e.getAttribute("type")){const o=e.firstChild;if(void 0!==o){const _=o.getAttribute("xmlns");if(_===fe)return xows_xmp_rost_push_recv(e);if(_===Do)return xows_xmp_jing_recv(e)}return!1}return!1}function xows_xmp_iq_parse(e,o){const _=e.getAttribute("type");xows_isfunc(o)?o(e.getAttribute("from"),_,xows_xmp_error_parse(e)):"error"===_&&B(t,xows_xmp_error_log(e,1,"xmp_iq_parse"))}function xows_xmp_iq_error_send(e,o,_,t,s){xows_xmp_send(xows_xml_node("iq",{id:e,type:"error",to:o},xows_xml_node("error",{type:_},xows_xml_node(t,{xmlns:J},s))))}function xows_xmp_iq_result_send(e,o){xows_xmp_send(xows_xml_node("iq",{id:e,type:"result",to:o}))}function xows_xmp_error_log(e,o,_,t){let s;const n=e.querySelector("error");if(n){s=(s=(s=n.firstChild.tagName).replace(/-/g," "))[0].toUpperCase()+s.substring(1);const e=n.querySelector("text");e&&(s+=": "+xows_xml_innertext(e))}return t||(t="query error ("+e.getAttribute("id")+")"),xows_log(o,_,t,s),s}function xows_xmp_error_parse(e){let o=null;const _=e.querySelector("error");if(_){o={},_.hasAttribute("code")&&(o.code=_.getAttribute("code")),_.hasAttribute("type")&&(o.type=_.getAttribute("type")),_.firstChild&&(o.name=_.firstChild.tagName);const e=_.querySelector("text");e&&(o.text=xows_xml_innertext(e))}return o}const K="urn:xmpp:delay",X="urn:xmpp:message-correct:0",$="urn:xmpp:reply:0",Q="urn:xmpp:sid:0",Z="urn:xmpp:occupant-id:0",ee="urn:xmpp:styling:0";let oe=function(){},_e=function(){},te=function(){};function xows_xmp_message_recv(e){const o=e.getAttribute("id"),_=e.getAttribute("from"),t=e.getAttribute("to"),s=e.getAttribute("type");if("error"===s)return oe(xows_xmp_message_forge(o,t,_,s),xows_xmp_error_parse(e)),!0;let n,c,i,r,a,l,u,d,x,w=e.childNodes.length;for(;w--;){const p=e.childNodes[w];if(1!==p.nodeType)continue;const m=p.tagName,g=p.getAttribute("xmlns");if(g===co)return xows_xmp_mam_result_recv(p);if(g===Xe)return xows_xmp_pubsub_recv(_,p);if(g===Ye){const e=p.querySelector("message");return!!e&&xows_xmp_message_recv(e)}if(g===xe){if("request"===m){xows_xmp_message_receipt_send(_,o);continue}return we(o,_,t,p.getAttribute("id")),!0}if(g===pe)return ge(o,_,s,p.getAttribute("id")),!0;if("subject"===m)return _e(o,_,xows_xml_innertext(p)),!0;if(g!==wo)g!==se?g!==K?g!==Z?g!==Q?g!==$?g!==X?"body"!==m||(c=xows_xml_innertext(p)):r=p.getAttribute("id"):(a=p.getAttribute("id"),p.hasAttribute("to")&&(l=p.getAttribute("to"))):("origin-id"===m&&(u=p.getAttribute("id")),"stanza-id"===m&&(d=p.getAttribute("id"))):x=p.getAttribute("id"):n=new Date(p.getAttribute("stamp")).getTime():i=ue.get(m);else if("groupchat"===s){const e=p.querySelectorAll("status");if(e.length){const t=[];for(let o=0;o<e.length;++o)t.push(parseInt(e[o].getAttribute("code")));return te(o,_,t),!0}}}return c?(oe(xows_xmp_message_forge(o,t,_,s,c,n,null,null,r,a,l,u,d,x)),!0):void 0!==i?(ne(o,_,s,i,x),!0):(xows_log(1,"xmp_message_recv","unhandled message ("+_+")",s),!1)}function xows_xmp_message_body_send(e,o,_,t,s,n,c){const i=xows_gen_uuid(),r=xows_xml_node("message",{id:i,to:o,type:e},xows_xml_node("body",null,_));return xows_xml_parent(r,xows_xml_node("origin-id",{id:i,xmlns:Q})),s&&xows_xml_parent(r,xows_xml_node("replace",{id:s,xmlns:X})),n&&xows_xml_parent(r,xows_xml_node("reply",{id:n,to:c,xmlns:$})),t&&"chat"===e&&xows_xml_parent(r,xows_xml_node("request",{xmlns:xe})),xows_xmp_send(r),i}const se="http://jabber.org/protocol/chatstates";let ne=function(){};const ce=0,ie=1,re=2,ae=3,le=4,ue=new Map([["gone",0],["active",1],["inactive",2],["paused",3],["composing",4]]),de=["gone","active","inactive","paused","composing"];function xows_xmp_message_chatstate_send(e,o,_){xows_xmp_send(xows_xml_node("message",{to:e,type:o},xows_xml_node(de[_],{xmlns:se})))}const xe="urn:xmpp:receipts";let we=function(){};function xows_xmp_message_receipt_send(e,o){xows_xmp_send(xows_xml_node("message",{to:e},xows_xml_node("received",{id:o,xmlns:xe})))}const pe="urn:xmpp:message-retract:1",me="urn:xmpp:message-retract:1#tombstone";let ge=function(){};function xows_xmp_message_retract_send(e,o,_){const t=xows_xml_node("message",{to:e,type:o},xows_xml_node("retract",{id:_,xmlns:pe}));xows_xml_parent(t,xows_xml_node("store",{xmlns:"urn:xmpp:hints"})),xows_xmp_send(t)}const fe="jabber:iq:roster";let he=function(){};function xows_xmp_rost_push_recv(e){xows_xmp_send(xows_xml_node("iq",{id:e.getAttribute("id"),type:"result"},xows_xml_node("query",{xmlns:fe})));const o=e.querySelector("item"),_=o.getAttribute("jid"),t=o.getAttribute("name"),s=Le.get(o.getAttribute("subscription"));let n=o.querySelector("group");n=n?xows_xml_innertext(n):null,he(_,t,s,n)}function xows_xmp_rost_get_parse(e,o){if("error"===e.getAttribute("type"))return void xows_xmp_error_log(e,1,"xmp_rost_get_parse","get roster");const _=e.getElementsByTagName("item"),t=[];for(let e=0,o=_.length;e<o;++e)t.push({jid:_[e].getAttribute("jid"),name:_[e].getAttribute("name"),subs:Le.get(_[e].getAttribute("subscription")),group:xows_xml_innertext(_[e].querySelector("group"))});xows_isfunc(o)&&o(t)}function xows_xmp_rost_get_query(e){xows_xmp_send(xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:fe})),xows_xmp_rost_get_parse,e)}function xows_xmp_rost_set_query(e,o,_,t){const s=xows_xml_node("item",{jid:e});o?(s.setAttribute("name",o),_&&xows_xml_parent(s,xows_xml_node("group",null,_))):s.setAttribute("subscription","remove"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("query",{xmlns:fe},s)),xows_xmp_iq_parse,t)}const be=0,ye=1,Fe=2,ve=3,ke=4,Ae=5,Ee=new Map([["dnd",1],["xa",2],["away",3],["chat",5]]),qe=new Map([[1,"dnd"],[2,"xa"],[3,"away"],[4,null],[5,"chat"]]),Se=-1,Ce=0,De=1,Te=2,je=3,Le=new Map([["remove",-1],["none",0],["from",1],["to",2],["both",3]]);let Ne=function(){},Ie=function(){},Me=function(){},Be=function(){};function xows_xmp_presence_recv(e){const o=e.getAttribute("from");let _;if(e.hasAttribute("type")){const t=e.getAttribute("type");switch(t){case"unavailable":_=be;break;case"subscribe":case"unsubscribe":case"subscribed":case"unsubscribed":{const _=e.querySelector("nick"),s=_?xows_xml_innertext(_):null;Ie(o,t,s)}return!0;case"error":{const _=xows_xmp_error_parse(e);xows_log(1,"xmp_presence_recv","error",o+" - "+_.type),Be(o,_)}return!0}}let t,s,n,c,i,r=null,a=e.childNodes.length;for(;a--;){const o=e.childNodes[a];if(1!==o.nodeType)continue;const l=o.tagName,u=o.getAttribute("xmlns");switch(l){case"show":{const e=xows_xml_innertext(o);_=e?Ee.get(e):ke;continue}case"priority":t=xows_xml_innertext(o);continue;case"status":s=xows_xml_innertext(o);continue}switch(u){case We:{const e=o.querySelector("photo");e&&(r=xows_xml_innertext(e))}continue;case Ho:n={node:o.getAttribute("node"),ver:o.getAttribute("ver")};continue;case Z:c=o.getAttribute("id");continue;case wo:{const e=o.querySelector("item");i={affi:So.get(e.getAttribute("affiliation")),role:yo.get(e.getAttribute("role")),jful:e.getAttribute("jid"),nick:e.getAttribute("nick"),code:[]};const _=o.querySelectorAll("status");for(let e=0;e<_.length;++e)i.code.push(parseInt(_[e].getAttribute("code")))}continue}}return void 0!==i?Me(o,_,s,i,c,r):Ne(o,_,t,s,n,r),!0}function xows_xmp_presence_send(e,o,t,s,n,c,i){const r=xows_xml_node("presence");if(e&&r.setAttribute("to",e),o&&r.setAttribute("type",o),t>be&&(xows_xml_parent(r,xows_xml_node("show",null,qe.get(t))),xows_xml_parent(r,xows_xml_node("priority",null,20*t)),"string"==typeof i&&xows_xml_parent(r,xows_xml_node("x",{xmlns:We},xows_xml_node("photo",null,i))),xows_xml_parent(r,xows_xml_node("c",{xmlns:Ho,hash:"sha-1",node:_,ver:xows_xmp_caps_self_verif()}))),"string"==typeof s&&xows_xml_parent(r,xows_xml_node("status",null,s)),n&&xows_xml_parent(r,xows_xml_node("nick",{xmlns:to},n)),c){const e=xows_xml_node("x",{xmlns:xo});c.pass&&xows_xml_parent(e,xows_xml_node("password",null,c.pass)),xows_xml_parent(r,e)}xows_xmp_send(r)}const Pe="urn:xmpp:ping";function xows_xmp_ping_reply(e){const o=e.getAttribute("from");xows_xmp_send(xows_xml_node("iq",{id:e.getAttribute("id"),to:o,type:"result"}))}const Oe="urn:xmpp:time";function xows_xmp_iq_time_reply(e){const o=e.getAttribute("from"),_=e.getAttribute("id"),t=new Date;let s=t.getTimezoneOffset()/60,n=s<0?"-":"";n+=((s=Math.abs(s))>9?s:"0"+s)+":00";const c=t.toJSON();xows_xmp_send(xows_xml_node("iq",{to:o,id:_,type:"result"},xows_xml_node("time",{xmlns:Oe},[xows_xml_node("tzo",null,n),xows_xml_node("utc",null,c)])))}const Re="jabber:iq:version";function xows_xmp_iq_version_reply(_){xows_xmp_send(xows_xml_node("iq",{to:_.getAttribute("from"),id:_.getAttribute("id"),type:"result"},xows_xml_node("query",{xmlns:Re},[xows_xml_node("name",null,e),xows_xml_node("version",null,o)])))}const Ge="http://jabber.org/protocol/disco#info",He="http://jabber.org/protocol/disco#items";function xows_xmp_disco_info_reply(e){const o=e.getAttribute("from"),_=e.getAttribute("id"),t=e.querySelector("query"),s=t?t.getAttribute("node"):null,n=xows_xmp_caps_self_features();xows_xmp_send(xows_xml_node("iq",{to:o,id:_,type:"result"},xows_xml_node("query",{xmlns:Ge,node:s},n)))}function xows_xmp_disco_info_parse(e,o){const _=e.getAttribute("from"),t=[],s=[];if("error"===e.getAttribute("type"))return xows_xmp_error_log(e,1,"xmp_disco_info_parse","get disco#info"),void(xows_isfunc(o)&&o(_,t,s,null,null));const n=e.querySelector("query");let c,i,r;for(c=0,i=(r=n.getElementsByTagName("identity")).length;c<i;++c)t.push({category:r[c].getAttribute("category"),type:r[c].getAttribute("type"),name:r[c].getAttribute("name")});for(c=0,i=(r=n.getElementsByTagName("feature")).length;c<i;++c)r[c].hasAttribute("var")&&s.push(r[c].getAttribute("var"));const a=n.querySelector("x"),l=a?xows_xmp_xdata_parse(a):null;xows_isfunc(o)&&o(_,t,s,l,n.getAttribute("node"))}function xows_xmp_disco_info_query(e,o,_){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("query",{xmlns:Ge,node:o})),xows_xmp_disco_info_parse,_)}function xows_xmp_disco_items_parse(e,o){const _=e.getAttribute("from"),t=[];if("error"===e.getAttribute("type"))return xows_xmp_error_log(e,1,"xmp_disco_items_parse","get disco#items"),void(xows_isfunc(o)&&o(_,t));const s=e.getElementsByTagName("item");for(let e=0,o=s.length;e<o;++e)t.push({jid:s[e].getAttribute("jid"),name:s[e].getAttribute("name")});xows_isfunc(o)&&o(_,t)}function xows_xmp_disco_items_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("query",{xmlns:He})),xows_xmp_disco_items_parse,o)}const Ue="urn:xmpp:extdisco:2";function xows_xmp_extdisco_parse(e,o){const _=e.getAttribute("from"),t=[];if("error"===e.getAttribute("type"))return xows_xmp_error_log(e,1,"xmp_extdisco_parse","get extdisco"),void(xows_isfunc(o)&&o(_,t));let s,n,c;for(s=0,n=(c=e.querySelector("services").getElementsByTagName("service")).length;s<n;++s)t.push({type:c[s].getAttribute("type"),host:c[s].getAttribute("host"),port:c[s].getAttribute("port"),transport:c[s].getAttribute("transport"),username:c[s].getAttribute("username"),password:c[s].getAttribute("password"),restricted:c[s].getAttribute("restricted")});xows_isfunc(o)&&o(_,t)}function xows_xmp_extdisco_query(e,o,_){const t=xows_xml_node("services",{xmlns:Ue});o&&t.setAttribute("type",o),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},t),xows_xmp_extdisco_parse,_)}const ze="jabber:x:data";function xows_xmp_xdata_parse(e){const o=[],_=e.getElementsByTagName("field");for(let e=0;e<_.length;++e){const t={required:null!==_[e].querySelector("required"),type:_[e].getAttribute("type"),label:_[e].getAttribute("label"),var:_[e].getAttribute("var")},s=_[e].querySelector(":scope > desc");s&&(t.desc=xows_xml_innertext(s));const n=_[e].querySelectorAll(":scope > value");if(n.length){t.value=[];for(let e=0;e<n.length;++e)t.value.push(xows_xml_innertext(n[e]))}const c=_[e].querySelectorAll(":scope > option");if(c.length){t.option=[];for(let e=0;e<c.length;++e)t.option.push({label:c[e].getAttribute("label"),value:xows_xml_innertext(c[e].querySelector(":scope > value"))})}o.push(t)}return o}function xows_xmp_xdata_make(e){const o=xows_xml_node("x",{xmlns:ze,type:"submit"});if(e&&e.length){let _;for(let t=0,s=e.length;t<s;++t){if(_=xows_xml_node("field"),e[t].var&&_.setAttribute("var",e[t].var),e[t].type&&_.setAttribute("type",e[t].type),e[t].value){const o=e[t].value;for(let e=0;e<o.length;++e)xows_xml_parent(_,xows_xml_node("value",null,o[e]))}xows_xml_parent(o,_)}}return o}function xows_xmp_xdata_cancel(){return xows_xml_node("x",{xmlns:ze,type:"cancel"})}const Ve="jabber:iq:register";function xows_xmp_regi_get_parse(e,o){const _=e.getAttribute("from");if("error"===e.getAttribute("type"))return xows_xmp_error_log(e,1,"xmp_regi_get_parse","get "+Ve),void(xows_isfunc(o)&&o(_,null,null,xows_xmp_error_parse(e)));const t=e.querySelector("username"),s=e.querySelector("password"),n=e.querySelector("email"),c={registered:!!e.querySelector("registered"),username:t?xows_xml_innertext(t):null,password:s?xows_xml_innertext(s):null,email:n?xows_xml_innertext(n):null},i=e.querySelector("x"),r=i?xows_xmp_xdata_parse(i):null;xows_isfunc(o)&&o(_,c,r)}function xows_xmp_regi_get_query(e,o){const _=xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:Ve}));null!==e&&_.setAttribute("to",e),xows_xmp_send(_,xows_xmp_regi_get_parse,o)}function xows_xmp_regi_set_query(e,o,_,t){const s=xows_xml_node("query",{xmlns:Ve});null!==o&&(null!==o.username&&xows_xml_parent(s,xows_xml_node("username",null,o.username)),null!==o.password&&xows_xml_parent(s,xows_xml_node("password",null,o.password)),null!==o.email&&xows_xml_parent(s,xows_xml_node("email",null,o.email))),null!==_&&xows_xml_parent(s,xows_xmp_xdata_make(_));const n=xows_xml_node("iq",{type:"set"},s);null!==e&&n.setAttribute("to",e),xows_xmp_send(n,xows_xmp_iq_parse,t)}function xows_xmp_regi_server_set_parse(e,o,_){let s=null;"error"===o?("409"!==_.code&&"conflict"!==_.name||(s=_.text?_.text:"Unsername already exists"),"406"!==_.code&&"not-acceptable"!==_.name||(s=_.text?_.text:"Username contains illegal characters")):"result"===o?(xows_log(2,"xmp_regi_server_set_parse","success"),I.regi=!1,xows_xmp_sasl_auth_send()):s="Unexpected registration error",null!==s&&(xows_log(0,"xmp_regi_server_set_parse",s),setTimeout(xows_xmp_fram_close_send,Ns.login_delay,t,s))}function xows_xmp_regi_server_get_parse(e,o,_,t){if(void 0!==_){let e=_.length;for(;e--;)"username"===_[e].var&&(_[e].value=[I.user]),"password"===_[e].var&&(_[e].value=[I.pass])}else null!==o.username&&(o.username=I.user),null!==o.password&&(o.password=I.pass);xows_xmp_regi_set_query(null,o,_,xows_xmp_regi_server_set_parse)}function xows_xmp_regi_pass_set_parse(e,o){const _=e.getAttribute("type");let t=null;if("error"===_){xows_xmp_error_log(e,1,"xmp_regi_pass_set_parse","set "+Ve);const o=e.querySelector("x");o&&(t=xows_xmp_xdata_parse(o))}xows_isfunc(o)&&o(_,t,xows_xmp_error_parse(e))}function xows_xmp_regi_pass_set_query(e,o,_){const t=xows_xml_node("query",{xmlns:Ve});e&&(xows_xml_parent(t,xows_xml_node("username",null,I.user)),xows_xml_parent(t,xows_xml_node("password",null,e))),null!==o&&xows_xml_parent(t,xows_xmp_xdata_make(o)),xows_xmp_send(xows_xml_node("iq",{type:"set"},t),xows_xmp_regi_pass_set_parse,_)}function xows_xmp_regi_remove_parse(e,o){const _=e.getAttribute("type");let t=null;if("error"===_){xows_xmp_error_log(e,1,"xmp_regi_remove_parse","set "+Ve);const o=e.querySelector("x");o&&(t=xows_xmp_xdata_parse(o))}xows_isfunc(o)&&o(_,t,xows_xmp_error_parse(e))}function xows_xmp_regi_remove_query(e,o){const _=xows_xml_node("query",{xmlns:Ve});xows_xml_parent(_,null!==e?xows_xmp_xdata_make(e):xows_xml_node("remove")),xows_xmp_send(xows_xml_node("iq",{type:"set"},_),xows_xmp_regi_remove_parse,o)}const Ye="urn:xmpp:carbons:2";function xows_xmp_carbons_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node(e?"enable":"disable",{xmlns:Ye})),xows_xmp_iq_parse,o)}const Je="vcard-temp",We="vcard-temp:x:update";function xows_xmp_vcardt_set_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"set",to:M.jbar},xows_xml_node("vCard",{xmlns:Je},e)),xows_xmp_iq_parse,o)}function xows_xmp_vcardt_get_parse(e,o){if(!xows_isfunc(o))return;const _=e.getAttribute("from");"error"===e.getAttribute("type")?o(_,null,xows_xmp_error_parse(e)):o(_,e.querySelector("vCard"))}function xows_xmp_vcardt_get_query(e,o){const _=xows_xml_node("iq",{type:"get"},xows_xml_node("vCard",{xmlns:Je}));null!==e&&_.setAttribute("to",e),xows_xmp_send(_,xows_xmp_vcardt_get_parse,o)}const Ke="http://jabber.org/protocol/pubsub",Xe="http://jabber.org/protocol/pubsub#event",$e="http://jabber.org/protocol/pubsub#owner",Qe="http://jabber.org/protocol/pubsub#publish-options";let Ze=function(){};function xows_xmp_pubsub_recv(e,o){const _=o.querySelector("items");if(!_)return!1;const t=_.getAttribute("node"),s=[];for(let e=0,o=_.childNodes.length;e<o;++e)s.push({id:_.childNodes[e].getAttribute("id"),child:_.childNodes[e].firstChild});return Ze(e,t,s),!0}function xows_xmp_pubsub_publish(e,o,_,t){const s=[o];_&&s.push(xows_xml_node("publish-options",{node:e},xows_xmp_xdata_make([{var:"FORM_TYPE",type:"hidden",value:[Qe]},{var:"pubsub#access_model",value:[_]}]))),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:Ke},s)),xows_xmp_iq_parse,t)}function xows_xmp_pubsub_conf_get_parse(e,o){const _=e.getAttribute("from");if(xows_isfunc(o))if("error"==e.getAttribute("type"))o(_,null,xows_xmp_error_parse(e));else{o(_,e.querySelector("configure").getAttribute("node"),xows_xmp_xdata_parse(e.querySelector("x")),null)}}function xows_xmp_pubsub_conf_get_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"get"},xows_xml_node("pubsub",{xmlns:$e},xows_xml_node("configure",{node:e}))),xows_xmp_pubsub_conf_get_parse,o)}function xows_xmp_pubsub_conf_set_query(e,o,_){const t=xows_xmp_xdata_make(o);xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:$e},xows_xml_node("configure",{node:e},t))),xows_xmp_iq_parse,_)}function xows_xmp_pubsub_retract(e,o,_){const t=xows_xml_node("item",{id:o});xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:Ke},xows_xml_node("retract",{node:e},t))),xows_xmp_iq_parse,_)}const eo="urn:xmpp:bookmarks:1";function xows_xmp_bookmark_publish(e,o,_,t,s){const n=xows_xml_node("conference",{xmlns:eo,name:o,autojoin:_});t&&xows_xml_parent(n,xows_xml_node("nick",null,t));const c=xows_xml_node("publish",{node:eo},xows_xml_node("item",{id:e},n));xows_xmp_pubsub_publish(eo,c,"whitelist",s)}const oo="urn:xmpp:vcard4",_o="urn:ietf:params:xml:ns:vcard-4.0";function xows_xmp_vcard4_publish(e,o,_){const t=xows_xml_node("publish",{node:oo},xows_xml_node("item",null,xows_xml_node("vcard",{xmlns:_o},e)));xows_xmp_pubsub_publish(oo,t,o,_)}function xows_xmp_vcard4_get_parse(e,o){if(!xows_isfunc(o))return;const _=e.getAttribute("from");"error"===e.getAttribute("type")?o(_,null,xows_xmp_error_parse(e)):o(_,e.querySelector("vcard"))}function xows_xmp_vcard4_get_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("vcard",{xmlns:_o})),xows_xmp_vcard4_get_parse,o)}const to="http://jabber.org/protocol/nick";function xows_xmp_nick_publish(e,o){const _=xows_xml_node("publish",{node:to},xows_xml_node("item",null,xows_xml_node("nick",{xmlns:to},e)));xows_xmp_pubsub_publish(to,_,null,o)}function xows_xmp_nick_get_parse(e,o){if(!xows_isfunc(o))return;const _=e.getAttribute("from");"error"===e.getAttribute("type")?o(_,null,xows_xmp_error_parse(e)):o(_,e.querySelector("nick"))}function xows_xmp_nick_get_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:Ke},xows_xml_node("items",{node:to},xows_xml_node("item",null)))),xows_xmp_nick_get_parse,o)}const so="urn:xmpp:avatar:data",no="urn:xmpp:avatar:metadata";function xows_xmp_avat_data_publish(e,o,_,t){const s=xows_xml_node("publish",{node:so},xows_xml_node("item",{id:e},xows_xml_node("data",{xmlns:so},o)));xows_xmp_pubsub_publish(so,s,_,t)}function xows_xmp_avat_meta_publish(e,o,_,t,s,n,c){const i=xows_xml_node("info",{id:e,type:o,bytes:_,width:t,height:s}),r=xows_xml_node("publish",{node:no},xows_xml_node("item",{id:e},xows_xml_node("metadata",{xmlns:no},i)));xows_xmp_pubsub_publish(no,r,n,c)}function xows_xmp_avat_data_get_parse(e,o){if(!xows_isfunc(o))return;const _=e.getAttribute("from");if("error"===e.getAttribute("type"))o(_,null,null,xows_xmp_error_parse(e));else{let _=null,t=null;const s=e.querySelector("item");s&&(_=s.getAttribute("id"),t=xows_xml_innertext(s.querySelector("data"))),o(e.getAttribute("from"),_,t)}}function xows_xmp_avat_data_get_query(e,o,_){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:Ke},xows_xml_node("items",{node:so},xows_xml_node("item",{id:o})))),xows_xmp_avat_data_get_parse,_)}function xows_xmp_avat_meta_get_parse(e,o){if(!xows_isfunc(o))return;const _=e.getAttribute("from");"error"===e.getAttribute("type")?o(_,null,xows_xmp_error_parse(e)):o(_,e.querySelector("metadata"))}function xows_xmp_avat_meta_get_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:Ke},xows_xml_node("items",{node:no}))),xows_xmp_avat_meta_get_parse,o)}const co="urn:xmpp:mam:2",io="http://jabber.org/protocol/rsm",ro=new Map,ao=new Map;function xows_xmp_mam_result_recv(e){const o=e.getAttribute("id"),_=e.getAttribute("queryid");if(!ro.has(_))return void xows_log(1,"xmp_recv_mam_result","unknown queryid for MAM result",_);const t=e.querySelector("forwarded");if(!t)return!1;const s=t.querySelector("message");if(!s)return!1;const n=s.getAttribute("id"),c=s.getAttribute("type"),i=s.getAttribute("from"),r=s.getAttribute("to");let a,l,u,d,x,w,p,m,g;const f=s.childNodes.length;for(let e=0;e<f;++e){const o=s.childNodes[e];if(1!==o.nodeType)continue;const _=o.getAttribute("xmlns"),t=o.tagName;_!==se&&(_!==xe?_!==pe?_!==X?_!==$?_!==Q?_!==Z?"body"===t&&(a=o.hasChildNodes()?xows_xml_innertext(o):""):g=o.getAttribute("id"):("origin-id"===t&&(p=o.getAttribute("id")),"stanza-id"===t&&(m=o.getAttribute("id"))):(x=o.getAttribute("id"),o.hasAttribute("to")&&(w=o.getAttribute("to"))):u=o.getAttribute("id"):d=o.getAttribute("id"):l=o.getAttribute("id"))}let h=null;const b=t.querySelector("delay");return b&&(h=new Date(b.getAttribute("stamp")).getTime()),d&&(a=null),m||(m=o),ro.get(_).push(xows_xmp_message_forge(n,r,i,c,a,h,l,d,u,x,w,p,m,g,o)),xows_log(2,"xmp_recv_mam_result","Adding archived message to result stack","from "+i),!0}function xows_xmp_mam_parse(e,o){const _=e.getAttribute("id");if(!ao.has(_))return void xows_log(1,"xmp_mam_parse","MAM query id not found",_);const t=ao.get(_);if(ao.delete(_),"error"===e.getAttribute("type"))return void xows_xmp_error_log(e,1,"xmp_mam_parse","get "+co);if(!ro.has(t.qid))return void xows_log(1,"xmp_mam_parse","MAM result queryid not found",t.qid);const s=ro.get(t.qid);ro.delete(t.qid);const n=e.querySelector("fin");if(n){let e,_,c,i,r,a,l=0;if(i="true"===n.getAttribute("complete"),(e=n.querySelector("count"))&&(l=parseInt(xows_xml_innertext(e))),!(e=n.querySelector("first")))return xows_log(2,"xmp_mam_parse","No result received"),void(xows_isfunc(o)&&o(t.to,t.jid,[],l,i));_=xows_xml_innertext(e),(e=n.querySelector("last"))&&(c=xows_xml_innertext(e));const u=s.length;for(r=0;r<u&&s[r].page!==_;r++);if(r>=u)xows_log(0,"xmp_mam_parse","first result page not found in stack",_),a=[];else{let e=r,o=0;do{if(r===u){xows_log(1,"xmp_mam_parse","last result page not found (reached end of stack)",c);break}o++}while(s[r++].page!==c);a=s.splice(e,o)}xows_log(2,"xmp_mam_parse","results collected","("+a.length+"/"+l+") '"+_+"'=>'"+c+"'"),xows_isfunc(o)&&o(t.to,t.jid,a,l,i)}}function xows_xmp_mam_query(e,o,_,t,s,n,c){const i=[];i.push({var:"FORM_TYPE",type:"hidden",value:[co]}),_&&i.push({var:"with",value:[_]}),t&&i.push({var:"start",value:[new Date(t).toJSON()]}),s&&i.push({var:"end",value:[new Date(s).toJSON()]});const r=xows_xml_node("set",{xmlns:io},xows_xml_node("max",null,o));!n&&t||xows_xml_parent(r,xows_xml_node("before",null,n));const a=xows_gen_nonce_asc(12);ro.set(a,[]);const l=xows_gen_uuid(),u=xows_xml_node("iq",{id:l,type:"set"},xows_xml_node("query",{xmlns:co,queryid:a},[xows_xmp_xdata_make(i),r]));null!==e&&u.setAttribute("to",e),ao.set(l,{to:e,jid:_,qid:a}),xows_log(2,"xmp_mam_query","send Archive query","with "+_+" start "+t+" end "+s),xows_xmp_send(u,xows_xmp_mam_parse,c)}const lo="urn:xmpp:http:upload:0",uo=new Map;function xows_xmp_upld_parse(e,o){const _=e.getAttribute("id");if(!uo.has(_))return void xows_log(1,"xmp_upld_parse","query parameters not found");const t=uo.get(_);if(uo.delete(_),"error"===e.getAttribute("type")){const _=xows_xmp_error_log(e,1,"xmp_upld_parse","get "+lo);return void(xows_isfunc(o)&&o(t.name,null,null,null,_))}const s=e.querySelector("slot"),n=s.querySelector("put"),c=n.getAttribute("url"),i=n.getElementsByTagName("header"),r=s.querySelector("get").getAttribute("url");xows_isfunc(o)&&o(t.name,c,i,r)}function xows_xmp_upld_query(e,o,_,t,s){let n={xmlns:lo,filename:o,size:_};t&&(n.type=t);const c=xows_gen_uuid(),i=xows_xml_node("iq",{id:c,to:e,type:"get"},xows_xml_node("request",n));uo.set(c,{name:o}),xows_xmp_send(i,xows_xmp_upld_parse,s)}const xo="http://jabber.org/protocol/muc",wo="http://jabber.org/protocol/muc#user",po="http://jabber.org/protocol/muc#owner",mo="http://jabber.org/protocol/muc#admin",go=0,fo=1,ho=2,bo=3,yo=new Map([["none",0],["visitor",1],["participant",2],["moderator",3]]),Fo=new Map([[0,"none"],[1,"visitor"],[2,"participant"],[3,"moderator"]]),vo=-1,ko=0,Ao=1,Eo=2,qo=3,So=new Map([["outcast",-1],["none",0],["member",1],["admin",2],["owner",3]]),Co=new Map([[-1,"outcast"],[0,"none"],[1,"member"],[2,"admin"],[3,"owner"]]);function xows_xmp_muc_cfg_get_parse(e,o){"error"!==e.getAttribute("type")?xows_isfunc(o)&&o(e.getAttribute("from"),xows_xmp_xdata_parse(e.querySelector("x"))):xows_xmp_error_log(e,1,"xmp_muc_cfg_get_parse","get "+po)}function xows_xmp_muc_cfg_get_guery(e,o){xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("query",{xmlns:po})),xows_xmp_muc_cfg_get_parse,o)}function xows_xmp_muc_cfg_set_cancel(e,o){const _=xows_xmp_xdata_cancel();xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:po},_)),xows_xmp_iq_parse,o)}function xows_xmp_muc_cfg_set_query(e,o,_){const t=xows_xmp_xdata_make(o);xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:po},t)),xows_xmp_iq_parse,_)}function xows_xmp_muc_destroy_query(e,o,_,t,s){const n=xows_xml_node("destroy",null,null);o&&n.setAttribute("jid",o),_&&xows_xml_parent(n,xows_xml_node("password",null,_)),t&&xows_xml_parent(n,xows_xml_node("reason",null,t)),xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:po},n)),xows_xmp_iq_parse,s)}function xows_xmp_muc_affi_set_query(e,o,_){const t=xows_xml_node("query",{xmlns:mo}),s=o.reason?xows_xml_node("reason",null,o.reason):null;xows_xml_parent(t,xows_xml_node("item",{jid:o.jid,affiliation:Co.get(o.affi)},s)),xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},t),xows_xmp_iq_parse,_)}function xows_xmp_muc_affi_get_parse(e,o){if("error"!==e.getAttribute("type")){if(xows_isfunc(o)){const _=e.querySelector("query").childNodes,t=[];for(let e=0,o=_.length;e<o;++e)t.push({affi:So.get(_[e].getAttribute("affiliation")),jid:_[e].getAttribute("jid"),nick:_[e].getAttribute("nick")});o(e.getAttribute("from"),t)}}else xows_xmp_error_log(e,1,"xmp_muc_affi_get_parse","get "+mo)}function xows_xmp_muc_affi_get_query(e,o,_){xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("query",{xmlns:mo},xows_xml_node("item",{affiliation:o}))),xows_xmp_muc_affi_get_parse,_)}function xows_xmp_muc_subject_send(e,o){const _=xows_gen_uuid();return xows_xmp_send(xows_xml_node("message",{id:_,to:e,type:"groupchat"},xows_xml_node("subject",null,xows_xml_escape(o)))),_}function xows_xmp_muc_role_set_query(e,o,_){const t=xows_xml_node("query",{xmlns:mo}),s=o.reason?xows_xml_node("reason",null,o.reason):null;xows_xml_parent(t,xows_xml_node("item",{nick:o.nick,role:Fo.get(o.role)},s)),xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},t),xows_xmp_iq_parse,_)}function xows_xmp_muc_role_get_parse(e,o){if("error"!==e.getAttribute("type")){if(xows_isfunc(o)){const _=e.querySelector("query").childNodes,t=[];for(let e=0,o=_.length;e<o;++e)t.push({role:yo.get(_[e].getAttribute("role")),nick:_[e].getAttribute("nick")});o(e.getAttribute("from"),t)}}else xows_xmp_error_log(e,1,"xmp_muc_role_get_parse","get "+mo)}function xows_xmp_muc_role_get_query(e,o,_){xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("query",{xmlns:mo},xows_xml_node("item",{role:o}))),xows_xmp_muc_role_get_parse,_)}function xows_xmp_muc_nick_parse(e,o){if(!xows_isfunc(o))return;const _=e.querySelector("identity"),t=_?_.getAttribute("name"):null;o(e.getAttribute("from"),t)}function xows_xmp_muc_nick_query(e,o){xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("query",{xmlns:Ge,node:"x-roomuser-item"})),xows_xmp_muc_nick_parse,o)}const Do="urn:xmpp:jingle:1",To="urn:xmpp:jingle:apps:rtp:1",jo="urn:xmpp:jingle:apps:rtp:audio",Lo="urn:xmpp:jingle:apps:rtp:video",No="urn:xmpp:jingle:transports:ice-udp:1",Io="urn:xmpp:jingle:apps:rtp:rtcp-fb:0",Mo="urn:xmpp:jingle:apps:rtp:rtp-hdrext:0",Bo="urn:xmpp:jingle:apps:dtls:0",Po="urn:xmpp:jingle:apps:grouping:0",Oo="urn:xmpp:jingle:apps:rtp:ssma:0",Ro="urn:xmpp:jingle:apps:rtp:info:1";let Go=function(){};function xows_xmp_jing_jingle2sdp(e){const o=e.querySelectorAll("description");for(let e=0;e<o.length;++e)if(o[e].getAttribute("xmlns")!==To)return null;let _="v=0\r\no=- "+Math.round(Date.now()/1)+" 0 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\n";const t=e.querySelector("group");if(t){_+="a=group:"+t.getAttribute("semantics");const e=t.querySelectorAll("content");for(let o=0;o<e.length;++o)_+=" "+e[o].getAttribute("name");_+="\r\n"}const s=e.querySelectorAll(":scope > content");for(let e=0;e<s.length;++e){const o=s[e].querySelector("description"),t=s[e].querySelector("transport"),n=t.querySelectorAll("fingerprint");_+="m="+o.getAttribute("media"),_+=n.length?" 1 RTP/SAVPF":" RTP/AVPF";const c=o.querySelectorAll("payload-type");for(let e=0;e<c.length;++e)_+=" "+c[e].getAttribute("id");switch(_+="\r\n",_+="c=IN IP4 0.0.0.0\r\n",t.getAttribute("senders")){case"both":_+="a=sendrecv";break;case"initiator":_+="a=sendonly";break;case"responder":_+="a=recvonly";break;case"none":_+="a=inactive"}_+="\r\n",_+="a=mid:"+s[e].getAttribute("name")+"\r\n",t.hasAttribute("ufrag")&&(_+="a=ice-ufrag:"+t.getAttribute("ufrag")+"\r\n"),t.hasAttribute("pwd")&&(_+="a=ice-pwd:"+t.getAttribute("pwd")+"\r\n");const i=t.querySelectorAll("fingerprint");for(let e=0;e<i.length;++e)_+="a=fingerprint:"+i[e].getAttribute("hash")+" "+xows_xml_innertext(i[e])+"\r\n";i.length&&(_+="a=setup:"+i[0].getAttribute("setup")+"\r\n");const r=o.querySelectorAll("rtp-hdrext");for(let e=0;e<r.length;++e)_+="a=extmap:"+r[e].getAttribute("id"),"initiator"==r[e].getAttribute("senders")&&(_+="/recvonly"),_+=" "+r[e].getAttribute("uri")+"\r\n";for(let e=0;e<c.length;++e){const o=c[e].querySelectorAll("parameter");if(o.length){_+="a=fmtp:"+c[e].getAttribute("id")+" ";for(let e=0;e<o.length;++e)_+=o[e].getAttribute("name")+"="+o[e].getAttribute("value"),e<o.length-1&&(_+=";");_+="\r\n"}}for(let e=0;e<c.length;++e){const o=c[e].querySelectorAll("rtcp-fb");if(o.length)for(let t=0;t<o.length;++t)_+="a=rtcp-fb:"+c[e].getAttribute("id"),_+=" "+o[t].getAttribute("type"),o[t].hasAttribute("subtype")&&(_+=" "+o[t].getAttribute("subtype")),_+="\r\n"}o.querySelector("rtcp-mux")&&(_+="a=rtcp-mux\r\n");for(let e=0;e<c.length;++e)_+="a=rtpmap:"+c[e].getAttribute("id")+" ",_+=c[e].getAttribute("name"),c[e].hasAttribute("clockrate")&&(_+="/"+c[e].getAttribute("clockrate")),c[e].hasAttribute("channels")&&(_+="/"+c[e].getAttribute("channels")),_+="\r\n";const a=o.querySelectorAll("source");for(let e=0;e<a.length;++e){_+="a=ssrc:"+a[e].getAttribute("ssrc");const o=a[e].querySelector("parameter");o&&(_+=" "+o.getAttribute("name")+":"+o.getAttribute("value")),_+="\r\n"}const l=o.querySelectorAll("ssrc-group");for(let e=0;e<l.length;++e){_+="a=ssrc-group:"+l[e].getAttribute("semantics");const o=l[e].querySelectorAll("source");for(let e=0;e<o.length;++e)_+=" "+o[e].getAttribute("ssrc");_+="\r\n"}const u=t.querySelectorAll("candidate");for(let e=0;e<u.length;++e)_+="a=candidate:"+u[e].getAttribute("foundation"),_+=" "+u[e].getAttribute("component"),_+=" "+u[e].getAttribute("protocol").toUpperCase(),_+=" "+u[e].getAttribute("priority"),_+=" "+u[e].getAttribute("ip"),_+=" "+u[e].getAttribute("port"),u[e].hasAttribute("type")&&(_+=" typ "+u[e].getAttribute("type")),u[e].hasAttribute("rel-addr")&&(_+=" raddr "+u[e].getAttribute("rel-addr")),u[e].hasAttribute("rel-port")&&(_+=" rport "+u[e].getAttribute("rel-port")),u[e].hasAttribute("generation")&&(_+=" generation "+u[e].getAttribute("generation")),_+="\r\n"}return _}function xows_xmp_jing_sdp2jingle(e){const o=xows_sdp_parse(e),_=xows_xml_node("jingle",{xmlns:Do}),t=xows_xml_node("group",{xmlns:Po,semantics:o.group.type});for(const e in o.group.mids)xows_xml_parent(t,xows_xml_node("content",{name:e}));xows_xml_parent(_,t);for(let e=0;e<o.media.length;++e){const t=xows_xml_node("content",{creator:"initiator",name:o.media[e].mid}),s=xows_xml_node("description",{xmlns:To,media:o.media[e].type});if(o.media[e].rtpmap){const _=o.media[e].rtpmap;for(let e=0;e<_.length;++e)xows_xml_parent(s,xows_xml_node("payload-type",{id:_[e].payload,name:_[e].codec,clockrate:_[e].rate,channels:_[e].channels}))}if(o.media[e].fmtp){const _=o.media[e].fmtp;for(let e=0;e<_.length;++e){const o=s.querySelector("payload-type[id='"+_[e].payload+"']");if(o)for(let t=0;t<_[e].config.length;++t){const s=_[e].config[t].split("=");xows_xml_parent(o,xows_xml_node("parameter",{name:s[0],value:s[1]}))}}}if(o.media[e].rtcpFb){const _=o.media[e].rtcpFb;for(let e=0;e<_.length;++e){const o=s.querySelector("payload-type[id='"+_[e].payload+"']");o&&xows_xml_parent(o,xows_xml_node("rtcp-fb",{xmlns:Io,type:_[e].type,subtype:_[e].subtype}))}}if(o.media[e].ssrcGroup){const _=o.media[e].ssrcGroup;for(let e=0;e<_.length;++e){const o=xows_xml_node("ssrc-group",{xmlns:Oo,semantics:_[e].semantics});for(let t=0;t<_[e].ssrcs.length;++t)xows_xml_parent(o,xows_xml_node("source",{ssrc:_[e].ssrcs[t]}));xows_xml_parent(s,o)}}if(o.media[e].ssrc){const _=o.media[e].ssrc;for(let e=0;e<_.length;++e)xows_xml_parent(s,xows_xml_node("source",{xmlns:Oo,ssrc:_[e].id},xows_xml_node("parameter",{name:_[e].attribute,value:_[e].value})))}if(o.media[e].extmap){const _=o.media[e].extmap;for(let e=0;e<_.length;++e){const o=xows_xml_node("rtp-hdrext",{xmlns:Mo,id:_[e].value,uri:_[e].uri});"recvonly"===_[e].direction&&o.setAttribute("senders","initiator"),xows_xml_parent(s,o)}}o.media[e].rtcpMux&&xows_xml_parent(s,xows_xml_node("rtcp-mux")),xows_xml_parent(t,s);const n=xows_xml_node("transport",{xmlns:No,pwd:o.media[e].icePwd,ufrag:o.media[e].iceUfrag});switch(o.media[e].direction){case"sendrecv":n.setAttribute("senders","both");break;case"sendonly":n.setAttribute("senders","initiator");break;case"recvonly":n.setAttribute("senders","responder");break;case"inactive":n.setAttribute("senders","none")}if(o.media[e].fingerprint||o.fingerprint){const _=o.media[e].fingerprint?o.media[e].fingerprint:o.fingerprint;for(let t=0;t<_.length;++t)xows_xml_parent(n,xows_xml_node("fingerprint",{xmlns:Bo,hash:_[t].type,setup:o.media[e].setup},_[t].hash))}if(o.media[e].candidate){const _=o.media[e].candidate;for(let e=0;e<_.length;++e){xows_xml_parent(n,xows_xml_node("candidate",{component:_[e].component,network:_[e].network,foundation:_[e].foundation,generation:_[e].generation,protocol:_[e].protocol,priority:_[e].priority,ip:_[e].ip,port:_[e].port,type:_[e].type,"rel-addr":_[e].raddr,"rel-port":_[e].rport}))}}xows_xml_parent(t,n),xows_xml_parent(_,t)}return _}function xows_xmp_jing_recv(e){const o=e.getAttribute("id"),_=e.getAttribute("from"),t=e.querySelector("jingle"),s=t.getAttribute("action");let n;if("session-terminate"===s){const e=t.querySelector("reason");e&&e.childNodes[0]&&(n=e.childNodes[0].tagName)}else if("session-info"===s)switch(n=t.childNodes[0].tagName){case"ringing":break;default:return void xows_xmp_iq_error_send(o,_,"error","feature-not-implemented",xows_xml_node("unsupported-info"))}else if(null===(n=xows_xmp_jing_jingle2sdp(t)))return xows_log(1,"xmp_recv_jingle","error","RTP to SDP conversion failed"),void xows_xmp_iq_error_send(o,_,"cancel","bad-request");xows_xmp_iq_result_send(o,_),Go(_,o,t.getAttribute("sid"),s,n)}function xows_xmp_jing_result(e,o){const _=e.getAttribute("from"),t=e.getAttribute("type");"error"!==t?xows_isfunc(o)&&o(_,t,null):xows_isfunc(o)&&o(_,t,xows_xmp_error_parse(e))}function xows_xmp_jing_initiate_sdp(e,o,_){const t=xows_xmp_jing_sdp2jingle(o),s=xows_gen_nonce_asc(16);return t.setAttribute("initiator",M.jful),t.setAttribute("action","session-initiate"),t.setAttribute("sid",s),xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},t),xows_xmp_jing_result,_),s}function xows_xmp_jing_accept_sdp(e,o,_,t){const s=xows_xmp_jing_sdp2jingle(_);s.setAttribute("responder",M.jful),s.setAttribute("action","session-accept"),s.setAttribute("sid",o),xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},s),xows_xmp_jing_result,t)}function xows_xmp_jing_info(e,o,_,t,s){let n={xmlns:Ro};t&&(n=Object.assign(n,t)),xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},xows_xml_node("jingle",{xmlns:Do,sid:o,action:"session-info"},xows_xml_node(_,n,null))),xows_xmp_jing_result,s)}function xows_xmp_jing_terminate(e,o,_,t){xows_xmp_send(xows_xml_node("iq",{type:"set",to:e},xows_xml_node("jingle",{xmlns:Do,sid:o,action:"session-terminate"},xows_xml_node("reason",null,xows_xml_node(_)))),xows_xmp_jing_result,t)}const Ho="http://jabber.org/protocol/caps";function xows_xmp_caps_self_features(){let o=no;return Ns.avatar_notify&&(o+="+notify"),[xows_xml_node("identity",{category:"client",name:e,type:"web"}),xows_xml_node("feature",{var:Ho}),xows_xml_node("feature",{var:Ge}),xows_xml_node("feature",{var:He}),xows_xml_node("feature",{var:Pe}),xows_xml_node("feature",{var:Oe}),xows_xml_node("feature",{var:Re}),xows_xml_node("feature",{var:se}),xows_xml_node("feature",{var:xe}),xows_xml_node("feature",{var:X}),xows_xml_node("feature",{var:ee}),xows_xml_node("feature",{var:Q}),xows_xml_node("feature",{var:pe}),xows_xml_node("feature",{var:$}),xows_xml_node("feature",{var:Je}),xows_xml_node("feature",{var:so}),xows_xml_node("feature",{var:o}),xows_xml_node("feature",{var:eo+"+notify"}),xows_xml_node("feature",{var:Do}),xows_xml_node("feature",{var:To}),xows_xml_node("feature",{var:jo}),xows_xml_node("feature",{var:Lo})]}function xows_xmp_caps_self_verif(){const e=xows_xmp_caps_self_features();let o,_=e.length,t="";for(o=0;o<_;++o)"identity"===e[o].tagName&&(t+=e[o].getAttribute("category")+"/",t+=e[o].getAttribute("type")+"/",t+=(e[o].hasAttribute("xml:lang")?e[o].getAttribute("xml:lang"):"")+"/",t+=e[o].getAttribute("name")+"<");for(o=0;o<_;++o)"feature"===e[o].tagName&&(t+=e[o].getAttribute("var")+"<");return xows_bytes_to_b64(xows_hash_sha1(t))}function xows_cach_peer_iden(e){return e.type===c_&&e.ocid?e.ocid:e.addr}const Uo=new Map;function xows_cach_avat_save(e,o,_){const t=o||xows_bytes_to_hex(xows_hash_sha1(xows_url_to_bytes(e)));return Uo.set(t,e),_||localStorage.setItem(t,e),t}function xows_cach_avat_has(e){return!!Uo.has(e)||!!localStorage.hasOwnProperty(e)}function xows_cach_avat_get(e){return Uo.has(e)?Uo.get(e):localStorage.hasOwnProperty(e)?(Uo.set(e,localStorage.getItem(e)),Uo.get(e)):null}function xows_cach_avat_temp_data(e,o){const _=xows_hash_sdbm(e);if(o||(o=xows_bytes_to_hex(_)),Uo.has(o))return Uo.get(o);{const e=xows_gen_avatar(I_,null,xows_bytes_to_int(_));return Uo.set(o,e),e}}function xows_cach_avat_temp_hash(e){return xows_bytes_to_hex(xows_hash_sdbm(e))}const zo=new Map;function xows_cach_peer_save(e){const o=xows_cach_peer_iden(e);let _;try{_=JSON.parse(localStorage.getItem(o))}catch(e){xows_log(1,"cli_cache_peer_add","JSON parse error",o)}null!==_?(_.name=e.name,_.avat=e.avat,_.noti=e.noti,"string"==typeof e.stat&&(_.stat=e.stat)):_={name:e.name,avat:e.avat,stat:e.stat,noti:e.noti},zo.set(o,_),localStorage.setItem(o,JSON.stringify(_))}function xows_cach_peer_has(e){return!!zo.has(e)||!!localStorage.hasOwnProperty(e)}function xows_cach_peer_get(e){if(zo.has(e))return zo.get(e);if(localStorage.hasOwnProperty(e)){try{zo.set(e,JSON.parse(localStorage.getItem(e)))}catch(o){return xows_log(1,"cli_cache_peer_get","JSON parse error",o),localStorage.removeItem(e),null}return zo.get(e)}return null}function xows_cach_peer_fetch(e){const o=xows_cach_peer_get(xows_cach_peer_iden(e));o&&(o.name&&(e.name=o.name),o.avat&&(e.avat=o.avat),o.stat&&(e.stat=o.stat),o.noti&&(e.noti=o.noti))}const Vo=new Map;function xows_cach_caps_save(e,o){Vo.set(e,o),localStorage.setItem(e,JSON.stringify(o))}function xows_cach_caps_has(e){return!!Vo.has(e)||!!localStorage.hasOwnProperty(e)}function xows_cach_caps_get(e){if(Vo.has(e))return Vo.get(e);if(localStorage.hasOwnProperty(e)){try{Vo.set(e,JSON.parse(localStorage.getItem(e)))}catch(o){return xows_log(1,"cli_cache_caps_get","JSON parse error",o),localStorage.removeItem(e),null}return Vo.get(e)}return null}let Yo=1;function xows_load_task_bit(){const e=Yo;return Yo=e<<1,e}const Jo=new Map;function xows_load_task_set(e,o){Jo.set(e,o)}const Wo={onempty:null,toid:null,param:null};function xows_load_onempty_set(e,o,_){if(0===Ko.size)return void o(_);const t=Wo;t.toid&&(clearTimeout(t.toid),t.toid=null),t.param=_,t.onempty=o,e>0&&(t.toid=setTimeout(o,e,_))}const Ko=new Map;function xows_load_task_done(e,o){if(e.load&=~o,0===e.load){const _=Ko.get(e);if(!_)return void xows_log(1,"load_task_done","entry not found for item","task=0x"+o);if(Ko.delete(e),_.onload(e,_.param),Wo.onempty&&0===Ko.size){const e=Wo;e.toid&&(clearTimeout(e.toid),e.toid=null),xows_log(1,"load_task_done","fireing onempty",e.onempty.name),e.onempty(e.param),e.onempty=null,e.param=null}}}function xows_load_init(e,o,_,t){if(0===o)return void _(e,t);Ko.has(e)?(xows_log(1,"load_init","item already setup for load","mask=0x"+o),e.load|=o):(e.load=o,Ko.set(e,{onload:_,param:t}));let s=1;do{if(o&s){Jo.get(s)(e)}s<<=1}while(s!=Yo)}const Xo=[],$o=new Map;function xows_cli_entity_has(e,o){return!!$o.has(e)&&$o.get(e).feat.includes(o)}const Qo=new Map,Zo=[];function xows_cli_external_has(e){const o=Array.from(arguments);let _;_=Ns.extern_services;for(let e=0;e<_.length;++e)if(o.includes(_[e].type))return!0;_=Zo;for(let e=0;e<_.length;++e)if(o.includes(_[e].type))return!0;return!1}function xows_cli_external_get(e){const o=Array.from(arguments);let _;const t=[];_=Ns.extern_services;for(let e=0;e<_.length;++e)o.includes(_[e].type)&&t.push(_[e]);_=Zo;for(let e=0;e<_.length;++e)o.includes(_[e].type)&&t.push(_[e]);return t}const e_=xows_load_task_bit(),o_=xows_load_task_bit(),__=xows_load_task_bit();function xows_cli_init(){xows_doc_listener_add(window,"beforeunload",xows_cli_flyyoufools),xows_doc_listener_add(window,"unload",xows_cli_flyyoufools),xows_load_task_set(e_,xows_cli_avat_fetch),xows_load_task_set(o_,xows_cli_nick_query),xows_load_task_set(__,xows_cli_muc_roominfo_query)}const t_=0,s_=1,n_=2,c_=4,i_=7;let r_={jful:null,jbar:null,addr:null,name:null,avat:null,show:0,stat:null,noti:!1,load:0};function xows_cli_isself_addr(e){return e.startsWith(r_.addr)}function xows_cli_test_addr(e,o,_){return e.addr==this}function xows_cli_test_self(e,o,_){return null!=e.self}xows_def_readonly(r_,"type",s_),xows_def_readonly(r_,"self",r_),Object.seal(r_);const a_=[];function xows_cli_cont_new(e,o,_,t){const s={name:o||e,subs:_,avat:t,show:0,stat:"",noti:!0,chat:0,jlck:e,jrpc:e,load:0};return xows_def_readonly(s,"type",s_),xows_def_readonly(s,"addr",e),xows_def_readonly(s,"jbar",e),xows_def_readonly(s,"ress",new Map),xows_def_readonly(s,"self",null),Object.seal(s),a_.push(s),s}function xows_cli_cont_rem(e){const o=a_.indexOf(e);a_.splice(o,1)}function xows_cli_cont_get(e){return a_.find(xows_cli_test_addr,xows_jid_bare(e))}function xows_cli_best_resource(e){if(e.type===c_)return e.jbar?e.jbar:e.addr;if(e.jlck!=e.jbar)return e.jlck;{let o=null;const _=Array.from(e.ress.values());return _.length&&(_.length>1&&(_.sort(function(e,o){return o.show-e.show}),_.sort(function(e,o){return o.prio-e.prio})),o=_[0].id),o?e.jbar+"/"+o:e.jbar}}const l_=[];function xows_cli_room_new(e,o){if(!o){const _=e.split("@")[0];o=_[0].toUpperCase()+_.slice(1)}const _={name:o,desc:"",subj:"",publ:!1,prot:!1,pass:null,modr:!1,anon:!0,open:!0,nocc:0,init:!1,join:null,role:0,affi:0,nick:null,rcon:!1,occu:[],writ:[],noti:!0,book:!1,load:0};return xows_def_readonly(_,"type",n_),xows_def_readonly(_,"addr",e),xows_def_readonly(_,"jlck",e),xows_def_readonly(_,"self",null),Object.seal(_),l_.push(_),_}function xows_cli_room_rem(e){const o=l_.indexOf(e);l_.splice(o,1)}function xows_cli_room_get(e){return l_.find(xows_cli_test_addr,xows_jid_bare(e))}function xows_cli_occu_new(e,o,_,t,s,n){const c=t?xows_jid_bare(t):null,i={name:xows_jid_resc(o),addr:o,jlck:o,jrpc:o,affi:0,role:0,jful:t,jbar:c,avat:s,show:4,stat:"",chat:0,noti:!0,load:0};return n=n?r_:null,xows_def_readonly(i,"type",c_),xows_def_readonly(i,"room",e),xows_def_readonly(i,"ocid",_),xows_def_readonly(i,"self",n),Object.seal(i),e.occu.push(i),i}function xows_cli_occu_rem(e){const o=e.room,_=o.occu.indexOf(e);o.occu.splice(_,1)}function xows_cli_occu_get(e,o,_){let t=e.occu.length;for(;t--;)if(e.occu[t].ocid===_||e.occu[t].addr===o)return e.occu[t];return null}function xows_cli_occu_get_or_new(e,o,_){let t=e.occu.length;for(;t--;)if(e.occu[t].ocid===_||e.occu[t].addr===o)return e.occu[t];const s=xows_cach_peer_get(_||o);return xows_cli_occu_new(e,o,_,null,s?s.avat:null,!1)}function xows_cli_occu_self(e){return e.occu.find(xows_cli_test_self)}const u_=[];function xows_cli_priv_rem(e){const o=u_.indexOf(e);u_.splice(o,1)}function xows_cli_priv_has(e){return u_.includes(e)}function xows_cli_priv_add(e){const o=u_.includes(e);return o||u_.push(e),!o}function xows_cli_peer_get(e,o){if(!e)return r_;const _=xows_jid_bare(e);if(_==r_.addr)return r_;if(o&s_){const e=a_.find(xows_cli_test_addr,_);if(e)return e}if(o&(n_|c_)){let t=l_.find(xows_cli_test_addr,_);if(t){let _;return o&c_&&e.includes("/")?(_=t.occu.find(xows_cli_test_addr,e))||u_.find(xows_cli_test_addr,e):t}}return null}function xows_cli_peer_push(e,o){switch(xows_cach_peer_save(e),e.type){case s_:e.self?x_(e,o):F_(e,o);break;case c_:Y_(e,o),xows_cli_priv_has(e)&&E_(e,o);break;case n_:H_(e,o)}}function xows_cli_peer_iden(e){return e.type===c_&&e.ocid?e.ocid:e.addr}function xows_cli_can_subscribe(e){if(e.self)return!1;switch(e.type){case s_:return!(e.subs&Te);case c_:if(null!==e.jbar){const o=a_.find(xows_cli_test_addr,e.jbar);return!o||!(o.subs&Te)}}return!1}function xows_cli_author_get(e,o,_){switch(e.type){case n_:return o===e.join?e.occu.find(xows_cli_test_self):xows_cli_occu_get_or_new(e,o,_);case s_:return o.startsWith(r_.addr)?r_:a_.find(xows_cli_test_addr,xows_jid_bare(o));default:return xows_cli_peer_get(o,i_)}}let d_=function(){},x_=function(){},w_=function(){},p_=function(){};function xows_cli_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"connect":d_=o;break;case"selfpush":x_=o;break;case"contpush":F_=o;break;case"contrem":v_=o;break;case"subspush":k_=o;break;case"roompush":H_=o;break;case"roomrem":U_=o;break;case"roomjoin":z_=o;break;case"roomexit":V_=o;break;case"occupush":Y_=o;break;case"occurem":J_=o;break;case"privpush":E_=o;break;case"privrem":q_=o;break;case"message":A_=o;break;case"chatstate":C_=o;break;case"receipt":S_=o;break;case"retract":T_=o;break;case"subject":W_=o;break;case"calloffer":Q_=o;break;case"callanwse":Z_=o;break;case"callstate":et=o;break;case"calltermd":ot=o;break;case"callerror":_t=o;break;case"error":w_=o;break;case"timeout":g_=o;break;case"close":p_=o}}function xows_cli_xmp_onerror(e,o){w_(e,o)}function xows_cli_connect(e,o,_,t){return a_.length=0,l_.length=0,u_.length=0,Qo.clear(),$o.clear(),Zo.length=0,O_=Ns.history_size/2,r_.addr=null,r_.jbar=null,r_.jful=null,r_.name=null,r_.avat=null,r_.stat=null,xows_cli_activity_stop(),xows_xmp_set_callback("session",xows_cli_xmp_onsession),xows_xmp_set_callback("presence",xows_cli_xmp_onpresence),xows_xmp_set_callback("subscrib",xows_cli_xmp_onsubscribe),xows_xmp_set_callback("occupant",xows_cli_xmp_onoccupant),xows_xmp_set_callback("presfail",xows_cli_xmp_onpreserr),xows_xmp_set_callback("rostpush",xows_cli_xmp_onrostpush),xows_xmp_set_callback("message",xows_cli_xmp_onmessage),xows_xmp_set_callback("chatstate",xows_cli_xmp_onchatstate),xows_xmp_set_callback("receipt",xows_cli_xmp_onreceipt),xows_xmp_set_callback("retract",xows_cli_xmp_onretract),xows_xmp_set_callback("subject",xows_cli_xmp_onsubject),xows_xmp_set_callback("mucnoti",xows_cli_xmp_onmucnoti),xows_xmp_set_callback("pubsub",xows_cli_xmp_onpubsub),xows_xmp_set_callback("jingle",xows_cli_xmp_onjingle),xows_xmp_set_callback("error",xows_cli_xmp_onerror),xows_xmp_set_callback("close",xows_cli_xmp_onclose),xows_xmp_connect(e,o,_,t)}function xows_cli_connected(){return null!==r_.jful}function xows_cli_xmp_onsession(e){if(r_.addr=e.jbar,r_.jbar=e.jbar,r_.jful=e.jful,xows_cach_peer_fetch(r_),!r_.name){const o=e.node;r_.name=o.charAt(0).toUpperCase()+o.slice(1)}r_.show=j_=ke,null!==r_.stat&&void 0!==r_.stat||(r_.stat=""),f_?xows_cli_session_start():xows_cli_warmup_start()}function xows_cli_warmup_start(){xows_log(2,"cli_warmup_start","ignition"),xows_xmp_disco_info_query(r_.addr,null,xows_cli_warmup_discnfo_self)}function xows_cli_warmup_discnfo_self(e,o,_,t){$o.set(e,{iden:o,feat:_,item:[]}),xows_xmp_disco_info_query(N,null,xows_cli_warmup_discnfo_host)}function xows_cli_warmup_discnfo_host(e,o,_,t){$o.set(e,{iden:o,feat:_,item:[]}),xows_xmp_disco_items_query(N,xows_cli_warmup_discitms_host)}const m_=[];function xows_cli_warmup_discitms_host(e,o){if(o.length){const _=$o.get(e);for(let e=0,t=o.length;e<t;++e){const t=o[e].jid;xows_log(2,"cli_init_discoitems_host","discovered item",t),_.item.push(t),m_.push(t)}xows_xmp_disco_info_query(m_.shift(),null,xows_cli_warmup_discnfo_item)}else xows_cli_entity_has(N,Ue)?xows_xmp_extdisco_query(N,null,xows_cli_warmup_extdisc_host):xows_cli_warmup_config()}function xows_cli_warmup_discnfo_item(e,o,_,t){$o.set(e,{iden:o,feat:_,item:[]}),m_.length?xows_xmp_disco_info_query(m_.shift(),null,xows_cli_warmup_discnfo_item):xows_cli_entity_has(N,Ue)?xows_xmp_extdisco_query(N,null,xows_cli_warmup_extdisc_host):xows_cli_warmup_config()}function xows_cli_warmup_extdisc_host(e,o){for(let e=0,_=o.length;e<_;++e){xows_log(2,"cli_extdisco_parse","discovered external",o[e].type+" ("+o[e].host+":"+o[e].port+")"),Zo.push(o[e])}xows_xmp_rost_get_query(xows_cli_warmup_roster)}function xows_cli_warmup_roster(e){xows_cli_rost_get_parse(e),xows_load_init(r_,e_|o_,xows_cli_warmup_config)}function xows_cli_warmup_config(){$o.get(N).feat.includes(Ye)&&xows_xmp_carbons_query(!0,null);for(const[e,o]of $o)o.feat.includes(xo)&&(Qo.has(xo)||Qo.set(xo,[]),Qo.get(xo).push(e)),o.feat.includes(lo)&&(Qo.has(lo)||Qo.set(lo,[]),Qo.get(lo).push(e));xows_cli_muc_roomlist_query(),xows_load_onempty_set(1e3,xows_cli_session_start)}function xows_cli_session_start(){if(xows_cli_peer_push(r_),f_){xows_log(1,"cli_session_start","recover connexion"),f_=!1;let e=l_.length;for(;e--;)l_[e].join&&(l_[e].join=null,l_[e].rcon=!0,xows_cli_muc_join_retry(l_[e]))}else xows_log(2,"cli_session_start","takeoff");xows_cli_presence_update(),xows_load_onempty_set(2e3,d_,r_)}let g_=function(){},f_=!1;function xows_cli_xmp_onclose(e,o){xows_log(2,"cli_xmp_onclose","connexion cloded","("+e+") "+o),f_?xows_cli_reconnect():(e==s?(xows_log(1,"cli_xmp_onclose","lost connection",o),f_=!0,xows_cli_rost_reset(),xows_cli_reconnect(5)):r_.jful&&(xows_log(1,"cli_xmp_onclose","session destroy",o),a_.length=0,l_.length=0,u_.length=0,r_.jful=null,r_.addr=null,r_.jbar=null,r_.name=null,r_.avat=null,r_.stat=null,xows_cli_activity_stop()),p_(e,o))}const h_=5e3;let b_=null,y_=0;function xows_cli_reconn_try(){f_&&xows_xmp_reconnect(),b_=null,y_--}function xows_cli_reconnect(e){f_&&(e&&(y_=e),xows_log(2,"cli_reconnect","attempt left",y_),xows_cli_activity_stop(),y_?b_||(b_=setTimeout(xows_cli_reconn_try,h_)):g_())}function xows_cli_disconnect(){r_.jful&&(xows_log(2,"cli_disconnect","prepare disconnect"),f_=!1,xows_cli_call_clear(),xows_cli_show_select(0),xows_xmp_fram_close_send(3))}function xows_cli_flyyoufools(){if(tt.size)for(const[e,o]of tt.entries())xows_xmp_jing_terminate(e.jrpc,o.sid,"failed-application");xows_xmp_flyyoufools()}let F_=function(){},v_=function(){};function xows_cli_xmp_onrostpush(e,o,_,t){let s=xows_cli_cont_get(e);if(_===Se)return void(s&&v_(s));s?(o&&s.name,s.subs=_):xows_cach_peer_fetch(s=xows_cli_cont_new(e,o,_));let n=0;s.subs&Te&&(n|=e_|o_),xows_load_init(s,n,xows_cli_peer_push)}function xows_cli_rost_reset(){let e=a_.length;for(;e--;){const o=a_[e];o.ress.clear(),o.show=be,F_(o)}}function xows_cli_rost_get_parse(e){if(e.length)for(let o=0,_=e.length;o<_;++o)xows_cli_xmp_onrostpush(e[o].jid,e[o].name,e[o].subs,e[o].group);else F_(null)}function xows_cli_rost_get_query(){xows_xmp_rost_get_query(xows_cli_rost_get_parse)}function xows_cli_rost_edit(e,o){xows_xmp_rost_set_query(e,o,null,null)}let k_=function(){};function xows_cli_xmp_onpresence(e,o,_,t,s,n){const c=xows_cli_cont_get(e);if(!c)return void(xows_cli_isself_addr(e)||xows_log(1,"cli_xmp_onpresence","unknown/unsubscribed Contact",e));c.jlck=c.jbar;let i=xows_jid_resc(e);if(o>be){if(c.ress.has(i))c.ress.get(i).show=o,c.ress.get(i).prio=_,c.ress.get(i).stat=t;else if(c.ress.set(i,{id:i,show:o,prio:_,stat:t,node:null}),s){const o=s.node+"#"+s.ver;c.ress.get(i).node=o,xows_cach_caps_has(o)||xows_xmp_disco_info_query(e,o,xows_cli_entity_caps_parse)}}else c.ress.has(i)&&c.ress.delete(i),c.chat=0;c.show=be;let r=-128;for(const e of c.ress.values())e.prio>r&&(r=e.prio,c.show=e.show,c.stat=e.stat);let a=0;c.show>be&&("string"==typeof n?n.length>0?xows_cach_avat_has(n)?c.avat=n:a|=e_:c.avat=null:c.avat||(a|=e_),a|=o_),xows_load_init(c,a,xows_cli_peer_push)}function xows_cli_entity_caps_parse(e,o,_,t,s){xows_cach_caps_has(s)||xows_cach_caps_save(s,_)}function xows_cli_entity_caps_test(e,o){return!!xows_cach_caps_has(e)&&xows_cach_caps_get(e).includes(o)}function xows_cli_xmp_onsubscribe(e,o,_){let t=xows_cli_cont_get(e);switch(o){case"subscribe":if(t)t.subs&Te&&xows_cli_subs_answer(t,!0);else{if(!_){const o=e.split("@")[0];_=o[0].toUpperCase()+o.slice(1)}xows_gui_cli_onsubspush(t=xows_cli_cont_new(xows_jid_bare(e),_,Ce,null))}break;case"unsubscribe":t?(t.subs&=~De,xows_gui_cli_oncontpush(t)):xows_log(1,"cli_xmp_onsubscribe","subscribe revoked from unknow contact",e);break;case"subscribed":t?(t.subs|=De,xows_gui_cli_oncontpush(t)):xows_log(1,"cli_xmp_onsubscribe","request allowed from unknow contact",e)}}function xows_cli_subs_request(e){let o=xows_cli_cont_get(e);if(!o){const _=e.split("@")[0];o=xows_cli_cont_new(e,_[0].toUpperCase()+_.slice(1),De,null)}xows_xmp_presence_send(e,"subscribe",null,null,r_.name)}function xows_cli_subs_revoke(e){xows_xmp_rost_set_query(e.addr,null,null,null)}function xows_cli_subs_answer(e,o){xows_xmp_presence_send(e.addr,o?"subscribed":"unsubscribed"),o?(e.subs|=De,e.subs!=je&&xows_cli_subs_request(e.addr)):v_(e)}let A_=function(){},E_=function(){},q_=function(){};function xows_cli_xmp_onmessage(e,o){const _=e.from;let t;(t="groupchat"==e.type?xows_cli_room_get(_):xows_cli_peer_get(xows_cli_isself_addr(_)?e.to:_,i_))?(t.type===s_&&(t.jlck=_),t.type===c_&&xows_cli_priv_add(t)&&E_(t),e.time||(e.time=(new Date).getTime()),A_(t,e,!1,!1,o)):xows_log(1,"cli_xmp_onmessage","unknown/unsubscribed JID",_)}function xows_cli_send_message(e,o,_,t,s){let n,c,i=!0;if(e.type===n_)n="groupchat",c=e.join;else if(n="chat",e.type===c_)c=e.room.join;else if(c=r_.addr,e.jlck!==e.addr){const o=e.ress.get(xows_jid_resc(e.jlck));o&&(i=xows_cli_entity_caps_test(o.node,xe))}const r=e.jlck,a=xows_xmp_message_body_send(n,r,o,i,_,t,s),l=xows_xmp_message_forge(a,r,c,n,o,null,null,null,_,t,s,a);A_(e,l,i,!0)}let S_=function(){};function xows_cli_xmp_onreceipt(e,o,_,t){let s;xows_cli_isself_addr(o)||((s=xows_cli_peer_get(o,i_))?S_(s,t):xows_log(1,"cli_xmp_onreceipt","unknown/unsubscribed JID",o))}let C_=function(){};function xows_cli_xmp_onchatstate(e,o,_,t,s){let n;if("chat"===_){if(xows_cli_isself_addr(o))return;n=xows_cli_peer_get(o,i_)}else if((n=xows_cli_room_get(o)).join===o)return;if(n){switch(n.type){case n_:{const e=xows_cli_occu_get(n,o,s);if(e)if(e.chat=t,t>ae)n.writ.includes(e)||n.writ.push(e);else{const o=n.writ.indexOf(e);o>=0&&n.writ.splice(o,1)}}break;case c_:n.chat=t;break;default:n.chat=t,t>0&&(n.jlck=o)}C_(n,t)}else xows_log(1,"cli_xmp_onchatstate","unknown/unsubscribed JID",o)}let D_=null;function xows_cli_chatstate_define(e,o){if(e.type===c_&&0==e.show)return;const _=e.type===n_?"groupchat":"chat";o>ae?(D_?clearTimeout(D_):xows_xmp_message_chatstate_send(e.jlck,_,o),D_=setTimeout(xows_cli_chatstate_define,4e3,e,ae)):(clearTimeout(D_),D_=null,xows_xmp_message_chatstate_send(e.jlck,_,o))}let T_=function(){};function xows_cli_xmp_onretract(e,o,_,t){let s;(s="chat"===_?xows_cli_peer_get(o,i_):xows_cli_room_get(o))?T_(s,t):xows_log(1,"cli_xmp_onretract","unknown/unsubscribed JID",o)}function xows_cli_retract_send(e,o){const _=e.type===n_?"groupchat":"chat";xows_xmp_message_retract_send(e.jlck,_,o),e.type!==n_&&T_(e,o)}function xows_cli_presence_update(){let e,o,_,t=0;r_.show>be?(t=r_.show,o=r_.stat,_=r_.avat):e="unavailable",xows_xmp_presence_send(null,e,t,o,null,null,_);let s=l_.length;for(;s--;)l_[s].join&&(xows_xmp_presence_send(l_[s].join,e,t,o,null,null,_),e&&(l_[s].join=null));xows_cli_peer_push(r_)}let j_=be;function xows_cli_show_select(e){r_.show=j_=e,xows_cli_presence_update()}function xows_cli_status_define(e){r_.stat!==e&&(r_.stat=e,xows_cli_presence_update())}let L_=null;function xows_cli_activity_sleep(){L_&&clearTimeout(L_),r_.show>Fe&&(L_=setTimeout(xows_cli_activity_sleep,6e5),r_.show--,xows_cli_presence_update())}function xows_cli_activity_wakeup(){L_&&clearTimeout(L_),L_=setTimeout(xows_cli_activity_sleep,6e5),r_.show<j_&&(r_.show=j_,xows_cli_presence_update())}function xows_cli_activity_stop(){L_&&clearTimeout(L_),r_.show=j_=be}function xows_cli_self_edit(e,o,_){e&&(r_.name=e),o?(r_.avat=xows_cach_avat_save(o),xows_cli_avat_publish(_)):r_.avat&&xows_cli_avat_retract(),xows_cli_nick_publish(),xows_cli_presence_update()}function xows_cli_xmp_onpubsub(e,o,_){o===oo&&_.length&&xows_cli_vcardt_parse(e,_[0].child),o===no&&_.length&&xows_cli_avat_meta_parse(e,_[0].child),o===to&&_.length&&xows_cli_nick_parse(e,_[0].child),o===eo&&_.length&&xows_cli_book_parse(e,_)}const N_=new Map;function xows_cli_pubsub_chmod_result(e,o,_,t){if(!N_.has(o))return;const s=N_.get(o);if(N_.delete(o),t)xows_isfunc(s.onresult)&&s.onresult(e,"error",t);else{if(_)for(let e=0,o=_.length;e<o;++e)"pubsub#access_model"===_[e].var&&(_[e].value=[s.access]);xows_xmp_pubsub_conf_set_query(o,_,s.onresult)}}function xows_cli_pubsub_chmod(e,o,_){N_.has(e)||(N_.set(e,{access:o,onresult:_}),xows_xmp_pubsub_conf_get_query(e,xows_cli_pubsub_chmod_result))}function xows_cli_nick_parse(e,o,_){const t=xows_cli_peer_get(e,s_|c_);t?(_?xows_log(1,"cli_nick_parse","error parse nickname",e):t.name=xows_xml_innertext(o),t.load?xows_load_task_done(t,o_):xows_cli_peer_push(t)):xows_log(1,"cli_nick_parse","unknown/unsubscribed JID",e)}function xows_cli_nick_query(e){xows_xmp_nick_get_query(e.addr,xows_cli_nick_parse)}function xows_cli_nick_publish(){xows_xmp_nick_publish(r_.name,null)}const I_=48,M_=new Map;function xows_cli_avat_data_parse(e,o,_,t){const s=xows_cli_peer_get(e,s_|c_);if(!s)return void xows_log(1,"cli_avat_data_parse","unknown/unsubscribed JID",e);const n=M_.get(s);M_.delete(s),t?xows_cli_vcardt_query(s):(xows_cach_avat_save("data:"+n.type+";base64,"+_,o),s.avat=o,s.load?xows_load_task_done(s,e_):xows_cli_peer_push(s),B_.delete(s))}function xows_cli_avat_meta_parse(e,o,_){const t=xows_cli_peer_get(e,s_|c_);if(!t)return void xows_log(1,"cli_avat_meta_parse","unknown/unsubscribed JID",e);let s=null;if(o&&(s=o.querySelector("info")),_||!s){if(Ns.avatar_autopub&&t===r_){const e=xows_cach_avat_temp_data(t.addr,null);return t.avat=xows_cach_avat_save(e),xows_cli_avat_publish("open"),xows_load_task_done(t,e_),void B_.delete(t)}return void xows_cli_vcardt_query(t)}const n=s.getAttribute("id"),c=s.getAttribute("type");xows_cach_avat_has(n)?(t.avat=n,t.load?xows_load_task_done(t,e_):xows_cli_peer_push(t)):(M_.set(t,{hash:n,type:c}),xows_xmp_avat_data_get_query(e,n,xows_cli_avat_data_parse))}function xows_cli_avat_meta_query(e){xows_xmp_avat_meta_get_query(e.addr,xows_cli_avat_meta_parse)}const B_=new Map;function xows_cli_avat_fetch(e){if(B_.has(e))return xows_log(1,"cli_avat_fetch","peer already in stack",e.addr),void(e.load&&xows_load_task_done(e,e_));B_.set(e,e),xows_xmp_avat_meta_get_query(e.addr,xows_cli_avat_meta_parse)}const P_={access:""};function xows_cli_avat_publish(e){const o=xows_cach_avat_get(r_.avat);if(!o)return;P_.access=e;const _=xows_url_to_data(o);xows_xmp_avat_data_publish(xows_bytes_to_hex(xows_hash_sha1(atob(_))),_,null,xows_cli_avat_meta_publish),e&&xows_cli_pubsub_chmod(so,e),xows_cli_vcardt_publish()}function xows_cli_avat_retract(){null!==r_.avat?(xows_xmp_pubsub_retract(no,r_.avat,null),r_.avat=null):xows_log(1,"cli_avat_retract","No avatar Hash-ID to retract")}function xows_cli_avat_meta_publish(e,o,_){if("result"!=o)return;const t=xows_cach_avat_get(r_.avat);if(!t)return;const s=atob(xows_url_to_data(t));xows_xmp_avat_meta_publish(xows_bytes_to_hex(xows_hash_sha1(s)),xows_url_to_type(t),s.length,I_,I_,null,null);const n=P_.access;n&&xows_cli_pubsub_chmod(no,n)}function xows_cli_vcardt_publish(){const e=[];if(e.push(xows_xml_node("NICKNAME",null,r_.name)),r_.avat){const o=xows_cach_avat_get(r_.avat),_=xows_url_to_type(o),t=xows_url_to_data(o);e.push(xows_xml_node("PHOTO",null,[xows_xml_node("TYPE",null,_),xows_xml_node("BINVAL",null,t)]))}xows_log(2,"cli_vcard_publish","publish own vCard-temp"),xows_xmp_vcardt_set_query(e)}function xows_cli_vcardt_parse(e,o,_){const t=xows_cli_peer_get(e,s_|c_);if(t){if(_)t.avat=null,xows_log(1,"cli_vcard_parse","error parsing vcard",e);else{const e=o.querySelector("PHOTO");if(e){const o="data:"+xows_xml_innertext(e.querySelector("TYPE"))+";base64,"+xows_xml_innertext(e.querySelector("BINVAL"));t.avat=xows_cach_avat_save(o)}else t.avat=null}t.load?xows_load_task_done(t,e_):xows_cli_peer_push(t),B_.delete(t)}else xows_log(1,"cli_vcard_parse","unknown/unsubscribed JID",e)}function xows_cli_vcardt_query(e){xows_xmp_vcardt_get_query(e.addr,xows_cli_vcardt_parse)}function xows_cli_book_parse(e,o){for(let e=0,_=o.length;e<_;++e){let _=o[e].id,t=o[e].child.getAttribute("name"),s=o[e].child.getAttribute("autojoin"),n=xows_cli_room_get(_);if(n){if(n.publ)return}else n=xows_cli_room_new(_,t);n.book=!0,s&&xows_cli_muc_join_atempt(n),xows_load_init(n,__,xows_cli_peer_push)}}function xows_cli_book_publish(e,o,_,t){const s=_||e.name,n=t||xows_jid_resc(e.join);xows_xmp_bookmark_publish(e.addr,s,o,n,null)}let O_=32;const R_=new Map;function xows_cli_mam_collect(e,o,_,t,s){const n=xows_cli_peer_get(e||o,i_);if(!n)return void xows_log(1,"cli_mam_collect","unknown/unsubscribed JID",e||o);const c=[];let i=_.length;for(;i--;)_[i].retract&&c.push(_[i].retract);if(i=_.length,n.type===s_)for(;i--;)c.includes(_[i].orid)&&(_[i].discard=!0);else for(;i--;)c.includes(_[i].szid)&&(_[i].discard=!0);const r=R_.get(n);if(!r)return void xows_log(1,"cli_mam_collect","unexpected MAM result",e||o);r.start?r.pool=r.pool.concat(_):r.pool=_.concat(r.pool);const a=r.pool;let l=0;for(i=a.length;i--;)!a[i].body||a[i].discard||a[i].replace||l++;if(!s&&l<r.count){r.start?r.start=a[a.length-1].time+1:r.end=a[0].time-1;const e=2*(r.count-l);return e<O_&&(r.max=e),void setTimeout(xows_cli_mam_request,100,n)}xows_log(2,"cli_mam_collect",l+" gathered messages for",n.addr),xows_isfunc(r.onresult)&&r.onresult(n,a,l,s),R_.delete(n)}function xows_cli_mam_request(e){if(!R_.has(e))return;const o=R_.get(e);e.type===n_?xows_xmp_mam_query(e.addr,o.max,null,o.start,o.end,null,xows_cli_mam_collect):xows_xmp_mam_query(null,o.max,e.addr,o.start,o.end,null,xows_cli_mam_collect)}function xows_cli_mam_fetch(e,o,_,t,s){if(R_.has(e))return;xows_log(2,"cli_mam_fetch","fetch history for",e.addr);const n=o>O_?O_:o;R_.set(e,{peer:e,count:o,max:n,start:_,end:t,onresult:s,pool:new Array}),xows_cli_mam_request(e)}const G_=new Map;function xows_cli_upld_abort(e){xows_log(1,"cli_upld_abort","abort requested",e);const o=G_.get(e);o.xhr&&o.xhr.abort(),G_.delete(e)}function xows_cli_upld_put_progress(e){const o=e.target._name,_=G_.get(o);xows_isfunc(_.onprogress)&&_.onprogress(o,e.loaded/e.total*100)}function xows_cli_upld_put_error(e){const o=e.target._name,_="HTTP PUT failed";xows_log(1,"cli_upld_put_error",_,o);const t=G_.get(o);xows_isfunc(t.onerror)&&t.onerror(o,_),G_.delete(o)}function xows_cli_upld_put_abort(e){const o=e.target._name;xows_log(1,"cli_upld_put_abort","HTTP PUT aborted by user",o);const _=G_.get(o);xows_isfunc(_.onabort)&&_.onabort(o),G_.delete(o)}function xows_cli_upld_xhr_state(e){if(4===e.readyState){if(201!==e.status)return void xows_log(1,"cli_upld_xhr_state","server responded",e.status);const o=e.upload._name,_=G_.get(o);xows_isfunc(_.onload)&&setTimeout(_.onload,500,o,_.url),G_.delete(o)}}function xows_cli_upld_result(e,o,_,t,s){const n=G_.get(e);if(!o){const o="upload denied: "+s;return xows_log(1,"cli_upld_result",o,e),xows_isfunc(n.onerror)&&n.onerror(e,o),void G_.delete(e)}n.url=t;const c=new XMLHttpRequest;n.xhr=c,c.open("PUT",o,!0),c.setRequestHeader("Content-Type","main_menucation/octet-stream");for(let e=0;e<_.length;++e)c.setRequestHeader(_[e].getAttribute("name"),_[e].innerHTML);c.upload._name=e,c.upload.onprogress=xows_cli_upld_put_progress,c.upload.onerror=xows_cli_upld_put_error,c.upload.onabort=xows_cli_upld_put_abort,c.onreadystatechange=function(){xows_cli_upld_xhr_state(this)},c.send(n.file)}function xows_cli_upld_query(e,o,_,s,n){if(!G_.has(e.name)){if(!Qo.has(lo)){const e="HTTP File Upload (XEP-0363) service is unavailable";return xows_log(1,"cli_upld_query",e),void w_(t,e)}G_.set(e.name,{file:e,onerror:o,onload:_,onprogress:s,onabort:n}),xows_xmp_upld_query(Qo.get(lo)[0],e.name,e.size,e.type,xows_cli_upld_result)}}let H_=function(){},U_=function(){},z_=function(){},V_=function(){},Y_=function(){},J_=function(){},W_=function(){};function xows_cli_muc_roomlist_parse(e,o){H_(null);for(let e=0,_=o.length;e<_;++e){xows_load_init(xows_cli_room_new(o[e].jid),__,xows_cli_peer_push)}}function xows_cli_muc_roomlist_query(){if(!Qo.has(xo))return void xows_log(1,"cli_muc_discoitems_query","aborted","no MUC service available");const e=Qo.get(xo);for(let o=0,_=e.length;o<_;++o)xows_xmp_disco_items_query(e[o],xows_cli_muc_roomlist_parse)}function xows_cli_muc_roominfo_parse(e,o,_,t){let s=null;o.length>0&&(s=o[0].name);let n=xows_cli_room_get(e);n?s&&(n.name=s):n=xows_cli_room_new(e,s);for(let e=0;e<_.length;++e)"muc_passwordprotected"===_[e]&&(n.prot=!0),"muc_unsecured"===_[e]&&(n.prot=!1),"muc_public"===_[e]&&(n.publ=!0),"muc_hidden"===_[e]&&(n.publ=!1),"muc_membersonly"===_[e]&&(n.open=!1),"muc_open"===_[e]&&(n.open=!0),"muc_moderated"===_[e]&&(n.modr=!0),"muc_unmoderated"===_[e]&&(n.modr=!1),"muc_semianonymous"===_[e]&&(n.anon=!0),"muc_nonanonymous"===_[e]&&(n.anon=!1);if(t)for(let e=0;e<t.length;++e)"muc#roomconfig_roomname"===t[e].var&&t[e].value&&(n.name=t[e].value),"muc#roominfo_description"===t[e].var&&t[e].value&&(n.desc=t[e].value),"muc#roominfo_subject"===t[e].var&&t[e].value&&(n.subj=t[e].value),"muc#roominfo_occupants"==t[e].var&&t[e].value&&(n.nocc=parseInt(t[e].value));n.load?xows_load_task_done(n,__):xows_cli_peer_push(n)}function xows_cli_muc_roominfo_query(e){xows_xmp_disco_info_query(e.addr,null,xows_cli_muc_roominfo_parse)}const K_=new Map;function xows_cli_muc_getcfg_result(e,o){const _=xows_cli_room_get(e);if(!_)return void xows_log(1,"cli_muc_cfg_get_parse","unknown/unsubscribed Room",e);const t=K_.get(_);xows_isfunc(t)&&t(_,o),K_.delete(_)}function xows_cli_muc_getcfg_query(e,o){K_.has(e)||(K_.set(e,o),xows_xmp_muc_cfg_get_guery(e.addr,xows_cli_muc_getcfg_result))}function xows_cli_muc_setcfg_result(e,o,_){if("result"!==o)return;const t=xows_cli_room_get(e);if(!t)return void xows_log(1,"cli_muc_cfg_set_parse","unknown/unsubscribed Room",e);const s=K_.get(t);xows_isfunc(s)&&s(t,o),t.init=!1,K_.delete(t)}function xows_cli_muc_setcfg_cancel(e,o){xows_xmp_muc_cfg_set_cancel(e.addr,o)}function xows_cli_muc_setcfg_query(e,o,_){K_.has(e)||(K_.set(e,_),xows_xmp_muc_cfg_set_query(e.addr,o,xows_cli_muc_setcfg_result))}const X_=new Map;function xows_cli_muc_regi_set_result(e,o,_){const t=xows_cli_room_get(e);if(!t)return void xows_log(1,"cli_muc_register_parse","unknown/unsubscribed Room",e);const s=X_.get(t);"error"!==o&&(t.nick=s.nick),xows_isfunc(s.onresult)&&s.onresult(t,o,_),X_.delete(t)}function xows_cli_muc_regi_get_result(e,o,_,t){const s=xows_cli_room_get(e);if(!s)return void xows_log(1,"cli_muc_register_parse","unknown/unsubscribed Room",e);const n=X_.get(s);if(t)return xows_isfunc(n.onresult)&&n.onresult(s,"error",t),void X_.delete(s);if(o.registered)return s.nick=n.nick,xows_isfunc(n.onresult)&&n.onresult(s,"registered",null),void X_.delete(s);if(_)for(let e=0,o=_.length;e<o;++e)"muc#register_roomnick"===_[e].var&&(_[e].value=[n.nick]);xows_xmp_regi_set_query(e,null,_,xows_cli_muc_regi_set_result)}function xows_cli_muc_regi_query(e,o,_){X_.has(e)||(X_.set(e,{onresult:_,nick:o}),xows_xmp_regi_get_query(e.addr,xows_cli_muc_regi_get_result))}function xows_cli_muc_join_retry(e){let o=e.addr+"/";o+=e.nick?e.nick:r_.name;const _={pass:e.pass};xows_xmp_presence_send(o,null,r_.show,r_.stat,null,_,r_.avat)}function xows_cli_muc_join_nick(e,o){let _=xows_cli_room_get(e);_?(_.nick=o,xows_cli_muc_join_retry(_)):xows_log(1,"cli_muc_join_nick_result","unknown/unsubscribed Room",e)}function xows_cli_muc_join_atempt(e,o,_){if(e){if(e.join)return}else{let _;if(xows_isjid(o))_=o;else{if(!Qo.has(xo))return void xows_log(1,"cli_muc_join","aborted","no MUC service available");_=o.toLowerCase()+"@"+Qo.get(xo)[0]}e=xows_cli_room_new(_)}e.pass=_,xows_xmp_muc_nick_query(e.addr,xows_cli_muc_join_nick)}function xows_cli_xmp_onoccupant(e,o,_,t,s,n){let c,i=xows_cli_room_get(e);if(!i)return void xows_log(1,"cli_xmp_onoccupant","unknown/unsubscribed Room",e);if(t.code.includes(201)&&(i.init=!0,H_(i)),t.code.includes(110))if(c=!0,o>be)null===i.join&&(i.join=e,t.code.includes(201)?(i.init=!0,H_(i),z_(i)):xows_load_init(i,__,z_));else if(!t.code.includes(303)){i.join=null;for(let e=0;e<i.occu.length;++e)xows_cli_priv_has(i.occu[e])&&q_(i.occu[e]);return i.occu.length=0,void V_(i,t)}let r=xows_cli_occu_get(i,e,s);if(r&&o===be){if(!t.code.includes(303))return r.show=o,xows_cli_priv_has(r)&&q_(r),void J_(r);{t.prev=r.addr,r.name=t.nick;const e=i.addr+"/"+r.name;r.addr=e,r.jlck=e,r.self&&(i.join=e)}}r?(r.name=xows_jid_resc(e),r.jful=t.jful,r.jbar=t.jful?xows_jid_bare(t.jful):null):r=xows_cli_occu_new(i,e,s,t.jful,null,c),r.show=o,r.stat=_,r.affi=t.affi,r.role=t.role,c&&(i.affi=t.affi,i.role=t.role);let a=0;"string"==typeof n?n.length>0?xows_cach_avat_has(n)?r.avat=n:a|=e_:r.avat=null:r.avat||(a|=e_),xows_load_init(r,a,xows_cli_peer_push,t)}function xows_cli_xmp_onpreserr(e,o){const _=xows_cli_peer_get(e,s_|n_);if(_){if(_.type===n_)z_(_,null,o);else if(_.type===s_){let e;switch(o.name){case"remote-server-not-found":e="Remote server not found";break;default:e="Server error"}F_(_,e)}}else xows_log(1,"cli_xmp_onpreserr","unknown/unsubscribed JID",e)}function xows_cli_xmp_onmucnoti(e,o,_){const t=xows_cli_room_get(o);if(t){for(let e=0;e<_.length;++e)_[e];_.includes(104)&&xows_cli_muc_roominfo_query(t)}else xows_log(1,"cli_xmp_onsubject","unknown/unsubscribed JID",o)}function xows_cli_xmp_onsubject(e,o,_){const t=xows_cli_room_get(o);t?(t.subj=_,W_(t,_)):xows_log(1,"cli_xmp_onsubject","unknown/unsubscribed JID",o)}function xows_cli_muc_set_nick(e,o){xows_xmp_presence_send(e.addr+"/"+o,null,r_.show,r_.stat,null,null,r_.avat)}function xows_cli_muc_set_subject(e,o){xows_xmp_muc_subject_send(e.addr,o)}function xows_cli_muc_set_affi(e,o){xows_xmp_muc_affi_set_query(e.room.addr,{jid:e.jbar,affi:o},null)}function xows_cli_muc_set_role(e,o){xows_xmp_muc_role_set_query(e.room.addr,{nick:e.name,role:o},null)}const $_={onresult:null,password:null,attempt:0};function xows_cli_regi_chpas_parse(e,o,_){const t=$_;if("error"===e){if(t.attempt>0&&xows_isfunc(t.onparse)&&t.onparse(e,_),o)for(let e=0;e<o.length;++e)"username"===o[e].var&&(o[e].value=[I.user]),"old_password"===o[e].var&&(o[e].value=[I.pass]),"password"===o[e].var&&(o[e].value=[t.password]);t.attempt++,xows_xmp_regi_pass_set_query(null,null,o,xows_cli_regi_chpas_parse)}else I.pass=t.password,xows_isfunc(t.onparse)&&t.onparse(e,null),t.password=null}function xows_cli_regi_chpas_query(e,o){const _=$_;_.onparse=o,_.password=e,_.attempt=0,xows_xmp_regi_pass_set_query(e,null,xows_cli_regi_chpas_parse)}function xows_cli_regi_remove_query(e,o){xows_xmp_regi_remove_query(e,o)}let Q_=function(){},Z_=function(){},et=function(){},ot=function(){},_t=function(){};const tt=new Map;function xows_cli_call_sess_new(e,o){const _={inb:o,rpc:xows_wrtc_new(xows_cli_external_get("stun","turn"),xows_cli_wrtc_onsdesc,xows_cli_wrtc_ontrack,xows_cli_wrtc_onstate,xows_cli_wrtc_onerror,e),sid:null,cnd:!1,loc:{sdp:null,str:null},rmt:{sdp:null,str:null}};return tt.set(e,_),_}function xows_cli_call_sess_has(e){return tt.has(e)}function xows_cli_call_sess_get(e){return tt.get(e)}function xows_cli_call_sess_meds(e){const o=tt.get(e);let _,t;o.rmt.str?_={audio:o.rmt.str.getAudioTracks().length>0,video:o.rmt.str.getVideoTracks().length>0}:o.rmt.sdp&&(_=xows_sdp_get_medias(o.rmt.sdp)),o.loc.str?t={audio:o.loc.str.getAudioTracks().length>0,video:o.loc.str.getVideoTracks().length>0}:o.loc.sdp&&(t=xows_sdp_get_medias(o.loc.sdp));let s=o.inb?_:t,n=o.inb?t:_;return n&&(s.audio=s.audio&&n.audio,s.video=s.video&&n.video),s}function xows_cli_call_sess_inbd(e){return tt.get(e).inb}function xows_cli_call_sess_cntd(e){return tt.get(e).cnd}function xows_cli_call_self_strm(e){return tt.get(e).loc.str}function xows_cli_call_peer_strm(e){return tt.get(e).rmt.str}function xows_cli_call_peer_list(){return Array.from(tt.keys())}function xows_cli_call_sess_count(){return tt.size}function xows_cli_call_self_mute(e,o,_){if(!tt.has(e))return;const t=tt.get(e),s=t.loc.str;let n;switch(o){case"video":n=s.getVideoTracks();break;case"audio":n=s.getAudioTracks();break;default:n=s.getTracks()}for(let e=0;e<n.length;++e)n[e].enabled=!_;const c=_?"mute":"unmute";xows_xmp_jing_info(e.jrpc,t.sid,c,{name:o})}function xows_cli_call_peer_hold(e,o,_){if(!tt.has(e))return;const t=tt.get(e),s=t.rmt.str.getAudioTracks();for(let e=0;e<s.length;++e)s[e].enabled=!_;const n=_?"hold":"unhold";xows_xmp_jing_info(e.jrpc,t.sid,n)}function xows_cli_call_sess_clear(e){if(!tt.has(e))return;const o=tt.get(e);if(o.loc.str){const e=o.loc.str.getTracks();for(let o=0;o<e.length;++o)e[o].stop()}if(o.rmt.str){const e=o.rmt.str.getTracks();for(let o=0;o<e.length;++o)e[o].stop()}o.rpc&&xows_wrtc_close(o.rpc),tt.delete(e),e.jrpc=null}function xows_cli_call_invite(e,o){e.jrpc=xows_cli_best_resource(e);const _=xows_cli_call_sess_new(e,!1);_.loc.str=o,xows_wrtc_set_local_stream(_.rpc,o)}function xows_cli_call_accept(e,o){if(!tt.has(e))return void xows_log(1,"cli_call_accept","No open session for",e.addr);const _=tt.get(e);_.loc.str=o,xows_wrtc_set_local_stream(_.rpc,o)}function xows_cli_call_hangup(e,o){if(!tt.has(e))return;const _=tt.get(e);_.sid&&(o||(o="success"),xows_xmp_jing_terminate(e.jrpc,_.sid,o)),xows_cli_call_sess_clear(e)}function xows_cli_call_clear(){for(const e of tt.keys())xows_cli_call_hangup(e,"success")}function xows_cli_wrtc_onsdesc(e,o,_){const t=tt.get(_);t.loc.sdp=o,t.inb?(xows_log(2,"cli_wrtc_onsdesc","Sending SPD answer to",_.addr),xows_xmp_jing_accept_sdp(_.jrpc,t.sid,o,null)):(xows_log(2,"cli_wrtc_onsdesc","Sending SPD offer to",_.addr),t.sid=xows_xmp_jing_initiate_sdp(_.jrpc,o,null))}function xows_cli_wrtc_ontrack(e,o,_){const t=tt.get(_);t.rmt.str=o,t.inb?(xows_log(2,"cli_wrtc_ontrack","Received offer stream from",_.addr),xows_xmp_jing_info(_.jrpc,t.sid,"ringing"),Q_(_,o)):(xows_log(2,"cli_wrtc_ontrack","Received answer stream from",_.addr),Z_(_,o))}function xows_cli_wrtc_onstate(e,o,_){"connected"===o&&(tt.get(_).cnd=!0),et(_,o)}function xows_cli_wrtc_onerror(e,o,_){_t(_,o)}function xows_cli_xmp_onjingle(e,o,_,t,s){const n=xows_cli_peer_get(e,i_);if(!n)return xows_log(1,"cli_xmp_onjingle","refused "+t,"from unknow peer: "+e),void xows_xmp_iq_error_send(o,e,"cancel","service-unavailable");switch(t){case"session-initiate":{n.jrpc=e;const o=xows_cli_call_sess_new(n,!0);o.sid=_,o.rmt.sdp=s,xows_wrtc_set_remote_sdp(o.rpc,s)}break;case"session-accept":{if(!tt.has(n))return xows_log(1,"cli_xmp_onjingle","Unexpected answer from",e),void xows_xmp_iq_error_send(o,e,"cancel","bad-request");const _=tt.get(n);_.rmt.sdp=s,xows_wrtc_set_remote_sdp(_.rpc,s)}break;case"session-info":et(n,s);break;case"session-terminate":ot(n,s),xows_cli_call_sess_clear(n)}}const st=0,nt=1,ct=2,it=new DOMParser;let rt=function(){},at=0,lt=[],ut=null,dt="dark";const xt={100:"1F4AF",1234:"1F522",grinning:"1F600",smiley:"1F603",smile:"1F604",grin:"1F601",laughing:"1F606",sweat_smile:"1F605",rolling_on_the_floor_laughing:"1F923",joy:"1F602",slightly_smiling_face:"1F642",upside_down_face:"1F643",wink:"1F609",blush:"1F60A",innocent:"1F607",smiling_face_with_3_hearts:"1F970",heart_eyes:"1F60D","star-struck":"1F929",kissing_heart:"1F618",kissing:"1F617",kissing_closed_eyes:"1F61A",kissing_smiling_eyes:"1F619",yum:"1F60B",stuck_out_tongue:"1F61B",stuck_out_tongue_winking_eye:"1F61C",zany_face:"1F92A",stuck_out_tongue_closed_eyes:"1F61D",money_mouth_face:"1F911",hugging_face:"1F917",face_with_hand_over_mouth:"1F92D",shushing_face:"1F92B",thinking_face:"1F914",zipper_mouth_face:"1F910",face_with_raised_eyebrow:"1F928",neutral_face:"1F610",expressionless:"1F611",no_mouth:"1F636",smirk:"1F60F",unamused:"1F612",face_with_rolling_eyes:"1F644",grimacing:"1F62C",lying_face:"1F925",relieved:"1F60C",pensive:"1F614",sleepy:"1F62A",drooling_face:"1F924",sleeping:"1F634",mask:"1F637",face_with_thermometer:"1F912",face_with_head_bandage:"1F915",nauseated_face:"1F922",face_vomiting:"1F92E",sneezing_face:"1F927",hot_face:"1F975",cold_face:"1F976",woozy_face:"1F974",dizzy_face:"1F635",exploding_head:"1F92F",face_with_cowboy_hat:"1F920",partying_face:"1F973",sunglasses:"1F60E",nerd_face:"1F913",face_with_monocle:"1F9D0",confused:"1F615",worried:"1F61F",slightly_frowning_face:"1F641",open_mouth:"1F62E",hushed:"1F62F",astonished:"1F632",flushed:"1F633",pleading_face:"1F97A",frowning:"1F626",anguished:"1F627",fearful:"1F628",cold_sweat:"1F630",disappointed_relieved:"1F625",cry:"1F622",sob:"1F62D",scream:"1F631",confounded:"1F616",persevere:"1F623",disappointed:"1F61E",sweat:"1F613",weary:"1F629",tired_face:"1F62B",yawning_face:"1F971",triumph:"1F624",rage:"1F621",angry:"1F620",face_with_symbols_on_mouth:"1F92C",smiling_imp:"1F608",imp:"1F47F",skull:"1F480",hankey:"1F4A9",clown_face:"1F921",japanese_ogre:"1F479",japanese_goblin:"1F47A",ghost:"1F47B",alien:"1F47D",space_invader:"1F47E",robot_face:"1F916",smiley_cat:"1F63A",smile_cat:"1F638",joy_cat:"1F639",heart_eyes_cat:"1F63B",smirk_cat:"1F63C",kissing_cat:"1F63D",scream_cat:"1F640",crying_cat_face:"1F63F",pouting_cat:"1F63E",see_no_evil:"1F648",hear_no_evil:"1F649",speak_no_evil:"1F64A",kiss:"1F48B",love_letter:"1F48C",cupid:"1F498",gift_heart:"1F49D",sparkling_heart:"1F496",heartpulse:"1F497",heartbeat:"1F493",revolving_hearts:"1F49E",two_hearts:"1F495",heart_decoration:"1F49F",broken_heart:"1F494",orange_heart:"1F9E1",yellow_heart:"1F49B",green_heart:"1F49A",blue_heart:"1F499",purple_heart:"1F49C",brown_heart:"1F90E",black_heart:"1F5A4",white_heart:"1F90D",anger:"1F4A2",boom:"1F4A5",dizzy:"1F4AB",sweat_drops:"1F4A6",dash:"1F4A8",bomb:"1F4A3",speech_balloon:"1F4AC",thought_balloon:"1F4AD",zzz:"1F4A4",wave:"1F44B",raised_back_of_hand:"1F91A",hand:"270B","spock-hand":"1F596",ok_hand:"1F44C",pinching_hand:"1F90F",crossed_fingers:"1F91E",i_love_you_hand_sign:"1F91F",the_horns:"1F918",call_me_hand:"1F919",point_left:"1F448",point_right:"1F449",point_up_2:"1F446",middle_finger:"1F595",point_down:"1F447","+1":"1F44D","-1":"1F44E",fist:"270A",facepunch:"1F44A","left-facing_fist":"1F91B","right-facing_fist":"1F91C",clap:"1F44F",raised_hands:"1F64C",open_hands:"1F450",palms_up_together:"1F932",handshake:"1F91D",pray:"1F64F",nail_care:"1F485",selfie:"1F933",muscle:"1F4AA",mechanical_arm:"1F9BE",mechanical_leg:"1F9BF",leg:"1F9B5",foot:"1F9B6",ear:"1F442",ear_with_hearing_aid:"1F9BB",nose:"1F443",brain:"1F9E0",tooth:"1F9B7",bone:"1F9B4",eyes:"1F440",tongue:"1F445",lips:"1F444",baby:"1F476",child:"1F9D2",boy:"1F466",girl:"1F467",adult:"1F9D1",person_with_blond_hair:"1F471",man:"1F468",bearded_person:"1F9D4",woman:"1F469",older_adult:"1F9D3",older_man:"1F474",older_woman:"1F475",person_frowning:"1F64D",person_with_pouting_face:"1F64E",no_good:"1F645",ok_woman:"1F646",information_desk_person:"1F481",raising_hand:"1F64B",deaf_person:"1F9CF",bow:"1F647",face_palm:"1F926",shrug:"1F937",cop:"1F46E",guardsman:"1F482",construction_worker:"1F477",prince:"1F934",princess:"1F478",man_with_turban:"1F473",man_with_gua_pi_mao:"1F472",person_with_headscarf:"1F9D5",man_in_tuxedo:"1F935",bride_with_veil:"1F470",pregnant_woman:"1F930","breast-feeding":"1F931",angel:"1F47C",santa:"1F385",mrs_claus:"1F936",superhero:"1F9B8",supervillain:"1F9B9",mage:"1F9D9",fairy:"1F9DA",vampire:"1F9DB",merperson:"1F9DC",elf:"1F9DD",genie:"1F9DE",zombie:"1F9DF",massage:"1F486",haircut:"1F487",walking:"1F6B6",standing_person:"1F9CD",kneeling_person:"1F9CE",runner:"1F3C3",dancer:"1F483",man_dancing:"1F57A",dancers:"1F46F",person_in_steamy_room:"1F9D6",person_climbing:"1F9D7",fencer:"1F93A",horse_racing:"1F3C7",snowboarder:"1F3C2",surfer:"1F3C4",rowboat:"1F6A3",swimmer:"1F3CA",bicyclist:"1F6B4",mountain_bicyclist:"1F6B5",person_doing_cartwheel:"1F938",wrestlers:"1F93C",water_polo:"1F93D",handball:"1F93E",juggling:"1F939",person_in_lotus_position:"1F9D8",bath:"1F6C0",sleeping_accommodation:"1F6CC",two_women_holding_hands:"1F46D",couple:"1F46B",two_men_holding_hands:"1F46C",couplekiss:"1F48F",couple_with_heart:"1F491",family:"1F46A",bust_in_silhouette:"1F464",busts_in_silhouette:"1F465",footprints:"1F463",monkey_face:"1F435",monkey:"1F412",gorilla:"1F98D",orangutan:"1F9A7",dog:"1F436",dog2:"1F415",guide_dog:"1F9AE",poodle:"1F429",wolf:"1F43A",fox_face:"1F98A",raccoon:"1F99D",cat:"1F431",cat2:"1F408",lion_face:"1F981",tiger:"1F42F",tiger2:"1F405",leopard:"1F406",horse:"1F434",racehorse:"1F40E",unicorn_face:"1F984",zebra_face:"1F993",deer:"1F98C",cow:"1F42E",ox:"1F402",water_buffalo:"1F403",cow2:"1F404",pig:"1F437",pig2:"1F416",boar:"1F417",pig_nose:"1F43D",ram:"1F40F",sheep:"1F411",goat:"1F410",dromedary_camel:"1F42A",camel:"1F42B",llama:"1F999",giraffe_face:"1F992",elephant:"1F418",rhinoceros:"1F98F",hippopotamus:"1F99B",mouse:"1F42D",mouse2:"1F401",rat:"1F400",hamster:"1F439",rabbit:"1F430",rabbit2:"1F407",hedgehog:"1F994",bat:"1F987",bear:"1F43B",koala:"1F428",panda_face:"1F43C",sloth:"1F9A5",otter:"1F9A6",skunk:"1F9A8",kangaroo:"1F998",badger:"1F9A1",feet:"1F43E",turkey:"1F983",chicken:"1F414",rooster:"1F413",hatching_chick:"1F423",baby_chick:"1F424",hatched_chick:"1F425",bird:"1F426",penguin:"1F427",eagle:"1F985",duck:"1F986",swan:"1F9A2",owl:"1F989",flamingo:"1F9A9",peacock:"1F99A",parrot:"1F99C",frog:"1F438",crocodile:"1F40A",turtle:"1F422",lizard:"1F98E",snake:"1F40D",dragon_face:"1F432",dragon:"1F409",sauropod:"1F995","t-rex":"1F996",whale:"1F433",whale2:"1F40B",dolphin:"1F42C",fish:"1F41F",tropical_fish:"1F420",blowfish:"1F421",shark:"1F988",octopus:"1F419",shell:"1F41A",snail:"1F40C",butterfly:"1F98B",bug:"1F41B",ant:"1F41C",bee:"1F41D",beetle:"1F41E",cricket:"1F997",scorpion:"1F982",mosquito:"1F99F",microbe:"1F9A0",bouquet:"1F490",cherry_blossom:"1F338",white_flower:"1F4AE",rose:"1F339",wilted_flower:"1F940",hibiscus:"1F33A",sunflower:"1F33B",blossom:"1F33C",tulip:"1F337",seedling:"1F331",evergreen_tree:"1F332",deciduous_tree:"1F333",palm_tree:"1F334",cactus:"1F335",ear_of_rice:"1F33E",herb:"1F33F",four_leaf_clover:"1F340",maple_leaf:"1F341",fallen_leaf:"1F342",leaves:"1F343",grapes:"1F347",melon:"1F348",watermelon:"1F349",tangerine:"1F34A",lemon:"1F34B",banana:"1F34C",pineapple:"1F34D",mango:"1F96D",apple:"1F34E",green_apple:"1F34F",pear:"1F350",peach:"1F351",cherries:"1F352",strawberry:"1F353",kiwifruit:"1F95D",tomato:"1F345",coconut:"1F965",avocado:"1F951",eggplant:"1F346",potato:"1F954",carrot:"1F955",corn:"1F33D",cucumber:"1F952",leafy_green:"1F96C",broccoli:"1F966",garlic:"1F9C4",onion:"1F9C5",mushroom:"1F344",peanuts:"1F95C",chestnut:"1F330",bread:"1F35E",croissant:"1F950",baguette_bread:"1F956",pretzel:"1F968",bagel:"1F96F",pancakes:"1F95E",waffle:"1F9C7",cheese_wedge:"1F9C0",meat_on_bone:"1F356",poultry_leg:"1F357",cut_of_meat:"1F969",bacon:"1F953",hamburger:"1F354",fries:"1F35F",pizza:"1F355",hotdog:"1F32D",sandwich:"1F96A",taco:"1F32E",burrito:"1F32F",stuffed_flatbread:"1F959",falafel:"1F9C6",egg:"1F95A",fried_egg:"1F373",shallow_pan_of_food:"1F958",stew:"1F372",bowl_with_spoon:"1F963",green_salad:"1F957",popcorn:"1F37F",butter:"1F9C8",salt:"1F9C2",canned_food:"1F96B",bento:"1F371",rice_cracker:"1F358",rice_ball:"1F359",rice:"1F35A",curry:"1F35B",ramen:"1F35C",spaghetti:"1F35D",sweet_potato:"1F360",oden:"1F362",sushi:"1F363",fried_shrimp:"1F364",fish_cake:"1F365",moon_cake:"1F96E",dango:"1F361",dumpling:"1F95F",fortune_cookie:"1F960",takeout_box:"1F961",crab:"1F980",lobster:"1F99E",shrimp:"1F990",squid:"1F991",oyster:"1F9AA",icecream:"1F366",shaved_ice:"1F367",ice_cream:"1F368",doughnut:"1F369",cookie:"1F36A",birthday:"1F382",cake:"1F370",cupcake:"1F9C1",pie:"1F967",chocolate_bar:"1F36B",candy:"1F36C",lollipop:"1F36D",custard:"1F36E",honey_pot:"1F36F",baby_bottle:"1F37C",glass_of_milk:"1F95B",coffee:"2615",tea:"1F375",sake:"1F376",champagne:"1F37E",wine_glass:"1F377",cocktail:"1F378",tropical_drink:"1F379",beer:"1F37A",beers:"1F37B",clinking_glasses:"1F942",tumbler_glass:"1F943",cup_with_straw:"1F964",beverage_box:"1F9C3",mate_drink:"1F9C9",ice_cube:"1F9CA",chopsticks:"1F962",fork_and_knife:"1F374",spoon:"1F944",hocho:"1F52A",amphora:"1F3FA",eyeglasses:"1F453",goggles:"1F97D",lab_coat:"1F97C",safety_vest:"1F9BA",necktie:"1F454",shirt:"1F455",jeans:"1F456",scarf:"1F9E3",gloves:"1F9E4",coat:"1F9E5",socks:"1F9E6",dress:"1F457",kimono:"1F458",sari:"1F97B","one-piece_swimsuit":"1FA71",briefs:"1FA72",shorts:"1FA73",bikini:"1F459",womans_clothes:"1F45A",purse:"1F45B",handbag:"1F45C",pouch:"1F45D",school_satchel:"1F392",mans_shoe:"1F45E",athletic_shoe:"1F45F",hiking_boot:"1F97E",womans_flat_shoe:"1F97F",high_heel:"1F460",sandal:"1F461",ballet_shoes:"1FA70",boot:"1F462",crown:"1F451",womans_hat:"1F452",tophat:"1F3A9",mortar_board:"1F393",billed_cap:"1F9E2",prayer_beads:"1F4FF",lipstick:"1F484",ring:"1F48D",gem:"1F48E",mute:"1F507",speaker:"1F508",sound:"1F509",loud_sound:"1F50A",loudspeaker:"1F4E2",mega:"1F4E3",postal_horn:"1F4EF",bell:"1F514",no_bell:"1F515",musical_score:"1F3BC",musical_note:"1F3B5",notes:"1F3B6",microphone:"1F3A4",headphones:"1F3A7",radio:"1F4FB",saxophone:"1F3B7",guitar:"1F3B8",musical_keyboard:"1F3B9",trumpet:"1F3BA",violin:"1F3BB",banjo:"1FA95",drum_with_drumsticks:"1F941",iphone:"1F4F1",calling:"1F4F2",telephone_receiver:"1F4DE",pager:"1F4DF",fax:"1F4E0",battery:"1F50B",electric_plug:"1F50C",computer:"1F4BB",minidisc:"1F4BD",floppy_disk:"1F4BE",cd:"1F4BF",dvd:"1F4C0",abacus:"1F9EE",movie_camera:"1F3A5",clapper:"1F3AC",tv:"1F4FA",camera:"1F4F7",camera_with_flash:"1F4F8",video_camera:"1F4F9",vhs:"1F4FC",mag:"1F50D",mag_right:"1F50E",bulb:"1F4A1",flashlight:"1F526",izakaya_lantern:"1F3EE",diya_lamp:"1FA94",notebook_with_decorative_cover:"1F4D4",closed_book:"1F4D5",book:"1F4D6",green_book:"1F4D7",blue_book:"1F4D8",orange_book:"1F4D9",books:"1F4DA",notebook:"1F4D3",ledger:"1F4D2",page_with_curl:"1F4C3",scroll:"1F4DC",page_facing_up:"1F4C4",newspaper:"1F4F0",bookmark_tabs:"1F4D1",bookmark:"1F516",moneybag:"1F4B0",yen:"1F4B4",dollar:"1F4B5",euro:"1F4B6",pound:"1F4B7",money_with_wings:"1F4B8",credit_card:"1F4B3",receipt:"1F9FE",chart:"1F4B9",currency_exchange:"1F4B1",heavy_dollar_sign:"1F4B2","e-mail":"1F4E7",incoming_envelope:"1F4E8",envelope_with_arrow:"1F4E9",outbox_tray:"1F4E4",inbox_tray:"1F4E5",package:"1F4E6",mailbox:"1F4EB",mailbox_closed:"1F4EA",mailbox_with_mail:"1F4EC",mailbox_with_no_mail:"1F4ED",postbox:"1F4EE",memo:"1F4DD",briefcase:"1F4BC",file_folder:"1F4C1",open_file_folder:"1F4C2",date:"1F4C5",calendar:"1F4C6",card_index:"1F4C7",chart_with_upwards_trend:"1F4C8",chart_with_downwards_trend:"1F4C9",bar_chart:"1F4CA",clipboard:"1F4CB",pushpin:"1F4CC",round_pushpin:"1F4CD",paperclip:"1F4CE",straight_ruler:"1F4CF",triangular_ruler:"1F4D0",lock:"1F512",unlock:"1F513",lock_with_ink_pen:"1F50F",closed_lock_with_key:"1F510",key:"1F511",hammer:"1F528",axe:"1FA93",gun:"1F52B",bow_and_arrow:"1F3F9",wrench:"1F527",nut_and_bolt:"1F529",probing_cane:"1F9AF",link:"1F517",toolbox:"1F9F0",magnet:"1F9F2",test_tube:"1F9EA",petri_dish:"1F9EB",dna:"1F9EC",microscope:"1F52C",telescope:"1F52D",satellite_antenna:"1F4E1",syringe:"1F489",drop_of_blood:"1FA78",pill:"1F48A",adhesive_bandage:"1FA79",stethoscope:"1FA7A",door:"1F6AA",chair:"1FA91",toilet:"1F6BD",shower:"1F6BF",bathtub:"1F6C1",razor:"1FA92",lotion_bottle:"1F9F4",safety_pin:"1F9F7",broom:"1F9F9",basket:"1F9FA",roll_of_paper:"1F9FB",soap:"1F9FC",sponge:"1F9FD",fire_extinguisher:"1F9EF",shopping_trolley:"1F6D2",smoking:"1F6AC",moyai:"1F5FF",earth_africa:"1F30D",earth_americas:"1F30E",earth_asia:"1F30F",globe_with_meridians:"1F310",japan:"1F5FE",compass:"1F9ED",volcano:"1F30B",mount_fuji:"1F5FB",bricks:"1F9F1",house:"1F3E0",house_with_garden:"1F3E1",office:"1F3E2",post_office:"1F3E3",european_post_office:"1F3E4",hospital:"1F3E5",bank:"1F3E6",hotel:"1F3E8",love_hotel:"1F3E9",convenience_store:"1F3EA",school:"1F3EB",department_store:"1F3EC",factory:"1F3ED",japanese_castle:"1F3EF",european_castle:"1F3F0",wedding:"1F492",tokyo_tower:"1F5FC",statue_of_liberty:"1F5FD",church:"26EA",mosque:"1F54C",hindu_temple:"1F6D5",synagogue:"1F54D",kaaba:"1F54B",fountain:"26F2",tent:"26FA",foggy:"1F301",night_with_stars:"1F303",sunrise_over_mountains:"1F304",sunrise:"1F305",city_sunset:"1F306",city_sunrise:"1F307",bridge_at_night:"1F309",carousel_horse:"1F3A0",ferris_wheel:"1F3A1",roller_coaster:"1F3A2",barber:"1F488",circus_tent:"1F3AA",steam_locomotive:"1F682",railway_car:"1F683",bullettrain_side:"1F684",bullettrain_front:"1F685",train2:"1F686",metro:"1F687",light_rail:"1F688",station:"1F689",tram:"1F68A",monorail:"1F69D",mountain_railway:"1F69E",train:"1F68B",bus:"1F68C",oncoming_bus:"1F68D",trolleybus:"1F68E",minibus:"1F690",ambulance:"1F691",fire_engine:"1F692",police_car:"1F693",oncoming_police_car:"1F694",taxi:"1F695",oncoming_taxi:"1F696",car:"1F697",oncoming_automobile:"1F698",blue_car:"1F699",truck:"1F69A",articulated_lorry:"1F69B",tractor:"1F69C",motor_scooter:"1F6F5",manual_wheelchair:"1F9BD",motorized_wheelchair:"1F9BC",auto_rickshaw:"1F6FA",bike:"1F6B2",scooter:"1F6F4",skateboard:"1F6F9",busstop:"1F68F",fuelpump:"26FD",rotating_light:"1F6A8",traffic_light:"1F6A5",vertical_traffic_light:"1F6A6",octagonal_sign:"1F6D1",construction:"1F6A7",anchor:"2693",boat:"26F5",canoe:"1F6F6",speedboat:"1F6A4",ship:"1F6A2",airplane_departure:"1F6EB",airplane_arriving:"1F6EC",parachute:"1FA82",seat:"1F4BA",helicopter:"1F681",suspension_railway:"1F69F",mountain_cableway:"1F6A0",aerial_tramway:"1F6A1",rocket:"1F680",flying_saucer:"1F6F8",luggage:"1F9F3",hourglass:"231B",hourglass_flowing_sand:"23F3",watch:"231A",alarm_clock:"23F0",clock12:"1F55B",clock1230:"1F567",clock1:"1F550",clock130:"1F55C",clock2:"1F551",clock230:"1F55D",clock3:"1F552",clock330:"1F55E",clock4:"1F553",clock430:"1F55F",clock5:"1F554",clock530:"1F560",clock6:"1F555",clock630:"1F561",clock7:"1F556",clock730:"1F562",clock8:"1F557",clock830:"1F563",clock9:"1F558",clock930:"1F564",clock10:"1F559",clock1030:"1F565",clock11:"1F55A",clock1130:"1F566",new_moon:"1F311",waxing_crescent_moon:"1F312",first_quarter_moon:"1F313",moon:"1F314",full_moon:"1F315",waning_gibbous_moon:"1F316",last_quarter_moon:"1F317",waning_crescent_moon:"1F318",crescent_moon:"1F319",new_moon_with_face:"1F31A",first_quarter_moon_with_face:"1F31B",last_quarter_moon_with_face:"1F31C",full_moon_with_face:"1F31D",sun_with_face:"1F31E",ringed_planet:"1FA90",star:"2B50",star2:"1F31F",stars:"1F320",milky_way:"1F30C",partly_sunny:"26C5",cyclone:"1F300",rainbow:"1F308",closed_umbrella:"1F302",umbrella_with_rain_drops:"2614",zap:"26A1",snowman_without_snow:"26C4",fire:"1F525",droplet:"1F4A7",ocean:"1F30A",jack_o_lantern:"1F383",christmas_tree:"1F384",fireworks:"1F386",sparkler:"1F387",firecracker:"1F9E8",sparkles:"2728",balloon:"1F388",tada:"1F389",confetti_ball:"1F38A",tanabata_tree:"1F38B",bamboo:"1F38D",dolls:"1F38E",flags:"1F38F",wind_chime:"1F390",rice_scene:"1F391",red_envelope:"1F9E7",ribbon:"1F380",gift:"1F381",ticket:"1F3AB",trophy:"1F3C6",sports_medal:"1F3C5",first_place_medal:"1F947",second_place_medal:"1F948",third_place_medal:"1F949",soccer:"26BD",baseball:"26BE",softball:"1F94E",basketball:"1F3C0",volleyball:"1F3D0",football:"1F3C8",rugby_football:"1F3C9",tennis:"1F3BE",flying_disc:"1F94F",bowling:"1F3B3",cricket_bat_and_ball:"1F3CF",field_hockey_stick_and_ball:"1F3D1",ice_hockey_stick_and_puck:"1F3D2",lacrosse:"1F94D",table_tennis_paddle_and_ball:"1F3D3",badminton_racquet_and_shuttlecock:"1F3F8",boxing_glove:"1F94A",martial_arts_uniform:"1F94B",goal_net:"1F945",golf:"26F3",fishing_pole_and_fish:"1F3A3",diving_mask:"1F93F",running_shirt_with_sash:"1F3BD",ski:"1F3BF",sled:"1F6F7",curling_stone:"1F94C",dart:"1F3AF","yo-yo":"1FA80",kite:"1FA81","8ball":"1F3B1",crystal_ball:"1F52E",nazar_amulet:"1F9FF",video_game:"1F3AE",slot_machine:"1F3B0",game_die:"1F3B2",jigsaw:"1F9E9",teddy_bear:"1F9F8",black_joker:"1F0CF",mahjong:"1F004",flower_playing_cards:"1F3B4",performing_arts:"1F3AD",art:"1F3A8",thread:"1F9F5",yarn:"1F9F6",atm:"1F3E7",put_litter_in_its_place:"1F6AE",potable_water:"1F6B0",wheelchair:"267F",mens:"1F6B9",womens:"1F6BA",restroom:"1F6BB",baby_symbol:"1F6BC",wc:"1F6BE",passport_control:"1F6C2",customs:"1F6C3",baggage_claim:"1F6C4",left_luggage:"1F6C5",children_crossing:"1F6B8",no_entry:"26D4",no_entry_sign:"1F6AB",no_bicycles:"1F6B3",no_smoking:"1F6AD",do_not_litter:"1F6AF","non-potable_water":"1F6B1",no_pedestrians:"1F6B7",no_mobile_phones:"1F4F5",underage:"1F51E",arrows_clockwise:"1F503",arrows_counterclockwise:"1F504",back:"1F519",end:"1F51A",on:"1F51B",soon:"1F51C",top:"1F51D",place_of_worship:"1F6D0",menorah_with_nine_branches:"1F54E",six_pointed_star:"1F52F",aries:"2648",taurus:"2649",gemini:"264A",cancer:"264B",leo:"264C",virgo:"264D",libra:"264E",scorpius:"264F",sagittarius:"2650",capricorn:"2651",aquarius:"2652",pisces:"2653",ophiuchus:"26CE",twisted_rightwards_arrows:"1F500",repeat:"1F501",repeat_one:"1F502",fast_forward:"23E9",rewind:"23EA",arrow_up_small:"1F53C",arrow_double_up:"23EB",arrow_down_small:"1F53D",arrow_double_down:"23EC",cinema:"1F3A6",low_brightness:"1F505",high_brightness:"1F506",signal_strength:"1F4F6",vibration_mode:"1F4F3",mobile_phone_off:"1F4F4",trident:"1F531",name_badge:"1F4DB",beginner:"1F530",o:"2B55",white_check_mark:"2705",x:"274C",negative_squared_cross_mark:"274E",heavy_plus_sign:"2795",heavy_minus_sign:"2796",heavy_division_sign:"2797",curly_loop:"27B0",loop:"27BF",question:"2753",grey_question:"2754",grey_exclamation:"2755",exclamation:"2757",keycap_ten:"1F51F",capital_abcd:"1F520",abcd:"1F521",symbols:"1F523",abc:"1F524",ab:"1F18E",cl:"1F191",cool:"1F192",free:"1F193",id:"1F194",new:"1F195",ng:"1F196",ok:"1F197",sos:"1F198",up:"1F199",vs:"1F19A",koko:"1F201",u6709:"1F236",u6307:"1F22F",ideograph_advantage:"1F250",u5272:"1F239",u7121:"1F21A",u7981:"1F232",accept:"1F251",u7533:"1F238",u5408:"1F234",u7a7a:"1F233",u55b6:"1F23A",u6e80:"1F235",red_circle:"1F534",large_orange_circle:"1F7E0",large_yellow_circle:"1F7E1",large_green_circle:"1F7E2",large_blue_circle:"1F535",large_purple_circle:"1F7E3",large_brown_circle:"1F7E4",black_circle:"26AB",white_circle:"26AA",large_red_square:"1F7E5",large_orange_square:"1F7E7",large_yellow_square:"1F7E8",large_green_square:"1F7E9",large_blue_square:"1F7E6",large_purple_square:"1F7EA",large_brown_square:"1F7EB",black_large_square:"2B1B",white_large_square:"2B1C",black_medium_small_square:"25FE",white_medium_small_square:"25FD",large_orange_diamond:"1F536",large_blue_diamond:"1F537",small_orange_diamond:"1F538",small_blue_diamond:"1F539",small_red_triangle:"1F53A",small_red_triangle_down:"1F53B",diamond_shape_with_a_dot_inside:"1F4A0",radio_button:"1F518",white_square_button:"1F533",black_square_button:"1F532"},wt={":":{")":"1F642","(":"1F641",O:"1F62E",P:"1F61B",D:"1F604","*":"1F617","|":"1F610","#":"1F910",S:"1F616",$:"1F633","/":"1F615",".":"1F636",X:"1F922"},8:{")":"1F60E"},":'":{")":"1F602","(":"1F622",D:"1F923"},";":{")":"1F609",P:"1F61C"},X:{")":"1F606",D:"1F606",P:"1F61D"}};let pt=function(){},mt=function(){};function xows_tpl_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"embload":pt=o;break;case"emberror":mt=o}}function xows_tpl_emld(e){pt(e)}function xows_tpl_emer(e){mt(e)}function xows_tpl_template_load(e,o){let _=Ns.root+"/themes/"+dt;switch(o){case nt:_+="/import/";break;case ct:_+="/instanced/";break;default:_+="/"}_+=e+".html",Ns.uncache&&(_+="?"+xows_gen_nonce_asc(4));const t=new XMLHttpRequest;t.open("GET",_,!0),t._type=o,t.onreadystatechange=function(){4===this.readyState&&(200===this.status?xows_tpl_template_parse(this.responseText,this.responseURL,this._type):xows_init_fatal(this.status,this.responseURL))},at++,xows_log(2,"tpl_template_load","loading file",_),t.send()}function xows_tpl_template_done(){for(;ut.childNodes.length>0;)document.body.appendChild(ut.firstChild);xows_log(2,"tpl_template_done","templates parsing completed"),ut=null,rt()}function xows_tpl_template_parse(e,o,_){xows_log(2,"tpl_template_parse","parsing template",o),e=xows_l10n_parse(e);const t=it.parseFromString(e,"text/html"),s=xows_clean_dom(it.parseFromString(e,"text/html").body);if(!s)return void xows_log(0,"tpl_template_parse","template parse error",o);let n,c;const i=[],r=[];if(_!==ct)for(n=(c=s.querySelectorAll("[XOWS_TPL_IMPORT]")).length;n--;)c[n].id?(i.push(c[n].id),c[n].removeAttribute("XOWS_TPL_IMPORT")):xows_log(0,"tpl_template_parse","instance declared without id",o);for(n=(c=s.querySelectorAll("[XOWS_TPL_INSTANCED]")).length;n--;)c[n].id?(r.push(c[n].id),c[n].parentNode.removeChild(c[n])):xows_log(0,"tpl_template_parse","instance declared without id",o);let a=o.substring(o.lastIndexOf("/")+1).split(".")[0];if(_===ct)s.firstChild?(lt[a]=document.createDocumentFragment(),lt[a].appendChild(s.firstChild)):document.head.appendChild(t.head.firstChild);else{let e=ut.querySelector("#"+a);for(e||(e=ut);s.childNodes.length>0;)e.appendChild(s.firstChild);for(n=i.length;n--;)xows_tpl_template_load(i[n],nt)}for(n=r.length;n--;)xows_tpl_template_load(r[n],ct);0===--at&&xows_tpl_template_done()}function xows_tpl_init(e){e&&(rt=e),Ns.root&&(Ns.root=Ns.root),Ns.theme&&(dt=Ns.theme);const o=document.createElement("link");let _;o.rel="stylesheet",o.type="text/css",_=Ns.mincss?"/style.min.css":"/style.css",o.href=Ns.root+"/themes/"+dt+_,Ns.uncache&&(o.href+="?"+xows_gen_nonce_asc(4)),document.head.appendChild(o),at=0,ut=document.createDocumentFragment(),xows_tpl_template_load("body")}const gt=/^\s*<a href=.+<\/a>\s*$/,ft=/^(?:http|https):\/\/(?:[!#$&-;=?-\[\]_a-z~]|%[0-9a-fA-F]{2})+/i,ht=/^```(.*?)\n(.+)```(?:\s?\n|\s?$)/s,bt=/^`(\S.+?\S)`/,yt=/(^\*\S.*?[^\s\*]\*)(?:[^\*]|$)/,Ft=/(^\*{2}\S.+?\S\*{2})(?:[^\*]|$)/,vt=/(^\*\S.+?\S\*)/,kt=/^_\S.+?\S_/,At=/^~\S.+?\S~/,Et=/^(>+?) .+[^>](?=\n|$)/,qt=/^:([\w\-+]+):/,St=/^([X8:;]|:')([()|DPXO#$.\/*sS])(?=\s|$)/i,Ct=new Map([[38,"&amp;"],[60,"&lt;"],[62,"&gt;"],[39,"&apos;"],[34,"&quot;"],[10,"<br>"]]),Dt=new Array;function xows_tpl_parse_styling(e){if(!e||!e.length)return"";let o,_,t=0,s=0,n=!1,c=!1,i=0,r="",a=0;for(Dt.length=0;a!==e.length;){if(_=e.charCodeAt(a),i&&10===e.charCodeAt(a-1)&&62!==_)for(;i;)r+="</blockquote>",i--;if(72!==_&&104!==_||!(o=ft.exec(e.substring(a)))){if(58===_||59===_||88===_||120===_||56===_){const _=e.substring(a);if(o=qt.exec(_)){const e=xt[o[1]];if(e){r+="<emo-ji>&#x"+e+";</emo-ji>",a+=o[0].length;continue}}if((0===a||32===e.charCodeAt(a-1))&&(o=St.exec(_))){const e=wt[o[1].toUpperCase()][o[2].toUpperCase()];if(e){r+="<emo-ji>&#x"+e+";</emo-ji>",a+=o[0].length;continue}}}if(_>47&&_<58||_>64&&_<91||_>96&&_<123)r+=e.charAt(a++);else if(_>55295&&_<57344)((_=65536+((1023&_)<<10|1023&e.charCodeAt(a+1)))>=8960&&_<=11263||_>=126976&&_<=129792)&&(r+="<emo-ji>&#x"+_.toString(16)+";</emo-ji>"),a+=2;else{if(42===_){if(s){if(s===a){r+="</b>",s=0,a+=2;continue}}else if(42===e.charCodeAt(a+1)&&(o=Ft.exec(e.substring(a)))){s=a+(o[1].length-2),r+="<b>",a+=2;continue}if(t){if(t===a){r+="</i>",t=0,a++;continue}}else if(o=s?vt.exec(e.substring(a)):yt.exec(e.substring(a))){t=a+(o[1].length-1),r+="<i>",a++;continue}}if(95===_){if(n){n=!1,r+="</u>",a++;continue}if(n=kt.test(e.substring(a))){r+="<u>",a++;continue}}if(126===_){if(c){c=!1,r+="</s>",a++;continue}if(c=At.test(e.substring(a))){r+="<s>",a++;continue}}if(62===_&&(0===a||10===e.charCodeAt(a-1))){let _=0;for(;o=Et.exec(e.substring(a));)32===e.charCodeAt(a+1)?a+=2:a++,_++;if(_){for(;_>i;)r+="<blockquote>",i++;for(;_<i;)r+="</blockquote>",i--;continue}}if(96===_){const _=e.substring(a);if(o=bt.exec(_)){r+="<code>"+o[1]+"</code>",a+=o[0].length;continue}if((0===a||10===e.charCodeAt(a-1))&&(o=ht.exec(_))){r+="<pre>"+o[2]+"</pre>",a+=o[0].length;continue}}Ct.has(_)?r+=Ct.get(_):r+=e.charAt(a),a++}}else Dt.push(o[0]),r+='<a href="'+o[0]+'" target="_blank">'+o[0]+"</a>",a+=o[0].length}return r}function xows_tpl_embed_wrap(e,o,_,t){let s="<embd-wrap class='";return _&&(s+=_),s+="'>",t&&(s+="<a href='"+e+"' target='_blank'>"+t+"</a>"),s+=o.replace(/src=/g,"loading='lazy' onload='xows_tpl_emld(this)' onerror='xows_tpl_emer(this)' src="),s+="</embd-wrap>"}function xows_tpl_embed_image(e,o){return xows_tpl_embed_wrap(e,'<img src="'+e+'">',"EMBD-IMG LOADING")}function xows_tpl_embed_movie(e,o){return xows_tpl_embed_wrap(e,'<video controls src="'+e+'"></video>',"EMBD-VID")}function xows_tpl_embed_audio(e,o){return xows_tpl_embed_wrap(e,'<audio controls src="'+e+'"/>',"EMBD-SND")}function xows_tpl_embed_youtube(e,o){const _=e.match(/(?:v=|embed\/|shorts\/|youtu\.be\/)([\w\-]+)(\?.+)?/);if(!_)return null;let t=_[1];return _[2]&&(t+=_[2].replace(/t=/,"start=")),xows_tpl_embed_wrap(e,'<iframe src="https://www.youtube.com/embed/'+t+'"/>',"EMBD-IFR LOADING","YouTube")}function xows_tpl_embed_dailymo(e,o){const _=e.match(/(?:video|dai\.ly)\/([\w\d]+)/);return _?xows_tpl_embed_wrap(e,'<iframe src="https://www.dailymotion.com/embed/video/'+_[1]+'"/>',"EMBD-IFR LOADING","Dailymotion"):null}function xows_tpl_embed_vimeo(e,o){const _=e.match(/\/([\d]+)/);return _?xows_tpl_embed_wrap(e,'<iframe src="https://player.vimeo.com/video/'+_[1]+'"></iframe>',"EMBD-IFR LOADING","Vimeo"):null}function xows_tpl_embed_odysee(e,o){const _=e.match(/.com\/(.*)/);return _?xows_tpl_embed_wrap(e,'<iframe src="https://odysee.com/$/embed/'+_[1]+'"></iframe>',"EMBD-IFR LOADING","Odysee"):null}function xows_tpl_embed_upld(e,o){return xows_tpl_embed_wrap(e,'<a class="dnld-btn" href="'+e+'" target="_blank"></a>',"EMBD-DNL",decodeURI(e.match(/(.+\/)*(.+\..+)/)[2]))}let Tt={JPG:xows_tpl_embed_image,JPEG:xows_tpl_embed_image,GIF:xows_tpl_embed_image,PNG:xows_tpl_embed_image,WEBP:xows_tpl_embed_image,SVG:xows_tpl_embed_image,MP4:xows_tpl_embed_movie,MPEG:xows_tpl_embed_movie,AVI:xows_tpl_embed_movie,MP3:xows_tpl_embed_audio,OGG:xows_tpl_embed_audio},jt={"www.youtube.com":xows_tpl_embed_youtube,"youtu.be":xows_tpl_embed_youtube,"www.dailymotion.com":xows_tpl_embed_dailymo,"dai.ly":xows_tpl_embed_dailymo,"vimeo.com":xows_tpl_embed_vimeo,"odysee.com":xows_tpl_embed_odysee},Lt={};function xows_tpl_embed_add_site(e,o){jt[e]=o}function xows_tpl_embed_add_file(e,o){Tt[e]=o}function xows_tpl_embed_add_upld(e){Lt[e]=xows_tpl_embed_upld}function xows_tpl_parse_embeds(e){if(!e.length)return null;let o,_,t,s,n="";for(let c=0,i=e.length;c<i;++c)s=null,(o=(t=e[c]).match(/\.([\w\d]+)(\?|$)/))&&(_=o[1].toUpperCase(),Tt[_]&&(s=Tt[_](t,_))),s||(o=t.match(/\/\/(.*?[\w\d\-_]+\.\w+)\//))&&(_=o[1].toLowerCase(),jt[_]&&(s=jt[_](t,_)),Lt[_]&&(s=Lt[_](t,_))),s&&(n+=s);return n.length?n:null}let Nt=new Map;function xows_tpl_spawn_avat_cls(e){let o;if(e.avat)o=e.avat;else{const _=xows_cach_peer_iden(e);xows_cach_avat_temp_data(_,o=xows_cach_avat_temp_hash(_))}if(!Nt.has(o)){const e="h-"+o,_=document.createElement("style");_.type="text/css",_.innerText="."+e+' {background-image:url("'+xows_cach_avat_get(o)+'");}\r\n',document.head.appendChild(_),Nt.set(o,e)}return Nt.get(o)}function xows_tpl_spawn_rost_subs(e){const o=lt["peer-pend"].firstChild.cloneNode(!0);return o.id=e.addr,o.title=e.addr,o.querySelector("PEER-NAME").innerText=e.addr,o}function xows_tpl_update_rost_subs(e,o){e.title=o.addr,e.querySelector("PEER-NAME").innerText=o.addr}function xows_tpl_spawn_rost_cont(e,o){const _=lt["peer-cont"].firstChild.cloneNode(!0);_.id=e.addr;const t=_.querySelector("BADG-SHOW");return e.subs&Te?(_.title=e.name+" ("+e.addr+")",_.querySelector("PEER-NAME").innerText=e.name,_.querySelector("PEER-META").innerText=e.stat?e.stat:"",t.dataset.show=e.show||0,_.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(e)):(_.title=e.addr,_.classList.add("PEER-DENY"),_.querySelector("PEER-NAME").innerText=e.addr,_.querySelector("PEER-META").innerText=xows_l10n_get(o||"Authorization pending"),t.hidden=!0,_.querySelector("[name='cont_bt_rtry']").disabled=!1),_}function xows_tpl_update_rost_cont(e,o,_){const t=e.querySelector("BADG-SHOW"),s=e.querySelector("[name='cont_bt_rtry']");o.subs&Te?(e.title=o.name+" ("+o.addr+")",e.classList.remove("PEER-DENY"),e.querySelector("PEER-NAME").innerText=o.name,e.querySelector("PEER-META").innerText=o.stat?o.stat:"",t.hidden=!1,t.dataset.show=o.show||0,s.disabled=!0,e.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(o)):(e.title=o.addr,e.classList.add("PEER-DENY"),e.querySelector("PEER-NAME").innerText=o.addr,e.querySelector("PEER-META").innerText=xows_l10n_get(_||"Authorization pending"),t.hidden=!0,s.disabled=!1)}function xows_tpl_spawn_rost_room(e){const o=lt["peer-room"].firstChild.cloneNode(!0);return o.id=e.addr,o.title=e.name+" ("+e.addr+")",o.querySelector("PEER-NAME").innerText=e.name,o.querySelector("PEER-META").innerText=e.desc,o.querySelector("BADG-LOCK").hidden=!(e.prot||!e.open),o}function xows_tpl_update_rost_room(e,o){e.title=o.name+" ("+e.id+")",e.querySelector("PEER-NAME").innerText=o.name,e.querySelector("PEER-META").innerText=o.desc,e.querySelector("BADG-LOCK").hidden=!(o.prot||!o.open)}function xows_tpl_spawn_room_occu(e,o=!1){const _=lt["peer-occu"].firstChild.cloneNode(!0);return o?(_.dataset.id=e.addr,_.querySelector("PEER-ACTS").hidden=!0):_.id=e.addr,_.dataset.ocid=e.ocid,_.title=e.name+" ("+e.addr+")",_.querySelector("PEER-NAME").innerText=e.name,_.querySelector("PEER-META").innerText=e.stat?e.stat:"",_.querySelector("BADG-SHOW").dataset.show=e.show||0,_.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(e),_}function xows_tpl_update_room_occu(e,o){e.title=o.name+" ("+e.id+")",e.querySelector("PEER-NAME").innerText=o.name,e.querySelector("PEER-META").innerText=o.stat?o.stat:"",e.querySelector("BADG-SHOW").dataset.show=o.show||0,e.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(o)}function xows_tpl_mesg_bestref(e,o){return e.type===n_?o.dataset.szid?o.dataset.szid:o.dataset.id:o.dataset.orid?o.dataset.orid:o.dataset.id}function xows_tpl_mesg_null_spawn(e,o,_){const t=lt["hist-null"].firstChild.cloneNode(!0);return t.dataset.id=e,t.dataset.orid=e,t.dataset.szid=e,t.dataset.from=o,t.querySelector("MESG-BODY").innerHTML=_,t}function xows_tpl_mesg_spawn(e,o,_,t,s,n){const c=lt["hist-mesg"].firstChild.cloneNode(!0);if(c.dataset.id=o.id,c.dataset.from=o.from,c.dataset.time=o.time,o.orid&&(c.dataset.orid=o.orid),o.szid&&(c.dataset.szid=o.szid),o.ocid&&(c.dataset.ocid=o.ocid),n){const o=c.querySelector("MESG-RPLY");if(n.classList.contains("MESG-NULL"))o.classList.add("MESG-FAIL");else{const _=xows_cli_author_get(e,n.dataset.from,n.dataset.ocid);_.self&&c.classList.add("MENTION");let t=xows_cli_peer_iden(_);const s=c.querySelector("RPLY-AVAT");s.dataset.peer=t,s.className=xows_tpl_spawn_avat_cls(_);const i=c.querySelector("RPLY-FROM");i.dataset.peer=t,i.innerText=_.name,o.dataset.to=_.addr}const _=n.querySelector("MESG-BODY");c.querySelector("RPLY-BODY").innerHTML=_?_.innerText:"[...]",o.dataset.id=xows_tpl_mesg_bestref(e,n),o.hidden=!1}let i;s?(i=s.classList.contains("MESG-APPEND"),c.classList.add("MESG-MODIFY")):t&&!n&&(i=t.dataset.from===o.from&&o.time-t.dataset.time<$t),i&&c.classList.add("MESG-APPEND");const r=xows_cli_author_get(e,o.from,o.ocid);let a=xows_cli_peer_iden(r);const l=c.querySelector("MESG-FROM");l.dataset.peer=a,l.innerText=r.name;const u=c.querySelector("MESG-AVAT");u.dataset.peer=a,u.className=xows_tpl_spawn_avat_cls(r),r.self&&(c.classList.add("MESG-SENT"),_||c.classList.add("MESG-RECP"),c.querySelector("MESG-BODY").dataset.raw=xows_html_escape(o.body)),c.querySelector("MESG-HOUR").innerText=xows_l10n_houre(o.time),c.querySelector("MESG-DATE").innerText=xows_l10n_date(o.time);const d=c.querySelector("MESG-BODY"),x=c.querySelector("MESG-EMBD"),w=xows_tpl_parse_styling(o.body);d.innerHTML=w;const p=xows_tpl_parse_embeds(Dt);return p&&(x.innerHTML=p,x.hidden=!1,gt.test(w)&&(d.hidden=!0)),c}function xows_tpl_mesg_update(e,o,_,t,s){if(_&&(e.dataset.orid=_.orid,e.dataset.szid=_.szid,e.dataset.ocid=_.ocid),t&&e.classList.add("MESG-RECP"),s){const _=e.querySelector("MESG-RPLY");if(s.classList.contains("MESG-NULL"))_.classList.add("MESG-FAIL"),e.classList.remove("MENTION");else{const e=xows_cli_author_get(o,s.dataset.from,s.dataset.ocid);_.dataset.to=e.addr}_.dataset.id=xows_tpl_mesg_bestref(o,s);const t=s.querySelector("MESG-BODY");e.querySelector("RPLY-BODY").innerHTML=t?t.innerText:"[...]"}}function xows_tpl_mesg_edit_insert(e){const o=lt["mesg-edit"].firstChild.cloneNode(!0);o.dataset.id=e.id;const _=e.querySelector("MESG-BODY");return o.querySelector("MESG-INPT").innerHTML=_.dataset.raw,_.parentNode.insertBefore(o,_),e.classList.add("MESG-EDITOR"),o}function xows_tpl_mesg_edit_remove(e){const o=e.querySelector("MESG-MAIN");o&&o.removeChild(o.querySelector("MESG-EDIT")),e.classList.remove("MESG-EDITOR")}function xows_tpl_mesg_trsh_insert(e){const o=lt["mesg-trsh"].firstChild.cloneNode(!0);o.dataset.id=e.id;const _=e.querySelector("MESG-EMBD");return _.parentNode.insertBefore(o,_),e.classList.add("MESG-TRASH"),o}function xows_tpl_mesg_trsh_remove(e){const o=e.querySelector("MESG-MAIN");o&&o.removeChild(o.querySelector("MESG-TRSH")),e.classList.remove("MESG-TRASH")}function xows_tpl_admn_memb_spawn(e,o){let _;e.role?_="memb-role":e.affi&&(_=e.affi==vo?"memb-outc":"memb-affi");const t=lt[_].firstChild.cloneNode(!0);if(t.dataset.bare=e.jid,t.dataset.nick=e.nick,t.querySelector("MEMB-ADDR").innerText=e.jid?e.jid:"",t.querySelector("MEMB-NICK").innerText=e.nick?e.nick:"",e.affi&&e.affi>vo){t.dataset.affi=e.affi,o<qo&&e.affi>=o&&t.setAttribute("disabled","");const _=t.querySelectorAll("MEMB-RADIO");for(let t=0;t<_.length;++t)_[t].dataset.on=_[t].dataset.affi==e.affi,o<qo&&(_[t].hidden=_[t].dataset.affi>Ao)}return t}function xows_tpl_admn_memb_update(e,o,_){const t=e.querySelectorAll("MEMB-RADIO");if(t.length>1)for(let e=0;e<t.length;++e)t[e].dataset.on=t[e].dataset.affi==o;else{const e="true"==t[0].dataset.on;t[0].dataset.on=e?"false":"true",e&&(o=_)}e.dataset.affi=o,null!=_&&(o!=_?e.classList.add("MODIFIED"):e.classList.remove("MODIFIED"))}function xows_tpl_spawn_stream_audio(e){const o=lt["strm-audio"].firstChild.cloneNode(!0);return o.dataset.peer=xows_cli_peer_iden(e),o.title=e.name,o.querySelector("STRM-AVAT").className=xows_tpl_spawn_avat_cls(e),o}function xows_tpl_spawn_stream_video(e){const o=lt["strm-video"].firstChild.cloneNode(!0);return o.dataset.peer=xows_cli_peer_iden(e),o.title=e.name,o}function xows_doc(e){return document.getElementById(e)}const It=new Map,Mt=new Map;let Bt=!1;const Pt=document.getSelection(),Ot=document.createRange();function xows_doc_listener_add(e,o,_,t=!0){e.addEventListener(o,_,{capture:!1,passive:t})}function xows_doc_listener_rem(e,o,_,t=!0){e.removeEventListener(o,_,{capture:!1,passive:t})}function xows_doc_cls_has(e,o){return document.getElementById(e).classList.contains(o)}function xows_doc_cls_tog(e,o,_){return document.getElementById(e).classList.toggle(o,_)}function xows_doc_cls_add(e,o){document.getElementById(e).classList.add(o)}function xows_doc_cls_rem(e,o){document.getElementById(e).classList.remove(o)}function xows_doc_show(e,o=!0){document.getElementById(e).hidden=!o}function xows_doc_hide(e,o=!1){document.getElementById(e).hidden=!o}function xows_doc_hidden(e){return document.getElementById(e).hidden}function xows_doc_frag_clone(e,o,_){let t,s;It.has(e)||It.set(e,new Map),t=It.get(o).get(_),s=document.createDocumentFragment(),It.get(e).set(_,s);for(let e=0,o=t.childNodes.length;e<o;++e)s.appendChild(t.childNodes[e].cloneNode(!0))}function xows_doc_frag_export(e,o,_){let t,s;if(It.has(e)||It.set(e,new Map),t=document.getElementById(o),s=document.createDocumentFragment(),It.get(e).set(o,s),_)for(let e=0,o=t.childNodes.length;e<o;++e)s.appendChild(t.childNodes[e].cloneNode(!0));else for(;t.childNodes.length;)s.appendChild(t.firstChild)}function xows_doc_frag_import(e,o,_){if(It.has(e)){let t,s;if(t=It.get(e).get(o),(s=document.getElementById(o)).innerText="",_)for(let e=0,o=t.childNodes.length;e<o;++e)s.appendChild(t.childNodes[e].cloneNode(!0));else for(;t.childNodes.length;)s.appendChild(t.firstChild)}}function xows_doc_frag_delete(e){It.delete(e)}function xows_doc_frag_clear(){It.clear()}function xows_doc_frag_element(e,o){return It.has(e)?It.get(e).get(o):null}function xows_doc_frag_find(e,o){if(It.has(e)){const _=It.get(e);if(_.has(o))return _.get(o);let t;for(const e of _.values())if(t=e.getElementById(o))return t}return null}function xows_doc_frag_element_find(e,o,_){if(It.has(e)){const t=It.get(e);if(t.has(o))return t.get(o).getElementById(_)}return null}function xows_doc_scrl_init(e){Mt.set(e,{scrollTop:0,scrollHeight:0,clientHeight:0,scrollBottom:0})}function xows_doc_scrl_get(e){return Mt.get(e)}function xows_doc_scrl_export(e,o){const _=document.getElementById(o);_.scrollBottom=_.scrollHeight-(_.clientHeight+_.scrollTop),Mt.set(e,{scrollTop:_.scrollTop,scrollHeight:_.scrollHeight,clientHeight:_.clientHeight,scrollBottom:_.scrollBottom||0})}function xows_doc_scrl_copy(e,o){Mt.set(e,Mt.get(o))}function xows_doc_scrl_delete(e){return Mt.delete(e)}function xows_doc_scrl_clear(){return Mt.clear()}function xows_doc_scrl_import(e,o){const _=Mt.get(e),t=document.getElementById(o);Bt=!0,t.scrollBottom=_.scrollBottom,t.scrollTop=t.scrollHeight-(t.clientHeight+t.scrollBottom)}function xows_doc_scrl_save(e){e.scrollBottom=e.scrollHeight-(e.clientHeight+e.scrollTop)}function xows_doc_scrl_keep(e){Bt=!0,e.scrollTop=e.scrollHeight-(e.clientHeight+(e.scrollBottom||0))}function xows_doc_scrl_down(e,o){Bt=!0,o?e.scrollTo({top:e.scrollHeight-e.clientHeight,behavior:"smooth"}):e.scrollTop=e.scrollHeight-e.clientHeight,e.scrollBottom=0}function xows_doc_scrl_edited(){return!!Bt&&(Bt=!1,!0)}function xows_doc_caret_around(e,o=!1){Pt.removeAllRanges(),Ot.setStartBefore(e),Ot.setEndAfter(e),Ot.collapse(o),Pt.addRange(Ot)}function xows_doc_caret_at(e,o=!1){Pt.removeAllRanges(),Ot.selectNodeContents(e),Ot.collapse(o),Pt.addRange(Ot)}function xows_doc_sel_rng(e){return Pt.getRangeAt(e)}function xows_doc_init(_){Ns.allow_register&&xows_doc_show("auth_regi"),xows_doc_listener_add(xows_doc("scr_page"),"keyup",xows_doc_page_onkeyu),xows_doc_listener_add(xows_doc("page_exit"),"click",xows_doc_page_onclose),xows_doc_listener_add(xows_doc("scr_void"),"click",xows_doc_void_onclick),xows_doc_listener_add(xows_doc("over_view"),"click",xows_doc_view_onclick),xows_tpl_set_callback("embload",xows_doc_media_onload),xows_tpl_set_callback("emberror",xows_doc_media_onerror),xows_doc("app_about").innerText=e.toUpperCase()+" v"+o,xows_log(2,"doc_init","document ready"),xows_isfunc(_)&&_()}function xows_doc_media_onload(e){e.parentNode.classList.remove("LOADPND"),e.parentNode.classList.remove("LOADING"),xows_gui_chat_onresize()}function xows_doc_media_onerror(e){e.parentNode.classList.remove("LOADPND"),e.parentNode.classList.remove("LOADING"),e.parentNode.classList.add("LOADERR"),e.closest("MESG-MAIN").querySelector("MESG-BODY").hidden=!1}function xows_doc_blink_bg(e,o){0===o?xows_doc_cls_rem(e,"BLINK-BG"):(xows_doc_cls_add(e,"BLINK-BG"),setTimeout(xows_doc_blink_bg,o,e,0))}function xows_doc_blink_fg(e,o){0===o?xows_doc_cls_rem(e,"BLINK-FG"):(xows_doc_cls_add(e,"BLINK-FG"),setTimeout(xows_doc_blink_fg,o,e,0))}const Rt=-1,Gt=0,Ht=1,Ut=2,zt={onabort:null,onvalid:null};function xows_doc_popu_close(){xows_doc_listener_rem(xows_doc("popu_close"),"click",xows_doc_popu_close),xows_doc_listener_rem(xows_doc("popu_abort"),"click",xows_doc_popu_onabort),xows_doc_listener_rem(xows_doc("popu_valid"),"click",xows_doc_popu_onvalid),zt.onabort=null,zt.onvalid=null,xows_doc_hide("over_popu"),xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void")}function xows_doc_popu_onabort(e){zt.onabort&&zt.onabort(),xows_doc_popu_close()}function xows_doc_popu_onvalid(e){zt.onvalid&&zt.onvalid(),xows_doc_popu_close()}function xows_doc_popu_open(e,o,_,t,s,n,c){if(xows_doc_popu_modal())return;let i;switch(xows_doc_popu_close(),e){case Rt:i="STYL-ERR";break;case Gt:i="STYL-WRN";break;case Ht:i="STYL-SCS";break;case Ut:i="STYL-ASK"}xows_doc("over_popu").classList=i,xows_doc("popu_text").innerHTML=xows_l10n_get(o),xows_doc_show("popu_close",!_&&!s),xows_doc_show("popu_valid",Boolean(_)),xows_doc_show("popu_abort",Boolean(s)),_&&(xows_doc("popu_valid").innerText=xows_l10n_get(t)),s&&(xows_doc("popu_abort").innerText=xows_l10n_get(n)),zt.onabort=s,zt.onvalid=_,c&&(xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void")),xows_doc_listener_add(xows_doc("popu_close"),"click",xows_doc_popu_close),xows_doc_listener_add(xows_doc("popu_abort"),"click",xows_doc_popu_onabort),xows_doc_listener_add(xows_doc("popu_valid"),"click",xows_doc_popu_onvalid),xows_doc_show("over_popu")}function xows_doc_popu_open_for_save(e,o){xows_doc_hidden("over_popu")&&xows_doc_popu_open(null,"It remains unsaved changes",e,"Save changes",o,"Reset")}function xows_doc_popu_modal(){return!(xows_doc_hidden("over_popu")||!zt.onabort)&&(xows_doc_blink_bg("over_popu",600),!0)}const Vt={onabort:null,onvalid:null,oninput:null,modal:!1};function xows_doc_ibox_allow(e){xows_doc("ibox_valid").disabled=!e}function xows_doc_ibox_error(e){xows_doc("ibox_error").innerText=xows_l10n_get(e),xows_doc_blink_fg("ibox_error",600)}function xows_doc_ibox_close(){xows_doc_hidden("over_ibox")||(xows_doc_listener_rem(xows_doc("ibox_close"),"click",xows_doc_ibox_close),xows_doc_listener_rem(xows_doc("ibox_abort"),"click",xows_doc_ibox_onabort),xows_doc_listener_rem(xows_doc("ibox_valid"),"click",xows_doc_ibox_onvalid),xows_doc_listener_rem(xows_doc("ibox_input"),"input",xows_doc_ibox_oninput),Vt.onabort=null,Vt.onvalid=null,Vt.oninput=null,Vt.modal&&xows_doc_listener_rem(document,"keyup",xows_doc_ibox_onkey),xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"),xows_doc_hide("over_ibox"),Vt.modal=!1)}function xows_doc_ibox_oninput(e){const o=xows_doc("ibox_input").value;Vt.oninput?Vt.oninput(o):xows_doc("ibox_valid").disabled=!o.length}function xows_doc_ibox_onabort(e){Vt.onabort&&Vt.onabort(),xows_doc_ibox_close()}function xows_doc_ibox_onvalid(e){Vt.onvalid&&Vt.onvalid(xows_doc("ibox_input").value),xows_doc_ibox_close()}function xows_doc_ibox_onkey(e){13===e.keyCode&&xows_doc_ibox_onvalid(),27===e.keyCode&&xows_doc_ibox_onabort()}function xows_doc_ibox_open(e,o,_,t,s,n,c,i,r,a=!0){if(xows_cli_activity_wakeup(),xows_doc_ibox_modal())return;xows_doc_ibox_close(),xows_doc("ibox_head").innerHTML=xows_l10n_get(e),xows_doc("ibox_hint").innerHTML=xows_l10n_get(o);const l=xows_doc("ibox_input");l.placeholder=xows_l10n_get(_),l.value=t||"",Vt.onabort=c,Vt.onvalid=s,Vt.oninput=r,n||(n="Apply"),i||(i="Cancel"),xows_doc("ibox_valid").innerText=xows_l10n_get(n),xows_doc("ibox_abort").innerText=xows_l10n_get(i),xows_doc("ibox_error").innerText="",Vt.modal=a,a&&(xows_doc_listener_add(document,"keyup",xows_doc_ibox_onkey),xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void")),xows_doc_ibox_oninput(),xows_doc_listener_add(xows_doc("ibox_close"),"click",xows_doc_ibox_onabort),xows_doc_listener_add(xows_doc("ibox_abort"),"click",xows_doc_ibox_onabort),xows_doc_listener_add(xows_doc("ibox_valid"),"click",xows_doc_ibox_onvalid),xows_doc_listener_add(xows_doc("ibox_input"),"input",xows_doc_ibox_oninput),xows_doc_show("over_ibox"),l.focus()}function xows_doc_ibox_modal(){if(!xows_doc_hidden("over_ibox")){if(Vt.modal)return xows_doc_blink_bg("over_ibox",600),!0;xows_doc_ibox_close()}return!1}const Yt={onvalid:null,onabort:null,modal:!1};function xows_doc_mbox_close(){xows_doc_hidden("over_mbox")||(xows_doc_listener_rem(xows_doc("mbox_close"),"click",xows_doc_mbox_onabort),xows_doc_listener_rem(xows_doc("mbox_abort"),"click",xows_doc_mbox_onabort),xows_doc_listener_rem(xows_doc("mbox_valid"),"click",xows_doc_mbox_onvalid),Yt.onvalid=null,Yt.onabort=null,xows_doc_hide("over_mbox"),xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"),Yt.modal=!1)}function xows_doc_mbox_onvalid(){Yt.onvalid&&Yt.onvalid(),xows_doc_mbox_close()}function xows_doc_mbox_onabort(){Yt.onabort&&Yt.onabort(),xows_doc_mbox_close()}function xows_doc_mbox_open(e,o,_,t,s,n,c,i=!0){if(xows_cli_activity_wakeup(),xows_doc_mbox_modal())return;let r;switch(xows_doc_mbox_close(),e){case Rt:r="STYL-ERR";break;case Gt:r="STYL-WRN";break;case Ht:r="STYL-SCS";break;case Ut:r="STYL-ASK"}xows_doc("mbox_icon").classList=r,xows_doc("mbox_head").innerHTML=xows_l10n_get(o),xows_doc("mbox_text").innerHTML=xows_l10n_get(_),Yt.onabort=n,Yt.onvalid=t,s||(s="OK"),xows_doc("mbox_valid").innerText=xows_l10n_get(s),n?(c||(c="Cancel"),xows_doc_show("mbox_abort"),xows_doc("mbox_abort").innerText=xows_l10n_get(c)):xows_doc_hide("mbox_abort"),Yt.modal=i,i&&(xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void")),xows_doc_listener_add(xows_doc("mbox_close"),"click",xows_doc_mbox_close),xows_doc_listener_add(xows_doc("mbox_abort"),"click",xows_doc_mbox_onabort),xows_doc_listener_add(xows_doc("mbox_valid"),"click",xows_doc_mbox_onvalid),xows_doc_show("over_mbox")}function xows_doc_mbox_modal(){if(!xows_doc_hidden("over_mbox")){if(Yt.modal)return xows_doc_blink_bg("over_mbox",600),!0;xows_doc_mbox_close()}return!1}const Jt={pageid:null,onclose:null,oninput:null,onclick:null};function xows_doc_page_oninput(e){Jt.oninput(e.target)}function xows_doc_page_onclick(e){Jt.onclick(e.target)}function xows_doc_page_onclose(e){xows_doc_popu_modal()||xows_doc_page_close()}function xows_doc_page_close(){if(!Jt.pageid)return;xows_log(2,"doc_page_close",Jt.pageid);const e=xows_doc(Jt.pageid);e.title&&xows_gui_title_pop(),Jt.oninput&&(xows_doc_listener_rem(e,"input",xows_doc_page_oninput),Jt.oninput=null),Jt.onclick&&(xows_doc_listener_rem(e,"click",xows_doc_page_onclick),Jt.onclick=null),Jt.onclose&&Jt.onclose(),Jt.onclose=null,xows_doc_hide("colr_exit"),xows_doc_hide(Jt.pageid),Jt.pageid=null,xows_doc_popu_close(),xows_doc_hide("scr_page")}function xows_doc_page_open(e,o,_,t,s){xows_cli_activity_wakeup(),xows_doc_page_close(),xows_log(2,"doc_page_open",e),xows_doc_show("scr_page"),xows_doc_show(e),Jt.pageid=e,o&&xows_doc_show("colr_exit"),Jt.onclose=_;const n=xows_doc(e);t&&(Jt.oninput=t,xows_doc_listener_add(n,"input",xows_doc_page_oninput)),s&&(Jt.onclick=s,xows_doc_listener_add(n,"click",xows_doc_page_onclick)),n.title&&xows_gui_title_push(xows_l10n_get(n.title)+" - XOWS"),xows_doc_popu_close()}function xows_doc_page_onkeyu(e){if(Jt.pageid&&13===e.keyCode)if(xows_doc_hidden("over_popu")||xows_doc_hidden("popu_valid")){const e=xows_doc(Jt.pageid).querySelector("*[type='submit']");e&&e.click()}else xows_doc("popu_valid").click()}function xows_doc_page_opened(e){return Jt.pageid==e}const Wt={bttn:null,drop:null,onclick:null,onclose:null};function xows_doc_menu_close(){const e=Wt;e.drop&&(e.drop.hidden=!0),e.onclick&&xows_doc_listener_rem(e.drop,"click",e.onclick),e.onclose&&e.onclose(),e.bttn&&e.bttn.blur(),xows_doc_hide("scr_void"),e.drop=null,e.bttn=null,e.onclick=null,e.onclose=null}function xows_doc_menu_toggle(e,o,_,t,s){const n=Wt;if(n.bttn)xows_doc_menu_close();else{const c=xows_doc(o);if(!e||!c)return;n.bttn=e,n.drop=c,n.onclick=_,n.onclose=s,n.onclick&&xows_doc_listener_add(n.drop,"click",n.onclick),xows_isfunc(t)&&t(n.bttn,n.drop),xows_doc_show("scr_void"),n.drop.hidden=!1,n.bttn.focus()}}function xows_doc_view_open(e){"IMG"===e.tagName&&(xows_doc("view_img").src=e.src,xows_doc_show("over_view"),xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void"))}function xows_doc_view_close(){const e=xows_doc("over_view");e.hidden||(e.hidden=!0,xows_doc("view_img").src="",xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"))}function xows_doc_view_onclick(e){switch(e.target.id){case"view_optab":window.open(e.target.parentNode.querySelector("IMG").src,"_blank").focus();break;default:xows_doc_view_close()}}const Kt={peer:null,onclick:null};function xows_doc_prof_onclick(e){"prof_close"!=e.target.id?Kt.onclick&&Kt.onclick(Kt.peer,e.target):xows_doc_prof_close()}function xows_doc_prof_close(){const e=xows_doc("over_prof");e.hidden||(xows_doc_listener_rem(e,"click",xows_doc_prof_onclick),Kt.peer=null,Kt.onclick=null,xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"),e.hidden=!0)}function xows_doc_prof_update(){const e=Kt.peer,o=xows_doc("over_prof");o.querySelector("PEER-NAME").innerText=e.name,o.querySelector("PEER-ADDR").innerText=e.jbar?e.jbar:"",o.querySelector("BADG-SHOW").dataset.show=e.show||0,o.querySelector("PEER-AVAT").className=xows_tpl_spawn_avat_cls(e);const _=o.querySelector("PEER-META");let t;_.innerText=e.stat?e.stat:"",_.className=e.stat?"":"PLACEHOLD";const s=xows_doc("prof_subs"),n=xows_doc("prof_addc");if(e.type===c_){let o;switch(e.jbar&&(t=xows_cli_cont_get(e.jbar)),e.affi){case qo:o="Owner";break;case Eo:o="Administrator";break;case Ao:o="Member";break;default:o="Unaffiliated"}const _=xows_doc("prof_affi");let s;switch(_.innerText=xows_l10n_get(o),_.dataset.affi=e.affi,e.role){case bo:s="Moderator";break;case ho:s="Participant";break;default:s="Visitor"}const n=xows_doc("prof_role");n.innerText=xows_l10n_get(s),n.dataset.role=e.role,e.jbar&&(t=xows_cli_cont_get(e.jbar)),xows_doc_show("prof_occu")}else t=e,xows_doc_hide("prof_occu");if(e.self)xows_doc_hide("prof_cont");else{let o,_=0;if(t){switch(s.hidden=!1,n.hidden=!0,t.subs){case je:o="Mutual";break;default:o="Pending"}_=t.subs}else{const t=xows_gui_peer_subs_status(e);switch(s.hidden=t<1,n.hidden=t>0,t){case 1:o="Pending",_=1;break;case 2:o="Unavailable",_=-1}}s.innerText=xows_l10n_get(o),s.dataset.subs=_,xows_doc_show("prof_cont")}}function xows_doc_prof_open(e,o){const _=xows_doc("over_prof");Kt.peer=e,Kt.onclick=o;const t=xows_doc("scr_void");t.className="VOID-DARK",t.hidden=!1,xows_doc_listener_add(_,"click",xows_doc_prof_onclick),xows_doc_prof_update(),_.hidden=!1}function xows_doc_void_onclick(e){Wt.bttn&&xows_doc_menu_close(),xows_doc_view_close(),xows_doc_prof_close(),xows_doc_popu_modal(),xows_doc_ibox_modal(),xows_doc_mbox_modal()}const Xt=new Map;function xows_wrtc_gen_credential(e,o){const _=parseInt(Date.now()/1e3)+86400+":"+e;return{username:_,password:xows_bytes_to_b64(xows_hmac_sha1(_,o))}}function xows_wrtc_onerror(e,o){xows_log(1,"wrtc_onerror",o.message);const _=Xt.get(e);xows_isfunc(_.onerror)&&_.onerror(e,o,_.param)}function xows_wrtc_oncnxstate(e){const o=e.target;xows_log(2,"wrtc_oncnxstate","Connection state",o.connectionState);const _=Xt.get(o);xows_isfunc(_.onstate)&&_.onstate(o,o.connectionState,_.param)}function xows_wrtc_onneednego(e){const o=e.target;xows_log(2,"wrtc_onneednego","Create SDP offer"),o.createOffer().then(e=>o.setLocalDescription(e)).then(null,e=>xows_wrtc_onerror(o,e))}function xows_wrtc_onicestate(e){const o=e.target;xows_log(2,"wrtc_onicestate","ICE gathering state",o.iceGatheringState);const _=Xt.get(o);xows_isfunc(_.onstate)&&_.onstate(o,o.iceGatheringState,_.param),"complete"===o.iceGatheringState&&xows_isfunc(_.onsdesc)&&_.onsdesc(o,o.localDescription.sdp,_.param)}function xows_wrtc_ontrack(e){if(e.streams.length){const o=e.target;xows_log(2,"wrtc_ontrack","Remote stream available");const _=Xt.get(o);xows_isfunc(_.ontrack)&&_.ontrack(o,e.streams[0],_.param)}}function xows_wrtc_close(e){xows_log(2,"wrtc_close","Deleting RTC object"),e.close(),Xt.delete(e)}function xows_wrtc_new(e,o,_,t,s,n){const c=[];for(let o=0;o<e.length;++o){const _={urls:e[o].type+":"+e[o].host};if(e[o].secret){const t=xows_wrtc_gen_credential(r_.addr,e[o].secret);_.username=t.username,_.credential=t.password}else e[o].username&&(_.username=e[o].username),e[o].password&&(_.credential=e[o].password);c.push(_)}const i=new RTCPeerConnection({iceServers:c});return i.ontrack=xows_wrtc_ontrack,i.onnegotiationneeded=xows_wrtc_onneednego,i.onconnectionstatechange=xows_wrtc_oncnxstate,i.onicegatheringstatechange=xows_wrtc_onicestate,i.onicecandidateerror=(e=>xows_wrtc_onerror(i,e)),Xt.set(i,{onerror:s,onstate:t,onsdesc:o,ontrack:_,param:n}),i}function xows_wrtc_set_local_stream(e,o){const _=o.getTracks();for(let o=0;o<_.length;++o)e.addTrack(_[o]);xows_log(2,"wrtc_local_stream","Local stream added"),e.remoteDescription&&(xows_log(2,"wrtc_local_stream","Create SDP Answer"),e.createAnswer().then(o=>e.setLocalDescription(o)).then(null,o=>xows_wrtc_onerror(e,o)))}function xows_wrtc_set_remote_sdp(e,o){const _=e.localDescription?"answer":"offer",t=new RTCSessionDescription({type:_,sdp:o});xows_log(2,"wrtc_set_remote_sdp","Setting remote SDP",_),e.setRemoteDescription(t).then(null,o=>xows_wrtc_onerror(e,o))}function xows_wrtc_has_local(e){return null!==e.localDescription}function xows_wrtc_has_remote(e){return null!==e.remoteDescription}function xows_wrtc_connected(e){return"connected"===e.connectionState}function xows_wrtc_busy(e){return null!==e.localDescription}const $t=6e5,Qt=xows_load_task_bit();let Zt="en-US",es=null,os=null;const _s={ctx:null,vol:null},ts=new Map;function xows_gui_sound_error(e){const o=e.target;xows_log(1,"gui_sound_error","'"+o.title+"' sound load failed",o.src),ts.delete(o.title)}function xows_gui_sound_load(e,o,_){const t=new Audio;ts.set(e,t),t.title=e,t.loop=_;const s=Ns.root+"/sounds/"+o;xows_log(2,"gui_sound_load","loading '"+e+"' sound",s),t.onerror=xows_gui_sound_error,t.src=s}function xows_gui_sound_play(e){ts.has(e)&&ts.get(e).play()}function xows_gui_sound_stop(e){ts.has(e)&&ts.get(e).pause()}let ss=!0,ns=!0,cs=!1,is=null;function xows_gui_medias_poll(){navigator.mediaDevices&&(navigator.mediaDevices.enumerateDevices().then(xows_gui_ondevicesinfos),navigator.mediaDevices.ondevicechange=xows_gui_ondevicechange)}function xows_gui_ondevicesinfos(e){is=e,xows_log(2,"gui_ondevicesinfos","received medias infos"),os&&xows_gui_peer_chat_update(os)}function xows_gui_ondevicechange(e){navigator.mediaDevices.enumerateDevices().then(xows_gui_ondevicesinfos)}function xows_gui_medias_has(e){if(!is)return!1;for(let o=0;o<is.length;++o)if(is[o].kind===e)return!0;return!1}const rs="NULL";function xows_gui_peer_doc(e,o){return e===os?document.getElementById(o):xows_doc_frag_find(e.addr,o)}function xows_gui_peer_doc_cls_tog(e,o,_,t){return e===os?document.getElementById(o).classList.toggle(_,t):xows_doc_frag_find(e.addr,o).classList.toggle(_,t)}function xows_gui_peer_doc_cls_add(e,o,_){return e===os?document.getElementById(o).classList.add(_):xows_doc_frag_find(e.addr,o).classList.add(_)}function xows_gui_peer_doc_cls_rem(e,o,_){return e===os?document.getElementById(o).classList.remove(_):xows_doc_frag_find(e.addr,o).classList.remove(_)}function xows_gui_peer_doc_cls_has(e,o,_){return e===os?document.getElementById(o).classList.contains(_):xows_doc_frag_find(e.addr,o).classList.contains(_)}function xows_gui_peer_scroll_save(e){xows_doc_scrl_save(e===os?document.getElementById("chat_main"):Mt.get(e.addr))}function xows_gui_peer_scroll_get(e){return e===os?document.getElementById("chat_main").scrollBottom:Mt.get(e.addr).scrollBottom}function xows_gui_peer_scroll_down(e,o=!0){xows_gui_chat_nav_hide(e),e===os?xows_doc_scrl_down(document.getElementById("chat_main"),o):xows_doc_scrl_down(Mt.get(e.addr))}function xows_gui_peer_scroll_keep(e){xows_doc_scrl_keep(e===os?document.getElementById("chat_main"):Mt.get(e.addr))}function xows_gui_peer_frag_init(){xows_doc_frag_export(rs,"chat_fram",!0),xows_doc_frag_export(rs,"room_fram",!0),xows_doc_scrl_export(rs,"chat_main")}function xows_gui_peer_frag_new(e,o){o||(o=rs),It.has(o)?(xows_doc_scrl_copy(e,o),xows_doc_frag_clone(e,o,"chat_fram"),xows_doc_frag_clone(e,o,"room_fram")):xows_log(1,"gui_peer_frag_new","source fragment doesn't exist",e)}function xows_gui_peer_frag_export(e){It.has(e)?(xows_doc_scrl_export(e,"chat_main"),xows_doc_frag_export(e,"chat_fram"),xows_doc_frag_export(e,"room_fram")):xows_log(1,"gui_peer_frag_export","fragment doesn't exist",e)}function xows_gui_peer_frag_import(e){let o=!1;e||(e=rs,o=!0),It.has(e)?(xows_doc_frag_import(e,"chat_fram",o),xows_doc_frag_import(e,"room_fram",o),xows_doc_scrl_import(e,"chat_main")):xows_log(1,"gui_peer_frag_import","fragment doesn't exist",e)}function xows_gui_peer_frag_discard(e){xows_doc_frag_delete(e),xows_doc_scrl_delete(e)}function xows_gui_peer_doc_has(e){return It.has(e.addr)}function xows_gui_peer_doc_init(e){if(It.has(e.addr))return;xows_gui_peer_frag_new(e.addr),xows_gui_peer_doc(e,"hist_ul").dataset.closed=!0;const o=xows_l10n_get("Send a message to")+" "+e.name+" ...";xows_gui_peer_doc(e,"chat_inpt").setAttribute("placeholder",o),xows_gui_peer_chat_update(e),xows_gui_chat_noti_update(e)}function xows_gui_peer_doc_reset(e){It.has(e.addr)&&It.delete(e.addr),xows_gui_peer_doc_init(e)}const as=new ResizeObserver(xows_gui_chat_onresize);function xows_gui_peer_doc_export(e){xows_gui_peer_frag_export(e.addr)}function xows_gui_peer_doc_import(e){if(e){xows_gui_peer_frag_import(e.addr),xows_gui_peer_chat_update(e),as.observe(xows_doc("chat_main")),xows_doc_listener_add(xows_doc("chat_head"),"click",xows_gui_chat_head_onclick),xows_doc_listener_add(xows_doc("chat_main"),"scrollend",xows_gui_chat_onscroll),xows_doc_listener_add(xows_doc("chat_hist"),"click",xows_gui_chat_hist_onclick);const o=xows_doc("call_ring");o.hidden||xows_doc_listener_add(o,"click",xows_gui_call_ring_onclick);const _=xows_doc("hist_upld");_.hidden||xows_doc_listener_add(_,"click",xows_gui_hist_upld_onclick);const t=xows_doc("chat_panl");xows_doc_listener_add(t,"click",xows_gui_chat_panl_onclick),xows_doc_listener_add(t,"input",xows_gui_chat_inpt_oninput),xows_doc_listener_add(t,"paste",xows_gui_chat_inpt_onpaste,!1),xows_doc_listener_add(xows_doc("chat_file"),"change",xows_gui_chat_file_onchange),e.type===n_&&(xows_doc_listener_add(xows_doc("room_head"),"click",xows_gui_room_head_onclick),xows_doc_listener_add(xows_doc("occu_list"),"click",xows_gui_occu_list_onclick))}else xows_gui_peer_frag_import(null)}function xows_gui_peer_doc_reassign(e,o){e===os&&xows_gui_peer_frag_export(o),xows_gui_peer_frag_new(e.addr,o),xows_gui_peer_frag_discard(o),e===os&&xows_gui_peer_doc_import(e)}function xows_gui_peer_chat_update(e){xows_gui_peer_doc(e,"chat_titl").innerText=e.name;const o=xows_gui_peer_doc(e,"meta_inpt");if(e.type===n_)o.innerText=e.subj,o.className=e.subj?"":"PLACEHOLD",xows_gui_peer_doc(e,"chat_bt_bkmk").hidden=e.book||e.publ,xows_gui_peer_doc(e,"chat_bt_nick").hidden=!1,xows_gui_peer_doc(e,"chat_bt_subj").hidden=e.role<bo&&e.affi<Eo,xows_gui_peer_doc(e,"chat_bt_cnfg").hidden=e.affi<qo;else{o.innerText=e.stat,xows_gui_peer_doc(e,"chat_show").dataset.show=e.show;const _=xows_cli_external_has("stun","turn");xows_gui_peer_doc(e,"chat_bt_cala").hidden=!(xows_gui_medias_has("audioinput")&&_),xows_gui_peer_doc(e,"chat_bt_calv").hidden=!(xows_gui_medias_has("videoinput")&&_),e.type===c_&&(xows_gui_peer_doc(e,"chat_bt_addc").hidden=0!==xows_gui_peer_subs_status(e),xows_gui_peer_doc(e,"chat_addr").innerText="("+e.addr+")")}if(e.type===n_){xows_gui_peer_doc(e,"occu_bt_cnfg").hidden=e.affi<Eo}}function xows_gui_init(){xows_doc_listener_add(document,"keydown",xows_gui_wnd_onkey,!1),xows_doc_listener_add(document,"keyup",xows_gui_wnd_onkey),xows_doc_listener_add(document,"visibilitychange",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"pagehide",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"focus",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"blur",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"popstate",xows_gui_nav_onpopstate),xows_doc_listener_add(window,"resize",xows_gui_chat_onresize),xows_doc_listener_add(xows_doc("main_hndr"),"click",xows_gui_main_open),xows_doc_listener_add(xows_doc("main_hndl"),"click",xows_gui_main_open),xows_doc_listener_add(xows_doc("main_tabs"),"click",xows_gui_main_tabs_onclick),xows_doc_listener_add(xows_doc("rost_fram"),"click",xows_gui_rost_fram_onclick),xows_doc_listener_add(xows_doc("self_panl"),"click",xows_gui_self_panl_onclick),xows_gui_peer_frag_init(),ns=!0,xows_gui_medias_poll(),xows_gui_sound_load("notify","notify.ogg"),xows_gui_sound_load("disable","disable.ogg"),xows_gui_sound_load("enable","enable.ogg"),xows_gui_sound_load("mute","mute.ogg"),xows_gui_sound_load("unmute","unmute.ogg"),xows_gui_sound_load("ringtone","ringtone.ogg",!0),xows_gui_sound_load("ringbell","ringbell.ogg",!0),xows_gui_sound_load("hangup","hangup.ogg"),xows_load_task_set(Qt,xows_gui_mam_fetch_newer)}function xows_gui_reset(){xows_log(2,"gui_reset","reset DOM states"),xows_doc_hide("scr_page"),xows_doc_hide("scr_main"),xows_doc_page_close(),xows_doc_menu_close(),xows_doc_view_close(),xows_doc_popu_close(),xows_doc_ibox_close(),xows_doc_mbox_close(),xows_doc_prof_close(),xows_doc_cls_rem("main_wrap","COLR-WIDE"),xows_doc_cls_rem("main_wrap","COLL-WIDE"),xows_doc_cls_add("main_colr","COL-HIDE"),xows_doc("cont_pend").innerHTML="",xows_doc("cont_budy").innerHTML="",xows_doc("room_book").innerHTML="",xows_doc("room_publ").innerHTML="",xows_doc("room_priv").innerHTML="",xows_doc("priv_occu").innerHTML="",xows_doc("tab_priv").hidden=!0,xows_doc("tab_room").disabled=!0,xows_gui_rost_switch("tab_cont");const e=xows_doc("priv_noti");e.dataset.mesg=0,e.dataset.call=0,e.dataset.ring=0,e.innerText="";const o=xows_doc("room_noti");o.dataset.mesg=0,o.dataset.call=0,o.dataset.ring=0,o.innerText="";const _=xows_doc("cont_noti");_.dataset.mesg=0,_.dataset.call=0,_.dataset.ring=0,_.dataset.subs=0,_.innerText="",xows_doc("self_show").dataset.show=0,xows_doc("self_name").innerText="",xows_doc("self_meta").innerText="",xows_doc("self_avat").className="",xows_gui_switch_peer(null),xows_doc_cls_add("chat_inpt","PLACEHOLD"),xows_doc("chat_inpt").innerText="",xows_doc_frag_clear(),xows_doc_scrl_clear(),xows_gui_peer_frag_init(),ns=!0}function xows_gui_connect(e=!1){xows_cli_set_callback("connect",xows_gui_cli_onconnect),xows_cli_set_callback("selfpush",xows_gui_cli_onselfpush),xows_cli_set_callback("contpush",xows_gui_cli_oncontpush),xows_cli_set_callback("contrem",xows_gui_cli_oncontrem),xows_cli_set_callback("subspush",xows_gui_cli_onsubspush),xows_cli_set_callback("roompush",xows_gui_cli_onroompush),xows_cli_set_callback("roomrem",xows_gui_cli_onroomrem),xows_cli_set_callback("roomjoin",xows_gui_cli_onroomjoin),xows_cli_set_callback("roomexit",xows_gui_cli_onroomexit),xows_cli_set_callback("occupush",xows_gui_cli_onoccupush),xows_cli_set_callback("occurem",xows_gui_cli_onoccurem),xows_cli_set_callback("privpush",xows_gui_cli_onprivpush),xows_cli_set_callback("privrem",xows_gui_cli_onprivrem),xows_cli_set_callback("message",xows_gui_cli_onmessage),xows_cli_set_callback("chatstate",xows_gui_cli_onchatstate),xows_cli_set_callback("receipt",xows_gui_cli_onreceipt),xows_cli_set_callback("retract",xows_gui_cli_onretract),xows_cli_set_callback("subject",xows_gui_cli_onsubject),xows_cli_set_callback("calloffer",xows_gui_cli_oncalloffer),xows_cli_set_callback("callanwse",xows_gui_cli_oncallanwse),xows_cli_set_callback("callstate",xows_gui_cli_oncallstate),xows_cli_set_callback("calltermd",xows_gui_cli_oncalltermd),xows_cli_set_callback("callerror",xows_gui_cli_oncallerror),xows_cli_set_callback("error",xows_gui_cli_onerror),xows_cli_set_callback("close",xows_gui_cli_onclose),xows_cli_set_callback("timeout",xows_gui_cli_ontimeout),xows_doc_popu_close(),ns=!1,_s.ctx||(_s.ctx=new AudioContext,_s.vol=_s.ctx.createGain(),_s.vol.connect(_s.ctx.destination),_s.vol.gain.value=0),Ns.domain&&(es.user+="@"+Ns.domain),xows_cli_connect(Ns.url,es.user,es.pass,e)}function xows_gui_cli_onconnect(e){if(es){if(es.cred&&(xows_log(2,"gui_cli_onconnect","Saving credential"),window.PasswordCredential)){const e={id:es.user,password:es.pass},o=new PasswordCredential(e);navigator.credentials.store(o)}es=null}if(cs){xows_log(1,"gui_cli_onconnect","recover connection"),cs=!1;let e=a_.length;for(;e--;){const o=a_[e];xows_gui_peer_doc_cls_has(o,"chat_load","LOADING")||xows_gui_mam_fetch_newer(o)}for(e=l_.length;e--;){const o=l_[e];xows_gui_peer_doc_cls_has(o,"chat_load","LOADING")||xows_gui_mam_fetch_newer(o)}}else{xows_log(2,"gui_cli_onconnect","initial connection"),window.history.pushState({},"",window.location.pathname),xows_gui_switch_peer(null);const e=Qo.has(lo);xows_doc("edit_bt_upld").disabled=!e,e&&xows_tpl_embed_add_upld(Qo.get(lo)[0]);const o=Qo.has(xo);xows_doc("room_bt_upd").disabled=!o}xows_gui_main_open(),xows_gui_rost_widen()}function xows_gui_disconnect(){os&&xows_cli_chatstate_define(os,ce),xows_gui_call_clear(),xows_cli_disconnect()}function xows_gui_cli_ontimeout(){document.hidden||(xows_log(2,"gui_cli_ontimeout","connection timeout","disconnecting"),xows_gui_disconnect(),xows_gui_reset(),xows_gui_page_auth_open(),xows_doc_popu_open(t,"Connection lost"))}function xows_gui_cli_onclose(e,o){if(xows_log(2,"gui_cli_onclose","connexion closed","("+e+") "+o),e===s)return cs=!0,xows_doc_popu_close(),xows_doc_mbox_close(),xows_doc_ibox_close(),xows_doc_prof_close(),void xows_gui_page_wait_open("Connecting...");ns||(xows_gui_reset(),xows_gui_page_auth_open()),o&&xows_doc_popu_open(e,o)}function xows_gui_cli_onerror(e,o){xows_doc_popu_open(e,o)}function xows_gui_nav_onpopstate(e){xows_cli_connected()&&!xows_doc_popu_modal()&&(history.forward(),xows_gui_popu_exit_open())}function xows_gui_wnd_onfocus(e){switch(e.type){case"focus":case"blur":ss||xows_cli_activity_wakeup();break;case"visibilitychange":f_&&!document.hidden&&xows_cli_reconnect(10)}ss=document.hasFocus()}let ls=null;function xows_gui_notify_query_handle(e){for(const e in It){const o=xows_cli_peer_get(e,i_);o&&xows_gui_chat_noti_update(o)}"granted"===e&&ls&&(xows_gui_notify_push(ls.peer,ls.body),ls=null)}function xows_gui_notify_query(){"granted"!==Notification.permission&&Notification.requestPermission().then(xows_gui_notify_query_handle)}function xows_gui_notify_permi(e){return Notification.permission===e}function xows_gui_notify_push(e,o){if(e.noti)switch(xows_log(2,"gui_notify_push",e.name,Notification.permission),Notification.permission){case"denied":return;case"granted":{const _=xows_cach_avat_get(e.avat);new Notification(e.name,{body:o,icon:_||"/"+Ns.root+"/icon.svg"});xows_gui_sound_play("notify")}break;default:ls={peer:e,body:o},xows_gui_notify_query()}}let us=[];function xows_gui_title_push(e){us.push(document.title),document.title=e}function xows_gui_title_pop(){document.title=us.pop()}const ds=new Array(256);function xows_gui_wnd_onkey(e){if(xows_cli_activity_wakeup(),ds[e.keyCode]="keydown"===e.type,"keydown"===e.type&&(27===e.keyCode&&(xows_gui_mesg_edit_close(e.target),xows_gui_mesg_trsh_abort(e.target)),13===e.keyCode)){if(ds[16])return;switch(e.preventDefault(),e.target.tagName){case"CHAT-INPT":xows_gui_chat_inpt_enter(e.target);break;case"MESG-INPT":xows_gui_mesg_edit_valid(e.target)}}}function xows_gui_preload_done(e){xows_gui_peer_doc_cls_has(e,"chat_load","LOADING")&&(xows_gui_peer_scroll_down(e),xows_gui_peer_doc_cls_rem(e,"chat_load","LOADING")),xows_doc_cls_tog("main_colr","COL-HIDE",e.type!==n_)}function xows_gui_preload_peer(e){let o=0;if(xows_gui_peer_doc_cls_has(e,"chat_load","LOADING"))switch(xows_doc_cls_add("main_colr","COL-HIDE"),e.type){case s_:case n_:o|=Qt;break;case c_:xows_doc_cls_add("hist_beg","HIST-START")}xows_load_init(e,o,xows_gui_preload_done)}function xows_gui_switch_peer(e){const o=os;if(o){if(e===o.addr)return;xows_cli_chatstate_define(o,ce),xows_gui_upld_close()}const _=e?xows_cli_peer_get(e,i_):null;o&&(xows_gui_peer_doc_export(o),_&&_.type!==o.type||xows_gui_rost_unselect());const t=xows_doc("chat_fram");if(t.hidden=null===_,o&&xows_gui_title_pop(),_){xows_gui_medias_poll(),os=_,xows_gui_rost_peer_select(_,!0,!0),xows_gui_peer_doc_import(_);const e=_.type===n_;t.classList.toggle("CHAT-ROOM",e),t.classList.toggle("CHAT-CONT",!e),xows_gui_preload_peer(_),xows_gui_unread_reset(_),xows_gui_chat_inpt_focus(),xows_gui_title_push("@"+_.name+" - XOWS"),xows_log(2,"gui_switch_peer",'peer "'+_.addr+'"',"selected")}else os&&(xows_log(2,"gui_switch_peer","unselect peer"),os=null,xows_gui_peer_doc_import(null),xows_doc_cls_add("main_colr","COL-HIDE"))}function xows_gui_switch_room(e){const o=xows_cli_room_get(e);o&&o.join?xows_gui_switch_peer(o.addr):(xows_gui_switch_peer(null),xows_gui_panel_close(),o?xows_cli_muc_join_atempt(o):xows_cli_muc_join_atempt(null,e))}function xows_gui_panel_close(){xows_doc_cls_rem("main_wrap","COLR-WIDE"),xows_doc_cls_rem("main_wrap","COLL-WIDE")}function xows_gui_main_open(){xows_gui_panel_close(),xows_doc_show("scr_main"),xows_doc_menu_close(),xows_doc_view_close(),xows_doc_page_close(),xows_doc_hidden("chat_fram")&&xows_gui_title_push(xows_l10n_get("Home")+" - XOWS")}function xows_gui_popu_exit_onabort(){}function xows_gui_popu_exit_onvalid(){xows_cli_flyyoufools(),history.back()}function xows_gui_popu_exit_open(){xows_doc_popu_open(Gt,"Do you really want to disconnect current session ?",xows_gui_popu_exit_onvalid,"Yes",xows_gui_popu_exit_onabort,"No",!0)}function xows_gui_main_tabs_onclick(e){xows_cli_activity_wakeup(),xows_gui_rost_widen();const o=e.target.closest("ROST-TAB");o&&xows_gui_rost_switch(o.id)}function xows_gui_rost_tabs_toggle(e){let o;const _=xows_doc("rost_tabs").querySelectorAll("ROST-TAB");for(let t=0;t<_.length;++t){const s=_[t].id==e;xows_doc_cls_tog(_[t].id,"SELECTED",s);const n=xows_doc(_[t].dataset.page);n.hidden=!s,s&&(o=n)}return o}function xows_gui_rost_widen(){xows_cli_activity_wakeup(),window.matchMedia("(max-width: 799px)").matches&&(xows_doc_cls_has("main_wrap","COLL-WIDE")||(xows_doc_cls_rem("main_wrap","COLR-WIDE"),xows_doc_cls_add("main_wrap","COLL-WIDE")))}function xows_gui_rost_fram_onclick(e){if(xows_cli_activity_wakeup(),e.target.closest("HEAD-ACTS")){switch(e.target.id){case"cont_bt_add":xows_gui_ibox_subs_open();break;case"room_bt_add":xows_gui_ibox_join_open();break;case"room_bt_upd":xows_gui_room_list_reload()}return}const o=e.target.closest("LI-PEER");if(o){if("BUTTON"===e.target.tagName)switch(e.target.name){case"cont_bt_rtry":return void xows_gui_popu_subs_rqst(o.id);case"cont_bt_unsb":return void xows_gui_mbox_subs_revk_open(xows_cli_cont_get(o.id))}o.classList.contains("PEER-CONT")?xows_gui_switch_peer(o.id):o.classList.contains("PEER-ROOM")?xows_gui_switch_room(o.id):o.classList.contains("PEER-OCCU")?xows_gui_switch_peer(o.dataset.id):o.classList.contains("PEER-PEND")&&xows_gui_mbox_subs_auth_open(o.id),xows_gui_panel_close()}}function xows_gui_peer_subs_status(e){if(xows_cli_can_subscribe(e)){const o=xows_gui_rost_li_get(e.jbar);return o&&o.classList.contains("PEER-CONT")?1:0}return 2}function xows_gui_popu_subs_rqst(e){xows_cli_subs_request(e),xows_doc_popu_open(Ht,"New subscription authorization request was sent"),setTimeout(xows_gui_rost_switch,200,"tab_cont")}function xows_gui_ibox_subs_oninput(e){xows_doc_ibox_allow(e.length&&xows_isjid(e))}function xows_gui_ibox_subs_onvalid(e){xows_gui_popu_subs_rqst(e)}function xows_gui_ibox_subs_open(){xows_doc_ibox_open("Subscribes to contact","A subscription authorization request will be sent to the specified address, you'll have to wait for contact to allow to that request.","Enter contact XMPP address...",null,xows_gui_ibox_subs_onvalid,"Add",null,null,xows_gui_ibox_subs_oninput,!0)}const xs={peer:null};function xows_gui_mbox_subs_revk_onabort(){}function xows_gui_mbox_subs_revk_onvalid(){xows_cli_subs_revoke(xs.cont)}function xows_gui_mbox_subs_revk_open(e){xs.cont=e;let o="Do you really want to remove contact and ";e.subs?o+="revoke subscription authorization ?":o+="abort subscription authorization request ?",xows_doc_mbox_open(Gt,"Revoke contact subscription",o,xows_gui_mbox_subs_revk_onvalid,"OK",xows_gui_mbox_subs_revk_onabort,"Cancel")}const ws={cont:null};function xows_gui_mbox_subs_auth_onabort(){xows_cli_subs_answer(ws.cont,!1)}function xows_gui_mbox_subs_auth_onvalid(){xows_cli_subs_answer(ws.cont,!0)}function xows_gui_mbox_subs_auth_open(e){ws.cont=xows_cli_cont_get(e),xows_doc_mbox_open(Ut,"Contact subscription request","A new contact is requesting subscription authorization. Would you like to grant authorization and add this contact ?",xows_gui_mbox_subs_auth_onvalid,"Allow",xows_gui_mbox_subs_auth_onabort,"Deny")}function xows_gui_ibox_join_oninput(e){e.length?e.includes("@")?xows_doc_ibox_allow(xows_isjid(e)):xows_doc_ibox_allow(!0):xows_doc_ibox_allow(!1)}function xows_gui_ibox_join_onvalid(e){xows_gui_switch_room(e)}function xows_gui_ibox_join_open(){xows_doc_ibox_open("Join or create a Channel","If the specified Room does not exist and if server does not restrict rooms creation, a new Room will be created with you as owner.","Enter Channel name or address...",null,xows_gui_ibox_join_onvalid,"Join",null,null,xows_gui_ibox_join_oninput,!0)}function xows_gui_cli_onroomjoin(e,o,_){if(_){if("auth"==_.type){if("forbidden"==_.name)return void xows_gui_mbox_join_fail_open("auth","You cannot join this Channel because you are banned.");if("not-authorized"==_.name)return void xows_gui_ibox_join_pass_open(e);if("registration-required"==_.name)return void xows_gui_ibox_join_regi_open(e)}if("cancel"==_.type){if("not-allowed"==_.name)return void xows_gui_mbox_join_fail_open("create","The specified Channel does not exists and Channel creation is restricted.");if("conflict"==_.name)return void xows_gui_ibox_join_cflt_open(e);_.name}return"wait"==_.type&&_.name,void xows_gui_mbox_join_fail_open("","<"+_.name+"> "+_.text)}e.rcon?e.rcon=!1:(xows_gui_switch_peer(e.addr),xows_gui_panel_close()),xows_gui_peer_chat_update(e),e.init&&xows_gui_mbox_conf_open(e)}function xows_gui_cli_onroomexit(e,o){e===os&&xows_gui_switch_peer(null),xows_gui_peer_doc_reset(e);let _=null;o.code.includes(301)&&(_=xows_l10n_get("You were banned from the Channel")),o.code.includes(307)&&(_=xows_l10n_get("You were kicked from the Channel")),o.code.includes(321)&&(_=xows_l10n_get("Rules changes caused you to leave the Channel")),o.code.includes(321)&&(_=xows_l10n_get("Server error caused you to leave the Channel")),_&&(_+=" <b>"+e.name+"</b>",xows_doc_popu_open(n,_))}function xows_gui_mbox_join_fail_open(e,o){let _;switch(e){case"auth":_="Channel access";break;case"create":_="Channel creation";break;default:_="Channel join error"}xows_doc_mbox_open(Rt,_,o,null,null,null,null)}const ps={room:null};function xows_gui_ibox_join_regi_onresult(e,o,_){if("error"!=o)xows_doc_ibox_close(),xows_gui_switch_room(e.addr);else{if(_)switch(_.name){case"conflict":return xows_gui_ibox_join_regi_open(e),void xows_doc_ibox_error("Nickname is already reserved in this Room");case"not-allowed":case"registration-required":return void xows_gui_mbox_join_fail_open("auth","You cannot join this Channel because its access is restricted to members only.");case"forbidden":return void xows_gui_mbox_join_fail_open("auth","You cannot join this Channel because you are banned.")}xows_gui_mbox_join_fail_open("auth","Channel registration request failed.")}}function xows_gui_ibox_join_regi_onvalid(e){xows_cli_muc_regi_query(ps.room,e,xows_gui_ibox_join_regi_onresult)}function xows_gui_ibox_join_regi_open(e){ps.room=e,xows_doc_ibox_open(xows_l10n_get("Channel registration"),xows_l10n_get("The nickname will be associated with your XMPP address and being reserved for you in this Room."),xows_l10n_get("Enter nickname to register..."),e.nick,xows_gui_ibox_join_regi_onvalid,"Register",null,null,null,!0)}const ms={room:null};function xows_gui_ibox_join_pass_onvalid(e){const o=ms.room;o.pass=e,xows_cli_muc_join_retry(o)}function xows_gui_ibox_join_pass_open(e){ms.room=e,xows_doc_ibox_open(xows_l10n_get("Channel password"),xows_l10n_get("This Channel is password-protected, you must provide password in order to join it."),xows_l10n_get("Enter a password..."),e.pass,xows_gui_ibox_join_pass_onvalid,"Join",null,null,null,!0),e.pass&&xows_doc_ibox_error("The password you entered is incorrect")}const gs={room:null};function xows_gui_ibox_join_cflt_onvalid(e){const o=gs.room;o.nick=e,xows_cli_muc_join_retry(o)}function xows_gui_ibox_join_cflt_open(e){gs.room=e,xows_doc_ibox_open(xows_l10n_get("Nickname conflict"),xows_l10n_get("Your nickname conflicts with another Channel's occupant, please choose another nickname."),xows_l10n_get("Enter a nickname..."),e.nick,xows_gui_ibox_join_cflt_onvalid,"Join",null,null,null,!0)}function xows_gui_rost_li_get(e){return e.type===c_?xows_doc("rost_priv").querySelector("LI-PEER[data-id='"+e.addr+"']"):document.getElementById(e.addr)}function xows_gui_rost_switch(e){const o=xows_gui_rost_tabs_toggle(e);let _;o&&(_=o.querySelector(".SELECTED")),_&&_.classList.contains("PEER-OCCU")?xows_gui_switch_peer(_.dataset.id):xows_gui_switch_peer(_?_.id:null)}function xows_gui_rost_peer_select(e,o,_){const t=xows_gui_rost_li_get(e);t.classList.toggle("SELECTED",o),_&&xows_gui_rost_tabs_toggle(t.closest("ROW-PAGE").dataset.tab)}function xows_gui_rost_unselect(){const e=xows_doc("rost_fram").querySelectorAll("ROW-PAGE");for(let o=0;o<e.length;++o)if(!e[o].hidden){const _=e[o].querySelector(".SELECTED");_&&_.classList.remove("SELECTED");break}}function xows_gui_calling_set(e,o){const _=xows_gui_rost_li_get(e);if(_)switch(_.querySelector("badg-call").hidden=!o,e.type){case c_:xows_doc("priv_call").hidden=!o;break;case n_:xows_doc("room_call").hidden=!o;break;default:xows_doc("cont_call").hidden=!o}}function xows_gui_unread_tab_update(e,o,_,t){let s,n;switch(e.type){case n_:s=xows_doc("tab_room"),n=xows_doc("room_noti");break;case c_:s=xows_doc("tab_priv"),n=xows_doc("priv_noti");break;default:s=xows_doc("tab_cont"),n=xows_doc("cont_noti")}let c=parseInt(n.dataset.mesg);o&&(c+=o,n.dataset.mesg=c);let i=parseInt(n.dataset.call);_&&(i+=_,n.dataset.call=i);let r=parseInt(n.dataset.ring);t&&(r+=t,n.dataset.ring=r),s.classList.toggle("RINGING",r>0)}function xows_gui_unread_mesg(e,o){const _=xows_gui_rost_li_get(e);if(!_)return;const t=_.querySelector("BADG-NOTI");t.dataset.mesg=parseInt(t.dataset.mesg)+1,xows_gui_unread_tab_update(e,1,null,null)}function xows_gui_unread_call(e,o){const _=xows_gui_rost_li_get(e);if(!_)return;_.classList.toggle("RINGING",o);const t=_.querySelector("BADG-NOTI"),s=parseInt(t.dataset.ring)>0;t.dataset.ring=o?1:0,t.dataset.call=o?0:1,xows_gui_unread_tab_update(e,null,o?0:1,o?1:s?-1:0)}function xows_gui_unread_reset(e){const o=xows_gui_rost_li_get(e);if(!o)return;o.classList.remove("RINGING");const _=o.querySelector("BADG-NOTI"),t=-parseInt(_.dataset.mesg),s=-parseInt(_.dataset.ring),n=-parseInt(_.dataset.call);_.dataset.mesg=0,_.dataset.ring=0,_.dataset.call=0,xows_gui_unread_tab_update(e,t,n,s)}function xows_gui_cont_list_reload(){xows_gui_switch_peer(null),xows_doc("cont_pend").hidden=!0,xows_doc("cont_pend").innerText="",xows_doc("cont_budy").hidden=!0,xows_doc("cont_budy").innerText="",xows_doc_cls_add("cont_list","LOADING"),xows_cli_rost_get_query()}function xows_gui_cont_list_update(){xows_doc_cls_rem("cont_list","LOADING");const e=xows_doc("cont_pend"),o=e.querySelectorAll("LI-PEER");e.hidden=0==o.length,xows_doc("cont_noti").dataset.subs=o.length;const _=xows_doc("cont_budy");_.hidden=null===_.querySelector("LI-PEER")}function xows_gui_cli_oncontpush(e,o){if(!e)return void xows_doc_cls_rem("cont_list","LOADING");let _=xows_gui_rost_li_get(e);_&&("PEER-PEND"==_.className?e.subs!=Ce&&(xows_doc("cont_pend").removeChild(_),_=null):(xows_tpl_update_rost_cont(_,e,o),xows_gui_peer_chat_update(e),xows_gui_hist_update(e,e),e.show<1&&xows_gui_cli_onchatstate(e,0)));const t=e.subs&Te?xows_doc("cont_budy"):xows_doc("cont_pend");_||(_=xows_tpl_spawn_rost_cont(e,o),xows_gui_peer_doc_init(e)),_.parentNode!=t&&t.appendChild(_),xows_gui_cont_list_update()}function xows_gui_cli_oncontrem(e){const o=xows_gui_rost_li_get(e);if(o){os===e&&xows_gui_switch_peer(null),o.parentNode.removeChild(o)}xows_gui_cont_list_update(),xows_cli_cont_rem(e)}function xows_gui_cli_onsubspush(e){const o=xows_doc("cont_pend");let _=xows_gui_rost_li_get(e);_?xows_tpl_update_rost_subs(_,e):_=xows_tpl_spawn_rost_subs(e),_.parentNode!=o&&o.appendChild(_),xows_gui_cont_list_update()}function xows_gui_room_list_reload(){os&&os.publ&&xows_gui_switch_peer(null),xows_doc_cls_add("room_list","LOADING"),xows_doc("room_publ").innerHTML="",setTimeout(xows_cli_muc_roomlist_query,500)}function xows_gui_room_list_update(){const e=xows_doc("room_publ");e.hidden=null===e.querySelector("LI-PEER");const o=xows_doc("room_priv");o.hidden=null===o.querySelector("LI-PEER");const _=xows_doc("room_book");_.hidden=null===_.querySelector("LI-PEER")}function xows_gui_cli_onroompush(e){if(!e)return xows_doc_cls_rem("room_list","LOADING"),void xows_gui_room_list_update();const o=e.publ?xows_doc("room_publ"):e.book?xows_doc("room_book"):xows_doc("room_priv");let _=document.getElementById(e.addr);_?(xows_tpl_update_rost_room(_,e),xows_gui_peer_chat_update(e)):(_=xows_tpl_spawn_rost_room(e),xows_gui_peer_doc_init(e)),_.parentNode!=o&&o.appendChild(_),xows_gui_room_list_update()}function xows_gui_cli_onroomrem(e){const o=document.getElementById(e.addr);o&&(os&&os===e&&xows_gui_switch_peer(null),o.parentNode.removeChild(o)),xows_gui_room_list_update(),xows_cli_room_rem(e)}function xows_gui_priv_init(e){e.jbar&&xows_cli_cont_get(e.jbar)?xows_gui_switch_peer(e.jbar):(xows_cli_priv_add(e),xows_gui_cli_onprivpush(e),xows_gui_switch_peer(e.addr))}function xows_gui_cli_onprivpush(e,o){const _=xows_doc("priv_occu");if(o&&o.code.includes(303)){if(!o.prev)return void xows_log(1,"gui_cli_onprivpush","missing previous JID for nickname change");let t=_.querySelector("LI-PEER[data-id='"+o.prev+"']");t&&(t.dataset.id=e.addr),xows_gui_peer_doc_reassign(e,o.prev)}let t=_.querySelector("LI-PEER[data-id='"+e.addr+"']");if(t){if(xows_tpl_update_room_occu(t,e),xows_gui_peer_chat_update(e),xows_gui_hist_update(e,e),!(e.show!==be||o&&o.code.includes(303))){xows_gui_peer_doc(e,"hist_ul").appendChild(xows_tpl_mesg_null_spawn(0,"internal",e.name+" "+xows_l10n_get("joined the conversation")))}}else t=xows_tpl_spawn_room_occu(e,!0),xows_gui_peer_doc_init(e);t.parentNode!=_&&_.appendChild(t),xows_doc_show("tab_priv")}function xows_gui_cli_onprivrem(e){let o=xows_doc("priv_occu").querySelector("LI-PEER[data-id='"+e.addr+"']");if(o){xows_tpl_update_room_occu(o,e),xows_gui_peer_chat_update(e),xows_gui_peer_doc(e,"hist_ul").appendChild(xows_tpl_mesg_null_spawn(0,"internal",e.name+" "+xows_l10n_get("has left the conversation")))}}function xows_gui_cli_onselfpush(e){xows_doc("self_show").dataset.show=e.show,xows_doc("self_avat").className=xows_tpl_spawn_avat_cls(e),xows_doc("self_name").innerText=e.name;const o=xows_doc("self_meta");o.innerText=e.stat,o.className=e.stat?"":"PLACEHOLD";let _=a_.length;for(;_--;)xows_gui_hist_update(a_[_],e);for(_=l_.length;_--;)xows_gui_hist_update(l_[_],e)}function xows_gui_self_panl_onclick(e){xows_cli_activity_wakeup(),"self_bt_acct"===e.target.id&&xows_gui_page_acct_open(),e.target.closest("#self_bttn")&&xows_doc_menu_toggle(xows_doc("self_bttn"),"drop_self",xows_gui_self_bttn_onclick,xows_gui_self_bttn_onshow)}function xows_gui_self_bttn_onshow(e,o){const _=xows_tpl_spawn_avat_cls(r_);o.querySelector("PEER-AVAT").className=_,o.querySelector("PEER-NAME").innerText=r_.name,o.querySelector("PEER-ADDR").innerText=r_.addr;const t=o.querySelector("PEER-META");t.className=r_.stat?"":"PLACEHOLD",t.innerText=r_.stat}function xows_gui_self_bttn_onclick(e){xows_cli_activity_wakeup(),xows_doc_menu_toggle(xows_doc("self_bttn"),"drop_self"),"self_bt_edit"===e.target.id&&xows_gui_page_edit_open(),e.target.closest("#self_mi_stat")&&xows_gui_ibox_stat_open();const o=e.target.closest("LI");if(o){const e=parseInt(o.value);if(!(e>0))return void xows_gui_disconnect();xows_cli_show_select(e)}}function xows_gui_ibox_stat_onvalid(e){e!=r_.stat&&xows_cli_status_define(e)}function xows_gui_ibox_stat_oninput(e){}function xows_gui_ibox_stat_open(){xows_doc_ibox_open(xows_l10n_get("Edit status message"),xows_l10n_get("Indicate anything you want to mention about your current situation."),xows_l10n_get("Enter a status message..."),r_.stat,xows_gui_ibox_stat_onvalid,null,null,null,xows_gui_ibox_stat_oninput,!0)}function xows_gui_chat_noti_update(e){const o=xows_gui_peer_doc(e,"chat_bt_noti"),_=e.noti&&xows_gui_notify_permi("granted");o.title=xows_l10n_get(_?"Disable notifications":"Enable notifications"),o.classList.toggle("DISABLED",!_)}function xows_gui_cli_onsubject(e,o){const _=xows_gui_peer_doc(e,"meta_inpt");_.innerText=o||"",_.className=o?"":"PLACEHOLD"}function xows_gui_chat_head_onclick(e){switch(xows_cli_activity_wakeup(),e.target.id){case"chat_bt_subj":xows_gui_ibox_room_subj_open(os);break;case"chat_bt_nick":xows_gui_ibox_room_nick_open(os);break;case"chat_bt_bkmk":os&&xows_gui_popu_room_book_open(os);break;case"chat_bt_noti":os.noti=!e.target.classList.toggle("DISABLED"),xows_cach_peer_save(os.addr,null,null,null,os.noti),xows_gui_notify_permi("granted")?xows_gui_chat_noti_update(os):xows_gui_notify_query();break;case"chat_bt_cnfg":xows_cli_muc_getcfg_query(os,xows_gui_page_mucc_open);break;case"chat_bt_occu":window.matchMedia("(max-width: 799px)").matches?xows_doc_cls_add("main_wrap","COLR-WIDE"):xows_doc_cls_tog("main_colr","COL-HIDE");break;case"chat_bt_addc":xows_gui_popu_subs_rqst(os.jbar);break;case"chat_bt_calv":case"chat_bt_cala":xows_gui_call_invite(os,{audio:!0,video:"chat_bt_calv"===e.target.id})}}const fs={room:null};function xows_gui_ibox_room_subj_onvalid(e){const o=fs.room,_=e.trimEnd();_!=o.subj&&xows_cli_muc_set_subject(o,_)}function xows_gui_ibox_room_subj_open(e){e.type===n_&&(fs.room=e,xows_doc_ibox_open(xows_l10n_get("Set topic of")+" #"+e.name,"Set the message of the day, a welcome message or the discussion subject.","Enter a topic...",e.subj,xows_gui_ibox_room_subj_onvalid,null,null,null,null,!0))}const hs={room:null};function xows_gui_ibox_room_nick_onvalid(e){const o=hs.room,_=e.trimEnd();_!=xows_jid_resc(o.join)&&xows_cli_muc_set_nick(o,_)}function xows_gui_ibox_room_nick_open(e){e.type===n_&&(hs.room=e,xows_doc_ibox_open(xows_l10n_get("Nickname for")+" #"+e.name,"Specify your new nickname for this Channel.","Enter a nickname...",xows_jid_resc(e.join),xows_gui_ibox_room_nick_onvalid,null,null,null,null,!0))}let bs=null;function xows_gui_popu_room_book_onabort(){bs=null}function xows_gui_popu_room_book_onvalid(){xows_cli_book_publish(bs),bs=null}function xows_gui_popu_room_book_open(e){bs=e,xows_doc_popu_open(Ut,"Add Channel to bookmarks ?",xows_gui_popu_room_book_onvalid,"Add Bookmark",xows_gui_popu_room_book_onabort,"Cancel",!0)}function xows_gui_call_view_onclick(e){if(xows_cli_activity_wakeup(),"BUTTON"!==e.target.tagName)return;let o;switch(e.target.id){case"call_spkr":{const _=xows_doc("call_volu");o=e.target.classList.toggle("MUTTED"),_s.vol.gain.value=o?0:parseInt(_.value)/100,_.disabled=o,xows_gui_sound_play(o?"mute":"unmute")}break;case"call_came":o=e.target.classList.toggle("MUTTED"),xows_cli_call_self_mute(os,"video",o),xows_gui_sound_play(o?"disable":"enable");break;case"call_micr":o=e.target.classList.toggle("MUTTED"),xows_cli_call_self_mute(os,"audio",o),xows_gui_sound_play(o?"disable":"enable");break;case"call_hgup":xows_gui_call_hangup(os,"success");break;case"call_expd":{const e=xows_doc_cls_tog("chat_fram","CALL-FULL")?"Reduce":"Expand";xows_doc("call_expd").title=xows_l10n_get(e)}}}function xows_gui_call_view_oninput(e){const o=parseInt(e.target.value)/100;_s.vol.gain.value=o,xows_log(2,"gui_call_volu_oninput","volume",o);let _="";o>.66?_="RNG-MAX":o<.33&&(_="RNG-MIN"),xows_doc("call_spkr").className=_}function xows_gui_call_view_open(e){const o=xows_gui_peer_doc(e,"call_view");xows_gui_peer_doc(e,"call_expd").title=xows_l10n_get("Expand");const _=xows_gui_peer_doc(e,"call_spkr"),t=xows_gui_peer_doc(e,"call_volu");_.className="",t.disabled=!1,t.value=50,_s.vol.gain.value=parseInt(t.value)/100;const s=xows_gui_peer_doc(e,"call_came");xows_gui_peer_doc(e,"call_micr").className="",s.className="",s.hidden=!xows_cli_call_sess_meds(e).video,o.hidden&&e===os&&(xows_doc_listener_add(xows_doc("call_menu"),"click",xows_gui_call_view_onclick),xows_doc_listener_add(xows_doc("call_volu"),"input",xows_gui_call_view_oninput)),o.hidden=!1}function xows_gui_call_view_close(e){const o=xows_gui_peer_doc(e,"call_view");_s.vol.gain.value=0,e===os&&(xows_doc_listener_rem(xows_doc("call_menu"),"click",xows_gui_call_view_onclick),xows_doc_listener_rem(xows_doc("call_volu"),"input",xows_gui_call_view_oninput)),o.hidden=!0,xows_gui_peer_doc(e,"call_grid").innerHTML="",xows_doc("chat_fram").classList.remove("CALL-FULL")}function xows_gui_call_view_part_add(e,o,_){const t=xows_gui_peer_doc(e,"call_grid"),s=_.getVideoTracks().length;if(s&&o.self)return;let n,c=t.querySelector("div[data-peer='"+xows_cli_peer_iden(o)+"']");c?c.firstChild.srcObject=_:((n=s?(c=xows_tpl_spawn_stream_video(o)).querySelector("video"):(c=xows_tpl_spawn_stream_audio(o)).querySelector("audio")).muted=!0,n.srcNode=_s.ctx.createMediaStreamSource(_),s||(n.fftNode=_s.ctx.createAnalyser(),n.fftNode.fftSize=2048,n.fftBuff=new Float32Array(n.fftNode.frequencyBinCount),n.srcNode.connect(n.fftNode)),o.self||n.srcNode.connect(_s.vol),n.srcObject=_,n.autoplay=!0,o.self?t.insertBefore(c,t.firstChild):t.appendChild(c))}let ys=null;function xows_gui_call_view_vumet_run(e){ys||(ys=setInterval(xows_gui_call_view_vumet_anim,e))}function xows_gui_call_view_vumet_stop(){clearInterval(ys),ys=null}function xows_gui_call_view_vumet_anim(){if(xows_doc("call_view").hidden)return;const e=xows_doc("call_grid").querySelectorAll("audio");for(let o=0;o<e.length;++o){e[o].fftNode.getFloatTimeDomainData(e[o].fftBuff);let _,t=0;for(let s=0;s<e[o].fftBuff.length;s++)(_=Math.abs(e[o].fftBuff[s]))>t&&(t=_);const s=t>.08?"var(--link-base)":"var(--text-tone4)";e[o].parentNode.style.borderColor!==s&&(e[o].parentNode.style.borderColor=s)}}const Fs=0,vs=1,ks=2;function xows_gui_call_ring_onclick(e){const o=xows_gui_peer_doc(os,"call_ring");switch(e.target.id){case"ring_bt_clos":break;case"ring_bt_deny":o.classList.contains("CALL-INBD")?xows_gui_call_hangup(os,"decline"):xows_gui_call_onabort(os);break;case"ring_bt_pkup":return void xows_gui_call_accept(os);default:return}xows_gui_call_ring_close(os)}function xows_gui_call_ring_show(e,o,_){const t=xows_gui_peer_doc(e,"call_ring");let s,n,c,i=!1,r=!1;switch(o!==Fs&&(r=xows_cli_call_sess_inbd(e),i=xows_cli_call_sess_meds(e).video),o){case ks:r?(c=!0,s=i?"Incoming video call...":"Incoming audio call..."):(n=!0,s="Call in progress...");break;case vs:s="Establishing relay...";break;case Fs:switch(_){case"decline":s="The call has been declined";break;case"buzy":s="The other party is buzy";break;case"success":s=xows_cli_call_sess_cntd(e)?"The other party hung up":"You missed a call"}}t.classList.toggle("CALL-VISI",i),t.classList.toggle("CALL-RING",o===ks),t.classList.toggle("CALL-NEGO",o===vs),t.classList.toggle("CALL-TERM",o===Fs),t.classList.toggle("CALL-INBD",r),t.querySelector("RING-TEXT").innerText=xows_l10n_get(s),c?xows_gui_sound_play("ringbell"):xows_gui_sound_stop("ringbell"),n?xows_gui_sound_play("ringtone"):xows_gui_sound_stop("ringtone"),t.hidden&&(e===os&&xows_doc_listener_add(t,"click",xows_gui_call_ring_onclick),t.hidden=!1,xows_gui_chat_onappend(e,t,!1))}function xows_gui_call_ring_close(e){xows_gui_sound_stop("ringtone"),xows_gui_sound_stop("ringbell");const o=xows_gui_peer_doc(e,"call_ring");xows_doc_listener_rem(o,"click",xows_gui_call_ring_onclick),o.hidden=!0}const As={constr:null,onmedia:null,onabort:null,data:null};function xows_gui_media_ask(e,o,_,t){const s=As;s.constr=e,s.onmedia=o,s.onabort=_,s.data=t,navigator.mediaDevices.getUserMedia(s.constr).then(e=>s.onmedia(s.data,e),xows_gui_media_fail_open)}function xows_gui_media_fail_onvalid(){const e=As;navigator.mediaDevices.getUserMedia(e.constr).then(o=>e.onmedia(e.data,o),xows_gui_media_fail_open)}function xows_gui_media_fail_onabort(){const e=As;xows_isfunc(e.onabort)&&e.onabort(e.data)}function xows_gui_media_fail_open(){xows_log(1,"gui_media_fail_open","user media acquisition failed"),xows_doc_popu_open(n,"Unable to get device stream for media call session",xows_gui_media_fail_onvalid,"Retry",xows_gui_media_fail_onabort,"Cancel")}function xows_gui_call_clear(){let e=xows_cli_call_peer_list();for(let o=0;o<e.length;++o)xows_cli_call_hangup(e[o],"failed-application"),xows_gui_call_exit(e[o])}function xows_gui_call_exit(e){xows_gui_calling_set(e,!1),xows_gui_call_view_close(e),xows_cli_call_sess_count()||xows_gui_call_view_vumet_stop()}function xows_gui_call_hangup(e,o){xows_cli_call_hangup(e,o),xows_gui_call_exit(e),xows_gui_sound_play("hangup")}function xows_gui_call_accept(e,o){o||((o=xows_cli_call_sess_meds(e)).audio=o.audio&&xows_gui_medias_has("audioinput"),o.video=o.video&&xows_gui_medias_has("videoinput")),xows_gui_media_ask(o,xows_gui_call_accept_onstream,xows_gui_call_onabort,e)}function xows_gui_call_accept_onstream(e,o){xows_cli_call_accept(e,o),xows_gui_call_ring_show(e,vs,null);const _=xows_cli_call_sess_meds(e);_.audio=_.audio&&xows_gui_medias_has("audioinput"),_.video=_.video&&xows_gui_medias_has("videoinput"),xows_gui_call_view_part_add(e,r_,o)}function xows_gui_call_invite(e,o){xows_gui_media_ask(o,xows_gui_call_invite_onstream,xows_gui_call_onabort,e)}function xows_gui_call_invite_onstream(e,o){xows_cli_call_invite(e,o),xows_gui_call_ring_show(e,vs,null),xows_gui_call_view_part_add(e,r_,o)}function xows_gui_call_onabort(e){xows_gui_call_ring_close(e),xows_gui_call_hangup(e,null)}function xows_gui_cli_oncalloffer(e,o){xows_gui_call_view_vumet_run(50),xows_gui_call_view_part_add(e,e,o),e!==os&&xows_gui_unread_call(e,!0),xows_gui_call_ring_show(e,ks,null)}function xows_gui_cli_oncallanwse(e,o){xows_gui_call_view_vumet_run(50),xows_gui_call_view_part_add(e,e,o)}function xows_gui_cli_oncallstate(e,o){"ringing"===o&&xows_gui_call_ring_show(e,ks,null),"gathering"===o&&xows_gui_call_ring_show(e,vs,null),"connected"===o&&(xows_gui_call_ring_close(e),xows_gui_calling_set(e,!0),xows_gui_call_view_open(e))}function xows_gui_cli_oncalltermd(e,o){xows_gui_call_ring_show(e,Fs,o),xows_gui_call_exit(e),xows_gui_sound_play("hangup")}function xows_gui_cli_oncallerror(e,o){const _=xows_l10n_get("Call session error")+": ";xows_doc_popu_open(t,_+o.message),xows_gui_call_hangup(e,"failed-application")}function xows_gui_chat_onresize(e,o){os&&xows_doc_scrl_keep(document.getElementById("chat_main"))}function xows_gui_chat_onscroll(e){if(!os)return;if(xows_doc_scrl_edited())return;const o=xows_doc("chat_main");xows_gui_peer_scroll_save(os),o.scrollTop<.8*xows_doc("hist_beg").offsetHeight&&xows_gui_mam_fetch_older(os),xows_gui_chat_nav_update(os,o.scrollBottom,o.clientHeight)}function xows_gui_chat_hist_onclick(e){if(xows_cli_activity_wakeup(),"IMG"===e.target.tagName)return void xows_doc_view_open(e.target);const o=e.target.closest("MESG-RPLY");if(o)return void xows_gui_hist_mesg_focus(os,o.dataset.id);const _=e.target.closest("LI-MESG");if(_){if(e.type.startsWith("touch")){const e=xows_doc("hist_ul").querySelector("LI-MESG.SELECTED");e&&e.classList.remove("SELECTED"),_&&_.classList.add("SELECTED")}if("BUTTON"===e.target.tagName&&e.target.name)switch(e.target.name){case"mesg_bt_edit":xows_gui_mesg_edit_open(_);break;case"edit_bt_abort":xows_gui_mesg_edit_close(_);break;case"edit_bt_valid":xows_gui_mesg_edit_valid(_.querySelector("MESG-INPT"));break;case"mesg_bt_trsh":xows_gui_mesg_trsh_open(_);break;case"trsh_bt_abort":xows_gui_mesg_trsh_abort(_);break;case"trsh_bt_valid":xows_gui_mesg_trsh_valid(_);break;case"mesg_bt_rply":xows_gui_chat_rply_set(_)}else;}}function xows_gui_chat_onappend(e,o,_){let t=!1;xows_gui_peer_scroll_get(e)>50&&("LI-MESG"===o.tagName&&(_?t=!0:xows_gui_chat_nav_show(e,"UNREAD")),"call_ring"===o.id&&xows_gui_chat_nav_show(e,"RINGING"),"hist_upld"===o.id&&(t=!0)),t?xows_gui_peer_scroll_down(e,!1):xows_gui_peer_scroll_keep(e)}function xows_gui_mesg_edit_close(e){e&&"LI-MESG"==e.tagName||(e=xows_doc("chat_hist").querySelector(".MESG-EDITOR")),e&&xows_tpl_mesg_edit_remove(e)}function xows_gui_mesg_edit_open(e){xows_gui_mesg_edit_close();const o=xows_tpl_mesg_edit_insert(e).querySelector("MESG-INPT");xows_doc_caret_at(o),o.focus()}function xows_gui_mesg_edit_valid(e){const o=e.closest("LI-MESG"),_=e.innerText.trimEnd();if(_!==o.querySelector("MESG-BODY").dataset.raw){const e=o.querySelector("MESG-RPLY");xows_cli_send_message(os,_,o.dataset.id,e.dataset.id,e.dataset.to)}xows_tpl_mesg_edit_remove(o)}function xows_gui_mesg_trsh_abort(e){e&&"LI-MESG"==e.tagName||(e=xows_doc("chat_hist").querySelector(".MESG-TRASH")),e&&xows_tpl_mesg_trsh_remove(e)}function xows_gui_mesg_trsh_open(e){xows_gui_mesg_trsh_abort(),xows_tpl_mesg_trsh_insert(e)}function xows_gui_mesg_trsh_valid(e){const o=xows_tpl_mesg_bestref(os,e);o&&xows_cli_retract_send(os,o)}function xows_gui_hist_update(e,o){const _=xows_gui_peer_doc(e,"hist_ul");if(!_||!_.childNodes.length)return;const t=xows_cli_peer_iden(o);let s;const n=_.querySelectorAll("MESG-FROM[data-peer='"+t+"'],RPLY-FROM[data-peer='"+t+"']");for(s=n.length;s--;)o.name!=n[s].innerText&&(n[s].innerText=o.name);if(!o.avat)return;const c=xows_tpl_spawn_avat_cls(o),i=_.querySelectorAll("MESG-AVAT[data-peer='"+t+"'],RPLY-AVAT[data-peer='"+t+"']");for(s=i.length;s--;)c!=i[s].className&&(i[s].className=c)}function xows_gui_hist_mesg_get(e,o){let _,t=(_=e===os?document.getElementById("hist_ul"):xows_doc_frag_element_find(e.addr,"chat_fram","hist_ul")).querySelector("LI-MESG[data-id='"+o+"']");return t||(t=e.type===n_?_.querySelector("LI-MESG[data-szid='"+o+"']"):_.querySelector("LI-MESG[data-orid='"+o+"']")),t}function xows_gui_hist_rply_get(e,o,_){let t=xows_gui_hist_mesg_get(e,o);return t||(t=xows_tpl_mesg_null_spawn(o,_,xows_l10n_get("The message is unreachable"))),t}function xows_gui_hist_mesg_replace(e,o,_){o.hidden=!0,o.innerHTML="";const t=xows_gui_peer_doc(e,"hist_ul"),s=xows_tpl_mesg_bestref(e,o),n=t.querySelectorAll("MESG-RPLY[data-id='"+s+"']");for(let o=0;o<n.length;++o)xows_tpl_mesg_update(n[o].closest("LI-MESG"),e,null,null,_);const c=xows_gui_peer_doc(e,"chat_rply");return c.dataset.id===s&&(c.dataset.id=xows_tpl_mesg_bestref(e,_)),t.insertBefore(_,o.nextSibling)}function xows_gui_hist_mesg_retract(e,o){const _=xows_gui_hist_mesg_get(e,o);if(!_)return void xows_log(1,"gui_hist_mesg_retract","retracted message not found",o);_.hidden=!0,_.innerHTML="";const t=xows_gui_peer_doc(e,"hist_ul").querySelectorAll("MESG-RPLY[data-id='"+o+"']");if(t.length){const _=xows_tpl_mesg_null_spawn(o,"",xows_l10n_get("The message was deleted"));for(let o=0;o<t.length;++o)xows_tpl_mesg_update(t[o].closest("LI-MESG"),e,null,null,_)}const s=_.nextSibling;s&&s.dataset.from===_.dataset.from&&s.classList.toggle("MESG-APPEND",_.classList.contains("MESG-APPEND"))}function xows_gui_hist_mesg_focus(e,o){const _=xows_gui_peer_doc(e,"hist_ul").querySelector(".FOCUS");if(_&&_.classList.remove("FOCUS"),!o)return;const t=xows_gui_hist_mesg_get(e,o);t&&(t.classList.add("FOCUS"),e===os&&t.offsetTop-xows_doc("chat_main").scrollTop<0&&t.scrollIntoView({behavior:"smooth",block:"center"}))}function xows_gui_hist_incoming_notify(e,o){if(!e.self){if(e.type===n_){if(!o.rpto)return;if(xows_cli_occu_self(e).addr!==o.rpto)return}e!==os&&xows_gui_unread_mesg(e,o.id),ss||xows_gui_notify_push(e,o.body)}}function xows_gui_cli_onmessage(e,o,_,t,s){if(s){const _=xows_gui_hist_mesg_get(e,o.id);return _&&_.classList.add("MESG-FAIL"),void xows_log(1,"gui_cli_onmessage","message error",s.name)}if(e.type===n_){const _=xows_gui_hist_mesg_get(e,o.orid?o.orid:o.id);if(_)return void xows_tpl_mesg_update(_,e,o,!0)}let n,c;if(o.repl&&!(n=xows_gui_hist_mesg_get(e,o.repl)))return;o.rpid&&(c=xows_gui_hist_rply_get(e,o.rpid,o.rpto));const i=xows_gui_peer_doc(e,"hist_ul");let r=i.lastChild;for(;r&&r.hidden;)r=r.previousSibling;const a=xows_tpl_mesg_spawn(e,o,_,r,n,c);n?xows_gui_hist_mesg_replace(e,n,a):i.appendChild(a),o.repl||xows_gui_hist_incoming_notify(e,o),xows_gui_chat_onappend(e,a,t)}function xows_gui_cli_onreceipt(e,o){const _=xows_gui_hist_mesg_get(e,o);_?_.classList.add("MESG-RECP"):xows_log(1,"gui_cli_onreceipt","message not found",o)}function xows_gui_cli_onretract(e,o){xows_gui_hist_mesg_retract(e,o)}const Es=new Map;function xows_gui_mam_query(e,o,_){if(Es.has(e))return;const t=xows_gui_peer_doc(e,"hist_ul");let s,n;if(_)t.childNodes.length&&(s=parseInt(t.lastChild.dataset.time)+25);else{if(xows_gui_peer_doc(e,"hist_beg").className.length)return;t.childNodes.length&&(n=parseInt(t.firstChild.dataset.time)-25)}Es.set(e,setTimeout(xows_cli_mam_fetch,o,e,Ns.history_count,s,n,xows_gui_mam_parse))}function xows_gui_mam_fetch_newer(e){xows_gui_mam_query(e,0,!0)}function xows_gui_mam_fetch_older(e){xows_gui_mam_query(e,Ns.history_delay,!1)}function xows_gui_mam_parse(e,o,_,t){const s=xows_gui_peer_doc(e,"hist_ul");let n=null,c=!0;o.length&&s.childNodes.length&&(s.firstChild.dataset.time>=o[o.length-1].time?n=s.firstChild:c=!1);const i=xows_gui_peer_doc(e,"hist_beg");i.className="";let r,a,l,u=0;const d=o.length;for(let _=0;_<d;++_){const t=o[_];if(t.retr){xows_gui_hist_mesg_retract(e,t.retr);continue}if(!t.body)continue;if(xows_gui_hist_mesg_get(e,t.id))continue;if(t.repl){if(!(r=xows_gui_hist_mesg_get(e,t.repl)))continue}else r=null;for(a=t.rpid?xows_gui_hist_rply_get(e,t.rpid,t.rpto):null;l&&l.hidden;)l=l.previousSibling;const c=xows_tpl_mesg_spawn(e,t,!1,l,r,a);r?xows_gui_hist_mesg_replace(e,r,c):l=s.insertBefore(c,n),u++}xows_log(2,"gui_mam_parse",u+" added messages for",e.addr),c&&t&&(i.className="HIST-START"),xows_gui_peer_scroll_keep(e),Es.delete(e),xows_load_task_done(e,Qt)}function xows_gui_upld_progress(e,o){xows_doc("upld_pbar").style.width=o+"%"}function xows_gui_upld_error(e,o){xows_doc_cls_add("upld_text","STYL-ERR"),xows_doc("upld_text").innerHTML="<b>"+xows_l10n_get("Error")+"</b> : "+o}function xows_gui_upld_load(e,o){xows_cli_send_message(os,o),xows_doc_hide("hist_upld")}function xows_gui_upld_abort(e){xows_gui_upld_close()}function xows_gui_upld_close(){xows_doc_listener_rem(xows_doc("hist_upld"),"click",xows_gui_hist_upld_onclick),xows_doc_hide("hist_upld")}function xows_gui_upld_open(e){const o=xows_doc("upld_text");o.classList="",xows_doc("upld_pbar").style.width="0%",o.innerText=e.name,xows_cli_upld_query(e,xows_gui_upld_error,xows_gui_upld_load,xows_gui_upld_progress,xows_gui_upld_abort),xows_doc_listener_add(xows_doc("hist_upld"),"click",xows_gui_hist_upld_onclick),xows_doc_show("hist_upld")}function xows_gui_chat_file_onchange(e){const o=xows_doc("chat_file").files[0];os.addr&&o&&xows_gui_upld_open(o)}function xows_gui_hist_upld_onclick(e){"upld_exit"===e.target.id&&xows_gui_upld_close()}function xows_gui_chat_panl_onclick(e){if(xows_cli_activity_wakeup(),e.target.closest("CHAT-INPT")){const e=xows_doc_sel_rng(0);if(e.collapsed){const o=e.endContainer;"EMO-JI"===o.parentNode.tagName&&xows_doc_caret_around(o.parentNode,!e.endOffset)}qs=e}else switch(e.target.id){case"chat_nav":return void xows_gui_peer_scroll_down(os,!0);case"rply_clos":xows_gui_chat_rply_close();break;case"edit_bt_upld":{const e=xows_doc("chat_file");e.value="",e.click();break}case"edit_bt_emoj":xows_doc_menu_toggle(xows_doc("edit_bt_emoj"),"drop_emoj",xows_gui_drop_emoj_onclick);break;default:xows_gui_chat_inpt_focus()}}function xows_gui_chat_nav_show(e,o=null){const _=xows_gui_peer_doc(e,"chat_nav");_.className=o,_.hidden=!1}function xows_gui_chat_nav_hide(e){xows_gui_peer_doc(e,"chat_nav").hidden=!0}function xows_gui_chat_nav_update(e,o,_){const t=xows_gui_peer_doc(e,"chat_nav");o>=50?t.classList.contains("RINGING")?xows_gui_chat_nav_show(e,"RINGING"):o>_&&xows_gui_chat_nav_show(e,"NEUTRAL"):xows_gui_chat_nav_hide(e)}function xows_gui_chat_rply_close(){if(!xows_doc_cls_has("chat_panl","REPLY"))return;xows_doc_cls_rem("chat_panl","REPLY");const e=xows_doc("chat_rply");xows_doc("rply_name").innerText="",e.dataset.id="",e.dataset.to="",xows_gui_hist_mesg_focus(os,null)}function xows_gui_chat_rply_set(e){xows_gui_chat_rply_close();const o=xows_doc("chat_rply"),_=xows_tpl_mesg_bestref(os,e);let t,s;t=os.type===s_?xows_jid_bare(e.dataset.from):e.dataset.from,s=os.type===n_?xows_cli_occu_get_or_new(os,t,e.dataset.ocid):os,xows_doc("rply_name").innerText=s.name,o.dataset.to=t,o.dataset.id=_,o.hidden=!1,xows_doc_cls_add("chat_panl","REPLY"),xows_gui_hist_mesg_focus(os,_),xows_gui_chat_inpt_focus()}function xows_gui_chat_inpt_focus(){const e=xows_doc("chat_inpt");e.focus();const o=xows_doc_sel_rng(0);o.endContainer!==e&&xows_doc_caret_around(o.endContainer)}function xows_gui_chat_inpt_enter(e){if(os){if(e.innerText.length){const o=xows_doc("chat_rply");xows_cli_send_message(os,e.innerText.trimEnd(),null,o.dataset.id,o.dataset.to),e.innerText="",xows_gui_chat_rply_close(),e.className="PLACEHOLD"}xows_cli_chatstate_define(os,ie)}}function xows_gui_chat_inpt_onpaste(e){xows_cli_activity_wakeup();let o=e.clipboardData.getData("text");o.length&&(e.preventDefault(),os&&xows_cli_chatstate_define(os,le),xows_doc("chat_inpt").className="",Pt.deleteFromDocument(),Pt.getRangeAt(0).insertNode(document.createTextNode(o)),Pt.collapseToEnd(),qs=xows_doc_sel_rng(0))}let qs=null;function xows_gui_chat_inpt_oninput(e){xows_cli_activity_wakeup(),os&&xows_cli_chatstate_define(os,le),qs=xows_doc_sel_rng(0);const o=document.getElementById("chat_inpt");if(o.innerText.length<2&&0===o.innerText.trim().length)return o.className="PLACEHOLD",void(o.innerText="");o.className=""}function xows_gui_chat_inpt_insert(e,o){const _=document.getElementById("chat_inpt");qs||(xows_doc_caret_at(_,!0),qs=xows_doc_sel_rng(0));const t=qs;let s;t&&!t.collapsed&&t.deleteContents(),o?(s=document.createElement(o)).appendChild(document.createTextNode(e)):s=document.createTextNode(e),t.insertNode(s),_.className="",_.focus(),xows_doc_caret_around(s),qs=xows_doc_sel_rng(0)}function xows_gui_drop_emoj_onclick(e){xows_cli_activity_wakeup();const o=e.target.closest("LI");o&&xows_gui_chat_inpt_insert(o.childNodes[0].nodeValue,"EMO-JI"),xows_doc_menu_close()}function xows_gui_cli_onchatstate(e,o){const _=xows_gui_peer_doc(e,"chat_stat");if(_){if(e.type===n_){const o=e.writ.length;if(o<1)return _.innerText="",void(_.hidden=!0);if(o>1){let t="";const s=o>2?2:o-1;for(let o=0;o<s;++o)t+="<b>"+e.writ[o].name+"</b>",o<s-1&&(t+=", ");t+=" "+xows_l10n_get("and")+" <b>";const n=o-s;t+=n>1?n+" "+xows_l10n_get("other(s)")+"</b> ":e.writ[o-1].name+"</b> ",_.innerHTML=t+xows_l10n_get("are currently writing")}else _.innerHTML="<b>"+e.writ[0].name+"</b> "+xows_l10n_get("is currently writing")}else{if(e.chat<le)return _.innerText="",void(_.hidden=!0);_.innerHTML="<b>"+e.name+"</b> "+xows_l10n_get("is currently writing")}_.hidden=!1}}function xows_gui_room_head_onclick(e){xows_cli_activity_wakeup(),os.type==n_&&"occu_bt_cnfg"==e.target.id&&xows_gui_page_muca_open(os)}function xows_gui_occu_li_get(e){return e.room===os?document.getElementById(e.addr):xows_doc_frag_element_find(e.room.addr,"room_fram",e.addr)}function xows_gui_occu_list_update(e){const o=xows_gui_peer_doc(e,"ownr_ul");o.hidden=null===o.querySelector("LI-PEER");const _=xows_gui_peer_doc(e,"admn_ul");_.hidden=null===_.querySelector("LI-PEER");const t=xows_gui_peer_doc(e,"modo_ul");t.hidden=null===t.querySelector("LI-PEER");const s=xows_gui_peer_doc(e,"part_ul");s.hidden=null===s.querySelector("LI-PEER");const n=xows_gui_peer_doc(e,"vist_ul");n.hidden=null===n.querySelector("LI-PEER")}function xows_gui_cli_onoccupush(e,o){const _=e.room;if(xows_log(2,"gui_cli_onoccupush","push occupant","room="+e.room.addr),o){if(o.code.includes(303)){if(!o.prev)return void xows_log(1,"gui_cli_onoccupush","missing previous JID for nickname change");let t;(t=_===os?document.getElementById(o.prev):xows_doc_frag_element_find(_.addr,"room_fram",o.prev))&&(t.id=e.addr)}o.code.includes(110)&&xows_gui_peer_chat_update(_)}let t="vist_ul";if(e.affi>Ao)t=e.affi>Eo?"ownr_ul":"admn_ul";else switch(e.role){case bo:t="modo_ul";break;case ho:t="part_ul"}let s=xows_gui_occu_li_get(e);if(s?xows_tpl_update_room_occu(s,e):s=xows_tpl_spawn_room_occu(e),xows_gui_peer_doc(_,t).appendChild(s),xows_gui_occu_list_update(_),xows_gui_hist_update(_,e),e.self){let o=u_.length;for(;o--;)u_[o].room===_&&xows_gui_hist_update(u_[o],e)}}function xows_gui_cli_onoccurem(e){if(e.self)e.room===os&&xows_gui_switch_peer(null);else{const o=xows_gui_occu_li_get(e);if(o){const e=o.parentNode;e.removeChild(o),e.hidden=!e.childElementCount}}xows_cli_occu_rem(e)}function xows_gui_occu_list_onclick(e){xows_cli_activity_wakeup();const o=e.target.closest("LI-PEER");o&&"occu_bt_menu"===e.target.name&&(o.classList.add("SELECTED"),xows_doc_menu_toggle(e.target,"drop_occu",xows_gui_occu_drop_onclick,xows_gui_occu_drop_onshow,xows_gui_occu_drop_onclose))}function xows_gui_occu_drop_onclose(){xows_doc("occu_list").querySelector(".SELECTED").classList.remove("SELECTED")}function xows_gui_occu_drop_onshow(e,o){const _=e.getBoundingClientRect();o.style.left=_.left-o.offsetWidth+"px";const t=_.top+.5*_.height;let s=t+o.offsetHeight-window.screen.height;s<0&&(s=0),o.style.top=t-s+"px";const n=xows_cli_occu_get(os,e.closest("LI-PEER").id),c=os.affi===qo,i=!n.self&&os.affi>Ao,r=!n.self&&(i||os.role>ho),a=c||n.affi<Eo&&os.affi>=n.affi,l=xows_doc("occu_mi_priv"),u=xows_doc("occu_sm_affi"),d=xows_doc("occu_sm_role"),x=xows_doc("occu_mi_kick"),w=xows_doc("occu_mi_outc");if(xows_doc_cls_rem("occu_mi_info","menu-separ"),xows_doc_cls_rem("occu_mi_priv","menu-separ"),l.hidden=n.self,!i&&!r||!a)return u.hidden=!0,d.hidden=!0,x.hidden=!0,void(w.hidden=!0);if(xows_doc_cls_add(n.self?"occu_mi_info":"occu_mi_priv","menu-separ"),u.hidden=!i,d.hidden=!r,x.hidden=!r,w.hidden=!i,i){const e=xows_doc("occu_mi_ownr"),o=xows_doc("occu_mi_admn"),_=xows_doc("occu_mi_memb"),t=xows_doc("occu_mi_none");e.querySelector("MENU-RADIO").dataset.on=n.affi===qo,o.querySelector("MENU-RADIO").dataset.on=n.affi===Eo,_.querySelector("MENU-RADIO").dataset.on=n.affi===Ao,t.querySelector("MENU-RADIO").dataset.on=n.affi===ko,e.classList.toggle("MENU-GRAYD",!c),o.classList.toggle("MENU-GRAYD",!c)}if(r){const e=xows_doc("occu_mi_modo"),o=xows_doc("occu_mi_part"),_=xows_doc("occu_mi_vist");e.querySelector("MENU-RADIO").dataset.on=n.role===bo,o.querySelector("MENU-RADIO").dataset.on=n.role===ho,_.querySelector("MENU-RADIO").dataset.on=n.role===fo;const t=os.role>n.role||os.affi>n.affi;e.classList.toggle("MENU-GRAYD",!i),o.classList.toggle("MENU-GRAYD",!t),_.classList.toggle("MENU-GRAYD",!t)}}function xows_gui_occu_drop_onclick(e){xows_cli_activity_wakeup();const o=xows_doc("occu_list").querySelector(".SELECTED");xows_doc_menu_close();const _=e.target.closest("LI");if(!_)return;const t=xows_cli_occu_get(os,o.id);let s=null,n=null;switch(_.id){case"occu_mi_info":return void xows_gui_prof_open(t);case"occu_mi_priv":return void xows_gui_priv_init(t);case"occu_mi_ownr":s=qo;break;case"occu_mi_admn":s=Eo;break;case"occu_mi_memb":s=Ao;break;case"occu_mi_none":s=ko;break;case"occu_mi_modo":n=bo;break;case"occu_mi_part":n=ho;break;case"occu_mi_vist":n=fo;break;case"occu_mi_kick":n=go;break;case"occu_mi_outc":s=vo}null!=s&&s!=t.affi&&(s>Ao&&s>t.affi||s===vo?xows_gui_mbox_affi_open(t,s):xows_cli_muc_set_affi(t,s)),null!=n&&n!=t.role&&(n===go?xows_gui_mbox_role_open(t,n):xows_cli_muc_set_role(t,n))}const Ss={occu:null,affi:null};function xows_gui_mbox_affi_onabort(){}function xows_gui_mbox_affi_onvalid(){const e=Ss;xows_cli_muc_set_affi(e.occu,e.affi)}function xows_gui_mbox_affi_open(e,o){const _=Ss;let t,s;if(_.occu=e,_.affi=o,o>vo){switch(t="Change occupant affiliation",s=xows_l10n_get("Grant Channel affiliation")+" <b>",o){case qo:s+=xows_l10n_get("Owner");break;case Eo:s+=xows_l10n_get("Administrator");break;case Ao:s+=xows_l10n_get("Member");break;case ko:s+=xows_l10n_get("None")}s+="</b> "+xows_l10n_get("to occupant")}else s=xows_l10n_get(t="Ban occupant");s+=" <b>"+e.name+"</b> ?",xows_doc_mbox_open(Ut,t,s,xows_gui_mbox_affi_onvalid,"OK",xows_gui_mbox_affi_onabort,"Cancel")}const Cs={occu:null,role:null};function xows_gui_mbox_role_onabort(){}function xows_gui_mbox_role_onvalid(){const e=Cs;xows_cli_muc_set_role(e.occu,e.role)}function xows_gui_mbox_role_open(e,o){const _=Cs;let t,s;if(_.occu=e,_.role=o,o>go){switch(t="Change occupant role",s=xows_l10n_get("Assign the Channel role")+" <b>",o){case bo:s+=xows_l10n_get("Moderator");break;case ho:s+=xows_l10n_get("Participant");break;case fo:s+=xows_l10n_get("Visitor")}s+="</b> "+xows_l10n_get("to occupant")}else s=xows_l10n_get(t="Kick occupant");s+=" <b>"+e.name+"</b> ?",xows_doc_mbox_open(Ut,t,s,xows_gui_mbox_role_onvalid,"OK",xows_gui_mbox_role_onabort,"Cancel")}function xows_gui_page_wait_onclick(e){"wait_abrt"===e.id&&(xows_gui_disconnect(),xows_gui_reset(),xows_gui_page_auth_open())}function xows_gui_page_wait_open(e){xows_doc("wait_text").innerText=xows_l10n_get(e),xows_doc_page_open("page_wait"),xows_doc_page_open("page_wait",!1,null,null,xows_gui_page_wait_onclick)}function xows_gui_page_auth_oninput(e){let o=!0;xows_doc("auth_user").value.length&&xows_doc("auth_pass").value.length&&(o=!1),xows_doc("auth_cnct").disabled=o}function xows_gui_page_auth_onclick(e){"auth_cnct"!==e.id?"auth_regi"===e.id&&xows_gui_page_regi_open():xows_doc("auth_cnct").disabled||(xows_gui_page_wait_open("Connecting..."),(es={}).user=xows_doc("auth_user").value.toLowerCase(),es.pass=xows_doc("auth_pass").value,es.cred=xows_doc("auth_cred").checked,xows_doc("auth_pass").value="",xows_gui_connect(!1))}function xows_gui_page_auth_open(){xows_doc("auth_user").value="",xows_doc("auth_pass").value="",xows_doc("auth_cnct").disabled=!0,xows_doc_page_open("page_auth",!1,null,xows_gui_page_auth_oninput,xows_gui_page_auth_onclick)}function xows_gui_page_regi_oninput(e){let o=!0;xows_doc("regi_user").value.length&&xows_doc("regi_pass").value.length&&xows_doc_cls_has("regi_capt","CAPTCHA-CHECKED")&&(o=!1),xows_doc("regi_subm").disabled=o}function xows_gui_page_regi_onclick(e){if("regi_capt"===e.id)return xows_doc_cls_add("regi_capt","CAPTCHA-CHECKED"),void xows_gui_page_regi_oninput(e);"regi_subm"!==e.id?"regi_canc"===e.id&&xows_gui_page_auth_open():xows_doc("regi_subm").disabled||(xows_gui_page_wait_open("Please wait..."),(es={}).user=xows_doc("regi_user").value.toLowerCase(),es.pass=xows_doc("regi_pass").value,xows_doc("regi_pass").value="",xows_gui_connect(!0))}function xows_gui_page_regi_open(){xows_doc("regi_user").value="",xows_doc("regi_pass").value="",xows_doc("regi_subm").disabled=!0,xows_doc_cls_rem("regi_capt","CAPTCHA-CHECKED"),xows_doc_page_open("page_regi",!1,null,xows_gui_page_regi_oninput,xows_gui_page_regi_onclick)}function xows_gui_page_edit_onabort(){let e;xows_doc("edit_name").value=r_.name,r_.avat?(e=xows_cach_avat_get(r_.avat),xows_doc("edit_avat").data=e):(e=xows_cach_avat_temp_data(r_.addr,null),xows_doc("edit_avat").data=null),xows_doc("edit_avat").style.backgroundImage='url("'+e+'")',xows_doc("edit_open").checked=!0}function xows_gui_page_edit_onvalid(){xows_cli_self_edit(xows_doc("edit_name").value,xows_doc("edit_avat").data,xows_doc("edit_open").checked?"open":"presence")}function xows_gui_page_edit_oninput(e){let o;switch(e.id){case"edit_open":o=!xows_doc("edit_open").checked;break;case"edit_name":o=xows_doc("edit_name").value!=r_.name}o&&xows_doc_popu_open_for_save(xows_gui_page_edit_onvalid,xows_gui_page_edit_onabort)}function xows_gui_page_edit_onclick(e){if("edit_bt_avch"!==e.id){if("edit_bt_avrm"===e.id){const e=xows_doc("edit_avat");e.data=null;const o=xows_cach_avat_temp_data(r_.addr,null);e.style.backgroundImage='url("'+o+'")',xows_doc_popu_open_for_save(xows_gui_page_edit_onvalid,xows_gui_page_edit_onabort)}}else xows_doc("edit_file").click()}function xows_gui_page_edit_ev_file(e){const o=xows_doc("edit_file");if(o.files[0]){const e=new FileReader;e.onload=function(e){const o=new Image;o.onload=function(e){const o=xows_gen_avatar(I_,this,null),_=xows_doc("edit_avat");_.data=o,_.style.backgroundImage='url("'+o+'")',xows_doc_popu_open_for_save(xows_gui_page_edit_onvalid,xows_gui_page_edit_onabort)},o.src=e.target.result},e.readAsDataURL(o.files[0])}}function xows_gui_page_edit_onclose(){xows_doc_listener_rem(xows_doc("edit_file"),"change",xows_gui_page_edit_ev_file)}function xows_gui_page_edit_open(){xows_gui_page_edit_onabort(),xows_doc("edit_addr").innerText=r_.addr,xows_doc_page_open("page_edit",!0,xows_gui_page_edit_onclose,xows_gui_page_edit_oninput,xows_gui_page_edit_onclick),xows_doc_listener_add(xows_doc("edit_file"),"change",xows_gui_page_edit_ev_file)}function xows_gui_page_acct_onabort(){}function xows_gui_page_acct_onvalid(){}function xows_gui_page_acct_oninput(e){const o=xows_doc("acct_pass"),_=xows_doc("acct_pnew"),t=xows_doc("acct_pcnf");xows_doc("acct_bt_pass").disabled=!o.value||!_.value||!t.value}function xows_gui_page_acct_onchpas(e,o){const _=xows_doc("acct_pass"),t=xows_doc("acct_pnew"),s=xows_doc("acct_pcnf");"error"===e?xows_doc_popu_open(Rt,xows_l10n_get("Password change failed")+": "+o.name):xows_doc_popu_open(Ht,"Password has been changed successfully"),_.setCustomValidity(""),_.value="",t.value="",s.setCustomValidity(""),s.value=""}function xows_gui_page_acct_onclick(e){const o=xows_doc("acct_pass"),_=xows_doc("acct_pnew"),t=xows_doc("acct_pcnf");if(o.setCustomValidity(""),t.setCustomValidity(""),"acct_bt_pass"===e.id){if(o.value!==I.pass)return xows_doc_popu_open(Rt,"The current password you entered is wrong"),void o.setCustomValidity("Wrong password");if(_.value!==t.value)return xows_doc_popu_open(Rt,"The password confirmation does not match"),void t.setCustomValidity("Confirmation does not match");xows_cli_regi_chpas_query(_.value,xows_gui_page_acct_onchpas)}"acct_bt_unre"===e.id&&xows_gui_mbox_unre_open()}function xows_gui_page_acct_onclose(){}function xows_gui_page_acct_open(){const e=xows_doc("acct_pass"),o=xows_doc("acct_pnew"),_=xows_doc("acct_pcnf");e.setCustomValidity(""),e.value="",o.value="",_.setCustomValidity(""),_.value="",xows_doc("acct_addr").innerText=r_.addr,xows_doc_page_open("page_acct",!0,xows_gui_page_acct_onclose,xows_gui_page_acct_oninput,xows_gui_page_acct_onclick)}const Ds={room:null,form:null,cancel:!0};function xows_gui_page_mucc_onresult(e,o){"result"===o&&(Ds.cancel=!1,xows_doc_page_close())}function xows_gui_page_mucc_onvalid(){const e=Ds.room,o=Ds.form;for(let e=0,_=o.length;e<_;++e){const _=o[e].value;switch(o[e].var){case"muc#roomconfig_roomname":_[0]=xows_doc("mucc_titl").value;break;case"muc#roomconfig_roomdesc":_[0]=xows_doc("mucc_desc").value;break;case"muc#roomconfig_persistentroom":_[0]=xows_doc("mucc_pers").checked?"1":"0";break;case"muc#roomconfig_publicroom":_[0]=xows_doc("mucc_publ").checked?"1":"0";break;case"muc#roomconfig_roomsecret":_[0]=xows_doc("mucc_prot").checked?xows_doc("mucc_pass").value:"";break;case"muc#roomconfig_membersonly":_[0]=xows_doc("mucc_mbon").checked?"1":"0";break;case"muc#roomconfig_moderatedroom":_[0]=xows_doc("mucc_modo").checked?"1":"0";break;case"muc#roomconfig_whois":_[0]=xows_doc("mucc_anon").value;break;case"muc#roomconfig_presencebroadcast":_.length=0,xows_doc("mucc_lsvi").checked&&_.push("visitor"),xows_doc("mucc_lspa").checked&&_.push("participant"),xows_doc("mucc_lsmo").checked&&_.push("moderator");break;case"muc#roomconfig_historylength":_[0]=xows_doc("mucc_hmax").value;break;case"muc#roomconfig_defaulthistorymessages":_[0]=xows_doc("mucc_hdef").value;break;case"muc#roomconfig_enablearchiving":_[0]=xows_doc("mucc_arch").checked?"1":"0"}}xows_cli_muc_setcfg_query(e,o,xows_gui_page_mucc_onresult)}function xows_gui_page_mucc_onabort(){const e=Ds.form;for(let o=0,_=e.length;o<_;++o){const _=e[o].value;switch(e[o].var){case"muc#roomconfig_roomname":xows_doc("mucc_titl").value=_[0]?_[0]:"";break;case"muc#roomconfig_roomdesc":xows_doc("mucc_desc").value=_[0];break;case"muc#roomconfig_persistentroom":xows_doc("mucc_pers").checked=xows_asbool(_[0]);break;case"muc#roomconfig_publicroom":xows_doc("mucc_publ").checked=xows_asbool(_[0]);break;case"muc#roomconfig_roomsecret":{const e=xows_asbool(_[0].length);xows_doc("mucc_prot").checked=e,xows_doc("mucc_pass").disabled=!e,xows_doc("mucc_pass").value=_[0];break}case"muc#roomconfig_membersonly":xows_doc("mucc_mbon").checked=xows_asbool(_[0]);break;case"muc#roomconfig_changesubject":case"muc#roomconfig_moderatedroom":xows_doc("mucc_modo").checked=xows_asbool(_[0]);break;case"muc#roomconfig_whois":xows_doc("mucc_anon").value=_;break;case"muc#roomconfig_presencebroadcast":xows_doc("mucc_lsvi").checked=_.includes("visitor"),xows_doc("mucc_lspa").checked=_.includes("participant"),xows_doc("mucc_lsmo").checked=_.includes("moderator");break;case"muc#roomconfig_historylength":xows_doc("mucc_hmax").value=_[0];break;case"muc#roomconfig_defaulthistorymessages":xows_doc("mucc_hdef").value=_[0];break;case"muc#roomconfig_enablearchiving":xows_doc("mucc_arch").checked=xows_asbool(_[0])}}}function xows_gui_page_mucc_oninput(e){let o=!1;const _=Ds.form,t=xows_doc("mucc_prot").checked;xows_doc("mucc_pass").disabled=!t,t||(xows_doc("mucc_pass").value="");for(let e=0,t=_.length;e<t;++e){const t=_[e].value;switch(_[e].var){case"muc#roomconfig_roomname":t[0]!==xows_doc("mucc_titl").value&&(o=!0);break;case"muc#roomconfig_roomdesc":t[0]!==xows_doc("mucc_desc").value&&(o=!0);break;case"muc#roomconfig_persistentroom":xows_asbool(t[0])!==xows_doc("mucc_pers").checked&&(o=!0);break;case"muc#roomconfig_publicroom":xows_asbool(t[0])!==xows_doc("mucc_publ").checked&&(o=!0);break;case"muc#roomconfig_roomsecret":t[0]!==xows_doc("mucc_pass").value&&(o=!0);break;case"muc#roomconfig_membersonly":xows_asbool(t[0])!==xows_doc("mucc_mbon").checked&&(o=!0);break;case"muc#roomconfig_moderatedroom":xows_asbool(t[0])!==xows_doc("mucc_modo").checked&&(o=!0);break;case"muc#roomconfig_whois":t[0]!==xows_doc("mucc_anon").value&&(o=!0);break;case"muc#roomconfig_presencebroadcast":t.includes("visitor")!==xows_doc("mucc_lsvi").checked&&(o=!0),t.includes("participant")!==xows_doc("mucc_lspa").checked&&(o=!0),t.includes("moderator")!==xows_doc("mucc_lsmo").checked&&(o=!0);break;case"muc#roomconfig_historylength":t[0]!==xows_doc("mucc_hmax").value&&(o=!0);break;case"muc#roomconfig_defaulthistorymessages":t[0]!==xows_doc("mucc_hdef").value&&(o=!0);break;case"muc#roomconfig_enablearchiving":xows_asbool(t[0])!==xows_doc("mucc_arch").checked&&(o=!0)}if(o)break}o&&xows_doc_popu_open_for_save(xows_gui_page_mucc_onvalid,xows_gui_page_mucc_onabort)}function xows_gui_page_mucc_onclose(){const e=Ds;e.room.init?xows_cli_muc_setcfg_query(e.room,null,null):e.cancel&&xows_cli_muc_setcfg_cancel(e.room,null),e.form=null,e.room=null}function xows_gui_page_mucc_open(e,o){for(let e=0,_=o.length;e<_;++e)o[e].value||(o[e].value=[0]);xows_doc("mucc_room").innerText=e.name+" ("+e.addr+")";const _=Ds;_.room=e,_.form=o,_.cancel=!0,xows_gui_page_mucc_onabort(),xows_doc_page_open("page_mucc",!0,xows_gui_page_mucc_onclose,xows_gui_page_mucc_oninput,xows_gui_page_mucc_oninput)}const Ts={room:null,stage:0,items:null},js=["outcast","owner","admin","member"];function xows_gui_page_muca_getitem(e){const o=Ts.items;for(let _=0;_<o.length;++_)if(o[_].jid==e.dataset.bare)return o[_];return null}function xows_gui_page_muca_onload(e,o){const _=Ts,t=_.room,s=xows_doc("muca_outc"),n=xows_doc("muca_affi");if(0==_.stage&&(s.innerHTML="",n.innerHTML="",s.classList.add("LOADING"),n.classList.add("LOADING"),_.items=[]),o&&o.length){_.items=_.items.concat(o);for(let e=0;e<o.length;++e){if(xows_cli_isself_addr(o[e].jid))continue;const _=xows_tpl_admn_memb_spawn(o[e],t.affi);-1==o[e].affi?s.appendChild(_):n.appendChild(_)}}if(1==_.stage&&t.affi<qo&&(_.stage=3),_.stage<4)return void xows_xmp_muc_affi_get_query(t.addr,js[_.stage++],xows_gui_page_muca_onload);s.classList.remove("LOADING"),n.classList.remove("LOADING");const c="<li>"+xows_l10n_get("List is empty")+"</li>";""==s.innerHTML&&(s.innerHTML=c),""==n.innerHTML&&(n.innerHTML=c)}function xows_gui_page_muca_onclose(){const e=Ts;e.room=null,e.stage=0,e.items=null}function xows_gui_page_muca_onvalid(){xows_doc_cls_add("muca_outc","LOADING"),xows_doc_cls_add("muca_affi","LOADING");const e=Ts;let o=xows_doc("page_muca").querySelectorAll(".MODIFIED");for(let _=0;_<o.length;++_){const t=xows_gui_page_muca_getitem(o[_]);t.affi=parseInt(o[_].dataset.affi),xows_xmp_muc_affi_set_query(e.room.addr,t,null)}e.stage=0,xows_gui_page_muca_onload(null,null)}function xows_gui_page_muca_onabort(){let e=xows_doc("page_muca").querySelectorAll(".MODIFIED");for(let o=0;o<e.length;++o){const _=xows_gui_page_muca_getitem(e[o]);xows_tpl_admn_memb_update(e[o],_.affi,_.affi)}}function xows_gui_page_muca_oninput(e){if("MEMB-RADIO"==e.tagName){const o=e.closest("LI-MEMB"),_=xows_gui_page_muca_getitem(o);xows_tpl_admn_memb_update(o,parseInt(e.dataset.affi),_.affi)}xows_doc("page_muca").querySelectorAll(".MODIFIED").length>0?xows_doc_popu_open_for_save(xows_gui_page_muca_onvalid,xows_gui_page_muca_onabort):xows_doc_popu_close()}function xows_gui_page_muca_open(e){xows_doc("muca_room").innerText=e.name+" ("+e.addr+")";const o=Ts;o.room=e,o.stage=0,xows_gui_page_muca_onload(null,null),xows_doc_page_open("page_muca",!0,xows_gui_page_muca_onclose,xows_gui_page_muca_oninput,xows_gui_page_muca_oninput)}const Ls={room:null};function xows_gui_mbox_conf_onvalid(){const e=Ls.room;xows_log(2,"gui_room_init_onvalid","request initial Room config",e.addr),xows_cli_muc_getcfg_query(e,xows_gui_page_mucc_open)}function xows_gui_mbox_conf_onabort(){xows_cli_muc_setcfg_query(Ls.room,null)}function xows_gui_mbox_conf_open(e){Ls.room=e,xows_doc_mbox_open(Ut,"Channel initialization","A new Channel was created and you are its owner, do you want to configure it right now ?",xows_gui_mbox_conf_onvalid,"Configure",xows_gui_mbox_conf_onabort,"Ignore")}function xows_gui_prof_onclick(e,o){o&&"prof_addc"==o.id&&(xows_cli_subs_request(e.jbar),xows_doc_prof_update())}function xows_gui_prof_open(e){xows_doc_prof_open(e,xows_gui_prof_onclick)}function xows_gui_mbox_unre_onabort(){}function xows_gui_mbox_unre_onvalid(){xows_cli_regi_remove_query(null,null)}function xows_gui_mbox_unre_open(){xows_doc_mbox_open(Ut,"Account deletion","Are you sure you want to delete your XMPP/Jabber account on this server ? This action cannot be reversed.",xows_gui_mbox_unre_onvalid,"Yes, farewell",xows_gui_mbox_unre_onabort,"God damn, NO !")}let Ns={root:"/xows",url:"ws://localhost/xmpp-websocket/",domain:"localhost",locale:"en-US",theme:"dark",verbose:1,uncache:!1,mincss:!1,allow_register:!1,avatar_autopub:!0,avatar_notify:!0,login_delay:2e3,history_count:50,history_delay:500,extern_services:[]};function xows_init_login_user(){xows_log(2,"init_login_user","normal login"),window.PasswordCredential?xows_doc_show("auth_save"):xows_doc_hide("auth_save"),xows_gui_page_auth_open()}function xows_init_login_auto(e){e?(xows_log(2,"init_login_auto","found credential","try auto login"),xows_gui_page_wait_open("Connecting..."),es={user:e.id,pass:e.password},xows_gui_connect()):(xows_log(2,"init_login_auto","No credential found","Fallback to normal login"),xows_init_login_user())}function xows_init_ondoc(){if(xows_cli_init(),xows_gui_init(),window.PasswordCredential){const e={password:!0,mediation:"optional"};navigator.credentials.get(e).then(xows_init_login_auto,xows_init_login_user)}else xows_init_login_user()}function xows_init_ontpl(){xows_doc_init(xows_init_ondoc)}function xows_init_onl10n(){xows_tpl_init(xows_init_ontpl)}function xows_init(e){e&&(e.hasOwnProperty("root")&&(Ns.root=e.root),e.hasOwnProperty("url")&&(Ns.url=e.url),e.hasOwnProperty("domain")&&(Ns.domain=e.domain),e.hasOwnProperty("locale")&&(Ns.locale=e.locale),e.hasOwnProperty("theme")&&(Ns.theme=e.theme),e.hasOwnProperty("verbose")&&(Ns.verbose=e.verbose),e.hasOwnProperty("uncache")&&(Ns.uncache=e.uncache),e.hasOwnProperty("mincss")&&(Ns.mincss=e.mincss),e.hasOwnProperty("allow_register")&&(Ns.allow_register=e.allow_register),e.hasOwnProperty("avatar_autopub")&&(Ns.avatar_autopub=e.avatar_autopub),e.hasOwnProperty("avatar_notify")&&(Ns.avatar_notify=e.avatar_notify),e.hasOwnProperty("fail_delay")&&(Ns.fail_delay=e.fail_delay),e.hasOwnProperty("history_count")&&(Ns.history_count=e.history_count),e.hasOwnProperty("history_delay")&&(Ns.history_delay=e.history_delay),e.hasOwnProperty("extern_services")&&(Ns.extern_services=e.extern_services)),"/"!=Ns.root.charAt(0)&&(Ns.root="/"+Ns.root),xows_log(2,"init","xows init start"),xows_l10n_select(Ns.locale,xows_init_onl10n)}function xows_init_fatal(e,o){let _="<h1>XOWS init failed</h1><h4>Asset file loading error ( HTTP error "+e+" )</h4>";_+="<big><code>"+o.match(/(.+?)(?:\?.*|$)/)[1]+"</code></big>",_+="<h5>Did you set the proper library/assets root path ?</h5>",document.body.style="padding:20px;text-align:center;background:#1A1A1F;color:#FC8484",document.body.innerHTML=_}