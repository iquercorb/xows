"use strict";const XOWS_APP_NAME="Xows",XOWS_APP_VERS="0.9.0",XOWS_APP_NODE="https://github.com/sedenion/xows",XOWS_LOGO_SVG=new Path2D("M8.282 6.527l2.514 3.942c-2.33 1.463-3.431 3.529-4.134 5.785-2.326.221-1.5-4.322-1.659-5.373 0 0-2.945 5.92-.822 7.584 1.518 1.19 4.09 1.651 4.09 1.651l-3.268 4.146c2.224.748 7.17.825 7.17.825l2.837-4.416h2.054l2.837 4.417s4.946-.078 7.17-.826l-3.268-4.146s2.558-.477 4.09-1.651c1.964-1.506-.822-7.584-.822-7.584-.159 1.051.667 5.594-1.66 5.373-.701-2.257-1.803-4.322-4.134-5.785l2.514-3.942c-.98-1.003-2.247-1.753-3.34-1.576l-3.786 4.692h-1.257L11.622 4.95c-1.091-.177-2.358.573-3.34 1.576zm4.104 6.495c.63 1.175 1.797 3.073 1.797 3.073s-1.005.029-1.95.029c-.944 0-1.598-.05-1.598-.754s.322-2.348 1.75-2.348zm7.264 0c1.449 0 1.75 1.644 1.75 2.348 0 .705-.596.754-1.598.754a74.34 74.34 0 01-1.95-.029S19 14.197 19.65 13.022z");function xows_hasbits(_,o){return(_&o)===o}function xows_isfunc(_){return _&&_.constructor&&_.call&&_.apply}function xows_random(_){let o=_+=1831565813;return o=Math.imul(o^o>>>15,1|o),(((o^=o+Math.imul(o^o>>>7,61|o))^o>>>14)>>>0)/4294967296}const XOWS_SIG_ERR=0,XOWS_SIG_WRN=1,XOWS_SIG_LOG=2;function xows_log(_,o,e,s,t){if(_<=xows_options.verbose){let n,c="";_>1&&t&&(c+="%c",n="color:"+t),c+=e,s&&(c+=": "+s);const i=o+": "+c;switch(_){case 0:case 1:console.warn(i);break;default:n?console.log(i,n):console.log(i)}}}const XOWS_CMAP_HEX="0123456789abcdef",XOWS_CMAP_B64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function xows_str_to_utf8(_){let o,e,s="";for(let t=0,n=_.length;t<n;++t)(o=_.charCodeAt(t))<128?s+=_.charAt(t):o<2048?s+=String.fromCharCode(192|o>>6,128|63&o):o<55296||o>=57344?s+=String.fromCharCode(224|o>>12,128|o>>6&63,128|63&o):(++t,o=65536+((1023&o)<<10|1023&(e=_.charCodeAt(t))),s+=String.fromCharCode(240|o>>18,128|o>>12&63,128|o>>6&63,128|63&o));return s}function xows_str_bytes_len(_){let o,e=0;for(let s=0,t=_.length;s<t;++s)(o=_.charCodeAt(s))<128?e++:o<2048?e+=2:o<55296||o>=57344?e+=3:(++s,e+=4);return e}function xows_str_to_bytes(_,o){let e,s;const t=new Uint8Array(o||xows_str_bytes_len(_));for(let o=0,n=0,c=_.length;o<c;++o)(e=_.charCodeAt(o))<128?t[n++]=e:e<2048?(t[n++]=192|e>>6,t[n++]=128|63&e):e<55296||e>=57344?(t[n++]=224|e>>12,t[n++]=128|e>>6&63,t[n++]=128|63&e):(++o,e=65536+((1023&e)<<10|1023&(s=_.charCodeAt(o))),t[n++]=240|e>>18,t[n++]=128|e>>12&63,t[n++]=128|e>>6&63,t[n++]=128|63&e);return t}function xows_bytes_to_str(_){return String.fromCharCode.apply(null,_)}function xows_bytes_to_b64(_){const o=_.length,e=o%3;let s,t,n,c="";for(s=0,t=o-e;s<t;)n=_[s++]<<16|_[s++]<<8|_[s++],c+=XOWS_CMAP_B64[63&n>>18],c+=XOWS_CMAP_B64[63&n>>12],c+=XOWS_CMAP_B64[63&n>>6],c+=XOWS_CMAP_B64[63&n];return 0!==e&&(n=_[s++]<<16,e>1&&(n|=_[s]<<8),c+=XOWS_CMAP_B64[63&n>>18],c+=XOWS_CMAP_B64[63&n>>12],c+=e>1?XOWS_CMAP_B64[63&n>>6]:"=",c+="="),c}function xows_bytes_to_hex(_){let o,e="";for(let s=0,t=_.length;s<t;++s)o=_[s],e+=XOWS_CMAP_HEX.charAt(o>>>4&15)+XOWS_CMAP_HEX.charAt(15&o);return e}function xows_gen_uuid(){const _=new Uint8Array(16);window.crypto.getRandomValues(_),_[6]=15&_[6]|64,_[8]=63&_[8]|128;let o="";for(let e=0,s=0;s<16;++s)8!==e&&13!==e&&18!==e&&23!==e||(o+="-",e++),o+=XOWS_CMAP_HEX.charAt(_[s]>>>4&15)+XOWS_CMAP_HEX.charAt(15&_[s]),e+=2;return o}function xows_gen_nonce_hex(_){const o=new Uint8Array(_);window.crypto.getRandomValues(o);let e="";for(let s=0;s<_;++s)e+=XOWS_CMAP_HEX.charAt(o[s]>>>4&15)+XOWS_CMAP_HEX.charAt(15&o[s]);return e}function xows_gen_nonce_asc(_){const o=new Uint8Array(_);window.crypto.getRandomValues(o);let e="";for(let s=0;s<_;++s)e+=XOWS_CMAP_B64[o[s]%62];return e}function xows_hash_md5(_){let o;function e(_,e,s,t,n,c,i){return((o=_+((t^e&(s^t))+n+i))<<c|o>>>32-c)+e}function s(_,e,s,t,n,c,i){return((o=_+((s^t&(e^s))+n+i))<<c|o>>>32-c)+e}function t(_,e,s,t,n,c,i){return((o=_+((e^s^t)+n+i))<<c|o>>>32-c)+e}function n(_,e,s,t,n,c,i){return((o=_+((s^(e|~t))+n+i))<<c|o>>>32-c)+e}let c,i,l,a=0;if("string"==typeof _)l=xows_str_to_bytes(_,64+((i=8*(c=xows_str_bytes_len(_)))+64>>9<<6));else for(i=8*(c=_.length),l=new Uint8Array(64+(i+64>>9<<6));a<c;++a)l[a]=_[a];l[c]|=128;let r=l.length-8;l[r]=255&i,l[r+1]=i>>8&255,l[r+2]=i>>16&255,l[r+3]=i>>24&255;const x=new Uint32Array(16),w=new Uint32Array(4);let u,d,p,m;for(w[0]=1732584193,w[1]=4023233417,w[2]=2562383102,w[3]=271733878,r=0;r<l.length;){for(a=0;a<16;++a)x[a]=l[r++]|l[r++]<<8|l[r++]<<16|l[r++]<<24;u=w[0],d=n(d=n(d=n(d=n(d=t(d=t(d=t(d=t(d=s(d=s(d=s(d=s(d=e(d=e(d=e(d=e(d=w[1],p=e(p=w[2],m=e(m=w[3],u=e(u,d,p,m,x[0],7,3614090360),d,p,x[1],12,3905402710),u,d,x[2],17,606105819),m,u,x[3],22,3250441966),p=e(p,m=e(m,u=e(u,d,p,m,x[4],7,4118548399),d,p,x[5],12,1200080426),u,d,x[6],17,2821735955),m,u,x[7],22,4249261313),p=e(p,m=e(m,u=e(u,d,p,m,x[8],7,1770035416),d,p,x[9],12,2336552879),u,d,x[10],17,4294925233),m,u,x[11],22,2304563134),p=e(p,m=e(m,u=e(u,d,p,m,x[12],7,1804603682),d,p,x[13],12,4254626195),u,d,x[14],17,2792965006),m,u,x[15],22,1236535329),p=s(p,m=s(m,u=s(u,d,p,m,x[1],5,4129170786),d,p,x[6],9,3225465664),u,d,x[11],14,643717713),m,u,x[0],20,3921069994),p=s(p,m=s(m,u=s(u,d,p,m,x[5],5,3593408605),d,p,x[10],9,38016083),u,d,x[15],14,3634488961),m,u,x[4],20,3889429448),p=s(p,m=s(m,u=s(u,d,p,m,x[9],5,568446438),d,p,x[14],9,3275163606),u,d,x[3],14,4107603335),m,u,x[8],20,1163531501),p=s(p,m=s(m,u=s(u,d,p,m,x[13],5,2850285829),d,p,x[2],9,4243563512),u,d,x[7],14,1735328473),m,u,x[12],20,2368359562),p=t(p,m=t(m,u=t(u,d,p,m,x[5],4,4294588738),d,p,x[8],11,2272392833),u,d,x[11],16,1839030562),m,u,x[14],23,4259657740),p=t(p,m=t(m,u=t(u,d,p,m,x[1],4,2763975236),d,p,x[4],11,1272893353),u,d,x[7],16,4139469664),m,u,x[10],23,3200236656),p=t(p,m=t(m,u=t(u,d,p,m,x[13],4,681279174),d,p,x[0],11,3936430074),u,d,x[3],16,3572445317),m,u,x[6],23,76029189),p=t(p,m=t(m,u=t(u,d,p,m,x[9],4,3654602809),d,p,x[12],11,3873151461),u,d,x[15],16,530742520),m,u,x[2],23,3299628645),p=n(p,m=n(m,u=n(u,d,p,m,x[0],6,4096336452),d,p,x[7],10,1126891415),u,d,x[14],15,2878612391),m,u,x[5],21,4237533241),p=n(p,m=n(m,u=n(u,d,p,m,x[12],6,1700485571),d,p,x[3],10,2399980690),u,d,x[10],15,4293915773),m,u,x[1],21,2240044497),p=n(p,m=n(m,u=n(u,d,p,m,x[8],6,1873313359),d,p,x[15],10,4264355552),u,d,x[6],15,2734768916),m,u,x[13],21,1309151649),p=n(p,m=n(m,u=n(u,d,p,m,x[4],6,4149444226),d,p,x[11],10,3174756917),u,d,x[2],15,718787259),m,u,x[9],21,3951481745),w[0]+=u,w[1]+=d,w[2]+=p,w[3]+=m}const g=new Uint8Array(16);for(a=0,r=0;a<4;++a)g[r++]=255&w[a],g[r++]=w[a]>>8&255,g[r++]=w[a]>>16&255,g[r++]=w[a]>>24&255;return g}function xows_hash_sha1(_){let o,e,s,t=0;if("string"==typeof _)s=xows_str_to_bytes(_,64+((e=8*(o=xows_str_bytes_len(_)))+64>>9<<6));else for(e=8*(o=_.length),s=new Uint8Array(64+(e+64>>9<<6));t<o;++t)s[t]=_[t];s[o]|=128;let n=s.length-4;s[n]=e>>24&255,s[n+1]=e>>16&255,s[n+2]=e>>8&255,s[n+3]=255&e;const c=new Uint32Array(16),i=new Uint32Array(5);let l,a,r,x,w,u,d,p;for(i[0]=1732584193,i[1]=4023233417,i[2]=2562383102,i[3]=271733878,i[4]=3285377520,n=0;n<s.length;){for(t=0;t<16;++t)c[t]=s[n++]<<24|s[n++]<<16|s[n++]<<8|s[n++];for(l=i[0],a=i[1],r=i[2],x=i[3],w=i[4],t=0;t<80;++t)t>15&&(p=c[t-3&15]^c[t-8&15]^c[t-14&15]^c[15&t],c[15&t]=p<<1|p>>>31),t<20?(u=1518500249,d=x^a&(r^x)):t<40?(u=1859775393,d=a^r^x):t<60?(u=2400959708,d=a&r|a&x|r&x):(u=3395469782,d=a^r^x),p=(l<<5|l>>>27)+d+(w+c[15&t]+u),w=x,x=r,r=a<<30|a>>>2,a=l,l=p;i[0]+=l,i[1]+=a,i[2]+=r,i[3]+=x,i[4]+=w}const m=new Uint8Array(20);for(t=0,n=0;t<5;++t)m[n++]=i[t]>>24&255,m[n++]=i[t]>>16&255,m[n++]=i[t]>>8&255,m[n++]=255&i[t];return m}function xows_hmac_sha1(_,o){"string"==typeof _&&(_=xows_str_to_bytes(_)),_.length>64&&(_=xows_hash_sha1(_));const e=new Uint8Array(64+o.length),s=new Uint8Array(84);let t,n,c;for(n=0,c=_.length;n<c;++n)e[n]=54^_[n],s[n]=92^_[n];for(;n<64;++n)e[n]=54,s[n]=92;for("string"==typeof o&&(o=xows_str_to_bytes(o)),t=0,c=o.length;t<c;++t)e[n++]=o[t];const i=xows_hash_sha1(e);for(t=0,n=64;t<20;++t)s[n++]=i[t];return xows_hash_sha1(s)}function xows_hash_sha256(_){const o=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);let e,s,t,n=0;if("string"==typeof _)t=xows_str_to_bytes(_,64+((s=8*(e=xows_str_bytes_len(_)))+64>>9<<6));else for(s=8*(e=_.length),t=new Uint8Array(64+(s+64>>9<<6));n<e;++n)t[n]=_[n];t[e]|=128;let c=t.length-4;t[c]=s>>24&255,t[c+1]=s>>16&255,t[c+2]=s>>8&255,t[c+3]=255&s;const i=new Uint32Array(64),l=new Uint32Array(8);let a,r,x,w,u,d,p,m,g,f;for(l[0]=1779033703,l[1]=3144134277,l[2]=1013904242,l[3]=2773480762,l[4]=1359893119,l[5]=2600822924,l[6]=528734635,l[7]=1541459225,c=0;c<t.length;){for(n=0;n<16;++n)i[n]=t[c++]<<24|t[c++]<<16|t[c++]<<8|t[c++];for(a=l[0],r=l[1],x=l[2],w=l[3],u=l[4],d=l[5],p=l[6],m=l[7],n=0;n<64;n++)n>15&&(g=((f=i[n-2])>>>17|f<<15)^(f>>>19|f<<13)^f>>>10,i[n]=g+i[n-7],g=((f=i[n-15])>>>7|f<<25)^(f>>>18|f<<14)^f>>>3,i[n]+=g+i[n-16]),w+=f=m+(g=(u>>>6|u<<26)^(u>>>11|u<<21)^(u>>>25|u<<7))+(p^u&(d^p))+o[n]+i[n],f+=(g=(a>>>2|a<<30)^(a>>>13|a<<19)^(a>>>22|a<<10))+(a&r|x&(a|r)),m=p,p=d,d=u,u=w,w=x,x=r,r=a,a=f;l[0]+=a,l[1]+=r,l[2]+=x,l[3]+=w,l[4]+=u,l[5]+=d,l[6]+=p,l[7]+=m}const h=new Uint8Array(32);for(n=0,c=0;n<8;++n)h[c++]=l[n]>>24&255,h[c++]=l[n]>>16&255,h[c++]=l[n]>>8&255,h[c++]=255&l[n];return h}const XOWS_REG_TEST_JID=/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;function xows_isjid(_){return XOWS_REG_TEST_JID.test(_)}function xows_jid_to_bare(_){const o=_.indexOf("/");return-1!==o?_.substring(0,o):_}function xows_jid_to_user(_){const o=_.indexOf("@");return-1!==o?_.substring(0,o):_}function xows_jid_to_nick(_){const o=_.indexOf("/");return-1!==o?_.substring(o+1):null}function xows_url_to_data(_){return 0===_.indexOf("data:")?_.substring(_.indexOf(",")+1):null}function xows_url_to_bytes(_){return 0===_.indexOf("data:")?atob(_.substring(_.indexOf(",")+1)):null}function xows_url_to_type(_){return 0===_.indexOf("data:")?_.substring(5,_.indexOf(";")):null}const XOWS_HTML_ESCAP_MAP={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&apos;",'"':"&quot;","\n":"<br>"};function xows_html_escap_fnc(_){return XOWS_HTML_ESCAP_MAP[_]}function xows_html_escape(_){return _.replace(/[\&<>'"\n]/g,xows_html_escap_fnc)}function xows_clean_dom(_){let o,e=_.childNodes.length;for(;e--;)8===(o=_.childNodes[e]).nodeType||3===o.nodeType&&!/\S/.test(o.nodeValue)?_.removeChild(o):1===o.nodeType&&xows_clean_dom(o);return _}function xows_gen_avatar(_,o,e,s){const t=document.createElement("canvas"),n=t.getContext("2d");if(o){let e;const s=o.naturalWidth,c=o.naturalHeight;if(s>_||c>_){let i,l,a;s>c?(l=.5*(s-(i=c)),a=0):(l=0,a=.5*(c-(i=s))),t.width=s,t.height=c,n.drawImage(o,0,0);const r=n.getImageData(l,a,i,i),x=new Int32Array(r.data.buffer);e=new ImageData(_,_);const w=new Int32Array(e.data.buffer),u=1/(_/i),d=Math.round(u),p=1/(d*d);let m,g,f,h,b,F,v,y,S,k;for(m=0;m<_;++m)for(g=0;g<_;++g){for(b=Math.round(g*u)*i+Math.round(m*u),F=0,v=0,y=0,S=0,h=0;h<d;++h)for(f=0;f<d;++f)S+=(k=x[b+(h*i+f)])>>24&255,y+=k>>16&255,v+=k>>8&255,F+=255&k;F=Math.round(F*p),v=Math.round(v*p),y=Math.round(y*p),S=Math.round(S*p),w[g*_+m]=S<<24|y<<16|v<<8|F}t.width=t.height=_,n.putImageData(e,0,0)}else t.width=t.height=_,n.drawImage(o,0,0,_,_)}else if(t.width=t.height=_,e){let o=0,s=e.length;for(;s--;)o+=e.charCodeAt(s);const t=2*xows_random(o)*180;n.fillStyle="hsl("+t+",85%,45%)",n.rect(0,0,_,_),n.fill(),n.fillStyle="#FFF";const c=_/32;n.scale(c,c),n.fill(XOWS_LOGO_SVG)}return t.toDataURL("image/png")}let xows_l10n_db={},xows_l10n_current="en",xows_l10n_fw_onready=function(){};function xows_l10n_select(_,o){xows_isfunc(o)&&(xows_l10n_fw_onready=o);let e=xows_options.root+"/locale/LC_list.json";xows_options.uncache&&(e+="?"+xows_gen_nonce_asc(4));const s=new XMLHttpRequest;s.open("GET",e,!0),s.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_select","parsing locale list",this.responseURL);let o=JSON.parse(this.responseText);if(!o)return void xows_log(0,"l10n_select",'locale list "'+this.responseURL+'" parse error');if(o[_])return xows_log(2,"l10n_select","found available locale",_),void xows_l10n_db_load(o[_]);if(-1!==_.indexOf("-")){let e=_.split("-")[0].toLowerCase();if(o[e])return xows_log(2,"l10n_select","found available language",e),void xows_l10n_db_load(o[e])}xows_log(1,"l10n_select",'invalid or unavailable locale "'+_+'"',"using default"),xows_l10n_fw_onready()}else xows_log(0,"l10n_select",'locale list "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"')},xows_log(2,"l10n_select","loading locale list",e),s.send()}function xows_l10n_db_load(_,o){xows_isfunc(o)&&(xows_l10n_fw_onready=o);let e=xows_options.root+"/locale/"+_+"/LC_db.json";xows_options.uncache&&(e+="?"+xows_gen_nonce_asc(4));const s=new XMLHttpRequest;s.open("GET",e,!0),s.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_db_load","parsing JSON data",this.responseURL);let o=JSON.parse(this.responseText);if(!o)return void xows_log(0,"l10n_db_load",'data "'+this.responseURL+'" parse error');xows_l10n_db=o,xows_l10n_current=_,xows_l10n_fw_onready()}else xows_log(0,"l10n_db_load",'file "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"'),xows_l10n_fw_onready()},xows_log(2,"l10n_db_load","loading locale db",e),s.send()}function xows_l10n_get(_){const o=xows_l10n_db[_];return o&&0!==o.length?o:_}function xows_l10n_parseFunc(_,o){const e=xows_l10n_db[o];return e&&0!==e.length?e:o}function xows_l10n_parse(_){return _.replace(/\${['"](.*)['"]}/g,xows_l10n_parseFunc)}function xows_l10n_hasLocale(_){return null!==xows_l10n_db[_]&&void 0!==xows_l10n_db[_]}function xows_l10n_date(_){const o=new Date(_),e=new Date,s=new Date(_);return e.setHours(0,0,0,0),s.setHours(0,0,0,0),e===s?xows_l10n_get("at")+" "+o.toLocaleTimeString(xows_l10n_current):o.toLocaleDateString(xows_l10n_current,{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}function xows_l10n_houre(_){return new Date(_).toLocaleTimeString(xows_l10n_current,{hour:"2-digit",minute:"2-digit"})}const xows_xml_parser=new DOMParser,xows_xml_doc=document.implementation.createDocument("jabber:client","Xows"),XOWS_XML_ESCAP_MAP={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&apos;",'"':"&quot;"},XOWS_XML_UNESC_MAP={"&amp;":"&","&lt;":"<","&gt;":">","&apos;":"'","&quot;":'"'};function xows_xml_escap_fnc(_){return XOWS_XML_ESCAP_MAP[_]}function xows_xml_escape(_){return _.replace(/[\&<>'"]/g,xows_xml_escap_fnc)}function xows_xml_unesc_fnc(_){return XOWS_XML_UNESC_MAP[_]}function xows_xml_unesc(_){return _.replace(/\&\w*;/g,xows_xml_unesc_fnc)}function xows_xml_parent(_,o){if("string"==typeof o||"number"==typeof o)_.appendChild(xows_xml_doc.createTextNode(o));else if("object"==typeof o){const e=o.length;if(void 0!==e)for(let s=0;s<e;++s)xows_xml_parent(_,o[s]);else _.appendChild(o)}}function xows_xml_node(_,o,e){const s=xows_xml_doc.createElement(_);if("object"==typeof o)for(const _ in o)o.hasOwnProperty(_)&&o[_]&&s.setAttribute(_,o[_]);return e&&xows_xml_parent(s,e),s}function xows_xml_edit(_,o,e){if(node=_.querySelector(o),node){for(;node.firstChild;)node.removeChild(node.lastChild);xows_xml_parent(node,e)}else node=xows_xml_node(o,null,e);return node}function xows_xml_serialize(_){let o,e,s="<"+_.nodeName;for(e=_.attributes.length,o=0;o<e;++o)s+=" "+_.attributes[o].nodeName+'="'+_.attributes[o].nodeValue+'"';if(0!==(e=_.childNodes.length)){for(s+=">",o=0;o<e;++o)1===_.childNodes[o].nodeType?s+=xows_xml_serialize(_.childNodes[o]):s+=xows_xml_escape(_.childNodes[o].nodeValue);s+="</"+_.nodeName+">"}else s+="/>";return s}function xows_xml_parse(_){return xows_clean_dom(xows_xml_parser.parseFromString(_,"text/xml"))}function xows_xml_get_text(_){if(!_)return"";const o=_.childNodes.length;if(0===o&&3===_.nodeType)return xows_xml_unesc(_.nodeValue);let e="";for(let s=0;s<o;++s)3===_.childNodes[s].nodeType&&(e+=_.childNodes[s].nodeValue);return xows_xml_unesc(e)}let xows_sasl_data=null,xows_sasl_select="",xows_sasl_get_request=function(){return""},xows_sasl_get_response=function(_){return""},xows_sasl_chk_integrity=function(_){return!0},xows_sasl_failure_cb=function(){},xows_sasl_success_cb=function(){};function xows_sasl_get_selected(){return xows_sasl_select}function xows_sasl_plain_req(){let _=xows_sasl_data.authz+"\0";return _+=xows_sasl_data.authc+"\0",_+=xows_sasl_data.passw,xows_sasl_data={},_}function xows_sasl_plain_resp(_){return""}function xows_sasl_plain_chk(_){return!0}function xows_sasl_sha1_req(){xows_sasl_data.cnonce=xows_gen_nonce_asc(24);let _="n="+xows_sasl_data.authc;return _+=",r="+xows_sasl_data.cnonce,xows_sasl_data.client_first_message_bare=_,"n,,"+_}function xows_sasl_sha1_resp(_){let o,e,s,t,n,c,i,l=_.split(",");for(o=0,s=l.length;o<s;++o)"r"===(i=l[o].match(/([a-z]+)=(.+)/))[1]&&(t=i[2]),"s"===i[1]&&(n=i[2]),"i"===i[1]&&(c=i[2]);if(t.substr(0,24)!==xows_sasl_data.cnonce)return xows_sasl_data={},xows_log(0,"sasl_sha1_resp","SCRAM-SHA-1 challenge error","missing cnonce in server nonce"),xows_isfunc(xows_sasl_failure_cb)&&xows_sasl_failure_cb(),"";let a,r,x="c=biws,r="+t,w=xows_sasl_data.client_first_message_bare;for(w+=","+_+","+x,a=r=xows_hmac_sha1(xows_sasl_data.passw,atob(n)+"\0\0\0"),o=1;o<c;++o)for(r=xows_hmac_sha1(xows_sasl_data.passw,r),e=0;e<20;++e)a[e]^=r[e];let u=xows_hmac_sha1(a,"Client Key");const d=xows_hmac_sha1(a,"Server Key"),p=xows_hmac_sha1(xows_hash_sha1(u),w);for(e=0;e<20;e++)u[e]^=p[e];xows_sasl_data={};const m=xows_hmac_sha1(d,w);return xows_sasl_data.sproof=xows_bytes_to_b64(m),x+=",p="+xows_bytes_to_b64(u)}function xows_sasl_sha1_chk(_){const o=_.match(/(v)=(.+)/),e=xows_sasl_data.sproof;return xows_sasl_data={},e===o[2]||(xows_log(0,"sasl_sha1_chk","SCRAM-SHA-1 integrity check failed","supplied server signature mismatches the computed one"),!1)}function xows_sasl_md5_req(){return""}function xows_sasl_md5_resp(_){let o,e,s,t,n,c,i=_.split(",");for(let _=0,l=i.length;_<l;++_)"realm"===(c=i[_].match(/([a-z]+)="?([^"]+)/))[1]&&(o=c[2]),"nonce"===c[1]&&(e=c[2]),"qop"===c[1]&&(s=c[2]),"host"===c[1]&&(t=c[2]),"rspauth"===c[1]&&(n=c[2]);if(void 0!==n)return"";const l=xows_sasl_data.authc,a=xows_sasl_data.authz,r=xows_sasl_data.passw;xows_sasl_data={};let x="xmpp/"+a.split("@")[1];void 0!==t&&(x+="/"+t);const w=xows_gen_nonce_asc(24),u="00000001";let d="charset=utf-8,";return d+='username="'+l+'",',d+='realm="'+o+'",',d+='nonce="'+e+'",',d+='cnonce="'+w+'",',d+="nc="+u+",",d+='digest-uri="'+x+'",',d+='response="'+xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_str(xows_hash_md5(l+":"+o+":"+r))+":"+e+":"+w+":"+a))+":"+e+":"+u+"1:"+w+":"+s+":"+xows_bytes_to_hex(xows_hash_md5("AUTHENTICATE:"+x))))+'",',d+="qop=auth"}function xows_sasl_md5_chk(_){return!0}const xows_sasl_mechanisms=[{name:"SCRAM-SHA-1",req:xows_sasl_sha1_req,res:xows_sasl_sha1_resp,chk:xows_sasl_sha1_chk},{name:"DIGEST-MD5",req:xows_sasl_md5_req,res:xows_sasl_md5_resp,chk:xows_sasl_md5_chk},{name:"PLAIN",req:xows_sasl_plain_req,res:xows_sasl_plain_resp,chk:xows_sasl_plain_chk}];function xows_sasl_init(_,o,e,s,t,n){let c=-1;for(let o=0,e=xows_sasl_mechanisms.length;o<e;++o)if(_.includes(xows_sasl_mechanisms[o].name)){xows_sasl_select=xows_sasl_mechanisms[o].name,c=o;break}return-1!==c&&(xows_sasl_failure_cb=n,xows_sasl_success_cb=t,xows_sasl_get_request=xows_sasl_mechanisms[c].req,xows_sasl_get_response=xows_sasl_mechanisms[c].res,xows_sasl_chk_integrity=xows_sasl_mechanisms[c].chk,(xows_sasl_data={}).authz=xows_str_to_utf8(o),xows_sasl_data.authc=xows_str_to_utf8(e),xows_sasl_data.passw=xows_str_to_utf8(s),!0)}let xows_sck_sock=null,xows_sck_url=null,xows_sck_fw_onopen=function(){},xows_sck_fw_onrecv=function(){},xows_sck_fw_onclose=function(){};function xows_sck_set_callback(_,o){if(xows_isfunc(o))switch(_.toLowerCase()){case"open":xows_sck_fw_onopen=o;break;case"recv":xows_sck_fw_onrecv=o;break;case"close":xows_sck_fw_onclose=o}}function xows_sck_error(_){xows_log(0,"sck_error","Socket connection error")}function xows_sck_closed(_){if(1e3!==_.code){let o;switch(_.code){case 1001:o="Going Away";break;case 1002:o="Protocol error";break;case 1003:o="Unsupported Data";break;case 1004:o="Reserved";break;case 1005:o="No Status Rcvd";break;case 1006:o="Abnormal Closure";break;case 1007:o="Invalid frame payload data";break;case 1008:o="Policy Violation";break;case 1009:o="Message Too Big";break;case 1010:o="Mandatory Ext.";break;case 1011:o="Internal Error";break;case 1012:o="Service Restart";break;case 1013:o="Try Again Later";break;case 1014:o="Bad Gateway";break;case 1015:o="TLS handshake";break;default:o="Unhandled error ("+_.code+")"}xows_log(0,"sck_closed",o),xows_sck_fw_onclose(XOWS_SIG_ERR,"Socket connection error")}else xows_log(2,"sck_closed","socket closed"),xows_sck_fw_onclose(3);xows_sck_sock=null}function xows_sck_opened(_){xows_log(2,"sck_opened","socket connected"),xows_sck_fw_onopen()}function xows_sck_recv(_){xows_log(3,"sck_recv",_.data,null,"#AB5655"),xows_sck_fw_onrecv(_.data)}function xows_sck_create(_,o){xows_log(3,"sck_create","socket connecting",_),(xows_sck_sock=new WebSocket(xows_sck_url=_,o)).onerror=xows_sck_error,xows_sck_sock.onopen=xows_sck_opened,xows_sck_sock.onclose=xows_sck_closed,xows_sck_sock.onmessage=xows_sck_recv}function xows_sck_destroy(){null!==xows_sck_sock&&(xows_log(3,"sck_destroy","closing WebSocket"),xows_sck_sock.close(),xows_sck_sock=null)}function xows_sck_send(_){xows_log(3,"sck_send",_,null,"#55ABAB"),xows_sck_sock.send(_)}const XOWS_NS_CLIENT="jabber:client",XOWS_NS_VERSION="jabber:iq:version",XOWS_NS_ROSTER="jabber:iq:roster",XOWS_NS_REGISTER="jabber:iq:register",XOWS_NS_PRIVATE="jabber:iq:private",XOWS_NS_XDATA="jabber:x:data",XOWS_NS_PING="urn:xmpp:ping",XOWS_NS_TIME="urn:xmpp:time",XOWS_NS_DELAY="urn:xmpp:delay",XOWS_NS_CARBONS="urn:xmpp:carbons",XOWS_NS_RECEIPTS="urn:xmpp:receipts",XOWS_NS_MAM="urn:xmpp:mam",XOWS_NS_VCARD4="urn:xmpp:vcard4",XOWS_NS_AVATAR_DATA="urn:xmpp:avatar:data",XOWS_NS_AVATAR_META="urn:xmpp:avatar:metadata",XOWS_NS_MARKERS="urn:xmpp:chat-markers",XOWS_NS_HTTPUPLOAD="urn:xmpp:http:upload",XOWS_NS_BOOKMARKS="urn:xmpp:bookmarks:1",XOWS_NS_IETF_FRAMING="urn:ietf:params:xml:ns:xmpp-framing",XOWS_NS_IETF_SASL="urn:ietf:params:xml:ns:xmpp-sasl",XOWS_NS_IETF_BIND="urn:ietf:params:xml:ns:xmpp-bind",XOWS_NS_IETF_SESSION="urn:ietf:params:xml:ns:xmpp-session",XOWS_NS_IETF_VCARD4="urn:ietf:params:xml:ns:vcard-4.0",XOWS_NS_VCARD="vcard-temp",XOWS_NS_VCARDXUPDATE="vcard-temp:x:update",XOWS_NS_NICK="http://jabber.org/protocol/nick",XOWS_NS_CAPS="http://jabber.org/protocol/caps",XOWS_NS_DISCOINFO="http://jabber.org/protocol/disco#info",XOWS_NS_DISCOITEMS="http://jabber.org/protocol/disco#items",XOWS_NS_MUC="http://jabber.org/protocol/muc",XOWS_NS_MUCUSER="http://jabber.org/protocol/muc#user",XOWS_NS_MUCOWNER="http://jabber.org/protocol/muc#owner",XOWS_NS_CHATSTATES="http://jabber.org/protocol/chatstates",XOWS_NS_RSM="http://jabber.org/protocol/rsm",XOWS_NS_PUBSUB="http://jabber.org/protocol/pubsub",XOWS_NS_PUBSUBEVENT="http://jabber.org/protocol/pubsub#event",XOWS_NS_PUBSUBOPTS="http://jabber.org/protocol/pubsub#publish-options",XOWS_SHOW_OFF=-1,XOWS_SHOW_DND=0,XOWS_SHOW_XA=1,XOWS_SHOW_AWAY=2,XOWS_SHOW_ON=3,XOWS_SHOW_CHAT=4,xows_xmp_show_level_map={dnd:0,xa:1,away:2,chat:4},xows_xmp_show_name_map=["dnd","xa","away","","chat"],XOWS_SUBS_REM=-1,XOWS_SUBS_NONE=0,XOWS_SUBS_FROM=1,XOWS_SUBS_TO=2,XOWS_SUBS_BOTH=3,xows_xmp_subs_mask_map={remove:-1,none:0,from:1,to:2,both:3},XOWS_CHAT_GONE=0,XOWS_CHAT_ACTI=1,XOWS_CHAT_INAC=2,XOWS_CHAT_PAUS=3,XOWS_CHAT_COMP=4,xows_xmp_chat_mask_map={gone:0,active:1,inactive:2,paused:3,composing:4},XOWS_ROLE_NONE=0,XOWS_ROLE_VIST=1,XOWS_ROLE_PART=2,XOWS_ROLE_MODO=3,xows_xmp_role_level_map={none:0,visitor:1,participant:2,moderator:3},XOWS_AFFI_OUTC=-1,XOWS_AFFI_NONE=0,XOWS_AFFI_MEMB=1,XOWS_AFFI_ADMN=2,XOWS_AFFI_OWNR=3,xows_xmp_affi_level_map={outcast:-1,none:0,member:1,admin:2,owner:3},xows_xmp_chat_name_map=["gone","active","inactive","paused","composing"],xows_xmp_xep_ns={"urn:xmpp:carbons":null,"urn:xmpp:mam":null,"urn:xmpp:http:upload":null},xows_xmp_stream_feat=[];let xows_xmp_iq_stk=[];const xows_xmp_mam_stk=[];let xows_xmp_url=null,xows_xmp_user=null,xows_xmp_domain=null,xows_xmp_jid=null,xows_xmp_bare=null,xows_xmp_res=null,xows_xmp_auth=null,xows_xmp_auth_register=!1;function xows_xmp_use_xep(_){const o=_.match(/([a-z\:]+)(:\d|$)/);if(o[1]){let e=!1;if(o[1]in xows_xmp_xep_ns)if(o[2].length){if(null!==xows_xmp_xep_ns[o[1]]){let _=!1;if(xows_xmp_xep_ns[o[1]].length){parseInt(xows_xmp_xep_ns[o[1]].charAt(1))>=parseInt(o[2].charAt(1))&&(_=!0)}}}else null!==xows_xmp_xep_ns[o[1]]&&(e=!0);return e?(xows_log(2,"xmp_use_xep","ignoring extension",_),!1):(xows_xmp_xep_ns[o[1]]=o[2].length?o[2]:"",xows_log(2,"xmp_use_xep","use extension",_),!0)}return xows_log(1,"xmp_use_xep","unsuported extension",o[1]),!1}function xows_xmp_get_xep(_){return _ in xows_xmp_xep_ns&&xows_xmp_xep_ns[_]?_+xows_xmp_xep_ns[_]:(xows_log(1,"xmp_get_xep","unknown extension",_),null)}function xows_xmp_get_caps(){let _=XOWS_NS_VCARD4,o=XOWS_NS_AVATAR_META;return xows_options.vcard4_notify&&(_+="+notify"),xows_options.avatar_notify&&(o+="+notify"),[xows_xml_node("identity",{category:"client",name:XOWS_APP_NAME,type:"web"}),xows_xml_node("feature",{var:XOWS_NS_CAPS}),xows_xml_node("feature",{var:XOWS_NS_DISCOINFO}),xows_xml_node("feature",{var:XOWS_NS_DISCOITEMS}),xows_xml_node("feature",{var:XOWS_NS_PING}),xows_xml_node("feature",{var:XOWS_NS_TIME}),xows_xml_node("feature",{var:XOWS_NS_VERSION}),xows_xml_node("feature",{var:XOWS_NS_CHATSTATES}),xows_xml_node("feature",{var:XOWS_NS_RECEIPTS}),xows_xml_node("feature",{var:XOWS_NS_VCARD}),xows_xml_node("feature",{var:XOWS_NS_IETF_VCARD4}),xows_xml_node("feature",{var:_}),xows_xml_node("feature",{var:XOWS_NS_AVATAR_DATA}),xows_xml_node("feature",{var:o}),xows_xml_node("feature",{var:XOWS_NS_BOOKMARKS+"+notify"})]}function xows_xmp_get_caps_ver(){const _=xows_xmp_get_caps();let o,e=_.length,s="";for(o=0;o<e;++o)"identity"===_[o].tagName&&(s+=_[o].getAttribute("category")+"/",s+=_[o].getAttribute("type")+"/",s+=(_[o].hasAttribute("xml:lang")?_[o].getAttribute("xml:lang"):"")+"/",s+=_[o].getAttribute("name")+"<");for(o=0;o<e;++o)"feature"===_[o].tagName&&(s+=_[o].getAttribute("var")+"<");return xows_bytes_to_b64(xows_hash_sha1(s))}function xows_xmp_xdata_parse(_){const o=[],e=_.getElementsByTagName("field");for(let _=0,s=e.length;_<s;++_)o.push({required:null!==e[_].querySelector("required"),type:e[_].getAttribute("type"),label:e[_].getAttribute("label"),var:e[_].getAttribute("var"),value:xows_xml_get_text(e[_].querySelector("value"))});return o}function xows_xmp_xdata_make(_){const o=xows_xml_node("x",{xmlns:XOWS_NS_XDATA,type:"submit"});if(_&&_.length){let e;for(let s=0,t=_.length;s<t;++s)e=xows_xml_node("field"),_[s].var&&e.setAttribute("var",_[s].var),_[s].type&&e.setAttribute("type",_[s].type),_[s].value&&xows_xml_parent(e,xows_xml_node("value",null,_[s].value)),xows_xml_parent(o,e)}return o}let xows_xmp_fw_onsession=function(){},xows_xmp_fw_onpresence=function(){},xows_xmp_fw_onsubscrib=function(){},xows_xmp_fw_onoccupant=function(){},xows_xmp_fw_onroster=function(){},xows_xmp_fw_onmessage=function(){},xows_xmp_fw_onchatstate=function(){},xows_xmp_fw_onreceipt=function(){},xows_xmp_fw_onsubject=function(){},xows_xmp_fw_onpubsub=function(){},xows_xmp_fw_onerror=function(){},xows_xmp_fw_onclose=function(){};function xows_xmp_set_callback(_,o){if(xows_isfunc(o))switch(_.toLowerCase()){case"session":xows_xmp_fw_onsession=o;break;case"presence":xows_xmp_fw_onpresence=o;break;case"subscrib":xows_xmp_fw_onsubscrib=o;break;case"occupant":xows_xmp_fw_onoccupant=o;break;case"roster":xows_xmp_fw_onroster=o;break;case"message":xows_xmp_fw_onmessage=o;break;case"chatstate":xows_xmp_fw_onchatstate=o;break;case"receipt":xows_xmp_fw_onreceipt=o;break;case"subject":xows_xmp_fw_onsubject=o;break;case"pubsub":xows_xmp_fw_onpubsub=o;break;case"error":xows_xmp_fw_onerror=o;break;case"close":xows_xmp_fw_onclose=o}}function xows_xmp_send(_,o,e){if(!xows_sck_sock)return void xows_log(1,"xows_xmp_send","socket is closed");"presence"!==_.tagName&&"message"!==_.tagName&&"iq"!==_.tagName||_.getAttribute("xmlns")||_.setAttribute("xmlns",XOWS_NS_CLIENT);let s=_.getAttribute("id");s||(s=xows_gen_uuid(),_.setAttribute("id",s)),xows_isfunc(o)&&xows_xmp_iq_stk.push({id:s,onresult:o,onparse:e}),xows_sck_send(xows_xml_serialize(_))}function xows_xmp_error_str(_){let o;const e=_.querySelector("error");if(e){o=(o=(o=e.firstChild.tagName).replace(/-/g," "))[0].toUpperCase()+o.substring(1);const _=e.querySelector("text");_&&(o+=": "+xows_xml_get_text(_))}return o}function xows_xmp_iq_parse(_,o){let e,s,t,n;const c=_.getAttribute("id"),i=_.getAttribute("type");if("error"===i){const o=_.querySelector("error");e=o.getAttribute("type"),s=o.getAttribute("code"),t=o.firstChild.tagName,n=xows_xml_get_text(_.querySelector("text"));const i=xows_xmp_error_str(_);xows_log(1,"xmp_iq_parse","query '"+c+"' error",i),xows_xmp_fw_onerror(XOWS_SIG_ERR,i)}xows_isfunc(o)&&o(_.getAttribute("from"),i,e,s,t,n)}function xows_xmp_session_parse(_){if("error"===_.getAttribute("type")){const o="Session establishment failure";return xows_log(0,"xmp_session_parse",o,xows_xmp_error_str(_)),void xows_xmp_send_close(XOWS_SIG_ERR,o)}xows_log(2,"xmp_session_parse","session established"),xows_xmp_fw_onsession(xows_xmp_jid)}function xows_xmp_session_query(){xows_log(2,"xmp_session_query","query for session"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("session",{xmlns:XOWS_NS_IETF_SESSION})),xows_xmp_session_parse)}function xows_xmp_bind_parse(_){if("error"===_.getAttribute("type")){const o="Resource Bind failure";return xows_log(0,"xmp_bind_parse",o,xows_xmp_error_str(_)),void xows_xmp_send_close(XOWS_SIG_ERR,o)}const o=_.querySelector("jid");xows_xmp_jid=xows_xml_get_text(o),xows_xmp_res=xows_jid_to_nick(xows_xmp_jid),xows_log(2,"xmp_bind_parse","Resource Bind accepted",xows_xmp_jid),xows_xmp_stream_feat.includes(XOWS_NS_IETF_SESSION)?xows_xmp_session_query():xows_xmp_fw_onsession(xows_xmp_jid)}function xows_xmp_bind_query(){const _="xows_"+xows_gen_nonce_asc(8);xows_log(2,"xmp_bind_query","query for Resource Bind",_),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("bind",{xmlns:XOWS_NS_IETF_BIND},xows_xml_node("resource",null,_))),xows_xmp_bind_parse)}function xows_xmp_carbons_query(_,o){const e=_?"enable":"disable";xows_log(2,"xmp_carbons_query","query XEP-0280 Carbons",e);const s=xows_xmp_get_xep(XOWS_NS_CARBONS);s?xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node(e,{xmlns:s})),xows_xmp_iq_parse,o):xows_log(1,"xmp_carbons_query","XEP-0280 Carbons unavailable")}function xows_xmp_discoinfo_parse(_,o){if("error"===_.getAttribute("type"))return void xows_log(1,"xmp_discoinfo_parse","parse Disco#info",xows_xmp_error_str(_));const e=_.querySelector("query");let s,t,n;const c=[];for(s=0,t=(n=e.getElementsByTagName("identity")).length;s<t;++s)c.push({category:n[s].getAttribute("category"),type:n[s].getAttribute("type"),name:n[s].getAttribute("name")});const i=[];for(s=0,t=(n=e.getElementsByTagName("feature")).length;s<t;++s)n[s].hasAttribute("var")&&i.push(n[s].getAttribute("var"));const l=e.querySelector("x"),a=l?xows_xmp_xdata_parse(l):null;xows_isfunc(o)&&o(_.getAttribute("from"),c,i,a,e.getAttribute("node"))}function xows_xmp_discoinfo_query(_,o,e){xows_log(2,"xmp_discoinfo_query","query disco#info",_),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("query",{xmlns:XOWS_NS_DISCOINFO,node:o})),xows_xmp_discoinfo_parse,e)}function xows_xmp_discoitems_parse(_,o){if("error"===_.getAttribute("type"))return void xows_log(1,"xmp_discoitems_parse","parse Disco#items",xows_xmp_error_str(_));const e=_.getElementsByTagName("item"),s=[];for(let _=0,o=e.length;_<o;++_)s.push({jid:e[_].getAttribute("jid"),name:e[_].getAttribute("name")});xows_isfunc(o)&&o(_.getAttribute("from"),s)}function xows_xmp_discoitems_query(_,o){xows_log(2,"xmp_discoitems_query","query disco#items",_),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("query",{xmlns:XOWS_NS_DISCOITEMS})),xows_xmp_discoitems_parse,o)}function xows_xmp_roster_get_parse(_,o){if("error"===_.getAttribute("type"))return void xows_log(1,"xmp_roster_get_parse","parse get Roster",xows_xmp_error_str(_));const e=_.getElementsByTagName("item"),s=[];for(let _=0,o=e.length;_<o;++_)s.push({bare:e[_].getAttribute("jid"),name:e[_].getAttribute("name"),subs:xows_xmp_subs_mask_map[e[_].getAttribute("subscription")],group:xows_xml_get_text(e[_].querySelector("group"))});xows_isfunc(o)&&o(s)}function xows_xmp_roster_get_query(_){xows_xmp_send(xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:XOWS_NS_ROSTER})),xows_xmp_roster_get_parse,_)}function xows_xmp_roster_set_query(_,o,e,s){xows_log(2,"xmp_roster_set_query","query set Roster",_);const t=xows_xml_node("item",{jid:_});o?(t.setAttribute("name",o),e&&xows_xml_parent(t,xows_xml_node("group",null,e))):t.setAttribute("subscription","remove"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("query",{xmlns:XOWS_NS_ROSTER},t)),xows_xmp_iq_parse,s)}function xows_xmp_muc_cfg_get_parse(_,o){"error"!==_.getAttribute("type")?xows_isfunc(o)&&o(_.getAttribute("from"),xows_xmp_xdata_parse(_.querySelector("x"))):xows_log(1,"xmp_muc_cfg_get_parse","parse get MUC config",xows_xmp_error_str(_))}function xows_xmp_muc_cfg_get_guery(_,o){xows_log(2,"xmp_muc_cfg_get_guery","query get MUC config",_),xows_xmp_send(xows_xml_node("iq",{to:_,type:"get"},xows_xml_node("query",{xmlns:XOWS_NS_MUCOWNER})),xows_xmp_muc_cfg_get_parse,o)}function xows_xmp_muc_cfg_set_cancel(_,o){xows_log(2,"xmp_muc_cfg_set_cancel","cancel set MUC config",_),xows_xmp_send(xows_xml_node("iq",{to:_,type:"set"},xows_xml_node("query",{xmlns:XOWS_NS_MUCOWNER},xows_xml_node("x",{xmlns:XOWS_NS_XDATA,type:"cancel"}))),xows_xmp_iq_parse,o)}function xows_xmp_muc_cfg_set_query(_,o,e){xows_log(2,"xmp_muc_cfg_set_query","query set MUC config",_);const s=xows_xmp_xdata_make(o);xows_xmp_send(xows_xml_node("iq",{to:_,type:"set"},xows_xml_node("query",{xmlns:XOWS_NS_MUCOWNER},s)),xows_xmp_iq_parse,e)}function xows_xmp_muc_role_query(_,o,e,s,t){xows_log(2,"xmp_muc_role_set_query","query set MUC role",_);const n=s?xows_xml_node("reason",null,s):null;xows_xmp_send(xows_xml_node("iq",{to:_,type:"set"},xows_xml_node("query",{xmlns:XOWS_NS_MUCOWNER},xows_xml_node("item",{nick:o,role:e},n))),xows_xmp_iq_parse,t)}function xows_xmp_muc_affi_query(_,o,e,s,t){xows_log(2,"xmp_muc_role_set_query","query set MUC role",_);const n=s?xows_xml_node("reason",null,s):null;xows_xmp_send(xows_xml_node("iq",{to:_,type:"set"},xows_xml_node("query",{xmlns:XOWS_NS_MUCOWNER},xows_xml_node("item",{affiliation:e,jid:nick},n))),xows_xmp_iq_parse,t)}function xows_xmp_muc_destroy_query(_,o,e,s,t){xows_log(2,"xmp_muc_destroy_query","query destroy MUC room",_);const n=xows_xml_node("destroy",null,null);o&&n.setAttribute("jid",o),e&&xows_xml_parent(n,xows_xml_node("password",null,e)),s&&xows_xml_parent(n,xows_xml_node("reason",null,s)),xows_xmp_send(xows_xml_node("iq",{to:_,type:"set"},xows_xml_node("query",{xmlns:XOWS_NS_MUCOWNER},n)),xows_xmp_iq_parse,t)}function xows_xmp_pubsub_publish(_,o,e,s){xows_log(2,"xmp_pubsub_publish","publish PEP node",_);const t=[o];e&&t.push(xows_xml_node("publish-options",{node:_},xows_xmp_xdata_make([{var:"FORM_TYPE",type:"hidden",value:XOWS_NS_PUBSUBOPTS},{var:"pubsub#access_model",value:e}]))),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:XOWS_NS_PUBSUB},t)),xows_xmp_iq_parse,s)}function xows_xmp_bookmark_publish(_,o,e,s,t){const n=xows_xml_node("conference",{xmlns:XOWS_NS_BOOKMARKS,name:o,autojoin:e});s&&xows_xml_parent(n,xows_xml_node("nick",null,s));const c=xows_xml_node("publish",{node:XOWS_NS_BOOKMARKS},xows_xml_node("item",{id:_},n));xows_xmp_pubsub_publish(XOWS_NS_BOOKMARKS,c,"whitelist",t)}function xows_xmp_vcard4_publish(_,o,e){const s=xows_xml_node("publish",{node:XOWS_NS_VCARD4},xows_xml_node("item",null,xows_xml_node("vcard",{xmlns:XOWS_NS_IETF_VCARD4},_)));xows_xmp_pubsub_publish(XOWS_NS_VCARD4,s,o,e)}function xows_xmp_vcard4_get_parse(_,o){let e=null;"error"===_.getAttribute("type")?xows_log(1,"xmp_vcard4_get_parse","parse get vCard-4",xows_xmp_error_str(_)):e=_.querySelector("vcard"),xows_isfunc(o)&&o(_.getAttribute("from"),e)}function xows_xmp_vcard4_get_query(_,o){xows_log(2,"xmp_vcard4_get_query","query get vCard-4",_),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("vcard",{xmlns:XOWS_NS_IETF_VCARD4})),xows_xmp_vcard4_get_parse,o)}function xows_xmp_vcardt_set_query(_,o){xows_xmp_send(xows_xml_node("iq",{type:"set",to:xows_xmp_bare},xows_xml_node("vCard",{xmlns:XOWS_NS_VCARD},_)),xows_xmp_iq_parse,o)}function xows_xmp_vcardt_get_parse(_,o){"error"!==_.getAttribute("type")?xows_isfunc(o)&&o(_.getAttribute("from"),_.querySelector("vCard")):xows_log(1,"xmp_vcardt_get_parse","parse get vcard-Temp",xows_xmp_error_str(_))}function xows_xmp_vcardt_get_query(_,o){xows_log(2,"xmp_vcardt_get_query_","query get vcard-Temp",_);const e=xows_xml_node("iq",{type:"get"},xows_xml_node("vCard",{xmlns:XOWS_NS_VCARD}));null!==_&&e.setAttribute("to",_),xows_xmp_send(e,xows_xmp_vcardt_get_parse,o)}function xows_xmp_avat_data_publish(_,o,e,s){xows_log(2,"xmp_avat_data_publish","publish Avatar-Data",_);const t=xows_xml_node("publish",{node:XOWS_NS_AVATAR_DATA},xows_xml_node("item",{id:_},xows_xml_node("data",{xmlns:XOWS_NS_AVATAR_DATA},o)));xows_xmp_pubsub_publish(XOWS_NS_AVATAR_DATA,t,e,s)}function xows_xmp_avat_meta_publish(_,o,e,s,t,n,c){xows_log(2,"xmp_avat_meta_publish","publish Avatar-Metadata",_);const i=xows_xml_node("info",{id:_,type:o,bytes:e,width:s,height:t}),l=xows_xml_node("publish",{node:XOWS_NS_AVATAR_META},xows_xml_node("item",{id:_},xows_xml_node("metadata",{xmlns:XOWS_NS_AVATAR_META},i)));xows_xmp_pubsub_publish(XOWS_NS_AVATAR_META,l,n,c)}function xows_xmp_avat_data_get_parse(_,o){let e,s=null;"error"===_.getAttribute("type")&&xows_log(1,"xmp_avat_data_get_parse","parse get Avatar-Data",xows_xmp_error_str(_));const t=_.querySelector("item");t&&(e=t.getAttribute("id"),s=xows_xml_get_text(t.querySelector("data"))),xows_isfunc(o)&&o(_.getAttribute("from"),e,s)}function xows_xmp_avat_data_get_query(_,o,e){xows_log(2,"xmp_avat_data_get_query","query get Avatar-Data",_+" hash:"+o),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("pubsub",{xmlns:XOWS_NS_PUBSUB},xows_xml_node("items",{node:XOWS_NS_AVATAR_DATA},xows_xml_node("item",{id:o})))),xows_xmp_avat_data_get_parse,e)}function xows_xmp_avat_meta_get_parse(_,o){"error"!==_.getAttribute("type")?xows_isfunc(o)&&o(_.getAttribute("from"),_.querySelector("metadata")):xows_log(1,"xmp_avat_meta_get_parse","parse get Avatar-Metadata",xows_xmp_error_str(_))}function xows_xmp_avat_meta_get_query(_,o){xows_log(2,"xmp_avat_meta_get_query","query get Avatar-Metadata",_),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("pubsub",{xmlns:XOWS_NS_PUBSUB},xows_xml_node("items",{node:XOWS_NS_AVATAR_META}))),xows_xmp_avat_meta_get_parse,o)}function xows_xmp_nick_publish(_,o){xows_log(2,"xmp_nick_publish","publish Nickname",_);const e=xows_xml_node("publish",{node:XOWS_NS_NICK},xows_xml_node("item",null,xows_xml_node("nick",{xmlns:XOWS_NS_NICK},_)));xows_xmp_pubsub_publish(XOWS_NS_NICK,e,null,o)}function xows_xmp_nick_get_parse(_,o){"error"!==_.getAttribute("type")?xows_isfunc(o)&&o(_.getAttribute("from"),_.querySelector("nick")):xows_log(1,"xmp_nick_get_parse","parse get Nickname",xows_xmp_error_str(_))}function xows_xmp_nick_get_query(_,o){xows_log(2,"xmp_avat_data_get_query","query get Nickname",_),xows_xmp_send(xows_xml_node("iq",{type:"get",to:_},xows_xml_node("pubsub",{xmlns:XOWS_NS_PUBSUB},xows_xml_node("items",{node:XOWS_NS_NICK},xows_xml_node("item",null)))),xows_xmp_nick_get_parse,o)}function xows_xmp_register_get_parse(_,o){if("error"===_.getAttribute("type"))return void xows_log(1,"xmp_register_get_parse","parse get Register",xows_xmp_error_str(_));const e=_.querySelector("username"),s=_.querySelector("password"),t=_.querySelector("email"),n=_.querySelector("x"),c=!!_.querySelector("registered"),i=e?xows_xml_get_text(e):null,l=s?xows_xml_get_text(s):null,a=t?xows_xml_get_text(t):null,r=n?xows_xmp_xdata_parse(n):null;xows_isfunc(o)&&o(_.getAttribute("from"),c,i,l,a,r)}function xows_xmp_register_get_query(_,o){xows_log(2,"xmp_register_get_query","query get Register");const e=xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:XOWS_NS_REGISTER}));null!==_&&e.setAttribute("to",_),xows_xmp_send(e,xows_xmp_register_get_parse,o)}function xows_xmp_register_set_query(_,o,e,s,t,n){xows_log(2,"xmp_register_submit","submit Register");const c=xows_xml_node("query",{xmlns:XOWS_NS_REGISTER});null!==o&&xows_xml_parent(c,xows_xml_node("username",null,o)),null!==e&&xows_xml_parent(c,xows_xml_node("password",null,e)),null!==s&&xows_xml_parent(c,xows_xml_node("email",null,s)),null!==t&&xows_xml_parent(c,xows_xmp_xdata_make(t));const i=xows_xml_node("iq",{type:"set"},c);null!==_&&i.setAttribute("to",_),xows_xmp_send(i,xows_xmp_iq_parse,n)}const xows_xmp_mam_query_param={};function xows_xmp_mam_parse(_,o){if("error"===_.getAttribute("type"))return void xows_log(1,"xmp_mam_parse","Archive query failure",xows_xmp_error_str(_));const e=_.getAttribute("id"),s=xows_xmp_mam_query_param[e].to,t=xows_xmp_mam_query_param[e].with,n=_.querySelector("fin");if(n){let _,e,c,i,l,a,r=0;if(i="true"===n.getAttribute("complete"),(_=n.querySelector("count"))&&(r=parseInt(xows_xml_get_text(_))),!(_=n.querySelector("first")))return xows_log(2,"xmp_mam_parse","No result received"),void(xows_isfunc(o)&&o(s,t,[],r,i));e=xows_xml_get_text(_),(_=n.querySelector("last"))&&(c=xows_xml_get_text(_));const x=xows_xmp_mam_stk.length;for(l=0;l<x&&xows_xmp_mam_stk[l].page!==e;l++);if(l>=x)xows_log(0,"xmp_mam_parse","first result page not found in stack",e),a=[];else{let _=l,o=0;do{if(l===x){xows_log(1,"xmp_mam_parse","last result page not found (reached end of stack)",c);break}o++}while(xows_xmp_mam_stk[l++].page!==c);a=xows_xmp_mam_stk.splice(_,o)}xows_log(2,"xmp_mam_parse","results collected","("+a.length+"/"+r+") '"+e+"'=>'"+c+"'"),xows_isfunc(o)&&o(s,t,a,r,i)}delete xows_xmp_mam_query_param[e]}function xows_xmp_mam_query(_,o,e,s,t,n,c){const i=xows_xmp_get_xep(XOWS_NS_MAM);if(!i)return void xows_log(1,"xmp_mam_query","Message Archive Management (XEP-0313) is unavailable");const l=[];l.push({var:"FORM_TYPE",type:"hidden",value:i}),e&&l.push({var:"with",value:e}),s&&l.push({var:"start",value:new Date(s).toJSON()}),t&&l.push({var:"end",value:new Date(t).toJSON()});const a=xows_xml_node("set",{xmlns:XOWS_NS_RSM},xows_xml_node("max",null,o));!n&&s||xows_xml_parent(a,xows_xml_node("before",null,n));const r=xows_gen_uuid(),x=xows_xml_node("iq",{id:r,type:"set"},xows_xml_node("query",{xmlns:i},[xows_xmp_xdata_make(l),a]));null!==_&&x.setAttribute("to",_),xows_xmp_mam_query_param[r]={to:_,with:e},xows_log(2,"xmp_mam_query","send Archive query","with "+e+" start "+s+" end "+t),xows_xmp_send(x,xows_xmp_mam_parse,c)}function xows_xmp_upload_parse(_,o){if("error"===_.getAttribute("type")){const e=xows_xmp_error_str(_);return xows_log(1,"xmp_upload_parse","HTTP-Upload query error",e),void(xows_isfunc(o)&&o(null,null,null,e))}const e=_.querySelector("slot");if(e){let _,s,t;const n=e.querySelector("put");n&&(_=n.getAttribute("url"),t=n.getElementsByTagName("header"));const c=e.querySelector("get");c&&(s=c.getAttribute("url")),xows_log(2,"xmp_upload_parse","accepted HTTP-Upload slot",_),xows_isfunc(o)&&o(_,t,s)}}function xows_xmp_upload_query(_,o,e,s,t){const n=xows_xmp_get_xep(XOWS_NS_HTTPUPLOAD);if(!n)return void xows_log(1,"xmp_upload_query","HTTP File Upload (XEP-0363) is unvailable");xows_log(2,"xmp_upload_query","send HTTP-Upload query",e+" bytes required");let c={xmlns:n,filename:o,size:e};s&&(c.type=s),xows_xmp_send(xows_xml_node("iq",{to:_,type:"get"},xows_xml_node("request",c)),xows_xmp_upload_parse,t)}let xows_xmp_auth_sasl_mechanisms=null;function xows_xmp_auth_sasl_request(_){if(!xows_sasl_init(_,xows_xmp_bare,xows_xmp_user,xows_xmp_auth)){xows_xmp_auth=null;let _="Unable to find a suitable authentication mechanism";return xows_log(0,"xmp_auth_sasl_request",_),xows_xmp_send_close(XOWS_SIG_ERR,_),!0}xows_xmp_auth=null;const o=xows_sasl_get_selected();xows_log(2,"xmp_auth_sasl_request","select authentication mechanism",o);const e=xows_sasl_get_request();0!==e.length&&(xows_log(2,"xmp_auth_sasl_request","sending authentication request",e),xows_xmp_send(xows_xml_node("auth",{xmlns:XOWS_NS_IETF_SASL,mechanism:o},btoa(e))))}function xows_xmp_auth_register_get_parse(_,o,e,s,t,n){if(void 0!==n){let _=n.length;for(;_--;)"username"===n[_].var&&(n[_].value=xows_xmp_user),"password"===n[_].var&&(n[_].value=xows_xmp_auth)}else null!==e&&(e=xows_xmp_user),null!==s&&(s=xows_xmp_auth);xows_xmp_register_set_query(null,e,s,null,n,xows_xmp_auth_register_set_parse)}function xows_xmp_auth_register_set_parse(_,o,e,s,t,n){let c=null;"error"===o?("409"!==s&&"conflict"!==t||(c="Unsername already exists"),"406"!==s&&"not-acceptable"!==t||(c="Username contains illegal characters")):"result"===o?(xows_log(2,"xmp_auth_register_set_parse","success"),xows_xmp_auth_register=!1,xows_xmp_auth_sasl_request(xows_xmp_auth_sasl_mechanisms)):c="Unexpected registration error",null!==c&&(xows_xmp_auth=null,xows_log(0,"xmp_auth_register_set_parse",c),setTimeout(xows_xmp_send_close,xows_options.login_delay,XOWS_SIG_ERR,c))}function xows_xmp_resp_ping(_){const o=_.getAttribute("from"),e=_.getAttribute("id");xows_log(2,"xmp_resp_ping","responds to Ping",o),xows_xmp_send(xows_xml_node("iq",{id:e,to:o,type:"result"}))}function xows_xmp_resp_time(_){const o=_.getAttribute("from"),e=_.getAttribute("id"),s=new Date;let t=s.getTimezoneOffset()/60,n=t<0?"-":"";n+=((t=Math.abs(t))>9?t:"0"+t)+":00";const c=s.toJSON();xows_log(2,"xmp_resp_time","responds to Time",o),xows_xmp_send(xows_xml_node("iq",{to:o,id:e,type:"result"},xows_xml_node("time",{xmlns:XOWS_NS_TIME},[xows_xml_node("tzo",null,n),xows_xml_node("utc",null,c)])))}function xows_xmp_resp_version(_){const o=_.getAttribute("from"),e=_.getAttribute("id");xows_log(2,"xmp_resp_version","responds to Version",o),xows_xmp_send(xows_xml_node("iq",{to:o,id:e,type:"result"},xows_xml_node("query",{xmlns:XOWS_NS_VERSION},[xows_xml_node("name",null,XOWS_APP_NAME),xows_xml_node("version",null,XOWS_APP_VERS)])))}function xows_xmp_resp_discoinfo(_){const o=_.getAttribute("from"),e=_.getAttribute("id"),s=_.querySelector("query"),t=s?s.getAttribute("node"):null;xows_log(2,"xmp_resp_discoinfo","responds to disco#info",o);const n=xows_xmp_get_caps();xows_xmp_send(xows_xml_node("iq",{to:o,id:e,type:"result"},xows_xml_node("query",{xmlns:XOWS_NS_DISCOINFO,node:t},n)))}function xows_xmp_recv_open(_){let o=_.getAttribute("xmlns")===XOWS_NS_IETF_FRAMING;if(!("1.0"===_.getAttribute("version"))||!o){const _="Invalid server framing";xows_log(0,"xmp_recv_open",_),xows_xmp_send_close(XOWS_SIG_ERR,_)}return!0}function xows_xmp_recv_close(_){return xows_log(2,"xmp_recv_close","stream closed"),xows_xmp_bare?(xows_xmp_send_close(XOWS_SIG_ERR,"Server closed the stream"),xows_xmp_bare=null):(xows_sck_destroy(),xows_xmp_fw_onclose(3)),!0}function xows_xmp_recv_streamerror(_){return xows_log(0,"xmp_recv_streamerror",_.firstChild.tagName,xows_xml_get_text(_.querySelector("text"))),xows_xmp_send_close(XOWS_SIG_ERR,"Server thrown a stream error"),!0}function xows_xmp_recv_streamfeatures(_){const o=_.getElementsByTagName("mechanism");if(o.length){const e=[];for(let _=0,s=o.length;_<s;++_)e.push(xows_xml_get_text(o[_]));if(xows_log(2,"xmp_recv_streamfeatures","received authentication mechanisms",e.join(", ")),xows_xmp_auth_register){if(_.querySelector("register"))xows_xmp_auth_sasl_mechanisms=e,xows_xmp_register_get_query(null,xows_xmp_auth_register_get_parse);else{xows_xmp_auth=null;let _="Account registration is not allowed by server";xows_log(0,"xmp_recv_streamfeatures",_),xows_xmp_send_close(XOWS_SIG_ERR,_)}}else xows_xmp_auth_sasl_request(e);return!0}{let o=_.childNodes.length;for(;o--;)xows_xmp_stream_feat.push(_.childNodes[o].getAttribute("xmlns"));xows_log(2,"xmp_recv_streamfeatures","received features",xows_xmp_stream_feat.join(", ")),xows_xmp_stream_feat.includes(XOWS_NS_IETF_BIND)?xows_xmp_bind_query():xows_xmp_fw_onsession(xows_xmp_bare)}return!1}function xows_xmp_recv_challenge(_){const o=atob(xows_xml_get_text(_));xows_log(2,"xmp_recv_challenge","received authentication challenge",o);const e=xows_sasl_get_response(o);return xows_log(2,"xmp_recv_challenge","sending challenge response",e),xows_xmp_send(xows_xml_node("response",{xmlns:XOWS_NS_IETF_SASL},btoa(e))),!0}function xows_xmp_recv_failure(_){let o;const e=_.firstChild.tagName;switch(e.toLowerCase()){case"not-authorized":o="Wrong username or password";break;default:o="Authentication failure"}return xows_log(0,"xmp_recv_failure",e),setTimeout(xows_xmp_send_close,xows_options.login_delay,XOWS_SIG_ERR,o),!0}function xows_xmp_recv_success(_){const o=xows_xml_get_text(_);if(0!==o.length&&xows_log(2,"xmp_recv_success","received server proof signature",o),!xows_sasl_chk_integrity(atob(o))){const _="Server integrity check failed";return xows_log(0,"xmp_recv_success",_),xows_xmp_send_close(XOWS_SIG_ERR,_),!0}return xows_log(2,"xmp_recv_success","authentication success"),xows_xmp_send_open(),!0}function xows_xmp_recv_roster_push(_){xows_xmp_send(xows_xml_node("iq",{id:_.getAttribute("id"),type:"result"},xows_xml_node("query",{xmlns:XOWS_NS_ROSTER})));const o=_.querySelector("item"),e=o.getAttribute("jid"),s=o.getAttribute("name"),t=xows_xmp_subs_mask_map[o.getAttribute("subscription")];let n=o.querySelector("group");n=n?xows_xml_get_text(n):null,xows_log(2,"xmp_recv_roster_push","received Roster Push"),xows_xmp_fw_onroster(e,s,t,n)}function xows_xmp_recv_presence(_){const o=_.getAttribute("from");let e,s,t,n,c,i;if(_.hasAttribute("type")){const s=_.getAttribute("type");if("unavailable"===s&&(e=-1),s.includes("subscrib")){xows_log(2,"xmp_recv_presence","received subscrib",o+" type:"+s);const e=_.querySelector("nick"),t=e?xows_xml_get_text(e):null;return xows_xmp_fw_onsubscrib(o,s,t),!0}if("error"===s){const e=xows_xmp_error_str(_);return xows_log(1,"xmp_recv_presence","error",o+" - "+e),xows_xmp_fw_onerror(XOWS_SIG_ERR,e),!0}}let l,a=_.childNodes.length;for(;a--;)if(1===(l=_.childNodes[a]).nodeType)if("show"!==l.tagName)if("priority"!==l.tagName)if("status"!==l.tagName)if("c"!==l.tagName){if("x"===l.tagName){const _=l.getAttribute("xmlns");if(_===XOWS_NS_MUCUSER){const _=l.querySelector("item");c={affi:xows_xmp_affi_level_map[_.getAttribute("affiliation")],role:xows_xmp_role_level_map[_.getAttribute("role")],full:_.getAttribute("jid"),nick:_.getAttribute("nickname"),code:[]};const o=l.querySelectorAll("status");let e=o.length;for(;e--;)c.code.push(parseInt(o[e].getAttribute("code")))}_===XOWS_NS_VCARDXUPDATE&&(i=xows_xml_get_text(l.firstChild))}}else l.getAttribute("xmlns")===XOWS_NS_CAPS&&(n={node:l.getAttribute("node"),ver:l.getAttribute("ver")});else t=xows_xml_get_text(l);else s=xows_xml_get_text(l);else{const _=xows_xml_get_text(l);e=_?xows_xmp_show_level_map[_]:3}return void 0!==c?(xows_log(2,"xmp_recv_presence","received MUC presence",o),xows_xmp_fw_onoccupant(o,e,t,c,i),!0):(xows_log(2,"xmp_recv_presence","received presence",o+" show:"+e),xows_xmp_fw_onpresence(o,e,s,t,n,i),!0)}function xows_xmp_recv_mam_result(_){const o=_.getAttribute("id"),e=_.querySelector("forwarded");if(!e)return!1;let s,t,n,c,i,l;const a=e.querySelector("delay");a&&(c=new Date(a.getAttribute("stamp")).getTime());const r=e.querySelector("message");if(r){s=r.getAttribute("id"),t=r.getAttribute("from"),n=r.getAttribute("to");let _,e,a,x,w=r.childNodes.length;for(;w--;)1===(_=r.childNodes[w]).nodeType&&(e=_.getAttribute("xmlns"),a=_.tagName,e!==XOWS_NS_CHATSTATES?"body"===_.tagName&&(i=_.hasChildNodes()?xows_xml_get_text(_):""):l=a);return void 0!==i?(c||(c=new Date(0).getTime()),xows_xmp_mam_stk.push({page:o,id:s,from:t,to:n,time:c,body:i}),x="Adding archived message to result stack"):x="Skipped archived message without body",xows_log(2,"xmp_recv_mam_result",x,"from "+t+" to "+n),!0}return!1}function xows_xmp_recv_pubsub(_,o){const e=o.querySelector("items");if(!e)return!1;const s=e.getAttribute("node"),t=[];for(let _=0,o=e.childNodes.length;_<o;++_)t.push({id:e.childNodes[_].getAttribute("id"),data:e.childNodes[_].firstChild});return xows_xmp_fw_onpubsub(_,s,t),!0}function xows_xmp_recv_message(_){const o=_.getAttribute("type"),e=_.getAttribute("id"),s=_.getAttribute("from"),t=_.getAttribute("to");let n,c,i,l,a,r,x,w,u=_.childNodes.length;for(;u--;)if(1===(w=_.childNodes[u]).nodeType){if((r=w.getAttribute("xmlns"))===xows_xmp_get_xep(XOWS_NS_MAM))return xows_log(2,"xmp_recv_message","received Archive result"),xows_xmp_recv_mam_result(w);if(r===XOWS_NS_PUBSUBEVENT)return xows_log(2,"xmp_recv_message","received PubSub Event"),xows_xmp_recv_pubsub(s,w);if(r===xows_xmp_get_xep(XOWS_NS_CARBONS)){xows_log(2,"xmp_recv_message","received forwarded Carbons");const _=w.querySelector("message");return!!_&&xows_xmp_recv_message(_)}if(x=w.tagName,r===XOWS_NS_RECEIPTS)if("request"===x)xows_log(2,"xmp_recv_message","received Receipt request"),xows_xmp_send_receipt(s,e);else if("received"===x){a=w.getAttribute("id");continue}r!==XOWS_NS_CHATSTATES?r!==XOWS_NS_DELAY?"body"!==x?"subject"===x&&(c=xows_xml_get_text(w)):n=xows_xml_get_text(w):i=new Date(w.getAttribute("stamp")).getTime():l=xows_xmp_chat_mask_map[x]}let d=!1;return void 0!==l&&(xows_xmp_fw_onchatstate(e,o,s,t,l,i),d=!0),void 0!==n&&(xows_xmp_fw_onmessage(e,o,s,t,n,i),d=!0),void 0!==a&&(xows_xmp_fw_onreceipt(e,s,t,a,i),d=!0),void 0!==c&&(xows_xmp_fw_onsubject(e,s,c),d=!0),xows_log(2,"xmp_recv_message",d?"Handling message":"unhandled message","from "+s+" to "+t),d}function xows_xmp_recv_iq(_){if("get"===_.getAttribute("type")){const o=_.firstChild;if(void 0!==o){const e=o.getAttribute("xmlns");if(e===XOWS_NS_PING)return xows_xmp_resp_ping(_);if(e===XOWS_NS_TIME)return xows_xmp_resp_time(_);if(e===XOWS_NS_VERSION)return xows_xmp_resp_version(_);if(e===XOWS_NS_DISCOINFO)return xows_xmp_resp_discoinfo(_)}return!1}if("set"===_.getAttribute("type")){const o=_.firstChild;if(void 0!==o){if(o.getAttribute("xmlns")===XOWS_NS_ROSTER)return xows_xmp_recv_roster_push(_)}return!1}const o=_.getAttribute("id");let e=xows_xmp_iq_stk.length;for(;e--;)if(xows_xmp_iq_stk[e].id===o){if(xows_isfunc(xows_xmp_iq_stk[e].onresult))return xows_xmp_iq_stk[e].onresult(_,xows_xmp_iq_stk[e].onparse);xows_log(1,"xmp_recv_iq","invalid onresult callback for query",o),xows_xmp_iq_stk.splice(e,1)}return!1}function xows_xmp_send_presence(_,o,e,s,t,n,c){const i=xows_xml_node("presence");_&&i.setAttribute("to",_),o&&i.setAttribute("type",o),e>=0&&(xows_xml_parent(i,xows_xml_node("show",null,xows_xmp_show_name_map[e])),xows_xml_parent(i,xows_xml_node("priority",null,20*e)),s&&xows_xml_parent(i,xows_xml_node("status",null,s)),xows_cli_feat_srv_has(XOWS_NS_VCARD)&&xows_xml_parent(i,xows_xml_node("x",{xmlns:XOWS_NS_VCARDXUPDATE},t?xows_xml_node("photo",null,t):null)),xows_xml_parent(i,xows_xml_node("c",{xmlns:XOWS_NS_CAPS,hash:"sha-1",node:XOWS_APP_NODE,ver:xows_xmp_get_caps_ver()}))),n&&xows_xml_parent(i,xows_xml_node("x",{xmlns:XOWS_NS_MUC})),c&&xows_xml_parent(i,xows_xml_node("nick",{xmlns:XOWS_NS_NICK},c)),xows_log(2,"xmp_send_presence",o||"availability",(_||"")+"show: "+xows_xmp_show_name_map[e]),xows_xmp_send(i)}function xows_xmp_send_receipt(_,o){xows_log(2,"xmp_send_receipt","send message Receipt","received "+o+" to "+_),xows_xmp_send(xows_xml_node("message",{to:_},xows_xml_node("received",{id:o,xmlns:XOWS_NS_RECEIPTS})))}function xows_xmp_send_chatstate(_,o,e){const s=xows_xmp_chat_name_map[e];xows_log(2,"xmp_send_chatstate","send chat state",s+" to "+_),xows_xmp_send(xows_xml_node("message",{to:_,type:o},xows_xml_node(s,{xmlns:XOWS_NS_CHATSTATES})))}function xows_xmp_send_message(_,o,e,s){const t=xows_gen_uuid(),n=xows_xml_node("message",{id:t,to:o,type:_},xows_xml_node("body",null,xows_xml_escape(e)));return s&&xows_xml_parent(n,xows_xml_node("request",{xmlns:XOWS_NS_RECEIPTS})),xows_log(2,"xmp_send_message","send message","type "+_+" to "+o),xows_xmp_send(n),t}function xows_xmp_send_subject(_,o){const e=xows_gen_uuid();return xows_log(2,"xmp_send_subject","send subject to",_),xows_xmp_send(xows_xml_node("message",{id:e,to:_,type:"groupchat"},xows_xml_node("subject",null,xows_xml_escape(o)))),e}function xows_xmp_send_close(_,o){xows_log(2,"xmp_send_close","saying goodbye"),xows_xmp_send(xows_xml_node("close",{xmlns:XOWS_NS_IETF_FRAMING,id:"_ciao"})),xows_xmp_bare=null,o&&xows_xmp_fw_onclose(_,o)}function xows_xmp_send_open(){xows_log(2,"xmp_send_open","send stream open request",XOWS_NS_IETF_FRAMING),xows_xmp_send(xows_xml_node("open",{to:xows_xmp_domain,version:"1.0",xmlns:XOWS_NS_IETF_FRAMING}))}function xows_xmp_sck_onopen(){xows_xmp_send_open()}function xows_xmp_sck_onclose(_,o){xows_xmp_bare&&(xows_xmp_bare=null,xows_xmp_fw_onclose(_,o))}function xows_xmp_sck_onrecv(_){const o=xows_xml_parse(_).firstChild,e=o.tagName;return"iq"===e?xows_xmp_recv_iq(o):"message"===e?xows_xmp_recv_message(o):"presence"===e?xows_xmp_recv_presence(o):"open"===e?xows_xmp_recv_open(o):"close"===e?xows_xmp_recv_close(o):"stream:error"===e?xows_xmp_recv_streamerror(o):"stream:features"===e?xows_xmp_recv_streamfeatures(o):"challenge"===e?xows_xmp_recv_challenge(o):"success"===e?xows_xmp_recv_success(o):"failure"===e?xows_xmp_recv_failure(o):void xows_log(1,"xmp_recv","unprocessed stanza",event.data)}function xows_xmp_connect(_,o,e,s){xows_sck_destroy(),xows_xmp_res=null,xows_xmp_jid=null;const t=o.split("@");if(xows_xmp_domain=null,void 0!==t[1]&&0!==t[1].length&&(xows_xmp_domain=t[1]),null===xows_xmp_domain){let _="Incomplete JID (undefined domain)";return xows_log(0,"xmp_connect",_),void xows_xmp_fw_onclose(XOWS_SIG_ERR,_)}xows_xmp_bare=o,xows_xmp_user=t[0],xows_xmp_auth=e,xows_sck_set_callback("open",xows_xmp_sck_onopen),xows_sck_set_callback("recv",xows_xmp_sck_onrecv),xows_sck_set_callback("close",xows_xmp_sck_onclose),xows_xmp_auth_register=s,xows_xmp_url=_,xows_sck_create(_,"xmpp")}const xows_cach_avat_db={};function xows_cach_avat_save(_,o,e){const s=o||xows_bytes_to_hex(xows_hash_sha1(xows_url_to_bytes(_)));return xows_cach_avat_db[s]=_,e||localStorage.setItem(s,_),s}function xows_cach_avat_has(_){return _ in xows_cach_avat_db||_ in localStorage}function xows_cach_avat_get(_){return _ in xows_cach_avat_db?xows_cach_avat_db[_]:_ in localStorage?(xows_cach_avat_db[_]=localStorage.getItem(_),xows_cach_avat_db[_]):null}const xows_cach_peer_db={};function xows_cach_peer_save(_,o,e,s){let t=null;if(o&&e&&s)t={name:o,avat:e,desc:s};else{try{t=JSON.parse(localStorage.getItem(_))}catch(_){xows_log(1,"cli_cache_peer_add","JSON parse error",_)}null!==t?(o&&(t.name=o),e&&(t.avat=e),s&&(t.desc=s)):t={name:o,avat:e,desc:s}}xows_cach_peer_db[_]=t,localStorage.setItem(_,JSON.stringify(t))}function xows_cach_peer_has(_){return _ in xows_cach_peer_db||_ in localStorage}function xows_cach_peer_get(_){if(_ in xows_cach_peer_db)return xows_cach_peer_db[_];if(_ in localStorage){try{xows_cach_peer_db[_]=JSON.parse(localStorage.getItem(_))}catch(o){return xows_log(1,"cli_cache_peer_get","JSON parse error",o),localStorage.removeItem(_),null}return xows_cach_peer_db[_]}return null}const xows_cach_caps_db={};function xows_cach_caps_save(_,o){xows_cach_caps_db[_]=o,localStorage.setItem(_,JSON.stringify(o))}function xows_cach_caps_has(_){return _ in xows_cach_caps_db||_ in localStorage}function xows_cach_caps_get(_){if(_ in xows_cli_cache_caps_db)return xows_cli_cache_caps_db[_];if(_ in localStorage){try{xows_cach_caps_db[_]=JSON.parse(localStorage.getItem(_))}catch(o){return xows_log(1,"cli_cache_caps_get","JSON parse error",o),localStorage.removeItem(_),null}return xows_cach_caps_db[_]}return null}const XOWS_PEER_NONE=0,XOWS_PEER_CONT=1,XOWS_PEER_ROOM=2,XOWS_PEER_OCCU=3,XOWS_AVAT_SIZE=48,xows_cli_feat_own=[],xows_cli_feat_srv=[];function xows_cli_feat_own_has(_){return xows_cli_feat_own.includes(_)}function xows_cli_feat_srv_has(_){return xows_cli_feat_srv.includes(_)}const xows_cli_svc_url={};function xows_cli_svc_exist(_){return _ in xows_cli_svc_url}let xows_cli_fw_onconnect=function(){},xows_cli_fw_onselfchange=function(){},xows_cli_fw_oncontpush=function(){},xows_cli_fw_oncontrem=function(){},xows_cli_fw_onsubspush=function(){},xows_cli_fw_onsubsrem=function(){},xows_cli_fw_onroompush=function(){},xows_cli_fw_onoccupush=function(){},xows_cli_fw_onoccurem=function(){},xows_cli_fw_onmessage=function(){},xows_cli_fw_onchatstate=function(){},xows_cli_fw_onreceipt=function(){},xows_cli_fw_onsubject=function(){},xows_cli_fw_onerror=function(){},xows_cli_fw_onclose=function(){},xows_cli_self={jid:null,bare:null,name:null,avat:null,show:-1,stat:null,vcrd:null};function xows_cli_isself(_){return _.includes(xows_cli_self.bare)}Object.defineProperty(xows_cli_self,"type",{value:XOWS_PEER_CONT,writable:!1}),Object.seal(xows_cli_self);const xows_cli_cont=[];function xows_cli_cont_new(_,o,e,s){const t={bare:_,lock:_,name:o||_,subs:e,ress:{},avat:s,show:-1,stat:"",noti:!0};return Object.defineProperty(t,"type",{value:XOWS_PEER_CONT,writable:!1}),Object.seal(t),xows_cli_cont.push(t),t}function xows_cli_cont_get(_){const o=xows_jid_to_bare(_);let e=xows_cli_cont.length;for(;e--;)if(xows_cli_cont[e].bare===o)return xows_cli_cont[e];return null}const xows_cli_room=[];function xows_cli_room_new(_,o,e,s){const t={bare:_,name:o,desc:e,subj:"",priv:s,join:null,role:0,affi:0,occu:[],noti:!0,init:!1};return Object.defineProperty(t,"type",{value:XOWS_PEER_ROOM,writable:!1}),Object.seal(t),xows_cli_room.push(t),t}function xows_cli_room_get(_){const o=xows_jid_to_bare(_);let e=xows_cli_room.length;for(;e--;)if(xows_cli_room[e].bare===o)return xows_cli_room[e];return null}function xows_cli_occu_new(_,o,e,s,t,n,c,i){const l={jid:o,name:xows_jid_to_nick(o),affi:e,role:s,full:t,bare:t?xows_jid_to_bare(t):null,avat:n,show:c,stat:i,self:!!t&&xows_cli_isself(t)};return Object.defineProperty(l,"type",{value:XOWS_PEER_OCCU,writable:!1}),Object.seal(l),_.occu.push(l),l}function xows_cli_occu_get(_,o){let e=_.occu.length;for(;e--;)if(_.occu[e].jid===o)return _.occu[e];return null}function xows_cli_occu_any(_,o){let e=_.occu.length;for(;e--;)if(_.occu[e].jid===o)return _.occu[e];const s=xows_cach_peer_get(o);return xows_cli_occu_new(_,o,null,null,null,s?s.avat:xows_cli_avat_temp(o),0,"")}function xows_cli_peer_get(_){const o=xows_jid_to_bare(_);let e=xows_cli_room.length;for(;e--;)if(xows_cli_room[e].bare===o)return xows_cli_room[e];for(e=xows_cli_cont.length;e--;)if(xows_cli_cont[e].bare===o)return xows_cli_cont[e];return null}function xows_cli_peer_update(_,o,e,s){if(!_||xows_cli_isself(_))xows_log(2,"cli_peer_update","received own profile data"),xows_cach_peer_save(xows_cli_self.bare,o,e,s),o&&(xows_cli_self.name=o),e&&(xows_cli_self.avat=e),s&&(xows_cli_self.stat=s),xows_cli_fw_onselfchange(xows_cli_self),(e||s)&&xows_cli_presence_update();else{const t=xows_cli_peer_get(_);if(!t)return void xows_log(1,"cli_peer_update","unknown/unsubscribed peer",_);if(xows_log(2,"cli_peer_update","received profile data for",_),(e||t.type===XOWS_PEER_CONT)&&xows_cach_peer_save(_,o,e,s),t.type===XOWS_PEER_CONT)o&&(t.name=o),e&&(t.avat=e),s&&(t.stat=s),xows_cli_fw_oncontpush(t);else{const s=xows_cli_occu_get(t,_);s&&(o&&(s.name=o),e&&(s.avat=e),xows_cli_fw_onoccupush(t,s))}}}function xows_cli_set_callback(_,o){if(xows_isfunc(o))switch(_.toLowerCase()){case"connect":xows_cli_fw_onconnect=o;break;case"selfchange":xows_cli_fw_onselfchange=o;break;case"contpush":xows_cli_fw_oncontpush=o;break;case"contrem":xows_cli_fw_oncontrem=o;break;case"subspush":xows_cli_fw_onsubspush=o;break;case"subsrem":xows_cli_fw_onsubsrem=o;break;case"roompush":xows_cli_fw_onroompush=o;break;case"occupush":xows_cli_fw_onoccupush=o;break;case"occurem":xows_cli_fw_onoccurem=o;break;case"message":xows_cli_fw_onmessage=o;break;case"chatstate":xows_cli_fw_onchatstate=o;break;case"receipt":xows_cli_fw_onreceipt=o;break;case"subject":xows_cli_fw_onsubject=o;break;case"error":xows_cli_fw_onerror=o;break;case"close":xows_cli_fw_onclose=o}}let xows_cli_initialize=!0;function xows_cli_connect(_,o,e,s){xows_cli_cont.length=0,xows_cli_room.length=0,xows_cli_feat_own.length=0,xows_cli_feat_srv.length=0;for(const _ in xows_cli_svc_url)delete xows_cli_svc_url[_];return xows_cli_self.jid=null,xows_cli_self.bare=null,xows_cli_self.name=null,xows_cli_self.avat=null,xows_cli_self.stat=null,xows_cli_self.vcrd=null,xows_cli_activity_stop(),xows_xmp_set_callback("session",xows_cli_xmp_onsession),xows_xmp_set_callback("presence",xows_cli_xmp_onpresence),xows_xmp_set_callback("subscrib",xows_cli_xmp_onsubscribe),xows_xmp_set_callback("occupant",xows_cli_xmp_onoccupant),xows_xmp_set_callback("roster",xows_cli_xmp_onroster),xows_xmp_set_callback("message",xows_cli_xmp_onmessage),xows_xmp_set_callback("chatstate",xows_cli_xmp_onchatstate),xows_xmp_set_callback("receipt",xows_cli_xmp_onreceipt),xows_xmp_set_callback("subject",xows_cli_xmp_onsubject),xows_xmp_set_callback("pubsub",xows_cli_xmp_onpubsub),xows_xmp_set_callback("error",xows_cli_xmp_onerror),xows_xmp_set_callback("close",xows_cli_xmp_onclose),xows_cli_initialize=!0,xows_xmp_connect(_,o,e,s)}function xows_cli_xmp_onsession(_){xows_cli_self.jid=_,xows_cli_self.bare=xows_jid_to_bare(_);const o=xows_cach_peer_get(xows_cli_self.bare);if(null!==o&&(o.name&&(xows_cli_self.name=o.name),o.avat&&(xows_cli_self.avat=o.avat),o.desc&&(xows_cli_self.stat=o.desc)),null===xows_cli_self.name){const _=xows_xmp_bare.split("@")[0];xows_cli_self.name=_[0].toUpperCase()+_.slice(1)}xows_cli_self.avat||(xows_cli_self.avat=xows_cli_avat_temp(xows_cli_self.bare)),xows_xmp_discoinfo_query(xows_cli_self.bare,null,xows_cli_own_info_parse)}function xows_cli_xmp_onclose(_,o){xows_cli_self.jid&&(xows_cli_cont.length=0,xows_cli_room.length=0,xows_cli_self.jid=null,xows_cli_self.bare=null,xows_cli_self.name=null,xows_cli_self.avat=null,xows_cli_self.stat=null,xows_cli_self.vcrd=null,xows_cli_activity_stop()),xows_cli_fw_onclose(_,o)}function xows_cli_xmp_onerror(_,o){xows_cli_fw_onerror(_,o)}function xows_cli_own_info_parse(_,o,e){for(let _=0,o=e.length;_<o;++_)xows_cli_feat_own.push(e[_]),e[_].includes(XOWS_NS_MAM)&&xows_xmp_use_xep(e[_]);xows_xmp_discoinfo_query(xows_xmp_domain,null,xows_cli_srv_info_parse)}function xows_cli_srv_info_parse(_,o,e){for(let _=0,o=e.length;_<o;++_)xows_cli_feat_srv.push(e[_]),e[_].includes(XOWS_NS_CARBONS)&&xows_xmp_use_xep(e[_])&&xows_xmp_carbons_query(!0),e[_].includes(XOWS_NS_HTTPUPLOAD)&&xows_xmp_use_xep(e[_]),e[_].includes(XOWS_NS_MUC)&&xows_xmp_use_xep(e[_]);xows_xmp_discoitems_query(xows_xmp_domain,xows_cli_srv_items_parse)}const xows_cli_srv_items_stack=[];function xows_cli_srv_items_parse(_,o){if(!o.length)return void xows_cli_rost_get_query();xows_cli_srv_items_stack.length=0;let e=o.length;for(;e--;)xows_cli_srv_items_stack.push(o[e].jid);xows_xmp_discoinfo_query(xows_cli_srv_items_stack.pop(),null,xows_cli_srv_item_info_parse)}function xows_cli_srv_item_info_parse(_,o,e){const s=o[0].category,t=o[0].type;let n;if(xows_log(2,"cli_srv_item_info_parse","discover service features",_+": "+s+", "+t+', "'+o[0].name+'"'),"store"===s&&"file"===t)for(n=e.length;n--;)e[n].includes(XOWS_NS_HTTPUPLOAD)&&(xows_xmp_use_xep(e[n]),xows_cli_svc_url[XOWS_NS_HTTPUPLOAD]=_,xows_log(2,"cli_srv_item_info_parse","use service for Http-Upload",_));if("conference"===s&&"text"===t)for(n=e.length;n--;)e[n]===XOWS_NS_MUC&&(xows_cli_svc_url[XOWS_NS_MUC]=_,xows_log(2,"cli_srv_item_info_parse","use service for Multi-User Chat",_));xows_cli_srv_items_stack.length?xows_xmp_discoinfo_query(xows_cli_srv_items_stack.pop(),null,xows_cli_srv_item_info_parse):xows_cli_rost_get_query()}function xows_cli_rost_update(_,o,e,s){if(e<0){xows_log(2,"cli_roster_update","Roster update",_+' "'+o+'" subscription: '+e);let s=xows_cli_cont.length;for(;s--;)if(xows_cli_cont[s].bare===_){xows_log(2,"cli_roster_update","removing Contact",_),xows_cli_cont.splice(s,1),xows_cli_fw_oncontrem(_);break}return}xows_log(2,"cli_roster_update","update Contact",_+' "'+o+'" subscription: '+e);let t=xows_cli_cont_get(_);if(null!==t)t.name=o||_,t.subs=e;else{let s=null;const n=xows_cach_peer_get(_);null!==n&&(o=n.name,s=n.avat),s||(s=xows_cli_avat_temp(_)),t=xows_cli_cont_new(_,o,e,s)}xows_options.avatar_notify||xows_cli_avat_meta_query(_),xows_cli_nick_query(_),xows_cli_fw_oncontpush(t)}function xows_cli_rost_get_parse(_){if(xows_cli_cont.length=0,_.length)for(let o=0,e=_.length;o<e;++o)xows_cli_rost_update(_[o].bare,_[o].name,_[o].subs,_[o].group);else xows_cli_fw_oncontpush(null);xows_cli_initialize&&xows_cli_presence_init()}function xows_cli_rost_get_query(){xows_xmp_roster_get_query(xows_cli_rost_get_parse)}function xows_cli_rost_edit(_,o){xows_log(2,"cli_roster_edit",(o?"add":"remove")+" contact",_),xows_xmp_roster_set_query(_,o,null,null),o&&(xows_log(2,"cli_roster_edit","request subscribe to",_),xows_xmp_send_presence(_,"subscribe"))}function xows_cli_vcard_query(_){xows_log(2,"cli_vcard_query","query vCard for",_),xows_cli_feat_own_has(XOWS_NS_IETF_VCARD4)&&!xows_options.legacy_vcard?xows_xmp_vcard4_get_query(_,xows_cli_vcard_parse):xows_xmp_vcardt_get_query(_,xows_cli_vcard_parse)}let xows_cli_vcard_own=null;function xows_cli_vcard_parse(_,o){let e,s,t;if(xows_log(2,"cli_vcard_handle","parse recevied vCard",_),o){let _;if(xows_cli_self.vcrd=o,xows_cli_feat_own_has(XOWS_NS_IETF_VCARD4)&&!xows_options.legacy_vcard)(_=o.querySelector("nickname"))&&(e=xows_xml_get_text(_.firstChild)),(_=o.querySelector("note"))&&(s=xows_xml_get_text(_.firstChild)),(_=o.querySelector("photo"))&&(t=xows_xml_get_text(_.firstChild));else if((_=o.querySelector("NICKNAME"))&&(e=xows_xml_get_text(_)),(_=o.querySelector("NOTE"))?s=xows_xml_get_text(_):(_=o.querySelector("DESC"))&&(s=xows_xml_get_text(_)),_=o.querySelector("PHOTO")){t="data:"+xows_xml_get_text(_.querySelector("TYPE"))+";base64,"+xows_xml_get_text(_.querySelector("BINVAL"))}e&&!e.length&&(e=null),s&&!s.length&&(s=null),t&&!t.length&&(t=null)}xows_cli_peer_update(_,e,t?xows_cach_avat_save(t):null,s)}function xows_cli_vcard_publish(_){const o=xows_cach_avat_get(xows_cli_self.avat);xows_cli_self.vcrd||(xows_cli_self.vcrd=xows_xml_node("vcard"));const e=xows_cli_self.vcrd;if(xows_cli_feat_own_has(XOWS_NS_IETF_VCARD4)&&!xows_options.legacy_vcard)xows_xml_edit(e,"nickname",xows_xml_node("text",null,xows_cli_self.name)),xows_xml_edit(e,"note",xows_xml_node("text",null,xows_cli_self.stat)),o&&xows_xml_edit(e,"photo",xows_xml_node("uri",null,o));else if(xows_xml_edit(e,"NICKNAME",xows_cli_self.name),xows_xml_edit(e,"DESC",xows_cli_self.stat),o){const _=xows_url_to_type(o),s=xows_url_to_data(o);xows_xml_edit(e,"PHOTO",[xows_xml_node("TYPE",null,_),xows_xml_node("BINVAL",null,s)])}xows_log(2,"cli_vcard_publish","publish own vCard");const s=[];for(let _=0,o=e.childNodes.length;_<o;++_)s.push(e.childNodes[_].cloneNode(!0));xows_cli_feat_own_has(XOWS_NS_IETF_VCARD4)&&!xows_options.legacy_vcard?xows_xmp_vcard4_publish(s,_?"open":"presence"):xows_xmp_vcardt_set_query(s)}const xows_cli_avat_meta_queue={};function xows_cli_avat_data_parse(_,o,e){let s=null;if(e){if(xows_log(2,"cli_avat_data_handle","handle received Avatar-Data",o),!(o in xows_cli_avat_meta_queue))return void xows_log(1,"cli_avat_data_handle","received Avatar-Data without Metadata",o);s=xows_cach_avat_save("data:"+xows_cli_avat_meta_queue[o].type+";base64,"+e,o),delete xows_cli_avat_meta_queue[o]}else xows_log(2,"cli_avat_data_handle","handle cached Avatar-Data",o),s=o;xows_cli_peer_update(_,null,s,null)}function xows_cli_avat_meta_parse(_,o){if(o){const e=o.querySelector("info");if(e){const o=e.getAttribute("id");xows_cli_avat_meta_queue[o]={type:e.getAttribute("type"),width:e.getAttribute("width"),height:e.getAttribute("height"),bytes:e.getAttribute("bytes")},xows_cach_avat_has(o)?(xows_log(2,"cli_avat_meta_parse","Avatar-Data already cached",o),xows_cli_avat_data_parse(_,o,null)):(xows_log(2,"cli_avat_meta_parse","Avatar-Data unavailable",o),xows_xmp_avat_data_get_query(_,o,xows_cli_avat_data_parse))}}}function xows_cli_avat_meta_query(_){xows_log(2,"cli_avat_meta_query","query Avatar-Metadata",_),xows_xmp_avat_meta_get_query(_,xows_cli_avat_meta_parse)}let xows_cli_avat_publish_temp=null;function xows_cli_avat_meta_publish(_=null,o="result"){if("result"===o)if(xows_log(2,"cli_avat_meta_publish","Avatar-Data publication succeed","now publish Metadata"),xows_cli_avat_publish_temp){const _=xows_cli_avat_publish_temp.open,o=xows_cli_avat_publish_temp.hash,e=xows_cli_avat_publish_temp.type,s=xows_cli_avat_publish_temp.bytes;xows_xmp_avat_meta_publish(o,e,s,XOWS_AVAT_SIZE,XOWS_AVAT_SIZE,_?"open":"presence",null),xows_log(2,"cli_avat_meta_publish","publish Avatar-Metadata","id:"+o+" bytes:"+s)}else xows_log(1,"cli_avat_meta_publish","no temp Metadata stored");xows_cli_avat_publish_temp=null}function xows_cli_avat_data_publish(_){const o=xows_cach_avat_get(xows_cli_self.avat);if(o){const e=xows_url_to_data(o),s=xows_url_to_type(o),t=atob(e),n=xows_bytes_to_hex(xows_hash_sha1(t));xows_cli_avat_publish_temp={open:_,hash:n,type:s,bytes:t.length},xows_log(2,"cli_avat_data_publish","publish Avatar-Data",n),xows_xmp_avat_data_publish(n,e,_?"open":"presence",xows_cli_avat_meta_publish)}else xows_log(1,"cli_avat_data_publish","no Data to publish")}function xows_cli_avat_temp(_){let o;return o=_.includes("/")?xows_jid_to_nick(_).toLowerCase():xows_jid_to_user(_),xows_cach_avat_save(xows_gen_avatar(XOWS_AVAT_SIZE,null,o),null,!0)}function xows_cli_nick_parse(_,o){xows_log(2,"cli_nick_parse","parse received Nickname",_),xows_cli_peer_update(_,xows_xml_get_text(o),null,null)}function xows_cli_nick_query(_){xows_log(2,"cli_nick_query","query nickname",_),xows_xmp_nick_get_query(_,xows_cli_nick_parse)}function xows_cli_nick_publish(){xows_log(2,"cli_nick_publish","publish own Nickname",xows_cli_self.name),xows_xmp_nick_publish(xows_cli_self.name)}function xows_cli_xmp_onroster(_,o,e,s){xows_cli_rost_update(_,o,e,s)}function xows_cli_xmp_onsubscribe(_,o,e){let s;switch(o){case"subscribe":s="request";break;case"unsubscribed":s="denied";break;case"subscribed":s="allowed";break;case"unsubscribe":s="removed"}if(xows_log(2,"cli_xmp_onsubscribe","Subscription "+s+" by",_),"subscribe"===o){const o=xows_cli_cont_get(_);o?(xows_log(2,"cli_xmp_onsubscribe","request automatically allowed","Contact in Roster"),xows_cli_subscribe_allow(o.bare,!0,e)):xows_cli_fw_onsubspush(xows_jid_to_bare(_),e)}}function xows_cli_xmp_onpresence(_,o,e,s,t,n){const c=xows_cli_cont_get(_);if(!c)return void(xows_jid_to_bare(_)!==xows_xmp_bare&&xows_log(1,"cli_xmp_onpresence","unknown/unsubscribed Contact",_));c.lock=c.bare;let i=xows_jid_to_nick(_);if(o>=0){if(c.ress[i])xows_log(2,"cli_xmp_onpresence","updating Resource for "+c.bare,i),c.ress[i].show=o,c.ress[i].prio=e,c.ress[i].stat=s;else if(xows_log(2,"cli_xmp_onpresence","adding Resource for "+c.bare,i),c.ress[i]={show:o,prio:e,stat:s,node:null},t){const o=t.node+"#"+t.ver;c.ress[i].node=o,xows_cach_caps_has(o)||(xows_log(2,"cli_xmp_onpresence","query entity caps for "+c.bare,o),xows_xmp_discoinfo_query(_,o,xows_cli_entity_caps_parse))}}else c.ress[i]&&(xows_log(2,"cli_xmp_onpresence","removing Resource for "+c.bare,i),delete c.ress[i]);c.show=-1,c.stat=null;let l=-128;for(const _ in c.ress)c.ress.hasOwnProperty(_)&&c.ress[_].prio>l&&(l=c.ress[_].prio,c.show=c.ress[_].show,c.stat=c.ress[_].stat);xows_log(2,"cli_xmp_onpresence","updated Presence for "+c.bare,"show:"+c.show+" stat:"+c.stat),n&&(xows_cach_avat_has(n)?c.avat=n:xows_cli_vcard_query(c.bare)),xows_cach_peer_save(c.bare,null,null,c.stat),xows_cli_fw_oncontpush(c)}function xows_cli_xmp_onoccupant(_,o,e,s,t){let n=xows_cli_room_get(_);if(!n){const o=xows_jid_to_bare(_),e=xows_jid_to_user(o);n=xows_cli_room_new(o,e,"",!1),xows_log(2,"cli_xmp_onoccupant","add unexisting Room",e+" ("+o+")"),xows_cli_fw_onroompush(n)}for(let e=0,t=s.code.length;e<t;++e)if(110!==s.code[e])201===s.code[e]&&(n.init=!0),s.code[e];else{if(!(o>=0))return n.join=null,xows_log(2,"cli_xmp_onoccupant","leaving Room",n.bare),void xows_cli_fw_onoccurem(n,null);n.join=_}if(o<0){let o=n.occu.length;for(;o--;)if(n.occu[o].jid===_){n.occu.splice(o,1);break}return void xows_cli_fw_onoccurem(n,_)}const c=xows_jid_to_nick(_),i=s.full?xows_jid_to_bare(s.full):null;let l=xows_cli_occu_get(n,_);if(l)xows_log(2,"cli_xmp_onoccupant","refresh Occupant of "+n.bare,c),l.full=s.full,l.bare=i,l.affi=s.affi,l.role=s.role,l.show=o,l.stat=e;else{xows_log(2,"cli_xmp_onoccupant","adding Occupant to "+n.bare,c);let t=null;i&&(t=xows_cach_peer_get(i)),t||(t=xows_cach_peer_get(_));const a=t&&t.avat?t.avat:null;l=xows_cli_occu_new(n,_,s.affi,s.role,s.full,a,o,e)}l.self&&(n.affi=s.affi,n.role=s.role),t?xows_cach_avat_has(t)?l.avat=t:xows_cli_vcard_query(_):l.avat||xows_cli_avat_meta_query(_),xows_cach_peer_save(_,l.name,l.avat,null),xows_cli_fw_onoccupush(n,l,s.code)}function xows_cli_entity_caps_parse(_,o,e,s,t){xows_cach_caps_has(t)?xows_log(2,"cli_entity_caps_parse","node already cached",t):(xows_log(2,"cli_entity_caps_parse","caching entity caps",t),xows_cach_caps_save(t,e))}function xows_cli_entity_caps_test(_,o){const e=xows_cach_caps_get(_);return e&&e.includes(o)}function xows_cli_xmp_onchatstate(_,o,e,s,t,n){if("chat"!==o&&"groupchat"!==o)return void xows_log(1,"cli_xmp_onchatstate","invalid message type",o);let c;if("chat"===o){if(xows_cli_isself(e))return void xows_log(2,"cli_xmp_onchatstate","carbons chat state ignored",e);c=xows_cli_cont_get(e)}else if((c=xows_cli_room_get(e)).join===e)return void xows_log(2,"cli_xmp_onchatstate","echo chat state ignored",e);c?(c.type===XOWS_PEER_CONT&&(c.lock=e,c.chat=t),xows_log(2,"cli_xmp_onchatstate","chat state",e+" "+t),xows_cli_fw_onchatstate(c,e,t)):xows_log(1,"cli_xmp_onchatstate","unknown/unsubscribed JID",e)}function xows_cli_xmp_onmessage(_,o,e,s,t,n){if("chat"!==o&&"groupchat"!==o)return void xows_log(1,"cli_xmp_onmessage","invalid message type",o);let c,i,l;"chat"===o?(i=xows_cli_cont_get((c=xows_cli_isself(e))?s:e),l=c?xows_cli_self:i):l=(c=e===(i=xows_cli_room_get(e)).join)?xows_cli_self:xows_cli_occu_any(i,e),i?(n||(n=(new Date).getTime()),i.type===XOWS_PEER_CONT&&(c||(i.lock=e)),xows_log(2,"cli_xmp_onmessage","chat message",e+' "'+t+'"'),xows_cli_fw_onmessage(i,_,e,t,n,c,!0,l)):xows_log(1,"cli_xmp_onmessage","unknown/unsubscribed JID",e)}function xows_cli_xmp_onsubject(_,o,e){const s=xows_cli_room_get(o);s?(s.subj=e,xows_log(2,"cli_xmp_onsubject","room subject",o+' "'+e+'"'),xows_cli_fw_onsubject(s,e)):xows_log(1,"cli_xmp_onsubject","unknown/unsubscribed JID",o)}function xows_cli_xmp_onreceipt(_,o,e,s,t){let n;xows_cli_isself(o)?xows_log(2,"cli_xmp_onreceipt","receipt from other Resource ignored",o):(n=xows_cli_peer_get(o))?(xows_log(2,"cli_xmp_onreceipt","message receipt received",o+" "+s),xows_cli_fw_onreceipt(n,s)):xows_log(1,"cli_xmp_onreceipt","unknown/unsubscribed JID",o)}function xows_cli_xmp_onpubsub(_,o,e){o===XOWS_NS_VCARD4&&e.length&&(xows_log(2,"cli_xmp_onpubsub","received vCard notification",_),xows_cli_vcard_parse(_,e[0].data)),o===XOWS_NS_AVATAR_META&&e.length&&(xows_log(2,"cli_xmp_onpubsub","received Avatar notification",_),xows_cli_avat_meta_parse(_,e[0].data)),o===XOWS_NS_NICK&&e.length&&(xows_log(2,"cli_xmp_onpubsub","received Nickname notification",_),xows_cli_nick_parse(_,e[0].data)),o===XOWS_NS_BOOKMARKS&&e.length&&(xows_log(2,"cli_xmp_onpubsub","received Bookmarks notification",_),xows_cli_favs_parse(_,e[0].data))}let xows_cli_mam_cb=null;function xows_cli_mam_parse(_,o,e,s,t){const n=xows_cli_peer_get(_||o);if(!n)return void xows_log(1,"cli_mam_parse","unknown/unsubscribed JID",_||o);let c=e.length;if(n.type===XOWS_PEER_CONT)for(;c--;)e[c].sent=xows_cli_isself(e[c].from),e[c].sndr=e[c].sent?xows_cli_self:n;else{let _,o;for(;c--;)_=e[c].from,e[c].sent=_===n.join,o=e[c].sent?xows_cli_self:xows_cli_occu_any(n,_),e[c].sndr=o}xows_log(2,"cli_mam_parse","received archives for",n.bare),xows_isfunc(xows_cli_mam_cb)&&xows_cli_mam_cb(n,e,t)}function xows_cli_mam_query(_,o,e,s,t){_.type===XOWS_PEER_CONT?xows_xmp_mam_query(null,o,_.bare,e,s,null,xows_cli_mam_parse):xows_xmp_mam_query(_.bare,o,null,e,s,null,xows_cli_mam_parse),xows_cli_mam_cb=t}function xows_cli_send_message(_,o){if(!o.length)return void xows_log(1,"cli_user_send_message","message with empty body","who you gonna call ?");let e,s,t,n=!1;if(_.type===XOWS_PEER_ROOM)e="groupchat",s=_.bare,t=_.join,n=!0;else if(e="chat",s=_.lock,t=xows_cli_self.bare,_.lock!==_.bare){const o=_.ress[xows_jid_to_nick(_.lock)];o&&(n=xows_cli_entity_caps_test(o.node,XOWS_NS_RECEIPTS))}xows_log(2,"cli_user_send_message","send "+e+" message",s+' "'+o+'"');const c=xows_xmp_send_message(e,s,o,n);xows_cli_fw_onmessage(_,c,t,o,(new Date).getTime(),!0,!n,xows_cli_self)}function xows_cli_send_chatstate(_,o){let e,s;_.type===XOWS_PEER_ROOM?(e="groupchat",s=_.bare):(e="chat",s=_.lock),xows_log(2,"cli_send_chatstate","send chatstat",s+' "'+o+'"'),xows_xmp_send_chatstate(s,e,o)}function xows_cli_send_subject(_,o){xows_log(2,"cli_muc_subject_send","send subject",_.bare+' "'+o+'"'),xows_xmp_send_subject(_.bare,o)}const xows_cli_muc_item_info_stack=[];function xows_cli_muc_items_query(){if(!xows_cli_svc_exist(XOWS_NS_MUC))return xows_log(1,"cli_muc_items_query","service not found","the server does not provide "+XOWS_NS_MUC+" service"),void xows_cli_fw_onerror(XOWS_SIG_WRN,"multi-user chat (XEP-0045) service is unavailable");xows_xmp_discoitems_query(xows_cli_svc_url[XOWS_NS_MUC],xows_cli_muc_items_parse)}function xows_cli_muc_items_parse(_,o){if(xows_cli_room.length=0,o.length){xows_cli_muc_item_info_stack.length=0;let _=o.length;for(;_--;)xows_cli_muc_item_info_stack.push(o[_].jid);xows_xmp_discoinfo_query(xows_cli_muc_item_info_stack.pop(),null,xows_cli_muc_item_info_parse)}else xows_cli_fw_onroompush(null)}function xows_cli_muc_item_info_parse(_,o,e,s){let t,n,c,i="",l="",a=!1;for(c=o.length?o[0].name:_.split("@")[0],t=0,n=e.length;t<n;++t)"muc_passwordprotected"===e[t]&&(a=!0);if(s)for(t=0,n=s.length;t<n;++t)"muc#roominfo_description"==s[t].var&&(l=s[t].value),"muc#roominfo_subject"==s[t].var&&(i=s[t].value);let r=xows_cli_room_get(_);r?(r.name=c,r.desc=l,r.priv=a,xows_log(2,"cli_muc_item_info_parse","refresh Room",c+" ("+_+') :"'+l+'"')):(r=xows_cli_room_new(_,c,l,a),xows_log(2,"cli_muc_item_info_parse","adding Room",c+" ("+_+') :"'+l+'"')),xows_cli_fw_onroompush(r),xows_cli_muc_item_info_stack.length&&xows_xmp_discoinfo_query(xows_cli_muc_item_info_stack.pop(),null,xows_cli_muc_item_info_parse)}let xows_cli_muc_cfg_cb=null;function xows_cli_muc_cfg_get_parse(_,o){const e=xows_cli_room_get(_);e?(xows_isfunc(xows_cli_muc_cfg_cb)&&xows_cli_muc_cfg_cb(e,o),xows_cli_muc_cfg_cb=null):xows_log(1,"cli_muc_cfg_get_parse","unknown/unsubscribed Room",_)}function xows_cli_muc_cfg_set_parse(_,o){if("result"===o){const e=xows_cli_room_get(_);if(!e)return void xows_log(1,"cli_muc_cfg_set_parse","unknown/unsubscribed Room",_);xows_xmp_discoinfo_query(e.bare,null,xows_cli_muc_item_info_parse),xows_isfunc(xows_cli_muc_cfg_cb)&&xows_cli_muc_cfg_cb(e,o),e.init=!1}xows_cli_muc_cfg_cb=null}function xows_cli_room_cfg_get(_,o){xows_cli_muc_cfg_cb?xows_log(1,"cli_room_cfg_get","overlapping queries"):(xows_cli_muc_cfg_cb=o,xows_xmp_muc_cfg_get_guery(_.bare,xows_cli_muc_cfg_get_parse))}function xows_cli_room_cfg_set(_,o,e){xows_cli_muc_cfg_cb?xows_log(1,"cli_room_cfg_set","overlapping queries"):(xows_cli_muc_cfg_cb=e,xows_xmp_muc_cfg_set_query(_.bare,o,xows_cli_muc_cfg_set_parse))}function xows_cli_room_cfg_cancel(_,o){xows_xmp_muc_cfg_set_cancel(_.bare,o)}let xows_cli_upld_param=null,xows_cli_upld_fw_error=function(){},xows_cli_upld_fw_success=function(){},xows_cli_upld_fw_progress=function(){},xows_cli_upld_fw_abort=function(){};function xows_cli_upld_query(_,o,e,s,t){if(!xows_cli_upld_param){if(!xows_cli_svc_exist(XOWS_NS_HTTPUPLOAD))return xows_log(1,"cli_user_upload_query","service not found","the server does not provide "+XOWS_NS_HTTPUPLOAD+"(:0) service"),void xows_cli_fw_onerror(XOWS_SIG_ERR,"HTTP File Upload (XEP-0363) service is unavailable");xows_log(2,"cli_user_upload_query","Upload query for",_.name),xows_cli_upld_param={file:_,url:""},xows_cli_upld_fw_error=o,xows_cli_upld_fw_success=e,xows_cli_upld_fw_progress=s,xows_cli_upld_fw_abort=t,xows_xmp_upload_query(xows_cli_svc_url[XOWS_NS_HTTPUPLOAD],_.name,_.size,_.type,xows_cli_upld_handle)}}function xows_cli_upld_abort(){xows_log(2,"cli_user_upload_abort","upload abort requested"),xows_cli_upld_xhr&&xows_cli_upld_xhr.abort()}let xows_cli_upld_xhr=null;function xows_cli_upld_xhr_progress(_){xows_isfunc(xows_cli_upld_fw_progress)&&xows_cli_upld_fw_progress(_.loaded/_.total*100)}function xows_cli_upld_xhr_success(){xows_isfunc(xows_cli_upld_fw_success)&&xows_cli_upld_fw_success(xows_cli_upld_param.url),xows_cli_upld_param=null,xows_cli_upld_xhr=null}function xows_cli_upld_xhr_error(_){const o="HTTP PUT request failed";xows_log(1,"cli_upld_xhr_error",o),xows_isfunc(xows_cli_upld_fw_error)&&xows_cli_upld_fw_error(o),xows_cli_upld_param=null,xows_cli_upld_xhr=null}function xows_cli_upld_xhr_abort(_){xows_log(1,"cli_upld_xhr_error","http PUT request aborted by user"),xows_cli_upld_param=null,xows_cli_upld_xhr=null,xows_isfunc(xows_cli_upld_fw_abort)&&xows_cli_upld_fw_abort()}function xows_cli_upld_handle(_,o,e,s){if(!_)return xows_cli_upld_param=null,void(xows_isfunc(xows_cli_upld_fw_error)&&xows_cli_upld_fw_error(s));xows_cli_upld_param.url=e;const t=xows_cli_upld_param.file;(new FormData).append(t.name,t);const n=new XMLHttpRequest;n.upload.addEventListener("progress",xows_cli_upld_xhr_progress,!1),n.upload.addEventListener("load",xows_cli_upld_xhr_success,!1),n.upload.addEventListener("error",xows_cli_upld_xhr_error,!1),n.upload.addEventListener("abort",xows_cli_upld_xhr_abort,!1),n.open("PUT",_,!0),n.setRequestHeader("Content-Type","main_menucation/octet-stream"),xows_log(2,"cli_upload_handle","send PUT http request",_),xows_cli_upld_xhr=n,n.send(t)}function xows_cli_muc_register_query(_){xows_xmp_register_get_query(_.bare,xows_cli_muc_register_parse)}function xows_cli_muc_register_parse(_,o,e,s,t,n){if(xows_cli_room_get(_)){if(!o&&n){for(let _=0,o=n.length;_<o;++_)"muc#register_roomnick"===n[_].var&&(n[_].value=xows_cli_self.name);xows_xmp_register_set_query(_,null,null,null,n,null)}}else xows_log(1,"cli_muc_register_parse","unknown/unsubscribed Room",_)}function xows_cli_subscribe_request(_){xows_log(2,"cli_subscribe_request","request subscribe to",_),xows_xmp_send_presence(_,"subscribe")}function xows_cli_subscribe_allow(_,o,e){if(xows_xmp_send_presence(_,o?"subscribed":"unsubscribed"),xows_log(2,"cli_subscribe_request",(o?"allow":"deny")+" subscription from",_),o&&!xows_cli_cont_get(_)){let o;if(e)o=e;else{const e=_.split("@")[0];o=e[0].toUpperCase()+e.slice(1)}xows_cli_rost_edit(_,o)}xows_cli_fw_onsubsrem(_)}function xows_cli_room_join(_,o,e,s){if(!xows_cli_svc_exist(XOWS_NS_MUC))return xows_log(1,"cli_muc_items_query","service not found","the server does not provide "+XOWS_NS_MUC+" service"),void xows_cli_fw_onerror(XOWS_SIG_WRN,"Multi-User Chat (XEP-0045) service is unavailable");let t;if(_){if(_.join)return;t=_.bare}else t=o.toLowerCase()+"@"+xows_cli_svc_url[XOWS_NS_MUC];xows_log(2,"cli_muc_room_join","request join",o+" ("+t+")"),xows_xmp_send_presence(t+"/"+(e||xows_cli_self.name),null,xows_cli_self.show,xows_cli_self.stat,xows_cli_self.avat,!0)}function xows_cli_change_profile(_,o,e){_&&(xows_cli_self.name=_,xows_log(2,"cli_change_profile","change nickname",_)),o?(xows_log(2,"cli_change_profile","change avatar"),xows_cli_self.avat=xows_cach_avat_save(o)):(xows_log(2,"cli_change_profile","set default avatar"),xows_cli_self.avat=xows_cli_avat_temp(xows_cli_self.bare)),xows_cli_vcard_publish(e),xows_cli_nick_publish(),xows_cli_avat_data_publish(e),xows_cli_presence_update(),xows_cli_fw_onselfchange(xows_cli_self)}let xows_cli_chosen_show=-1;function xows_cli_presence_init(){xows_cli_self.show=xows_cli_chosen_show=3,xows_log(2,"cli_presence_init","send intial presence"),xows_xmp_send_presence(null,null,3,xows_cli_self.stat),xows_cli_initialize=!1,xows_options.vcard4_notify||xows_cli_vcard_query(xows_cli_self.bare),xows_options.avatar_notify||xows_cli_avat_meta_query(xows_cli_self.bare),xows_cli_nick_query(xows_cli_self.bare),xows_cli_fw_onconnect(xows_cli_self),xows_cli_fw_onselfchange(xows_cli_self)}function xows_cli_presence_update(){let _,o,e,s;xows_cli_self.show>=0?(o=xows_cli_self.show,e=xows_cli_self.stat,s=xows_cli_self.avat):_="unavailable",xows_log(2,"cli_presence_update","send updated presence"),xows_xmp_send_presence(null,_,o,e,s);let t=xows_cli_room.length;for(;t--;)xows_cli_room[t].join&&(xows_xmp_send_presence(xows_cli_room[t].join,_,o,e,s),_&&(xows_cli_room[t].join=null))}function xows_cli_change_presence(_){xows_cli_self.show=xows_cli_chosen_show=_,xows_cli_presence_update(),xows_cli_fw_onselfchange(xows_cli_self)}function xows_cli_change_status(_){xows_cli_self.stat!==_&&(xows_cli_self.stat=_,xows_cach_peer_save(xows_cli_self.bare,null,null,_),xows_cli_self.show===xows_cli_chosen_show&&xows_cli_presence_update(),xows_cli_fw_onselfchange(xows_cli_self))}let xows_cli_activity_timeout=null;function xows_cli_activity_sleep(){xows_cli_activity_timeout&&clearTimeout(xows_cli_activity_timeout),xows_cli_self.show>1&&(xows_cli_activity_timeout=setTimeout(xows_cli_activity_sleep,6e5),xows_cli_self.show--,xows_cli_presence_update(),xows_cli_fw_onselfchange(xows_cli_self))}function xows_cli_activity_wakeup(){xows_cli_activity_timeout&&clearTimeout(xows_cli_activity_timeout),xows_cli_activity_timeout=setTimeout(xows_cli_activity_sleep,6e5),xows_cli_self.show<xows_cli_chosen_show&&(xows_cli_self.show=xows_cli_chosen_show,xows_cli_presence_update(),xows_cli_fw_onselfchange(xows_cli_self))}function xows_cli_activity_stop(){xows_cli_activity_timeout&&clearTimeout(xows_cli_activity_timeout),xows_cli_chosen_show=-1,xows_cli_self.show=-1}let xows_cli_chatstate_timeout=null;function xows_cli_chatstate_set(_,o){o>XOWS_CHAT_PAUS?(xows_cli_chatstate_timeout?clearTimeout(xows_cli_chatstate_timeout):xows_cli_send_chatstate(_,o),xows_cli_chatstate_timeout=setTimeout(xows_cli_chatstate_set,4e3,_,XOWS_CHAT_PAUS)):(clearTimeout(xows_cli_chatstate_timeout),xows_cli_send_chatstate(_,o),xows_cli_chatstate_timeout=null)}function xows_cli_connected(){return null!==xows_cli_self.jid}function xows_cli_disconnect(){xows_log(2,"cli_disconnect","prepare disconnect"),xows_cli_self.jid&&(xows_cli_self.show=XOWS_SHOW_OFF,xows_cli_presence_update(),xows_xmp_send_close(3))}const xows_tpl_template_parser=new DOMParser;let xows_tpl_fw_onready=function(){},xows_tpl_template_parse_remain=0,xows_tpl_model=[],xows_tpl_fragment=null,xows_tpl_theme="dark";const xows_tpl_emoj_map={100:"1F4AF",1234:"1F522",grinning:"1F600",smiley:"1F603",smile:"1F604",grin:"1F601",laughing:"1F606",sweat_smile:"1F605",rolling_on_the_floor_laughing:"1F923",joy:"1F602",slightly_smiling_face:"1F642",upside_down_face:"1F643",wink:"1F609",blush:"1F60A",innocent:"1F607",smiling_face_with_3_hearts:"1F970",heart_eyes:"1F60D","star-struck":"1F929",kissing_heart:"1F618",kissing:"1F617",kissing_closed_eyes:"1F61A",kissing_smiling_eyes:"1F619",yum:"1F60B",stuck_out_tongue:"1F61B",stuck_out_tongue_winking_eye:"1F61C",zany_face:"1F92A",stuck_out_tongue_closed_eyes:"1F61D",money_mouth_face:"1F911",hugging_face:"1F917",face_with_hand_over_mouth:"1F92D",shushing_face:"1F92B",thinking_face:"1F914",zipper_mouth_face:"1F910",face_with_raised_eyebrow:"1F928",neutral_face:"1F610",expressionless:"1F611",no_mouth:"1F636",smirk:"1F60F",unamused:"1F612",face_with_rolling_eyes:"1F644",grimacing:"1F62C",lying_face:"1F925",relieved:"1F60C",pensive:"1F614",sleepy:"1F62A",drooling_face:"1F924",sleeping:"1F634",mask:"1F637",face_with_thermometer:"1F912",face_with_head_bandage:"1F915",nauseated_face:"1F922",face_vomiting:"1F92E",sneezing_face:"1F927",hot_face:"1F975",cold_face:"1F976",woozy_face:"1F974",dizzy_face:"1F635",exploding_head:"1F92F",face_with_cowboy_hat:"1F920",partying_face:"1F973",sunglasses:"1F60E",nerd_face:"1F913",face_with_monocle:"1F9D0",confused:"1F615",worried:"1F61F",slightly_frowning_face:"1F641",open_mouth:"1F62E",hushed:"1F62F",astonished:"1F632",flushed:"1F633",pleading_face:"1F97A",frowning:"1F626",anguished:"1F627",fearful:"1F628",cold_sweat:"1F630",disappointed_relieved:"1F625",cry:"1F622",sob:"1F62D",scream:"1F631",confounded:"1F616",persevere:"1F623",disappointed:"1F61E",sweat:"1F613",weary:"1F629",tired_face:"1F62B",yawning_face:"1F971",triumph:"1F624",rage:"1F621",angry:"1F620",face_with_symbols_on_mouth:"1F92C",smiling_imp:"1F608",imp:"1F47F",skull:"1F480",hankey:"1F4A9",clown_face:"1F921",japanese_ogre:"1F479",japanese_goblin:"1F47A",ghost:"1F47B",alien:"1F47D",space_invader:"1F47E",robot_face:"1F916",smiley_cat:"1F63A",smile_cat:"1F638",joy_cat:"1F639",heart_eyes_cat:"1F63B",smirk_cat:"1F63C",kissing_cat:"1F63D",scream_cat:"1F640",crying_cat_face:"1F63F",pouting_cat:"1F63E",see_no_evil:"1F648",hear_no_evil:"1F649",speak_no_evil:"1F64A",kiss:"1F48B",love_letter:"1F48C",cupid:"1F498",gift_heart:"1F49D",sparkling_heart:"1F496",heartpulse:"1F497",heartbeat:"1F493",revolving_hearts:"1F49E",two_hearts:"1F495",heart_decoration:"1F49F",broken_heart:"1F494",orange_heart:"1F9E1",yellow_heart:"1F49B",green_heart:"1F49A",blue_heart:"1F499",purple_heart:"1F49C",brown_heart:"1F90E",black_heart:"1F5A4",white_heart:"1F90D",anger:"1F4A2",boom:"1F4A5",dizzy:"1F4AB",sweat_drops:"1F4A6",dash:"1F4A8",bomb:"1F4A3",speech_balloon:"1F4AC",thought_balloon:"1F4AD",zzz:"1F4A4",wave:"1F44B",raised_back_of_hand:"1F91A",hand:"270B","spock-hand":"1F596",ok_hand:"1F44C",pinching_hand:"1F90F",crossed_fingers:"1F91E",i_love_you_hand_sign:"1F91F",the_horns:"1F918",call_me_hand:"1F919",point_left:"1F448",point_right:"1F449",point_up_2:"1F446",middle_finger:"1F595",point_down:"1F447","+1":"1F44D","-1":"1F44E",fist:"270A",facepunch:"1F44A","left-facing_fist":"1F91B","right-facing_fist":"1F91C",clap:"1F44F",raised_hands:"1F64C",open_hands:"1F450",palms_up_together:"1F932",handshake:"1F91D",pray:"1F64F",nail_care:"1F485",selfie:"1F933",muscle:"1F4AA",mechanical_arm:"1F9BE",mechanical_leg:"1F9BF",leg:"1F9B5",foot:"1F9B6",ear:"1F442",ear_with_hearing_aid:"1F9BB",nose:"1F443",brain:"1F9E0",tooth:"1F9B7",bone:"1F9B4",eyes:"1F440",tongue:"1F445",lips:"1F444",baby:"1F476",child:"1F9D2",boy:"1F466",girl:"1F467",adult:"1F9D1",person_with_blond_hair:"1F471",man:"1F468",bearded_person:"1F9D4",woman:"1F469",older_adult:"1F9D3",older_man:"1F474",older_woman:"1F475",person_frowning:"1F64D",person_with_pouting_face:"1F64E",no_good:"1F645",ok_woman:"1F646",information_desk_person:"1F481",raising_hand:"1F64B",deaf_person:"1F9CF",bow:"1F647",face_palm:"1F926",shrug:"1F937",cop:"1F46E",guardsman:"1F482",construction_worker:"1F477",prince:"1F934",princess:"1F478",man_with_turban:"1F473",man_with_gua_pi_mao:"1F472",person_with_headscarf:"1F9D5",man_in_tuxedo:"1F935",bride_with_veil:"1F470",pregnant_woman:"1F930","breast-feeding":"1F931",angel:"1F47C",santa:"1F385",mrs_claus:"1F936",superhero:"1F9B8",supervillain:"1F9B9",mage:"1F9D9",fairy:"1F9DA",vampire:"1F9DB",merperson:"1F9DC",elf:"1F9DD",genie:"1F9DE",zombie:"1F9DF",massage:"1F486",haircut:"1F487",walking:"1F6B6",standing_person:"1F9CD",kneeling_person:"1F9CE",runner:"1F3C3",dancer:"1F483",man_dancing:"1F57A",dancers:"1F46F",person_in_steamy_room:"1F9D6",person_climbing:"1F9D7",fencer:"1F93A",horse_racing:"1F3C7",snowboarder:"1F3C2",surfer:"1F3C4",rowboat:"1F6A3",swimmer:"1F3CA",bicyclist:"1F6B4",mountain_bicyclist:"1F6B5",person_doing_cartwheel:"1F938",wrestlers:"1F93C",water_polo:"1F93D",handball:"1F93E",juggling:"1F939",person_in_lotus_position:"1F9D8",bath:"1F6C0",sleeping_accommodation:"1F6CC",two_women_holding_hands:"1F46D",couple:"1F46B",two_men_holding_hands:"1F46C",couplekiss:"1F48F",couple_with_heart:"1F491",family:"1F46A",bust_in_silhouette:"1F464",busts_in_silhouette:"1F465",footprints:"1F463",monkey_face:"1F435",monkey:"1F412",gorilla:"1F98D",orangutan:"1F9A7",dog:"1F436",dog2:"1F415",guide_dog:"1F9AE",poodle:"1F429",wolf:"1F43A",fox_face:"1F98A",raccoon:"1F99D",cat:"1F431",cat2:"1F408",lion_face:"1F981",tiger:"1F42F",tiger2:"1F405",leopard:"1F406",horse:"1F434",racehorse:"1F40E",unicorn_face:"1F984",zebra_face:"1F993",deer:"1F98C",cow:"1F42E",ox:"1F402",water_buffalo:"1F403",cow2:"1F404",pig:"1F437",pig2:"1F416",boar:"1F417",pig_nose:"1F43D",ram:"1F40F",sheep:"1F411",goat:"1F410",dromedary_camel:"1F42A",camel:"1F42B",llama:"1F999",giraffe_face:"1F992",elephant:"1F418",rhinoceros:"1F98F",hippopotamus:"1F99B",mouse:"1F42D",mouse2:"1F401",rat:"1F400",hamster:"1F439",rabbit:"1F430",rabbit2:"1F407",hedgehog:"1F994",bat:"1F987",bear:"1F43B",koala:"1F428",panda_face:"1F43C",sloth:"1F9A5",otter:"1F9A6",skunk:"1F9A8",kangaroo:"1F998",badger:"1F9A1",feet:"1F43E",turkey:"1F983",chicken:"1F414",rooster:"1F413",hatching_chick:"1F423",baby_chick:"1F424",hatched_chick:"1F425",bird:"1F426",penguin:"1F427",eagle:"1F985",duck:"1F986",swan:"1F9A2",owl:"1F989",flamingo:"1F9A9",peacock:"1F99A",parrot:"1F99C",frog:"1F438",crocodile:"1F40A",turtle:"1F422",lizard:"1F98E",snake:"1F40D",dragon_face:"1F432",dragon:"1F409",sauropod:"1F995","t-rex":"1F996",whale:"1F433",whale2:"1F40B",dolphin:"1F42C",fish:"1F41F",tropical_fish:"1F420",blowfish:"1F421",shark:"1F988",octopus:"1F419",shell:"1F41A",snail:"1F40C",butterfly:"1F98B",bug:"1F41B",ant:"1F41C",bee:"1F41D",beetle:"1F41E",cricket:"1F997",scorpion:"1F982",mosquito:"1F99F",microbe:"1F9A0",bouquet:"1F490",cherry_blossom:"1F338",white_flower:"1F4AE",rose:"1F339",wilted_flower:"1F940",hibiscus:"1F33A",sunflower:"1F33B",blossom:"1F33C",tulip:"1F337",seedling:"1F331",evergreen_tree:"1F332",deciduous_tree:"1F333",palm_tree:"1F334",cactus:"1F335",ear_of_rice:"1F33E",herb:"1F33F",four_leaf_clover:"1F340",maple_leaf:"1F341",fallen_leaf:"1F342",leaves:"1F343",grapes:"1F347",melon:"1F348",watermelon:"1F349",tangerine:"1F34A",lemon:"1F34B",banana:"1F34C",pineapple:"1F34D",mango:"1F96D",apple:"1F34E",green_apple:"1F34F",pear:"1F350",peach:"1F351",cherries:"1F352",strawberry:"1F353",kiwifruit:"1F95D",tomato:"1F345",coconut:"1F965",avocado:"1F951",eggplant:"1F346",potato:"1F954",carrot:"1F955",corn:"1F33D",cucumber:"1F952",leafy_green:"1F96C",broccoli:"1F966",garlic:"1F9C4",onion:"1F9C5",mushroom:"1F344",peanuts:"1F95C",chestnut:"1F330",bread:"1F35E",croissant:"1F950",baguette_bread:"1F956",pretzel:"1F968",bagel:"1F96F",pancakes:"1F95E",waffle:"1F9C7",cheese_wedge:"1F9C0",meat_on_bone:"1F356",poultry_leg:"1F357",cut_of_meat:"1F969",bacon:"1F953",hamburger:"1F354",fries:"1F35F",pizza:"1F355",hotdog:"1F32D",sandwich:"1F96A",taco:"1F32E",burrito:"1F32F",stuffed_flatbread:"1F959",falafel:"1F9C6",egg:"1F95A",fried_egg:"1F373",shallow_pan_of_food:"1F958",stew:"1F372",bowl_with_spoon:"1F963",green_salad:"1F957",popcorn:"1F37F",butter:"1F9C8",salt:"1F9C2",canned_food:"1F96B",bento:"1F371",rice_cracker:"1F358",rice_ball:"1F359",rice:"1F35A",curry:"1F35B",ramen:"1F35C",spaghetti:"1F35D",sweet_potato:"1F360",oden:"1F362",sushi:"1F363",fried_shrimp:"1F364",fish_cake:"1F365",moon_cake:"1F96E",dango:"1F361",dumpling:"1F95F",fortune_cookie:"1F960",takeout_box:"1F961",crab:"1F980",lobster:"1F99E",shrimp:"1F990",squid:"1F991",oyster:"1F9AA",icecream:"1F366",shaved_ice:"1F367",ice_cream:"1F368",doughnut:"1F369",cookie:"1F36A",birthday:"1F382",cake:"1F370",cupcake:"1F9C1",pie:"1F967",chocolate_bar:"1F36B",candy:"1F36C",lollipop:"1F36D",custard:"1F36E",honey_pot:"1F36F",baby_bottle:"1F37C",glass_of_milk:"1F95B",coffee:"2615",tea:"1F375",sake:"1F376",champagne:"1F37E",wine_glass:"1F377",cocktail:"1F378",tropical_drink:"1F379",beer:"1F37A",beers:"1F37B",clinking_glasses:"1F942",tumbler_glass:"1F943",cup_with_straw:"1F964",beverage_box:"1F9C3",mate_drink:"1F9C9",ice_cube:"1F9CA",chopsticks:"1F962",fork_and_knife:"1F374",spoon:"1F944",hocho:"1F52A",amphora:"1F3FA",eyeglasses:"1F453",goggles:"1F97D",lab_coat:"1F97C",safety_vest:"1F9BA",necktie:"1F454",shirt:"1F455",jeans:"1F456",scarf:"1F9E3",gloves:"1F9E4",coat:"1F9E5",socks:"1F9E6",dress:"1F457",kimono:"1F458",sari:"1F97B","one-piece_swimsuit":"1FA71",briefs:"1FA72",shorts:"1FA73",bikini:"1F459",womans_clothes:"1F45A",purse:"1F45B",handbag:"1F45C",pouch:"1F45D",school_satchel:"1F392",mans_shoe:"1F45E",athletic_shoe:"1F45F",hiking_boot:"1F97E",womans_flat_shoe:"1F97F",high_heel:"1F460",sandal:"1F461",ballet_shoes:"1FA70",boot:"1F462",crown:"1F451",womans_hat:"1F452",tophat:"1F3A9",mortar_board:"1F393",billed_cap:"1F9E2",prayer_beads:"1F4FF",lipstick:"1F484",ring:"1F48D",gem:"1F48E",mute:"1F507",speaker:"1F508",sound:"1F509",loud_sound:"1F50A",loudspeaker:"1F4E2",mega:"1F4E3",postal_horn:"1F4EF",bell:"1F514",no_bell:"1F515",musical_score:"1F3BC",musical_note:"1F3B5",notes:"1F3B6",microphone:"1F3A4",headphones:"1F3A7",radio:"1F4FB",saxophone:"1F3B7",guitar:"1F3B8",musical_keyboard:"1F3B9",trumpet:"1F3BA",violin:"1F3BB",banjo:"1FA95",drum_with_drumsticks:"1F941",iphone:"1F4F1",calling:"1F4F2",telephone_receiver:"1F4DE",pager:"1F4DF",fax:"1F4E0",battery:"1F50B",electric_plug:"1F50C",computer:"1F4BB",minidisc:"1F4BD",floppy_disk:"1F4BE",cd:"1F4BF",dvd:"1F4C0",abacus:"1F9EE",movie_camera:"1F3A5",clapper:"1F3AC",tv:"1F4FA",camera:"1F4F7",camera_with_flash:"1F4F8",video_camera:"1F4F9",vhs:"1F4FC",mag:"1F50D",mag_right:"1F50E",bulb:"1F4A1",flashlight:"1F526",izakaya_lantern:"1F3EE",diya_lamp:"1FA94",notebook_with_decorative_cover:"1F4D4",closed_book:"1F4D5",book:"1F4D6",green_book:"1F4D7",blue_book:"1F4D8",orange_book:"1F4D9",books:"1F4DA",notebook:"1F4D3",ledger:"1F4D2",page_with_curl:"1F4C3",scroll:"1F4DC",page_facing_up:"1F4C4",newspaper:"1F4F0",bookmark_tabs:"1F4D1",bookmark:"1F516",moneybag:"1F4B0",yen:"1F4B4",dollar:"1F4B5",euro:"1F4B6",pound:"1F4B7",money_with_wings:"1F4B8",credit_card:"1F4B3",receipt:"1F9FE",chart:"1F4B9",currency_exchange:"1F4B1",heavy_dollar_sign:"1F4B2","e-mail":"1F4E7",incoming_envelope:"1F4E8",envelope_with_arrow:"1F4E9",outbox_tray:"1F4E4",inbox_tray:"1F4E5",package:"1F4E6",mailbox:"1F4EB",mailbox_closed:"1F4EA",mailbox_with_mail:"1F4EC",mailbox_with_no_mail:"1F4ED",postbox:"1F4EE",memo:"1F4DD",briefcase:"1F4BC",file_folder:"1F4C1",open_file_folder:"1F4C2",date:"1F4C5",calendar:"1F4C6",card_index:"1F4C7",chart_with_upwards_trend:"1F4C8",chart_with_downwards_trend:"1F4C9",bar_chart:"1F4CA",clipboard:"1F4CB",pushpin:"1F4CC",round_pushpin:"1F4CD",paperclip:"1F4CE",straight_ruler:"1F4CF",triangular_ruler:"1F4D0",lock:"1F512",unlock:"1F513",lock_with_ink_pen:"1F50F",closed_lock_with_key:"1F510",key:"1F511",hammer:"1F528",axe:"1FA93",gun:"1F52B",bow_and_arrow:"1F3F9",wrench:"1F527",nut_and_bolt:"1F529",probing_cane:"1F9AF",link:"1F517",toolbox:"1F9F0",magnet:"1F9F2",test_tube:"1F9EA",petri_dish:"1F9EB",dna:"1F9EC",microscope:"1F52C",telescope:"1F52D",satellite_antenna:"1F4E1",syringe:"1F489",drop_of_blood:"1FA78",pill:"1F48A",adhesive_bandage:"1FA79",stethoscope:"1FA7A",door:"1F6AA",chair:"1FA91",toilet:"1F6BD",shower:"1F6BF",bathtub:"1F6C1",razor:"1FA92",lotion_bottle:"1F9F4",safety_pin:"1F9F7",broom:"1F9F9",basket:"1F9FA",roll_of_paper:"1F9FB",soap:"1F9FC",sponge:"1F9FD",fire_extinguisher:"1F9EF",shopping_trolley:"1F6D2",smoking:"1F6AC",moyai:"1F5FF",earth_africa:"1F30D",earth_americas:"1F30E",earth_asia:"1F30F",globe_with_meridians:"1F310",japan:"1F5FE",compass:"1F9ED",volcano:"1F30B",mount_fuji:"1F5FB",bricks:"1F9F1",house:"1F3E0",house_with_garden:"1F3E1",office:"1F3E2",post_office:"1F3E3",european_post_office:"1F3E4",hospital:"1F3E5",bank:"1F3E6",hotel:"1F3E8",love_hotel:"1F3E9",convenience_store:"1F3EA",school:"1F3EB",department_store:"1F3EC",factory:"1F3ED",japanese_castle:"1F3EF",european_castle:"1F3F0",wedding:"1F492",tokyo_tower:"1F5FC",statue_of_liberty:"1F5FD",church:"26EA",mosque:"1F54C",hindu_temple:"1F6D5",synagogue:"1F54D",kaaba:"1F54B",fountain:"26F2",tent:"26FA",foggy:"1F301",night_with_stars:"1F303",sunrise_over_mountains:"1F304",sunrise:"1F305",city_sunset:"1F306",city_sunrise:"1F307",bridge_at_night:"1F309",carousel_horse:"1F3A0",ferris_wheel:"1F3A1",roller_coaster:"1F3A2",barber:"1F488",circus_tent:"1F3AA",steam_locomotive:"1F682",railway_car:"1F683",bullettrain_side:"1F684",bullettrain_front:"1F685",train2:"1F686",metro:"1F687",light_rail:"1F688",station:"1F689",tram:"1F68A",monorail:"1F69D",mountain_railway:"1F69E",train:"1F68B",bus:"1F68C",oncoming_bus:"1F68D",trolleybus:"1F68E",minibus:"1F690",ambulance:"1F691",fire_engine:"1F692",police_car:"1F693",oncoming_police_car:"1F694",taxi:"1F695",oncoming_taxi:"1F696",car:"1F697",oncoming_automobile:"1F698",blue_car:"1F699",truck:"1F69A",articulated_lorry:"1F69B",tractor:"1F69C",motor_scooter:"1F6F5",manual_wheelchair:"1F9BD",motorized_wheelchair:"1F9BC",auto_rickshaw:"1F6FA",bike:"1F6B2",scooter:"1F6F4",skateboard:"1F6F9",busstop:"1F68F",fuelpump:"26FD",rotating_light:"1F6A8",traffic_light:"1F6A5",vertical_traffic_light:"1F6A6",octagonal_sign:"1F6D1",construction:"1F6A7",anchor:"2693",boat:"26F5",canoe:"1F6F6",speedboat:"1F6A4",ship:"1F6A2",airplane_departure:"1F6EB",airplane_arriving:"1F6EC",parachute:"1FA82",seat:"1F4BA",helicopter:"1F681",suspension_railway:"1F69F",mountain_cableway:"1F6A0",aerial_tramway:"1F6A1",rocket:"1F680",flying_saucer:"1F6F8",luggage:"1F9F3",hourglass:"231B",hourglass_flowing_sand:"23F3",watch:"231A",alarm_clock:"23F0",clock12:"1F55B",clock1230:"1F567",clock1:"1F550",clock130:"1F55C",clock2:"1F551",clock230:"1F55D",clock3:"1F552",clock330:"1F55E",clock4:"1F553",clock430:"1F55F",clock5:"1F554",clock530:"1F560",clock6:"1F555",clock630:"1F561",clock7:"1F556",clock730:"1F562",clock8:"1F557",clock830:"1F563",clock9:"1F558",clock930:"1F564",clock10:"1F559",clock1030:"1F565",clock11:"1F55A",clock1130:"1F566",new_moon:"1F311",waxing_crescent_moon:"1F312",first_quarter_moon:"1F313",moon:"1F314",full_moon:"1F315",waning_gibbous_moon:"1F316",last_quarter_moon:"1F317",waning_crescent_moon:"1F318",crescent_moon:"1F319",new_moon_with_face:"1F31A",first_quarter_moon_with_face:"1F31B",last_quarter_moon_with_face:"1F31C",full_moon_with_face:"1F31D",sun_with_face:"1F31E",ringed_planet:"1FA90",star:"2B50",star2:"1F31F",stars:"1F320",milky_way:"1F30C",partly_sunny:"26C5",cyclone:"1F300",rainbow:"1F308",closed_umbrella:"1F302",umbrella_with_rain_drops:"2614",zap:"26A1",snowman_without_snow:"26C4",fire:"1F525",droplet:"1F4A7",ocean:"1F30A",jack_o_lantern:"1F383",christmas_tree:"1F384",fireworks:"1F386",sparkler:"1F387",firecracker:"1F9E8",sparkles:"2728",balloon:"1F388",tada:"1F389",confetti_ball:"1F38A",tanabata_tree:"1F38B",bamboo:"1F38D",dolls:"1F38E",flags:"1F38F",wind_chime:"1F390",rice_scene:"1F391",red_envelope:"1F9E7",ribbon:"1F380",gift:"1F381",ticket:"1F3AB",trophy:"1F3C6",sports_medal:"1F3C5",first_place_medal:"1F947",second_place_medal:"1F948",third_place_medal:"1F949",soccer:"26BD",baseball:"26BE",softball:"1F94E",basketball:"1F3C0",volleyball:"1F3D0",football:"1F3C8",rugby_football:"1F3C9",tennis:"1F3BE",flying_disc:"1F94F",bowling:"1F3B3",cricket_bat_and_ball:"1F3CF",field_hockey_stick_and_ball:"1F3D1",ice_hockey_stick_and_puck:"1F3D2",lacrosse:"1F94D",table_tennis_paddle_and_ball:"1F3D3",badminton_racquet_and_shuttlecock:"1F3F8",boxing_glove:"1F94A",martial_arts_uniform:"1F94B",goal_net:"1F945",golf:"26F3",fishing_pole_and_fish:"1F3A3",diving_mask:"1F93F",running_shirt_with_sash:"1F3BD",ski:"1F3BF",sled:"1F6F7",curling_stone:"1F94C",dart:"1F3AF","yo-yo":"1FA80",kite:"1FA81","8ball":"1F3B1",crystal_ball:"1F52E",nazar_amulet:"1F9FF",video_game:"1F3AE",slot_machine:"1F3B0",game_die:"1F3B2",jigsaw:"1F9E9",teddy_bear:"1F9F8",black_joker:"1F0CF",mahjong:"1F004",flower_playing_cards:"1F3B4",performing_arts:"1F3AD",art:"1F3A8",thread:"1F9F5",yarn:"1F9F6",atm:"1F3E7",put_litter_in_its_place:"1F6AE",potable_water:"1F6B0",wheelchair:"267F",mens:"1F6B9",womens:"1F6BA",restroom:"1F6BB",baby_symbol:"1F6BC",wc:"1F6BE",passport_control:"1F6C2",customs:"1F6C3",baggage_claim:"1F6C4",left_luggage:"1F6C5",children_crossing:"1F6B8",no_entry:"26D4",no_entry_sign:"1F6AB",no_bicycles:"1F6B3",no_smoking:"1F6AD",do_not_litter:"1F6AF","non-potable_water":"1F6B1",no_pedestrians:"1F6B7",no_mobile_phones:"1F4F5",underage:"1F51E",arrows_clockwise:"1F503",arrows_counterclockwise:"1F504",back:"1F519",end:"1F51A",on:"1F51B",soon:"1F51C",top:"1F51D",place_of_worship:"1F6D0",menorah_with_nine_branches:"1F54E",six_pointed_star:"1F52F",aries:"2648",taurus:"2649",gemini:"264A",cancer:"264B",leo:"264C",virgo:"264D",libra:"264E",scorpius:"264F",sagittarius:"2650",capricorn:"2651",aquarius:"2652",pisces:"2653",ophiuchus:"26CE",twisted_rightwards_arrows:"1F500",repeat:"1F501",repeat_one:"1F502",fast_forward:"23E9",rewind:"23EA",arrow_up_small:"1F53C",arrow_double_up:"23EB",arrow_down_small:"1F53D",arrow_double_down:"23EC",cinema:"1F3A6",low_brightness:"1F505",high_brightness:"1F506",signal_strength:"1F4F6",vibration_mode:"1F4F3",mobile_phone_off:"1F4F4",trident:"1F531",name_badge:"1F4DB",beginner:"1F530",o:"2B55",white_check_mark:"2705",x:"274C",negative_squared_cross_mark:"274E",heavy_plus_sign:"2795",heavy_minus_sign:"2796",heavy_division_sign:"2797",curly_loop:"27B0",loop:"27BF",question:"2753",grey_question:"2754",grey_exclamation:"2755",exclamation:"2757",keycap_ten:"1F51F",capital_abcd:"1F520",abcd:"1F521",symbols:"1F523",abc:"1F524",ab:"1F18E",cl:"1F191",cool:"1F192",free:"1F193",id:"1F194",new:"1F195",ng:"1F196",ok:"1F197",sos:"1F198",up:"1F199",vs:"1F19A",koko:"1F201",u6709:"1F236",u6307:"1F22F",ideograph_advantage:"1F250",u5272:"1F239",u7121:"1F21A",u7981:"1F232",accept:"1F251",u7533:"1F238",u5408:"1F234",u7a7a:"1F233",u55b6:"1F23A",u6e80:"1F235",red_circle:"1F534",large_orange_circle:"1F7E0",large_yellow_circle:"1F7E1",large_green_circle:"1F7E2",large_blue_circle:"1F535",large_purple_circle:"1F7E3",large_brown_circle:"1F7E4",black_circle:"26AB",white_circle:"26AA",large_red_square:"1F7E5",large_orange_square:"1F7E7",large_yellow_square:"1F7E8",large_green_square:"1F7E9",large_blue_square:"1F7E6",large_purple_square:"1F7EA",large_brown_square:"1F7EB",black_large_square:"2B1B",white_large_square:"2B1C",black_medium_small_square:"25FE",white_medium_small_square:"25FD",large_orange_diamond:"1F536",large_blue_diamond:"1F537",small_orange_diamond:"1F538",small_blue_diamond:"1F539",small_red_triangle:"1F53A",small_red_triangle_down:"1F53B",diamond_shape_with_a_dot_inside:"1F4A0",radio_button:"1F518",white_square_button:"1F533",black_square_button:"1F532"},xows_tpl_emot_map={":":{")":"1F642","(":"1F641",O:"1F62E",P:"1F61B",D:"1F604","*":"1F617","|":"1F610","#":"1F910",S:"1F616",$:"1F633","/":"1F615",".":"1F636",X:"1F922"},8:{")":"1F60E"},":&APOS;":{")":"1F602","(":"1F622",D:"1F923"},";":{")":"1F609",P:"1F61C"},X:{")":"1F606",D:"1F606",P:"1F61D"}};function xows_tpl_template_load(_,o){let e=xows_options.root+"/themes/"+xows_tpl_theme+"/"+_+".html";xows_options.uncache&&(e+="?"+xows_gen_nonce_asc(4));const s=new XMLHttpRequest;s.open("GET",e,!0),s._isinst=o,s.onreadystatechange=function(){4===this.readyState&&(200===this.status?xows_tpl_template_parse(this.responseText,this.responseURL,this._isinst):xows_log(0,"tpl_template_load",'file "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"'))},xows_tpl_template_parse_remain++,xows_log(2,"tpl_template_load","loading file",e),s.send()}function xows_tpl_template_done(){for(;xows_tpl_fragment.childNodes.length>0;)document.body.appendChild(xows_tpl_fragment.firstChild);xows_log(2,"tpl_template_done","templates parsing completed"),xows_tpl_fragment=null,xows_tpl_fw_onready()}function xows_tpl_template_parse(_,o,e){xows_log(2,"tpl_template_parse","parsing template",o),_=xows_l10n_parse(_);const s=xows_clean_dom(xows_tpl_template_parser.parseFromString(_,"text/html").body);if(!s)return void xows_log(0,"tpl_template_parse",'template "'+o+'" parse error');let t,n;const c=[],i=[];if(!e)for(t=(n=s.querySelectorAll("[has_template]")).length;t--;)c.push(n[t].getAttribute("id")),n[t].removeAttribute("has_template");for(t=(n=s.querySelectorAll("[is_instance]")).length;t--;)i.push(n[t].className),n[t].parentNode.removeChild(n[t]);let l=o.substring(o.lastIndexOf("/")+1).split(".")[0];if(e)xows_tpl_model[l]=document.createDocumentFragment(),xows_tpl_model[l].appendChild(s.firstChild);else{let _=xows_tpl_fragment.querySelector("#"+l);for(_||(_=xows_tpl_fragment);s.childNodes.length>0;)_.appendChild(s.firstChild);for(t=c.length;t--;)xows_tpl_template_load(c[t],!1)}for(t=i.length;t--;)xows_tpl_template_load(i[t],!0);0===--xows_tpl_template_parse_remain&&xows_tpl_template_done()}function xows_tpl_init(_){_&&(xows_tpl_fw_onready=_),xows_options.root&&(xows_options.root=xows_options.root),xows_options.theme&&(xows_tpl_theme=xows_options.theme);const o=document.createElement("link");o.rel="stylesheet",o.type="text/css";o.href=xows_options.root+"/themes/"+xows_tpl_theme+"/style.css",xows_options.uncache&&(o.href+="?"+xows_gen_nonce_asc(4)),document.head.appendChild(o),xows_tpl_template_parse_remain=0,xows_tpl_fragment=document.createDocumentFragment(),xows_tpl_template_load("body")}function xows_tpl_embed_wrap(_,o,e,s){let t='<aside class="';return e&&(t+=e),t+='" onclick="xows_doc_view_open(this.firstChild)">',s&&(t+='<a href="'+_+'" target="_blank">'+s+"</a>"),t+=o.replace(/src=/g,"lazy_src="),t+="</aside>"}function xows_tpl_embed_image(_,o){return xows_tpl_embed_wrap(_,'<img src="'+_+'" '+("GIF"===o?"NOLOADER":"")+">","EMBD-IMG")}function xows_tpl_embed_movie(_,o){return xows_tpl_embed_wrap(_,'<video controls src="'+_+'" NOLOADER></video>',"EMBD-VID")}function xows_tpl_embed_audio(_,o){return xows_tpl_embed_wrap(_,'<audio controls src="'+_+'" NOLOADER/>',"EMBD-SND")}function xows_tpl_embed_youtube(_,o){let e=_.match(/(v=|embed\/|youtu\.be\/)(.+)/)[2];return xows_tpl_embed_wrap(_,'<iframe src="https://www.youtube.com/embed/'+(e=e.replace(/t=/,"start="))+'"/>',"EMBD-STR","YouTube")}function xows_tpl_embed_dailymo(_,o){return xows_tpl_embed_wrap(_,'<iframe src="https://www.dailymotion.com/embed/video/'+_.match(/(video|dai\.ly)\/([\w\d]+)/)[2]+'"/>',"EMBD-STR","Dailymotion")}function xows_tpl_embed_vimeo(_,o){return xows_tpl_embed_wrap(_,'<iframe src="https://player.vimeo.com/video/'+_.match(/\/([\d]+)/)[1]+'"></iframe>',"EMBD-STR","Vimeo")}function xows_tpl_embed_odysee(_,o){return xows_tpl_embed_wrap(_,'<iframe src="https://odysee.com/$/embed/'+_.match(/.com\/(.*)/)[1]+'"></iframe>',"EMBD-STR","Odysee")}function xows_tpl_embed_upld(_,o){return xows_tpl_embed_wrap(_,'<a class="dnld-btn" href="'+_+'" target="_blank"></a>',"EMBD-DNL",decodeURI(_.match(/(.+\/)*(.+\..+)/)[2]))}let xows_tpl_embed_files={JPG:xows_tpl_embed_image,JPEG:xows_tpl_embed_image,GIF:xows_tpl_embed_image,PNG:xows_tpl_embed_image,WEBP:xows_tpl_embed_image,SVG:xows_tpl_embed_image,MP4:xows_tpl_embed_movie,MPEG:xows_tpl_embed_movie,AVI:xows_tpl_embed_movie,MP3:xows_tpl_embed_audio,OGG:xows_tpl_embed_audio},xows_tpl_embed_sites={"www.youtube.com":xows_tpl_embed_youtube,"youtu.be":xows_tpl_embed_youtube,"www.dailymotion.com":xows_tpl_embed_dailymo,"dai.ly":xows_tpl_embed_dailymo,"vimeo.com":xows_tpl_embed_vimeo},xows_tpl_embed_uplds={};function xows_tpl_embed_add_site(_,o){xows_tpl_embed_sites[_]=o}function xows_tpl_embed_add_file(_,o){xows_tpl_embed_files[_]=o}function xows_tpl_embed_add_upld(_){xows_tpl_embed_uplds[_]=xows_tpl_embed_upld}function xows_tpl_replace_emoj_sc(_,o){const e=xows_tpl_emoj_map[o];return e?"<emoj>&#x"+e+";</emoj>":_}function xows_tpl_replace_emoj_cp(_,o){return"<emoj>"+o+"</emoj>"}function xows_tpl_replace_emots(_,o,e,s){const t=xows_tpl_emot_map[e.toUpperCase()][s.toUpperCase()];return t?"<emoj>&#x"+t+";</emoj>":_}let xows_tpl_format_urls=null;function xows_tpl_replace_url(_){xows_tpl_format_urls&&xows_tpl_format_urls.push(_);const o=_.match(/\/\/(.*?[\w\d-_]+\.\w+)\//);return o&&xows_tpl_embed_uplds[o[1].toLowerCase()]?"":'<a href="'+_+'" title="'+_+'" target="_blank">'+_+"</a>"}function xows_tpl_format_body(_,o){return _=(_=(_=(_=xows_html_escape(_)).replace(/([\u{2300}-\u{2BFF}]|[\u{1F000}-\u{1FB00}])/gu,xows_tpl_replace_emoj_cp)).replace(/:([\w-+-_]*):/g,xows_tpl_replace_emoj_sc)).replace(/(\s|^)([Xx8:;]|:&apos;)-?([()|DpPxXoO#$.\/*sS])/g,xows_tpl_replace_emots),xows_tpl_format_urls=o,_.replace(/(http|https|ftp|ftps):\/\/(\S*)/g,xows_tpl_replace_url)}function xows_tpl_format_embed(_){let o,e,s,t,n="";for(let c=0,i=_.length;c<i;++c)t=null,(o=(s=_[c]).match(/\.([\w\d]+)(\?|$)/))&&(e=o[1].toUpperCase(),xows_tpl_embed_files[e]&&(t=xows_tpl_embed_files[e](s,e))),t||(o=s.match(/\/\/(.*?[\w\d\-_]+\.\w+)\//))&&(e=o[1].toLowerCase(),xows_tpl_embed_sites[e]&&(t=xows_tpl_embed_sites[e](s,e)),xows_tpl_embed_uplds[e]&&(t=xows_tpl_embed_uplds[e](s,e))),t&&(n+=t);return n}let xows_tpl_avat_cls_db={};function xows_tpl_spawn_avat_cls(_){if(_&&!(_ in xows_tpl_avat_cls_db)){const o=".h-"+_+' {background-image:url("'+xows_cach_avat_get(_)+'");}\r\n';xows_tpl_avat_cls_db[_]=o;const e=document.createElement("style");e.type="text/css",e.innerHTML=o,document.head.appendChild(e)}}function xows_tpl_spawn_rost_cont(_,o,e,s,t,n){const c=xows_tpl_model["ROST-CONT"].firstChild.cloneNode(!0);c.setAttribute("id",_),c.setAttribute("title",o+" ("+_+")"),c.querySelector("H3").innerHTML=o,c.querySelector("P").innerHTML=n||"";const i=c.querySelector(".PEER-SHOW"),l=c.querySelector(".PEER-SUBS"),a=c.querySelector("FIGURE");return s<XOWS_SUBS_TO?(c.classList.add("PEER-DENY"),i.classList.add("HIDDEN"),l.classList.remove("HIDDEN")):(i.setAttribute("show",null!==t?t:-1),xows_tpl_spawn_avat_cls(e),a.className="h-"+e),c}function xows_tpl_update_rost_cont(_,o,e,s,t,n){const c=_.getAttribute("id");_.setAttribute("title",o+" ("+c+")"),_.querySelector("H3").innerHTML=o,_.querySelector("P").innerHTML=n||"";const i=_.querySelector(".PEER-SHOW"),l=_.querySelector(".PEER-SUBS"),a=_.querySelector("FIGURE");s<XOWS_SUBS_TO?(_.classList.add("PEER-DENY"),i.classList.add("HIDDEN"),l.classList.remove("HIDDEN")):(_.classList.remove("PEER-DENY"),i.classList.remove("HIDDEN"),i.setAttribute("show",null!==t?t:-1),l.classList.add("HIDDEN"),xows_tpl_spawn_avat_cls(e),a.className="h-"+e)}function xows_tpl_spawn_room_occu(_,o,e,s,t,n){const c=xows_tpl_model["ROOM-OCCU"].firstChild.cloneNode(!0);return c.setAttribute("id",_),c.setAttribute("jid",s),c.setAttribute("title",o+" ("+s+")"),c.querySelector("H3").innerHTML=o,c.querySelector("P").innerHTML=n||"",c.querySelector(".PEER-SHOW").setAttribute("show",null!==t?t:-1),c.querySelector(".OCCU-SUBS").disabled=!s||0===s.length,xows_tpl_spawn_avat_cls(e),c.querySelector("FIGURE").className="h-"+e,c}function xows_tpl_update_room_occu(_,o,e,s,t,n){_.setAttribute("jid",s),_.setAttribute("title",o+" ("+s+")"),_.querySelector("H3").innerHTML=o,_.querySelector("P").innerHTML=n||"",_.querySelector(".PEER-SHOW").setAttribute("show",null!==t?t:-1),_.querySelector(".OCCU-SUBS").disabled=!s||0===s.length,xows_tpl_spawn_avat_cls(e),_.querySelector("FIGURE").className="h-"+e}function xows_tpl_spawn_rost_room(_,o,e,s){const t=xows_tpl_model["ROST-ROOM"].firstChild.cloneNode(!0);t.setAttribute("id",_),t.setAttribute("title",o+" ("+_+")"),t.querySelector("H3").innerHTML=o,t.querySelector("P").innerHTML=e;const n=t.querySelector("FIGURE");return s&&n.classList.add("ROOM-LOCK"),t}function xows_tpl_update_rost_room(_,o,e,s){const t=_.getAttribute("id");_.setAttribute("title",o+" ("+t+")"),_.querySelector("H3").innerHTML=o,_.querySelector("P").innerHTML=e;const n=_.querySelector("FIGURE");s?n.classList.add("ROOM-LOCK"):n.classList.remove("ROOM-LOCK")}function xows_tpl_spawn_rost_subs(_,o){const e=xows_tpl_model["ROST-SUBS"].firstChild.cloneNode(!0);return e.setAttribute("id",_),o&&e.setAttribute("name",o),e.setAttribute("title",_+" ("+o+")"),e.querySelector("H3").innerHTML=o||_,e}function xows_tpl_mesg_spawn(_,o,e,s,t,n,c){const i=xows_tpl_model[c?"MESG-FULL":"MESG-AGGR"].firstChild.cloneNode(!0);i.classList.add(t?"MESG-SENT":"MESG-RECV"),n&&i.classList.add("MESG-RECP"),i.setAttribute("id",_),i.setAttribute("from",o),i.setAttribute("time",s);const l=[];return i.querySelector("P").innerHTML=xows_tpl_format_body(e,l),l.length&&(i.querySelector("FOOTER").innerHTML=xows_tpl_format_embed(l)),c?(i.querySelector(".MESG-DATE").innerHTML=xows_l10n_date(s),i.querySelector(".MESG-FROM").innerHTML=c.name,xows_tpl_spawn_avat_cls(c.avat),i.querySelector("FIGURE").className="h-"+c.avat):i.querySelector(".MESG-HOUR").innerHTML=xows_l10n_houre(s),i}const xows_doc={},xows_doc_frag_db={};let xows_doc_loader_scroll={top:99999,off:0},xows_doc_loader_client=null,xows_doc_loader_attrib="";const xows_doc_loader_stack=[],xows_doc_sel=document.getSelection(),xows_doc_rng=document.createRange();function xows_doc_cache(_){xows_doc[_]=document.getElementById(_)}function xows_doc_listener_add(_,o,e,s=!0,t=!1){_.addEventListener(o,e,{capture:t,passive:s})}function xows_doc_listener_rem(_,o,e,s=!0,t=!1){_.removeEventListener(o,e,{capture:t,passive:s})}function xows_doc_listener_add_select(_,o,e,s,t=!0){const n=_.querySelectorAll(o);let c=n.length;for(;c--;)n[c].addEventListener(e,s,{capture:!1,passive:t})}function xows_doc_listener_rem_select(_,o,e,s,t=!0){const n=_.querySelectorAll(o);let c=n.length;for(;c--;)n[c].removeEventListener(e,s,{capture:!1,passive:t})}function xows_doc_cls_has(_,o){return xows_doc[_].classList.contains(o)}function xows_doc_cls_tog(_,o){return xows_doc[_].classList.toggle(o)}function xows_doc_cls_add(_,o){xows_doc[_].classList.add(o)}function xows_doc_cls_rem(_,o){xows_doc[_].classList.remove(o)}function xows_doc_cls_set(_,o,e){e?xows_doc[_].classList.add(o):xows_doc[_].classList.remove(o)}function xows_doc_show(_){xows_doc[_].classList.remove("HIDDEN")}function xows_doc_hide(_){xows_doc[_].classList.add("HIDDEN")}function xows_doc_hidden_set(_,o){o?xows_doc[_].classList.add("HIDDEN"):xows_doc[_].classList.remove("HIDDEN")}function xows_doc_hidden(_){return xows_doc[_].classList.contains("HIDDEN")}function xows_doc_frag_backup(_,o){for(xows_doc_frag_db[_]||(xows_doc_frag_db[_]={}),xows_doc_frag_db[_][o]=document.createDocumentFragment();xows_doc[o].childNodes.length;)xows_doc_frag_db[_][o].appendChild(xows_doc[o].firstChild)}function xows_doc_frag_copy(_,o,e){let s,t,n,c=!1;if(o?xows_doc_frag_db[o]&&xows_doc_frag_db[o][e]&&(s=xows_doc_frag_db[o][e]):s=xows_doc[e],_?(xows_doc_frag_db[_]||(xows_doc_frag_db[_]={}),xows_doc_frag_db[_][e]=document.createDocumentFragment(),t=xows_doc_frag_db[_][e]):((t=xows_doc[e]).innerHTML="",c=!0),s&&t!==s)for(let _=0,o=s.childNodes.length;_<o;++_)n=s.childNodes[_].cloneNode(!0),t.appendChild(n),c&&n.id&&(xows_doc[n.id]=n)}function xows_doc_frag_restore(_,o){if(xows_doc_frag_db[_]){let e;for(xows_doc[o].innerHTML="";xows_doc_frag_db[_][o].childNodes.length;)e=xows_doc_frag_db[_][o].firstChild,xows_doc[o].appendChild(e),e.id&&(xows_doc[e.id]=e)}}function xows_doc_frag(_,o){return xows_doc_frag_db[_]?xows_doc_frag_db[_][o]:null}function xows_doc_frag_element(_,o){let e;for(const s in xows_doc_frag_db[_])if(e=xows_doc_frag_db[_][s].getElementById(o))return e;return null}function xows_doc_get_child(_,o){let e=_.childNodes.length;for(;e--;)if(_.childNodes[e].id===o)return _.childNodes[e];return null}function xows_doc_caret_around(_,o=!1){xows_doc_sel.removeAllRanges(),xows_doc_rng.setStartBefore(_),xows_doc_rng.setEndAfter(_),xows_doc_rng.collapse(o),xows_doc_sel.addRange(xows_doc_rng)}function xows_doc_caret_at(_,o=!1){xows_doc_sel.removeAllRanges(),xows_doc_rng.selectNodeContents(_),xows_doc_rng.collapse(o),xows_doc_sel.addRange(xows_doc_rng)}function xows_doc_sel_rng(_){return xows_doc_sel.getRangeAt(_)}function xows_doc_init(_){const o=document.querySelectorAll("[id]");let e=o.length;for(;e--;)xows_doc_cache(o[e].id);xows_doc_listener_add(xows_doc.main_tabs,"click",xows_gui_rost_widen),xows_doc_listener_add(xows_doc.main_hndr,"click",xows_gui_main_open),xows_doc_listener_add(xows_doc.main_hndl,"click",xows_gui_main_open),xows_doc_listener_add(xows_doc.rost_tabs,"click",xows_gui_rost_tabs_onclick),xows_doc_listener_add(xows_doc.cont_list,"click",xows_gui_rost_list_onclick),xows_doc_listener_add(xows_doc.room_list,"click",xows_gui_rost_list_onclick),xows_doc_listener_add(xows_doc.cont_add,"click",xows_gui_page_cont_open),xows_doc_listener_add(xows_doc.room_add,"click",xows_gui_room_add_onclick),xows_doc_listener_add(xows_doc.room_upd,"click",xows_gui_room_list_reload),xows_doc_listener_add(xows_doc.occu_list,"click",xows_gui_occu_list_onclick),xows_doc_listener_add(xows_doc.menu_show,"click",xows_gui_menu_show_onclick),xows_doc_listener_add(xows_doc.drop_show,"click",xows_gui_menu_show_onclick),xows_doc_listener_add(xows_doc.menu_user,"click",xows_gui_page_user_open),xows_doc_listener_add(xows_doc.user_stat,"keypress",xows_gui_user_stat_onkeyp),xows_doc_listener_add(xows_doc.user_stat,"blur",xows_gui_user_stat_onblur),xows_doc_listener_add(xows_doc.send_edit,"keydown",xows_gui_send_edit_onkeyp,!1),xows_doc_listener_add(xows_doc.send_edit,"keyup",xows_gui_send_edit_onkeyp),xows_doc_listener_add(xows_doc.send_edit,"input",xows_gui_send_edit_oninput),xows_doc_listener_add(xows_doc.send_edit,"click",xows_gui_send_edit_onclick),xows_doc_listener_add(xows_doc.chat_main,"scroll",xows_gui_chat_main_onscroll),xows_doc_listener_add(xows_doc.chat_main,"click",xows_gui_chat_main_onclick),xows_doc_listener_add(xows_doc.chat_file,"change",xows_gui_chat_file_onchange),xows_doc_listener_add(xows_doc.chat_upld,"click",xows_gui_chat_upld_onclick),xows_doc_listener_add(xows_doc.menu_emoj,"click",xows_gui_menu_emoj_onclick),xows_doc_listener_add(xows_doc.chat_meta,"keypress",xows_gui_chat_meta_onkeyp),xows_doc_listener_add(xows_doc.chat_meta,"blur",xows_gui_chat_meta_onblur),xows_doc_listener_add(xows_doc.chat_noti,"click",xows_gui_chat_noti_onclick),xows_doc_listener_add(xows_doc.chat_conf,"click",xows_gui_chat_conf_onclick),xows_doc_listener_add(xows_doc.chat_occu,"click",xows_gui_chat_occu_onclick),xows_doc_listener_add(xows_doc.scr_page,"keyup",xows_doc_page_onkeyu),xows_doc_listener_add(xows_doc.page_exit,"click",xows_doc_page_onclose),xows_doc_listener_add(xows_doc.upld_exit,"click",xows_gui_upld_onclose),xows_options.allow_register&&xows_doc_show("auth_regi"),xows_doc_listener_add(xows_doc.scr_void,"click",xows_doc_void_onclick),xows_doc_listener_add(xows_doc.mbox_close,"click",xows_doc_mbox_close),xows_doc_listener_add(xows_doc.mbox_abort,"click",xows_doc_mbox_onabort),xows_doc_listener_add(xows_doc.mbox_valid,"click",xows_doc_mbox_onvalid),xows_doc_listener_add(document,"visibilitychange",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"focus",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"blur",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"beforeunload",xows_gui_wnd_onunload),xows_doc_listener_add(window,"popstate",xows_gui_nav_onpopstate),xows_gui_notify_sound=new Audio("/"+xows_options.root+"/sounds/notify.mp3?456"),xows_doc_frag_copy("empty",null,"chat_hist"),xows_doc_frag_copy("empty",null,"occu_list"),xows_log(2,"gui_start","document ready"),xows_isfunc(_)&&_()}function xows_doc_loader_clear(){xows_doc_loader_stack.length=0,xows_doc_loader_scroll.top=99999,xows_log(2,"doc_loader_clear","loader stack cleared")}function xows_doc_loader_setup(_,o){xows_doc_loader_attrib=o,xows_log(2,"doc_loader_setup","now search elements with attribute",o),xows_doc_loader_client!==_&&(xows_doc_loader_client&&(xows_doc_listener_rem(xows_doc_loader_client,"scroll",xows_doc_loader_check),xows_log(2,"doc_loader_setup","removing scroll listener from element","<"+xows_doc_loader_client.tagName+' id="'+xows_doc_loader_client.getAttribute("id")+'">')),(xows_doc_loader_client=_)&&(xows_doc_listener_add(xows_doc_loader_client,"scroll",xows_doc_loader_check),xows_log(2,"doc_loader_setup","adding scroll listener to element","<"+_.tagName+' id="'+_.getAttribute("id")+'">'))),xows_doc_loader_scroll.top=99999}function xows_doc_loader_monitor(_){const o=Array.from(_.querySelectorAll("["+xows_doc_loader_attrib+"]"));if(o.length){xows_log(2,"doc_loader_monitor","adding to monitoring stack",o.length+" new element(s)");let _=o.length;for(;_--;)xows_doc_loader_stack.push(o[_])}}function xows_doc_loader_onload(_){_.parentNode.classList.remove("LOADING"),_.classList.remove("FLATTEN"),xows_doc_loader_client.scrollTop=xows_doc_loader_client.scrollHeight-xows_doc_loader_scroll.off}function xows_doc_loader_check(_){if(!xows_doc_loader_stack.length)return;if(!_&&Math.abs(xows_doc_loader_client.scrollTop-xows_doc_loader_scroll.top)<120)return;xows_doc_loader_scroll.top=xows_doc_loader_client.scrollTop,xows_doc_loader_scroll.off=xows_doc_loader_client.scrollHeight-xows_doc_loader_scroll.top;const o=xows_doc_loader_client.getBoundingClientRect();let e,s,t=xows_doc_loader_stack.length;for(;t--;)(e=(s=xows_doc_loader_stack[t]).getBoundingClientRect()).bottom>o.top&&e.top<=o.bottom&&(s.hasAttribute("NOLOADER")||(s.classList.add("FLATTEN"),s.parentNode.classList.add("LOADING"),s.onload=function(){xows_doc_loader_onload(this)}),s.src=s.getAttribute(xows_doc_loader_attrib),s.removeAttribute(xows_doc_loader_attrib),xows_doc_loader_stack.splice(t,1),xows_log(2,"doc_loader_check","loading",s.src))}function xows_doc_blink(_,o){xows_doc_cls_has(_,"BLINK")?xows_doc_cls_rem(_,"BLINK"):(xows_doc_cls_add(_,"BLINK"),setTimeout(xows_doc_blink,o,_))}let xows_doc_mbox_cb_onabort=null,xows_doc_mbox_cb_onvalid=null;function xows_doc_mbox_onabort(_){xows_doc_mbox_cb_onabort&&(xows_doc_mbox_cb_onabort(),xows_doc_mbox_close())}function xows_doc_mbox_onvalid(_){xows_doc_mbox_cb_onvalid&&(xows_doc_mbox_cb_onvalid(),xows_doc_mbox_close())}function xows_doc_mbox_open(_,o,e,s,t,n,c){if(xows_doc_mbox_modal())return;let i;switch(xows_doc_mbox_close(),_){case 0:i="TEXT-ERR";break;case 1:i="TEXT-WRN";break;case 2:i="TEXT-SCS";break;case 4:i="TEXT-ASK"}xows_doc.mbox_text.classList=i,xows_doc.mbox_text.innerHTML=xows_l10n_get(o),xows_doc_hidden_set("mbox_close",e||t),xows_doc_hidden_set("mbox_valid",!e),xows_doc_hidden_set("mbox_abort",!t),e&&(xows_doc.mbox_valid.innerHTML=xows_l10n_get(s)),t&&(xows_doc.mbox_abort.innerHTML=xows_l10n_get(n)),xows_doc_mbox_cb_onabort=t,xows_doc_mbox_cb_onvalid=e,c&&xows_doc_show("scr_void"),xows_doc_show("over_mbox")}function xows_doc_mbox_open_for_save(_,o){xows_doc_hidden("over_mbox")&&xows_doc_mbox_open(3,"It remains unsaved changes",_,"Save changes",o,"Reset")}function xows_doc_mbox_close(){xows_doc_mbox_cb_onabort=null,xows_doc_mbox_cb_onvalid=null,xows_doc_hide("over_mbox"),xows_doc_hide("scr_void")}function xows_doc_mbox_modal(){return!(xows_doc_hidden("over_mbox")||!xows_doc_mbox_cb_onabort)&&(xows_doc_blink("over_mbox",400),!0)}let xows_doc_page_id=null,xows_doc_page_cb_onclose=null,xows_doc_page_cb_oninput=null,xows_doc_page_cb_onclick=null;function xows_doc_page_oninput(_){xows_doc_page_cb_oninput(_.target)}function xows_doc_page_onclick(_){xows_doc_page_cb_onclick(_.target)}function xows_doc_page_onclose(_){xows_doc_mbox_modal()||xows_doc_page_close()}function xows_doc_page_close(_=!1){xows_doc_page_id&&(xows_log(2,"gui_page_close",(_?"soft":"hard")+" close",xows_doc_page_id),xows_doc_page_cb_oninput&&(xows_doc_listener_rem(xows_doc[xows_doc_page_id],"input",xows_doc_page_oninput),xows_doc_page_cb_oninput=null),xows_doc_page_cb_onclick&&(xows_doc_listener_rem(xows_doc[xows_doc_page_id],"click",xows_doc_page_onclick),xows_doc_page_cb_onclick=null),xows_doc_page_cb_onclose&&xows_doc_page_cb_onclose(),xows_doc_page_cb_onclose=null,xows_doc_hide("colr_exit"),xows_doc_hide(xows_doc_page_id),xows_doc_page_id=null,xows_doc_mbox_close(),_||xows_gui_main_open())}function xows_doc_page_open(_,o,e,s,t){xows_cli_activity_wakeup();let n=null!==xows_doc_page_id;n&&xows_doc_page_close(!0),xows_log(2,"gui_dlg_open",_),n||(xows_doc_hide("scr_main"),xows_doc_show("scr_page")),xows_doc_show(_),xows_doc_page_id=_,o&&xows_doc_show("colr_exit"),xows_doc_page_cb_onclose=e,s&&(xows_doc_page_cb_oninput=s,xows_doc_listener_add(xows_doc[_],"input",xows_doc_page_oninput)),t&&(xows_doc_page_cb_onclick=t,xows_doc_listener_add(xows_doc[_],"click",xows_doc_page_onclick)),xows_doc_mbox_close()}function xows_doc_page_onkeyu(_){if(xows_doc_page_id&&13===_.keyCode)if(xows_doc_hidden("over_mbox")||xows_doc_hidden("mbox_valid")){const _=xows_doc[xows_doc_page_id].querySelector("*[type='submit']");_&&_.click()}else xows_doc.mbox_valid.click()}function xows_doc_page_opened(_){return xows_doc_page_id==_}const xows_doc_menu={};function xows_doc_menu_close(){xows_doc_hide("scr_void"),xows_doc_hide(xows_doc_menu.drop),xows_doc_menu.btn.blur(),xows_doc_menu.btn=null,xows_doc_menu.drop=null}function xows_doc_menu_toggle(_,o){xows_doc_menu.btn?xows_doc_menu_close():(xows_doc_show("scr_void"),xows_doc_show(o),_.focus(),xows_doc_menu.btn=_,xows_doc_menu.drop=o)}function xows_doc_view_close(){xows_doc_hidden("over_view")||(xows_doc_hide("over_view"),xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"))}function xows_doc_view_open(_){"IMG"===_.tagName&&(xows_doc.view_img.src=_.src,xows_doc.view_open.href=_.src,xows_doc_show("over_view"),xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void"))}function xows_doc_void_onclick(_){xows_doc_menu.btn&&xows_doc_menu_close(),xows_doc_view_close(),xows_doc_mbox_modal()}const XOWS_MESG_AGGR_THRESHOLD=6e5,XOWS_GUI_HIST_SIZE=55;let xows_gui_locale="en-US",xows_gui_auth=null,xows_gui_peer=null,xows_gui_notify_sound=null,xows_gui_has_focus=!0,xows_gui_clean=!0;function xows_gui_peer_element(_,o){return _===xows_gui_peer?xows_doc[o]?xows_doc[o]:document.getElementById(o):xows_doc_frag_element(_.bare,o)}const xows_gui_peer_scroll_db={};function xows_gui_peer_scroll_backup(_){_.bare in xows_gui_peer_scroll_db||(xows_gui_peer_scroll_db[_.bare]={}),xows_gui_peer_scroll_db[_.bare]={scrollTop:xows_doc.chat_main.scrollTop,scrollHeight:xows_doc.chat_main.scrollHeight,clientHeight:xows_doc.chat_main.clientHeight}}function xows_gui_peer_scroll_restore(_){_.bare in xows_gui_peer_scroll_db&&(xows_doc.chat_main.scrollTop=xows_gui_peer_scroll_db[_.bare].scrollTop)}function xows_gui_peer_scroll_top(_){return _!==xows_gui_peer?xows_gui_peer_scroll_db[_.bare].scrollTop:xows_doc.chat_main.scrollTop}function xows_gui_peer_scroll_bot(_){const o=_!==xows_gui_peer?xows_gui_peer_scroll_db[_.bare]:xows_doc.chat_main;return o.scrollHeight-o.scrollTop-o.clientHeight}function xows_gui_peer_scroll_off(_){const o=_!==xows_gui_peer?xows_gui_peer_scroll_db[_.bare]:xows_doc.chat_main;return o.scrollHeight-o.scrollTop}function xows_gui_peer_scroll_down(_){const o=_!==xows_gui_peer?xows_gui_peer_scroll_db[_.bare]:xows_doc.chat_main;o.scrollTop=o.scrollHeight}function xows_gui_peer_scroll_seek(_,o){const e=_!==xows_gui_peer?xows_gui_peer_scroll_db[_.bare]:xows_doc.chat_main;e.scrollTop=e.scrollHeight-o}function xows_gui_connect(_=!1){xows_doc_mbox_close(),xows_options.domain&&(xows_gui_auth.user+="@"+xows_options.domain),xows_cli_set_callback("connect",xows_gui_cli_onconnect),xows_cli_set_callback("selfchange",xows_gui_cli_onselfchange),xows_cli_set_callback("contpush",xows_gui_cli_oncontpush),xows_cli_set_callback("contrem",xows_gui_cli_oncontrem),xows_cli_set_callback("subspush",xows_gui_cli_onsubspush),xows_cli_set_callback("subsrem",xows_gui_cli_onsubsrem),xows_cli_set_callback("roompush",xows_gui_cli_onroompush),xows_cli_set_callback("occupush",xows_gui_cli_onoccupush),xows_cli_set_callback("occurem",xows_gui_cli_onoccurem),xows_cli_set_callback("message",xows_gui_cli_onmessage),xows_cli_set_callback("chatstate",xows_gui_cli_onchatstate),xows_cli_set_callback("receipt",xows_gui_cli_onreceipt),xows_cli_set_callback("subject",xows_gui_cli_onsubject),xows_cli_set_callback("error",xows_gui_cli_onerror),xows_cli_set_callback("close",xows_gui_cli_onclose),xows_gui_clean=!1,xows_cli_connect(xows_options.url,xows_gui_auth.user,xows_gui_auth.pass,_)}function xows_gui_cli_onconnect(_){if(xows_gui_auth.cred&&(xows_log(2,"gui_loggedin","Saving credential"),window.PasswordCredential)){const _={id:xows_gui_auth.user,password:xows_gui_auth.pass},o=new PasswordCredential(_);navigator.credentials.store(o)}xows_gui_auth=null,xows_gui_main_open(),xows_gui_rost_widen(),xows_gui_peer=null,xows_doc_loader_setup(xows_doc.chat_main,"lazy_src"),xows_cli_svc_exist(XOWS_NS_HTTPUPLOAD)&&(xows_doc.chat_upld.disabled=!1,xows_tpl_embed_add_upld(xows_cli_svc_url[XOWS_NS_HTTPUPLOAD])),xows_cli_svc_exist(XOWS_NS_MUC)&&(xows_doc.tab_room.disabled=!1),xows_gui_room_list_reload()}function xows_gui_disconnect(){xows_log(2,"gui_disconnect","prepare to disconnect"),xows_gui_peer&&xows_cli_chatstate_set(xows_gui_peer,XOWS_CHAT_GONE),xows_cli_disconnect()}function xows_gui_cli_onclose(_,o){xows_gui_clean||(xows_gui_reset(),xows_gui_page_auth_open()),o&&xows_doc_mbox_open(_,o)}function xows_gui_cli_onerror(_,o){xows_doc_mbox_open(_,o)}const xows_gui_nav_stack=[];let xows_gui_nav_lock=!1,xows_gui_nav_pos=0;function xows_gui_nav_push(_,o,...e){if(xows_gui_nav_lock||!xows_cli_connected())return;xows_gui_nav_pos<xows_gui_nav_stack.length&&xows_gui_nav_stack.splice(xows_gui_nav_pos+1);const s=xows_gui_nav_stack.length;history.pushState({pos:s,page:_},"",window.location.pathname+"#"+_),xows_gui_nav_stack.push({func:o,args:[...e]}),xows_gui_nav_pos++}function xows_gui_nav_onpopstate(_){if(_.state){const o=_.state.pos,e=xows_gui_nav_stack[o];if(e&&e.func)return xows_gui_nav_lock=!0,e.func(...e.args),xows_gui_nav_lock=!1,void(xows_gui_nav_pos=o)}xows_cli_connected()&&!xows_doc_mbox_modal()&&(history.forward(),xows_gui_mbox_exit_open())}function xows_gui_wnd_onfocus(){const _=xows_gui_has_focus;(xows_gui_has_focus=document.hasFocus())&&!_&&xows_cli_activity_wakeup()}function xows_gui_wnd_onunload(_){xows_log(2,"gui_evt_unload","Unload event from browser"),xows_gui_disconnect()}let xows_gui_notify_permi=0,xows_gui_notify_await=null;function xows_gui_notify_allow(_){xows_gui_peer&&(xows_gui_peer.noti=_,_?(xows_doc.chat_noti.title=xows_l10n_get("Disable notifications"),xows_gui_notify_permi="granted"):(xows_doc.chat_noti.title=xows_l10n_get("Enable notifications"),xows_gui_notify_permi=0),xows_doc_cls_set("chat_noti","CHAT-MUTE",_),xows_doc_cls_set("chat_noti","CHAT-NOTI",!_))}function xows_gui_notify_query_handle(_){xows_gui_peer&&(xows_gui_notify_permi=_,"granted"===_&&(xows_gui_notify_allow(!0),xows_gui_notify_await&&(xows_gui_notify_push(xows_gui_notify_await.title,xows_gui_notify_await.body,xows_gui_notify_await.avat),xows_gui_notify_await=null)))}function xows_gui_notify_query(){xows_gui_peer&&(xows_gui_notify_permi=0,Notification.requestPermission().then(xows_gui_notify_query_handle))}function xows_gui_notify_push(_,o,e){switch(xows_gui_notify_permi){case"denied":return;case"granted":{const s=xows_cach_avat_get(e);new Notification(_,{body:o,icon:s||"/"+xows_options.root+"/icon.svg"});xows_gui_notify_sound.play()}break;default:xows_gui_notify_await={title:_,body:o,avat:e},xows_gui_notify_query()}}function xows_gui_reset(){xows_log(2,"gui_reset","reset DOM states"),xows_gui_switch_peer(null);const _=["scr_main","scr_void","page_cont","page_user","page_join","page_room","page_regi","page_auth","page_wait","drop_show","drop_emoj","chat_fram","chat_stat","hist_end","hist_new","room_list"];let o=_.length;for(;o--;)xows_doc_hide(_[o]);xows_doc.cont_ul.innerHTML="",xows_doc.room_ul.innerHTML="",xows_doc.favs_ul.innerHTML="",xows_doc.hist_ul.innerHTML="",xows_doc.modo_ul.innerHTML="",xows_doc.memb_ul.innerHTML="",xows_doc.hist_beg.innerHTML="",xows_doc_cls_add("tab_cont","TAB-ENABLED"),xows_doc_cls_rem("tab_room","TAB-ENABLED"),xows_doc_show("cont_list"),xows_doc_cls_rem("main_coll","COL-THIN"),xows_doc_cls_rem("main_coll","COL-WIDE"),xows_doc_cls_rem("main_coll","COL-HIDE"),xows_doc_cls_rem("main_colr","COL-THIN"),xows_doc_cls_rem("main_colr","COL-WIDE"),xows_doc_cls_add("main_colr","COL-HIDE");for(const _ in xows_doc_frag_db)"empty"!==_&&delete xows_doc_frag_db[_];xows_gui_clean=!0}function xows_gui_switch_peer(_){const o=xows_gui_peer;if(o){if(_===o.bare)return;xows_cli_chatstate_set(o,XOWS_CHAT_GONE),xows_gui_upld_onclose()}const e=_?xows_cli_peer_get(_):null;o&&(xows_gui_peer_scroll_backup(o),xows_doc_frag_backup(o.bare,"chat_hist"),xows_doc_frag_backup(o.bare,"occu_list"),e&&e.type===o.type&&document.getElementById(o.bare).classList.remove("SELECTED")),null===e?xows_doc_hide("chat_fram"):xows_doc_show("chat_fram");let s=!1;e?(document.getElementById(e.bare).classList.add("SELECTED"),xows_doc_frag_restore(e.bare,"chat_hist"),xows_doc_frag_restore(e.bare,"occu_list"),xows_gui_peer_scroll_restore(e),xows_doc_cls_set("main_colr","COL-HIDE",e.type!==XOWS_PEER_ROOM),xows_gui_peer=e,e.type===XOWS_PEER_ROOM&&(e.join||xows_cli_room_join(e)),xows_gui_unread_reset(e),xows_doc_loader_clear(),xows_doc_loader_monitor(xows_doc.chat_main),xows_doc_loader_check(!0),xows_doc.hist_ul.childNodes.length<40&&xows_gui_mam_query(!1,40,0),xows_gui_peer_scroll_bot(e)<50&&xows_gui_peer_scroll_down(e),xows_log(2,"gui_switch_peer",'peer "'+e.bare+'"',"selected"),s=!0):xows_gui_peer&&(xows_log(2,"gui_switch_peer","unselect peer"),xows_gui_peer=null,xows_doc_frag_copy(null,"empty","chat_hist"),xows_doc_frag_copy(null,"empty","occu_list"),xows_doc_cls_add("main_colr","COL-HIDE"),s=!0),xows_gui_writing_clear(),xows_gui_chat_fram_update(),s&&xows_gui_nav_push("switch_peer",xows_gui_switch_peer,_)}function xows_gui_panel_close(){xows_doc_cls_rem("main_wrap","COLR-WIDE"),xows_doc_cls_rem("main_wrap","COLL-WIDE")}function xows_gui_main_open(){xows_doc_hidden("scr_page")||(xows_doc_page_close(!0),xows_doc_hide("scr_page"),xows_doc_show("scr_main")),xows_gui_panel_close(),xows_gui_nav_push("main_open",xows_gui_main_open)}function xows_gui_room_privi_update(_){let o,e;const s=xows_gui_peer.affi,t=xows_gui_peer.role;_||(o=t>XOWS_ROLE_PART,e=s>XOWS_AFFI_ADMN),xows_doc_hidden_set("chat_conf",!e),xows_doc_cls_set("chat_meta","ENABLED",o),xows_doc.chat_meta.setAttribute("contenteditable",o),xows_doc.chat_meta.title=o?xows_l10n_get("Change Room topic"):""}function xows_gui_mbox_exit_onabort(){}function xows_gui_mbox_exit_onvalid(){xows_gui_disconnect(),history.back()}function xows_gui_mbox_exit_open(){xows_doc_mbox_open(1,"Do you really want to disconnect current session ?",xows_gui_mbox_exit_onvalid,"Yes",xows_gui_mbox_exit_onabort,"No",!0)}const xows_gui_mbox_subs_edit={};function xows_gui_mbox_subs_edit_onabort(){xows_gui_mbox_subs_edit.bare=null,xows_gui_mbox_subs_edit.name=null}function xows_gui_mbox_subs_edit_onvalid(){xows_cli_rost_edit(xows_gui_mbox_subs_edit.bare,xows_gui_mbox_subs_edit.name),xows_gui_mbox_subs_edit.bare=null,xows_gui_mbox_subs_edit.name=null}function xows_gui_mbox_subs_edit_open(_,o){let e,s;xows_gui_mbox_subs_edit.bare=_,o?(xows_gui_mbox_subs_edit.name=o,s=4,e="Add contact and request authorisation ?"):(s=1,e="Remove contact and revoke authorization ?"),xows_doc_mbox_open(s,e,xows_gui_mbox_subs_edit_onvalid,"OK",xows_gui_mbox_subs_edit_onabort,"Cancel",!0)}const xows_gui_mbox_subs_auth={};function xows_gui_mbox_subs_auth_onabort(){xows_cli_subscribe_allow(xows_gui_mbox_subs_auth.bare,!1),xows_gui_mbox_subs_auth.bare=null,xows_gui_mbox_subs_auth.name=null}function xows_gui_mbox_subs_auth_onvalid(){xows_cli_subscribe_allow(xows_gui_mbox_subs_auth.bare,!0,xows_gui_mbox_subs_auth.name),xows_gui_mbox_subs_auth.bare=null,xows_gui_mbox_subs_auth.name=null}function xows_gui_mbox_subs_auth_open(_,o){xows_gui_mbox_subs_auth.bare=_,xows_gui_mbox_subs_auth.name=o,xows_doc_mbox_open(4,"Allow contact subscription ?",xows_gui_mbox_subs_auth_onvalid,"Allow",xows_gui_mbox_subs_auth_onabort,"Deny",!0)}function xows_gui_rost_widen(){xows_cli_activity_wakeup(),window.matchMedia("(max-width: 799px)").matches&&(xows_doc_cls_has("main_wrap","COLL-WIDE")||(xows_doc_cls_rem("main_wrap","COLR-WIDE"),xows_doc_cls_add("main_wrap","COLL-WIDE"),xows_gui_nav_push("panel_open",xows_gui_rost_widen)))}function xows_gui_rost_switch(_){let o,e=!1;const s="tab_cont"===_,t="tab_room"===_;if(t&&xows_doc_cls_has("tab_cont","ENABLED")&&(e=!0,xows_doc.rost_titl.innerHTML=xows_l10n_get("Chat rooms"),o=xows_doc.room_ul),s&&xows_doc_cls_has("tab_room","ENABLED")&&(e=!0,xows_doc.rost_titl.innerHTML=xows_l10n_get("Contacts"),o=xows_doc.cont_ul),e&&(xows_doc_cls_set("tab_cont","ENABLED",s),xows_doc_cls_set("tab_room","ENABLED",t),xows_doc_hidden_set("cont_list",!s),xows_doc_hidden_set("room_list",!t),xows_doc_hidden_set("cont_add",!s),xows_doc_hidden_set("room_add",!t),xows_doc_hidden_set("room_upd",!t),o)){const _=o.querySelector(".SELECTED");xows_gui_switch_peer(_?_.id:null)}}function xows_gui_rost_tabs_onclick(_){xows_cli_activity_wakeup();const o=_.target.closest("button");o&&xows_gui_rost_switch(o.id)}function xows_gui_rost_list_onclick(_){xows_cli_activity_wakeup();const o=_.target.closest("li");if(o)if("ROST-SUBS"===o.className)xows_gui_mbox_subs_auth_open(o.id,o.name);else if("BUTTON"===_.target.tagName)switch(_.target.name){case"subs":return xows_cli_subscribe_request(o.id),void xows_doc_mbox_open(2,"New authorization request was sent");case"rem":return void xows_gui_mbox_subs_edit_open(o.id)}else xows_gui_switch_peer(o.id),xows_gui_panel_close()}function xows_gui_unread_add(_,o){let e,s;e=(s=_.type===XOWS_PEER_ROOM?xows_doc.room_unrd:xows_doc.cont_unrd).firstChild?parseInt(s.innerHTML):0,s.innerHTML=e+1,s.classList.remove("HIDDEN");const t=document.getElementById(_.bare);if(t){const _=t.querySelector(".UNRD-SPOT");e=_.firstChild?parseInt(_.innerHTML):0,_.innerHTML=e+1,_.classList.remove("HIDDEN")}}function xows_gui_unread_reset(_){let o,e;o=(e=_.type===XOWS_PEER_ROOM?xows_doc.room_unrd:xows_doc.cont_unrd).firstChild?parseInt(e.innerHTML):0;const s=document.getElementById(_.bare);if(s){const _=s.querySelector(".UNRD-SPOT");o-=_.firstChild?parseInt(_.innerHTML):0,_.innerHTML="",_.classList.add("HIDDEN")}e.innerHTML=o>0?o:"",o<=0&&e.classList.add("HIDDEN")}function xows_gui_cont_list_reload(){xows_gui_switch_peer(null),xows_doc.cont_ul.innerHTML="",xows_doc_cls_add("cont_list","LOADING"),xows_cli_rost_get_query()}function xows_gui_cli_oncontpush(_){if(null===_)return void xows_doc_cls_rem("cont_list","LOADING");const o=document.getElementById(_.bare);o?(xows_tpl_update_rost_cont(o,_.name,_.avat,_.subs,_.show,_.stat),_===xows_gui_peer&&xows_gui_chat_fram_update()):(xows_doc_cls_rem("cont_ul","LOADING"),xows_doc.cont_ul.appendChild(xows_tpl_spawn_rost_cont(_.bare,_.name,_.avat,_.subs,_.show,_.stat)),xows_doc_frag_copy(_.bare,"empty","chat_hist"),xows_gui_peer_scroll_backup(_),xows_doc_frag_copy(_.bare,"empty","occu_list"))}function xows_gui_cli_oncontrem(_){const o=document.getElementById(_);o&&o.parentNode.removeChild(o)}function xows_gui_cli_onsubspush(_,o){let e=xows_doc.subs_ul.childNodes.length;for(;e--;)if(xows_doc.subs_ul.childNodes[e].id===_)return;xows_doc.subs_ul.appendChild(xows_tpl_spawn_rost_subs(_,o)),xows_doc_show("subs_unrd"),xows_doc.subs_unrd.innerHTML=xows_doc.subs_ul.childNodes.length}function xows_gui_cli_onsubsrem(_){let o=xows_doc.subs_ul.childNodes.length;for(;o--;)if(xows_doc.subs_ul.childNodes[o].id===_){xows_doc.subs_ul.removeChild(xows_doc.subs_ul.childNodes[o]);break}const e=xows_doc.subs_ul.childNodes.length;e?xows_doc.subs_unrd.innerHTML=e:(xows_doc.subs_unrd.innerHTML="",xows_doc_hide("subs_unrd"))}function xows_gui_room_list_reload(){xows_gui_switch_peer(null),xows_doc.room_ul.innerHTML="",xows_doc_cls_add("room_list","LOADING"),setTimeout(xows_cli_muc_items_query,500)}function xows_gui_room_add_onclick(_){xows_cli_activity_wakeup(),xows_gui_page_join_open()}function xows_gui_cli_onroompush(_){if(null===_)return void xows_doc_cls_rem("room_list","LOADING");const o=document.getElementById(_.bare);o?(xows_tpl_update_rost_room(o,_.name,_.desc,_.lock),_===xows_gui_peer&&xows_gui_chat_fram_update()):(xows_doc_cls_rem("room_list","LOADING"),xows_doc.room_ul.appendChild(xows_tpl_spawn_rost_room(_.bare,_.name,_.desc,_.lock)),xows_doc_frag_copy(_.bare,"empty","chat_hist"),xows_gui_peer_scroll_backup(_),xows_doc_frag_copy(_.bare,"empty","occu_list"))}function xows_gui_cli_onselfchange(_){xows_doc.user_stat.value=_.stat?_.stat:"",xows_doc.user_stat.blur(),xows_doc.user_show.setAttribute("show",_.show),xows_doc.user_name.innerHTML=_.name,xows_doc.user_addr.innerHTML="("+_.bare+")",xows_tpl_spawn_avat_cls(_.avat),xows_doc.user_avat.className="h-"+_.avat}function xows_gui_menu_show_onclick(_){const o=_.target.closest("li");if(o){const _=parseInt(o.getAttribute("name"));if(!(_>=0))return xows_doc.auth_user.value="",xows_doc.auth_pass.value="",navigator.credentials&&navigator.credentials.preventSilentAccess(),void xows_gui_disconnect();xows_cli_change_presence(_)}xows_doc_menu_toggle(xows_doc.menu_show,"drop_show"),xows_cli_activity_wakeup()}function xows_gui_chat_fram_update(){if(!xows_gui_peer)return xows_doc.chat_titl.innerHTML="",xows_doc.chat_addr.innerHTML="",xows_doc.chat_meta.title="",xows_doc.chat_meta.innerHTML="",xows_doc.send_wrap.setAttribute("placeholder",""),xows_doc.chat_stat.innerHTML="",void xows_doc_hide("chat_show");xows_doc.chat_titl.innerHTML=xows_gui_peer.name,xows_gui_peer.type===XOWS_PEER_CONT?(xows_doc_show("chat_show"),xows_doc_show("chat_addr"),xows_doc.chat_show.setAttribute("show",xows_gui_peer.show),xows_doc.chat_addr.innerHTML="("+xows_gui_peer.bare+")",xows_doc.chat_meta.innerHTML=xows_gui_peer.stat?xows_gui_peer.stat:"",xows_doc_hide("chat_occu"),xows_gui_room_privi_update(!0)):(xows_doc_hide("chat_show"),xows_doc_hide("chat_addr"),xows_doc.chat_meta.innerHTML=xows_gui_peer.subj,xows_doc_show("chat_occu"),xows_gui_room_privi_update()),xows_gui_peer.noti?xows_gui_notify_allow(!0):xows_gui_notify_allow(!1),xows_doc.send_wrap.setAttribute("placeholder",xows_l10n_get("Send a message to")+" "+xows_gui_peer.name+" ...")}function xows_gui_chat_noti_onclick(_){xows_doc_cls_has("chat_noti","CHAT-MUTE")?xows_gui_notify_allow(!1):xows_gui_notify_query()}function xows_gui_chat_conf_onclick(_){xows_cli_activity_wakeup(),xows_cli_room_cfg_get(xows_gui_peer,xows_gui_page_room_open)}function xows_gui_chat_occu_onclick(_){xows_cli_activity_wakeup(),window.matchMedia("(max-width: 799px)").matches?xows_doc_cls_add("main_wrap","COLR-WIDE"):xows_doc_cls_tog("main_colr","COL-HIDE")}function xows_gui_chat_meta_onblur(_){xows_cli_activity_wakeup();const o=xows_doc.chat_meta.innerText;o!=xows_gui_peer.subj&&xows_cli_send_subject(xows_gui_peer,o)}function xows_gui_chat_meta_onkeyp(_){13===_.keyCode&&xows_doc.chat_meta.blur()}function xows_gui_cli_onsubject(_,o){_===xows_gui_peer&&(xows_doc.chat_meta.innerHTML=o||"")}function xows_gui_chat_main_onscroll(_){const o=xows_doc.chat_main;o.scrollHeight!==o.clientHeight&&(o.scrollTop<20&&xows_gui_mam_query(!1),o.scrollHeight-o.scrollTop-o.clientHeight<20&&(xows_doc_hide("hist_new"),xows_doc_hidden("hist_end")||xows_gui_mam_query(!0)))}function xows_gui_chat_main_onclick(_){"hist_new"===_.target.id&&(xows_doc_hidden("hist_end")?xows_doc.chat_main.scrollTop=xows_doc.chat_main.scrollHeight:(xows_doc.hist_ul.innerHTML="",xows_doc.hist_beg.innerHTML="",xows_doc_hide("hist_end"),xows_gui_mam_query(!1,XOWS_GUI_HIST_SIZE,0)))}function xows_gui_hist_gen_mesg(_,o,e,s,t,n,c,i){let l=!0;if(_){(t-_.getAttribute("time")>XOWS_MESG_AGGR_THRESHOLD||_.getAttribute("from")!==e)&&(l=!1)}else l=!1;return xows_tpl_mesg_spawn(o,e,s,t,n,c,l?null:i)}function xows_gui_hist_avat_upd(_,o,e){if(!e)return;const s=xows_gui_peer_element(_,"hist_ul"),t="h-"+e;let n,c,i=s.childNodes.length;for(;i--;)(c=s.childNodes[i]).getAttribute("from")===o&&(n=c.querySelector("FIGURE"))&&(n.className=t)}function xows_gui_cli_onmessage(_,o,e,s,t,n,c,i){const l=_!==xows_gui_peer;if(l&&xows_gui_unread_add(_,o),xows_gui_has_focus||n||!_.noti||xows_gui_notify_push(i.name,s,i.avat),!n&&!hist_end.classList.contains("HIDDEN"))return void xows_gui_peer_element(_,"hist_new").classList.remove("HIDDEN");const a=xows_gui_peer_element(_,"hist_ul");if(xows_doc_get_child(a,o))return;const r=xows_gui_peer_scroll_bot(_),x=xows_gui_hist_gen_mesg(a.lastChild,o,e,s,t,n,c,i);a.appendChild(x),a.childNodes.length>XOWS_GUI_HIST_SIZE&&(a.removeChild(a.firstChild),xows_gui_peer_element(_,"hist_beg").innerHTML=""),!n&&r>100?xows_gui_peer_element(_,"hist_new").classList.remove("HIDDEN"):xows_gui_peer_scroll_down(_),l||(xows_doc_loader_monitor(x),xows_doc_loader_check(!0))}function xows_gui_cli_onreceipt(_,o){const e=xows_gui_peer_element(_,o);e?e.classList.add("MESG-RECP"):xows_log(1,"gui_hist_set_receipt","message not found",o)}let xows_gui_mam_query_to=null;function xows_gui_mam_query(_,o=20,e=100){if(!xows_gui_mam_query_to){let s,t;if(_){if(xows_doc_hidden("hist_end"))return;xows_doc.hist_ul.childNodes.length&&(s=parseInt(xows_doc.hist_ul.lastChild.getAttribute("time"))),xows_doc_cls_add("hist_end","LOADING")}else{if(xows_doc.hist_beg.innerHTML.length)return;xows_doc.hist_ul.childNodes.length&&(t=parseInt(xows_doc.hist_ul.firstChild.getAttribute("time"))),xows_doc_cls_add("hist_beg","LOADING")}xows_gui_mam_query_to=setTimeout(xows_cli_mam_query,e,xows_gui_peer,o,s,t,xows_gui_mam_parse)}}function xows_gui_mam_parse(_,o,e){const s=_!==xows_gui_peer,t=xows_gui_peer_element(_,"hist_ul"),n=xows_gui_peer_element(_,"hist_beg"),c=xows_gui_peer_element(_,"hist_end");n.classList.remove("LOADING"),c.classList.remove("LOADING");const i=0===t.childNodes.length;let l;o.length&&!i&&t.firstChild.getAttribute("time")>=o[o.length-1].time&&(l=t.firstChild);let a=t.childNodes.length-XOWS_GUI_HIST_SIZE+o.length;if(a>0)if(l){for(;a--;)t.removeChild(t.lastChild);c.classList.remove("HIDDEN")}else{for(;a--;)t.removeChild(t.firstChild);n.innerHTML=""}const r=xows_gui_peer_scroll_off(_);let x,w,u=0;for(let _=0,e=o.length;_<e;++_)xows_doc_get_child(t,o[_].id)||(x=xows_gui_hist_gen_mesg(w,o[_].id,o[_].from,o[_].body,o[_].time,o[_].sent,!0,o[_].sndr),w=l?t.insertBefore(x,l):t.appendChild(x),s||xows_doc_loader_monitor(x),u++);if(e){let _=!1;o.length&&0===u?o[0].id===t.firstChild.id?_=!0:o[o.length-1].id!==t.lastChild.id&&xows_log(1,"gui_mam_handle","Complete MAM query exception","bound messages ID mismatches"):_=void 0!==l||i,_?n.innerHTML=xows_l10n_get("Start of history"):c.classList.add("HIDDEN")}s||(l&&xows_gui_peer_scroll_seek(_,r),i&&xows_gui_peer_scroll_down(_),xows_doc_loader_check(!0)),xows_gui_mam_query_to=null}const xows_gui_send_edit_keyd=new Array(256);function xows_gui_send_edit_onkeyp(_){if(xows_cli_activity_wakeup(),xows_gui_send_edit_keyd[_.keyCode]="keydown"===_.type,"keydown"===_.type)if(13===_.keyCode){if(xows_gui_send_edit_keyd[16])return;if(_.preventDefault(),xows_gui_peer){const _=xows_doc.send_edit;_.innerText.length&&(xows_cli_send_message(xows_gui_peer,_.innerText),xows_doc_cls_add("send_wrap","SEND-PHLD"),_.innerHTML=""),xows_cli_chatstate_set(xows_gui_peer,XOWS_CHAT_ACTI)}}else xows_gui_peer&&xows_cli_chatstate_set(xows_gui_peer,XOWS_CHAT_COMP)}let xows_gui_send_edit_rng=null;function xows_gui_send_edit_oninput(_){xows_gui_send_edit_rng=xows_doc_sel_rng(0);const o=xows_doc.send_edit;if(o.innerText.length<2&&0===o.innerText.trim().length)return xows_doc_cls_add("send_wrap","SEND-PHLD"),void(o.innerHTML="");xows_doc_cls_rem("send_wrap","SEND-PHLD")}function xows_gui_send_edit_onclick(_){const o=xows_doc_sel_rng(0);if(o.collapsed){const _=o.endContainer;if("EMOJ"===_.parentNode.tagName)return void xows_doc_caret_around(_.parentNode,!o.endOffset)}xows_gui_send_edit_rng=o}function xows_gui_send_edit_insert(_,o){const e=xows_gui_send_edit_rng;let s;e.collapsed||e.deleteContents(),o?(s=document.createElement(o)).appendChild(document.createTextNode(_)):s=document.createTextNode(_),e.insertNode(s),xows_doc_cls_rem("send_wrap","SEND-PHLD"),xows_doc.send_edit.focus(),xows_doc_caret_around(s),xows_gui_send_edit_rng=xows_doc_sel_rng(0)}function xows_gui_menu_emoj_onclick(_){xows_cli_activity_wakeup();const o=_.target.closest("LI");o&&xows_gui_send_edit_insert(o.childNodes[0].nodeValue,"emoj"),xows_doc_menu_toggle(xows_doc.menu_emoj,"drop_emoj")}function xows_gui_upld_onprogress(_){xows_doc.upld_pbar.style.width=_+"%"}function xows_gui_upld_onerror(_){xows_doc_cls_add("upld_text","TEXT-ERR"),xows_doc.upld_text.innerHTML="<b>"+xows_l10n_get("Error")+"</b> : "+_}function xows_gui_upld_onsuccess(_){xows_doc_hide("hist_upld"),setTimeout(xows_cli_send_message,400,xows_gui_peer,_)}function xows_gui_upld_onabort(){xows_gui_upld_onclose()}function xows_gui_upld_onclose(){xows_doc_hide("hist_upld")}function xows_gui_upld_open(_){xows_doc.upld_text.classList="",xows_doc.upld_pbar.style.width="0%",xows_doc.upld_text.innerHTML=_.name,console.log(_.name),xows_cli_upld_query(_,xows_gui_upld_onerror,xows_gui_upld_onsuccess,xows_gui_upld_onprogress,xows_gui_upld_onabort),xows_doc_show("hist_upld"),xows_gui_peer_scroll_down(xows_gui_peer)}function xows_gui_chat_file_onchange(_){const o=xows_doc.chat_file.files[0];xows_gui_peer.bare&&o&&xows_gui_upld_open(o)}function xows_gui_chat_upld_onclick(_){xows_cli_activity_wakeup(),xows_doc.chat_file.value="",xows_doc.chat_file.click()}const xows_gui_writing_lst=[];function xows_gui_writing_clear(){0!==xows_gui_writing_lst.length&&(xows_gui_writing_lst.length=0),xows_doc_hide("chat_stat"),xows_doc.chat_stat.innerHTML=""}function xows_gui_writing_set(_,o){const e=xows_gui_writing_lst,s=e.indexOf(_);o?s<0&&e.push(_):s>=0&&e.splice(s,1);const t=e.length;if(t>0){if(xows_gui_peer)if(xows_doc_show("chat_stat"),xows_gui_peer.type===XOWS_PEER_CONT)xows_doc.chat_stat.innerHTML="<b>"+xows_gui_peer.name+"</b> "+xows_l10n_get("is currently writing");else{let _="";if(t>1){const o=t>2?2:t-1;for(let s=0;s<o;++s)_+="<b>"+xows_jid_to_nick(e[s])+"</b>",s<o-1&&(_+=", ");_+=" "+xows_l10n_get("and")+" <b>";const s=t-o;_+=s>1?s+" "+xows_l10n_get("other(s)")+"</b> ":xows_jid_to_nick(e[t-1])+"</b> ",xows_doc.chat_stat.innerHTML=_+xows_l10n_get("are currently writing")}else xows_doc.chat_stat.innerHTML="<b>"+xows_jid_to_nick(e[0])+"</b> "+xows_l10n_get("is currently writing")}}else xows_gui_writing_clear()}function xows_gui_cli_onchatstate(_,o,e){_===xows_gui_peer&&xows_gui_writing_set(o,e>XOWS_CHAT_PAUS)}function xows_gui_cli_onoccupush(_,o,e){e&&e.includes(110)&&xows_gui_page_join_onjoind(_,null,e.includes(201));const s=xows_gui_peer_element(_,o.jid);if(s)xows_tpl_update_room_occu(s,o.name,o.avat,o.full,o.show,o.stat),xows_gui_hist_avat_upd(_,o.jid,o.avat);else{const e=xows_gui_peer_element(_,o.role===XOWS_ROLE_MODO?"modo_ul":"memb_ul"),s=xows_tpl_spawn_room_occu(o.jid,o.name,o.avat,o.full,o.show,o.stat);o.self&&(s.querySelector(".OCCU-SUBS").classList.add("HIDDEN"),xows_gui_room_privi_update()),o.full&&xows_cli_cont_get(o.full)&&s.querySelector(".OCCU-SUBS").classList.add("HIDDEN"),e.appendChild(s)}}function xows_gui_cli_onoccurem(_,o){if(o){const e=xows_gui_peer_element(_,o);e&&e.parentNode.removeChild(e)}else if(_===xows_gui_peer){xows_gui_switch_peer(null);const _=xows_doc.room_ul.querySelector(".SELECTED");_&&_.classList.remove("SELECTED")}}function xows_gui_occu_list_onclick(_){if(xows_cli_activity_wakeup(),"BUTTON"===_.target.tagName){const o=_.target.closest("li");if(o){const _=xows_jid_to_bare(o.getAttribute("jid"));if(xows_isjid(_)){const o=_.split("@")[0];xows_gui_mbox_subs_edit_open(_,o[0].toUpperCase()+o.slice(1))}}}}function xows_gui_user_stat_onblur(_){xows_cli_activity_wakeup();const o=xows_doc.user_stat.value;o!=xows_cli_self.stat&&xows_cli_change_status(o)}function xows_gui_user_stat_onkeyp(_){13===_.keyCode&&xows_doc.user_stat.blur()}function xows_gui_page_wait_open(_){xows_doc.wait_text.innerHTML=xows_l10n_get(_),xows_doc_page_open("page_wait")}function xows_gui_page_auth_oninput(_){let o=!0;xows_doc.auth_user.value.length&&xows_doc.auth_pass.value.length&&(o=!1),xows_doc.auth_cnct.disabled=o}function xows_gui_page_auth_onclick(_){"auth_cnct"!==_.id?"auth_regi"===_.id&&xows_gui_page_regi_open():xows_doc.auth_cnct.disabled||(xows_gui_page_wait_open("Connecting..."),(xows_gui_auth={}).user=xows_doc.auth_user.value.toLowerCase(),xows_gui_auth.pass=xows_doc.auth_pass.value,xows_gui_auth.cred=xows_doc.auth_cred.checked,xows_doc.auth_pass.value="",xows_gui_connect(!1))}function xows_gui_page_auth_open(){xows_doc.auth_user.value="",xows_doc.auth_pass.value="",xows_doc.auth_cnct.disabled=!0,xows_doc_page_open("page_auth",!1,null,xows_gui_page_auth_oninput,xows_gui_page_auth_onclick),xows_gui_nav_push("auth_open",xows_gui_page_auth_open)}function xows_gui_page_regi_oninput(_){let o=!0;xows_doc.regi_user.value.length&&xows_doc.regi_pass.value.length&&xows_doc_cls_has("regi_capt","CAPTCHA-CHECKED")&&(o=!1),xows_doc.regi_subm.disabled=o}function xows_gui_page_regi_onclick(_){if("regi_capt"===_.id)return xows_doc_cls_add("regi_capt","CAPTCHA-CHECKED"),void xows_gui_page_regi_oninput(_);"regi_subm"!==_.id?"regi_canc"===_.id&&xows_gui_page_auth_open():xows_doc.regi_subm.disabled||(xows_gui_page_wait_open("Please wait..."),(xows_gui_auth={}).user=xows_doc.regi_user.value.toLowerCase(),xows_gui_auth.pass=xows_doc.regi_pass.value,xows_doc.regi_pass.value="",xows_gui_connect(!0))}function xows_gui_page_regi_open(){xows_doc.regi_user.value="",xows_doc.regi_pass.value="",xows_doc.regi_subm.disabled=!0,xows_doc_cls_rem("regi_capt","CAPTCHA-CHECKED"),xows_doc_page_open("page_regi",!1,null,xows_gui_page_regi_oninput,xows_gui_page_regi_onclick),xows_gui_nav_push("regi_open",xows_gui_page_regi_open)}function xows_gui_page_user_onabort(){xows_doc.card_name.value=xows_cli_self.name;const _=xows_cach_avat_get(xows_cli_self.avat);xows_doc.card_avat.style.backgroundImage='url("'+_+'")',xows_doc.card_avat.data=_,xows_doc.card_open.checked=!0}function xows_gui_page_user_onvalid(){xows_cli_change_profile(xows_doc.card_name.value,xows_doc.card_avat.data,xows_doc.card_open.checked)}function xows_gui_page_user_oninput(_){let o;switch(_.id){case"card_open":o=!xows_doc.card_open.checked;break;case"card_name":o=xows_doc.card_name.value!=xows_cli_self.name}o&&xows_doc_mbox_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)}function xows_gui_page_user_onclick(_){if("card_avch"!==_.id){if("card_avrm"===_.id){xows_doc.card_avat.data=null;const _=xows_cli_avat_temp(xows_cli_self.bare);xows_doc.card_avat.style.backgroundImage='url("'+xows_cach_avat_get(_)+'")',xows_doc_mbox_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)}}else xows_doc.card_file.click()}function xows_gui_page_user_ev_file(_){if(xows_doc.card_file.files[0]){const _=new FileReader;_.onload=function(_){const o=new Image;o.onload=function(_){const o=xows_gen_avatar(XOWS_AVAT_SIZE,this);xows_doc.card_avat.data=o,xows_doc.card_avat.style.backgroundImage='url("'+o+'")',xows_doc_mbox_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)},o.src=_.target.result},_.readAsDataURL(xows_doc.card_file.files[0])}}function xows_gui_page_user_onclose(){xows_doc_listener_rem(xows_doc.card_file,"change",xows_gui_page_user_ev_file)}function xows_gui_page_user_open(){xows_gui_page_user_onabort(),xows_doc_page_open("page_user",!0,xows_gui_page_user_onclose,xows_gui_page_user_oninput,xows_gui_page_user_onclick),xows_doc_listener_add(xows_doc.card_file,"change",xows_gui_page_user_ev_file),xows_gui_nav_push("user_open",xows_gui_page_user_open)}function xows_gui_page_cont_onvalid(){let _=xows_doc.cont_bare.value;const o=_.split("@")[0];xows_cli_rost_edit(_,o[0].toUpperCase()+o.slice(1))}function xows_gui_page_cont_oninput(_){xows_doc.cont_bare.value.length&&xows_isjid(xows_doc.cont_bare.value)?xows_doc_mbox_open(3,"Add contact and request authorisation",xows_gui_page_cont_onvalid,"Submit"):xows_doc_mbox_close()}function xows_gui_page_cont_open(){xows_doc.cont_bare.value="",xows_doc_page_open("page_cont",!0,null,xows_gui_page_cont_oninput)}const xows_gui_page_join={};function xows_gui_page_join_onjoind(_,o,e){xows_doc_page_opened("page_join")&&(xows_gui_switch_peer(_.bare),xows_gui_panel_close(),e?(xows_gui_page_join.room=_,xows_doc.join_room.disabled=!0,xows_doc_mbox_open(3,"The Room will be created, do you want to configure it ?",xows_gui_page_join_onvalid,"Configure",xows_gui_page_join_onabort,"Join now")):xows_doc_page_close())}function xows_gui_page_join_onvalid(){const _=xows_gui_page_join.room;if(_)xows_log(2,"gui_page_join_onvalid","request initial Room config",_.bare),xows_cli_room_cfg_get(_,xows_gui_page_room_open);else{xows_cli_room_join(null,xows_doc.join_room.value,xows_cli_self.name)}}function xows_gui_page_join_onabort(){const _=xows_gui_page_join.room;_&&xows_cli_room_cfg_set(_,null,xows_gui_page_join_onjoind)}function xows_gui_page_join_oninput(_){xows_doc.join_room.value.length?xows_doc_mbox_open(3,"Join Room (create it if does not exist)",xows_gui_page_join_onvalid,"Join"):xows_doc_mbox_close()}function xows_gui_page_join_onclose(){xows_gui_page_join.room=null}function xows_gui_page_join_open(){xows_doc.join_room.disabled=!1,xows_doc.join_room.value="",xows_doc_page_open("page_join",!0,xows_gui_page_join_onclose,xows_gui_page_join_oninput),xows_gui_nav_push("join_open",xows_gui_page_join_open)}const xows_doc_page_room={};function xows_gui_page_room_onvalid(){const _=xows_doc_page_room.room,o=xows_doc_page_room.form;for(let _=0,e=o.length;_<e;++_)switch(o[_].var){case"muc#roomconfig_roomname":o[_].value=xows_doc.room_titl.value;break;case"muc#roomconfig_roomdesc":o[_].value=xows_doc.room_desc.value;break;case"muc#roomconfig_persistentroom":o[_].value=xows_doc.room_pers.checked?"1":"0";break;case"muc#roomconfig_publicroom":o[_].value=xows_doc.room_publ.checked?"1":"0";break;case"muc#roomconfig_membersonly":o[_].value=xows_doc.room_mbon.checked?"1":"0";break;case"muc#roomconfig_moderatedroom":o[_].value=xows_doc.room_modo.checked?"1":"0";break;case"muc#roomconfig_whois":o[_].value=xows_doc.room_anon.value;break;case"muc#roomconfig_historylength":o[_].value=xows_doc.room_hmax.value;break;case"muc#roomconfig_defaulthistorymessages":o[_].value=xows_doc.room_hdef.value;break;case"muc#roomconfig_enablearchiving":o[_].value=xows_doc.room_arch.checked?"1":"0"}xows_cli_room_cfg_set(_,o,xows_doc_page_close)}function xows_gui_page_room_onabort(){xows_doc_page_room.room;const _=xows_doc_page_room.form;for(let o=0,e=_.length;o<e;++o)switch(_[o].var){case"muc#roomconfig_roomname":xows_doc.room_titl.value=_[o].value;break;case"muc#roomconfig_roomdesc":xows_doc.room_desc.value=_[o].value;break;case"muc#roomconfig_persistentroom":xows_doc.room_pers.checked=_[o].value;break;case"muc#roomconfig_publicroom":xows_doc.room_publ.checked=_[o].value;break;case"muc#roomconfig_membersonly":xows_doc.room_mbon.checked=_[o].value;break;case"muc#roomconfig_changesubject":case"muc#roomconfig_moderatedroom":xows_doc.room_modo.checked=_[o].value;break;case"muc#roomconfig_whois":xows_doc.room_anon.value=_[o].value;break;case"muc#roomconfig_historylength":xows_doc.room_hmax.value=_[o].value;break;case"muc#roomconfig_defaulthistorymessages":xows_doc.room_hdef.value=_[o].value;break;case"muc#roomconfig_enablearchiving":xows_doc.room_arch.checked=_[o].value}}function xows_gui_page_room_oninput(_){let o=!1;const e=xows_doc_page_room.form;for(let _=0,s=e.length;_<s;++_){switch(e[_].var){case"muc#roomconfig_roomname":e[_].value,xows_doc.room_titl.value,o=!0;break;case"muc#roomconfig_roomdesc":e[_].value,xows_doc.room_desc.value,o=!0;break;case"muc#roomconfig_persistentroom":parseInt(e[_].value),xows_doc.room_pers.checked,o=!0;break;case"muc#roomconfig_publicroom":parseInt(e[_].value),xows_doc.room_publ.checked,o=!0;break;case"muc#roomconfig_membersonly":parseInt(e[_].value),xows_doc.room_mbon.checked,o=!0;break;case"muc#roomconfig_moderatedroom":parseInt(e[_].value),xows_doc.room_modo.checked,o=!0;break;case"muc#roomconfig_whois":e[_].value,xows_doc.room_anon.value,o=!0;break;case"muc#roomconfig_historylength":e[_].value,xows_doc.room_hmax.value,o=!0;break;case"muc#roomconfig_defaulthistorymessages":e[_].value,xows_doc.room_hdef.value,o=!0;break;case"muc#roomconfig_enablearchiving":parseInt(e[_].value),xows_doc.room_arch.checked,o=!0}if(o)break}o&&xows_doc_mbox_open_for_save(xows_gui_page_room_onvalid,xows_gui_page_room_onabort)}function xows_gui_page_room_onclose(){const _=xows_doc_page_room.room;_.init?xows_cli_room_cfg_set(_,null,null):xows_cli_room_cfg_cancel(_),xows_doc_page_room.form=null,xows_doc_page_room.room=null}function xows_gui_page_room_open(_,o){xows_doc_page_room.room=_,xows_doc_page_room.form=o,xows_doc.room_bare.innerHTML=_.bare,xows_gui_page_room_onabort(),xows_doc_page_open("page_room",!0,xows_gui_page_room_onclose,xows_gui_page_room_oninput),xows_gui_nav_push("room_open",xows_gui_page_room_open)}let xows_options={root:"xows",url:"ws://localhost/xmpp-websocket/",domain:"localhost",locale:"en-US",theme:"dark",verbose:1,uncache:!1,allow_register:!1,legacy_vcard:!1,vcard4_notify:!0,avatar_notify:!0,login_delay:2e3};function xows_init_login_user(){xows_log(2,"init_login_user","normal login"),window.PasswordCredential?xows_doc_show("auth_save"):xows_doc_hide("auth_save"),xows_gui_page_auth_open()}function xows_init_login_auto(_){_?(xows_log(2,"init_login_auto","found credential","try auto login"),xows_gui_page_wait_open("Connecting..."),xows_gui_auth={user:_.id,pass:_.password},xows_gui_connect()):(xows_log(2,"init_login_auto","No credential found","Fallback to normal login"),xows_init_login_user())}function xows_init_ondoc(){if(window.PasswordCredential){const _={password:!0,mediation:"optional"};navigator.credentials.get(_).then(xows_init_login_auto,xows_init_login_user)}else xows_init_login_user()}function xows_init_ontpl(){xows_doc_init(xows_init_ondoc)}function xows_init_onl10n(){xows_tpl_init(xows_init_ontpl)}function xows_init(_){_&&("root"in _&&(xows_options.root=_.root),"url"in _&&(xows_options.url=_.url),"domain"in _&&(xows_options.domain=_.domain),"locale"in _&&(xows_options.locale=_.locale),"theme"in _&&(xows_options.theme=_.theme),"verbose"in _&&(xows_options.verbose=_.verbose),"uncache"in _&&(xows_options.uncache=_.uncache),"allow_register"in _&&(xows_options.allow_register=_.allow_register),"legacy_vcard"in _&&(xows_options.legacy_vcard=_.legacy_vcard),"vcard4_notify"in _&&(xows_options.vcard4_notify=_.vcard4_notify),"avatar_notify"in _&&(xows_options.avatar_notify=_.avatar_notify),"fail_delay"in _&&(xows_options.fail_delay=_.fail_delay)),xows_log(2,"init","xows init start"),xows_l10n_select(xows_options.locale,xows_init_onl10n)}