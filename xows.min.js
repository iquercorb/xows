"use strict";const e="Xows",o="0.9.1",_="https://github.com/sedenion/xows",t=-1,s=0,n=new Path2D("M159.201 52.324c-19.942.79-41.713 14.61-59.059 32.342h-.008l50.797 79.645c-47.087 29.58-69.341 71.312-83.529 116.906-47.011 4.47-14.317-87.328-17.531-108.576 0 0-75.508 119.611-32.617 153.242 30.69 24.065 82.644 33.38 82.644 33.38l-66.027 83.763c44.933 15.125 144.87 16.685 144.87 16.685l57.33-89.246h40.103l57.33 89.246s99.938-1.56 144.87-16.685l-66.026-83.762s51.953-9.316 82.644-33.381c42.891-33.631-34.617-153.242-34.617-153.242-3.214 21.248 31.48 113.046-15.531 108.576-14.188-45.594-36.443-87.326-83.53-116.906l50.797-79.645h-.008c-17.345-17.733-39.117-31.552-59.058-32.342-2.85-.112-5.66.041-8.416.487l-76.506 94.812h-24l-76.506-94.812a42.195 42.195 0 0 0-8.416-.487zM189.055 223.9c35.389 0 30.326 54.113 30.326 54.113s-20.312.57-39.397.57c-19.093 0-32.304-.99-32.304-15.23 0-14.234 5.985-39.453 41.375-39.453zm134.136 0c35.39 0 41.375 25.219 41.375 39.453 0 14.24-13.211 15.23-32.304 15.23-19.085 0-39.397-.57-39.397-.57s-5.063-54.113 30.326-54.113z");function xows_hasbits(e,o){return(e&o)===o}function xows_asbool(e){if(e.length){const o=parseInt(e);return NaN!==o?Boolean(o):"TRUE"===e.toUpperCase()}return Boolean(e)}function xows_isfunc(e){return e&&e.constructor&&e.call&&e.apply}function xows_random(e){let o=e+=1831565813;return o=Math.imul(o^o>>>15,1|o),(((o^=o+Math.imul(o^o>>>7,61|o))^o>>>14)>>>0)/4294967296}function xows_log(e,o,_,t,s){if(e<=xt.verbose){let n,r="";e>1&&s&&(r+="%c",n="color:"+s),r+=_,t&&(r+=": "+t);const i=o+": "+r;switch(e){case 0:case 1:console.warn(i);break;default:n?console.log(i,n):console.log(i)}}}const r="0123456789abcdef",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function xows_str_to_utf8(e){let o,_,t="";for(let s=0,n=e.length;s<n;++s)(o=e.charCodeAt(s))<128?t+=e.charAt(s):o<2048?t+=String.fromCharCode(192|o>>6,128|63&o):o<55296||o>=57344?t+=String.fromCharCode(224|o>>12,128|o>>6&63,128|63&o):(++s,o=65536+((1023&o)<<10|1023&(_=e.charCodeAt(s))),t+=String.fromCharCode(240|o>>18,128|o>>12&63,128|o>>6&63,128|63&o));return t}function xows_str_bytes_len(e){let o,_=0;for(let t=0,s=e.length;t<s;++t)(o=e.charCodeAt(t))<128?_++:o<2048?_+=2:o<55296||o>=57344?_+=3:(++t,_+=4);return _}function xows_str_to_bytes(e,o){let _,t;const s=new Uint8Array(o||xows_str_bytes_len(e));for(let o=0,n=0,r=e.length;o<r;++o)(_=e.charCodeAt(o))<128?s[n++]=_:_<2048?(s[n++]=192|_>>6,s[n++]=128|63&_):_<55296||_>=57344?(s[n++]=224|_>>12,s[n++]=128|_>>6&63,s[n++]=128|63&_):(++o,_=65536+((1023&_)<<10|1023&(t=e.charCodeAt(o))),s[n++]=240|_>>18,s[n++]=128|_>>12&63,s[n++]=128|_>>6&63,s[n++]=128|63&_);return s}function xows_bytes_to_str(e){return String.fromCharCode.apply(null,e)}function xows_bytes_to_b64(e){const o=e.length,_=o%3;let t,s,n,r="";for(t=0,s=o-_;t<s;)n=e[t++]<<16|e[t++]<<8|e[t++],r+=i[63&n>>18],r+=i[63&n>>12],r+=i[63&n>>6],r+=i[63&n];return 0!==_&&(n=e[t++]<<16,_>1&&(n|=e[t]<<8),r+=i[63&n>>18],r+=i[63&n>>12],r+=_>1?i[63&n>>6]:"=",r+="="),r}function xows_bytes_to_hex(e){let o,_="";for(let t=0,s=e.length;t<s;++t)o=e[t],_+=r.charAt(o>>>4&15)+r.charAt(15&o);return _}function xows_gen_uuid(){const e=new Uint8Array(16);window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let o="";for(let _=0,t=0;t<16;++t)8!==_&&13!==_&&18!==_&&23!==_||(o+="-",_++),o+=r.charAt(e[t]>>>4&15)+r.charAt(15&e[t]),_+=2;return o}function xows_gen_nonce_hex(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let _="";for(let t=0;t<e;++t)_+=r.charAt(o[t]>>>4&15)+r.charAt(15&o[t]);return _}function xows_gen_nonce_asc(e){const o=new Uint8Array(e);window.crypto.getRandomValues(o);let _="";for(let t=0;t<e;++t)_+=i[o[t]%62];return _}function xows_hash_md5(e){let o;function P1(e,_,t,s,n,r,i){return((o=e+((s^_&(t^s))+n+i))<<r|o>>>32-r)+_}function P2(e,_,t,s,n,r,i){return((o=e+((t^s&(_^t))+n+i))<<r|o>>>32-r)+_}function P3(e,_,t,s,n,r,i){return((o=e+((_^t^s)+n+i))<<r|o>>>32-r)+_}function P4(e,_,t,s,n,r,i){return((o=e+((t^(_|~s))+n+i))<<r|o>>>32-r)+_}let _,t,s,n=0;if("string"==typeof e)s=xows_str_to_bytes(e,64+((t=8*(_=xows_str_bytes_len(e)))+64>>9<<6));else for(t=8*(_=e.length),s=new Uint8Array(64+(t+64>>9<<6));n<_;++n)s[n]=e[n];s[_]|=128;let r=s.length-8;s[r]=255&t,s[r+1]=t>>8&255,s[r+2]=t>>16&255,s[r+3]=t>>24&255;const i=new Uint32Array(16),c=new Uint32Array(4);let a,l,u,x;for(c[0]=1732584193,c[1]=4023233417,c[2]=2562383102,c[3]=271733878,r=0;r<s.length;){for(n=0;n<16;++n)i[n]=s[r++]|s[r++]<<8|s[r++]<<16|s[r++]<<24;a=c[0],l=P4(l=P4(l=P4(l=P4(l=P3(l=P3(l=P3(l=P3(l=P2(l=P2(l=P2(l=P2(l=P1(l=P1(l=P1(l=P1(l=c[1],u=P1(u=c[2],x=P1(x=c[3],a=P1(a,l,u,x,i[0],7,3614090360),l,u,i[1],12,3905402710),a,l,i[2],17,606105819),x,a,i[3],22,3250441966),u=P1(u,x=P1(x,a=P1(a,l,u,x,i[4],7,4118548399),l,u,i[5],12,1200080426),a,l,i[6],17,2821735955),x,a,i[7],22,4249261313),u=P1(u,x=P1(x,a=P1(a,l,u,x,i[8],7,1770035416),l,u,i[9],12,2336552879),a,l,i[10],17,4294925233),x,a,i[11],22,2304563134),u=P1(u,x=P1(x,a=P1(a,l,u,x,i[12],7,1804603682),l,u,i[13],12,4254626195),a,l,i[14],17,2792965006),x,a,i[15],22,1236535329),u=P2(u,x=P2(x,a=P2(a,l,u,x,i[1],5,4129170786),l,u,i[6],9,3225465664),a,l,i[11],14,643717713),x,a,i[0],20,3921069994),u=P2(u,x=P2(x,a=P2(a,l,u,x,i[5],5,3593408605),l,u,i[10],9,38016083),a,l,i[15],14,3634488961),x,a,i[4],20,3889429448),u=P2(u,x=P2(x,a=P2(a,l,u,x,i[9],5,568446438),l,u,i[14],9,3275163606),a,l,i[3],14,4107603335),x,a,i[8],20,1163531501),u=P2(u,x=P2(x,a=P2(a,l,u,x,i[13],5,2850285829),l,u,i[2],9,4243563512),a,l,i[7],14,1735328473),x,a,i[12],20,2368359562),u=P3(u,x=P3(x,a=P3(a,l,u,x,i[5],4,4294588738),l,u,i[8],11,2272392833),a,l,i[11],16,1839030562),x,a,i[14],23,4259657740),u=P3(u,x=P3(x,a=P3(a,l,u,x,i[1],4,2763975236),l,u,i[4],11,1272893353),a,l,i[7],16,4139469664),x,a,i[10],23,3200236656),u=P3(u,x=P3(x,a=P3(a,l,u,x,i[13],4,681279174),l,u,i[0],11,3936430074),a,l,i[3],16,3572445317),x,a,i[6],23,76029189),u=P3(u,x=P3(x,a=P3(a,l,u,x,i[9],4,3654602809),l,u,i[12],11,3873151461),a,l,i[15],16,530742520),x,a,i[2],23,3299628645),u=P4(u,x=P4(x,a=P4(a,l,u,x,i[0],6,4096336452),l,u,i[7],10,1126891415),a,l,i[14],15,2878612391),x,a,i[5],21,4237533241),u=P4(u,x=P4(x,a=P4(a,l,u,x,i[12],6,1700485571),l,u,i[3],10,2399980690),a,l,i[10],15,4293915773),x,a,i[1],21,2240044497),u=P4(u,x=P4(x,a=P4(a,l,u,x,i[8],6,1873313359),l,u,i[15],10,4264355552),a,l,i[6],15,2734768916),x,a,i[13],21,1309151649),u=P4(u,x=P4(x,a=P4(a,l,u,x,i[4],6,4149444226),l,u,i[11],10,3174756917),a,l,i[2],15,718787259),x,a,i[9],21,3951481745),c[0]+=a,c[1]+=l,c[2]+=u,c[3]+=x}const d=new Uint8Array(16);for(n=0,r=0;n<4;++n)d[r++]=255&c[n],d[r++]=c[n]>>8&255,d[r++]=c[n]>>16&255,d[r++]=c[n]>>24&255;return d}function xows_hash_sha1(e){let o,_,t,s=0;if("string"==typeof e)t=xows_str_to_bytes(e,64+((_=8*(o=xows_str_bytes_len(e)))+64>>9<<6));else for(_=8*(o=e.length),t=new Uint8Array(64+(_+64>>9<<6));s<o;++s)t[s]=e[s];t[o]|=128;let n=t.length-4;t[n]=_>>24&255,t[n+1]=_>>16&255,t[n+2]=_>>8&255,t[n+3]=255&_;const r=new Uint32Array(16),i=new Uint32Array(5);let c,a,l,u,x,d,w,p;for(i[0]=1732584193,i[1]=4023233417,i[2]=2562383102,i[3]=271733878,i[4]=3285377520,n=0;n<t.length;){for(s=0;s<16;++s)r[s]=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++];for(c=i[0],a=i[1],l=i[2],u=i[3],x=i[4],s=0;s<80;++s)s>15&&(p=r[s-3&15]^r[s-8&15]^r[s-14&15]^r[15&s],r[15&s]=p<<1|p>>>31),s<20?(d=1518500249,w=u^a&(l^u)):s<40?(d=1859775393,w=a^l^u):s<60?(d=2400959708,w=a&l|a&u|l&u):(d=3395469782,w=a^l^u),p=(c<<5|c>>>27)+w+(x+r[15&s]+d),x=u,u=l,l=a<<30|a>>>2,a=c,c=p;i[0]+=c,i[1]+=a,i[2]+=l,i[3]+=u,i[4]+=x}const m=new Uint8Array(20);for(s=0,n=0;s<5;++s)m[n++]=i[s]>>24&255,m[n++]=i[s]>>16&255,m[n++]=i[s]>>8&255,m[n++]=255&i[s];return m}function xows_hmac_sha1(e,o){"string"==typeof e&&(e=xows_str_to_bytes(e)),e.length>64&&(e=xows_hash_sha1(e));const _=new Uint8Array(64+o.length),t=new Uint8Array(84);let s,n,r;for(n=0,r=e.length;n<r;++n)_[n]=54^e[n],t[n]=92^e[n];for(;n<64;++n)_[n]=54,t[n]=92;for("string"==typeof o&&(o=xows_str_to_bytes(o)),s=0,r=o.length;s<r;++s)_[n++]=o[s];const i=xows_hash_sha1(_);for(s=0,n=64;s<20;++s)t[n++]=i[s];return xows_hash_sha1(t)}function xows_hash_sha256(e){const o=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);let _,t,s,n=0;if("string"==typeof e)s=xows_str_to_bytes(e,64+((t=8*(_=xows_str_bytes_len(e)))+64>>9<<6));else for(t=8*(_=e.length),s=new Uint8Array(64+(t+64>>9<<6));n<_;++n)s[n]=e[n];s[_]|=128;let r=s.length-4;s[r]=t>>24&255,s[r+1]=t>>16&255,s[r+2]=t>>8&255,s[r+3]=255&t;const i=new Uint32Array(64),c=new Uint32Array(8);let a,l,u,x,d,w,p,m,g,h;for(c[0]=1779033703,c[1]=3144134277,c[2]=1013904242,c[3]=2773480762,c[4]=1359893119,c[5]=2600822924,c[6]=528734635,c[7]=1541459225,r=0;r<s.length;){for(n=0;n<16;++n)i[n]=s[r++]<<24|s[r++]<<16|s[r++]<<8|s[r++];for(a=c[0],l=c[1],u=c[2],x=c[3],d=c[4],w=c[5],p=c[6],m=c[7],n=0;n<64;n++)n>15&&(g=((h=i[n-2])>>>17|h<<15)^(h>>>19|h<<13)^h>>>10,i[n]=g+i[n-7],g=((h=i[n-15])>>>7|h<<25)^(h>>>18|h<<14)^h>>>3,i[n]+=g+i[n-16]),x+=h=m+(g=(d>>>6|d<<26)^(d>>>11|d<<21)^(d>>>25|d<<7))+(p^d&(w^p))+o[n]+i[n],h+=(g=(a>>>2|a<<30)^(a>>>13|a<<19)^(a>>>22|a<<10))+(a&l|u&(a|l)),m=p,p=w,w=d,d=x,x=u,u=l,l=a,a=h;c[0]+=a,c[1]+=l,c[2]+=u,c[3]+=x,c[4]+=d,c[5]+=w,c[6]+=p,c[7]+=m}const f=new Uint8Array(32);for(n=0,r=0;n<8;++n)f[r++]=c[n]>>24&255,f[r++]=c[n]>>16&255,f[r++]=c[n]>>8&255,f[r++]=255&c[n];return f}const c=/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;function xows_isjid(e){return c.test(e)}function xows_jid_to_bare(e){const o=e.indexOf("/");return-1!==o?e.substring(0,o):e}function xows_jid_to_user(e){const o=e.indexOf("@");return-1!==o?e.substring(0,o):e}function xows_jid_to_nick(e){const o=e.indexOf("/");return-1!==o?e.substring(o+1):null}function xows_url_to_data(e){return 0===e.indexOf("data:")?e.substring(e.indexOf(",")+1):null}function xows_url_to_bytes(e){return 0===e.indexOf("data:")?atob(e.substring(e.indexOf(",")+1)):null}function xows_url_to_type(e){return 0===e.indexOf("data:")?e.substring(5,e.indexOf(";")):null}const a={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&apos;",'"':"&quot;","\n":"<br>"};function xows_html_escap_fnc(e){return a[e]}function xows_html_escape(e){return e.replace(/[\&<>'"\n]/g,xows_html_escap_fnc)}function xows_clean_dom(e){let o,_=e.childNodes.length;for(;_--;)8===(o=e.childNodes[_]).nodeType||3===o.nodeType&&!/\S/.test(o.nodeValue)?e.removeChild(o):1===o.nodeType&&xows_clean_dom(o);return e}function xows_gen_avatar(e,o,_,t){const s=document.createElement("canvas"),r=s.getContext("2d");if(o){let _;const t=o.naturalWidth,n=o.naturalHeight;if(t>e||n>e){let i,c,a;t>n?(c=.5*(t-(i=n)),a=0):(c=0,a=.5*(n-(i=t))),s.width=t,s.height=n,r.drawImage(o,0,0);const l=r.getImageData(c,a,i,i),u=new Int32Array(l.data.buffer);_=new ImageData(e,e);const x=new Int32Array(_.data.buffer),d=1/(e/i),w=Math.round(d),p=1/(w*w);let m,g,h,f,b,F,v,y,k,A;for(m=0;m<e;++m)for(g=0;g<e;++g){for(b=Math.round(g*d)*i+Math.round(m*d),F=0,v=0,y=0,k=0,f=0;f<w;++f)for(h=0;h<w;++h)k+=(A=u[b+(f*i+h)])>>24&255,y+=A>>16&255,v+=A>>8&255,F+=255&A;F=Math.round(F*p),v=Math.round(v*p),y=Math.round(y*p),k=Math.round(k*p),x[g*e+m]=k<<24|y<<16|v<<8|F}s.width=s.height=e,r.putImageData(_,0,0)}else s.width=s.height=e,r.drawImage(o,0,0,e,e)}else if(s.width=s.height=e,_){let o=0,t=_.length;for(;t--;)o+=_.charCodeAt(t);const s=2*xows_random(o)*180;r.fillStyle="hsl("+s+",85%,45%)",r.rect(0,0,e,e),r.fill(),r.fillStyle="#FFF";const i=e/32;r.scale(i,i),r.fill(n)}return s.toDataURL("image/png")}let l={},u="en",x=function(){};function xows_l10n_select(e,o){xows_isfunc(o)&&(x=o);let _=xt.root+"/locale/LC_list.json";xt.uncache&&(_+="?"+xows_gen_nonce_asc(4));const t=new XMLHttpRequest;t.open("GET",_,!0),t.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_select","parsing locale list",this.responseURL);let o=JSON.parse(this.responseText);if(!o)return void xows_log(0,"l10n_select",'locale list "'+this.responseURL+'" parse error');if(o[e])return xows_log(2,"l10n_select","found available locale",e),void xows_l10n_db_load(o[e]);if(-1!==e.indexOf("-")){let _=e.split("-")[0].toLowerCase();if(o[_])return xows_log(2,"l10n_select","found available language",_),void xows_l10n_db_load(o[_])}xows_log(1,"l10n_select",'invalid or unavailable locale "'+e+'"',"using default"),x()}else xows_log(0,"l10n_select",'locale list "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"')},xows_log(2,"l10n_select","loading locale list",_),t.send()}function xows_l10n_db_load(e,o){xows_isfunc(o)&&(x=o);let _=xt.root+"/locale/"+e+"/LC_db.json";xt.uncache&&(_+="?"+xows_gen_nonce_asc(4));const t=new XMLHttpRequest;t.open("GET",_,!0),t.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){xows_log(2,"l10n_db_load","parsing JSON data",this.responseURL);let o=JSON.parse(this.responseText);if(!o)return void xows_log(0,"l10n_db_load",'data "'+this.responseURL+'" parse error');l=o,u=e,x()}else xows_log(0,"l10n_db_load",'file "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"'),x()},xows_log(2,"l10n_db_load","loading locale db",_),t.send()}function xows_l10n_get(e){const o=l[e];return o&&0!==o.length?o:e}function xows_l10n_parseFunc(e,o){const _=l[o];return _&&0!==_.length?_:o}function xows_l10n_parse(e){return e.replace(/\${['"](.*)['"]}/g,xows_l10n_parseFunc)}function xows_l10n_hasLocale(e){return null!==l[e]&&void 0!==l[e]}function xows_l10n_date(e){const o=new Date(e),_=new Date,t=new Date(e);return _.setHours(0,0,0,0),t.setHours(0,0,0,0),_===t?xows_l10n_get("at")+" "+o.toLocaleTimeString(u):o.toLocaleDateString(u,{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}function xows_l10n_houre(e){return new Date(e).toLocaleTimeString(u,{hour:"2-digit",minute:"2-digit"})}const d=new DOMParser,w=document.implementation.createDocument("jabber:client","Xows"),p={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&apos;",'"':"&quot;"},m={"&amp;":"&","&lt;":"<","&gt;":">","&apos;":"'","&quot;":'"'};function xows_xml_escap_fnc(e){return p[e]}function xows_xml_escape(e){return e.replace(/[\&<>'"]/g,xows_xml_escap_fnc)}function xows_xml_unesc_fnc(e){return m[e]}function xows_xml_unesc(e){return e.replace(/\&\w*;/g,xows_xml_unesc_fnc)}function xows_xml_parent(e,o){if("string"==typeof o||"number"==typeof o)e.appendChild(w.createTextNode(o));else if("object"==typeof o){const _=o.length;if(void 0!==_)for(let t=0;t<_;++t)xows_xml_parent(e,o[t]);else e.appendChild(o)}}function xows_xml_node(e,o,_){const t=w.createElement(e);if("object"==typeof o)for(const e in o)o.hasOwnProperty(e)&&o[e]&&t.setAttribute(e,o[e]);return _&&xows_xml_parent(t,_),t}function xows_xml_edit(e,o,_){if(node=e.querySelector(o),node){for(;node.firstChild;)node.removeChild(node.lastChild);xows_xml_parent(node,_)}else node=xows_xml_node(o,null,_);return node}function xows_xml_serialize(e){let o,_,t="<"+e.nodeName;for(_=e.attributes.length,o=0;o<_;++o)t+=" "+e.attributes[o].nodeName+'="'+e.attributes[o].nodeValue+'"';if(0!==(_=e.childNodes.length)){for(t+=">",o=0;o<_;++o)1===e.childNodes[o].nodeType?t+=xows_xml_serialize(e.childNodes[o]):t+=xows_xml_escape(e.childNodes[o].nodeValue);t+="</"+e.nodeName+">"}else t+="/>";return t}function xows_xml_parse(e){return xows_clean_dom(d.parseFromString(e,"text/xml"))}function xows_xml_get_text(e){if(!e)return"";const o=e.childNodes.length;if(0===o&&3===e.nodeType)return xows_xml_unesc(e.nodeValue);let _="";for(let t=0;t<o;++t)3===e.childNodes[t].nodeType&&(_+=e.childNodes[t].nodeValue);return xows_xml_unesc(_)}let g=null,h="",f=function(){return""},b=function(e){return""},F=function(e){return!0},v=function(){},y=function(){};function xows_sasl_get_selected(){return h}function xows_sasl_plain_req(){let e=g.authz+"\0";return e+=g.authc+"\0",e+=g.passw,g={},e}function xows_sasl_plain_resp(e){return""}function xows_sasl_plain_chk(e){return!0}function xows_sasl_sha1_req(){g.cnonce=xows_gen_nonce_asc(24);let e="n="+g.authc;return e+=",r="+g.cnonce,g.client_first_message_bare=e,"n,,"+e}function xows_sasl_sha1_resp(e){let o,_,t,s,n,r,i,c=e.split(",");for(o=0,t=c.length;o<t;++o)"r"===(i=c[o].match(/([a-z]+)=(.+)/))[1]&&(s=i[2]),"s"===i[1]&&(n=i[2]),"i"===i[1]&&(r=i[2]);if(s.substr(0,24)!==g.cnonce)return g={},xows_log(0,"sasl_sha1_resp","SCRAM-SHA-1 challenge error","missing cnonce in server nonce"),xows_isfunc(v)&&v(),"";let a,l,u="c=biws,r="+s,x=g.client_first_message_bare;for(x+=","+e+","+u,a=l=xows_hmac_sha1(g.passw,atob(n)+"\0\0\0"),o=1;o<r;++o)for(l=xows_hmac_sha1(g.passw,l),_=0;_<20;++_)a[_]^=l[_];let d=xows_hmac_sha1(a,"Client Key");const w=xows_hmac_sha1(a,"Server Key"),p=xows_hmac_sha1(xows_hash_sha1(d),x);for(_=0;_<20;_++)d[_]^=p[_];g={};const m=xows_hmac_sha1(w,x);return g.sproof=xows_bytes_to_b64(m),u+=",p="+xows_bytes_to_b64(d)}function xows_sasl_sha1_chk(e){const o=e.match(/(v)=(.+)/),_=g.sproof;return g={},_===o[2]||(xows_log(0,"sasl_sha1_chk","SCRAM-SHA-1 integrity check failed","supplied server signature mismatches the computed one"),!1)}function xows_sasl_md5_req(){return""}function xows_sasl_md5_resp(e){let o,_,t,s,n,r,i=e.split(",");for(let e=0,c=i.length;e<c;++e)"realm"===(r=i[e].match(/([a-z]+)="?([^"]+)/))[1]&&(o=r[2]),"nonce"===r[1]&&(_=r[2]),"qop"===r[1]&&(t=r[2]),"host"===r[1]&&(s=r[2]),"rspauth"===r[1]&&(n=r[2]);if(void 0!==n)return"";const c=g.authc,a=g.authz,l=g.passw;g={};let u="xmpp/"+a.split("@")[1];void 0!==s&&(u+="/"+s);const x=xows_gen_nonce_asc(24),d="00000001";let w="charset=utf-8,";return w+='username="'+c+'",',w+='realm="'+o+'",',w+='nonce="'+_+'",',w+='cnonce="'+x+'",',w+="nc="+d+",",w+='digest-uri="'+u+'",',w+='response="'+xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_hex(xows_hash_md5(xows_bytes_to_str(xows_hash_md5(c+":"+o+":"+l))+":"+_+":"+x+":"+a))+":"+_+":"+d+"1:"+x+":"+t+":"+xows_bytes_to_hex(xows_hash_md5("AUTHENTICATE:"+u))))+'",',w+="qop=auth"}function xows_sasl_md5_chk(e){return!0}const k=[{name:"SCRAM-SHA-1",req:xows_sasl_sha1_req,res:xows_sasl_sha1_resp,chk:xows_sasl_sha1_chk},{name:"DIGEST-MD5",req:xows_sasl_md5_req,res:xows_sasl_md5_resp,chk:xows_sasl_md5_chk},{name:"PLAIN",req:xows_sasl_plain_req,res:xows_sasl_plain_resp,chk:xows_sasl_plain_chk}];function xows_sasl_init(e,o,_,t,s,n){let r=-1;for(let o=0,_=k.length;o<_;++o)if(e.includes(k[o].name)){h=k[o].name,r=o;break}return-1!==r&&(v=n,y=s,f=k[r].req,b=k[r].res,F=k[r].chk,(g={}).authz=xows_str_to_utf8(o),g.authc=xows_str_to_utf8(_),g.passw=xows_str_to_utf8(t),!0)}let A=null,q=null,C=function(){},E=function(){},D=function(){};function xows_sck_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"open":C=o;break;case"recv":E=o;break;case"close":D=o}}function xows_sck_error(e){xows_log(0,"sck_error","Socket connection error")}function xows_sck_closed(e){if(1e3!==e.code){let o;switch(e.code){case 1001:o="Going Away";break;case 1002:o="Protocol error";break;case 1003:o="Unsupported Data";break;case 1004:o="Reserved";break;case 1005:o="No Status Rcvd";break;case 1006:o="Abnormal Closure";break;case 1007:o="Invalid frame payload data";break;case 1008:o="Policy Violation";break;case 1009:o="Message Too Big";break;case 1010:o="Mandatory Ext.";break;case 1011:o="Internal Error";break;case 1012:o="Service Restart";break;case 1013:o="Try Again Later";break;case 1014:o="Bad Gateway";break;case 1015:o="TLS handshake";break;default:o="Unhandled error ("+e.code+")"}xows_log(0,"sck_closed",o),D(t,"Socket connection error")}else xows_log(2,"sck_closed","socket closed"),D(3);A=null}function xows_sck_opened(e){xows_log(2,"sck_opened","socket connected"),C()}function xows_sck_recv(e){xows_log(3,"sck_recv",e.data,null,"#AB5655"),E(e.data)}function xows_sck_create(e,o){xows_log(3,"sck_create","socket connecting",e),(A=new WebSocket(q=e,o)).onerror=xows_sck_error,A.onopen=xows_sck_opened,A.onclose=xows_sck_closed,A.onmessage=xows_sck_recv}function xows_sck_destroy(){null!==A&&(xows_log(3,"sck_destroy","closing WebSocket"),A.close(),A=null)}function xows_sck_send(e){xows_log(3,"sck_send",e,null,"#55ABAB"),A.send(e)}const S="jabber:client",T="jabber:iq:version",N="jabber:iq:roster",j="jabber:iq:register",B="jabber:iq:private",L="jabber:x:data",P="urn:xmpp:ping",I="urn:xmpp:time",O="urn:xmpp:delay",R="urn:xmpp:carbons",H="urn:xmpp:receipts",U="urn:xmpp:mam",M="urn:xmpp:vcard4",G="urn:xmpp:avatar:data",z="urn:xmpp:avatar:metadata",J="urn:xmpp:chat-markers",X="urn:xmpp:http:upload",V="urn:xmpp:bookmarks:1",W="urn:ietf:params:xml:ns:xmpp-framing",K="urn:ietf:params:xml:ns:xmpp-sasl",Y="urn:ietf:params:xml:ns:xmpp-bind",$="urn:ietf:params:xml:ns:xmpp-session",Q="urn:ietf:params:xml:ns:vcard-4.0",Z="vcard-temp",ee="vcard-temp:x:update",oe="http://jabber.org/protocol/nick",_e="http://jabber.org/protocol/caps",te="http://jabber.org/protocol/disco#info",se="http://jabber.org/protocol/disco#items",ne="http://jabber.org/protocol/muc",re="http://jabber.org/protocol/muc#user",ie="http://jabber.org/protocol/muc#owner",ce="http://jabber.org/protocol/chatstates",ae="http://jabber.org/protocol/rsm",le="http://jabber.org/protocol/pubsub",ue="http://jabber.org/protocol/pubsub#event",xe="http://jabber.org/protocol/pubsub#publish-options",de=-1,we=0,pe=1,me=2,ge=3,he=4,fe={dnd:0,xa:1,away:2,chat:4},be=["dnd","xa","away","","chat"],Fe=-1,ve=0,ye=1,ke=2,Ae=3,qe={remove:-1,none:0,from:1,to:2,both:3},Ce=0,Ee=1,De=2,Se=3,Te=4,Ne={gone:0,active:1,inactive:2,paused:3,composing:4},je=0,Be=1,Le=2,Pe=3,Ie={none:0,visitor:1,participant:2,moderator:3},Oe=-1,Re=0,He=1,Ue=2,Me=3,Ge={outcast:-1,none:0,member:1,admin:2,owner:3},ze=["gone","active","inactive","paused","composing"],Je={"urn:xmpp:carbons":null,"urn:xmpp:mam":null,"urn:xmpp:http:upload":null},Xe=[];let Ve=[];const We=[];let Ke=null,Ye=null,$e=null,Qe=null,Ze=null,eo=null,oo=null,_o=!1;function xows_xmp_use_xep(e){const o=e.match(/([a-z\:]+)(:\d|$)/);if(o[1]){let _=!1;if(o[1]in Je)if(o[2].length){if(null!==Je[o[1]]){let e=!1;if(Je[o[1]].length){parseInt(Je[o[1]].charAt(1))>=parseInt(o[2].charAt(1))&&(e=!0)}}}else null!==Je[o[1]]&&(_=!0);return _?(xows_log(2,"xmp_use_xep","ignoring extension",e),!1):(Je[o[1]]=o[2].length?o[2]:"",xows_log(2,"xmp_use_xep","use extension",e),!0)}return xows_log(1,"xmp_use_xep","unsuported extension",o[1]),!1}function xows_xmp_get_xep(e){return e in Je&&Je[e]?e+Je[e]:(xows_log(1,"xmp_get_xep","unknown extension",e),null)}function xows_xmp_get_caps(){let o=M,_=z;return xt.vcard4_notify&&(o+="+notify"),xt.avatar_notify&&(_+="+notify"),[xows_xml_node("identity",{category:"client",name:e,type:"web"}),xows_xml_node("feature",{var:_e}),xows_xml_node("feature",{var:te}),xows_xml_node("feature",{var:se}),xows_xml_node("feature",{var:P}),xows_xml_node("feature",{var:I}),xows_xml_node("feature",{var:T}),xows_xml_node("feature",{var:ce}),xows_xml_node("feature",{var:H}),xows_xml_node("feature",{var:Z}),xows_xml_node("feature",{var:Q}),xows_xml_node("feature",{var:o}),xows_xml_node("feature",{var:G}),xows_xml_node("feature",{var:_}),xows_xml_node("feature",{var:V+"+notify"})]}function xows_xmp_get_caps_ver(){const e=xows_xmp_get_caps();let o,_=e.length,t="";for(o=0;o<_;++o)"identity"===e[o].tagName&&(t+=e[o].getAttribute("category")+"/",t+=e[o].getAttribute("type")+"/",t+=(e[o].hasAttribute("xml:lang")?e[o].getAttribute("xml:lang"):"")+"/",t+=e[o].getAttribute("name")+"<");for(o=0;o<_;++o)"feature"===e[o].tagName&&(t+=e[o].getAttribute("var")+"<");return xows_bytes_to_b64(xows_hash_sha1(t))}function xows_xmp_xdata_parse(e){const o=[],_=e.getElementsByTagName("field");for(let e=0,t=_.length;e<t;++e)o.push({required:null!==_[e].querySelector("required"),type:_[e].getAttribute("type"),label:_[e].getAttribute("label"),var:_[e].getAttribute("var"),value:xows_xml_get_text(_[e].querySelector("value"))});return o}function xows_xmp_xdata_make(e){const o=xows_xml_node("x",{xmlns:L,type:"submit"});if(e&&e.length){let _;for(let t=0,s=e.length;t<s;++t)_=xows_xml_node("field"),e[t].var&&_.setAttribute("var",e[t].var),e[t].type&&_.setAttribute("type",e[t].type),e[t].value&&xows_xml_parent(_,xows_xml_node("value",null,e[t].value)),xows_xml_parent(o,_)}return o}let to=function(){},so=function(){},no=function(){},ro=function(){},io=function(){},co=function(){},ao=function(){},lo=function(){},uo=function(){},xo=function(){},wo=function(){},po=function(){};function xows_xmp_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"session":to=o;break;case"presence":so=o;break;case"subscrib":no=o;break;case"occupant":ro=o;break;case"roster":io=o;break;case"message":co=o;break;case"chatstate":ao=o;break;case"receipt":lo=o;break;case"subject":uo=o;break;case"pubsub":xo=o;break;case"error":wo=o;break;case"close":po=o}}function xows_xmp_send(e,o,_){if(!A)return void xows_log(1,"xows_xmp_send","socket is closed");"presence"!==e.tagName&&"message"!==e.tagName&&"iq"!==e.tagName||e.getAttribute("xmlns")||e.setAttribute("xmlns",S);let t=e.getAttribute("id");t||(t=xows_gen_uuid(),e.setAttribute("id",t)),xows_isfunc(o)&&Ve.push({id:t,onresult:o,onparse:_}),xows_sck_send(xows_xml_serialize(e))}function xows_xmp_error_str(e){let o;const _=e.querySelector("error");if(_){o=(o=(o=_.firstChild.tagName).replace(/-/g," "))[0].toUpperCase()+o.substring(1);const e=_.querySelector("text");e&&(o+=": "+xows_xml_get_text(e))}return o}function xows_xmp_iq_parse(e,o){let _,s,n,r;const i=e.getAttribute("id"),c=e.getAttribute("type");if("error"===c){const o=e.querySelector("error");_=o.getAttribute("type"),s=o.getAttribute("code"),n=o.firstChild.tagName,r=xows_xml_get_text(e.querySelector("text"));const c=xows_xmp_error_str(e);xows_log(1,"xmp_iq_parse","query '"+i+"' error",c),wo(t,c)}xows_isfunc(o)&&o(e.getAttribute("from"),c,_,s,n,r)}function xows_xmp_session_parse(e){if("error"===e.getAttribute("type")){const o="Session establishment failure";return xows_log(0,"xmp_session_parse",o,xows_xmp_error_str(e)),void xows_xmp_send_close(t,o)}xows_log(2,"xmp_session_parse","session established"),to(Qe)}function xows_xmp_session_query(){xows_log(2,"xmp_session_query","query for session"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("session",{xmlns:$})),xows_xmp_session_parse)}function xows_xmp_bind_parse(e){if("error"===e.getAttribute("type")){const o="Resource Bind failure";return xows_log(0,"xmp_bind_parse",o,xows_xmp_error_str(e)),void xows_xmp_send_close(t,o)}const o=e.querySelector("jid");Qe=xows_xml_get_text(o),eo=xows_jid_to_nick(Qe),xows_log(2,"xmp_bind_parse","Resource Bind accepted",Qe),Xe.includes($)?xows_xmp_session_query():to(Qe)}function xows_xmp_bind_query(){const e="xows_"+xows_gen_nonce_asc(8);xows_log(2,"xmp_bind_query","query for Resource Bind",e),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("bind",{xmlns:Y},xows_xml_node("resource",null,e))),xows_xmp_bind_parse)}function xows_xmp_carbons_query(e,o){const _=e?"enable":"disable";xows_log(2,"xmp_carbons_query","query XEP-0280 Carbons",_);const t=xows_xmp_get_xep(R);t?xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node(_,{xmlns:t})),xows_xmp_iq_parse,o):xows_log(1,"xmp_carbons_query","XEP-0280 Carbons unavailable")}function xows_xmp_discoinfo_parse(e,o){if("error"===e.getAttribute("type"))return void xows_log(1,"xmp_discoinfo_parse","parse Disco#info",xows_xmp_error_str(e));const _=e.querySelector("query");let t,s,n;const r=[];for(t=0,s=(n=_.getElementsByTagName("identity")).length;t<s;++t)r.push({category:n[t].getAttribute("category"),type:n[t].getAttribute("type"),name:n[t].getAttribute("name")});const i=[];for(t=0,s=(n=_.getElementsByTagName("feature")).length;t<s;++t)n[t].hasAttribute("var")&&i.push(n[t].getAttribute("var"));const c=_.querySelector("x"),a=c?xows_xmp_xdata_parse(c):null;xows_isfunc(o)&&o(e.getAttribute("from"),r,i,a,_.getAttribute("node"))}function xows_xmp_discoinfo_query(e,o,_){xows_log(2,"xmp_discoinfo_query","query disco#info",e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("query",{xmlns:te,node:o})),xows_xmp_discoinfo_parse,_)}function xows_xmp_discoitems_parse(e,o){if("error"===e.getAttribute("type"))return void xows_log(1,"xmp_discoitems_parse","parse Disco#items",xows_xmp_error_str(e));const _=e.getElementsByTagName("item"),t=[];for(let e=0,o=_.length;e<o;++e)t.push({jid:_[e].getAttribute("jid"),name:_[e].getAttribute("name")});xows_isfunc(o)&&o(e.getAttribute("from"),t)}function xows_xmp_discoitems_query(e,o){xows_log(2,"xmp_discoitems_query","query disco#items",e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("query",{xmlns:se})),xows_xmp_discoitems_parse,o)}function xows_xmp_roster_get_parse(e,o){if("error"===e.getAttribute("type"))return void xows_log(1,"xmp_roster_get_parse","parse get Roster",xows_xmp_error_str(e));const _=e.getElementsByTagName("item"),t=[];for(let e=0,o=_.length;e<o;++e)t.push({bare:_[e].getAttribute("jid"),name:_[e].getAttribute("name"),subs:qe[_[e].getAttribute("subscription")],group:xows_xml_get_text(_[e].querySelector("group"))});xows_isfunc(o)&&o(t)}function xows_xmp_roster_get_query(e){xows_xmp_send(xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:N})),xows_xmp_roster_get_parse,e)}function xows_xmp_roster_set_query(e,o,_,t){xows_log(2,"xmp_roster_set_query","query set Roster",e);const s=xows_xml_node("item",{jid:e});o?(s.setAttribute("name",o),_&&xows_xml_parent(s,xows_xml_node("group",null,_))):s.setAttribute("subscription","remove"),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("query",{xmlns:N},s)),xows_xmp_iq_parse,t)}function xows_xmp_muc_cfg_get_parse(e,o){"error"!==e.getAttribute("type")?xows_isfunc(o)&&o(e.getAttribute("from"),xows_xmp_xdata_parse(e.querySelector("x"))):xows_log(1,"xmp_muc_cfg_get_parse","parse get MUC config",xows_xmp_error_str(e))}function xows_xmp_muc_cfg_get_guery(e,o){xows_log(2,"xmp_muc_cfg_get_guery","query get MUC config",e),xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("query",{xmlns:ie})),xows_xmp_muc_cfg_get_parse,o)}function xows_xmp_muc_cfg_set_cancel(e,o){xows_log(2,"xmp_muc_cfg_set_cancel","cancel set MUC config",e),xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:ie},xows_xml_node("x",{xmlns:L,type:"cancel"}))),xows_xmp_iq_parse,o)}function xows_xmp_muc_cfg_set_query(e,o,_){xows_log(2,"xmp_muc_cfg_set_query","query set MUC config",e);const t=xows_xmp_xdata_make(o);xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:ie},t)),xows_xmp_iq_parse,_)}function xows_xmp_muc_role_query(e,o,_,t,s){xows_log(2,"xmp_muc_role_set_query","query set MUC role",e);const n=t?xows_xml_node("reason",null,t):null;xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:ie},xows_xml_node("item",{nick:o,role:_},n))),xows_xmp_iq_parse,s)}function xows_xmp_muc_affi_query(e,o,_,t,s){xows_log(2,"xmp_muc_role_set_query","query set MUC role",e);const n=t?xows_xml_node("reason",null,t):null;xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:ie},xows_xml_node("item",{affiliation:_,jid:nick},n))),xows_xmp_iq_parse,s)}function xows_xmp_muc_destroy_query(e,o,_,t,s){xows_log(2,"xmp_muc_destroy_query","query destroy MUC room",e);const n=xows_xml_node("destroy",null,null);o&&n.setAttribute("jid",o),_&&xows_xml_parent(n,xows_xml_node("password",null,_)),t&&xows_xml_parent(n,xows_xml_node("reason",null,t)),xows_xmp_send(xows_xml_node("iq",{to:e,type:"set"},xows_xml_node("query",{xmlns:ie},n)),xows_xmp_iq_parse,s)}function xows_xmp_pubsub_publish(e,o,_,t){xows_log(2,"xmp_pubsub_publish","publish PEP node",e);const s=[o];_&&s.push(xows_xml_node("publish-options",{node:e},xows_xmp_xdata_make([{var:"FORM_TYPE",type:"hidden",value:xe},{var:"pubsub#access_model",value:_}]))),xows_xmp_send(xows_xml_node("iq",{type:"set"},xows_xml_node("pubsub",{xmlns:le},s)),xows_xmp_iq_parse,t)}function xows_xmp_bookmark_publish(e,o,_,t,s){const n=xows_xml_node("conference",{xmlns:V,name:o,autojoin:_});t&&xows_xml_parent(n,xows_xml_node("nick",null,t));const r=xows_xml_node("publish",{node:V},xows_xml_node("item",{id:e},n));xows_xmp_pubsub_publish(V,r,"whitelist",s)}function xows_xmp_vcard4_publish(e,o,_){const t=xows_xml_node("publish",{node:M},xows_xml_node("item",null,xows_xml_node("vcard",{xmlns:Q},e)));xows_xmp_pubsub_publish(M,t,o,_)}function xows_xmp_vcard4_get_parse(e,o){let _=null;"error"===e.getAttribute("type")?xows_log(1,"xmp_vcard4_get_parse","parse get vCard-4",xows_xmp_error_str(e)):_=e.querySelector("vcard"),xows_isfunc(o)&&o(e.getAttribute("from"),_)}function xows_xmp_vcard4_get_query(e,o){xows_log(2,"xmp_vcard4_get_query","query get vCard-4",e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("vcard",{xmlns:Q})),xows_xmp_vcard4_get_parse,o)}function xows_xmp_vcardt_set_query(e,o){xows_xmp_send(xows_xml_node("iq",{type:"set",to:Ze},xows_xml_node("vCard",{xmlns:Z},e)),xows_xmp_iq_parse,o)}function xows_xmp_vcardt_get_parse(e,o){"error"!==e.getAttribute("type")?xows_isfunc(o)&&o(e.getAttribute("from"),e.querySelector("vCard")):xows_log(1,"xmp_vcardt_get_parse","parse get vcard-Temp",xows_xmp_error_str(e))}function xows_xmp_vcardt_get_query(e,o){xows_log(2,"xmp_vcardt_get_query_","query get vcard-Temp",e);const _=xows_xml_node("iq",{type:"get"},xows_xml_node("vCard",{xmlns:Z}));null!==e&&_.setAttribute("to",e),xows_xmp_send(_,xows_xmp_vcardt_get_parse,o)}function xows_xmp_avat_data_publish(e,o,_,t){xows_log(2,"xmp_avat_data_publish","publish Avatar-Data",e);const s=xows_xml_node("publish",{node:G},xows_xml_node("item",{id:e},xows_xml_node("data",{xmlns:G},o)));xows_xmp_pubsub_publish(G,s,_,t)}function xows_xmp_avat_meta_publish(e,o,_,t,s,n,r){xows_log(2,"xmp_avat_meta_publish","publish Avatar-Metadata",e);const i=xows_xml_node("info",{id:e,type:o,bytes:_,width:t,height:s}),c=xows_xml_node("publish",{node:z},xows_xml_node("item",{id:e},xows_xml_node("metadata",{xmlns:z},i)));xows_xmp_pubsub_publish(z,c,n,r)}function xows_xmp_avat_data_get_parse(e,o){let _,t=null;"error"===e.getAttribute("type")&&xows_log(1,"xmp_avat_data_get_parse","parse get Avatar-Data",xows_xmp_error_str(e));const s=e.querySelector("item");s&&(_=s.getAttribute("id"),t=xows_xml_get_text(s.querySelector("data"))),xows_isfunc(o)&&o(e.getAttribute("from"),_,t)}function xows_xmp_avat_data_get_query(e,o,_){xows_log(2,"xmp_avat_data_get_query","query get Avatar-Data",e+" hash:"+o),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:le},xows_xml_node("items",{node:G},xows_xml_node("item",{id:o})))),xows_xmp_avat_data_get_parse,_)}function xows_xmp_avat_meta_get_parse(e,o){"error"!==e.getAttribute("type")?xows_isfunc(o)&&o(e.getAttribute("from"),e.querySelector("metadata")):xows_log(1,"xmp_avat_meta_get_parse","parse get Avatar-Metadata",xows_xmp_error_str(e))}function xows_xmp_avat_meta_get_query(e,o){xows_log(2,"xmp_avat_meta_get_query","query get Avatar-Metadata",e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:le},xows_xml_node("items",{node:z}))),xows_xmp_avat_meta_get_parse,o)}function xows_xmp_nick_publish(e,o){xows_log(2,"xmp_nick_publish","publish Nickname",e);const _=xows_xml_node("publish",{node:oe},xows_xml_node("item",null,xows_xml_node("nick",{xmlns:oe},e)));xows_xmp_pubsub_publish(oe,_,null,o)}function xows_xmp_nick_get_parse(e,o){"error"!==e.getAttribute("type")?xows_isfunc(o)&&o(e.getAttribute("from"),e.querySelector("nick")):xows_log(1,"xmp_nick_get_parse","parse get Nickname",xows_xmp_error_str(e))}function xows_xmp_nick_get_query(e,o){xows_log(2,"xmp_avat_data_get_query","query get Nickname",e),xows_xmp_send(xows_xml_node("iq",{type:"get",to:e},xows_xml_node("pubsub",{xmlns:le},xows_xml_node("items",{node:oe},xows_xml_node("item",null)))),xows_xmp_nick_get_parse,o)}function xows_xmp_register_get_parse(e,o){if("error"===e.getAttribute("type"))return void xows_log(1,"xmp_register_get_parse","parse get Register",xows_xmp_error_str(e));const _=e.querySelector("username"),t=e.querySelector("password"),s=e.querySelector("email"),n=e.querySelector("x"),r=!!e.querySelector("registered"),i=_?xows_xml_get_text(_):null,c=t?xows_xml_get_text(t):null,a=s?xows_xml_get_text(s):null,l=n?xows_xmp_xdata_parse(n):null;xows_isfunc(o)&&o(e.getAttribute("from"),r,i,c,a,l)}function xows_xmp_register_get_query(e,o){xows_log(2,"xmp_register_get_query","query get Register");const _=xows_xml_node("iq",{type:"get"},xows_xml_node("query",{xmlns:j}));null!==e&&_.setAttribute("to",e),xows_xmp_send(_,xows_xmp_register_get_parse,o)}function xows_xmp_register_set_query(e,o,_,t,s,n){xows_log(2,"xmp_register_submit","submit Register");const r=xows_xml_node("query",{xmlns:j});null!==o&&xows_xml_parent(r,xows_xml_node("username",null,o)),null!==_&&xows_xml_parent(r,xows_xml_node("password",null,_)),null!==t&&xows_xml_parent(r,xows_xml_node("email",null,t)),null!==s&&xows_xml_parent(r,xows_xmp_xdata_make(s));const i=xows_xml_node("iq",{type:"set"},r);null!==e&&i.setAttribute("to",e),xows_xmp_send(i,xows_xmp_iq_parse,n)}const mo={};function xows_xmp_mam_parse(e,o){if("error"===e.getAttribute("type"))return void xows_log(1,"xmp_mam_parse","Archive query failure",xows_xmp_error_str(e));const _=e.getAttribute("id"),t=mo[_].to,s=mo[_].with,n=e.querySelector("fin");if(n){let e,_,r,i,c,a,l=0;if(i="true"===n.getAttribute("complete"),(e=n.querySelector("count"))&&(l=parseInt(xows_xml_get_text(e))),!(e=n.querySelector("first")))return xows_log(2,"xmp_mam_parse","No result received"),void(xows_isfunc(o)&&o(t,s,[],l,i));_=xows_xml_get_text(e),(e=n.querySelector("last"))&&(r=xows_xml_get_text(e));const u=We.length;for(c=0;c<u&&We[c].page!==_;c++);if(c>=u)xows_log(0,"xmp_mam_parse","first result page not found in stack",_),a=[];else{let e=c,o=0;do{if(c===u){xows_log(1,"xmp_mam_parse","last result page not found (reached end of stack)",r);break}o++}while(We[c++].page!==r);a=We.splice(e,o)}xows_log(2,"xmp_mam_parse","results collected","("+a.length+"/"+l+") '"+_+"'=>'"+r+"'"),xows_isfunc(o)&&o(t,s,a,l,i)}delete mo[_]}function xows_xmp_mam_query(e,o,_,t,s,n,r){const i=xows_xmp_get_xep(U);if(!i)return void xows_log(1,"xmp_mam_query","Message Archive Management (XEP-0313) is unavailable");const c=[];c.push({var:"FORM_TYPE",type:"hidden",value:i}),_&&c.push({var:"with",value:_}),t&&c.push({var:"start",value:new Date(t).toJSON()}),s&&c.push({var:"end",value:new Date(s).toJSON()});const a=xows_xml_node("set",{xmlns:ae},xows_xml_node("max",null,o));!n&&t||xows_xml_parent(a,xows_xml_node("before",null,n));const l=xows_gen_uuid(),u=xows_xml_node("iq",{id:l,type:"set"},xows_xml_node("query",{xmlns:i},[xows_xmp_xdata_make(c),a]));null!==e&&u.setAttribute("to",e),mo[l]={to:e,with:_},xows_log(2,"xmp_mam_query","send Archive query","with "+_+" start "+t+" end "+s),xows_xmp_send(u,xows_xmp_mam_parse,r)}function xows_xmp_upload_parse(e,o){if("error"===e.getAttribute("type")){const _=xows_xmp_error_str(e);return xows_log(1,"xmp_upload_parse","HTTP-Upload query error",_),void(xows_isfunc(o)&&o(null,null,null,_))}const _=e.querySelector("slot");if(_){let e,t,s;const n=_.querySelector("put");n&&(e=n.getAttribute("url"),s=n.getElementsByTagName("header"));const r=_.querySelector("get");r&&(t=r.getAttribute("url")),xows_log(2,"xmp_upload_parse","accepted HTTP-Upload slot",e),xows_isfunc(o)&&o(e,s,t)}}function xows_xmp_upload_query(e,o,_,t,s){const n=xows_xmp_get_xep(X);if(!n)return void xows_log(1,"xmp_upload_query","HTTP File Upload (XEP-0363) is unvailable");xows_log(2,"xmp_upload_query","send HTTP-Upload query",_+" bytes required");let r={xmlns:n,filename:o,size:_};t&&(r.type=t),xows_xmp_send(xows_xml_node("iq",{to:e,type:"get"},xows_xml_node("request",r)),xows_xmp_upload_parse,s)}let go=null;function xows_xmp_auth_sasl_request(e){if(!xows_sasl_init(e,Ze,Ye,oo)){oo=null;let e="Unable to find a suitable authentication mechanism";return xows_log(0,"xmp_auth_sasl_request",e),xows_xmp_send_close(t,e),!0}oo=null;const o=xows_sasl_get_selected();xows_log(2,"xmp_auth_sasl_request","select authentication mechanism",o);const _=f();0!==_.length&&(xows_log(2,"xmp_auth_sasl_request","sending authentication request",_),xows_xmp_send(xows_xml_node("auth",{xmlns:K,mechanism:o},btoa(_))))}function xows_xmp_auth_register_get_parse(e,o,_,t,s,n){if(void 0!==n){let e=n.length;for(;e--;)"username"===n[e].var&&(n[e].value=Ye),"password"===n[e].var&&(n[e].value=oo)}else null!==_&&(_=Ye),null!==t&&(t=oo);xows_xmp_register_set_query(null,_,t,null,n,xows_xmp_auth_register_set_parse)}function xows_xmp_auth_register_set_parse(e,o,_,s,n,r){let i=null;"error"===o?("409"!==s&&"conflict"!==n||(i="Unsername already exists"),"406"!==s&&"not-acceptable"!==n||(i="Username contains illegal characters")):"result"===o?(xows_log(2,"xmp_auth_register_set_parse","success"),_o=!1,xows_xmp_auth_sasl_request(go)):i="Unexpected registration error",null!==i&&(oo=null,xows_log(0,"xmp_auth_register_set_parse",i),setTimeout(xows_xmp_send_close,xt.login_delay,t,i))}function xows_xmp_resp_ping(e){const o=e.getAttribute("from"),_=e.getAttribute("id");xows_log(2,"xmp_resp_ping","responds to Ping",o),xows_xmp_send(xows_xml_node("iq",{id:_,to:o,type:"result"}))}function xows_xmp_resp_time(e){const o=e.getAttribute("from"),_=e.getAttribute("id"),t=new Date;let s=t.getTimezoneOffset()/60,n=s<0?"-":"";n+=((s=Math.abs(s))>9?s:"0"+s)+":00";const r=t.toJSON();xows_log(2,"xmp_resp_time","responds to Time",o),xows_xmp_send(xows_xml_node("iq",{to:o,id:_,type:"result"},xows_xml_node("time",{xmlns:I},[xows_xml_node("tzo",null,n),xows_xml_node("utc",null,r)])))}function xows_xmp_resp_version(_){const t=_.getAttribute("from"),s=_.getAttribute("id");xows_log(2,"xmp_resp_version","responds to Version",t),xows_xmp_send(xows_xml_node("iq",{to:t,id:s,type:"result"},xows_xml_node("query",{xmlns:T},[xows_xml_node("name",null,e),xows_xml_node("version",null,o)])))}function xows_xmp_resp_discoinfo(e){const o=e.getAttribute("from"),_=e.getAttribute("id"),t=e.querySelector("query"),s=t?t.getAttribute("node"):null;xows_log(2,"xmp_resp_discoinfo","responds to disco#info",o);const n=xows_xmp_get_caps();xows_xmp_send(xows_xml_node("iq",{to:o,id:_,type:"result"},xows_xml_node("query",{xmlns:te,node:s},n)))}function xows_xmp_recv_open(e){let o=e.getAttribute("xmlns")===W;if(!("1.0"===e.getAttribute("version"))||!o){const e="Invalid server framing";xows_log(0,"xmp_recv_open",e),xows_xmp_send_close(t,e)}return!0}function xows_xmp_recv_close(e){return xows_log(2,"xmp_recv_close","stream closed"),Ze?(xows_xmp_send_close(t,"Server closed the stream"),Ze=null):(xows_sck_destroy(),po(3)),!0}function xows_xmp_recv_streamerror(e){return xows_log(0,"xmp_recv_streamerror",e.firstChild.tagName,xows_xml_get_text(e.querySelector("text"))),xows_xmp_send_close(t,"Server thrown a stream error"),!0}function xows_xmp_recv_streamfeatures(e){const o=e.getElementsByTagName("mechanism");if(o.length){const _=[];for(let e=0,t=o.length;e<t;++e)_.push(xows_xml_get_text(o[e]));if(xows_log(2,"xmp_recv_streamfeatures","received authentication mechanisms",_.join(", ")),_o){if(e.querySelector("register"))go=_,xows_xmp_register_get_query(null,xows_xmp_auth_register_get_parse);else{oo=null;let e="Account registration is not allowed by server";xows_log(0,"xmp_recv_streamfeatures",e),xows_xmp_send_close(t,e)}}else xows_xmp_auth_sasl_request(_);return!0}{let o=e.childNodes.length;for(;o--;)Xe.push(e.childNodes[o].getAttribute("xmlns"));xows_log(2,"xmp_recv_streamfeatures","received features",Xe.join(", ")),Xe.includes(Y)?xows_xmp_bind_query():to(Ze)}return!1}function xows_xmp_recv_challenge(e){const o=atob(xows_xml_get_text(e));xows_log(2,"xmp_recv_challenge","received authentication challenge",o);const _=b(o);return xows_log(2,"xmp_recv_challenge","sending challenge response",_),xows_xmp_send(xows_xml_node("response",{xmlns:K},btoa(_))),!0}function xows_xmp_recv_failure(e){let o;const _=e.firstChild.tagName;switch(_.toLowerCase()){case"not-authorized":o="Wrong username or password";break;default:o="Authentication failure"}return xows_log(0,"xmp_recv_failure",_),setTimeout(xows_xmp_send_close,xt.login_delay,t,o),!0}function xows_xmp_recv_success(e){const o=xows_xml_get_text(e);if(0!==o.length&&xows_log(2,"xmp_recv_success","received server proof signature",o),!F(atob(o))){const e="Server integrity check failed";return xows_log(0,"xmp_recv_success",e),xows_xmp_send_close(t,e),!0}return xows_log(2,"xmp_recv_success","authentication success"),xows_xmp_send_open(),!0}function xows_xmp_recv_roster_push(e){xows_xmp_send(xows_xml_node("iq",{id:e.getAttribute("id"),type:"result"},xows_xml_node("query",{xmlns:N})));const o=e.querySelector("item"),_=o.getAttribute("jid"),t=o.getAttribute("name"),s=qe[o.getAttribute("subscription")];let n=o.querySelector("group");n=n?xows_xml_get_text(n):null,xows_log(2,"xmp_recv_roster_push","received Roster Push"),io(_,t,s,n)}function xows_xmp_recv_presence(e){const o=e.getAttribute("from");let _,s,n,r,i,c;if(e.hasAttribute("type")){const s=e.getAttribute("type");if("unavailable"===s&&(_=-1),s.includes("subscrib")){xows_log(2,"xmp_recv_presence","received subscrib",o+" type:"+s);const _=e.querySelector("nick"),t=_?xows_xml_get_text(_):null;return no(o,s,t),!0}if("error"===s){const _=xows_xmp_error_str(e);return xows_log(1,"xmp_recv_presence","error",o+" - "+_),wo(t,_),!0}}let a,l=e.childNodes.length;for(;l--;)if(1===(a=e.childNodes[l]).nodeType)if("show"!==a.tagName)if("priority"!==a.tagName)if("status"!==a.tagName)if("c"!==a.tagName){if("x"===a.tagName){const e=a.getAttribute("xmlns");if(e===re){const e=a.querySelector("item");i={affi:Ge[e.getAttribute("affiliation")],role:Ie[e.getAttribute("role")],full:e.getAttribute("jid"),nick:e.getAttribute("nickname"),code:[]};const o=a.querySelectorAll("status");let _=o.length;for(;_--;)i.code.push(parseInt(o[_].getAttribute("code")))}e===ee&&(c=xows_xml_get_text(a.firstChild))}}else a.getAttribute("xmlns")===_e&&(r={node:a.getAttribute("node"),ver:a.getAttribute("ver")});else n=xows_xml_get_text(a);else s=xows_xml_get_text(a);else{const e=xows_xml_get_text(a);_=e?fe[e]:3}return void 0!==i?(xows_log(2,"xmp_recv_presence","received MUC presence",o),ro(o,_,n,i,c),!0):(xows_log(2,"xmp_recv_presence","received presence",o+" show:"+_),so(o,_,s,n,r,c),!0)}function xows_xmp_recv_mam_result(e){const o=e.getAttribute("id"),_=e.querySelector("forwarded");if(!_)return!1;let t,s,n,r,i,c;const a=_.querySelector("delay");a&&(r=new Date(a.getAttribute("stamp")).getTime());const l=_.querySelector("message");if(l){t=l.getAttribute("id"),s=l.getAttribute("from"),n=l.getAttribute("to");let e,_,a,u,x=l.childNodes.length;for(;x--;)1===(e=l.childNodes[x]).nodeType&&(_=e.getAttribute("xmlns"),a=e.tagName,_!==ce?"body"===e.tagName&&(i=e.hasChildNodes()?xows_xml_get_text(e):""):c=a);return void 0!==i?(r||(r=new Date(0).getTime()),We.push({page:o,id:t,from:s,to:n,time:r,body:i}),u="Adding archived message to result stack"):u="Skipped archived message without body",xows_log(2,"xmp_recv_mam_result",u,"from "+s+" to "+n),!0}return!1}function xows_xmp_recv_pubsub(e,o){const _=o.querySelector("items");if(!_)return!1;const t=_.getAttribute("node"),s=[];for(let e=0,o=_.childNodes.length;e<o;++e)s.push({id:_.childNodes[e].getAttribute("id"),data:_.childNodes[e].firstChild});return xo(e,t,s),!0}function xows_xmp_recv_message(e){const o=e.getAttribute("type"),_=e.getAttribute("id"),t=e.getAttribute("from"),s=e.getAttribute("to");let n,r,i,c,a,l,u,x,d=e.childNodes.length;for(;d--;)if(1===(x=e.childNodes[d]).nodeType){if((l=x.getAttribute("xmlns"))===xows_xmp_get_xep(U))return xows_log(2,"xmp_recv_message","received Archive result"),xows_xmp_recv_mam_result(x);if(l===ue)return xows_log(2,"xmp_recv_message","received PubSub Event"),xows_xmp_recv_pubsub(t,x);if(l===xows_xmp_get_xep(R)){xows_log(2,"xmp_recv_message","received forwarded Carbons");const e=x.querySelector("message");return!!e&&xows_xmp_recv_message(e)}if(u=x.tagName,l===H)if("request"===u)xows_log(2,"xmp_recv_message","received Receipt request"),xows_xmp_send_receipt(t,_);else if("received"===u){a=x.getAttribute("id");continue}l!==ce?l!==O?"body"!==u?"subject"===u&&(r=xows_xml_get_text(x)):n=xows_xml_get_text(x):i=new Date(x.getAttribute("stamp")).getTime():c=Ne[u]}let w=!1;return void 0!==c&&(ao(_,o,t,s,c,i),w=!0),void 0!==n&&(co(_,o,t,s,n,i),w=!0),void 0!==a&&(lo(_,t,s,a,i),w=!0),void 0!==r&&(uo(_,t,r),w=!0),xows_log(2,"xmp_recv_message",w?"Handling message":"unhandled message","from "+t+" to "+s),w}function xows_xmp_recv_iq(e){if("get"===e.getAttribute("type")){const o=e.firstChild;if(void 0!==o){const _=o.getAttribute("xmlns");if(_===P)return xows_xmp_resp_ping(e);if(_===I)return xows_xmp_resp_time(e);if(_===T)return xows_xmp_resp_version(e);if(_===te)return xows_xmp_resp_discoinfo(e)}return!1}if("set"===e.getAttribute("type")){const o=e.firstChild;if(void 0!==o){if(o.getAttribute("xmlns")===N)return xows_xmp_recv_roster_push(e)}return!1}const o=e.getAttribute("id");let _=Ve.length;for(;_--;)if(Ve[_].id===o){if(xows_isfunc(Ve[_].onresult))return Ve[_].onresult(e,Ve[_].onparse);xows_log(1,"xmp_recv_iq","invalid onresult callback for query",o),Ve.splice(_,1)}return!1}function xows_xmp_send_presence(e,o,t,s,n,r,i){const c=xows_xml_node("presence");e&&c.setAttribute("to",e),o&&c.setAttribute("type",o),t>=0&&(xows_xml_parent(c,xows_xml_node("show",null,be[t])),xows_xml_parent(c,xows_xml_node("priority",null,20*t)),s&&xows_xml_parent(c,xows_xml_node("status",null,s)),xows_cli_feat_srv_has(Z)&&xows_xml_parent(c,xows_xml_node("x",{xmlns:ee},n?xows_xml_node("photo",null,n):null)),xows_xml_parent(c,xows_xml_node("c",{xmlns:_e,hash:"sha-1",node:_,ver:xows_xmp_get_caps_ver()}))),r&&xows_xml_parent(c,xows_xml_node("x",{xmlns:ne})),i&&xows_xml_parent(c,xows_xml_node("nick",{xmlns:oe},i)),xows_log(2,"xmp_send_presence",o||"availability",(e||"")+"show: "+be[t]),xows_xmp_send(c)}function xows_xmp_send_receipt(e,o){xows_log(2,"xmp_send_receipt","send message Receipt","received "+o+" to "+e),xows_xmp_send(xows_xml_node("message",{to:e},xows_xml_node("received",{id:o,xmlns:H})))}function xows_xmp_send_chatstate(e,o,_){const t=ze[_];xows_log(2,"xmp_send_chatstate","send chat state",t+" to "+e),xows_xmp_send(xows_xml_node("message",{to:e,type:o},xows_xml_node(t,{xmlns:ce})))}function xows_xmp_send_message(e,o,_,t){const s=xows_gen_uuid(),n=xows_xml_node("message",{id:s,to:o,type:e},xows_xml_node("body",null,xows_xml_escape(_)));return t&&xows_xml_parent(n,xows_xml_node("request",{xmlns:H})),xows_log(2,"xmp_send_message","send message","type "+e+" to "+o),xows_xmp_send(n),s}function xows_xmp_send_subject(e,o){const _=xows_gen_uuid();return xows_log(2,"xmp_send_subject","send subject to",e),xows_xmp_send(xows_xml_node("message",{id:_,to:e,type:"groupchat"},xows_xml_node("subject",null,xows_xml_escape(o)))),_}function xows_xmp_send_close(e,o){xows_log(2,"xmp_send_close","saying goodbye"),xows_xmp_send(xows_xml_node("close",{xmlns:W,id:"_ciao"})),Ze=null,o&&po(e,o)}function xows_xmp_send_open(){xows_log(2,"xmp_send_open","send stream open request",W),xows_xmp_send(xows_xml_node("open",{to:$e,version:"1.0",xmlns:W}))}function xows_xmp_sck_onopen(){xows_xmp_send_open()}function xows_xmp_sck_onclose(e,o){Ze&&(Ze=null,po(e,o))}function xows_xmp_sck_onrecv(e){const o=xows_xml_parse(e).firstChild,_=o.tagName;return"iq"===_?xows_xmp_recv_iq(o):"message"===_?xows_xmp_recv_message(o):"presence"===_?xows_xmp_recv_presence(o):"open"===_?xows_xmp_recv_open(o):"close"===_?xows_xmp_recv_close(o):"stream:error"===_?xows_xmp_recv_streamerror(o):"stream:features"===_?xows_xmp_recv_streamfeatures(o):"challenge"===_?xows_xmp_recv_challenge(o):"success"===_?xows_xmp_recv_success(o):"failure"===_?xows_xmp_recv_failure(o):void xows_log(1,"xmp_recv","unprocessed stanza",event.data)}function xows_xmp_connect(e,o,_,s){xows_sck_destroy(),eo=null,Qe=null;const n=o.split("@");if($e=null,void 0!==n[1]&&0!==n[1].length&&($e=n[1]),null===$e){let e="Incomplete JID (undefined domain)";return xows_log(0,"xmp_connect",e),void po(t,e)}Ze=o,Ye=n[0],oo=_,xows_sck_set_callback("open",xows_xmp_sck_onopen),xows_sck_set_callback("recv",xows_xmp_sck_onrecv),xows_sck_set_callback("close",xows_xmp_sck_onclose),_o=s,Ke=e,xows_sck_create(e,"xmpp")}const ho={};function xows_cach_avat_save(e,o,_){const t=o||xows_bytes_to_hex(xows_hash_sha1(xows_url_to_bytes(e)));return ho[t]=e,_||localStorage.setItem(t,e),t}function xows_cach_avat_has(e){return e in ho||e in localStorage}function xows_cach_avat_get(e){return e in ho?ho[e]:e in localStorage?(ho[e]=localStorage.getItem(e),ho[e]):null}const fo={};function xows_cach_peer_save(e,o,_,t){let s=null;if(o&&_&&t)s={name:o,avat:_,desc:t};else{try{s=JSON.parse(localStorage.getItem(e))}catch(e){xows_log(1,"cli_cache_peer_add","JSON parse error",e)}null!==s?(o&&(s.name=o),_&&(s.avat=_),t&&(s.desc=t)):s={name:o,avat:_,desc:t}}fo[e]=s,localStorage.setItem(e,JSON.stringify(s))}function xows_cach_peer_has(e){return e in fo||e in localStorage}function xows_cach_peer_get(e){if(e in fo)return fo[e];if(e in localStorage){try{fo[e]=JSON.parse(localStorage.getItem(e))}catch(o){return xows_log(1,"cli_cache_peer_get","JSON parse error",o),localStorage.removeItem(e),null}return fo[e]}return null}const bo={};function xows_cach_caps_save(e,o){bo[e]=o,localStorage.setItem(e,JSON.stringify(o))}function xows_cach_caps_has(e){return e in bo||e in localStorage}function xows_cach_caps_get(e){if(e in xows_cli_cache_caps_db)return xows_cli_cache_caps_db[e];if(e in localStorage){try{bo[e]=JSON.parse(localStorage.getItem(e))}catch(o){return xows_log(1,"cli_cache_caps_get","JSON parse error",o),localStorage.removeItem(e),null}return bo[e]}return null}const Fo=0,vo=1,yo=2,ko=3,Ao=48,qo=[],Co=[];function xows_cli_feat_own_has(e){return qo.includes(e)}function xows_cli_feat_srv_has(e){return Co.includes(e)}const Eo={};function xows_cli_svc_exist(e){return e in Eo}let Do=function(){},So=function(){},To=function(){},No=function(){},jo=function(){},Bo=function(){},Lo=function(){},Po=function(){},Io=function(){},Oo=function(){},Ro=function(){},Ho=function(){},Uo=function(){},Mo=function(){},Go=function(){},zo=function(){},Jo={jid:null,bare:null,name:null,avat:null,show:-1,stat:null,vcrd:null};function xows_cli_isself(e){return e.includes(Jo.bare)}Object.defineProperty(Jo,"type",{value:vo,writable:!1}),Object.seal(Jo);const Xo=[];function xows_cli_cont_new(e,o,_,t){const s={bare:e,lock:e,name:o||e,subs:_,ress:{},avat:t,show:-1,stat:"",noti:!0};return Object.defineProperty(s,"type",{value:vo,writable:!1}),Object.seal(s),Xo.push(s),s}function xows_cli_cont_get(e){const o=xows_jid_to_bare(e);let _=Xo.length;for(;_--;)if(Xo[_].bare===o)return Xo[_];return null}const Vo=[];function xows_cli_room_new(e,o,_,t,s){const n={bare:e,name:o,desc:_,subj:"",publ:s,prot:t,join:null,role:0,affi:0,occu:[],noti:!0,init:!1,book:!1};return Object.defineProperty(n,"type",{value:yo,writable:!1}),Object.seal(n),Vo.push(n),n}function xows_cli_room_get(e){const o=xows_jid_to_bare(e);let _=Vo.length;for(;_--;)if(Vo[_].bare===o)return Vo[_];return null}function xows_cli_occu_new(e,o,_,t,s,n,r,i){const c={jid:o,name:xows_jid_to_nick(o),affi:_,role:t,full:s,bare:s?xows_jid_to_bare(s):null,avat:n,show:r,stat:i,self:!!s&&xows_cli_isself(s)};return Object.defineProperty(c,"type",{value:ko,writable:!1}),Object.seal(c),e.occu.push(c),c}function xows_cli_occu_get(e,o){let _=e.occu.length;for(;_--;)if(e.occu[_].jid===o)return e.occu[_];return null}function xows_cli_occu_any(e,o){let _=e.occu.length;for(;_--;)if(e.occu[_].jid===o)return e.occu[_];const t=xows_cach_peer_get(o);return xows_cli_occu_new(e,o,null,null,null,t?t.avat:xows_cli_avat_temp(o),0,"")}function xows_cli_peer_get(e){const o=xows_jid_to_bare(e);let _=Vo.length;for(;_--;)if(Vo[_].bare===o)return Vo[_];for(_=Xo.length;_--;)if(Xo[_].bare===o)return Xo[_];return null}function xows_cli_peer_update(e,o,_,t){if(!e||xows_cli_isself(e))xows_log(2,"cli_peer_update","received own profile data"),xows_cach_peer_save(Jo.bare,o,_,t),o&&(Jo.name=o),_&&(Jo.avat=_),t&&(Jo.stat=t),So(Jo),(_||t)&&xows_cli_presence_update();else{const s=xows_cli_peer_get(e);if(!s)return void xows_log(1,"cli_peer_update","unknown/unsubscribed peer",e);if(xows_log(2,"cli_peer_update","received profile data for",e),(_||s.type===vo)&&xows_cach_peer_save(e,o,_,t),s.type===vo)o&&(s.name=o),_&&(s.avat=_),t&&(s.stat=t),To(s);else{const t=xows_cli_occu_get(s,e);t&&(o&&(t.name=o),_&&(t.avat=_),Io(s,t))}}}function xows_cli_set_callback(e,o){if(xows_isfunc(o))switch(e.toLowerCase()){case"connect":Do=o;break;case"selfchange":So=o;break;case"contpush":To=o;break;case"contrem":No=o;break;case"subspush":jo=o;break;case"subsrem":Bo=o;break;case"roompush":Lo=o;break;case"roomrem":Po=o;break;case"occupush":Io=o;break;case"occurem":Oo=o;break;case"message":Ro=o;break;case"chatstate":Ho=o;break;case"receipt":Uo=o;break;case"subject":Mo=o;break;case"error":Go=o;break;case"close":zo=o}}let Wo=!0;function xows_cli_connect(e,o,_,t){Xo.length=0,Vo.length=0,qo.length=0,Co.length=0;for(const e in Eo)delete Eo[e];return Jo.jid=null,Jo.bare=null,Jo.name=null,Jo.avat=null,Jo.stat=null,Jo.vcrd=null,xows_cli_activity_stop(),xows_xmp_set_callback("session",xows_cli_xmp_onsession),xows_xmp_set_callback("presence",xows_cli_xmp_onpresence),xows_xmp_set_callback("subscrib",xows_cli_xmp_onsubscribe),xows_xmp_set_callback("occupant",xows_cli_xmp_onoccupant),xows_xmp_set_callback("roster",xows_cli_xmp_onroster),xows_xmp_set_callback("message",xows_cli_xmp_onmessage),xows_xmp_set_callback("chatstate",xows_cli_xmp_onchatstate),xows_xmp_set_callback("receipt",xows_cli_xmp_onreceipt),xows_xmp_set_callback("subject",xows_cli_xmp_onsubject),xows_xmp_set_callback("pubsub",xows_cli_xmp_onpubsub),xows_xmp_set_callback("error",xows_cli_xmp_onerror),xows_xmp_set_callback("close",xows_cli_xmp_onclose),Wo=!0,xows_xmp_connect(e,o,_,t)}function xows_cli_xmp_onsession(e){Jo.jid=e,Jo.bare=xows_jid_to_bare(e);const o=xows_cach_peer_get(Jo.bare);if(null!==o&&(o.name&&(Jo.name=o.name),o.avat&&(Jo.avat=o.avat),o.desc&&(Jo.stat=o.desc)),null===Jo.name){const e=Ze.split("@")[0];Jo.name=e[0].toUpperCase()+e.slice(1)}Jo.avat||(Jo.avat=xows_cli_avat_temp(Jo.bare)),xows_xmp_discoinfo_query(Jo.bare,null,xows_cli_own_info_parse)}function xows_cli_xmp_onclose(e,o){Jo.jid&&(Xo.length=0,Vo.length=0,Jo.jid=null,Jo.bare=null,Jo.name=null,Jo.avat=null,Jo.stat=null,Jo.vcrd=null,xows_cli_activity_stop()),zo(e,o)}function xows_cli_xmp_onerror(e,o){Go(e,o)}function xows_cli_own_info_parse(e,o,_){for(let e=0,o=_.length;e<o;++e)qo.push(_[e]),_[e].includes(U)&&xows_xmp_use_xep(_[e]);xows_xmp_discoinfo_query($e,null,xows_cli_srv_info_parse)}function xows_cli_srv_info_parse(e,o,_){for(let e=0,o=_.length;e<o;++e)Co.push(_[e]),_[e].includes(R)&&xows_xmp_use_xep(_[e])&&xows_xmp_carbons_query(!0),_[e].includes(X)&&xows_xmp_use_xep(_[e]),_[e].includes(ne)&&xows_xmp_use_xep(_[e]);xows_xmp_discoitems_query($e,xows_cli_srv_items_parse)}const Ko=[];function xows_cli_srv_items_parse(e,o){if(!o.length)return void xows_cli_rost_get_query();Ko.length=0;let _=o.length;for(;_--;)Ko.push(o[_].jid);xows_xmp_discoinfo_query(Ko.pop(),null,xows_cli_srv_item_info_parse)}function xows_cli_srv_item_info_parse(e,o,_){const t=o[0].category,s=o[0].type;let n;if(xows_log(2,"cli_srv_item_info_parse","discover service features",e+": "+t+", "+s+', "'+o[0].name+'"'),"store"===t&&"file"===s)for(n=_.length;n--;)_[n].includes(X)&&(xows_xmp_use_xep(_[n]),Eo[X]=e,xows_log(2,"cli_srv_item_info_parse","use service for Http-Upload",e));if("conference"===t&&"text"===s)for(n=_.length;n--;)_[n]===ne&&(Eo[ne]=e,xows_log(2,"cli_srv_item_info_parse","use service for Multi-User Chat",e));Ko.length?xows_xmp_discoinfo_query(Ko.pop(),null,xows_cli_srv_item_info_parse):xows_cli_rost_get_query()}function xows_cli_rost_update(e,o,_,t){if(_<0){xows_log(2,"cli_roster_update","Roster update",e+' "'+o+'" subscription: '+_);let t=Xo.length;for(;t--;)if(Xo[t].bare===e){xows_log(2,"cli_roster_update","removing Contact",e),Xo.splice(t,1),No(e);break}return}xows_log(2,"cli_roster_update","update Contact",e+' "'+o+'" subscription: '+_);let s=xows_cli_cont_get(e);if(null!==s)s.name=o||e,s.subs=_;else{let t=null;const n=xows_cach_peer_get(e);null!==n&&(o=n.name,t=n.avat),t||(t=xows_cli_avat_temp(e)),s=xows_cli_cont_new(e,o,_,t)}xt.avatar_notify||xows_cli_avat_meta_query(e),xows_cli_nick_query(e),To(s)}function xows_cli_rost_get_parse(e){if(Xo.length=0,e.length)for(let o=0,_=e.length;o<_;++o)xows_cli_rost_update(e[o].bare,e[o].name,e[o].subs,e[o].group);else To(null);Wo&&xows_cli_presence_init()}function xows_cli_rost_get_query(){xows_xmp_roster_get_query(xows_cli_rost_get_parse)}function xows_cli_rost_edit(e,o){xows_log(2,"cli_roster_edit",(o?"add":"remove")+" contact",e),xows_xmp_roster_set_query(e,o,null,null),o&&(xows_log(2,"cli_roster_edit","request subscribe to",e),xows_xmp_send_presence(e,"subscribe"))}function xows_cli_vcard_query(e){xows_log(2,"cli_vcard_query","query vCard for",e),xows_cli_feat_own_has(Q)&&!xt.legacy_vcard?xows_xmp_vcard4_get_query(e,xows_cli_vcard_parse):xows_xmp_vcardt_get_query(e,xows_cli_vcard_parse)}let Yo=null;function xows_cli_vcard_parse(e,o){let _,t,s;if(xows_log(2,"cli_vcard_handle","parse recevied vCard",e),o){let e;if(Jo.vcrd=o,xows_cli_feat_own_has(Q)&&!xt.legacy_vcard)(e=o.querySelector("nickname"))&&(_=xows_xml_get_text(e.firstChild)),(e=o.querySelector("note"))&&(t=xows_xml_get_text(e.firstChild)),(e=o.querySelector("photo"))&&(s=xows_xml_get_text(e.firstChild));else if((e=o.querySelector("NICKNAME"))&&(_=xows_xml_get_text(e)),(e=o.querySelector("NOTE"))?t=xows_xml_get_text(e):(e=o.querySelector("DESC"))&&(t=xows_xml_get_text(e)),e=o.querySelector("PHOTO")){s="data:"+xows_xml_get_text(e.querySelector("TYPE"))+";base64,"+xows_xml_get_text(e.querySelector("BINVAL"))}_&&!_.length&&(_=null),t&&!t.length&&(t=null),s&&!s.length&&(s=null)}xows_cli_peer_update(e,_,s?xows_cach_avat_save(s):null,t)}function xows_cli_vcard_publish(e){const o=xows_cach_avat_get(Jo.avat);Jo.vcrd||(Jo.vcrd=xows_xml_node("vcard"));const _=Jo.vcrd;if(xows_cli_feat_own_has(Q)&&!xt.legacy_vcard)xows_xml_edit(_,"nickname",xows_xml_node("text",null,Jo.name)),xows_xml_edit(_,"note",xows_xml_node("text",null,Jo.stat)),o&&xows_xml_edit(_,"photo",xows_xml_node("uri",null,o));else if(xows_xml_edit(_,"NICKNAME",Jo.name),xows_xml_edit(_,"DESC",Jo.stat),o){const e=xows_url_to_type(o),t=xows_url_to_data(o);xows_xml_edit(_,"PHOTO",[xows_xml_node("TYPE",null,e),xows_xml_node("BINVAL",null,t)])}xows_log(2,"cli_vcard_publish","publish own vCard");const t=[];for(let e=0,o=_.childNodes.length;e<o;++e)t.push(_.childNodes[e].cloneNode(!0));xows_cli_feat_own_has(Q)&&!xt.legacy_vcard?xows_xmp_vcard4_publish(t,e?"open":"presence"):xows_xmp_vcardt_set_query(t)}const $o={};function xows_cli_avat_data_parse(e,o,_){let t=null;if(_){if(xows_log(2,"cli_avat_data_handle","handle received Avatar-Data",o),!(o in $o))return void xows_log(1,"cli_avat_data_handle","received Avatar-Data without Metadata",o);t=xows_cach_avat_save("data:"+$o[o].type+";base64,"+_,o),delete $o[o]}else xows_log(2,"cli_avat_data_handle","handle cached Avatar-Data",o),t=o;xows_cli_peer_update(e,null,t,null)}function xows_cli_avat_meta_parse(e,o){if(o){const _=o.querySelector("info");if(_){const o=_.getAttribute("id");$o[o]={type:_.getAttribute("type"),width:_.getAttribute("width"),height:_.getAttribute("height"),bytes:_.getAttribute("bytes")},xows_cach_avat_has(o)?(xows_log(2,"cli_avat_meta_parse","Avatar-Data already cached",o),xows_cli_avat_data_parse(e,o,null)):(xows_log(2,"cli_avat_meta_parse","Avatar-Data unavailable",o),xows_xmp_avat_data_get_query(e,o,xows_cli_avat_data_parse))}}}function xows_cli_avat_meta_query(e){xows_log(2,"cli_avat_meta_query","query Avatar-Metadata",e),xows_xmp_avat_meta_get_query(e,xows_cli_avat_meta_parse)}let Qo=null;function xows_cli_avat_meta_publish(e=null,o="result"){if("result"===o)if(xows_log(2,"cli_avat_meta_publish","Avatar-Data publication succeed","now publish Metadata"),Qo){const e=Qo.open,o=Qo.hash,_=Qo.type,t=Qo.bytes;xows_xmp_avat_meta_publish(o,_,t,Ao,Ao,e?"open":"presence",null),xows_log(2,"cli_avat_meta_publish","publish Avatar-Metadata","id:"+o+" bytes:"+t)}else xows_log(1,"cli_avat_meta_publish","no temp Metadata stored");Qo=null}function xows_cli_avat_data_publish(e){const o=xows_cach_avat_get(Jo.avat);if(o){const _=xows_url_to_data(o),t=xows_url_to_type(o),s=atob(_),n=xows_bytes_to_hex(xows_hash_sha1(s));Qo={open:e,hash:n,type:t,bytes:s.length},xows_log(2,"cli_avat_data_publish","publish Avatar-Data",n),xows_xmp_avat_data_publish(n,_,e?"open":"presence",xows_cli_avat_meta_publish)}else xows_log(1,"cli_avat_data_publish","no Data to publish")}function xows_cli_avat_temp(e){let o;return o=e.includes("/")?xows_jid_to_nick(e).toLowerCase():xows_jid_to_user(e),xows_cach_avat_save(xows_gen_avatar(Ao,null,o),null,!0)}function xows_cli_nick_parse(e,o){xows_log(2,"cli_nick_parse","parse received Nickname",e),xows_cli_peer_update(e,xows_xml_get_text(o),null,null)}function xows_cli_nick_query(e){xows_log(2,"cli_nick_query","query nickname",e),xows_xmp_nick_get_query(e,xows_cli_nick_parse)}function xows_cli_nick_publish(){xows_log(2,"cli_nick_publish","publish own Nickname",Jo.name),xows_xmp_nick_publish(Jo.name)}function xows_cli_book_parse(e,o){let _,t,s,n,r;for(let e=0,i=o.length;e<i;++e){t=o[e].id,s=o[e].data.getAttribute("name"),n=o[e].data.getAttribute("autojoin");const i=o[e].data.querySelector("nick");if(i&&(r=xows_xml_get_text(i)),_=xows_cli_room_get(t)){if(_.publ)return}else _=xows_cli_room_new(t,s,"",!1,!1);_.book=!0,n&&xows_cli_room_join(_),xows_cli_room_discoinfo(_)}}function xows_cli_book_publish(e,o,_,t){const s=_||e.name,n=t||xows_jid_to_nick(e.join);xows_log(2,"cli_book_publish","add bookmark",s+" ("+e.bare+")"),xows_xmp_bookmark_publish(e.bare,s,o,n)}function xows_cli_xmp_onroster(e,o,_,t){xows_cli_rost_update(e,o,_,t)}function xows_cli_xmp_onsubscribe(e,o,_){let t;switch(o){case"subscribe":t="request";break;case"unsubscribed":t="denied";break;case"subscribed":t="allowed";break;case"unsubscribe":t="removed"}if(xows_log(2,"cli_xmp_onsubscribe","Subscription "+t+" by",e),"subscribe"===o){const o=xows_cli_cont_get(e);o?(xows_log(2,"cli_xmp_onsubscribe","request automatically allowed","Contact in Roster"),xows_cli_subscribe_allow(o.bare,!0,_)):jo(xows_jid_to_bare(e),_)}}function xows_cli_xmp_onpresence(e,o,_,t,s,n){const r=xows_cli_cont_get(e);if(!r)return void(xows_jid_to_bare(e)!==Ze&&xows_log(1,"cli_xmp_onpresence","unknown/unsubscribed Contact",e));r.lock=r.bare;let i=xows_jid_to_nick(e);if(o>=0){if(r.ress[i])xows_log(2,"cli_xmp_onpresence","updating Resource for "+r.bare,i),r.ress[i].show=o,r.ress[i].prio=_,r.ress[i].stat=t;else if(xows_log(2,"cli_xmp_onpresence","adding Resource for "+r.bare,i),r.ress[i]={show:o,prio:_,stat:t,node:null},s){const o=s.node+"#"+s.ver;r.ress[i].node=o,xows_cach_caps_has(o)||(xows_log(2,"cli_xmp_onpresence","query entity caps for "+r.bare,o),xows_xmp_discoinfo_query(e,o,xows_cli_entity_caps_parse))}}else r.ress[i]&&(xows_log(2,"cli_xmp_onpresence","removing Resource for "+r.bare,i),delete r.ress[i]);r.show=-1,r.stat=null;let c=-128;for(const e in r.ress)r.ress.hasOwnProperty(e)&&r.ress[e].prio>c&&(c=r.ress[e].prio,r.show=r.ress[e].show,r.stat=r.ress[e].stat);xows_log(2,"cli_xmp_onpresence","updated Presence for "+r.bare,"show:"+r.show+" stat:"+r.stat),n&&(xows_cach_avat_has(n)?r.avat=n:xows_cli_vcard_query(r.bare)),xows_cach_peer_save(r.bare,null,null,r.stat),To(r)}function xows_cli_xmp_onoccupant(e,o,_,t,s){let n=xows_cli_room_get(e);if(!n){const o=xows_jid_to_bare(e),_=xows_jid_to_user(o);n=xows_cli_room_new(o,_,"",!1,!1),xows_log(2,"cli_xmp_onoccupant","add unexisting Room",_+" ("+o+")"),Lo(n),xows_cli_room_discoinfo(n)}for(let _=0,s=t.code.length;_<s;++_)if(110!==t.code[_])201===t.code[_]&&(n.init=!0),t.code[_];else{if(!(o>=0))return n.join=null,xows_log(2,"cli_xmp_onoccupant","leaving Room",n.bare),void Oo(n,null);n.join=e}if(o<0){let o=n.occu.length;for(;o--;)if(n.occu[o].jid===e){n.occu.splice(o,1);break}return void Oo(n,e)}const r=xows_jid_to_nick(e),i=t.full?xows_jid_to_bare(t.full):null;let c=xows_cli_occu_get(n,e);if(c)xows_log(2,"cli_xmp_onoccupant","refresh Occupant of "+n.bare,r),c.full=t.full,c.bare=i,c.affi=t.affi,c.role=t.role,c.show=o,c.stat=_;else{xows_log(2,"cli_xmp_onoccupant","adding Occupant to "+n.bare,r);let s=null;i&&(s=xows_cach_peer_get(i)),s||(s=xows_cach_peer_get(e));const a=s&&s.avat?s.avat:null;c=xows_cli_occu_new(n,e,t.affi,t.role,t.full,a,o,_)}c.self&&(n.affi=t.affi,n.role=t.role),s?xows_cach_avat_has(s)?c.avat=s:xows_cli_vcard_query(e):c.avat||xows_cli_avat_meta_query(e),xows_cach_peer_save(e,c.name,c.avat,null),Io(n,c,t.code)}function xows_cli_entity_caps_parse(e,o,_,t,s){xows_cach_caps_has(s)?xows_log(2,"cli_entity_caps_parse","node already cached",s):(xows_log(2,"cli_entity_caps_parse","caching entity caps",s),xows_cach_caps_save(s,_))}function xows_cli_entity_caps_test(e,o){const _=xows_cach_caps_get(e);return _&&_.includes(o)}function xows_cli_xmp_onchatstate(e,o,_,t,s,n){if("chat"!==o&&"groupchat"!==o)return void xows_log(1,"cli_xmp_onchatstate","invalid message type",o);let r;if("chat"===o){if(xows_cli_isself(_))return void xows_log(2,"cli_xmp_onchatstate","carbons chat state ignored",_);r=xows_cli_cont_get(_)}else if((r=xows_cli_room_get(_)).join===_)return void xows_log(2,"cli_xmp_onchatstate","echo chat state ignored",_);r?(r.type===vo&&(r.lock=_,r.chat=s),xows_log(2,"cli_xmp_onchatstate","chat state",_+" "+s),Ho(r,_,s)):xows_log(1,"cli_xmp_onchatstate","unknown/unsubscribed JID",_)}function xows_cli_xmp_onmessage(e,o,_,t,s,n){if("chat"!==o&&"groupchat"!==o)return void xows_log(1,"cli_xmp_onmessage","invalid message type",o);let r,i,c;"chat"===o?(i=xows_cli_cont_get((r=xows_cli_isself(_))?t:_),c=r?Jo:i):c=(r=_===(i=xows_cli_room_get(_)).join)?Jo:xows_cli_occu_any(i,_),i?(n||(n=(new Date).getTime()),i.type===vo&&(r||(i.lock=_)),xows_log(2,"cli_xmp_onmessage","chat message",_+' "'+s+'"'),Ro(i,e,_,s,n,r,!0,c)):xows_log(1,"cli_xmp_onmessage","unknown/unsubscribed JID",_)}function xows_cli_xmp_onsubject(e,o,_){const t=xows_cli_room_get(o);t?(t.subj=_,xows_log(2,"cli_xmp_onsubject","room subject",o+' "'+_+'"'),Mo(t,_)):xows_log(1,"cli_xmp_onsubject","unknown/unsubscribed JID",o)}function xows_cli_xmp_onreceipt(e,o,_,t,s){let n;xows_cli_isself(o)?xows_log(2,"cli_xmp_onreceipt","receipt from other Resource ignored",o):(n=xows_cli_peer_get(o))?(xows_log(2,"cli_xmp_onreceipt","message receipt received",o+" "+t),Uo(n,t)):xows_log(1,"cli_xmp_onreceipt","unknown/unsubscribed JID",o)}function xows_cli_xmp_onpubsub(e,o,_){o===M&&_.length&&(xows_log(2,"cli_xmp_onpubsub","received vCard notification",e),xows_cli_vcard_parse(e,_[0].data)),o===z&&_.length&&(xows_log(2,"cli_xmp_onpubsub","received Avatar notification",e),xows_cli_avat_meta_parse(e,_[0].data)),o===oe&&_.length&&(xows_log(2,"cli_xmp_onpubsub","received Nickname notification",e),xows_cli_nick_parse(e,_[0].data)),o===V&&_.length&&(xows_log(2,"cli_xmp_onpubsub","received Bookmarks notification",e),xows_cli_book_parse(e,_))}let Zo=null;function xows_cli_mam_parse(e,o,_,t,s){const n=xows_cli_peer_get(e||o);if(!n)return void xows_log(1,"cli_mam_parse","unknown/unsubscribed JID",e||o);let r=_.length;if(n.type===vo)for(;r--;)_[r].sent=xows_cli_isself(_[r].from),_[r].sndr=_[r].sent?Jo:n;else{let e,o;for(;r--;)e=_[r].from,_[r].sent=e===n.join,o=_[r].sent?Jo:xows_cli_occu_any(n,e),_[r].sndr=o}xows_log(2,"cli_mam_parse","received archives for",n.bare),xows_isfunc(Zo)&&Zo(n,_,s)}function xows_cli_mam_query(e,o,_,t,s){e.type===vo?xows_xmp_mam_query(null,o,e.bare,_,t,null,xows_cli_mam_parse):xows_xmp_mam_query(e.bare,o,null,_,t,null,xows_cli_mam_parse),Zo=s}function xows_cli_send_message(e,o){if(!o.length)return void xows_log(1,"cli_user_send_message","message with empty body","who you gonna call ?");let _,t,s,n=!1;if(e.type===yo)_="groupchat",t=e.bare,s=e.join,n=!0;else if(_="chat",t=e.lock,s=Jo.bare,e.lock!==e.bare){const o=e.ress[xows_jid_to_nick(e.lock)];o&&(n=xows_cli_entity_caps_test(o.node,H))}xows_log(2,"cli_user_send_message","send "+_+" message",t+' "'+o+'"');const r=xows_xmp_send_message(_,t,o,n);Ro(e,r,s,o,(new Date).getTime(),!0,!n,Jo)}function xows_cli_send_chatstate(e,o){let _,t;e.type===yo?(_="groupchat",t=e.bare):(_="chat",t=e.lock),xows_log(2,"cli_send_chatstate","send chatstat",t+' "'+o+'"'),xows_xmp_send_chatstate(t,_,o)}function xows_cli_send_subject(e,o){xows_log(2,"cli_muc_subject_send","send subject",e.bare+' "'+o+'"'),xows_xmp_send_subject(e.bare,o)}const e_=[];function xows_cli_muc_items_query(){if(!xows_cli_svc_exist(ne))return xows_log(1,"cli_muc_items_query","service not found","the server does not provide "+ne+" service"),void Go(s,"multi-user chat (XEP-0045) service is unavailable");xows_xmp_discoitems_query(Eo[ne],xows_cli_muc_items_parse)}function xows_cli_muc_items_parse(e,o){let _=Vo.length;for(;_--;)Vo[_].publ&&Vo.splice(_,1);if(o.length){e_.length=0;let e=o.length;for(;e--;)e_.push(o[e].jid);xows_xmp_discoinfo_query(e_.pop(),null,xows_cli_muc_item_info_parse)}Lo(null)}function xows_cli_muc_item_info_parse(e,o,_,t){let s,n,r,i="",c="",a=!1,l=!1;for(r=o.length?o[0].name:e.split("@")[0],s=0,n=_.length;s<n;++s)"muc_passwordprotected"===_[s]&&(a=!0),"muc_public"===_[s]&&(l=!0),"muc_hidden"===_[s]&&(l=!1);if(t)for(s=0,n=t.length;s<n;++s)"muc#roominfo_description"==t[s].var&&(c=t[s].value),"muc#roominfo_subject"==t[s].var&&(i=t[s].value);let u=xows_cli_room_get(e);u?(u.name=r,u.desc=c,u.prot=a,u.publ=l,xows_log(2,"cli_muc_item_info_parse","refresh Room",r+" ("+e+') :"'+c+'"')):(u=xows_cli_room_new(e,r,c,a,l),xows_log(2,"cli_muc_item_info_parse","adding Room",r+" ("+e+') :"'+c+'"')),Lo(u),e_.length&&xows_xmp_discoinfo_query(e_.pop(),null,xows_cli_muc_item_info_parse)}function xows_cli_room_discoinfo(e){xows_xmp_discoinfo_query(e.bare,null,xows_cli_muc_item_info_parse)}let o_=null;function xows_cli_muc_cfg_get_parse(e,o){const _=xows_cli_room_get(e);_?(xows_isfunc(o_)&&o_(_,o),o_=null):xows_log(1,"cli_muc_cfg_get_parse","unknown/unsubscribed Room",e)}function xows_cli_muc_cfg_set_parse(e,o){if("result"===o){const _=xows_cli_room_get(e);if(!_)return void xows_log(1,"cli_muc_cfg_set_parse","unknown/unsubscribed Room",e);xows_cli_room_discoinfo(_),xows_isfunc(o_)&&o_(_,o),_.init=!1}o_=null}function xows_cli_room_cfg_get(e,o){o_?xows_log(1,"cli_room_cfg_get","overlapping queries"):(o_=o,xows_xmp_muc_cfg_get_guery(e.bare,xows_cli_muc_cfg_get_parse))}function xows_cli_room_cfg_set(e,o,_){o_?xows_log(1,"cli_room_cfg_set","overlapping queries"):(o_=_,xows_xmp_muc_cfg_set_query(e.bare,o,xows_cli_muc_cfg_set_parse))}function xows_cli_room_cfg_cancel(e,o){xows_xmp_muc_cfg_set_cancel(e.bare,o)}let __=null,t_=function(){},s_=function(){},n_=function(){},r_=function(){};function xows_cli_upld_query(e,o,_,s,n){if(!__){if(!xows_cli_svc_exist(X))return xows_log(1,"cli_user_upload_query","service not found","the server does not provide "+X+"(:0) service"),void Go(t,"HTTP File Upload (XEP-0363) service is unavailable");xows_log(2,"cli_user_upload_query","Upload query for",e.name),__={file:e,url:""},t_=o,s_=_,n_=s,r_=n,xows_xmp_upload_query(Eo[X],e.name,e.size,e.type,xows_cli_upld_handle)}}function xows_cli_upld_abort(){xows_log(2,"cli_user_upload_abort","upload abort requested"),i_&&i_.abort()}let i_=null;function xows_cli_upld_xhr_progress(e){xows_isfunc(n_)&&n_(e.loaded/e.total*100)}function xows_cli_upld_xhr_success(){xows_isfunc(s_)&&s_(__.url),__=null,i_=null}function xows_cli_upld_xhr_error(e){const o="HTTP PUT request failed";xows_log(1,"cli_upld_xhr_error",o),xows_isfunc(t_)&&t_(o),__=null,i_=null}function xows_cli_upld_xhr_abort(e){xows_log(1,"cli_upld_xhr_error","http PUT request aborted by user"),__=null,i_=null,xows_isfunc(r_)&&r_()}function xows_cli_upld_handle(e,o,_,t){if(!e)return __=null,void(xows_isfunc(t_)&&t_(t));__.url=_;const s=__.file;(new FormData).append(s.name,s);const n=new XMLHttpRequest;n.upload.addEventListener("progress",xows_cli_upld_xhr_progress,!1),n.upload.addEventListener("load",xows_cli_upld_xhr_success,!1),n.upload.addEventListener("error",xows_cli_upld_xhr_error,!1),n.upload.addEventListener("abort",xows_cli_upld_xhr_abort,!1),n.open("PUT",e,!0),n.setRequestHeader("Content-Type","main_menucation/octet-stream"),xows_log(2,"cli_upload_handle","send PUT http request",e),i_=n,n.send(s)}function xows_cli_muc_register_query(e){xows_xmp_register_get_query(e.bare,xows_cli_muc_register_parse)}function xows_cli_muc_register_parse(e,o,_,t,s,n){if(xows_cli_room_get(e)){if(!o&&n){for(let e=0,o=n.length;e<o;++e)"muc#register_roomnick"===n[e].var&&(n[e].value=Jo.name);xows_xmp_register_set_query(e,null,null,null,n,null)}}else xows_log(1,"cli_muc_register_parse","unknown/unsubscribed Room",e)}function xows_cli_subscribe_request(e){xows_log(2,"cli_subscribe_request","request subscribe to",e),xows_xmp_send_presence(e,"subscribe")}function xows_cli_subscribe_allow(e,o,_){if(xows_xmp_send_presence(e,o?"subscribed":"unsubscribed"),xows_log(2,"cli_subscribe_request",(o?"allow":"deny")+" subscription from",e),o&&!xows_cli_cont_get(e)){let o;if(_)o=_;else{const _=e.split("@")[0];o=_[0].toUpperCase()+_.slice(1)}xows_cli_rost_edit(e,o)}Bo(e)}function xows_cli_room_join(e,o,_,t){if(!xows_cli_svc_exist(ne))return xows_log(1,"cli_room_join","service not found","the server does not provide "+ne+" service"),void Go(s,"Multi-User Chat (XEP-0045) service is unavailable");let n;if(e){if(e.join)return;n=e.bare}else n=o.toLowerCase()+"@"+Eo[ne];xows_log(2,"cli_room_join","request join",o+" ("+n+")"),xows_xmp_send_presence(n+"/"+(_||Jo.name),null,Jo.show,Jo.stat,Jo.avat,!0)}function xows_cli_change_profile(e,o,_){e&&(Jo.name=e,xows_log(2,"cli_change_profile","change nickname",e)),o?(xows_log(2,"cli_change_profile","change avatar"),Jo.avat=xows_cach_avat_save(o)):(xows_log(2,"cli_change_profile","set default avatar"),Jo.avat=xows_cli_avat_temp(Jo.bare)),xows_cli_vcard_publish(_),xows_cli_nick_publish(),xows_cli_avat_data_publish(_),xows_cli_presence_update(),So(Jo)}let c_=-1;function xows_cli_presence_init(){Jo.show=c_=3,xows_log(2,"cli_presence_init","send intial presence"),xows_xmp_send_presence(null,null,3,Jo.stat),Wo=!1,xt.vcard4_notify||xows_cli_vcard_query(Jo.bare),xt.avatar_notify||xows_cli_avat_meta_query(Jo.bare),xows_cli_nick_query(Jo.bare),Do(Jo),So(Jo)}function xows_cli_presence_update(){let e,o,_,t;Jo.show>=0?(o=Jo.show,_=Jo.stat,t=Jo.avat):e="unavailable",xows_log(2,"cli_presence_update","send updated presence"),xows_xmp_send_presence(null,e,o,_,t);let s=Vo.length;for(;s--;)Vo[s].join&&(xows_xmp_send_presence(Vo[s].join,e,o,_,t),e&&(Vo[s].join=null))}function xows_cli_change_presence(e){Jo.show=c_=e,xows_cli_presence_update(),So(Jo)}function xows_cli_change_status(e){Jo.stat!==e&&(Jo.stat=e,xows_cach_peer_save(Jo.bare,null,null,e),Jo.show===c_&&xows_cli_presence_update(),So(Jo))}let a_=null;function xows_cli_activity_sleep(){a_&&clearTimeout(a_),Jo.show>1&&(a_=setTimeout(xows_cli_activity_sleep,6e5),Jo.show--,xows_cli_presence_update(),So(Jo))}function xows_cli_activity_wakeup(){a_&&clearTimeout(a_),a_=setTimeout(xows_cli_activity_sleep,6e5),Jo.show<c_&&(Jo.show=c_,xows_cli_presence_update(),So(Jo))}function xows_cli_activity_stop(){a_&&clearTimeout(a_),c_=-1,Jo.show=-1}let l_=null;function xows_cli_chatstate_set(e,o){o>Se?(l_?clearTimeout(l_):xows_cli_send_chatstate(e,o),l_=setTimeout(xows_cli_chatstate_set,4e3,e,Se)):(clearTimeout(l_),xows_cli_send_chatstate(e,o),l_=null)}function xows_cli_connected(){return null!==Jo.jid}function xows_cli_disconnect(){xows_log(2,"cli_disconnect","prepare disconnect"),Jo.jid&&(Jo.show=de,xows_cli_presence_update(),xows_xmp_send_close(3))}const u_=new DOMParser;let x_=function(){},d_=0,w_=[],p_=null,m_="dark";const g_={100:"1F4AF",1234:"1F522",grinning:"1F600",smiley:"1F603",smile:"1F604",grin:"1F601",laughing:"1F606",sweat_smile:"1F605",rolling_on_the_floor_laughing:"1F923",joy:"1F602",slightly_smiling_face:"1F642",upside_down_face:"1F643",wink:"1F609",blush:"1F60A",innocent:"1F607",smiling_face_with_3_hearts:"1F970",heart_eyes:"1F60D","star-struck":"1F929",kissing_heart:"1F618",kissing:"1F617",kissing_closed_eyes:"1F61A",kissing_smiling_eyes:"1F619",yum:"1F60B",stuck_out_tongue:"1F61B",stuck_out_tongue_winking_eye:"1F61C",zany_face:"1F92A",stuck_out_tongue_closed_eyes:"1F61D",money_mouth_face:"1F911",hugging_face:"1F917",face_with_hand_over_mouth:"1F92D",shushing_face:"1F92B",thinking_face:"1F914",zipper_mouth_face:"1F910",face_with_raised_eyebrow:"1F928",neutral_face:"1F610",expressionless:"1F611",no_mouth:"1F636",smirk:"1F60F",unamused:"1F612",face_with_rolling_eyes:"1F644",grimacing:"1F62C",lying_face:"1F925",relieved:"1F60C",pensive:"1F614",sleepy:"1F62A",drooling_face:"1F924",sleeping:"1F634",mask:"1F637",face_with_thermometer:"1F912",face_with_head_bandage:"1F915",nauseated_face:"1F922",face_vomiting:"1F92E",sneezing_face:"1F927",hot_face:"1F975",cold_face:"1F976",woozy_face:"1F974",dizzy_face:"1F635",exploding_head:"1F92F",face_with_cowboy_hat:"1F920",partying_face:"1F973",sunglasses:"1F60E",nerd_face:"1F913",face_with_monocle:"1F9D0",confused:"1F615",worried:"1F61F",slightly_frowning_face:"1F641",open_mouth:"1F62E",hushed:"1F62F",astonished:"1F632",flushed:"1F633",pleading_face:"1F97A",frowning:"1F626",anguished:"1F627",fearful:"1F628",cold_sweat:"1F630",disappointed_relieved:"1F625",cry:"1F622",sob:"1F62D",scream:"1F631",confounded:"1F616",persevere:"1F623",disappointed:"1F61E",sweat:"1F613",weary:"1F629",tired_face:"1F62B",yawning_face:"1F971",triumph:"1F624",rage:"1F621",angry:"1F620",face_with_symbols_on_mouth:"1F92C",smiling_imp:"1F608",imp:"1F47F",skull:"1F480",hankey:"1F4A9",clown_face:"1F921",japanese_ogre:"1F479",japanese_goblin:"1F47A",ghost:"1F47B",alien:"1F47D",space_invader:"1F47E",robot_face:"1F916",smiley_cat:"1F63A",smile_cat:"1F638",joy_cat:"1F639",heart_eyes_cat:"1F63B",smirk_cat:"1F63C",kissing_cat:"1F63D",scream_cat:"1F640",crying_cat_face:"1F63F",pouting_cat:"1F63E",see_no_evil:"1F648",hear_no_evil:"1F649",speak_no_evil:"1F64A",kiss:"1F48B",love_letter:"1F48C",cupid:"1F498",gift_heart:"1F49D",sparkling_heart:"1F496",heartpulse:"1F497",heartbeat:"1F493",revolving_hearts:"1F49E",two_hearts:"1F495",heart_decoration:"1F49F",broken_heart:"1F494",orange_heart:"1F9E1",yellow_heart:"1F49B",green_heart:"1F49A",blue_heart:"1F499",purple_heart:"1F49C",brown_heart:"1F90E",black_heart:"1F5A4",white_heart:"1F90D",anger:"1F4A2",boom:"1F4A5",dizzy:"1F4AB",sweat_drops:"1F4A6",dash:"1F4A8",bomb:"1F4A3",speech_balloon:"1F4AC",thought_balloon:"1F4AD",zzz:"1F4A4",wave:"1F44B",raised_back_of_hand:"1F91A",hand:"270B","spock-hand":"1F596",ok_hand:"1F44C",pinching_hand:"1F90F",crossed_fingers:"1F91E",i_love_you_hand_sign:"1F91F",the_horns:"1F918",call_me_hand:"1F919",point_left:"1F448",point_right:"1F449",point_up_2:"1F446",middle_finger:"1F595",point_down:"1F447","+1":"1F44D","-1":"1F44E",fist:"270A",facepunch:"1F44A","left-facing_fist":"1F91B","right-facing_fist":"1F91C",clap:"1F44F",raised_hands:"1F64C",open_hands:"1F450",palms_up_together:"1F932",handshake:"1F91D",pray:"1F64F",nail_care:"1F485",selfie:"1F933",muscle:"1F4AA",mechanical_arm:"1F9BE",mechanical_leg:"1F9BF",leg:"1F9B5",foot:"1F9B6",ear:"1F442",ear_with_hearing_aid:"1F9BB",nose:"1F443",brain:"1F9E0",tooth:"1F9B7",bone:"1F9B4",eyes:"1F440",tongue:"1F445",lips:"1F444",baby:"1F476",child:"1F9D2",boy:"1F466",girl:"1F467",adult:"1F9D1",person_with_blond_hair:"1F471",man:"1F468",bearded_person:"1F9D4",woman:"1F469",older_adult:"1F9D3",older_man:"1F474",older_woman:"1F475",person_frowning:"1F64D",person_with_pouting_face:"1F64E",no_good:"1F645",ok_woman:"1F646",information_desk_person:"1F481",raising_hand:"1F64B",deaf_person:"1F9CF",bow:"1F647",face_palm:"1F926",shrug:"1F937",cop:"1F46E",guardsman:"1F482",construction_worker:"1F477",prince:"1F934",princess:"1F478",man_with_turban:"1F473",man_with_gua_pi_mao:"1F472",person_with_headscarf:"1F9D5",man_in_tuxedo:"1F935",bride_with_veil:"1F470",pregnant_woman:"1F930","breast-feeding":"1F931",angel:"1F47C",santa:"1F385",mrs_claus:"1F936",superhero:"1F9B8",supervillain:"1F9B9",mage:"1F9D9",fairy:"1F9DA",vampire:"1F9DB",merperson:"1F9DC",elf:"1F9DD",genie:"1F9DE",zombie:"1F9DF",massage:"1F486",haircut:"1F487",walking:"1F6B6",standing_person:"1F9CD",kneeling_person:"1F9CE",runner:"1F3C3",dancer:"1F483",man_dancing:"1F57A",dancers:"1F46F",person_in_steamy_room:"1F9D6",person_climbing:"1F9D7",fencer:"1F93A",horse_racing:"1F3C7",snowboarder:"1F3C2",surfer:"1F3C4",rowboat:"1F6A3",swimmer:"1F3CA",bicyclist:"1F6B4",mountain_bicyclist:"1F6B5",person_doing_cartwheel:"1F938",wrestlers:"1F93C",water_polo:"1F93D",handball:"1F93E",juggling:"1F939",person_in_lotus_position:"1F9D8",bath:"1F6C0",sleeping_accommodation:"1F6CC",two_women_holding_hands:"1F46D",couple:"1F46B",two_men_holding_hands:"1F46C",couplekiss:"1F48F",couple_with_heart:"1F491",family:"1F46A",bust_in_silhouette:"1F464",busts_in_silhouette:"1F465",footprints:"1F463",monkey_face:"1F435",monkey:"1F412",gorilla:"1F98D",orangutan:"1F9A7",dog:"1F436",dog2:"1F415",guide_dog:"1F9AE",poodle:"1F429",wolf:"1F43A",fox_face:"1F98A",raccoon:"1F99D",cat:"1F431",cat2:"1F408",lion_face:"1F981",tiger:"1F42F",tiger2:"1F405",leopard:"1F406",horse:"1F434",racehorse:"1F40E",unicorn_face:"1F984",zebra_face:"1F993",deer:"1F98C",cow:"1F42E",ox:"1F402",water_buffalo:"1F403",cow2:"1F404",pig:"1F437",pig2:"1F416",boar:"1F417",pig_nose:"1F43D",ram:"1F40F",sheep:"1F411",goat:"1F410",dromedary_camel:"1F42A",camel:"1F42B",llama:"1F999",giraffe_face:"1F992",elephant:"1F418",rhinoceros:"1F98F",hippopotamus:"1F99B",mouse:"1F42D",mouse2:"1F401",rat:"1F400",hamster:"1F439",rabbit:"1F430",rabbit2:"1F407",hedgehog:"1F994",bat:"1F987",bear:"1F43B",koala:"1F428",panda_face:"1F43C",sloth:"1F9A5",otter:"1F9A6",skunk:"1F9A8",kangaroo:"1F998",badger:"1F9A1",feet:"1F43E",turkey:"1F983",chicken:"1F414",rooster:"1F413",hatching_chick:"1F423",baby_chick:"1F424",hatched_chick:"1F425",bird:"1F426",penguin:"1F427",eagle:"1F985",duck:"1F986",swan:"1F9A2",owl:"1F989",flamingo:"1F9A9",peacock:"1F99A",parrot:"1F99C",frog:"1F438",crocodile:"1F40A",turtle:"1F422",lizard:"1F98E",snake:"1F40D",dragon_face:"1F432",dragon:"1F409",sauropod:"1F995","t-rex":"1F996",whale:"1F433",whale2:"1F40B",dolphin:"1F42C",fish:"1F41F",tropical_fish:"1F420",blowfish:"1F421",shark:"1F988",octopus:"1F419",shell:"1F41A",snail:"1F40C",butterfly:"1F98B",bug:"1F41B",ant:"1F41C",bee:"1F41D",beetle:"1F41E",cricket:"1F997",scorpion:"1F982",mosquito:"1F99F",microbe:"1F9A0",bouquet:"1F490",cherry_blossom:"1F338",white_flower:"1F4AE",rose:"1F339",wilted_flower:"1F940",hibiscus:"1F33A",sunflower:"1F33B",blossom:"1F33C",tulip:"1F337",seedling:"1F331",evergreen_tree:"1F332",deciduous_tree:"1F333",palm_tree:"1F334",cactus:"1F335",ear_of_rice:"1F33E",herb:"1F33F",four_leaf_clover:"1F340",maple_leaf:"1F341",fallen_leaf:"1F342",leaves:"1F343",grapes:"1F347",melon:"1F348",watermelon:"1F349",tangerine:"1F34A",lemon:"1F34B",banana:"1F34C",pineapple:"1F34D",mango:"1F96D",apple:"1F34E",green_apple:"1F34F",pear:"1F350",peach:"1F351",cherries:"1F352",strawberry:"1F353",kiwifruit:"1F95D",tomato:"1F345",coconut:"1F965",avocado:"1F951",eggplant:"1F346",potato:"1F954",carrot:"1F955",corn:"1F33D",cucumber:"1F952",leafy_green:"1F96C",broccoli:"1F966",garlic:"1F9C4",onion:"1F9C5",mushroom:"1F344",peanuts:"1F95C",chestnut:"1F330",bread:"1F35E",croissant:"1F950",baguette_bread:"1F956",pretzel:"1F968",bagel:"1F96F",pancakes:"1F95E",waffle:"1F9C7",cheese_wedge:"1F9C0",meat_on_bone:"1F356",poultry_leg:"1F357",cut_of_meat:"1F969",bacon:"1F953",hamburger:"1F354",fries:"1F35F",pizza:"1F355",hotdog:"1F32D",sandwich:"1F96A",taco:"1F32E",burrito:"1F32F",stuffed_flatbread:"1F959",falafel:"1F9C6",egg:"1F95A",fried_egg:"1F373",shallow_pan_of_food:"1F958",stew:"1F372",bowl_with_spoon:"1F963",green_salad:"1F957",popcorn:"1F37F",butter:"1F9C8",salt:"1F9C2",canned_food:"1F96B",bento:"1F371",rice_cracker:"1F358",rice_ball:"1F359",rice:"1F35A",curry:"1F35B",ramen:"1F35C",spaghetti:"1F35D",sweet_potato:"1F360",oden:"1F362",sushi:"1F363",fried_shrimp:"1F364",fish_cake:"1F365",moon_cake:"1F96E",dango:"1F361",dumpling:"1F95F",fortune_cookie:"1F960",takeout_box:"1F961",crab:"1F980",lobster:"1F99E",shrimp:"1F990",squid:"1F991",oyster:"1F9AA",icecream:"1F366",shaved_ice:"1F367",ice_cream:"1F368",doughnut:"1F369",cookie:"1F36A",birthday:"1F382",cake:"1F370",cupcake:"1F9C1",pie:"1F967",chocolate_bar:"1F36B",candy:"1F36C",lollipop:"1F36D",custard:"1F36E",honey_pot:"1F36F",baby_bottle:"1F37C",glass_of_milk:"1F95B",coffee:"2615",tea:"1F375",sake:"1F376",champagne:"1F37E",wine_glass:"1F377",cocktail:"1F378",tropical_drink:"1F379",beer:"1F37A",beers:"1F37B",clinking_glasses:"1F942",tumbler_glass:"1F943",cup_with_straw:"1F964",beverage_box:"1F9C3",mate_drink:"1F9C9",ice_cube:"1F9CA",chopsticks:"1F962",fork_and_knife:"1F374",spoon:"1F944",hocho:"1F52A",amphora:"1F3FA",eyeglasses:"1F453",goggles:"1F97D",lab_coat:"1F97C",safety_vest:"1F9BA",necktie:"1F454",shirt:"1F455",jeans:"1F456",scarf:"1F9E3",gloves:"1F9E4",coat:"1F9E5",socks:"1F9E6",dress:"1F457",kimono:"1F458",sari:"1F97B","one-piece_swimsuit":"1FA71",briefs:"1FA72",shorts:"1FA73",bikini:"1F459",womans_clothes:"1F45A",purse:"1F45B",handbag:"1F45C",pouch:"1F45D",school_satchel:"1F392",mans_shoe:"1F45E",athletic_shoe:"1F45F",hiking_boot:"1F97E",womans_flat_shoe:"1F97F",high_heel:"1F460",sandal:"1F461",ballet_shoes:"1FA70",boot:"1F462",crown:"1F451",womans_hat:"1F452",tophat:"1F3A9",mortar_board:"1F393",billed_cap:"1F9E2",prayer_beads:"1F4FF",lipstick:"1F484",ring:"1F48D",gem:"1F48E",mute:"1F507",speaker:"1F508",sound:"1F509",loud_sound:"1F50A",loudspeaker:"1F4E2",mega:"1F4E3",postal_horn:"1F4EF",bell:"1F514",no_bell:"1F515",musical_score:"1F3BC",musical_note:"1F3B5",notes:"1F3B6",microphone:"1F3A4",headphones:"1F3A7",radio:"1F4FB",saxophone:"1F3B7",guitar:"1F3B8",musical_keyboard:"1F3B9",trumpet:"1F3BA",violin:"1F3BB",banjo:"1FA95",drum_with_drumsticks:"1F941",iphone:"1F4F1",calling:"1F4F2",telephone_receiver:"1F4DE",pager:"1F4DF",fax:"1F4E0",battery:"1F50B",electric_plug:"1F50C",computer:"1F4BB",minidisc:"1F4BD",floppy_disk:"1F4BE",cd:"1F4BF",dvd:"1F4C0",abacus:"1F9EE",movie_camera:"1F3A5",clapper:"1F3AC",tv:"1F4FA",camera:"1F4F7",camera_with_flash:"1F4F8",video_camera:"1F4F9",vhs:"1F4FC",mag:"1F50D",mag_right:"1F50E",bulb:"1F4A1",flashlight:"1F526",izakaya_lantern:"1F3EE",diya_lamp:"1FA94",notebook_with_decorative_cover:"1F4D4",closed_book:"1F4D5",book:"1F4D6",green_book:"1F4D7",blue_book:"1F4D8",orange_book:"1F4D9",books:"1F4DA",notebook:"1F4D3",ledger:"1F4D2",page_with_curl:"1F4C3",scroll:"1F4DC",page_facing_up:"1F4C4",newspaper:"1F4F0",bookmark_tabs:"1F4D1",bookmark:"1F516",moneybag:"1F4B0",yen:"1F4B4",dollar:"1F4B5",euro:"1F4B6",pound:"1F4B7",money_with_wings:"1F4B8",credit_card:"1F4B3",receipt:"1F9FE",chart:"1F4B9",currency_exchange:"1F4B1",heavy_dollar_sign:"1F4B2","e-mail":"1F4E7",incoming_envelope:"1F4E8",envelope_with_arrow:"1F4E9",outbox_tray:"1F4E4",inbox_tray:"1F4E5",package:"1F4E6",mailbox:"1F4EB",mailbox_closed:"1F4EA",mailbox_with_mail:"1F4EC",mailbox_with_no_mail:"1F4ED",postbox:"1F4EE",memo:"1F4DD",briefcase:"1F4BC",file_folder:"1F4C1",open_file_folder:"1F4C2",date:"1F4C5",calendar:"1F4C6",card_index:"1F4C7",chart_with_upwards_trend:"1F4C8",chart_with_downwards_trend:"1F4C9",bar_chart:"1F4CA",clipboard:"1F4CB",pushpin:"1F4CC",round_pushpin:"1F4CD",paperclip:"1F4CE",straight_ruler:"1F4CF",triangular_ruler:"1F4D0",lock:"1F512",unlock:"1F513",lock_with_ink_pen:"1F50F",closed_lock_with_key:"1F510",key:"1F511",hammer:"1F528",axe:"1FA93",gun:"1F52B",bow_and_arrow:"1F3F9",wrench:"1F527",nut_and_bolt:"1F529",probing_cane:"1F9AF",link:"1F517",toolbox:"1F9F0",magnet:"1F9F2",test_tube:"1F9EA",petri_dish:"1F9EB",dna:"1F9EC",microscope:"1F52C",telescope:"1F52D",satellite_antenna:"1F4E1",syringe:"1F489",drop_of_blood:"1FA78",pill:"1F48A",adhesive_bandage:"1FA79",stethoscope:"1FA7A",door:"1F6AA",chair:"1FA91",toilet:"1F6BD",shower:"1F6BF",bathtub:"1F6C1",razor:"1FA92",lotion_bottle:"1F9F4",safety_pin:"1F9F7",broom:"1F9F9",basket:"1F9FA",roll_of_paper:"1F9FB",soap:"1F9FC",sponge:"1F9FD",fire_extinguisher:"1F9EF",shopping_trolley:"1F6D2",smoking:"1F6AC",moyai:"1F5FF",earth_africa:"1F30D",earth_americas:"1F30E",earth_asia:"1F30F",globe_with_meridians:"1F310",japan:"1F5FE",compass:"1F9ED",volcano:"1F30B",mount_fuji:"1F5FB",bricks:"1F9F1",house:"1F3E0",house_with_garden:"1F3E1",office:"1F3E2",post_office:"1F3E3",european_post_office:"1F3E4",hospital:"1F3E5",bank:"1F3E6",hotel:"1F3E8",love_hotel:"1F3E9",convenience_store:"1F3EA",school:"1F3EB",department_store:"1F3EC",factory:"1F3ED",japanese_castle:"1F3EF",european_castle:"1F3F0",wedding:"1F492",tokyo_tower:"1F5FC",statue_of_liberty:"1F5FD",church:"26EA",mosque:"1F54C",hindu_temple:"1F6D5",synagogue:"1F54D",kaaba:"1F54B",fountain:"26F2",tent:"26FA",foggy:"1F301",night_with_stars:"1F303",sunrise_over_mountains:"1F304",sunrise:"1F305",city_sunset:"1F306",city_sunrise:"1F307",bridge_at_night:"1F309",carousel_horse:"1F3A0",ferris_wheel:"1F3A1",roller_coaster:"1F3A2",barber:"1F488",circus_tent:"1F3AA",steam_locomotive:"1F682",railway_car:"1F683",bullettrain_side:"1F684",bullettrain_front:"1F685",train2:"1F686",metro:"1F687",light_rail:"1F688",station:"1F689",tram:"1F68A",monorail:"1F69D",mountain_railway:"1F69E",train:"1F68B",bus:"1F68C",oncoming_bus:"1F68D",trolleybus:"1F68E",minibus:"1F690",ambulance:"1F691",fire_engine:"1F692",police_car:"1F693",oncoming_police_car:"1F694",taxi:"1F695",oncoming_taxi:"1F696",car:"1F697",oncoming_automobile:"1F698",blue_car:"1F699",truck:"1F69A",articulated_lorry:"1F69B",tractor:"1F69C",motor_scooter:"1F6F5",manual_wheelchair:"1F9BD",motorized_wheelchair:"1F9BC",auto_rickshaw:"1F6FA",bike:"1F6B2",scooter:"1F6F4",skateboard:"1F6F9",busstop:"1F68F",fuelpump:"26FD",rotating_light:"1F6A8",traffic_light:"1F6A5",vertical_traffic_light:"1F6A6",octagonal_sign:"1F6D1",construction:"1F6A7",anchor:"2693",boat:"26F5",canoe:"1F6F6",speedboat:"1F6A4",ship:"1F6A2",airplane_departure:"1F6EB",airplane_arriving:"1F6EC",parachute:"1FA82",seat:"1F4BA",helicopter:"1F681",suspension_railway:"1F69F",mountain_cableway:"1F6A0",aerial_tramway:"1F6A1",rocket:"1F680",flying_saucer:"1F6F8",luggage:"1F9F3",hourglass:"231B",hourglass_flowing_sand:"23F3",watch:"231A",alarm_clock:"23F0",clock12:"1F55B",clock1230:"1F567",clock1:"1F550",clock130:"1F55C",clock2:"1F551",clock230:"1F55D",clock3:"1F552",clock330:"1F55E",clock4:"1F553",clock430:"1F55F",clock5:"1F554",clock530:"1F560",clock6:"1F555",clock630:"1F561",clock7:"1F556",clock730:"1F562",clock8:"1F557",clock830:"1F563",clock9:"1F558",clock930:"1F564",clock10:"1F559",clock1030:"1F565",clock11:"1F55A",clock1130:"1F566",new_moon:"1F311",waxing_crescent_moon:"1F312",first_quarter_moon:"1F313",moon:"1F314",full_moon:"1F315",waning_gibbous_moon:"1F316",last_quarter_moon:"1F317",waning_crescent_moon:"1F318",crescent_moon:"1F319",new_moon_with_face:"1F31A",first_quarter_moon_with_face:"1F31B",last_quarter_moon_with_face:"1F31C",full_moon_with_face:"1F31D",sun_with_face:"1F31E",ringed_planet:"1FA90",star:"2B50",star2:"1F31F",stars:"1F320",milky_way:"1F30C",partly_sunny:"26C5",cyclone:"1F300",rainbow:"1F308",closed_umbrella:"1F302",umbrella_with_rain_drops:"2614",zap:"26A1",snowman_without_snow:"26C4",fire:"1F525",droplet:"1F4A7",ocean:"1F30A",jack_o_lantern:"1F383",christmas_tree:"1F384",fireworks:"1F386",sparkler:"1F387",firecracker:"1F9E8",sparkles:"2728",balloon:"1F388",tada:"1F389",confetti_ball:"1F38A",tanabata_tree:"1F38B",bamboo:"1F38D",dolls:"1F38E",flags:"1F38F",wind_chime:"1F390",rice_scene:"1F391",red_envelope:"1F9E7",ribbon:"1F380",gift:"1F381",ticket:"1F3AB",trophy:"1F3C6",sports_medal:"1F3C5",first_place_medal:"1F947",second_place_medal:"1F948",third_place_medal:"1F949",soccer:"26BD",baseball:"26BE",softball:"1F94E",basketball:"1F3C0",volleyball:"1F3D0",football:"1F3C8",rugby_football:"1F3C9",tennis:"1F3BE",flying_disc:"1F94F",bowling:"1F3B3",cricket_bat_and_ball:"1F3CF",field_hockey_stick_and_ball:"1F3D1",ice_hockey_stick_and_puck:"1F3D2",lacrosse:"1F94D",table_tennis_paddle_and_ball:"1F3D3",badminton_racquet_and_shuttlecock:"1F3F8",boxing_glove:"1F94A",martial_arts_uniform:"1F94B",goal_net:"1F945",golf:"26F3",fishing_pole_and_fish:"1F3A3",diving_mask:"1F93F",running_shirt_with_sash:"1F3BD",ski:"1F3BF",sled:"1F6F7",curling_stone:"1F94C",dart:"1F3AF","yo-yo":"1FA80",kite:"1FA81","8ball":"1F3B1",crystal_ball:"1F52E",nazar_amulet:"1F9FF",video_game:"1F3AE",slot_machine:"1F3B0",game_die:"1F3B2",jigsaw:"1F9E9",teddy_bear:"1F9F8",black_joker:"1F0CF",mahjong:"1F004",flower_playing_cards:"1F3B4",performing_arts:"1F3AD",art:"1F3A8",thread:"1F9F5",yarn:"1F9F6",atm:"1F3E7",put_litter_in_its_place:"1F6AE",potable_water:"1F6B0",wheelchair:"267F",mens:"1F6B9",womens:"1F6BA",restroom:"1F6BB",baby_symbol:"1F6BC",wc:"1F6BE",passport_control:"1F6C2",customs:"1F6C3",baggage_claim:"1F6C4",left_luggage:"1F6C5",children_crossing:"1F6B8",no_entry:"26D4",no_entry_sign:"1F6AB",no_bicycles:"1F6B3",no_smoking:"1F6AD",do_not_litter:"1F6AF","non-potable_water":"1F6B1",no_pedestrians:"1F6B7",no_mobile_phones:"1F4F5",underage:"1F51E",arrows_clockwise:"1F503",arrows_counterclockwise:"1F504",back:"1F519",end:"1F51A",on:"1F51B",soon:"1F51C",top:"1F51D",place_of_worship:"1F6D0",menorah_with_nine_branches:"1F54E",six_pointed_star:"1F52F",aries:"2648",taurus:"2649",gemini:"264A",cancer:"264B",leo:"264C",virgo:"264D",libra:"264E",scorpius:"264F",sagittarius:"2650",capricorn:"2651",aquarius:"2652",pisces:"2653",ophiuchus:"26CE",twisted_rightwards_arrows:"1F500",repeat:"1F501",repeat_one:"1F502",fast_forward:"23E9",rewind:"23EA",arrow_up_small:"1F53C",arrow_double_up:"23EB",arrow_down_small:"1F53D",arrow_double_down:"23EC",cinema:"1F3A6",low_brightness:"1F505",high_brightness:"1F506",signal_strength:"1F4F6",vibration_mode:"1F4F3",mobile_phone_off:"1F4F4",trident:"1F531",name_badge:"1F4DB",beginner:"1F530",o:"2B55",white_check_mark:"2705",x:"274C",negative_squared_cross_mark:"274E",heavy_plus_sign:"2795",heavy_minus_sign:"2796",heavy_division_sign:"2797",curly_loop:"27B0",loop:"27BF",question:"2753",grey_question:"2754",grey_exclamation:"2755",exclamation:"2757",keycap_ten:"1F51F",capital_abcd:"1F520",abcd:"1F521",symbols:"1F523",abc:"1F524",ab:"1F18E",cl:"1F191",cool:"1F192",free:"1F193",id:"1F194",new:"1F195",ng:"1F196",ok:"1F197",sos:"1F198",up:"1F199",vs:"1F19A",koko:"1F201",u6709:"1F236",u6307:"1F22F",ideograph_advantage:"1F250",u5272:"1F239",u7121:"1F21A",u7981:"1F232",accept:"1F251",u7533:"1F238",u5408:"1F234",u7a7a:"1F233",u55b6:"1F23A",u6e80:"1F235",red_circle:"1F534",large_orange_circle:"1F7E0",large_yellow_circle:"1F7E1",large_green_circle:"1F7E2",large_blue_circle:"1F535",large_purple_circle:"1F7E3",large_brown_circle:"1F7E4",black_circle:"26AB",white_circle:"26AA",large_red_square:"1F7E5",large_orange_square:"1F7E7",large_yellow_square:"1F7E8",large_green_square:"1F7E9",large_blue_square:"1F7E6",large_purple_square:"1F7EA",large_brown_square:"1F7EB",black_large_square:"2B1B",white_large_square:"2B1C",black_medium_small_square:"25FE",white_medium_small_square:"25FD",large_orange_diamond:"1F536",large_blue_diamond:"1F537",small_orange_diamond:"1F538",small_blue_diamond:"1F539",small_red_triangle:"1F53A",small_red_triangle_down:"1F53B",diamond_shape_with_a_dot_inside:"1F4A0",radio_button:"1F518",white_square_button:"1F533",black_square_button:"1F532"},h_={":":{")":"1F642","(":"1F641",O:"1F62E",P:"1F61B",D:"1F604","*":"1F617","|":"1F610","#":"1F910",S:"1F616",$:"1F633","/":"1F615",".":"1F636",X:"1F922"},8:{")":"1F60E"},":&APOS;":{")":"1F602","(":"1F622",D:"1F923"},";":{")":"1F609",P:"1F61C"},X:{")":"1F606",D:"1F606",P:"1F61D"}};function xows_tpl_template_load(e,o){let _=xt.root+"/themes/"+m_+"/"+e+".html";xt.uncache&&(_+="?"+xows_gen_nonce_asc(4));const t=new XMLHttpRequest;t.open("GET",_,!0),t._isinst=o,t.onreadystatechange=function(){4===this.readyState&&(200===this.status?xows_tpl_template_parse(this.responseText,this.responseURL,this._isinst):xows_log(0,"tpl_template_load",'file "'+this.responseURL+'" loading error','HTTP status:"'+this.status+'"'))},d_++,xows_log(2,"tpl_template_load","loading file",_),t.send()}function xows_tpl_template_done(){for(;p_.childNodes.length>0;)document.body.appendChild(p_.firstChild);xows_log(2,"tpl_template_done","templates parsing completed"),p_=null,x_()}function xows_tpl_template_parse(e,o,_){xows_log(2,"tpl_template_parse","parsing template",o),e=xows_l10n_parse(e);const t=xows_clean_dom(u_.parseFromString(e,"text/html").body);if(!t)return void xows_log(0,"tpl_template_parse",'template "'+o+'" parse error');let s,n;const r=[],i=[];if(!_)for(s=(n=t.querySelectorAll("[has_template]")).length;s--;)r.push(n[s].getAttribute("id")),n[s].removeAttribute("has_template");for(s=(n=t.querySelectorAll("[is_instance]")).length;s--;)i.push(n[s].className),n[s].parentNode.removeChild(n[s]);let c=o.substring(o.lastIndexOf("/")+1).split(".")[0];if(_)w_[c]=document.createDocumentFragment(),w_[c].appendChild(t.firstChild);else{let e=p_.querySelector("#"+c);for(e||(e=p_);t.childNodes.length>0;)e.appendChild(t.firstChild);for(s=r.length;s--;)xows_tpl_template_load(r[s],!1)}for(s=i.length;s--;)xows_tpl_template_load(i[s],!0);0===--d_&&xows_tpl_template_done()}function xows_tpl_init(e){e&&(x_=e),xt.root&&(xt.root=xt.root),xt.theme&&(m_=xt.theme);const o=document.createElement("link");o.rel="stylesheet",o.type="text/css";o.href=xt.root+"/themes/"+m_+"/style.css",xt.uncache&&(o.href+="?"+xows_gen_nonce_asc(4)),document.head.appendChild(o),d_=0,p_=document.createDocumentFragment(),xows_tpl_template_load("body")}function xows_tpl_embed_wrap(e,o,_,t){let s='<aside class="';return _&&(s+=_),s+='" onclick="xows_doc_view_open(this.firstChild)">',t&&(s+='<a href="'+e+'" target="_blank">'+t+"</a>"),s+=o.replace(/src=/g,"lazy_src="),s+="</aside>"}function xows_tpl_embed_image(e,o){return xows_tpl_embed_wrap(e,'<img src="'+e+'" '+("GIF"===o?"NOLOADER":"")+">","EMBD-IMG")}function xows_tpl_embed_movie(e,o){return xows_tpl_embed_wrap(e,'<video controls src="'+e+'" NOLOADER></video>',"EMBD-VID")}function xows_tpl_embed_audio(e,o){return xows_tpl_embed_wrap(e,'<audio controls src="'+e+'" NOLOADER/>',"EMBD-SND")}function xows_tpl_embed_youtube(e,o){let _=e.match(/(v=|embed\/|youtu\.be\/)(.+)/)[2];return xows_tpl_embed_wrap(e,'<iframe src="https://www.youtube.com/embed/'+(_=_.replace(/t=/,"start="))+'"/>',"EMBD-STR","YouTube")}function xows_tpl_embed_dailymo(e,o){return xows_tpl_embed_wrap(e,'<iframe src="https://www.dailymotion.com/embed/video/'+e.match(/(video|dai\.ly)\/([\w\d]+)/)[2]+'"/>',"EMBD-STR","Dailymotion")}function xows_tpl_embed_vimeo(e,o){return xows_tpl_embed_wrap(e,'<iframe src="https://player.vimeo.com/video/'+e.match(/\/([\d]+)/)[1]+'"></iframe>',"EMBD-STR","Vimeo")}function xows_tpl_embed_odysee(e,o){return xows_tpl_embed_wrap(e,'<iframe src="https://odysee.com/$/embed/'+e.match(/.com\/(.*)/)[1]+'"></iframe>',"EMBD-STR","Odysee")}function xows_tpl_embed_upld(e,o){return xows_tpl_embed_wrap(e,'<a class="dnld-btn" href="'+e+'" target="_blank"></a>',"EMBD-DNL",decodeURI(e.match(/(.+\/)*(.+\..+)/)[2]))}let f_={JPG:xows_tpl_embed_image,JPEG:xows_tpl_embed_image,GIF:xows_tpl_embed_image,PNG:xows_tpl_embed_image,WEBP:xows_tpl_embed_image,SVG:xows_tpl_embed_image,MP4:xows_tpl_embed_movie,MPEG:xows_tpl_embed_movie,AVI:xows_tpl_embed_movie,MP3:xows_tpl_embed_audio,OGG:xows_tpl_embed_audio},b_={"www.youtube.com":xows_tpl_embed_youtube,"youtu.be":xows_tpl_embed_youtube,"www.dailymotion.com":xows_tpl_embed_dailymo,"dai.ly":xows_tpl_embed_dailymo,"vimeo.com":xows_tpl_embed_vimeo},F_={};function xows_tpl_embed_add_site(e,o){b_[e]=o}function xows_tpl_embed_add_file(e,o){f_[e]=o}function xows_tpl_embed_add_upld(e){F_[e]=xows_tpl_embed_upld}function xows_tpl_replace_emoj_sc(e,o){const _=g_[o];return _?"<emoj>&#x"+_+";</emoj>":e}function xows_tpl_replace_emoj_cp(e,o){return"<emoj>"+o+"</emoj>"}function xows_tpl_replace_emots(e,o,_,t){const s=h_[_.toUpperCase()][t.toUpperCase()];return s?"<emoj>&#x"+s+";</emoj>":e}let v_=null;function xows_tpl_replace_url(e){v_&&v_.push(e);const o=e.match(/\/\/(.*?[\w\d-_]+\.\w+)\//);return o&&F_[o[1].toLowerCase()]?"":'<a href="'+e+'" title="'+e+'" target="_blank">'+e+"</a>"}function xows_tpl_format_body(e,o){return e=(e=(e=(e=xows_html_escape(e)).replace(/([\u{2300}-\u{2BFF}]|[\u{1F000}-\u{1FB00}])/gu,xows_tpl_replace_emoj_cp)).replace(/:([\w-+-_]*):/g,xows_tpl_replace_emoj_sc)).replace(/(\s|^)([Xx8:;]|:&apos;)-?([()|DpPxXoO#$.\/*sS])/g,xows_tpl_replace_emots),v_=o,e.replace(/(http|https|ftp|ftps):\/\/(\S*)/g,xows_tpl_replace_url)}function xows_tpl_format_embed(e){let o,_,t,s,n="";for(let r=0,i=e.length;r<i;++r)s=null,(o=(t=e[r]).match(/\.([\w\d]+)(\?|$)/))&&(_=o[1].toUpperCase(),f_[_]&&(s=f_[_](t,_))),s||(o=t.match(/\/\/(.*?[\w\d\-_]+\.\w+)\//))&&(_=o[1].toLowerCase(),b_[_]&&(s=b_[_](t,_)),F_[_]&&(s=F_[_](t,_))),s&&(n+=s);return n}let y_={};function xows_tpl_spawn_avat_cls(e){if(e&&!(e in y_)){const o=".h-"+e+' {background-image:url("'+xows_cach_avat_get(e)+'");}\r\n';y_[e]=o;const _=document.createElement("style");_.type="text/css",_.innerText=o,document.head.appendChild(_)}}function xows_tpl_spawn_rost_cont(e,o,_,t,s,n){const r=w_["ROST-CONT"].firstChild.cloneNode(!0);r.title=e,r.querySelector("H3").innerText=o,r.querySelector("P").innerText=n||"";const i=r.querySelector(".PEER-SHOW"),c=r.querySelector(".PEER-SUBS"),a=r.querySelector("FIGURE");return t<ke?(r.classList.add("PEER-DENY"),i.classList.add("HIDDEN"),c.classList.remove("HIDDEN")):(i.setAttribute("show",null!==s?s:-1),xows_tpl_spawn_avat_cls(_),a.className="h-"+_),r}function xows_tpl_update_rost_cont(e,o,_,t,s,n){e.querySelector("H3").innerText=o,e.querySelector("P").innerText=n||"";const r=e.querySelector(".PEER-SHOW"),i=e.querySelector(".PEER-SUBS"),c=e.querySelector("FIGURE");t<ke?(e.classList.add("PEER-DENY"),r.classList.add("HIDDEN"),i.classList.remove("HIDDEN")):(e.classList.remove("PEER-DENY"),r.classList.remove("HIDDEN"),r.setAttribute("show",null!==s?s:-1),i.classList.add("HIDDEN"),xows_tpl_spawn_avat_cls(_),c.className="h-"+_)}function xows_tpl_spawn_room_occu(e,o,_,t,s,n){const r=w_["ROOM-OCCU"].firstChild.cloneNode(!0);return r.title=e,t&&r.setAttribute("jid",t),r.querySelector("H3").innerText=o,r.querySelector("P").innerText=n||"",r.querySelector(".PEER-SHOW").setAttribute("show",null!==s?s:-1),r.querySelector(".OCCU-SUBS").disabled=!(t&&t.length),xows_tpl_spawn_avat_cls(_),r.querySelector("FIGURE").className="h-"+_,r}function xows_tpl_update_room_occu(e,o,_,t,s,n){e.setAttribute("jid",t),e.querySelector("H3").innerText=o,e.querySelector("P").innerText=n||"",e.querySelector(".PEER-SHOW").setAttribute("show",null!==s?s:-1),e.querySelector(".OCCU-SUBS").disabled=!(t&&t.length),xows_tpl_spawn_avat_cls(_),e.querySelector("FIGURE").className="h-"+_}function xows_tpl_spawn_rost_room(e,o,_,t){const s=w_["ROST-ROOM"].firstChild.cloneNode(!0);return s.title=e,s.querySelector("H3").innerText=o,s.querySelector("P").innerText=_,s}function xows_tpl_update_rost_room(e,o,_,t){e.querySelector("H3").innerText=o,e.querySelector("P").innerText=_}function xows_tpl_spawn_rost_subs(e,o){const _=w_["ROST-SUBS"].firstChild.cloneNode(!0);return _.title=e,o&&_.setAttribute("name",o),_.querySelector("H3").innerText=o||e,_}function xows_tpl_mesg_spawn(e,o,_,t,s,n,r){const i=w_[r?"MESG-FULL":"MESG-AGGR"].firstChild.cloneNode(!0);i.classList.add(s?"MESG-SENT":"MESG-RECV"),n&&i.classList.add("MESG-RECP"),i.setAttribute("id",e),i.setAttribute("from",o),i.setAttribute("time",t);const c=[];return i.querySelector("P").innerHTML=xows_tpl_format_body(_,c),c.length&&(i.querySelector("FOOTER").innerHTML=xows_tpl_format_embed(c)),r?(i.querySelector(".MESG-DATE").innerText=xows_l10n_date(t),i.querySelector(".MESG-FROM").innerText=r.name,xows_tpl_spawn_avat_cls(r.avat),i.querySelector("FIGURE").className="h-"+r.avat):i.querySelector(".MESG-HOUR").innerText=xows_l10n_houre(t),i}const k_={},A_={};let q_={top:99999,off:0},C_=null,E_="";const D_=[],S_=document.getSelection(),T_=document.createRange();function xows_doc_cache(e){k_[e]=document.getElementById(e)}function xows_doc_listener_add(e,o,_,t=!0,s=!1){e.addEventListener(o,_,{capture:s,passive:t})}function xows_doc_listener_rem(e,o,_,t=!0,s=!1){e.removeEventListener(o,_,{capture:s,passive:t})}function xows_doc_listener_add_select(e,o,_,t,s=!0){const n=e.querySelectorAll(o);let r=n.length;for(;r--;)n[r].addEventListener(_,t,{capture:!1,passive:s})}function xows_doc_listener_rem_select(e,o,_,t,s=!0){const n=e.querySelectorAll(o);let r=n.length;for(;r--;)n[r].removeEventListener(_,t,{capture:!1,passive:s})}function xows_doc_cls_has(e,o){return k_[e].classList.contains(o)}function xows_doc_cls_tog(e,o){return k_[e].classList.toggle(o)}function xows_doc_cls_add(e,o){k_[e].classList.add(o)}function xows_doc_cls_rem(e,o){k_[e].classList.remove(o)}function xows_doc_cls_set(e,o,_){_?k_[e].classList.add(o):k_[e].classList.remove(o)}function xows_doc_show(e){k_[e].classList.remove("HIDDEN")}function xows_doc_hide(e){k_[e].classList.add("HIDDEN")}function xows_doc_hidden_set(e,o){o?k_[e].classList.add("HIDDEN"):k_[e].classList.remove("HIDDEN")}function xows_doc_hidden(e){return k_[e].classList.contains("HIDDEN")}function xows_doc_frag_backup(e,o){for(A_[e]||(A_[e]={}),A_[e][o]=document.createDocumentFragment();k_[o].childNodes.length;)A_[e][o].appendChild(k_[o].firstChild)}function xows_doc_frag_copy(e,o,_){let t,s,n,r=!1;if(o?A_[o]&&A_[o][_]&&(t=A_[o][_]):t=k_[_],e?(A_[e]||(A_[e]={}),A_[e][_]=document.createDocumentFragment(),s=A_[e][_]):((s=k_[_]).innerHTML="",r=!0),t&&s!==t)for(let e=0,o=t.childNodes.length;e<o;++e)n=t.childNodes[e].cloneNode(!0),s.appendChild(n),r&&n.id&&(k_[n.id]=n)}function xows_doc_frag_restore(e,o){if(A_[e]){let _;for(k_[o].innerHTML="";A_[e][o].childNodes.length;)_=A_[e][o].firstChild,k_[o].appendChild(_),_.id&&(k_[_.id]=_)}}function xows_doc_frag(e,o){return A_[e]?A_[e][o]:null}function xows_doc_frag_element(e,o){let _;for(const t in A_[e])if(_=A_[e][t].getElementById(o))return _;return null}function xows_doc_frag_selector(e,o){let _;for(const t in A_[e])if(_=A_[e][t].querySelector(o))return _;return null}function xows_doc_get_child(e,o){let _=e.childNodes.length;for(;_--;)if(e.childNodes[_].id===o)return e.childNodes[_];return null}function xows_doc_caret_around(e,o=!1){S_.removeAllRanges(),T_.setStartBefore(e),T_.setEndAfter(e),T_.collapse(o),S_.addRange(T_)}function xows_doc_caret_at(e,o=!1){S_.removeAllRanges(),T_.selectNodeContents(e),T_.collapse(o),S_.addRange(T_)}function xows_doc_sel_rng(e){return S_.getRangeAt(e)}function xows_doc_list_clean(e){const o=k_[e].querySelectorAll("LI");let _=o.length;for(;_--;)o[_].parentNode.removeChild(o[_])}function xows_doc_init(e){const o=document.querySelectorAll("[id]");let _=o.length;for(;_--;)xows_doc_cache(o[_].id);xows_doc_listener_add(k_.main_tabs,"click",xows_gui_rost_widen),xows_doc_listener_add(k_.main_hndr,"click",xows_gui_main_open),xows_doc_listener_add(k_.main_hndl,"click",xows_gui_main_open),xows_doc_listener_add(k_.rost_tabs,"click",xows_gui_rost_tabs_onclick),xows_doc_listener_add(k_.cont_list,"click",xows_gui_rost_list_onclick),xows_doc_listener_add(k_.room_list,"click",xows_gui_rost_list_onclick),xows_doc_listener_add(k_.cont_add,"click",xows_gui_page_cont_open),xows_doc_listener_add(k_.room_add,"click",xows_gui_room_add_onclick),xows_doc_listener_add(k_.room_upd,"click",xows_gui_room_list_reload),xows_doc_listener_add(k_.occu_list,"click",xows_gui_occu_list_onclick),xows_doc_listener_add(k_.menu_show,"click",xows_gui_menu_show_onclick),xows_doc_listener_add(k_.drop_show,"click",xows_gui_menu_show_onclick),xows_doc_listener_add(k_.menu_user,"click",xows_gui_page_user_open),xows_doc_listener_add(k_.user_stat,"keypress",xows_gui_user_stat_onkeyp),xows_doc_listener_add(k_.user_stat,"blur",xows_gui_user_stat_onblur),xows_doc_listener_add(k_.send_edit,"keydown",xows_gui_send_edit_onkeyp,!1),xows_doc_listener_add(k_.send_edit,"keyup",xows_gui_send_edit_onkeyp),xows_doc_listener_add(k_.send_edit,"input",xows_gui_send_edit_oninput),xows_doc_listener_add(k_.send_edit,"click",xows_gui_send_edit_onclick),xows_doc_listener_add(k_.chat_main,"scroll",xows_gui_chat_main_onscroll),xows_doc_listener_add(k_.chat_main,"click",xows_gui_chat_main_onclick),xows_doc_listener_add(k_.chat_file,"change",xows_gui_chat_file_onchange),xows_doc_listener_add(k_.chat_upld,"click",xows_gui_chat_upld_onclick),xows_doc_listener_add(k_.menu_emoj,"click",xows_gui_menu_emoj_onclick),xows_doc_listener_add(k_.chat_meta,"keypress",xows_gui_chat_meta_onkeyp),xows_doc_listener_add(k_.chat_meta,"blur",xows_gui_chat_meta_onblur),xows_doc_listener_add(k_.chat_noti,"click",xows_gui_chat_noti_onclick),xows_doc_listener_add(k_.chat_conf,"click",xows_gui_chat_conf_onclick),xows_doc_listener_add(k_.chat_occu,"click",xows_gui_chat_occu_onclick),xows_doc_listener_add(k_.chat_book,"click",xows_gui_chat_book_onclick),xows_doc_listener_add(k_.scr_page,"keyup",xows_doc_page_onkeyu),xows_doc_listener_add(k_.page_exit,"click",xows_doc_page_onclose),xows_doc_listener_add(k_.upld_exit,"click",xows_gui_upld_onclose),xt.allow_register&&xows_doc_show("auth_regi"),xows_doc_listener_add(k_.scr_void,"click",xows_doc_void_onclick),xows_doc_listener_add(k_.mbox_close,"click",xows_doc_mbox_close),xows_doc_listener_add(k_.mbox_abort,"click",xows_doc_mbox_onabort),xows_doc_listener_add(k_.mbox_valid,"click",xows_doc_mbox_onvalid),xows_doc_listener_add(document,"visibilitychange",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"focus",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"blur",xows_gui_wnd_onfocus),xows_doc_listener_add(window,"beforeunload",xows_gui_wnd_onunload),xows_doc_listener_add(window,"popstate",xows_gui_nav_onpopstate),W_=new Audio("/"+xt.root+"/sounds/notify.mp3?456"),xows_doc_frag_copy("empty",null,"chat_hist"),xows_doc_frag_copy("empty",null,"occu_list"),xows_log(2,"gui_start","document ready"),xows_isfunc(e)&&e()}function xows_doc_loader_clear(){D_.length=0,q_.top=99999,xows_log(2,"doc_loader_clear","loader stack cleared")}function xows_doc_loader_setup(e,o){E_=o,xows_log(2,"doc_loader_setup","now search elements with attribute",o),C_!==e&&(C_&&(xows_doc_listener_rem(C_,"scroll",xows_doc_loader_check),xows_log(2,"doc_loader_setup","removing scroll listener from element","<"+C_.tagName+' id="'+C_.getAttribute("id")+'">')),(C_=e)&&(xows_doc_listener_add(C_,"scroll",xows_doc_loader_check),xows_log(2,"doc_loader_setup","adding scroll listener to element","<"+e.tagName+' id="'+e.getAttribute("id")+'">'))),q_.top=99999}function xows_doc_loader_monitor(e){const o=Array.from(e.querySelectorAll("["+E_+"]"));if(o.length){xows_log(2,"doc_loader_monitor","adding to monitoring stack",o.length+" new element(s)");let e=o.length;for(;e--;)D_.push(o[e])}}function xows_doc_loader_onload(e){e.parentNode.classList.remove("LOADING"),e.classList.remove("FLATTEN"),C_.scrollTop=C_.scrollHeight-q_.off}function xows_doc_loader_check(e){if(!D_.length)return;if(!e&&Math.abs(C_.scrollTop-q_.top)<120)return;q_.top=C_.scrollTop,q_.off=C_.scrollHeight-q_.top;const o=C_.getBoundingClientRect();let _,t,s=D_.length;for(;s--;)(_=(t=D_[s]).getBoundingClientRect()).bottom>o.top&&_.top<=o.bottom&&(t.hasAttribute("NOLOADER")||(t.classList.add("FLATTEN"),t.parentNode.classList.add("LOADING"),t.onload=function(){xows_doc_loader_onload(this)}),t.src=t.getAttribute(E_),t.removeAttribute(E_),D_.splice(s,1),xows_log(2,"doc_loader_check","loading",t.src))}function xows_doc_blink(e,o){xows_doc_cls_has(e,"BLINK")?xows_doc_cls_rem(e,"BLINK"):(xows_doc_cls_add(e,"BLINK"),setTimeout(xows_doc_blink,o,e))}let N_=null,j_=null;function xows_doc_mbox_onabort(e){N_&&(N_(),xows_doc_mbox_close())}function xows_doc_mbox_onvalid(e){j_&&(j_(),xows_doc_mbox_close())}const B_=-1,L_=0,P_=1,I_=2;function xows_doc_mbox_open(e,o,_,t,s,n,r){if(xows_doc_mbox_modal())return;let i;switch(xows_doc_mbox_close(),e){case B_:i="TEXT-ERR";break;case L_:i="TEXT-WRN";break;case P_:i="TEXT-SCS";break;case I_:i="TEXT-ASK"}k_.mbox_text.classList=i,k_.mbox_text.innerHTML=xows_l10n_get(o),xows_doc_hidden_set("mbox_close",_||s),xows_doc_hidden_set("mbox_valid",!_),xows_doc_hidden_set("mbox_abort",!s),_&&(k_.mbox_valid.innerHTML=xows_l10n_get(t)),s&&(k_.mbox_abort.innerHTML=xows_l10n_get(n)),N_=s,j_=_,r&&xows_doc_show("scr_void"),xows_doc_show("over_mbox")}function xows_doc_mbox_open_for_save(e,o){xows_doc_hidden("over_mbox")&&xows_doc_mbox_open(null,"It remains unsaved changes",e,"Save changes",o,"Reset")}function xows_doc_mbox_close(){N_=null,j_=null,xows_doc_hide("over_mbox"),xows_doc_hide("scr_void")}function xows_doc_mbox_modal(){return!(xows_doc_hidden("over_mbox")||!N_)&&(xows_doc_blink("over_mbox",400),!0)}let O_=null,R_=null,H_=null,U_=null;function xows_doc_page_oninput(e){H_(e.target)}function xows_doc_page_onclick(e){U_(e.target)}function xows_doc_page_onclose(e){xows_doc_mbox_modal()||xows_doc_page_close()}function xows_doc_page_close(e=!1){O_&&(xows_log(2,"gui_page_close",(e?"soft":"hard")+" close",O_),H_&&(xows_doc_listener_rem(k_[O_],"input",xows_doc_page_oninput),H_=null),U_&&(xows_doc_listener_rem(k_[O_],"click",xows_doc_page_onclick),U_=null),R_&&R_(),R_=null,xows_doc_hide("colr_exit"),xows_doc_hide(O_),O_=null,xows_doc_mbox_close(),e||xows_gui_main_open())}function xows_doc_page_open(e,o,_,t,s){xows_cli_activity_wakeup();let n=null!==O_;n&&xows_doc_page_close(!0),xows_log(2,"gui_dlg_open",e),n||(xows_doc_hide("scr_main"),xows_doc_show("scr_page")),xows_doc_show(e),O_=e,o&&xows_doc_show("colr_exit"),R_=_,t&&(H_=t,xows_doc_listener_add(k_[e],"input",xows_doc_page_oninput)),s&&(U_=s,xows_doc_listener_add(k_[e],"click",xows_doc_page_onclick)),xows_doc_mbox_close()}function xows_doc_page_onkeyu(e){if(O_&&13===e.keyCode)if(xows_doc_hidden("over_mbox")||xows_doc_hidden("mbox_valid")){const e=k_[O_].querySelector("*[type='submit']");e&&e.click()}else k_.mbox_valid.click()}function xows_doc_page_opened(e){return O_==e}const M_={};function xows_doc_menu_close(){xows_doc_hide("scr_void"),xows_doc_hide(M_.drop),M_.btn.blur(),M_.btn=null,M_.drop=null}function xows_doc_menu_toggle(e,o){M_.btn?xows_doc_menu_close():(xows_doc_show("scr_void"),xows_doc_show(o),e.focus(),M_.btn=e,M_.drop=o)}function xows_doc_view_close(){xows_doc_hidden("over_view")||(xows_doc_hide("over_view"),xows_doc_cls_rem("scr_void","VOID-DARK"),xows_doc_hide("scr_void"))}function xows_doc_view_open(e){"IMG"===e.tagName&&(k_.view_img.src=e.src,k_.view_open.href=e.src,xows_doc_show("over_view"),xows_doc_cls_add("scr_void","VOID-DARK"),xows_doc_show("scr_void"))}function xows_doc_void_onclick(e){M_.btn&&xows_doc_menu_close(),xows_doc_view_close(),xows_doc_mbox_modal()}const G_=6e5,z_=55;let J_="en-US",X_=null,V_=null,W_=null,K_=!0,Y_=!0;function xows_gui_peer_element(e,o){return e===V_?k_[o]?k_[o]:document.getElementById(o):xows_doc_frag_element(e.bare,o)}function xows_gui_peer_selector(e,o){return e===V_?document.querySelector(o):xows_doc_frag_selector(e.bare,o)}const $_={};function xows_gui_peer_scroll_backup(e){e.bare in $_||($_[e.bare]={}),$_[e.bare]={scrollTop:k_.chat_main.scrollTop,scrollHeight:k_.chat_main.scrollHeight,clientHeight:k_.chat_main.clientHeight}}function xows_gui_peer_scroll_restore(e){e.bare in $_&&(k_.chat_main.scrollTop=$_[e.bare].scrollTop)}function xows_gui_peer_scroll_top(e){return e!==V_?$_[e.bare].scrollTop:k_.chat_main.scrollTop}function xows_gui_peer_scroll_bot(e){const o=e!==V_?$_[e.bare]:k_.chat_main;return o.scrollHeight-o.scrollTop-o.clientHeight}function xows_gui_peer_scroll_off(e){const o=e!==V_?$_[e.bare]:k_.chat_main;return o.scrollHeight-o.scrollTop}function xows_gui_peer_scroll_down(e){const o=e!==V_?$_[e.bare]:k_.chat_main;o.scrollTop=o.scrollHeight}function xows_gui_peer_scroll_seek(e,o){const _=e!==V_?$_[e.bare]:k_.chat_main;_.scrollTop=_.scrollHeight-o}function xows_gui_find_rost_li(e){let o;return(o=k_.cont_list.querySelector("LI[title='"+e.bare+"']"))?o:(o=k_.room_list.querySelector("LI[title='"+e.bare+"']"))?o:null}function xows_gui_find_occu_li(e,o){return(e===V_?k_.occu_list:xows_doc_frag(e.bare,"occu_list")).querySelector("LI[title='"+o+"']")}function xows_gui_connect(e=!1){xows_doc_mbox_close(),xt.domain&&(X_.user+="@"+xt.domain),xows_cli_set_callback("connect",xows_gui_cli_onconnect),xows_cli_set_callback("selfchange",xows_gui_cli_onselfchange),xows_cli_set_callback("contpush",xows_gui_cli_oncontpush),xows_cli_set_callback("contrem",xows_gui_cli_oncontrem),xows_cli_set_callback("subspush",xows_gui_cli_onsubspush),xows_cli_set_callback("subsrem",xows_gui_cli_onsubsrem),xows_cli_set_callback("roompush",xows_gui_cli_onroompush),xows_cli_set_callback("roomrem",xows_gui_cli_onroomrem),xows_cli_set_callback("occupush",xows_gui_cli_onoccupush),xows_cli_set_callback("occurem",xows_gui_cli_onoccurem),xows_cli_set_callback("message",xows_gui_cli_onmessage),xows_cli_set_callback("chatstate",xows_gui_cli_onchatstate),xows_cli_set_callback("receipt",xows_gui_cli_onreceipt),xows_cli_set_callback("subject",xows_gui_cli_onsubject),xows_cli_set_callback("error",xows_gui_cli_onerror),xows_cli_set_callback("close",xows_gui_cli_onclose),Y_=!1,xows_cli_connect(xt.url,X_.user,X_.pass,e)}function xows_gui_cli_onconnect(e){if(X_.cred&&(xows_log(2,"gui_loggedin","Saving credential"),window.PasswordCredential)){const e={id:X_.user,password:X_.pass},o=new PasswordCredential(e);navigator.credentials.store(o)}X_=null,xows_gui_main_open(),xows_gui_rost_widen(),V_=null,xows_doc_loader_setup(k_.chat_main,"lazy_src"),xows_cli_svc_exist(X)&&(k_.chat_upld.disabled=!1,xows_tpl_embed_add_upld(Eo[X])),xows_cli_svc_exist(ne)&&(k_.tab_room.disabled=!1),xows_gui_room_list_reload()}function xows_gui_disconnect(){xows_log(2,"gui_disconnect","prepare to disconnect"),V_&&xows_cli_chatstate_set(V_,Ce),xows_cli_disconnect()}function xows_gui_cli_onclose(e,o){Y_||(xows_gui_reset(),xows_gui_page_auth_open()),o&&xows_doc_mbox_open(e,o)}function xows_gui_cli_onerror(e,o){xows_doc_mbox_open(e,o)}const Q_=[];let Z_=!1,et=0;function xows_gui_nav_push(e,o,..._){if(Z_||!xows_cli_connected())return;et<Q_.length&&Q_.splice(et+1);const t=Q_.length;history.pushState({pos:t,page:e},"",window.location.pathname+"#"+e),Q_.push({func:o,args:[..._]}),et++}function xows_gui_nav_onpopstate(e){if(e.state){const o=e.state.pos,_=Q_[o];if(_&&_.func)return Z_=!0,_.func(..._.args),Z_=!1,void(et=o)}xows_cli_connected()&&!xows_doc_mbox_modal()&&(history.forward(),xows_gui_mbox_exit_open())}function xows_gui_wnd_onfocus(){const e=K_;(K_=document.hasFocus())&&!e&&xows_cli_activity_wakeup()}function xows_gui_wnd_onunload(e){xows_log(2,"gui_evt_unload","Unload event from browser"),xows_gui_disconnect()}let ot=0,_t=null;function xows_gui_notify_allow(e){V_&&(V_.noti=e,e?(k_.chat_noti.title=xows_l10n_get("Disable notifications"),ot="granted"):(k_.chat_noti.title=xows_l10n_get("Enable notifications"),ot=0),xows_doc_cls_set("chat_noti","CHAT-MUTE",e),xows_doc_cls_set("chat_noti","CHAT-NOTI",!e))}function xows_gui_notify_query_handle(e){V_&&(ot=e,"granted"===e&&(xows_gui_notify_allow(!0),_t&&(xows_gui_notify_push(_t.title,_t.body,_t.avat),_t=null)))}function xows_gui_notify_query(){V_&&(ot=0,Notification.requestPermission().then(xows_gui_notify_query_handle))}function xows_gui_notify_push(e,o,_){switch(ot){case"denied":return;case"granted":{const t=xows_cach_avat_get(_);new Notification(e,{body:o,icon:t||"/"+xt.root+"/icon.svg"});W_.play()}break;default:_t={title:e,body:o,avat:_},xows_gui_notify_query()}}function xows_gui_reset(){xows_log(2,"gui_reset","reset DOM states"),xows_gui_switch_peer(null);const e=["scr_main","scr_void","page_cont","page_user","page_join","page_room","page_regi","page_auth","page_wait","drop_show","drop_emoj","chat_fram","chat_stat","hist_end","hist_new","room_list"];let o=e.length;for(;o--;)xows_doc_hide(e[o]);xows_doc_list_clean("cont_ul"),xows_doc_list_clean("book_ul"),xows_doc_list_clean("room_ul"),xows_doc_list_clean("modo_ul"),xows_doc_list_clean("memb_ul"),k_.hist_ul.innerText="",k_.hist_beg.innerText="",xows_doc_cls_add("tab_cont","TAB-ENABLED"),xows_doc_cls_rem("tab_room","TAB-ENABLED"),xows_doc_show("cont_list"),xows_doc_cls_rem("main_coll","COL-THIN"),xows_doc_cls_rem("main_coll","COL-WIDE"),xows_doc_cls_rem("main_coll","COL-HIDE"),xows_doc_cls_rem("main_colr","COL-THIN"),xows_doc_cls_rem("main_colr","COL-WIDE"),xows_doc_cls_add("main_colr","COL-HIDE");for(const e in A_)"empty"!==e&&delete A_[e];Y_=!0}function xows_gui_switch_peer(e){const o=V_;if(o){if(e===o.bare)return;xows_cli_chatstate_set(o,Ce),xows_gui_upld_onclose()}const _=e?xows_cli_peer_get(e):null;o&&(xows_gui_peer_scroll_backup(o),xows_doc_frag_backup(o.bare,"chat_hist"),xows_doc_frag_backup(o.bare,"occu_list"),_&&_.type===o.type&&xows_gui_find_rost_li(o).classList.remove("SELECTED")),null===_?xows_doc_hide("chat_fram"):xows_doc_show("chat_fram");let t=!1;_?(xows_gui_find_rost_li(_).classList.add("SELECTED"),xows_doc_frag_restore(_.bare,"chat_hist"),xows_doc_frag_restore(_.bare,"occu_list"),xows_gui_peer_scroll_restore(_),xows_doc_cls_set("main_colr","COL-HIDE",_.type!==yo),V_=_,_.type===yo&&(_.join||xows_cli_room_join(_)),xows_gui_unread_reset(_),xows_doc_loader_clear(),xows_doc_loader_monitor(k_.chat_main),xows_doc_loader_check(!0),k_.hist_ul.childNodes.length<40&&xows_gui_mam_query(!1,40,0),xows_gui_peer_scroll_bot(_)<50&&xows_gui_peer_scroll_down(_),xows_log(2,"gui_switch_peer",'peer "'+_.bare+'"',"selected"),t=!0):V_&&(xows_log(2,"gui_switch_peer","unselect peer"),V_=null,xows_doc_frag_copy(null,"empty","chat_hist"),xows_doc_frag_copy(null,"empty","occu_list"),xows_doc_cls_add("main_colr","COL-HIDE"),t=!0),xows_gui_writing_clear(),xows_gui_chat_fram_update(),t&&xows_gui_nav_push("switch_peer",xows_gui_switch_peer,e)}function xows_gui_panel_close(){xows_doc_cls_rem("main_wrap","COLR-WIDE"),xows_doc_cls_rem("main_wrap","COLL-WIDE")}function xows_gui_main_open(){xows_doc_hidden("scr_page")||(xows_doc_page_close(!0),xows_doc_hide("scr_page"),xows_doc_show("scr_main")),xows_gui_panel_close(),xows_gui_nav_push("main_open",xows_gui_main_open)}function xows_gui_room_privi_update(e){let o,_;if(V_&&!e){const e=V_.affi;o=V_.role>Le,_=e>Ue}xows_doc_hidden_set("chat_conf",!_),xows_doc_cls_set("chat_meta","ENABLED",o),k_.chat_meta.setAttribute("contenteditable",o),k_.chat_meta.title=o?xows_l10n_get("Change Room topic"):""}function xows_gui_mbox_exit_onabort(){}function xows_gui_mbox_exit_onvalid(){xows_gui_disconnect(),history.back()}function xows_gui_mbox_exit_open(){xows_doc_mbox_open(L_,"Do you really want to disconnect current session ?",xows_gui_mbox_exit_onvalid,"Yes",xows_gui_mbox_exit_onabort,"No",!0)}const tt={};function xows_gui_mbox_subs_edit_onabort(){tt.bare=null,tt.name=null}function xows_gui_mbox_subs_edit_onvalid(){xows_cli_rost_edit(tt.bare,tt.name),tt.bare=null,tt.name=null}function xows_gui_mbox_subs_edit_open(e,o){let _,t;tt.bare=e,o?(tt.name=o,t=I_,_="Add contact and request authorisation ?"):(t=L_,_="Remove contact and revoke authorization ?"),xows_doc_mbox_open(t,_,xows_gui_mbox_subs_edit_onvalid,"OK",xows_gui_mbox_subs_edit_onabort,"Cancel",!0)}const st={};function xows_gui_mbox_subs_auth_onabort(){xows_cli_subscribe_allow(st.bare,!1),st.bare=null,st.name=null}function xows_gui_mbox_subs_auth_onvalid(){xows_cli_subscribe_allow(st.bare,!0,st.name),st.bare=null,st.name=null}function xows_gui_mbox_subs_auth_open(e,o){st.bare=e,st.name=o,xows_doc_mbox_open(I_,"Allow contact subscription ?",xows_gui_mbox_subs_auth_onvalid,"Allow",xows_gui_mbox_subs_auth_onabort,"Deny",!0)}let nt=null;function xows_gui_mbox_bookmark_onabort(){nt=null}function xows_gui_mbox_bookmark_onvalid(){xows_cli_book_publish(nt),nt=null}function xows_gui_mbox_bookmark_open(e){nt=e,xows_doc_mbox_open(I_,"Add Room to bookmarks ?",xows_gui_mbox_bookmark_onvalid,"Add Bookmark",xows_gui_mbox_bookmark_onabort,"Cancel",!0)}function xows_gui_rost_widen(){xows_cli_activity_wakeup(),window.matchMedia("(max-width: 799px)").matches&&(xows_doc_cls_has("main_wrap","COLL-WIDE")||(xows_doc_cls_rem("main_wrap","COLR-WIDE"),xows_doc_cls_add("main_wrap","COLL-WIDE"),xows_gui_nav_push("panel_open",xows_gui_rost_widen)))}function xows_gui_rost_switch(e){let o,_=!1;const t="tab_room"===e;t&&!xows_doc_cls_has("tab_room","ENABLED")&&(_=!0,k_.rost_titl.innerText=xows_l10n_get("Chatrooms"),o=k_.room_list);const s="tab_cont"===e;if(s&&!xows_doc_cls_has("tab_cont","ENABLED")&&(_=!0,k_.rost_titl.innerText=xows_l10n_get("Contacts"),o=k_.cont_list),!_)return;let n;xows_doc_cls_set("tab_cont","ENABLED",s),xows_doc_hidden_set("cont_list",!s),xows_doc_hidden_set("cont_add",!s),xows_doc_cls_set("tab_room","ENABLED",t),xows_doc_hidden_set("room_list",!t),xows_doc_hidden_set("room_add",!t),xows_doc_hidden_set("room_upd",!t),o&&(n=o.querySelector(".SELECTED")),xows_gui_switch_peer(n?n.title:null)}function xows_gui_rost_tabs_onclick(e){xows_cli_activity_wakeup();const o=e.target.closest("button");o&&xows_gui_rost_switch(o.id)}function xows_gui_rost_list_onclick(e){xows_cli_activity_wakeup();const o=e.target.closest("li");if(o){if("BUTTON"===e.target.tagName)switch(e.target.name){case"CONT_ASK":return xows_cli_subscribe_request(o.title),void xows_doc_mbox_open(P_,"New authorization request was sent");case"CONT_REM":return void xows_gui_mbox_subs_edit_open(o.title)}switch(o.className){case"ROST-SUBS":return void xows_gui_mbox_subs_auth_open(o.title,o.name);default:xows_gui_switch_peer(o.title),xows_gui_panel_close()}}}function xows_gui_unread_add(e,o){const _=e.type===yo?k_.room_unrd:k_.cont_unrd;let t=parseInt(_.innerText)||0;_.innerText=t+1,_.classList.remove("HIDDEN");const s=xows_gui_find_rost_li(e);if(s){const e=s.querySelector(".UNRD-SPOT");t=parseInt(e.innerText)||0,e.innerText=t+1,e.classList.remove("HIDDEN")}}function xows_gui_unread_reset(e){const o=e.type===yo?k_.room_unrd:k_.cont_unrd;let _=parseInt(o.innerText)||0;const t=xows_gui_find_rost_li(e);if(t){const e=t.querySelector(".UNRD-SPOT");_-=parseInt(e.innerText)||0,e.innerText="",e.classList.add("HIDDEN")}o.innerText=_>0?_:"",_<=0&&o.classList.add("HIDDEN")}function xows_gui_cont_list_reload(){xows_gui_switch_peer(null),k_.cont_ul.innerText="",xows_doc_cls_add("cont_list","LOADING"),xows_cli_rost_get_query()}function xows_gui_cli_oncontpush(e){if(null===e)return void xows_doc_cls_rem("cont_list","LOADING");const o=k_.cont_ul.querySelector("li[title='"+e.bare+"'");o?(xows_tpl_update_rost_cont(o,e.name,e.avat,e.subs,e.show,e.stat),e===V_&&xows_gui_chat_fram_update()):(xows_doc_cls_rem("cont_ul","LOADING"),k_.cont_ul.appendChild(xows_tpl_spawn_rost_cont(e.bare,e.name,e.avat,e.subs,e.show,e.stat)),xows_doc_frag_copy(e.bare,"empty","chat_hist"),xows_gui_peer_scroll_backup(e),xows_doc_frag_copy(e.bare,"empty","occu_list")),xows_doc_hidden_set("cont_ul",k_.cont_ul.childNodes.length<2)}function xows_gui_cli_oncontrem(e){const o=k_.cont_ul.querySelector("li[title='"+e+"'");o&&o.parentNode.removeChild(o),xows_doc_hidden_set("cont_ul",k_.cont_ul.childNodes.length<2)}function xows_gui_cli_onsubspush(e,o){if(k_.subs_ul.querySelector("li[title='"+e+"'"))return;k_.subs_ul.appendChild(xows_tpl_spawn_rost_subs(e,o));const _=k_.subs_ul.childNodes.length-1;k_.subs_unrd.innerText=_,xows_doc_show("subs_unrd"),xows_doc_hidden_set("subs_ul",_<1)}function xows_gui_cli_onsubsrem(e){const o=k_.subs_ul.querySelector("li[title='"+e+"'");o&&o.parentNode.removeChild(o);const _=k_.subs_ul.childNodes.length-1;_?k_.subs_unrd.innerText=_:(k_.subs_unrd.innerText="",xows_doc_hide("subs_unrd")),xows_doc_hidden_set("subs_ul",_<1)}function xows_gui_room_list_reload(){V_&&V_.publ&&xows_gui_switch_peer(null),xows_doc_hide("room_ul"),xows_doc_list_clean("room_ul"),xows_doc_cls_add("room_list","LOADING"),setTimeout(xows_cli_muc_items_query,500)}function xows_gui_room_add_onclick(e){xows_cli_activity_wakeup(),xows_gui_page_join_open()}function xows_gui_cli_onroompush(e){if(!e)return void xows_doc_cls_rem("room_list","LOADING");let o;o=e.publ?k_.room_ul:e.book?k_.book_ul:k_.priv_ul;const _=k_.room_list.querySelector("li[title='"+e.bare+"']");_?(_.parentNode!==o&&o.appendChild(_),xows_tpl_update_rost_room(_,e.name,e.desc,e.lock),e===V_&&xows_gui_chat_fram_update()):(o.appendChild(xows_tpl_spawn_rost_room(e.bare,e.name,e.desc,e.lock)),xows_doc_frag_copy(e.bare,"empty","chat_hist"),xows_gui_peer_scroll_backup(e),xows_doc_frag_copy(e.bare,"empty","occu_list")),xows_doc_hidden_set("book_ul",k_.book_ul.childNodes.length<2),xows_doc_hidden_set("room_ul",k_.room_ul.childNodes.length<2),xows_doc_hidden_set("priv_ul",k_.priv_ul.childNodes.length<2)}function xows_gui_cli_onroomrem(e){const o=k_.room_list.querySelector("li[title='"+e+"'");o&&o.parentNode.removeChild(o)}function xows_gui_cli_onselfchange(e){k_.user_stat.value=e.stat?e.stat:"",k_.user_stat.blur(),k_.user_show.setAttribute("show",e.show),k_.user_name.innerText=e.name,k_.user_addr.innerText="("+e.bare+")",xows_tpl_spawn_avat_cls(e.avat),k_.user_avat.className="h-"+e.avat}function xows_gui_menu_show_onclick(e){const o=e.target.closest("li");if(o){const e=parseInt(o.getAttribute("name"));if(!(e>=0))return k_.auth_user.value="",k_.auth_pass.value="",navigator.credentials&&navigator.credentials.preventSilentAccess(),void xows_gui_disconnect();xows_cli_change_presence(e)}xows_doc_menu_toggle(k_.menu_show,"drop_show"),xows_cli_activity_wakeup()}function xows_gui_chat_fram_update(){if(!V_)return k_.chat_titl.innerText="",k_.chat_addr.innerText="",k_.chat_meta.title="",k_.chat_meta.innerText="",k_.send_wrap.setAttribute("placeholder",""),k_.chat_stat.innerText="",xows_doc_hide("chat_show"),xows_doc_hide("chat_occu"),xows_doc_hide("chat_book"),void xows_gui_room_privi_update(!0);k_.chat_titl.innerText=V_.name,V_.type===vo?(xows_doc_show("chat_show"),xows_doc_show("chat_addr"),k_.chat_show.setAttribute("show",V_.show),k_.chat_addr.innerText="("+V_.bare+")",k_.chat_meta.innerText=V_.stat?V_.stat:"",xows_doc_hide("chat_occu"),xows_doc_hide("chat_book"),xows_gui_room_privi_update(!0)):(xows_doc_hide("chat_show"),xows_doc_hide("chat_addr"),k_.chat_meta.innerText=V_.subj,xows_doc_show("chat_occu"),xows_doc_hidden_set("chat_book",V_.book||V_.publ),xows_gui_room_privi_update()),V_.noti?xows_gui_notify_allow(!0):xows_gui_notify_allow(!1),k_.send_wrap.setAttribute("placeholder",xows_l10n_get("Send a message to")+" "+V_.name+" ...")}function xows_gui_chat_noti_onclick(e){xows_doc_cls_has("chat_noti","CHAT-MUTE")?xows_gui_notify_allow(!1):xows_gui_notify_query()}function xows_gui_chat_conf_onclick(e){xows_cli_activity_wakeup(),xows_cli_room_cfg_get(V_,xows_gui_page_room_open)}function xows_gui_chat_occu_onclick(e){xows_cli_activity_wakeup(),window.matchMedia("(max-width: 799px)").matches?xows_doc_cls_add("main_wrap","COLR-WIDE"):xows_doc_cls_tog("main_colr","COL-HIDE")}function xows_gui_chat_book_onclick(e){xows_cli_activity_wakeup(),V_&&xows_gui_mbox_bookmark_open(V_)}function xows_gui_chat_meta_onblur(e){xows_cli_activity_wakeup();const o=k_.chat_meta.innerText;o!=V_.subj&&xows_cli_send_subject(V_,o)}function xows_gui_chat_meta_onkeyp(e){13===e.keyCode&&k_.chat_meta.blur()}function xows_gui_cli_onsubject(e,o){e===V_&&(k_.chat_meta.innerText=o||"")}function xows_gui_chat_main_onscroll(e){const o=k_.chat_main;o.scrollHeight!==o.clientHeight&&(o.scrollTop<20&&xows_gui_mam_query(!1),o.scrollHeight-o.scrollTop-o.clientHeight<20&&(xows_doc_hide("hist_new"),xows_doc_hidden("hist_end")||xows_gui_mam_query(!0)))}function xows_gui_chat_main_onclick(e){"hist_new"===e.target.id&&(xows_doc_hidden("hist_end")?k_.chat_main.scrollTop=k_.chat_main.scrollHeight:(k_.hist_ul.innerText="",k_.hist_beg.innerText="",xows_doc_hide("hist_end"),xows_gui_mam_query(!1,z_,0)))}function xows_gui_hist_gen_mesg(e,o,_,t,s,n,r,i){let c=!0;if(e){(s-e.getAttribute("time")>G_||e.getAttribute("from")!==_)&&(c=!1)}else c=!1;return xows_tpl_mesg_spawn(o,_,t,s,n,r,c?null:i)}function xows_gui_hist_avat_upd(e,o,_){if(!_)return;const t=xows_gui_peer_element(e,"hist_ul"),s="h-"+_;let n,r,i=t.childNodes.length;for(;i--;)(r=t.childNodes[i]).getAttribute("from")===o&&(n=r.querySelector("FIGURE"))&&(n.className=s)}function xows_gui_cli_onmessage(e,o,_,t,s,n,r,i){const c=e!==V_;if(c&&xows_gui_unread_add(e,o),K_||n||!e.noti||xows_gui_notify_push(i.name,t,i.avat),!n&&!hist_end.classList.contains("HIDDEN"))return void xows_gui_peer_element(e,"hist_new").classList.remove("HIDDEN");const a=xows_gui_peer_element(e,"hist_ul");if(xows_doc_get_child(a,o))return;const l=xows_gui_peer_scroll_bot(e),u=xows_gui_hist_gen_mesg(a.lastChild,o,_,t,s,n,r,i);a.appendChild(u),a.childNodes.length>z_&&(a.removeChild(a.firstChild),xows_gui_peer_element(e,"hist_beg").innerText=""),!n&&l>100?xows_gui_peer_element(e,"hist_new").classList.remove("HIDDEN"):xows_gui_peer_scroll_down(e),c||(xows_doc_loader_monitor(u),xows_doc_loader_check(!0))}function xows_gui_cli_onreceipt(e,o){const _=xows_gui_peer_element(e,o);_?_.classList.add("MESG-RECP"):xows_log(1,"gui_hist_set_receipt","message not found",o)}let rt=null;function xows_gui_mam_query(e,o=20,_=100){if(!rt){let t,s;if(e){if(xows_doc_hidden("hist_end"))return;k_.hist_ul.childNodes.length&&(t=parseInt(k_.hist_ul.lastChild.getAttribute("time"))),xows_doc_cls_add("hist_end","LOADING")}else{if(k_.hist_beg.innerText.length)return;k_.hist_ul.childNodes.length&&(s=parseInt(k_.hist_ul.firstChild.getAttribute("time"))),xows_doc_cls_add("hist_beg","LOADING")}rt=setTimeout(xows_cli_mam_query,_,V_,o,t,s,xows_gui_mam_parse)}}function xows_gui_mam_parse(e,o,_){const t=e!==V_,s=xows_gui_peer_element(e,"hist_ul"),n=xows_gui_peer_element(e,"hist_beg"),r=xows_gui_peer_element(e,"hist_end");n.classList.remove("LOADING"),r.classList.remove("LOADING");const i=0===s.childNodes.length;let c;o.length&&!i&&s.firstChild.getAttribute("time")>=o[o.length-1].time&&(c=s.firstChild);let a=s.childNodes.length-z_+o.length;if(a>0)if(c){for(;a--;)s.removeChild(s.lastChild);r.classList.remove("HIDDEN")}else{for(;a--;)s.removeChild(s.firstChild);n.innerText=""}const l=xows_gui_peer_scroll_off(e);let u,x,d=0;for(let e=0,_=o.length;e<_;++e)xows_doc_get_child(s,o[e].id)||(u=xows_gui_hist_gen_mesg(x,o[e].id,o[e].from,o[e].body,o[e].time,o[e].sent,!0,o[e].sndr),x=c?s.insertBefore(u,c):s.appendChild(u),t||xows_doc_loader_monitor(u),d++);if(_){let e=!1;o.length&&0===d?o[0].id===s.firstChild.id?e=!0:o[o.length-1].id!==s.lastChild.id&&xows_log(1,"gui_mam_handle","Complete MAM query exception","bound messages ID mismatches"):e=void 0!==c||i,e?n.innerText=xows_l10n_get("Start of history"):r.classList.add("HIDDEN")}t||(c&&xows_gui_peer_scroll_seek(e,l),i&&xows_gui_peer_scroll_down(e),xows_doc_loader_check(!0)),rt=null}const it=new Array(256);function xows_gui_send_edit_onkeyp(e){if(xows_cli_activity_wakeup(),it[e.keyCode]="keydown"===e.type,"keydown"===e.type)if(13===e.keyCode){if(it[16])return;if(e.preventDefault(),V_){const e=k_.send_edit;e.innerText.length&&(xows_cli_send_message(V_,e.innerText),xows_doc_cls_add("send_wrap","SEND-PHLD"),e.innerText=""),xows_cli_chatstate_set(V_,Ee)}}else V_&&xows_cli_chatstate_set(V_,Te)}let ct=null;function xows_gui_send_edit_oninput(e){ct=xows_doc_sel_rng(0);const o=k_.send_edit;if(o.innerText.length<2&&0===o.innerText.trim().length)return xows_doc_cls_add("send_wrap","SEND-PHLD"),void(o.innerText="");xows_doc_cls_rem("send_wrap","SEND-PHLD")}function xows_gui_send_edit_onclick(e){const o=xows_doc_sel_rng(0);if(o.collapsed){const e=o.endContainer;if("EMOJ"===e.parentNode.tagName)return void xows_doc_caret_around(e.parentNode,!o.endOffset)}ct=o}function xows_gui_send_edit_insert(e,o){const _=ct;let t;_.collapsed||_.deleteContents(),o?(t=document.createElement(o)).appendChild(document.createTextNode(e)):t=document.createTextNode(e),_.insertNode(t),xows_doc_cls_rem("send_wrap","SEND-PHLD"),k_.send_edit.focus(),xows_doc_caret_around(t),ct=xows_doc_sel_rng(0)}function xows_gui_menu_emoj_onclick(e){xows_cli_activity_wakeup();const o=e.target.closest("LI");o&&xows_gui_send_edit_insert(o.childNodes[0].nodeValue,"emoj"),xows_doc_menu_toggle(k_.menu_emoj,"drop_emoj")}function xows_gui_upld_onprogress(e){k_.upld_pbar.style.width=e+"%"}function xows_gui_upld_onerror(e){xows_doc_cls_add("upld_text","TEXT-ERR"),k_.upld_text.innerHTML="<b>"+xows_l10n_get("Error")+"</b> : "+e}function xows_gui_upld_onsuccess(e){xows_doc_hide("hist_upld"),setTimeout(xows_cli_send_message,400,V_,e)}function xows_gui_upld_onabort(){xows_gui_upld_onclose()}function xows_gui_upld_onclose(){xows_doc_hide("hist_upld")}function xows_gui_upld_open(e){k_.upld_text.classList="",k_.upld_pbar.style.width="0%",k_.upld_text.innerText=e.name,console.log(e.name),xows_cli_upld_query(e,xows_gui_upld_onerror,xows_gui_upld_onsuccess,xows_gui_upld_onprogress,xows_gui_upld_onabort),xows_doc_show("hist_upld"),xows_gui_peer_scroll_down(V_)}function xows_gui_chat_file_onchange(e){const o=k_.chat_file.files[0];V_.bare&&o&&xows_gui_upld_open(o)}function xows_gui_chat_upld_onclick(e){xows_cli_activity_wakeup(),k_.chat_file.value="",k_.chat_file.click()}const at=[];function xows_gui_writing_clear(){0!==at.length&&(at.length=0),xows_doc_hide("chat_stat"),k_.chat_stat.innerText=""}function xows_gui_writing_set(e,o){const _=at,t=_.indexOf(e);o?t<0&&_.push(e):t>=0&&_.splice(t,1);const s=_.length;if(s>0){if(V_)if(xows_doc_show("chat_stat"),V_.type===vo)k_.chat_stat.innerHTML="<b>"+V_.name+"</b> "+xows_l10n_get("is currently writing");else{let e="";if(s>1){const o=s>2?2:s-1;for(let t=0;t<o;++t)e+="<b>"+xows_jid_to_nick(_[t])+"</b>",t<o-1&&(e+=", ");e+=" "+xows_l10n_get("and")+" <b>";const t=s-o;e+=t>1?t+" "+xows_l10n_get("other(s)")+"</b> ":xows_jid_to_nick(_[s-1])+"</b> ",k_.chat_stat.innerHTML=e+xows_l10n_get("are currently writing")}else k_.chat_stat.innerHTML="<b>"+xows_jid_to_nick(_[0])+"</b> "+xows_l10n_get("is currently writing")}}else xows_gui_writing_clear()}function xows_gui_cli_onchatstate(e,o,_){e===V_&&xows_gui_writing_set(o,_>Se)}function xows_gui_cli_onoccupush(e,o,_){_&&_.includes(110)&&xows_gui_page_join_onjoind(e,null,_.includes(201));const t=xows_gui_find_occu_li(e,o.jid);if(t)xows_tpl_update_room_occu(t,o.name,o.avat,o.full,o.show,o.stat),xows_gui_hist_avat_upd(e,o.jid,o.avat);else{const _=xows_tpl_spawn_room_occu(o.jid,o.name,o.avat,o.full,o.show,o.stat);o.self&&(_.querySelector(".OCCU-SUBS").classList.add("HIDDEN"),xows_gui_room_privi_update()),o.full&&xows_cli_cont_get(o.full)&&_.querySelector(".OCCU-SUBS").classList.add("HIDDEN"),xows_gui_peer_element(e,o.role===Pe?"modo_ul":"memb_ul").appendChild(_)}}function xows_gui_cli_onoccurem(e,o){if(jid){const _=xows_gui_find_occu_li(e,o);_&&_.parentNode.removeChild(_)}else if(e===V_){xows_gui_switch_peer(null);const e=k_.room_list.querySelector(".SELECTED");e&&e.classList.remove("SELECTED")}}function xows_gui_occu_list_onclick(e){xows_cli_activity_wakeup();const o=e.target.closest("li");if(o&&"BUTTON"===e.target.tagName)switch(e.target.name){case"OCCU_ADD":{const e=xows_jid_to_bare(o.getAttribute("jid")),_=e.split("@")[0];return void xows_gui_mbox_subs_edit_open(e,_[0].toUpperCase()+_.slice(1))}default:return}}function xows_gui_user_stat_onblur(e){xows_cli_activity_wakeup();const o=k_.user_stat.value;o!=Jo.stat&&xows_cli_change_status(o)}function xows_gui_user_stat_onkeyp(e){13===e.keyCode&&k_.user_stat.blur()}function xows_gui_page_wait_open(e){k_.wait_text.innerText=xows_l10n_get(e),xows_doc_page_open("page_wait")}function xows_gui_page_auth_oninput(e){let o=!0;k_.auth_user.value.length&&k_.auth_pass.value.length&&(o=!1),k_.auth_cnct.disabled=o}function xows_gui_page_auth_onclick(e){"auth_cnct"!==e.id?"auth_regi"===e.id&&xows_gui_page_regi_open():k_.auth_cnct.disabled||(xows_gui_page_wait_open("Connecting..."),(X_={}).user=k_.auth_user.value.toLowerCase(),X_.pass=k_.auth_pass.value,X_.cred=k_.auth_cred.checked,k_.auth_pass.value="",xows_gui_connect(!1))}function xows_gui_page_auth_open(){k_.auth_user.value="",k_.auth_pass.value="",k_.auth_cnct.disabled=!0,xows_doc_page_open("page_auth",!1,null,xows_gui_page_auth_oninput,xows_gui_page_auth_onclick),xows_gui_nav_push("auth_open",xows_gui_page_auth_open)}function xows_gui_page_regi_oninput(e){let o=!0;k_.regi_user.value.length&&k_.regi_pass.value.length&&xows_doc_cls_has("regi_capt","CAPTCHA-CHECKED")&&(o=!1),k_.regi_subm.disabled=o}function xows_gui_page_regi_onclick(e){if("regi_capt"===e.id)return xows_doc_cls_add("regi_capt","CAPTCHA-CHECKED"),void xows_gui_page_regi_oninput(e);"regi_subm"!==e.id?"regi_canc"===e.id&&xows_gui_page_auth_open():k_.regi_subm.disabled||(xows_gui_page_wait_open("Please wait..."),(X_={}).user=k_.regi_user.value.toLowerCase(),X_.pass=k_.regi_pass.value,k_.regi_pass.value="",xows_gui_connect(!0))}function xows_gui_page_regi_open(){k_.regi_user.value="",k_.regi_pass.value="",k_.regi_subm.disabled=!0,xows_doc_cls_rem("regi_capt","CAPTCHA-CHECKED"),xows_doc_page_open("page_regi",!1,null,xows_gui_page_regi_oninput,xows_gui_page_regi_onclick),xows_gui_nav_push("regi_open",xows_gui_page_regi_open)}function xows_gui_page_user_onabort(){k_.card_name.value=Jo.name;const e=xows_cach_avat_get(Jo.avat);k_.card_avat.style.backgroundImage='url("'+e+'")',k_.card_avat.data=e,k_.card_open.checked=!0}function xows_gui_page_user_onvalid(){xows_cli_change_profile(k_.card_name.value,k_.card_avat.data,k_.card_open.checked)}function xows_gui_page_user_oninput(e){let o;switch(e.id){case"card_open":o=!k_.card_open.checked;break;case"card_name":o=k_.card_name.value!=Jo.name}o&&xows_doc_mbox_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)}function xows_gui_page_user_onclick(e){if("card_avch"!==e.id){if("card_avrm"===e.id){k_.card_avat.data=null;const e=xows_cli_avat_temp(Jo.bare);k_.card_avat.style.backgroundImage='url("'+xows_cach_avat_get(e)+'")',xows_doc_mbox_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)}}else k_.card_file.click()}function xows_gui_page_user_ev_file(e){if(k_.card_file.files[0]){const e=new FileReader;e.onload=function(e){const o=new Image;o.onload=function(e){const o=xows_gen_avatar(Ao,this);k_.card_avat.data=o,k_.card_avat.style.backgroundImage='url("'+o+'")',xows_doc_mbox_open_for_save(xows_gui_page_user_onvalid,xows_gui_page_user_onabort)},o.src=e.target.result},e.readAsDataURL(k_.card_file.files[0])}}function xows_gui_page_user_onclose(){xows_doc_listener_rem(k_.card_file,"change",xows_gui_page_user_ev_file)}function xows_gui_page_user_open(){xows_gui_page_user_onabort(),xows_doc_page_open("page_user",!0,xows_gui_page_user_onclose,xows_gui_page_user_oninput,xows_gui_page_user_onclick),xows_doc_listener_add(k_.card_file,"change",xows_gui_page_user_ev_file),xows_gui_nav_push("user_open",xows_gui_page_user_open)}function xows_gui_page_cont_onvalid(){let e=k_.cont_bare.value;const o=e.split("@")[0];xows_cli_rost_edit(e,o[0].toUpperCase()+o.slice(1))}function xows_gui_page_cont_oninput(e){k_.cont_bare.value.length&&xows_isjid(k_.cont_bare.value)?xows_doc_mbox_open(null,"Add contact and request authorisation",xows_gui_page_cont_onvalid,"Submit"):xows_doc_mbox_close()}function xows_gui_page_cont_open(){k_.cont_bare.value="",xows_doc_page_open("page_cont",!0,null,xows_gui_page_cont_oninput)}const lt={};function xows_gui_page_join_onjoind(e,o,_){xows_doc_page_opened("page_join")&&(xows_gui_switch_peer(e.bare),xows_gui_panel_close(),_?(lt.room=e,k_.join_room.disabled=!0,xows_doc_mbox_open(null,"The Room will be created, do you want to configure it ?",xows_gui_page_join_onvalid,"Configure",xows_gui_page_join_onabort,"Join now")):xows_doc_page_close())}function xows_gui_page_join_onvalid(){const e=lt.room;if(e)xows_log(2,"gui_page_join_onvalid","request initial Room config",e.bare),xows_cli_room_cfg_get(e,xows_gui_page_room_open);else{xows_cli_room_join(null,k_.join_room.value,Jo.name)}}function xows_gui_page_join_onabort(){const e=lt.room;e&&xows_cli_room_cfg_set(e,null,xows_gui_page_join_onjoind)}function xows_gui_page_join_oninput(e){k_.join_room.value.length?xows_doc_mbox_open(null,"Join Room (create it if does not exist)",xows_gui_page_join_onvalid,"Join"):xows_doc_mbox_close()}function xows_gui_page_join_onclose(){lt.room=null}function xows_gui_page_join_open(){k_.join_room.disabled=!1,k_.join_room.value="",xows_doc_page_open("page_join",!0,xows_gui_page_join_onclose,xows_gui_page_join_oninput),xows_gui_nav_push("join_open",xows_gui_page_join_open)}const ut={};function xows_gui_page_room_onresult(e,o){"result"===o&&xows_doc_page_close()}function xows_gui_page_room_onvalid(){const e=ut.room,o=ut.form;for(let e=0,_=o.length;e<_;++e)switch(o[e].var){case"muc#roomconfig_roomname":o[e].value=k_.room_titl.value;break;case"muc#roomconfig_roomdesc":o[e].value=k_.room_desc.value;break;case"muc#roomconfig_persistentroom":o[e].value=k_.room_pers.checked?"1":"0";break;case"muc#roomconfig_publicroom":o[e].value=k_.room_publ.checked?"1":"0";break;case"muc#roomconfig_membersonly":o[e].value=k_.room_mbon.checked?"1":"0";break;case"muc#roomconfig_moderatedroom":o[e].value=k_.room_modo.checked?"1":"0";break;case"muc#roomconfig_whois":o[e].value=k_.room_anon.value;break;case"muc#roomconfig_historylength":o[e].value=k_.room_hmax.value;break;case"muc#roomconfig_defaulthistorymessages":o[e].value=k_.room_hdef.value;break;case"muc#roomconfig_enablearchiving":o[e].value=k_.room_arch.checked?"1":"0"}xows_cli_room_cfg_set(e,o,xows_gui_page_room_onresult)}function xows_gui_page_room_onabort(){ut.room;const e=ut.form;for(let o=0,_=e.length;o<_;++o)switch(e[o].var){case"muc#roomconfig_roomname":k_.room_titl.value=e[o].value;break;case"muc#roomconfig_roomdesc":k_.room_desc.value=e[o].value;break;case"muc#roomconfig_persistentroom":k_.room_pers.checked=xows_asbool(e[o].value);break;case"muc#roomconfig_publicroom":k_.room_publ.checked=xows_asbool(e[o].value);break;case"muc#roomconfig_membersonly":k_.room_mbon.checked=xows_asbool(e[o].value);break;case"muc#roomconfig_changesubject":case"muc#roomconfig_moderatedroom":k_.room_modo.checked=xows_asbool(e[o].value);break;case"muc#roomconfig_whois":k_.room_anon.value=e[o].value;break;case"muc#roomconfig_historylength":k_.room_hmax.value=e[o].value;break;case"muc#roomconfig_defaulthistorymessages":k_.room_hdef.value=e[o].value;break;case"muc#roomconfig_enablearchiving":k_.room_arch.checked=xows_asbool(e[o].value)}}function xows_gui_page_room_oninput(e){let o=!1;const _=ut.form;for(let e=0,t=_.length;e<t;++e){switch(_[e].var){case"muc#roomconfig_roomname":_[e].value,k_.room_titl.value,o=!0;break;case"muc#roomconfig_roomdesc":_[e].value,k_.room_desc.value,o=!0;break;case"muc#roomconfig_persistentroom":xows_asbool(_[e].value),k_.room_pers.checked,o=!0;break;case"muc#roomconfig_publicroom":xows_asbool(_[e].value),k_.room_publ.checked,o=!0;break;case"muc#roomconfig_membersonly":xows_asbool(_[e].value),k_.room_mbon.checked,o=!0;break;case"muc#roomconfig_moderatedroom":xows_asbool(_[e].value),k_.room_modo.checked,o=!0;break;case"muc#roomconfig_whois":_[e].value,k_.room_anon.value,o=!0;break;case"muc#roomconfig_historylength":_[e].value,k_.room_hmax.value,o=!0;break;case"muc#roomconfig_defaulthistorymessages":_[e].value,k_.room_hdef.value,o=!0;break;case"muc#roomconfig_enablearchiving":xows_asbool(_[e].value),k_.room_arch.checked,o=!0}if(o)break}o&&xows_doc_mbox_open_for_save(xows_gui_page_room_onvalid,xows_gui_page_room_onabort)}function xows_gui_page_room_onclose(){const e=ut.room;e.init?xows_cli_room_cfg_set(e,null,null):xows_cli_room_cfg_cancel(e),ut.form=null,ut.room=null}function xows_gui_page_room_open(e,o){ut.room=e,ut.form=o,k_.room_bare.innerText=e.bare,xows_gui_page_room_onabort(),xows_doc_page_open("page_room",!0,xows_gui_page_room_onclose,xows_gui_page_room_oninput),xows_gui_nav_push("room_open",xows_gui_page_room_open)}let xt={root:"xows",url:"ws://localhost/xmpp-websocket/",domain:"localhost",locale:"en-US",theme:"dark",verbose:1,uncache:!1,allow_register:!1,legacy_vcard:!1,vcard4_notify:!0,avatar_notify:!0,login_delay:2e3};function xows_init_login_user(){xows_log(2,"init_login_user","normal login"),window.PasswordCredential?xows_doc_show("auth_save"):xows_doc_hide("auth_save"),xows_gui_page_auth_open()}function xows_init_login_auto(e){e?(xows_log(2,"init_login_auto","found credential","try auto login"),xows_gui_page_wait_open("Connecting..."),X_={user:e.id,pass:e.password},xows_gui_connect()):(xows_log(2,"init_login_auto","No credential found","Fallback to normal login"),xows_init_login_user())}function xows_init_ondoc(){if(window.PasswordCredential){const e={password:!0,mediation:"optional"};navigator.credentials.get(e).then(xows_init_login_auto,xows_init_login_user)}else xows_init_login_user()}function xows_init_ontpl(){xows_doc_init(xows_init_ondoc)}function xows_init_onl10n(){xows_tpl_init(xows_init_ontpl)}function xows_init(e){e&&("root"in e&&(xt.root=e.root),"url"in e&&(xt.url=e.url),"domain"in e&&(xt.domain=e.domain),"locale"in e&&(xt.locale=e.locale),"theme"in e&&(xt.theme=e.theme),"verbose"in e&&(xt.verbose=e.verbose),"uncache"in e&&(xt.uncache=e.uncache),"allow_register"in e&&(xt.allow_register=e.allow_register),"legacy_vcard"in e&&(xt.legacy_vcard=e.legacy_vcard),"vcard4_notify"in e&&(xt.vcard4_notify=e.vcard4_notify),"avatar_notify"in e&&(xt.avatar_notify=e.avatar_notify),"fail_delay"in e&&(xt.fail_delay=e.fail_delay)),xows_log(2,"init","xows init start"),xows_l10n_select(xt.locale,xows_init_onl10n)}